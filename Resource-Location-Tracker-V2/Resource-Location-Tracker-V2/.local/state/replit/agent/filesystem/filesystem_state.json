{"file_contents":{"client/src/components/ui/toaster.tsx":{"content":"import { useToast } from \"@/hooks/use-toast\"\nimport {\n  Toast,\n  ToastClose,\n  ToastDescription,\n  ToastProvider,\n  ToastTitle,\n  ToastViewport,\n} from \"@/components/ui/toast\"\n\nexport function Toaster() {\n  const { toasts } = useToast()\n\n  return (\n    <ToastProvider>\n      {toasts.map(function ({ id, title, description, action, ...props }) {\n        return (\n          <Toast key={id} {...props}>\n            <div className=\"grid gap-1\">\n              {title && <ToastTitle>{title}</ToastTitle>}\n              {description && (\n                <ToastDescription>{description}</ToastDescription>\n              )}\n            </div>\n            {action}\n            <ToastClose />\n          </Toast>\n        )\n      })}\n      <ToastViewport />\n    </ToastProvider>\n  )\n}\n","path":null,"size_bytes":772,"size_tokens":null},"client/src/components/ui/context-menu.tsx":{"content":"import * as React from \"react\"\nimport * as ContextMenuPrimitive from \"@radix-ui/react-context-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ContextMenu = ContextMenuPrimitive.Root\n\nconst ContextMenuTrigger = ContextMenuPrimitive.Trigger\n\nconst ContextMenuGroup = ContextMenuPrimitive.Group\n\nconst ContextMenuPortal = ContextMenuPrimitive.Portal\n\nconst ContextMenuSub = ContextMenuPrimitive.Sub\n\nconst ContextMenuRadioGroup = ContextMenuPrimitive.RadioGroup\n\nconst ContextMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <ContextMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </ContextMenuPrimitive.SubTrigger>\n))\nContextMenuSubTrigger.displayName = ContextMenuPrimitive.SubTrigger.displayName\n\nconst ContextMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuSubContent.displayName = ContextMenuPrimitive.SubContent.displayName\n\nconst ContextMenuContent = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Portal>\n    <ContextMenuPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"z-50 max-h-[--radix-context-menu-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md animate-in fade-in-80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-context-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </ContextMenuPrimitive.Portal>\n))\nContextMenuContent.displayName = ContextMenuPrimitive.Content.displayName\n\nconst ContextMenuItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuItem.displayName = ContextMenuPrimitive.Item.displayName\n\nconst ContextMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <ContextMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.CheckboxItem>\n))\nContextMenuCheckboxItem.displayName =\n  ContextMenuPrimitive.CheckboxItem.displayName\n\nconst ContextMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <ContextMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <ContextMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </ContextMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </ContextMenuPrimitive.RadioItem>\n))\nContextMenuRadioItem.displayName = ContextMenuPrimitive.RadioItem.displayName\n\nconst ContextMenuLabel = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <ContextMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold text-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nContextMenuLabel.displayName = ContextMenuPrimitive.Label.displayName\n\nconst ContextMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof ContextMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof ContextMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <ContextMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nContextMenuSeparator.displayName = ContextMenuPrimitive.Separator.displayName\n\nconst ContextMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nContextMenuShortcut.displayName = \"ContextMenuShortcut\"\n\nexport {\n  ContextMenu,\n  ContextMenuTrigger,\n  ContextMenuContent,\n  ContextMenuItem,\n  ContextMenuCheckboxItem,\n  ContextMenuRadioItem,\n  ContextMenuLabel,\n  ContextMenuSeparator,\n  ContextMenuShortcut,\n  ContextMenuGroup,\n  ContextMenuPortal,\n  ContextMenuSub,\n  ContextMenuSubContent,\n  ContextMenuSubTrigger,\n  ContextMenuRadioGroup,\n}\n","path":null,"size_bytes":7428,"size_tokens":null},"client/src/context/AuthContext.tsx":{"content":"import { createContext, useContext, useState, useEffect, ReactNode } from 'react';\n\ninterface User {\n  id: string;\n  email: string | null;\n  firstName: string | null;\n  lastName: string | null;\n  profileImageUrl: string | null;\n  role: 'ADMIN' | 'CONTRACTOR' | 'MANAGER' | 'UTILITY' | null;\n  companyId: string | null; // References companies.id (UUID)\n}\n\ninterface AuthContextType {\n  user: User | null;\n  login: () => void;\n  logout: () => void;\n  isLoading: boolean;\n}\n\nconst AuthContext = createContext<AuthContextType | undefined>(undefined);\n\nexport function AuthProvider({ children }: { children: ReactNode }) {\n  const [user, setUser] = useState<User | null>(null);\n  const [isLoading, setIsLoading] = useState(true);\n\n  useEffect(() => {\n    // Check authentication status on app load\n    checkAuth();\n  }, []);\n\n  const checkAuth = async () => {\n    try {\n      const response = await fetch('/api/user', {\n        credentials: 'include',\n      });\n      \n      if (response.ok) {\n        const contentType = response.headers.get('content-type');\n        if (contentType && contentType.includes('application/json')) {\n          const userData = await response.json();\n          setUser(userData);\n        } else {\n          // Not JSON, user is not authenticated\n          setUser(null);\n        }\n      } else {\n        setUser(null);\n      }\n    } catch (error) {\n      // Silently handle auth check errors (user is simply not authenticated)\n      setUser(null);\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const login = () => {\n    // Redirect to Replit Auth login\n    window.location.href = '/api/login';\n  };\n\n  const logout = () => {\n    // Redirect to Replit Auth logout\n    window.location.href = '/api/logout';\n  };\n\n  return (\n    <AuthContext.Provider value={{ user, login, logout, isLoading }}>\n      {children}\n    </AuthContext.Provider>\n  );\n}\n\nexport function useAuth() {\n  const context = useContext(AuthContext);\n  if (context === undefined) {\n    throw new Error('useAuth must be used within an AuthProvider');\n  }\n  return context;\n}\n","path":null,"size_bytes":2076,"size_tokens":null},"server/vite.ts":{"content":"import express, { type Express } from \"express\";\nimport fs from \"fs\";\nimport path from \"path\";\nimport { createServer as createViteServer, createLogger } from \"vite\";\nimport { type Server } from \"http\";\nimport viteConfig from \"../vite.config\";\nimport { nanoid } from \"nanoid\";\n\nconst viteLogger = createLogger();\n\nexport function log(message: string, source = \"express\") {\n  const formattedTime = new Date().toLocaleTimeString(\"en-US\", {\n    hour: \"numeric\",\n    minute: \"2-digit\",\n    second: \"2-digit\",\n    hour12: true,\n  });\n\n  console.log(`${formattedTime} [${source}] ${message}`);\n}\n\nexport async function setupVite(app: Express, server: Server) {\n  const serverOptions = {\n    middlewareMode: true,\n    hmr: { server },\n    allowedHosts: true,\n  };\n\n  const vite = await createViteServer({\n    ...viteConfig,\n    configFile: false,\n    customLogger: {\n      ...viteLogger,\n      error: (msg, options) => {\n        viteLogger.error(msg, options);\n        process.exit(1);\n      },\n    },\n    server: serverOptions,\n    appType: \"custom\",\n  });\n\n  app.use(vite.middlewares);\n  app.use(\"*\", async (req, res, next) => {\n    const url = req.originalUrl;\n\n    try {\n      const clientTemplate = path.resolve(\n        import.meta.dirname,\n        \"..\",\n        \"client\",\n        \"index.html\",\n      );\n\n      // always reload the index.html file from disk incase it changes\n      let template = await fs.promises.readFile(clientTemplate, \"utf-8\");\n      template = template.replace(\n        `src=\"/src/main.tsx\"`,\n        `src=\"/src/main.tsx?v=${nanoid()}\"`,\n      );\n      const page = await vite.transformIndexHtml(url, template);\n      res.status(200).set({ \"Content-Type\": \"text/html\" }).end(page);\n    } catch (e) {\n      vite.ssrFixStacktrace(e as Error);\n      next(e);\n    }\n  });\n}\n\nexport function serveStatic(app: Express) {\n  const distPath = path.resolve(import.meta.dirname, \"public\");\n\n  if (!fs.existsSync(distPath)) {\n    throw new Error(\n      `Could not find the build directory: ${distPath}, make sure to build the client first`,\n    );\n  }\n\n  app.use(express.static(distPath));\n\n  // fall through to index.html if the file doesn't exist\n  app.use(\"*\", (_req, res) => {\n    res.sendFile(path.resolve(distPath, \"index.html\"));\n  });\n}\n","path":null,"size_bytes":2254,"size_tokens":null},"postcss.config.js":{"content":"export default {\n  plugins: {\n    tailwindcss: {},\n    autoprefixer: {},\n  },\n}\n","path":null,"size_bytes":80,"size_tokens":null},"BUILD_BACKUP.md":{"content":"# Build Backup - Interactive Map Analysis Application\n**Date**: June 27, 2025\n**Status**: STABLE WORKING BUILD - PRESERVE THIS STATE\n\n## Current Working Features ✅\n\n### 1. Interactive Map System\n- **Map Engine**: Leaflet with OpenStreetMap tiles\n- **Resource Markers**: 304 contractor resources displaying correctly\n- **Analysis Points**: User-created points with address geocoding\n- **Distance Calculations**: Straight-line distance calculations working\n- **Visual Indicators**: Color-coded markers and distance circles\n\n### 2. Database Integration\n- **PostgreSQL**: Persistent data storage active\n- **Tables**: resources, contractors, analysis_points, distance_calculations, analysis_jobs\n- **Drizzle ORM**: Database operations functioning correctly\n- **Data Integrity**: All CRUD operations working\n\n### 3. Contractors Management\n- **Full CRUD**: Create, Read, Update, Delete operations\n- **5-Star Rating System**: Working contractor evaluation\n- **Search & Filter**: Functional contractor search\n- **Data Import**: CSV/Excel file upload to contractors table\n\n### 4. File Processing\n- **CSV Parser**: Working for contractor data import\n- **Excel Support**: .xlsx file processing functional\n- **KMZ Support**: KML/KMZ file parsing for geographic data\n- **Error Handling**: Robust file format validation\n\n### 5. Export Functionality\n- **Excel Export**: Distance calculations to .xlsx\n- **CSV Export**: Analysis results export\n- **Results Table**: Tabular data display with sorting\n\n### 6. Navigation & UI\n- **Wouter Routing**: Navigation between Map and Contractors pages\n- **Responsive Design**: Mobile-friendly with collapsible sidebar\n- **Tailwind CSS**: Consistent styling with shadcn/ui components\n- **Error States**: Proper loading and error handling\n\n## Current Database State\n- **304 Resources**: Successfully loaded and displaying on map\n- **Analysis Points**: Can create multiple points (current: lawrence, ks and liberal, KS)\n- **Distance Calculations**: 304 calculations per analysis point\n- **Contractors**: Linked to resources via contractorId in properties\n\n## API Endpoints Working\n- GET /api/resources ✅\n- GET /api/analysis-points ✅\n- POST /api/analysis-points ✅\n- DELETE /api/analysis-points/:id ✅\n- GET /api/analysis-points/:id/calculations ✅\n- POST /api/calculate-distances/:id ✅\n- GET /api/analysis-points/:id/calculations/export ✅\n- GET /api/contractors ✅\n- POST /api/contractors ✅\n\n## Critical Files to Preserve\n1. `shared/schema.ts` - Database schema definitions\n2. `server/storage.ts` - Database storage implementation\n3. `server/routes.ts` - API route handlers\n4. `client/src/components/MapContainer.tsx` - Map functionality\n5. `client/src/components/Sidebar.tsx` - Analysis tools\n6. `client/src/pages/contractors.tsx` - Contractor management\n7. `server/services/csvParser.ts` - File processing\n8. `package.json` - Dependencies\n9. Database migration files (if any)\n\n## Performance Metrics\n- Map loads: ~2-3 seconds for 304 markers\n- Distance calculations: ~1.3 seconds for 304 resources\n- Database queries: Sub-500ms response times\n- File uploads: Processing various CSV formats successfully\n\n## Known Working Data Flow\n1. CSV upload → Contractors table → Resources generation → Map display\n2. Address input → Geocoding → Analysis point creation → Distance calculations\n3. Analysis results → Export functionality → Excel/CSV download\n\n## Dependencies Confirmed Working\n- React 18 with TypeScript\n- Leaflet for mapping\n- PostgreSQL with Drizzle ORM\n- Express.js backend\n- Tailwind CSS + shadcn/ui\n- File processing libraries (xlsx, papaparse, etc.)\n\n## Environment Requirements\n- PostgreSQL database (DATABASE_URL configured)\n- Node.js environment\n- Port 5000 for Express server\n- Vite development server\n\n---\n**IMPORTANT**: This build state represents a fully functional geospatial mapping and contractor management application. All core features are working correctly. Use this document as a reference point for any rollbacks needed during new feature development.","path":null,"size_bytes":4028,"size_tokens":null},"client/src/components/ContractorReviewFlow.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Progress } from \"@/components/ui/progress\";\nimport ContractorReviewForm from \"./ContractorReviewForm\";\nimport ContractorSelector from \"./ContractorSelector\";\nimport { CheckCircle, Users, ArrowLeft, Search, List } from \"lucide-react\";\nimport type { Contractor } from \"@shared/schema\";\n\ninterface ContractorReviewFlowProps {\n  onComplete: () => void;\n  onCancel: () => void;\n}\n\ntype ReviewMode = 'selection' | 'sequential' | 'targeted';\n\nexport default function ContractorReviewFlow({ onComplete, onCancel }: ContractorReviewFlowProps) {\n  const [currentIndex, setCurrentIndex] = useState(0);\n  const [reviewedContractors, setReviewedContractors] = useState<Set<number>>(new Set());\n  const [isComplete, setIsComplete] = useState(false);\n  const [reviewMode, setReviewMode] = useState<ReviewMode>('selection');\n  const [selectedContractor, setSelectedContractor] = useState<Contractor | null>(null);\n\n  const { data: contractors = [], isLoading } = useQuery<Contractor[]>({\n    queryKey: [\"/api/contractors\"],\n  });\n\n  // For sequential review, use all contractors (don't filter out reviewed ones)\n  const contractorsToReview = reviewMode === 'sequential' ? contractors : contractors.filter(\n    contractor => !reviewedContractors.has(contractor.id)\n  );\n\n  const totalContractors = contractors.length;\n  const completedReviews = reviewedContractors.size;\n  const progressPercentage = totalContractors > 0 ? (completedReviews / totalContractors) * 100 : 0;\n\n  // For sequential mode, current contractor is based on currentIndex\n  // For targeted mode, current contractor is selectedContractor\n  const currentContractor = reviewMode === 'targeted' \n    ? selectedContractor \n    : (reviewMode === 'sequential' && currentIndex < contractors.length)\n      ? contractors[currentIndex]\n      : null;\n\n  const handleSubmitReview = () => {\n    if (reviewMode === 'targeted' && selectedContractor) {\n      // For targeted review, go back to selection after completing\n      setSelectedContractor(null);\n      setReviewMode('selection');\n      return;\n    }\n    \n    // For sequential review, automatically move to next contractor\n    if (reviewMode === 'sequential') {\n      const currentContractor = contractors[currentIndex];\n      if (currentContractor) {\n        setReviewedContractors(prev => new Set([...prev, currentContractor.id]));\n      }\n      \n      // Move to next contractor\n      const nextIndex = currentIndex + 1;\n      if (nextIndex < contractors.length) {\n        setCurrentIndex(nextIndex);\n        // Scroll to top when moving to next contractor\n        window.scrollTo({ top: 0, behavior: 'smooth' });\n      } else {\n        // All contractors have been reviewed\n        setIsComplete(true);\n      }\n    }\n  };\n\n  const handleSkipContractor = () => {\n    if (reviewMode === 'sequential') {\n      const currentContractor = contractors[currentIndex];\n      if (currentContractor) {\n        setReviewedContractors(prev => new Set([...prev, currentContractor.id]));\n      }\n      \n      // Move to next contractor or complete\n      const nextIndex = currentIndex + 1;\n      if (nextIndex < contractors.length) {\n        setCurrentIndex(nextIndex);\n        // Scroll to top when moving to next contractor\n        window.scrollTo({ top: 0, behavior: 'smooth' });\n      } else {\n        setIsComplete(true);\n      }\n    }\n  };\n\n  // Reset current index when contractors to review list changes\n  useEffect(() => {\n    if (currentIndex >= contractorsToReview.length && contractorsToReview.length > 0) {\n      setCurrentIndex(0);\n    }\n  }, [contractorsToReview.length, currentIndex]);\n\n  // Mode selection screen\n  if (reviewMode === 'selection') {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-6\">\n        <div className=\"max-w-2xl mx-auto\">\n          <div className=\"mb-6\">\n            <Button\n              onClick={onCancel}\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"text-gray-600 dark:text-gray-300 mb-4\"\n            >\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Back to Contractors\n            </Button>\n            <h1 className=\"text-3xl font-bold mb-2\">Contractor Review</h1>\n            <p className=\"text-gray-600 dark:text-gray-300\">\n              Choose how you'd like to review contractors\n            </p>\n          </div>\n\n          <div className=\"space-y-4\">\n            <Card className=\"hover:shadow-md transition-shadow cursor-pointer border-2 hover:border-blue-300\">\n              <CardHeader \n                className=\"pb-3\"\n                onClick={() => setReviewMode('targeted')}\n              >\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center\">\n                    <Search className=\"w-6 h-6 text-blue-600 dark:text-blue-400\" />\n                  </div>\n                  <div>\n                    <CardTitle className=\"text-lg\">Search & Select Contractor</CardTitle>\n                    <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                      Find and review a specific contractor\n                    </p>\n                  </div>\n                </div>\n              </CardHeader>\n            </Card>\n\n            <Card className=\"hover:shadow-md transition-shadow cursor-pointer border-2 hover:border-green-300\">\n              <CardHeader \n                className=\"pb-3\"\n                onClick={() => setReviewMode('sequential')}\n              >\n                <div className=\"flex items-center gap-3\">\n                  <div className=\"w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center\">\n                    <List className=\"w-6 h-6 text-green-600 dark:text-green-400\" />\n                  </div>\n                  <div>\n                    <CardTitle className=\"text-lg\">Review All Contractors</CardTitle>\n                    <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                      Go through all contractors sequentially\n                    </p>\n                  </div>\n                </div>\n              </CardHeader>\n            </Card>\n          </div>\n        </div>\n      </div>\n    );\n  }\n\n  // Contractor selection screen for targeted review\n  if (reviewMode === 'targeted' && !selectedContractor) {\n    return (\n      <ContractorSelector\n        onSelectContractor={(contractor) => {\n          setSelectedContractor(contractor);\n        }}\n        onCancel={() => setReviewMode('selection')}\n      />\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-gray-600 dark:text-gray-300\">Loading contractors...</p>\n        </div>\n      </div>\n    );\n  }\n\n  if (isComplete || contractorsToReview.length === 0) {\n    return (\n      <div className=\"max-w-2xl mx-auto p-6\">\n        <Card className=\"text-center border-green-200 bg-green-50 dark:bg-green-950 dark:border-green-800\">\n          <CardHeader>\n            <div className=\"w-16 h-16 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center mx-auto mb-4\">\n              <CheckCircle className=\"w-8 h-8 text-green-600 dark:text-green-400\" />\n            </div>\n            <CardTitle className=\"text-2xl text-green-800 dark:text-green-200\">\n              Review Process Complete!\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"text-green-700 dark:text-green-300\">\n              <p className=\"text-lg mb-2\">\n                You have completed reviews for all available contractors.\n              </p>\n              <p className=\"text-sm\">\n                {completedReviews} contractor{completedReviews !== 1 ? 's' : ''} reviewed out of {totalContractors} total\n              </p>\n            </div>\n            \n            <div className=\"flex gap-3 justify-center pt-4\">\n              <Button onClick={onComplete} className=\"bg-green-600 hover:bg-green-700\">\n                Return to Contractors Page\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n\n\n  if (!currentContractor && reviewMode === 'sequential') {\n    return (\n      <div className=\"max-w-2xl mx-auto p-6\">\n        <Card>\n          <CardContent className=\"text-center py-8\">\n            <Users className=\"w-12 h-12 text-gray-400 mx-auto mb-4\" />\n            <p className=\"text-gray-600 dark:text-gray-300\">\n              No contractors available for review.\n            </p>\n            <Button onClick={onCancel} variant=\"outline\" className=\"mt-4\">\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Back to Contractors\n            </Button>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 flex flex-col\">\n      {/* Progress Header */}\n      <div className=\"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10 flex-shrink-0\">\n        <div className=\"max-w-4xl mx-auto p-4\">\n          <div className=\"flex items-center justify-between mb-4\">\n            <div className=\"flex items-center gap-4\">\n              <Button\n                onClick={reviewMode === 'targeted' ? () => setReviewMode('selection') : onCancel}\n                variant=\"ghost\"\n                size=\"sm\"\n                className=\"text-gray-600 dark:text-gray-300\"\n              >\n                <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                {reviewMode === 'targeted' ? 'Back to Selection' : 'Back to Contractors'}\n              </Button>\n              <div className=\"h-6 w-px bg-gray-300 dark:bg-gray-600\"></div>\n              <h2 className=\"text-lg font-semibold text-gray-900 dark:text-white\">\n                {reviewMode === 'targeted' ? 'Review Selected Contractor' : 'Contractor Review Process'}\n              </h2>\n            </div>\n            {reviewMode === 'sequential' && (\n              <div className=\"text-sm text-gray-600 dark:text-gray-300\">\n                {completedReviews} / {totalContractors} completed\n              </div>\n            )}\n          </div>\n          \n          {reviewMode === 'sequential' && (\n            <div className=\"space-y-2\">\n              <div className=\"flex justify-between text-sm text-gray-600 dark:text-gray-300\">\n                <span>Progress</span>\n                <span>{Math.round(progressPercentage)}%</span>\n              </div>\n              <Progress value={progressPercentage} className=\"h-2\" />\n            </div>\n          )}\n        </div>\n      </div>\n\n      {/* Review Form */}\n      <div className=\"flex-1 overflow-y-auto\">\n        <ContractorReviewForm\n          contractor={currentContractor}\n          onSubmit={handleSubmitReview}\n          onSkip={handleSkipContractor}\n          currentIndex={completedReviews}\n          totalCount={totalContractors}\n          isTargetedReview={reviewMode === 'targeted'}\n        />\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":11459,"size_tokens":null},"client/src/lib/mapUtils.ts":{"content":"export function getMarkerColor(distance: number): string {\n  if (distance <= 5) return '#10B981'; // emerald-500\n  if (distance <= 10) return '#F59E0B'; // amber-500\n  return '#EF4444'; // red-500\n}\n\nexport function getResourceColor(type: string): string {\n  const typeMap: Record<string, string> = {\n    'Union': '#3B82F6',      // blue-500\n    'Non-Union': '#EF4444',  // red-500\n    'Non-union': '#EF4444',  // red-500\n    'Veg': '#10B981',        // emerald-500\n    'HVAC': '#F59E0B',       // amber-500\n    'DAT': '#8B5CF6',        // violet-500\n    'Consulting': '#EC4899', // pink-500\n    'Logistics': '#06B6D4',  // cyan-500\n    'Unknown': '#6B7280',    // gray-500\n    'Other': '#6B7280',      // gray-500\n  };\n  \n  return typeMap[type] || '#6B7280'; // gray-500 for unknown types\n}\n\nexport function formatDuration(seconds: number): string {\n  const minutes = Math.round(seconds / 60);\n  const hours = Math.floor(minutes / 60);\n  const remainingMinutes = minutes % 60;\n  \n  if (hours > 0) {\n    return `${hours}h ${remainingMinutes}m`;\n  }\n  return `${minutes}m`;\n}\n\nexport function calculateStraightLineDistance(\n  lat1: number,\n  lng1: number,\n  lat2: number,\n  lng2: number\n): number {\n  const R = 3959; // Earth's radius in miles\n  const φ1 = (lat1 * Math.PI) / 180;\n  const φ2 = (lat2 * Math.PI) / 180;\n  const Δφ = ((lat2 - lat1) * Math.PI) / 180;\n  const Δλ = ((lng2 - lng1) * Math.PI) / 180;\n\n  const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\n            Math.cos(φ1) * Math.cos(φ2) *\n            Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n  return R * c;\n}\n\nexport function formatCoordinates(lat: number, lng: number): string {\n  const latDir = lat >= 0 ? 'N' : 'S';\n  const lngDir = lng >= 0 ? 'E' : 'W';\n  return `${Math.abs(lat).toFixed(4)}°${latDir}, ${Math.abs(lng).toFixed(4)}°${lngDir}`;\n}\n","path":null,"size_bytes":1888,"size_tokens":null},"client/src/components/ui/alert-dialog.tsx":{"content":"import * as React from \"react\"\nimport * as AlertDialogPrimitive from \"@radix-ui/react-alert-dialog\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nconst AlertDialog = AlertDialogPrimitive.Root\n\nconst AlertDialogTrigger = AlertDialogPrimitive.Trigger\n\nconst AlertDialogPortal = AlertDialogPrimitive.Portal\n\nconst AlertDialogOverlay = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nAlertDialogOverlay.displayName = AlertDialogPrimitive.Overlay.displayName\n\nconst AlertDialogContent = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPortal>\n    <AlertDialogOverlay />\n    <AlertDialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    />\n  </AlertDialogPortal>\n))\nAlertDialogContent.displayName = AlertDialogPrimitive.Content.displayName\n\nconst AlertDialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogHeader.displayName = \"AlertDialogHeader\"\n\nconst AlertDialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nAlertDialogFooter.displayName = \"AlertDialogFooter\"\n\nconst AlertDialogTitle = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold\", className)}\n    {...props}\n  />\n))\nAlertDialogTitle.displayName = AlertDialogPrimitive.Title.displayName\n\nconst AlertDialogDescription = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nAlertDialogDescription.displayName =\n  AlertDialogPrimitive.Description.displayName\n\nconst AlertDialogAction = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Action>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Action>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Action\n    ref={ref}\n    className={cn(buttonVariants(), className)}\n    {...props}\n  />\n))\nAlertDialogAction.displayName = AlertDialogPrimitive.Action.displayName\n\nconst AlertDialogCancel = React.forwardRef<\n  React.ElementRef<typeof AlertDialogPrimitive.Cancel>,\n  React.ComponentPropsWithoutRef<typeof AlertDialogPrimitive.Cancel>\n>(({ className, ...props }, ref) => (\n  <AlertDialogPrimitive.Cancel\n    ref={ref}\n    className={cn(\n      buttonVariants({ variant: \"outline\" }),\n      \"mt-2 sm:mt-0\",\n      className\n    )}\n    {...props}\n  />\n))\nAlertDialogCancel.displayName = AlertDialogPrimitive.Cancel.displayName\n\nexport {\n  AlertDialog,\n  AlertDialogPortal,\n  AlertDialogOverlay,\n  AlertDialogTrigger,\n  AlertDialogContent,\n  AlertDialogHeader,\n  AlertDialogFooter,\n  AlertDialogTitle,\n  AlertDialogDescription,\n  AlertDialogAction,\n  AlertDialogCancel,\n}\n","path":null,"size_bytes":4420,"size_tokens":null},"client/src/components/ui/progress.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ProgressPrimitive from \"@radix-ui/react-progress\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Progress = React.forwardRef<\n  React.ElementRef<typeof ProgressPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ProgressPrimitive.Root>\n>(({ className, value, ...props }, ref) => (\n  <ProgressPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative h-4 w-full overflow-hidden rounded-full bg-secondary\",\n      className\n    )}\n    {...props}\n  >\n    <ProgressPrimitive.Indicator\n      className=\"h-full w-full flex-1 bg-primary transition-all\"\n      style={{ transform: `translateX(-${100 - (value || 0)}%)` }}\n    />\n  </ProgressPrimitive.Root>\n))\nProgress.displayName = ProgressPrimitive.Root.displayName\n\nexport { Progress }\n","path":null,"size_bytes":791,"size_tokens":null},"backup/RESTORE_INSTRUCTIONS.md":{"content":"# Restore Instructions for Stable Build\n\n## Quick Restore Commands\nIf new features break the application, use these commands to restore the working state:\n\n```bash\n# Restore critical backend files\ncp backup/schema.ts.backup shared/schema.ts\ncp backup/storage.ts.backup server/storage.ts  \ncp backup/routes.ts.backup server/routes.ts\n\n# Restore package dependencies\ncp backup/package.json.backup package.json\nnpm install\n\n# Restart the application\nnpm run dev\n```\n\n## Database State Verification\nAfter restoring, verify these are working:\n1. Map loads with 304 resources\n2. Analysis points can be created via address input\n3. Distance calculations complete successfully\n4. Contractors page loads with CRUD operations\n5. Export functionality generates files\n\n## Working Test Cases\n- Address: \"lawrence, ks\" → Should create analysis point\n- Address: \"liberal, KS\" → Should create second analysis point\n- Export button → Should download Excel file with calculations\n- Contractors page → Should show searchable contractor list\n\n## Files NOT Backed Up (Safe to Modify)\n- UI components in client/src/components/ui/\n- Styling files (CSS, Tailwind config)\n- Development configuration files\n- Documentation files\n\n## Emergency Rollback\nIf complete restoration is needed:\n1. Check workflow status in Replit\n2. Use BUILD_BACKUP.md to verify features\n3. Compare current behavior vs. documented working state\n4. Restore files as needed using backup files\n\n## Database Reset (If Needed)\n```bash\n# Only if database corruption occurs\nnpm run db:push\n# Re-upload contractor CSV file to restore data\n```\n\nLast Updated: June 27, 2025\nVerified Working State: All features functional","path":null,"size_bytes":1669,"size_tokens":null},"client/src/components/ui/resizable.tsx":{"content":"\"use client\"\n\nimport { GripVertical } from \"lucide-react\"\nimport * as ResizablePrimitive from \"react-resizable-panels\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ResizablePanelGroup = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) => (\n  <ResizablePrimitive.PanelGroup\n    className={cn(\n      \"flex h-full w-full data-[panel-group-direction=vertical]:flex-col\",\n      className\n    )}\n    {...props}\n  />\n)\n\nconst ResizablePanel = ResizablePrimitive.Panel\n\nconst ResizableHandle = ({\n  withHandle,\n  className,\n  ...props\n}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {\n  withHandle?: boolean\n}) => (\n  <ResizablePrimitive.PanelResizeHandle\n    className={cn(\n      \"relative flex w-px items-center justify-center bg-border after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring focus-visible:ring-offset-1 data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90\",\n      className\n    )}\n    {...props}\n  >\n    {withHandle && (\n      <div className=\"z-10 flex h-4 w-3 items-center justify-center rounded-sm border bg-border\">\n        <GripVertical className=\"h-2.5 w-2.5\" />\n      </div>\n    )}\n  </ResizablePrimitive.PanelResizeHandle>\n)\n\nexport { ResizablePanelGroup, ResizablePanel, ResizableHandle }\n","path":null,"size_bytes":1723,"size_tokens":null},"client/src/components/ui/sidebar.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { VariantProps, cva } from \"class-variance-authority\"\nimport { PanelLeft } from \"lucide-react\"\n\nimport { useIsMobile } from \"@/hooks/use-mobile\"\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\nimport { Input } from \"@/components/ui/input\"\nimport { Separator } from \"@/components/ui/separator\"\nimport {\n  Sheet,\n  SheetContent,\n  SheetDescription,\n  SheetHeader,\n  SheetTitle,\n} from \"@/components/ui/sheet\"\nimport { Skeleton } from \"@/components/ui/skeleton\"\nimport {\n  Tooltip,\n  TooltipContent,\n  TooltipProvider,\n  TooltipTrigger,\n} from \"@/components/ui/tooltip\"\n\nconst SIDEBAR_COOKIE_NAME = \"sidebar_state\"\nconst SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7\nconst SIDEBAR_WIDTH = \"16rem\"\nconst SIDEBAR_WIDTH_MOBILE = \"18rem\"\nconst SIDEBAR_WIDTH_ICON = \"3rem\"\nconst SIDEBAR_KEYBOARD_SHORTCUT = \"b\"\n\ntype SidebarContextProps = {\n  state: \"expanded\" | \"collapsed\"\n  open: boolean\n  setOpen: (open: boolean) => void\n  openMobile: boolean\n  setOpenMobile: (open: boolean) => void\n  isMobile: boolean\n  toggleSidebar: () => void\n}\n\nconst SidebarContext = React.createContext<SidebarContextProps | null>(null)\n\nfunction useSidebar() {\n  const context = React.useContext(SidebarContext)\n  if (!context) {\n    throw new Error(\"useSidebar must be used within a SidebarProvider.\")\n  }\n\n  return context\n}\n\nconst SidebarProvider = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    defaultOpen?: boolean\n    open?: boolean\n    onOpenChange?: (open: boolean) => void\n  }\n>(\n  (\n    {\n      defaultOpen = true,\n      open: openProp,\n      onOpenChange: setOpenProp,\n      className,\n      style,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const isMobile = useIsMobile()\n    const [openMobile, setOpenMobile] = React.useState(false)\n\n    // This is the internal state of the sidebar.\n    // We use openProp and setOpenProp for control from outside the component.\n    const [_open, _setOpen] = React.useState(defaultOpen)\n    const open = openProp ?? _open\n    const setOpen = React.useCallback(\n      (value: boolean | ((value: boolean) => boolean)) => {\n        const openState = typeof value === \"function\" ? value(open) : value\n        if (setOpenProp) {\n          setOpenProp(openState)\n        } else {\n          _setOpen(openState)\n        }\n\n        // This sets the cookie to keep the sidebar state.\n        document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`\n      },\n      [setOpenProp, open]\n    )\n\n    // Helper to toggle the sidebar.\n    const toggleSidebar = React.useCallback(() => {\n      return isMobile\n        ? setOpenMobile((open) => !open)\n        : setOpen((open) => !open)\n    }, [isMobile, setOpen, setOpenMobile])\n\n    // Adds a keyboard shortcut to toggle the sidebar.\n    React.useEffect(() => {\n      const handleKeyDown = (event: KeyboardEvent) => {\n        if (\n          event.key === SIDEBAR_KEYBOARD_SHORTCUT &&\n          (event.metaKey || event.ctrlKey)\n        ) {\n          event.preventDefault()\n          toggleSidebar()\n        }\n      }\n\n      window.addEventListener(\"keydown\", handleKeyDown)\n      return () => window.removeEventListener(\"keydown\", handleKeyDown)\n    }, [toggleSidebar])\n\n    // We add a state so that we can do data-state=\"expanded\" or \"collapsed\".\n    // This makes it easier to style the sidebar with Tailwind classes.\n    const state = open ? \"expanded\" : \"collapsed\"\n\n    const contextValue = React.useMemo<SidebarContextProps>(\n      () => ({\n        state,\n        open,\n        setOpen,\n        isMobile,\n        openMobile,\n        setOpenMobile,\n        toggleSidebar,\n      }),\n      [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar]\n    )\n\n    return (\n      <SidebarContext.Provider value={contextValue}>\n        <TooltipProvider delayDuration={0}>\n          <div\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH,\n                \"--sidebar-width-icon\": SIDEBAR_WIDTH_ICON,\n                ...style,\n              } as React.CSSProperties\n            }\n            className={cn(\n              \"group/sidebar-wrapper flex min-h-svh w-full has-[[data-variant=inset]]:bg-sidebar\",\n              className\n            )}\n            ref={ref}\n            {...props}\n          >\n            {children}\n          </div>\n        </TooltipProvider>\n      </SidebarContext.Provider>\n    )\n  }\n)\nSidebarProvider.displayName = \"SidebarProvider\"\n\nconst Sidebar = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    side?: \"left\" | \"right\"\n    variant?: \"sidebar\" | \"floating\" | \"inset\"\n    collapsible?: \"offcanvas\" | \"icon\" | \"none\"\n  }\n>(\n  (\n    {\n      side = \"left\",\n      variant = \"sidebar\",\n      collapsible = \"offcanvas\",\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const { isMobile, state, openMobile, setOpenMobile } = useSidebar()\n\n    if (collapsible === \"none\") {\n      return (\n        <div\n          className={cn(\n            \"flex h-full w-[--sidebar-width] flex-col bg-sidebar text-sidebar-foreground\",\n            className\n          )}\n          ref={ref}\n          {...props}\n        >\n          {children}\n        </div>\n      )\n    }\n\n    if (isMobile) {\n      return (\n        <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>\n          <SheetContent\n            data-sidebar=\"sidebar\"\n            data-mobile=\"true\"\n            className=\"w-[--sidebar-width] bg-sidebar p-0 text-sidebar-foreground [&>button]:hidden\"\n            style={\n              {\n                \"--sidebar-width\": SIDEBAR_WIDTH_MOBILE,\n              } as React.CSSProperties\n            }\n            side={side}\n          >\n            <SheetHeader className=\"sr-only\">\n              <SheetTitle>Sidebar</SheetTitle>\n              <SheetDescription>Displays the mobile sidebar.</SheetDescription>\n            </SheetHeader>\n            <div className=\"flex h-full w-full flex-col\">{children}</div>\n          </SheetContent>\n        </Sheet>\n      )\n    }\n\n    return (\n      <div\n        ref={ref}\n        className=\"group peer hidden text-sidebar-foreground md:block\"\n        data-state={state}\n        data-collapsible={state === \"collapsed\" ? collapsible : \"\"}\n        data-variant={variant}\n        data-side={side}\n      >\n        {/* This is what handles the sidebar gap on desktop */}\n        <div\n          className={cn(\n            \"relative w-[--sidebar-width] bg-transparent transition-[width] duration-200 ease-linear\",\n            \"group-data-[collapsible=offcanvas]:w-0\",\n            \"group-data-[side=right]:rotate-180\",\n            variant === \"floating\" || variant === \"inset\"\n              ? \"group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4))]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon]\"\n          )}\n        />\n        <div\n          className={cn(\n            \"fixed inset-y-0 z-10 hidden h-svh w-[--sidebar-width] transition-[left,right,width] duration-200 ease-linear md:flex\",\n            side === \"left\"\n              ? \"left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]\"\n              : \"right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]\",\n            // Adjust the padding for floating and inset variants.\n            variant === \"floating\" || variant === \"inset\"\n              ? \"p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)_+_theme(spacing.4)_+2px)]\"\n              : \"group-data-[collapsible=icon]:w-[--sidebar-width-icon] group-data-[side=left]:border-r group-data-[side=right]:border-l\",\n            className\n          )}\n          {...props}\n        >\n          <div\n            data-sidebar=\"sidebar\"\n            className=\"flex h-full w-full flex-col bg-sidebar group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:border-sidebar-border group-data-[variant=floating]:shadow\"\n          >\n            {children}\n          </div>\n        </div>\n      </div>\n    )\n  }\n)\nSidebar.displayName = \"Sidebar\"\n\nconst SidebarTrigger = React.forwardRef<\n  React.ElementRef<typeof Button>,\n  React.ComponentProps<typeof Button>\n>(({ className, onClick, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <Button\n      ref={ref}\n      data-sidebar=\"trigger\"\n      variant=\"ghost\"\n      size=\"icon\"\n      className={cn(\"h-7 w-7\", className)}\n      onClick={(event) => {\n        onClick?.(event)\n        toggleSidebar()\n      }}\n      {...props}\n    >\n      <PanelLeft />\n      <span className=\"sr-only\">Toggle Sidebar</span>\n    </Button>\n  )\n})\nSidebarTrigger.displayName = \"SidebarTrigger\"\n\nconst SidebarRail = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\">\n>(({ className, ...props }, ref) => {\n  const { toggleSidebar } = useSidebar()\n\n  return (\n    <button\n      ref={ref}\n      data-sidebar=\"rail\"\n      aria-label=\"Toggle Sidebar\"\n      tabIndex={-1}\n      onClick={toggleSidebar}\n      title=\"Toggle Sidebar\"\n      className={cn(\n        \"absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] hover:after:bg-sidebar-border group-data-[side=left]:-right-4 group-data-[side=right]:left-0 sm:flex\",\n        \"[[data-side=left]_&]:cursor-w-resize [[data-side=right]_&]:cursor-e-resize\",\n        \"[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize\",\n        \"group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full group-data-[collapsible=offcanvas]:hover:bg-sidebar\",\n        \"[[data-side=left][data-collapsible=offcanvas]_&]:-right-2\",\n        \"[[data-side=right][data-collapsible=offcanvas]_&]:-left-2\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarRail.displayName = \"SidebarRail\"\n\nconst SidebarInset = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"main\">\n>(({ className, ...props }, ref) => {\n  return (\n    <main\n      ref={ref}\n      className={cn(\n        \"relative flex w-full flex-1 flex-col bg-background\",\n        \"md:peer-data-[variant=inset]:m-2 md:peer-data-[state=collapsed]:peer-data-[variant=inset]:ml-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInset.displayName = \"SidebarInset\"\n\nconst SidebarInput = React.forwardRef<\n  React.ElementRef<typeof Input>,\n  React.ComponentProps<typeof Input>\n>(({ className, ...props }, ref) => {\n  return (\n    <Input\n      ref={ref}\n      data-sidebar=\"input\"\n      className={cn(\n        \"h-8 w-full bg-background shadow-none focus-visible:ring-2 focus-visible:ring-sidebar-ring\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarInput.displayName = \"SidebarInput\"\n\nconst SidebarHeader = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"header\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarHeader.displayName = \"SidebarHeader\"\n\nconst SidebarFooter = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"footer\"\n      className={cn(\"flex flex-col gap-2 p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarFooter.displayName = \"SidebarFooter\"\n\nconst SidebarSeparator = React.forwardRef<\n  React.ElementRef<typeof Separator>,\n  React.ComponentProps<typeof Separator>\n>(({ className, ...props }, ref) => {\n  return (\n    <Separator\n      ref={ref}\n      data-sidebar=\"separator\"\n      className={cn(\"mx-2 w-auto bg-sidebar-border\", className)}\n      {...props}\n    />\n  )\n})\nSidebarSeparator.displayName = \"SidebarSeparator\"\n\nconst SidebarContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"content\"\n      className={cn(\n        \"flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarContent.displayName = \"SidebarContent\"\n\nconst SidebarGroup = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => {\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"group\"\n      className={cn(\"relative flex w-full min-w-0 flex-col p-2\", className)}\n      {...props}\n    />\n  )\n})\nSidebarGroup.displayName = \"SidebarGroup\"\n\nconst SidebarGroupLabel = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"div\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-label\"\n      className={cn(\n        \"flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium text-sidebar-foreground/70 outline-none ring-sidebar-ring transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        \"group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupLabel.displayName = \"SidebarGroupLabel\"\n\nconst SidebarGroupAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & { asChild?: boolean }\n>(({ className, asChild = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"group-action\"\n      className={cn(\n        \"absolute right-3 top-3.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarGroupAction.displayName = \"SidebarGroupAction\"\n\nconst SidebarGroupContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"group-content\"\n    className={cn(\"w-full text-sm\", className)}\n    {...props}\n  />\n))\nSidebarGroupContent.displayName = \"SidebarGroupContent\"\n\nconst SidebarMenu = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu\"\n    className={cn(\"flex w-full min-w-0 flex-col gap-1\", className)}\n    {...props}\n  />\n))\nSidebarMenu.displayName = \"SidebarMenu\"\n\nconst SidebarMenuItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    data-sidebar=\"menu-item\"\n    className={cn(\"group/menu-item relative\", className)}\n    {...props}\n  />\n))\nSidebarMenuItem.displayName = \"SidebarMenuItem\"\n\nconst sidebarMenuButtonVariants = cva(\n  \"peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-none ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-[[data-sidebar=menu-action]]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:!size-8 group-data-[collapsible=icon]:!p-2 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"hover:bg-sidebar-accent hover:text-sidebar-accent-foreground\",\n        outline:\n          \"bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]\",\n      },\n      size: {\n        default: \"h-8 text-sm\",\n        sm: \"h-7 text-xs\",\n        lg: \"h-12 text-sm group-data-[collapsible=icon]:!p-0\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst SidebarMenuButton = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    isActive?: boolean\n    tooltip?: string | React.ComponentProps<typeof TooltipContent>\n  } & VariantProps<typeof sidebarMenuButtonVariants>\n>(\n  (\n    {\n      asChild = false,\n      isActive = false,\n      variant = \"default\",\n      size = \"default\",\n      tooltip,\n      className,\n      ...props\n    },\n    ref\n  ) => {\n    const Comp = asChild ? Slot : \"button\"\n    const { isMobile, state } = useSidebar()\n\n    const button = (\n      <Comp\n        ref={ref}\n        data-sidebar=\"menu-button\"\n        data-size={size}\n        data-active={isActive}\n        className={cn(sidebarMenuButtonVariants({ variant, size }), className)}\n        {...props}\n      />\n    )\n\n    if (!tooltip) {\n      return button\n    }\n\n    if (typeof tooltip === \"string\") {\n      tooltip = {\n        children: tooltip,\n      }\n    }\n\n    return (\n      <Tooltip>\n        <TooltipTrigger asChild>{button}</TooltipTrigger>\n        <TooltipContent\n          side=\"right\"\n          align=\"center\"\n          hidden={state !== \"collapsed\" || isMobile}\n          {...tooltip}\n        />\n      </Tooltip>\n    )\n  }\n)\nSidebarMenuButton.displayName = \"SidebarMenuButton\"\n\nconst SidebarMenuAction = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<\"button\"> & {\n    asChild?: boolean\n    showOnHover?: boolean\n  }\n>(({ className, asChild = false, showOnHover = false, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"button\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-action\"\n      className={cn(\n        \"absolute right-1 top-1.5 flex aspect-square w-5 items-center justify-center rounded-md p-0 text-sidebar-foreground outline-none ring-sidebar-ring transition-transform hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 peer-hover/menu-button:text-sidebar-accent-foreground [&>svg]:size-4 [&>svg]:shrink-0\",\n        // Increases the hit area of the button on mobile.\n        \"after:absolute after:-inset-2 after:md:hidden\",\n        \"peer-data-[size=sm]/menu-button:top-1\",\n        \"peer-data-[size=default]/menu-button:top-1.5\",\n        \"peer-data-[size=lg]/menu-button:top-2.5\",\n        \"group-data-[collapsible=icon]:hidden\",\n        showOnHover &&\n          \"group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 peer-data-[active=true]/menu-button:text-sidebar-accent-foreground md:opacity-0\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuAction.displayName = \"SidebarMenuAction\"\n\nconst SidebarMenuBadge = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\">\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    data-sidebar=\"menu-badge\"\n    className={cn(\n      \"pointer-events-none absolute right-1 flex h-5 min-w-5 select-none items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums text-sidebar-foreground\",\n      \"peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground\",\n      \"peer-data-[size=sm]/menu-button:top-1\",\n      \"peer-data-[size=default]/menu-button:top-1.5\",\n      \"peer-data-[size=lg]/menu-button:top-2.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuBadge.displayName = \"SidebarMenuBadge\"\n\nconst SidebarMenuSkeleton = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    showIcon?: boolean\n  }\n>(({ className, showIcon = false, ...props }, ref) => {\n  // Random width between 50 to 90%.\n  const width = React.useMemo(() => {\n    return `${Math.floor(Math.random() * 40) + 50}%`\n  }, [])\n\n  return (\n    <div\n      ref={ref}\n      data-sidebar=\"menu-skeleton\"\n      className={cn(\"flex h-8 items-center gap-2 rounded-md px-2\", className)}\n      {...props}\n    >\n      {showIcon && (\n        <Skeleton\n          className=\"size-4 rounded-md\"\n          data-sidebar=\"menu-skeleton-icon\"\n        />\n      )}\n      <Skeleton\n        className=\"h-4 max-w-[--skeleton-width] flex-1\"\n        data-sidebar=\"menu-skeleton-text\"\n        style={\n          {\n            \"--skeleton-width\": width,\n          } as React.CSSProperties\n        }\n      />\n    </div>\n  )\n})\nSidebarMenuSkeleton.displayName = \"SidebarMenuSkeleton\"\n\nconst SidebarMenuSub = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    data-sidebar=\"menu-sub\"\n    className={cn(\n      \"mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l border-sidebar-border px-2.5 py-0.5\",\n      \"group-data-[collapsible=icon]:hidden\",\n      className\n    )}\n    {...props}\n  />\n))\nSidebarMenuSub.displayName = \"SidebarMenuSub\"\n\nconst SidebarMenuSubItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ ...props }, ref) => <li ref={ref} {...props} />)\nSidebarMenuSubItem.displayName = \"SidebarMenuSubItem\"\n\nconst SidebarMenuSubButton = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentProps<\"a\"> & {\n    asChild?: boolean\n    size?: \"sm\" | \"md\"\n    isActive?: boolean\n  }\n>(({ asChild = false, size = \"md\", isActive, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      data-sidebar=\"menu-sub-button\"\n      data-size={size}\n      data-active={isActive}\n      className={cn(\n        \"flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 text-sidebar-foreground outline-none ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0 [&>svg]:text-sidebar-accent-foreground\",\n        \"data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground\",\n        size === \"sm\" && \"text-xs\",\n        size === \"md\" && \"text-sm\",\n        \"group-data-[collapsible=icon]:hidden\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nSidebarMenuSubButton.displayName = \"SidebarMenuSubButton\"\n\nexport {\n  Sidebar,\n  SidebarContent,\n  SidebarFooter,\n  SidebarGroup,\n  SidebarGroupAction,\n  SidebarGroupContent,\n  SidebarGroupLabel,\n  SidebarHeader,\n  SidebarInput,\n  SidebarInset,\n  SidebarMenu,\n  SidebarMenuAction,\n  SidebarMenuBadge,\n  SidebarMenuButton,\n  SidebarMenuItem,\n  SidebarMenuSkeleton,\n  SidebarMenuSub,\n  SidebarMenuSubButton,\n  SidebarMenuSubItem,\n  SidebarProvider,\n  SidebarRail,\n  SidebarSeparator,\n  SidebarTrigger,\n  useSidebar,\n}\n","path":null,"size_bytes":23567,"size_tokens":null},"client/src/pages/contractor-form.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { CheckCircle, Truck, Calendar, Building, User, Phone, Mail, AlertCircle } from \"lucide-react\";\nimport { useLocation } from \"wouter\";\n\nconst categories = [\"Union\", \"Non-Union\", \"Veg\", \"HVAC\", \"DAT\", \"Consulting\"];\n\nexport default function ContractorAvailabilityForm() {\n  const { toast } = useToast();\n  const [location] = useLocation();\n  const [hasSubcontractor, setHasSubcontractor] = useState(false);\n  const [isSubmitted, setIsSubmitted] = useState(false);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [sessionId, setSessionId] = useState<string | null>(null);\n  const [sessionLabel, setSessionLabel] = useState<string>(\"\");\n  const [departureCoords, setDepartureCoords] = useState<{lat: number, lon: number} | null>(null);\n  const [subDepartureCoords, setSubDepartureCoords] = useState<{lat: number, lon: number} | null>(null);\n  const [isValidatingLocation, setIsValidatingLocation] = useState(false);\n\n  // Extract session ID from URL\n  useEffect(() => {\n    const params = new URLSearchParams(window.location.search);\n    const sessionParam = params.get('session');\n    setSessionId(sessionParam);\n  }, [location]);\n\n  // Fetch session details if sessionId is provided\n  const { data: sessionData, isLoading: isLoadingSession } = useQuery({\n    queryKey: [\"/api/availability-sessions\", sessionId],\n    queryFn: async () => {\n      if (!sessionId || sessionId === 'active') return null;\n      const response = await fetch(`/api/availability-sessions/${sessionId}`);\n      if (!response.ok) return null;\n      return response.json();\n    },\n    enabled: !!sessionId && sessionId !== 'active'\n  });\n\n  useEffect(() => {\n    if (sessionData) {\n      setSessionLabel(sessionData.label);\n    } else if (sessionId === 'active') {\n      setSessionLabel('Active Session');\n    } else if (!sessionId) {\n      setSessionLabel('Active Session (default)');\n    }\n  }, [sessionData, sessionId]);\n\n  // Geocoding validation function\n  const validateLocation = async (location: string): Promise<{lat: number, lon: number} | null> => {\n    try {\n      const response = await fetch('/api/geocode', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ location })\n      });\n      \n      const data = await response.json();\n      \n      if (data.success) {\n        return { lat: data.latitude, lon: data.longitude };\n      } else {\n        toast({\n          title: \"Invalid Location\",\n          description: data.message || \"Please enter a valid city and state (e.g., 'Atlanta, GA')\",\n          variant: \"destructive\"\n        });\n        return null;\n      }\n    } catch (error) {\n      toast({\n        title: \"Validation Error\",\n        description: \"Could not validate location. Please try again.\",\n        variant: \"destructive\"\n      });\n      return null;\n    }\n  };\n\n  // Form submission mutation\n  const submitMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest('POST', '/api/contractor-submissions', data);\n    },\n    onSuccess: () => {\n      setIsSubmitted(true);\n      toast({\n        title: \"Submission Successful\",\n        description: \"Your availability information has been submitted successfully. We will review it and contact you soon.\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Submission Failed\",\n        description: error.message || \"Could not submit your availability information. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleSubmit = async (event: React.FormEvent<HTMLFormElement>) => {\n    event.preventDefault();\n    setIsSubmitting(true);\n    setIsValidatingLocation(true);\n    \n    const formData = new FormData(event.currentTarget);\n    const departureCity = formData.get('departureCity') as string;\n    const departureState = formData.get('departureState') as string;\n    const departureLocation = `${departureCity}, ${departureState}`;\n    \n    const subDepartureCity = formData.get('subDepartureCity') as string;\n    const subDepartureState = formData.get('subDepartureState') as string;\n    const subDepartureLocation = hasSubcontractor && subDepartureCity && subDepartureState \n      ? `${subDepartureCity}, ${subDepartureState}` \n      : '';\n    \n    // Validate main departure location\n    const coords = await validateLocation(departureLocation);\n    if (!coords) {\n      setIsSubmitting(false);\n      setIsValidatingLocation(false);\n      return;\n    }\n    setDepartureCoords(coords);\n    \n    // Validate subcontractor departure location if present\n    let subCoords = null;\n    if (hasSubcontractor && subDepartureLocation) {\n      subCoords = await validateLocation(subDepartureLocation);\n      if (!subCoords) {\n        setIsSubmitting(false);\n        setIsValidatingLocation(false);\n        return;\n      }\n      setSubDepartureCoords(subCoords);\n    }\n    \n    setIsValidatingLocation(false);\n    \n    const data = {\n      // Company Information\n      contractorName: formData.get('contractorName'),\n      companyName: formData.get('companyName'),\n      email: formData.get('email'),\n      phone: formData.get('phone'),\n      category: formData.get('category'),\n      birdRep: formData.get('birdRep') || 'TBD',\n      \n      // Availability Information with geocoded coordinates and separate city/state\n      departureCity,\n      departureState,\n      departureLocation,\n      departureLatitude: coords.lat,\n      departureLongitude: coords.lon,\n      totalFTE: parseInt(formData.get('totalFTE') as string) || 0,\n      buckets: parseInt(formData.get('buckets') as string) || 0,\n      diggers: parseInt(formData.get('diggers') as string) || 0,\n      pickups: parseInt(formData.get('pickups') as string) || 0,\n      backyardMachines: parseInt(formData.get('backyardMachines') as string) || 0,\n      notes: formData.get('notes'),\n      submittedBy: 'contractor', // Identify as contractor submission\n      \n      // Session ID - link submission to specific session\n      sessionId: sessionId || 'active',\n      \n      // Subcontractor data with geocoded coordinates and separate city/state\n      hasSubcontractor,\n      subcontractorData: hasSubcontractor ? {\n        name: formData.get('subName'),\n        company: formData.get('subCompany'),\n        departureCity: subDepartureCity,\n        departureState: subDepartureState,\n        departureLocation: subDepartureLocation,\n        departureLatitude: subCoords?.lat,\n        departureLongitude: subCoords?.lon,\n        totalFTE: parseInt(formData.get('subTotalFTE') as string) || 0,\n        buckets: parseInt(formData.get('subBuckets') as string) || 0,\n        diggers: parseInt(formData.get('subDiggers') as string) || 0,\n        pickups: parseInt(formData.get('subPickups') as string) || 0,\n        backyardMachines: parseInt(formData.get('subBackyardMachines') as string) || 0,\n      } : undefined\n    };\n\n    submitMutation.mutate(data);\n    setIsSubmitting(false);\n  };\n\n  if (isSubmitted) {\n    return (\n      <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-gray-100 flex items-center justify-center p-4\">\n        <Card className=\"w-full max-w-md\">\n          <CardContent className=\"text-center p-8\">\n            <CheckCircle className=\"w-16 h-16 text-green-500 mx-auto mb-4\" />\n            <h2 className=\"text-2xl font-bold text-gray-900 mb-2\">\n              Submission Successful!\n            </h2>\n            <p className=\"text-gray-600 mb-6\">\n              Thank you for submitting your availability information. Our team will review your submission and contact you within 24 hours.\n            </p>\n            <div className=\"text-sm text-gray-500\">\n              <p>Need to make changes?</p>\n              <p>Please contact our operations team directly.</p>\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-gray-100 py-8 px-4\">\n      <div className=\"max-w-4xl mx-auto\">\n        {/* Header */}\n        <div className=\"text-center mb-8\">\n          <div className=\"flex items-center justify-center mb-4\">\n            <div className=\"bg-blue-600 p-3 rounded-full\">\n              <Truck className=\"w-8 h-8 text-white\" />\n            </div>\n          </div>\n          <h1 className=\"text-3xl font-bold text-gray-900 mb-2\">\n            Contractor Availability Submission\n          </h1>\n          {sessionLabel && (\n            <div className=\"inline-flex items-center gap-2 bg-blue-100 text-blue-800 px-4 py-2 rounded-full mb-2\">\n              <Calendar className=\"w-4 h-4\" />\n              <span className=\"font-semibold\">Session: {sessionLabel}</span>\n            </div>\n          )}\n          <p className=\"text-gray-600 max-w-2xl mx-auto mt-2\">\n            Submit your crew and equipment availability information. All fields are required unless marked as optional.\n          </p>\n        </div>\n\n        {/* Warning if no session or invalid session */}\n        {!sessionId && (\n          <Card className=\"mb-6 border-yellow-200 bg-yellow-50\">\n            <CardContent className=\"p-4 flex items-start gap-3\">\n              <AlertCircle className=\"w-5 h-5 text-yellow-600 mt-0.5\" />\n              <div>\n                <p className=\"font-semibold text-yellow-800\">No Session Specified</p>\n                <p className=\"text-sm text-yellow-700\">\n                  This form link doesn't specify a session. Your submission will be added to the active session. \n                  If you received a specific form link, please use that instead.\n                </p>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Building className=\"w-5 h-5\" />\n              Company & Contact Information\n            </CardTitle>\n            <CardDescription>\n              Provide your company details and primary contact information\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <form onSubmit={handleSubmit} className=\"space-y-8\">\n              {/* Company Information Section */}\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                <div>\n                  <Label htmlFor=\"contractorName\">Contact Person Name *</Label>\n                  <Input\n                    id=\"contractorName\"\n                    name=\"contractorName\"\n                    placeholder=\"John Smith\"\n                    required\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"companyName\">Company Name *</Label>\n                  <Input\n                    id=\"companyName\"\n                    name=\"companyName\"\n                    placeholder=\"ABC Electrical Services\"\n                    required\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"email\">Email Address *</Label>\n                  <Input\n                    id=\"email\"\n                    name=\"email\"\n                    type=\"email\"\n                    placeholder=\"contact@company.com\"\n                    required\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"phone\">Phone Number *</Label>\n                  <Input\n                    id=\"phone\"\n                    name=\"phone\"\n                    type=\"tel\"\n                    placeholder=\"(555) 123-4567\"\n                    required\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"category\">Company Category *</Label>\n                  <Select name=\"category\" required>\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Select category\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {categories.map((category) => (\n                        <SelectItem key={category} value={category}>\n                          {category}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div>\n                  <Label htmlFor=\"birdRep\">Bird Representative (Optional)</Label>\n                  <Input\n                    id=\"birdRep\"\n                    name=\"birdRep\"\n                    placeholder=\"Representative name\"\n                  />\n                </div>\n              </div>\n\n              {/* Availability Information Section */}\n              <div className=\"border-t pt-8\">\n                <div className=\"mb-6\">\n                  <h3 className=\"text-xl font-semibold text-gray-900 flex items-center gap-2 mb-2\">\n                    <User className=\"w-5 h-5\" />\n                    Crew & Equipment Availability\n                  </h3>\n                  <p className=\"text-gray-600\">\n                    Provide details about your available crew and equipment\n                  </p>\n                </div>\n                \n                <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                  <div>\n                    <Label htmlFor=\"departureCity\">Departure City *</Label>\n                    <Input\n                      id=\"departureCity\"\n                      name=\"departureCity\"\n                      placeholder=\"e.g., Atlanta\"\n                      required\n                      data-testid=\"input-departure-city\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"departureState\">Departure State *</Label>\n                    <Input\n                      id=\"departureState\"\n                      name=\"departureState\"\n                      placeholder=\"e.g., TX\"\n                      required\n                      data-testid=\"input-departure-state\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"totalFTE\">Total FTE (Full Time Equivalent) *</Label>\n                    <Input\n                      id=\"totalFTE\"\n                      name=\"totalFTE\"\n                      type=\"number\"\n                      min=\"0\"\n                      placeholder=\"0\"\n                      required\n                    />\n                  </div>\n                </div>\n\n                {/* Equipment Section */}\n                <div className=\"mt-6\">\n                  <h4 className=\"text-lg font-medium text-gray-900 mb-4\">Equipment Available</h4>\n                  <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                    <div>\n                      <Label htmlFor=\"buckets\">Bucket Trucks</Label>\n                      <Input\n                        id=\"buckets\"\n                        name=\"buckets\"\n                        type=\"number\"\n                        min=\"0\"\n                        defaultValue=\"0\"\n                        placeholder=\"0\"\n                      />\n                    </div>\n                    <div>\n                      <Label htmlFor=\"diggers\">Digger Trucks</Label>\n                      <Input\n                        id=\"diggers\"\n                        name=\"diggers\"\n                        type=\"number\"\n                        min=\"0\"\n                        defaultValue=\"0\"\n                        placeholder=\"0\"\n                      />\n                    </div>\n                    <div>\n                      <Label htmlFor=\"pickups\">Pickup Trucks</Label>\n                      <Input\n                        id=\"pickups\"\n                        name=\"pickups\"\n                        type=\"number\"\n                        min=\"0\"\n                        defaultValue=\"0\"\n                        placeholder=\"0\"\n                      />\n                    </div>\n                    <div>\n                      <Label htmlFor=\"backyardMachines\">Backyard Machines</Label>\n                      <Input\n                        id=\"backyardMachines\"\n                        name=\"backyardMachines\"\n                        type=\"number\"\n                        min=\"0\"\n                        defaultValue=\"0\"\n                        placeholder=\"0\"\n                      />\n                    </div>\n                  </div>\n                </div>\n              </div>\n\n              {/* Subcontractor Section */}\n              <div className=\"border-t pt-8\">\n                <div className=\"flex items-center space-x-2 mb-6\">\n                  <Checkbox \n                    id=\"hasSubcontractor\" \n                    checked={hasSubcontractor} \n                    onCheckedChange={(checked) => setHasSubcontractor(checked === true)}\n                  />\n                  <Label htmlFor=\"hasSubcontractor\" className=\"text-lg font-medium\">\n                    I am bringing subcontractors\n                  </Label>\n                </div>\n\n                {hasSubcontractor && (\n                  <div className=\"bg-gray-50 rounded-lg p-6 space-y-6\">\n                    <h4 className=\"text-lg font-medium text-gray-900\">Subcontractor Information</h4>\n                    \n                    <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\n                      <div>\n                        <Label htmlFor=\"subName\">Subcontractor Contact Name *</Label>\n                        <Input\n                          id=\"subName\"\n                          name=\"subName\"\n                          placeholder=\"Jane Doe\"\n                          required={hasSubcontractor}\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"subCompany\">Subcontractor Company Name *</Label>\n                        <Input\n                          id=\"subCompany\"\n                          name=\"subCompany\"\n                          placeholder=\"XYZ Contracting\"\n                          required={hasSubcontractor}\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"subDepartureCity\">Subcontractor Departure City *</Label>\n                        <Input\n                          id=\"subDepartureCity\"\n                          name=\"subDepartureCity\"\n                          placeholder=\"e.g., Columbus\"\n                          required={hasSubcontractor}\n                          data-testid=\"input-sub-departure-city\"\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"subDepartureState\">Subcontractor Departure State *</Label>\n                        <Input\n                          id=\"subDepartureState\"\n                          name=\"subDepartureState\"\n                          placeholder=\"e.g., TX\"\n                          required={hasSubcontractor}\n                          data-testid=\"input-sub-departure-state\"\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"subTotalFTE\">Subcontractor FTE *</Label>\n                        <Input\n                          id=\"subTotalFTE\"\n                          name=\"subTotalFTE\"\n                          type=\"number\"\n                          min=\"0\"\n                          placeholder=\"0\"\n                          required={hasSubcontractor}\n                        />\n                      </div>\n                    </div>\n\n                    <div>\n                      <h5 className=\"text-md font-medium text-gray-900 mb-4\">Subcontractor Equipment</h5>\n                      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n                        <div>\n                          <Label htmlFor=\"subBuckets\">Bucket Trucks</Label>\n                          <Input\n                            id=\"subBuckets\"\n                            name=\"subBuckets\"\n                            type=\"number\"\n                            min=\"0\"\n                            defaultValue=\"0\"\n                            placeholder=\"0\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"subDiggers\">Digger Trucks</Label>\n                          <Input\n                            id=\"subDiggers\"\n                            name=\"subDiggers\"\n                            type=\"number\"\n                            min=\"0\"\n                            defaultValue=\"0\"\n                            placeholder=\"0\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"subPickups\">Pickup Trucks</Label>\n                          <Input\n                            id=\"subPickups\"\n                            name=\"subPickups\"\n                            type=\"number\"\n                            min=\"0\"\n                            defaultValue=\"0\"\n                            placeholder=\"0\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"subBackyardMachines\">Backyard Machines</Label>\n                          <Input\n                            id=\"subBackyardMachines\"\n                            name=\"subBackyardMachines\"\n                            type=\"number\"\n                            min=\"0\"\n                            defaultValue=\"0\"\n                            placeholder=\"0\"\n                          />\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                )}\n              </div>\n\n              {/* Notes Section */}\n              <div className=\"border-t pt-8\">\n                <div>\n                  <Label htmlFor=\"notes\">Additional Notes (Optional)</Label>\n                  <Textarea\n                    id=\"notes\"\n                    name=\"notes\"\n                    placeholder=\"Any additional information about your availability, special requirements, or equipment...\"\n                    rows={4}\n                  />\n                </div>\n              </div>\n\n              {/* Submit Button */}\n              <div className=\"border-t pt-8\">\n                <div className=\"flex justify-center\">\n                  <Button \n                    type=\"submit\" \n                    size=\"lg\"\n                    disabled={isSubmitting || submitMutation.isPending}\n                    className=\"px-8 py-3\"\n                  >\n                    {isSubmitting || submitMutation.isPending ? (\n                      <>\n                        <Calendar className=\"w-4 h-4 mr-2 animate-spin\" />\n                        Submitting...\n                      </>\n                    ) : (\n                      <>\n                        <CheckCircle className=\"w-4 h-4 mr-2\" />\n                        Submit Availability\n                      </>\n                    )}\n                  </Button>\n                </div>\n              </div>\n            </form>\n          </CardContent>\n        </Card>\n\n        {/* Footer */}\n        <div className=\"text-center mt-8 text-sm text-gray-500\">\n          <p>\n            Questions about this form? Contact our operations team for assistance.\n          </p>\n        </div>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":23949,"size_tokens":null},"client/src/components/MapContainer.tsx":{"content":"import { useEffect, useRef, useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { ChevronUp, ChevronDown } from \"lucide-react\";\nimport { getMarkerColor, getResourceColor } from \"@/lib/mapUtils\";\nimport WeatherMapLayers from \"./WeatherMapLayers\";\nimport { useWeatherData } from \"@/hooks/useWeatherData\";\nimport type { Resource, AnalysisPoint, Contractor } from \"@shared/schema\";\n\nimport L from 'leaflet';\nimport 'leaflet/dist/leaflet.css';\n\n// Fix for default markers in Vite\ndelete (L.Icon.Default.prototype as any)._getIconUrl;\nL.Icon.Default.mergeOptions({\n  iconRetinaUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon-2x.png',\n  iconUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-icon.png',\n  shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',\n});\n\ninterface MapContainerProps {\n  resources: Resource[];\n  analysisPoints: AnalysisPoint[];\n  contractors?: Contractor[];\n  selectedPointId: number | null;\n  onCreatePoint: (point: { label: string; latitude: number; longitude: number }) => void;\n  isSelectingPoint?: boolean;\n  closestDistance?: number | null;\n  maxDistance?: number | null;\n  maxHours?: number | null;\n  isOutlookLayerVisible?: boolean;\n  isUtilitiesLayerVisible?: boolean;\n  visibleDays?: { [key: number]: boolean };\n}\n\nexport default function MapContainer({\n  resources,\n  analysisPoints,\n  contractors = [],\n  selectedPointId,\n  onCreatePoint,\n  isSelectingPoint = false,\n  closestDistance = null,\n  maxDistance = null,\n  maxHours = null,\n  isOutlookLayerVisible = false,\n  isUtilitiesLayerVisible = false,\n  visibleDays = { 1: true, 2: true, 3: true }\n}: MapContainerProps) {\n  const mapRef = useRef<HTMLDivElement>(null);\n  const mapInstanceRef = useRef<any>(null);\n  const markersRef = useRef<Map<string, any>>(new Map());\n  const distanceCircleRef = useRef<any>(null);\n  const [mouseCoords, setMouseCoords] = useState({ lat: 0, lng: 0 });\n  const [zoom, setZoom] = useState(6);\n  const [isLegendCollapsed, setIsLegendCollapsed] = useState(false);\n  \n  // Get weather data for map layers\n  const { outlookData, utilitiesData } = useWeatherData();\n\n  // Initialize map (runs only once)\n  useEffect(() => {\n    if (!mapRef.current || mapInstanceRef.current) return;\n\n    console.log('Initializing map...');\n    \n    const map = L.map(mapRef.current, {\n      zoomControl: false // Disable default zoom controls to avoid duplicates\n    }).setView([33.7490, -84.3880], 6);\n    \n    // Add zoom control to top-right position\n    L.control.zoom({\n      position: 'topright'\n    }).addTo(map);\n    \n    console.log('Map created, adding tile layer...');\n    \n    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n      attribution: '© OpenStreetMap contributors'\n    }).addTo(map);\n\n    console.log('Tile layer added');\n\n    // Handle mouse move for coordinates\n    map.on('mousemove', (e: any) => {\n      setMouseCoords({ lat: e.latlng.lat, lng: e.latlng.lng });\n    });\n\n    // Handle zoom changes\n    map.on('zoomend', () => {\n      setZoom(map.getZoom());\n    });\n\n    mapInstanceRef.current = map;\n\n    // Force map to resize after a short delay\n    setTimeout(() => {\n      if (map) {\n        map.invalidateSize();\n      }\n    }, 100);\n\n    return () => {\n      map.remove();\n      mapInstanceRef.current = null;\n    };\n  }, []); // Empty dependency array - only run once\n\n  // Handle map click for point creation (separate effect)\n  useEffect(() => {\n    if (!mapInstanceRef.current) return;\n\n    const map = mapInstanceRef.current;\n\n    const handleMapClick = (e: any) => {\n      console.log('Map clicked, isSelectingPoint:', isSelectingPoint);\n      if (isSelectingPoint) {\n        const pointLabel = `Point ${String.fromCharCode(65 + analysisPoints.length)}`;\n        console.log('Creating point:', pointLabel, e.latlng);\n        onCreatePoint({\n          label: pointLabel,\n          latitude: e.latlng.lat,\n          longitude: e.latlng.lng,\n        });\n      }\n    };\n    \n    map.on('click', handleMapClick);\n\n    return () => {\n      map.off('click', handleMapClick);\n    };\n  }, [isSelectingPoint, analysisPoints.length, onCreatePoint]);\n\n  // Update resource markers only when resources actually change\n  useEffect(() => {\n    if (!mapInstanceRef.current) return;\n\n    const map = mapInstanceRef.current;\n\n    // Get current resource IDs on the map\n    const currentResourceIds = new Set<number>();\n    markersRef.current.forEach((marker, key) => {\n      if (key.startsWith('resource-') && !key.includes('label')) {\n        const id = parseInt(key.replace('resource-', ''), 10);\n        if (!isNaN(id)) {\n          currentResourceIds.add(id);\n        }\n      }\n    });\n\n    // Get new resource IDs from props\n    const newResourceIds = new Set(resources.map(r => r.id));\n\n    // Remove markers for resources that no longer exist\n    currentResourceIds.forEach(id => {\n      if (!newResourceIds.has(id)) {\n        const markerKey = `resource-${id}`;\n        const labelKey = `resource-label-${id}`;\n        \n        // Clean up all related markers\n        [markerKey, labelKey].forEach(key => {\n          const marker = markersRef.current.get(key);\n          if (marker) {\n            try {\n              if (map.hasLayer(marker)) {\n                map.removeLayer(marker);\n              }\n            } catch (e) {\n              // Marker might already be removed, ignore error\n            }\n            markersRef.current.delete(key);\n          }\n        });\n      }\n    });\n\n    // Add markers for new resources\n    resources.forEach((resource) => {\n      const markerKey = `resource-${resource.id}`;\n      \n      // Skip if marker already exists\n      if (markersRef.current.has(markerKey)) return;\n\n      const color = getResourceColor(resource.type);\n      \n      // Create main resource marker - clean consistent style for all markers\n      const marker = L.circleMarker([resource.latitude, resource.longitude], {\n        radius: 8,\n        fillColor: color,\n        color: '#ffffff',\n        weight: 2,\n        opacity: 1,\n        fillOpacity: 0.8,\n        pane: 'markerPane'\n      });\n\n      // Create label with better styling\n      const labelHtml = `\n        <div style=\"\n          font-size: 10px; \n          color: #1f2937; \n          font-weight: 600; \n          text-shadow: 1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white;\n          white-space: nowrap;\n          pointer-events: none;\n          background: rgba(255,255,255,0.8);\n          padding: 1px 3px;\n          border-radius: 3px;\n          border: 1px solid rgba(0,0,0,0.1);\n        \">${resource.name}</div>\n      `;\n      \n      const labelIcon = L.divIcon({\n        className: 'resource-label-custom',\n        html: labelHtml,\n        iconSize: [0, 0],\n        iconAnchor: [0, -12]\n      });\n\n      const labelMarker = L.marker([resource.latitude, resource.longitude], { \n        icon: labelIcon,\n        interactive: false,\n        pane: 'overlayPane'\n      });\n\n      // Add popup to main marker\n      marker.bindPopup(`\n        <div style=\"padding: 12px; min-width: 200px;\">\n          <div style=\"font-weight: 600; font-size: 16px; margin-bottom: 4px; color: #1f2937;\">${resource.name}</div>\n          <div style=\"color: #6b7280; font-size: 14px; margin-bottom: 8px;\">${resource.type}</div>\n          <div style=\"color: #9ca3af; font-size: 12px; margin-bottom: 4px;\">\n            ${resource.latitude.toFixed(6)}, ${resource.longitude.toFixed(6)}\n          </div>\n          ${resource.description ? `<div style=\"color: #4b5563; font-size: 13px; margin-top: 8px; border-top: 1px solid #e5e7eb; padding-top: 8px;\">${resource.description}</div>` : ''}\n        </div>\n      `, {\n        maxWidth: 300,\n        className: 'custom-popup'\n      });\n\n      // Add to map\n      marker.addTo(map);\n      labelMarker.addTo(map);\n\n      // Store references\n      markersRef.current.set(markerKey, marker);\n      markersRef.current.set(`resource-label-${resource.id}`, labelMarker);\n    });\n\n    console.log(`Updated resource markers: ${resources.length} resources`);\n  }, [resources]);\n\n  // Update departure location markers (storage yards) - render as regular resources\n  useEffect(() => {\n    if (!mapInstanceRef.current) return;\n\n    const map = mapInstanceRef.current;\n\n    // Clear existing departure location markers\n    markersRef.current.forEach((marker, key) => {\n      if (key.startsWith('departure-')) {\n        map.removeLayer(marker);\n        markersRef.current.delete(key);\n      }\n    });\n\n    // Add departure location markers from all contractors as regular resource markers\n    let markerCount = 0;\n    contractors.forEach((contractor) => {\n      if (contractor.departureLocations && Array.isArray(contractor.departureLocations)) {\n        contractor.departureLocations.forEach((location: any, idx: number) => {\n          if (location.latitude && location.longitude) {\n            const markerKey = `departure-${contractor.id}-${idx}`;\n            \n            // Skip if marker already exists\n            if (markersRef.current.has(markerKey)) return;\n\n            // Use the contractor's category color for storage yard markers\n            const color = getResourceColor(contractor.category || 'Unknown');\n            \n            // Create main resource marker (same style as regular resources)\n            const marker = L.circleMarker([location.latitude, location.longitude], {\n              radius: 8,\n              fillColor: color,\n              color: '#ffffff',\n              weight: 2,\n              opacity: 1,\n              fillOpacity: 0.8,\n              pane: 'markerPane'\n            });\n\n            // Create label with company name\n            const labelHtml = `\n              <div style=\"\n                font-size: 10px; \n                color: #1f2937; \n                font-weight: 600; \n                text-shadow: 1px 1px 2px white, -1px -1px 2px white, 1px -1px 2px white, -1px 1px 2px white;\n                white-space: nowrap;\n                pointer-events: none;\n                background: rgba(255,255,255,0.8);\n                padding: 1px 3px;\n                border-radius: 3px;\n                border: 1px solid rgba(0,0,0,0.1);\n              \">${contractor.company}</div>\n            `;\n            \n            const labelIcon = L.divIcon({\n              className: 'resource-label-custom',\n              html: labelHtml,\n              iconSize: [0, 0],\n              iconAnchor: [0, -12]\n            });\n\n            const labelMarker = L.marker([location.latitude, location.longitude], { \n              icon: labelIcon,\n              interactive: false,\n              pane: 'overlayPane'\n            });\n\n            // Add popup with full contractor and storage yard info\n            marker.bindPopup(`\n              <div style=\"padding: 12px; min-width: 200px;\">\n                <div style=\"font-weight: 600; font-size: 16px; margin-bottom: 4px; color: #1f2937;\">${contractor.company}</div>\n                <div style=\"color: #6b7280; font-size: 14px; margin-bottom: 8px;\">Storage Yard - ${contractor.category || 'Unknown'}</div>\n                <div style=\"color: #9ca3af; font-size: 12px; margin-bottom: 4px;\">\n                  ${location.latitude.toFixed(6)}, ${location.longitude.toFixed(6)}\n                </div>\n                <div style=\"color: #4b5563; font-size: 13px; margin-top: 8px; border-top: 1px solid #e5e7eb; padding-top: 8px;\">\n                  📍 ${location.location}\n                </div>\n                ${contractor.name ? `<div style=\"color: #6b7280; font-size: 12px; margin-top: 4px;\">Contact: ${contractor.name}</div>` : ''}\n                ${contractor.phone ? `<div style=\"color: #6b7280; font-size: 12px; margin-top: 2px;\">📞 ${contractor.phone}</div>` : ''}\n                ${contractor.email ? `<div style=\"color: #6b7280; font-size: 12px; margin-top: 2px;\">✉️ ${contractor.email}</div>` : ''}\n                ${contractor.birdRep ? `<div style=\"color: #6b7280; font-size: 12px; margin-top: 4px;\">Bird Rep: ${contractor.birdRep}</div>` : ''}\n              </div>\n            `, {\n              maxWidth: 300,\n              className: 'custom-popup'\n            });\n\n            // Add to map\n            marker.addTo(map);\n            labelMarker.addTo(map);\n\n            // Store references\n            markersRef.current.set(markerKey, marker);\n            markersRef.current.set(`${markerKey}-label`, labelMarker);\n            markerCount++;\n          }\n        });\n      }\n    });\n\n    console.log(`Updated departure location markers: ${markerCount} locations`);\n  }, [contractors]);\n\n  // Update analysis point markers\n  useEffect(() => {\n    if (!mapInstanceRef.current) return;\n\n    const map = mapInstanceRef.current;\n\n    // Clear existing point markers\n    markersRef.current.forEach((marker, key) => {\n      if (key.startsWith('point-')) {\n        map.removeLayer(marker);\n        markersRef.current.delete(key);\n      }\n    });\n\n    // Add analysis point markers\n    analysisPoints.forEach((point) => {\n      const isSelected = point.id === selectedPointId;\n      \n      // Create a custom hatched pattern icon\n      const size = isSelected ? 30 : 24;\n      const hatchedIcon = L.divIcon({\n        className: 'custom-hatched-marker',\n        html: `\n          <div style=\"\n            width: ${size}px;\n            height: ${size}px;\n            position: relative;\n            border-radius: 50%;\n            border: ${isSelected ? '4px' : '3px'} solid #ffffff;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.3);\n            background: conic-gradient(\n              from 0deg,\n              #DC2626 0deg 45deg,\n              #2563EB 45deg 90deg,\n              #DC2626 90deg 135deg,\n              #2563EB 135deg 180deg,\n              #DC2626 180deg 225deg,\n              #2563EB 225deg 270deg,\n              #DC2626 270deg 315deg,\n              #2563EB 315deg 360deg\n            );\n            display: flex;\n            align-items: center;\n            justify-content: center;\n          \">\n            <div style=\"\n              width: ${size - 8}px;\n              height: ${size - 8}px;\n              border-radius: 50%;\n              background: linear-gradient(\n                45deg,\n                #DC2626 25%,\n                #2563EB 25%,\n                #2563EB 50%,\n                #DC2626 50%,\n                #DC2626 75%,\n                #2563EB 75%\n              );\n              background-size: 8px 8px;\n              border: 2px solid #ffffff;\n            \"></div>\n          </div>\n        `,\n        iconSize: [size, size],\n        iconAnchor: [size / 2, size / 2]\n      });\n\n      const marker = L.marker([point.latitude, point.longitude], {\n        icon: hatchedIcon\n      }).addTo(map);\n\n      marker.bindPopup(`\n        <div class=\"p-2\">\n          <div class=\"font-medium\">${point.label}</div>\n          <div class=\"text-sm text-gray-600\">Analysis Point</div>\n          <div class=\"text-sm text-gray-500\">${point.latitude.toFixed(4)}, ${point.longitude.toFixed(4)}</div>\n        </div>\n      `);\n\n      markersRef.current.set(`point-${point.id}`, marker);\n    });\n  }, [analysisPoints, selectedPointId]);\n\n  // Update isSelectingPoint effect\n  useEffect(() => {\n    if (mapInstanceRef.current) {\n      const map = mapInstanceRef.current;\n      \n      if (isSelectingPoint) {\n        map.getContainer().style.cursor = 'crosshair';\n      } else {\n        map.getContainer().style.cursor = '';\n      }\n    }\n  }, [isSelectingPoint]);\n\n  // Update distance circle\n  useEffect(() => {\n    if (!mapInstanceRef.current) return;\n\n    const map = mapInstanceRef.current;\n    \n    // Remove existing circle\n    if (distanceCircleRef.current) {\n      map.removeLayer(distanceCircleRef.current);\n      distanceCircleRef.current = null;\n    }\n\n    // Add new circle if we have a selected point and max distance filter\n    if (selectedPointId && maxDistance) {\n      const selectedPoint = analysisPoints.find(p => p.id === selectedPointId);\n      if (selectedPoint) {\n        console.log('Creating circle with maxDistance:', maxDistance, 'miles');\n        // Convert miles to meters for Leaflet circle\n        const radiusInMeters = maxDistance * 1609.34;\n        \n        distanceCircleRef.current = L.circle([selectedPoint.latitude, selectedPoint.longitude], {\n          radius: radiusInMeters,\n          color: '#3B82F6',\n          fillColor: '#3B82F6',\n          fillOpacity: 0.1,\n          weight: 2,\n          dashArray: '5, 5'\n        }).addTo(map);\n      }\n    }\n  }, [selectedPointId, maxDistance, analysisPoints]);\n\n\n\n\n\n  const formatCoordinates = (lat: number, lng: number) => {\n    const latDir = lat >= 0 ? 'N' : 'S';\n    const lngDir = lng >= 0 ? 'E' : 'W';\n    return `${Math.abs(lat).toFixed(4)}°${latDir}, ${Math.abs(lng).toFixed(4)}°${lngDir}`;\n  };\n\n\n\n  return (\n    <div className=\"w-full h-full relative\">\n      {/* Map Container */}\n      <div \n        ref={mapRef} \n        className=\"w-full h-full\" \n        style={{ \n          height: '100%',\n          width: '100%'\n        }}\n      ></div>\n      \n\n\n      {/* Map Status Bar */}\n      <Card className=\"absolute bottom-4 left-4 z-[500] px-3 py-2 bg-white shadow-lg\">\n        <div className=\"flex items-center space-x-4 text-xs text-gray-600\">\n          <span>{formatCoordinates(mouseCoords.lat, mouseCoords.lng)}</span>\n          <span className=\"text-gray-400\">|</span>\n          <span>Zoom: {zoom}</span>\n          <span className=\"text-gray-400\">|</span>\n          <span>{resources.length} resources visible</span>\n        </div>\n      </Card>\n\n      {/* Map Legend */}\n      {resources.length > 0 && (\n        <Card className=\"absolute bottom-4 right-4 z-[500] bg-white/95 backdrop-blur-sm shadow-lg border max-w-52\">\n          <div className=\"flex items-center justify-between p-3 pb-2\">\n            <div className=\"text-sm font-semibold text-gray-900\">Map Legend</div>\n            <Button\n              variant=\"ghost\"\n              size=\"sm\"\n              onClick={() => setIsLegendCollapsed(!isLegendCollapsed)}\n              className=\"h-6 w-6 p-0 hover:bg-gray-100\"\n            >\n              {isLegendCollapsed ? (\n                <ChevronUp size={14} />\n              ) : (\n                <ChevronDown size={14} />\n              )}\n            </Button>\n          </div>\n          \n          {!isLegendCollapsed && (\n            <div className=\"px-3 pb-3\">\n              <div className=\"space-y-2\">\n                <div className=\"text-xs font-medium text-gray-700 mb-1\">Resource Types</div>\n                <div className=\"grid grid-cols-1 gap-1 text-xs\">\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"w-3 h-3 bg-blue-500 rounded-full border border-white shadow-sm\"></div>\n                    <span className=\"text-gray-700\">Union</span>\n                  </div>\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"w-3 h-3 bg-red-500 rounded-full border border-white shadow-sm\"></div>\n                    <span className=\"text-gray-700\">Non-union</span>\n                  </div>\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"w-3 h-3 bg-emerald-500 rounded-full border border-white shadow-sm\"></div>\n                    <span className=\"text-gray-700\">Veg</span>\n                  </div>\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"w-3 h-3 bg-amber-500 rounded-full border border-white shadow-sm\"></div>\n                    <span className=\"text-gray-700\">HVAC</span>\n                  </div>\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"w-3 h-3 bg-violet-500 rounded-full border border-white shadow-sm\"></div>\n                    <span className=\"text-gray-700\">DAT</span>\n                  </div>\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"w-3 h-3 bg-pink-500 rounded-full border border-white shadow-sm\"></div>\n                    <span className=\"text-gray-700\">Consulting</span>\n                  </div>\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"w-3 h-3 bg-cyan-500 rounded-full border border-white shadow-sm\"></div>\n                    <span className=\"text-gray-700\">Logistics</span>\n                  </div>\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"w-3 h-3 bg-gray-500 rounded-full border border-white shadow-sm\"></div>\n                    <span className=\"text-gray-700\">Other</span>\n                  </div>\n                </div>\n              </div>\n              \n              {analysisPoints.length > 0 && (\n                <div className=\"border-t border-gray-200 mt-3 pt-2\">\n                  <div className=\"text-xs font-medium text-gray-700 mb-1\">Analysis Points</div>\n                  <div className=\"flex items-center space-x-2\">\n                    <div className=\"w-3 h-3 rounded-full ring-2 ring-white shadow-sm\" style={{\n                      background: 'conic-gradient(from 0deg, #DC2626 0deg 90deg, #2563EB 90deg 180deg, #DC2626 180deg 270deg, #2563EB 270deg 360deg)'\n                    }}></div>\n                    <span className=\"text-gray-700 text-xs\">Analysis Point</span>\n                  </div>\n                </div>\n              )}\n              \n              <div className=\"border-t border-gray-200 mt-2 pt-2 text-xs text-gray-600\">\n                {resources.length} resources loaded\n              </div>\n            </div>\n          )}\n        </Card>\n      )}\n\n      {isSelectingPoint && (\n        <Card className=\"absolute top-4 left-1/2 transform -translate-x-1/2 z-[1001] p-3 bg-primary text-primary-foreground\">\n          <p className=\"text-sm font-medium\">Click on the map to place an analysis point</p>\n        </Card>\n      )}\n\n      {/* Weather Map Layers */}\n      <WeatherMapLayers\n        map={mapInstanceRef.current}\n        outlookData={outlookData}\n        utilitiesData={utilitiesData}\n        showOutlookLayer={isOutlookLayerVisible}\n        showUtilitiesLayer={isUtilitiesLayerVisible}\n        visibleDays={visibleDays}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":22402,"size_tokens":null},"client/src/components/ContractorReviewForm.tsx":{"content":"import { useState, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Form, FormControl, FormField, FormItem, FormLabel, FormMessage } from \"@/components/ui/form\";\nimport { Input } from \"@/components/ui/input\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { RadioGroup, RadioGroupItem } from \"@/components/ui/radio-group\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { useForm } from \"react-hook-form\";\nimport { zodResolver } from \"@hookform/resolvers/zod\";\nimport { useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { insertContractorReviewSchema, type InsertContractorReview, type Contractor } from \"@shared/schema\";\nimport { Star, CheckCircle } from \"lucide-react\";\nimport { z } from \"zod\";\n\n// Extend the schema to add submitter name\nconst reviewFormSchema = insertContractorReviewSchema.extend({\n  submitterName: z.string().min(1, \"Submitter name is required\"),\n});\n\ntype ReviewFormData = z.infer<typeof reviewFormSchema>;\n\ninterface ContractorReviewFormProps {\n  contractor: Contractor;\n  onSubmit: () => void;\n  onSkip: () => void;\n  currentIndex: number;\n  totalCount: number;\n  isTargetedReview?: boolean;\n}\n\nconst StarRating = ({ value, onChange }: { value: number; onChange: (value: number) => void }) => {\n  return (\n    <div className=\"flex gap-1\">\n      {[1, 2, 3, 4, 5].map((star) => (\n        <button\n          key={star}\n          type=\"button\"\n          onClick={() => onChange(star)}\n          className=\"focus:outline-none hover:scale-110 transition-transform\"\n        >\n          <Star\n            className={`w-6 h-6 ${\n              star <= value\n                ? \"fill-yellow-400 text-yellow-400\"\n                : \"text-gray-300 hover:text-yellow-300\"\n            }`}\n          />\n        </button>\n      ))}\n    </div>\n  );\n};\n\nexport default function ContractorReviewForm({\n  contractor,\n  onSubmit,\n  onSkip,\n  currentIndex,\n  totalCount,\n  isTargetedReview = false,\n}: ContractorReviewFormProps) {\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const form = useForm<ReviewFormData>({\n    resolver: zodResolver(reviewFormSchema),\n    key: contractor.id, // This ensures form resets when contractor changes\n    defaultValues: {\n      contractorId: contractor.id,\n      submitterName: \"\",\n      communicationRating: 0,\n      workQualityRating: 0,\n      collaborationRating: 0,\n      documentationRating: 0,\n      hadConflicts: false,\n      conflictDetails: \"\",\n      strengths: \"\",\n      improvementAreas: \"\",\n      metSafetyStandards: true,\n      safetyIssues: \"\",\n      adheredToSchedule: true,\n      scheduleIssues: \"\",\n      wouldRecommend: true,\n      additionalComments: \"\",\n    },\n  });\n\n  // Reset form when contractor changes\n  useEffect(() => {\n    form.reset({\n      contractorId: contractor.id,\n      submitterName: \"\",\n      communicationRating: 0,\n      workQualityRating: 0,\n      collaborationRating: 0,\n      documentationRating: 0,\n      hadConflicts: false,\n      conflictDetails: \"\",\n      strengths: \"\",\n      improvementAreas: \"\",\n      metSafetyStandards: true,\n      safetyIssues: \"\",\n      adheredToSchedule: true,\n      scheduleIssues: \"\",\n      wouldRecommend: true,\n      additionalComments: \"\",\n    });\n  }, [contractor.id, form]);\n\n  const reviewMutation = useMutation({\n    mutationFn: (data: InsertContractorReview) =>\n      apiRequest(\"POST\", \"/api/contractor-reviews\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/contractors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/contractor-reviews\"] });\n      toast({\n        description: \"Review submitted successfully\",\n        className: \"bg-green-50 border-green-200\",\n      });\n      onSubmit();\n    },\n    onError: (error: any) => {\n      toast({\n        description: `Failed to submit review: ${error?.message || \"Unknown error\"}`,\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleSubmit = (data: ReviewFormData) => {\n    reviewMutation.mutate(data);\n  };\n\n  return (\n    <div className=\"max-w-4xl mx-auto p-6\">\n      <div className=\"mb-6\">\n        <div className=\"flex items-center justify-between mb-4\">\n          <div>\n            <h1 className=\"text-2xl font-bold text-gray-900 dark:text-white\">\n              Contractor Storm Response Review Form\n            </h1>\n            <p className=\"text-gray-600 dark:text-gray-300 mt-1\">\n              Review contractor performance after storm response participation\n            </p>\n          </div>\n          <div className=\"text-sm text-gray-500 dark:text-gray-400\">\n            {currentIndex + 1} of {totalCount}\n          </div>\n        </div>\n        \n        <Card className=\"mb-6 border-blue-200 bg-blue-50 dark:bg-blue-950 dark:border-blue-800\">\n          <CardHeader>\n            <CardTitle className=\"text-lg text-blue-800 dark:text-blue-200\">\n              Reviewing: {contractor.name}\n            </CardTitle>\n            <CardDescription className=\"text-blue-600 dark:text-blue-300\">\n              {contractor.company} • {contractor.category}\n              {contractor.city && contractor.state && ` • ${contractor.city}, ${contractor.state}`}\n            </CardDescription>\n          </CardHeader>\n        </Card>\n      </div>\n\n      <Form {...form}>\n        <form onSubmit={form.handleSubmit(handleSubmit)} className=\"space-y-8\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Reviewer Information</CardTitle>\n            </CardHeader>\n            <CardContent>\n              <FormField\n                control={form.control}\n                name=\"submitterName\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel>Your Name *</FormLabel>\n                    <FormControl>\n                      <Input placeholder=\"Enter your full name\" {...field} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Performance Ratings</CardTitle>\n              <CardDescription>Rate each area on a scale of 1-5 stars</CardDescription>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <FormField\n                control={form.control}\n                name=\"communicationRating\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">\n                      How effectively did the contractor communicate with our team during the storm response? *\n                    </FormLabel>\n                    <FormControl>\n                      <StarRating value={field.value} onChange={field.onChange} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"workQualityRating\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">\n                      How would you rate the quality of the contractor's work? *\n                    </FormLabel>\n                    <FormControl>\n                      <StarRating value={field.value} onChange={field.onChange} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"collaborationRating\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">\n                      How effectively did the contractor collaborate with our team and other stakeholders? *\n                    </FormLabel>\n                    <FormControl>\n                      <StarRating value={field.value} onChange={field.onChange} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"documentationRating\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">\n                      How accurate and timely was the contractor's documentation and reporting? *\n                    </FormLabel>\n                    <FormControl>\n                      <StarRating value={field.value} onChange={field.onChange} />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Issues and Conflicts</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <FormField\n                control={form.control}\n                name=\"hadConflicts\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">\n                      Were there any conflicts or issues that arose? *\n                    </FormLabel>\n                    <FormControl>\n                      <RadioGroup\n                        value={field.value.toString()}\n                        onValueChange={(value) => field.onChange(value === \"true\")}\n                        className=\"flex gap-6\"\n                      >\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"true\" id=\"conflicts-yes\" />\n                          <label htmlFor=\"conflicts-yes\">Yes</label>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"false\" id=\"conflicts-no\" />\n                          <label htmlFor=\"conflicts-no\">No</label>\n                        </div>\n                      </RadioGroup>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              {form.watch(\"hadConflicts\") && (\n                <FormField\n                  control={form.control}\n                  name=\"conflictDetails\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>What conflicts or issues arose, and how were they resolved?</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          placeholder=\"Describe the conflicts/issues and their resolution...\"\n                          {...field}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Performance Feedback</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <FormField\n                control={form.control}\n                name=\"strengths\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">\n                      What were the strengths of the contractor's performance?\n                    </FormLabel>\n                    <FormControl>\n                      <Textarea\n                        placeholder=\"Describe the contractor's key strengths...\"\n                        {...field}\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"improvementAreas\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">\n                      What areas could the contractor improve upon for future projects?\n                    </FormLabel>\n                    <FormControl>\n                      <Textarea\n                        placeholder=\"Describe areas for improvement...\"\n                        {...field}\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Safety and Compliance</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <FormField\n                control={form.control}\n                name=\"metSafetyStandards\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">\n                      Did the contractor meet all safety and regulatory standards? *\n                    </FormLabel>\n                    <FormControl>\n                      <RadioGroup\n                        value={field.value.toString()}\n                        onValueChange={(value) => field.onChange(value === \"true\")}\n                        className=\"flex gap-6\"\n                      >\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"true\" id=\"safety-yes\" />\n                          <label htmlFor=\"safety-yes\">Yes</label>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"false\" id=\"safety-no\" />\n                          <label htmlFor=\"safety-no\">No</label>\n                        </div>\n                      </RadioGroup>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              {!form.watch(\"metSafetyStandards\") && (\n                <FormField\n                  control={form.control}\n                  name=\"safetyIssues\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>What safety or regulatory issues were present?</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          placeholder=\"Describe the safety or regulatory issues...\"\n                          {...field}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Schedule and Timeline</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <FormField\n                control={form.control}\n                name=\"adheredToSchedule\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">\n                      Did the contractor adhere to the agreed-upon timelines and schedules? *\n                    </FormLabel>\n                    <FormControl>\n                      <RadioGroup\n                        value={field.value.toString()}\n                        onValueChange={(value) => field.onChange(value === \"true\")}\n                        className=\"flex gap-6\"\n                      >\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"true\" id=\"schedule-yes\" />\n                          <label htmlFor=\"schedule-yes\">Yes</label>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"false\" id=\"schedule-no\" />\n                          <label htmlFor=\"schedule-no\">No</label>\n                        </div>\n                      </RadioGroup>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              {!form.watch(\"adheredToSchedule\") && (\n                <FormField\n                  control={form.control}\n                  name=\"scheduleIssues\"\n                  render={({ field }) => (\n                    <FormItem>\n                      <FormLabel>What issues arose regarding time and schedule?</FormLabel>\n                      <FormControl>\n                        <Textarea\n                          placeholder=\"Describe the timing and schedule issues...\"\n                          {...field}\n                        />\n                      </FormControl>\n                      <FormMessage />\n                    </FormItem>\n                  )}\n                />\n              )}\n            </CardContent>\n          </Card>\n\n          <Card>\n            <CardHeader>\n              <CardTitle>Recommendation and Additional Comments</CardTitle>\n            </CardHeader>\n            <CardContent className=\"space-y-6\">\n              <FormField\n                control={form.control}\n                name=\"wouldRecommend\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">\n                      Would you recommend this contractor for future storm response work? *\n                    </FormLabel>\n                    <FormControl>\n                      <RadioGroup\n                        value={field.value.toString()}\n                        onValueChange={(value) => field.onChange(value === \"true\")}\n                        className=\"flex gap-6\"\n                      >\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"true\" id=\"recommend-yes\" />\n                          <label htmlFor=\"recommend-yes\">Yes</label>\n                        </div>\n                        <div className=\"flex items-center space-x-2\">\n                          <RadioGroupItem value=\"false\" id=\"recommend-no\" />\n                          <label htmlFor=\"recommend-no\">No</label>\n                        </div>\n                      </RadioGroup>\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n\n              <FormField\n                control={form.control}\n                name=\"additionalComments\"\n                render={({ field }) => (\n                  <FormItem>\n                    <FormLabel className=\"text-base font-medium\">\n                      Do you have any additional comments or suggestions regarding the contractor's performance?\n                    </FormLabel>\n                    <FormControl>\n                      <Textarea\n                        placeholder=\"Any additional comments or suggestions...\"\n                        {...field}\n                        rows={4}\n                      />\n                    </FormControl>\n                    <FormMessage />\n                  </FormItem>\n                )}\n              />\n            </CardContent>\n          </Card>\n\n          <div className={`flex ${isTargetedReview ? 'justify-end' : 'justify-between'} items-center pt-6 border-t`}>\n            {!isTargetedReview && (\n              <Button\n                type=\"button\"\n                variant=\"outline\"\n                onClick={onSkip}\n                disabled={reviewMutation.isPending}\n              >\n                Skip This Contractor\n              </Button>\n            )}\n            \n            <div className=\"flex gap-3\">\n              <Button\n                type=\"submit\"\n                disabled={reviewMutation.isPending}\n                className=\"min-w-[120px]\"\n              >\n                {reviewMutation.isPending ? (\n                  <div className=\"flex items-center gap-2\">\n                    <div className=\"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin\" />\n                    Submitting...\n                  </div>\n                ) : (\n                  <div className=\"flex items-center gap-2\">\n                    <CheckCircle className=\"w-4 h-4\" />\n                    Submit Review\n                  </div>\n                )}\n              </Button>\n            </div>\n          </div>\n        </form>\n      </Form>\n    </div>\n  );\n}","path":null,"size_bytes":20979,"size_tokens":null},"client/src/main.tsx":{"content":"import { createRoot } from \"react-dom/client\";\nimport App from \"./App\";\nimport \"./index.css\";\n\ncreateRoot(document.getElementById(\"root\")!).render(<App />);\n","path":null,"size_bytes":157,"size_tokens":null},"client/src/pages/not-found.tsx":{"content":"import { Card, CardContent } from \"@/components/ui/card\";\nimport { AlertCircle } from \"lucide-react\";\n\nexport default function NotFound() {\n  return (\n    <div className=\"min-h-screen w-full flex items-center justify-center bg-gray-50\">\n      <Card className=\"w-full max-w-md mx-4\">\n        <CardContent className=\"pt-6\">\n          <div className=\"flex mb-4 gap-2\">\n            <AlertCircle className=\"h-8 w-8 text-red-500\" />\n            <h1 className=\"text-2xl font-bold text-gray-900\">404 Page Not Found</h1>\n          </div>\n\n          <p className=\"mt-4 text-sm text-gray-600\">\n            Did you forget to add the page to the router?\n          </p>\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n","path":null,"size_bytes":711,"size_tokens":null},"client/src/components/ui/pagination.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { ButtonProps, buttonVariants } from \"@/components/ui/button\"\n\nconst Pagination = ({ className, ...props }: React.ComponentProps<\"nav\">) => (\n  <nav\n    role=\"navigation\"\n    aria-label=\"pagination\"\n    className={cn(\"mx-auto flex w-full justify-center\", className)}\n    {...props}\n  />\n)\nPagination.displayName = \"Pagination\"\n\nconst PaginationContent = React.forwardRef<\n  HTMLUListElement,\n  React.ComponentProps<\"ul\">\n>(({ className, ...props }, ref) => (\n  <ul\n    ref={ref}\n    className={cn(\"flex flex-row items-center gap-1\", className)}\n    {...props}\n  />\n))\nPaginationContent.displayName = \"PaginationContent\"\n\nconst PaginationItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentProps<\"li\">\n>(({ className, ...props }, ref) => (\n  <li ref={ref} className={cn(\"\", className)} {...props} />\n))\nPaginationItem.displayName = \"PaginationItem\"\n\ntype PaginationLinkProps = {\n  isActive?: boolean\n} & Pick<ButtonProps, \"size\"> &\n  React.ComponentProps<\"a\">\n\nconst PaginationLink = ({\n  className,\n  isActive,\n  size = \"icon\",\n  ...props\n}: PaginationLinkProps) => (\n  <a\n    aria-current={isActive ? \"page\" : undefined}\n    className={cn(\n      buttonVariants({\n        variant: isActive ? \"outline\" : \"ghost\",\n        size,\n      }),\n      className\n    )}\n    {...props}\n  />\n)\nPaginationLink.displayName = \"PaginationLink\"\n\nconst PaginationPrevious = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to previous page\"\n    size=\"default\"\n    className={cn(\"gap-1 pl-2.5\", className)}\n    {...props}\n  >\n    <ChevronLeft className=\"h-4 w-4\" />\n    <span>Previous</span>\n  </PaginationLink>\n)\nPaginationPrevious.displayName = \"PaginationPrevious\"\n\nconst PaginationNext = ({\n  className,\n  ...props\n}: React.ComponentProps<typeof PaginationLink>) => (\n  <PaginationLink\n    aria-label=\"Go to next page\"\n    size=\"default\"\n    className={cn(\"gap-1 pr-2.5\", className)}\n    {...props}\n  >\n    <span>Next</span>\n    <ChevronRight className=\"h-4 w-4\" />\n  </PaginationLink>\n)\nPaginationNext.displayName = \"PaginationNext\"\n\nconst PaginationEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    aria-hidden\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More pages</span>\n  </span>\n)\nPaginationEllipsis.displayName = \"PaginationEllipsis\"\n\nexport {\n  Pagination,\n  PaginationContent,\n  PaginationEllipsis,\n  PaginationItem,\n  PaginationLink,\n  PaginationNext,\n  PaginationPrevious,\n}\n","path":null,"size_bytes":2751,"size_tokens":null},"client/src/hooks/use-toast.ts":{"content":"import * as React from \"react\"\n\nimport type {\n  ToastActionElement,\n  ToastProps,\n} from \"@/components/ui/toast\"\n\nconst TOAST_LIMIT = 1\nconst TOAST_REMOVE_DELAY = 1000000\n\ntype ToasterToast = ToastProps & {\n  id: string\n  title?: React.ReactNode\n  description?: React.ReactNode\n  action?: ToastActionElement\n}\n\nconst actionTypes = {\n  ADD_TOAST: \"ADD_TOAST\",\n  UPDATE_TOAST: \"UPDATE_TOAST\",\n  DISMISS_TOAST: \"DISMISS_TOAST\",\n  REMOVE_TOAST: \"REMOVE_TOAST\",\n} as const\n\nlet count = 0\n\nfunction genId() {\n  count = (count + 1) % Number.MAX_SAFE_INTEGER\n  return count.toString()\n}\n\ntype ActionType = typeof actionTypes\n\ntype Action =\n  | {\n      type: ActionType[\"ADD_TOAST\"]\n      toast: ToasterToast\n    }\n  | {\n      type: ActionType[\"UPDATE_TOAST\"]\n      toast: Partial<ToasterToast>\n    }\n  | {\n      type: ActionType[\"DISMISS_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n  | {\n      type: ActionType[\"REMOVE_TOAST\"]\n      toastId?: ToasterToast[\"id\"]\n    }\n\ninterface State {\n  toasts: ToasterToast[]\n}\n\nconst toastTimeouts = new Map<string, ReturnType<typeof setTimeout>>()\n\nconst addToRemoveQueue = (toastId: string) => {\n  if (toastTimeouts.has(toastId)) {\n    return\n  }\n\n  const timeout = setTimeout(() => {\n    toastTimeouts.delete(toastId)\n    dispatch({\n      type: \"REMOVE_TOAST\",\n      toastId: toastId,\n    })\n  }, TOAST_REMOVE_DELAY)\n\n  toastTimeouts.set(toastId, timeout)\n}\n\nexport const reducer = (state: State, action: Action): State => {\n  switch (action.type) {\n    case \"ADD_TOAST\":\n      return {\n        ...state,\n        toasts: [action.toast, ...state.toasts].slice(0, TOAST_LIMIT),\n      }\n\n    case \"UPDATE_TOAST\":\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === action.toast.id ? { ...t, ...action.toast } : t\n        ),\n      }\n\n    case \"DISMISS_TOAST\": {\n      const { toastId } = action\n\n      // ! Side effects ! - This could be extracted into a dismissToast() action,\n      // but I'll keep it here for simplicity\n      if (toastId) {\n        addToRemoveQueue(toastId)\n      } else {\n        state.toasts.forEach((toast) => {\n          addToRemoveQueue(toast.id)\n        })\n      }\n\n      return {\n        ...state,\n        toasts: state.toasts.map((t) =>\n          t.id === toastId || toastId === undefined\n            ? {\n                ...t,\n                open: false,\n              }\n            : t\n        ),\n      }\n    }\n    case \"REMOVE_TOAST\":\n      if (action.toastId === undefined) {\n        return {\n          ...state,\n          toasts: [],\n        }\n      }\n      return {\n        ...state,\n        toasts: state.toasts.filter((t) => t.id !== action.toastId),\n      }\n  }\n}\n\nconst listeners: Array<(state: State) => void> = []\n\nlet memoryState: State = { toasts: [] }\n\nfunction dispatch(action: Action) {\n  memoryState = reducer(memoryState, action)\n  listeners.forEach((listener) => {\n    listener(memoryState)\n  })\n}\n\ntype Toast = Omit<ToasterToast, \"id\">\n\nfunction toast({ ...props }: Toast) {\n  const id = genId()\n\n  const update = (props: ToasterToast) =>\n    dispatch({\n      type: \"UPDATE_TOAST\",\n      toast: { ...props, id },\n    })\n  const dismiss = () => dispatch({ type: \"DISMISS_TOAST\", toastId: id })\n\n  dispatch({\n    type: \"ADD_TOAST\",\n    toast: {\n      ...props,\n      id,\n      open: true,\n      onOpenChange: (open) => {\n        if (!open) dismiss()\n      },\n    },\n  })\n\n  return {\n    id: id,\n    dismiss,\n    update,\n  }\n}\n\nfunction useToast() {\n  const [state, setState] = React.useState<State>(memoryState)\n\n  React.useEffect(() => {\n    listeners.push(setState)\n    return () => {\n      const index = listeners.indexOf(setState)\n      if (index > -1) {\n        listeners.splice(index, 1)\n      }\n    }\n  }, [state])\n\n  return {\n    ...state,\n    toast,\n    dismiss: (toastId?: string) => dispatch({ type: \"DISMISS_TOAST\", toastId }),\n  }\n}\n\nexport { useToast, toast }\n","path":null,"size_bytes":3895,"size_tokens":null},"server/routes.ts":{"content":"import type { Express } from \"express\";\nimport { createServer, type Server } from \"http\";\nimport multer from \"multer\";\nimport { storage } from \"./storage\";\nimport { parseKMZFile, convertToResources } from \"./services/kmzParser\";\nimport { parseCSVFile, parseExcelFile, convertCSVToResources, exportToExcel, exportToExcelWithBirdRepSheets, exportToCSVWithBirdRepFiles } from \"./services/csvParser\";\nimport { routingService } from \"./services/routingService\";\nimport { fetchSPCOutlook, fetchElectricUtilities, calculateAffectedUtilities } from \"./services/weatherService\";\nimport { insertResourceSchema, insertAnalysisPointSchema, insertContractorSchema, insertContractorReviewSchema, insertUserSchema, insertUserCompanyAccessSchema, insertCompanySchema, insertStormSessionSchema, insertRosterSchema, insertCrewSchema, insertRosterPersonnelSchema, insertRosterEquipmentSchema, insertTimesheetSchema, insertTimesheetLineSchema, insertExpenseSchema, insertExpenseFileSchema, insertInvoiceSchema, insertInvoiceLineSchema, insertIssueTypeSchema, insertTicketSchema, insertTicketAssignmentSchema, ticketAssignments, distanceCalculations, analysisPoints, contractors, contractorFiles, users, rosterPersonnel, rosterEquipment, timesheetLines, expenseFiles, invoiceLines } from \"@shared/schema\";\nimport { db } from \"./db\";\nimport { eq } from \"drizzle-orm\";\nimport { promises as fs } from 'fs';\nimport path from 'path';\nimport { randomUUID } from 'crypto';\nimport archiver from 'archiver';\nimport OpenAI from \"openai\";\nimport { requireAuth, requireUtility, requireManager, requireManagerOrUtility, requireAdminRole, requireAdminOrManager, requireCompanyAccess } from \"./middleware/rbac\";\nimport { createAuditLog, getAuditContext } from \"./services/auditLog\";\nimport { objectStorageClient, ObjectStorageService, parseObjectPath } from \"./objectStorage\";\n\n// Session utility functions\nfunction getSessionId(req: any): string {\n  const sessionId = req.headers['x-session-id'] || req.query.sessionId;\n  return sessionId || 'global-session';\n}\n\nasync function getEffectiveSessionId(req: any, pointId?: number): Promise<string> {\n  const requestedSessionId = getSessionId(req);\n\n  // If it's the auto-detect session, try to find the actual session ID from existing data\n  if (requestedSessionId === 'auto-detect-session' && pointId) {\n    const analysisPoints = await storage.getAllAnalysisPoints();\n    const existingPoint = analysisPoints.find(p => p.id === pointId);\n    if (existingPoint && existingPoint.sessionId) {\n      return existingPoint.sessionId;\n    }\n  }\n\n  return requestedSessionId;\n}\n\nconst upload = multer({\n  dest: 'uploads/',\n  fileFilter: (req, file, cb) => {\n    // Allow common document and data types for contractor files\n    const allowedTypes = ['.kmz', '.kml', '.csv', '.xlsx', '.xls', '.pdf', '.doc', '.docx', '.txt', '.jpg', '.jpeg', '.png', '.gif'];\n    const ext = path.extname(file.originalname).toLowerCase();\n    cb(null, allowedTypes.includes(ext));\n  },\n  limits: {\n    fileSize: 10 * 1024 * 1024, // 10MB limit\n  },\n});\n\n// Configure multer for in-memory storage (for Object Storage uploads)\nconst receiptUpload = multer({\n  storage: multer.memoryStorage(),\n  fileFilter: (req, file, cb) => {\n    // Allow common image and document types for receipts\n    const allowedTypes = ['.jpg', '.jpeg', '.png', '.pdf', '.gif', '.webp'];\n    const ext = path.extname(file.originalname).toLowerCase();\n    cb(null, allowedTypes.includes(ext));\n  },\n  limits: {\n    fileSize: 10 * 1024 * 1024, // 10MB limit\n  },\n});\n\n// Initialize OpenAI client - the newest OpenAI model is \"gpt-5\" which was released August 7, 2025. do not change this unless explicitly requested by the user\nconst openai = process.env.OPENAI_API_KEY ? new OpenAI({ apiKey: process.env.OPENAI_API_KEY }) : null;\n\n// AI-powered contractor matching function\nasync function findBestContractorMatch(submissionCompanyName: string, allContractors: any[]): Promise<{contractor: any | null, confidence: number, reasoning: string}> {\n  try {\n    if (!submissionCompanyName || submissionCompanyName.trim() === '') {\n      return { contractor: null, confidence: 0, reasoning: 'No company name provided' };\n    }\n\n    // If OpenAI is not available, skip to fallback\n    if (!openai) {\n      throw new Error('OpenAI not configured');\n    }\n\n    // Create a list of contractor names for comparison\n    const contractorList = allContractors.map(c => ({\n      id: c.id,\n      company: c.company,\n      name: c.name\n    }));\n\n    const prompt = `I need to match a company name from a form submission to contractors in my database. The submission might have typos, abbreviations, or slight variations.\n\nSubmission company name: \"${submissionCompanyName}\"\n\nDatabase contractors:\n${contractorList.map(c => `ID: ${c.id}, Company: \"${c.company}\", Contact: \"${c.name}\"`).join('\\n')}\n\nPlease find the best match and respond with JSON in this exact format:\n{\n  \"matched_contractor_id\": number_or_null,\n  \"confidence\": number_between_0_and_1,\n  \"reasoning\": \"explanation of the match or why no match was found\"\n}\n\nConsider variations like:\n- Abbreviations (e.g., \"Inc\" vs \"Incorporated\", \"LLC\" vs \"Limited\")\n- Typos and misspellings\n- Word order differences\n- Missing or extra words\n- Different punctuation\n\nIf confidence is below 0.7, return null for matched_contractor_id.`;\n\n    const response = await openai.chat.completions.create({\n      model: \"gpt-5\",\n      messages: [\n        {\n          role: \"system\",\n          content: \"You are an expert at matching company names despite variations, typos, and abbreviations. Return only valid JSON.\"\n        },\n        {\n          role: \"user\",\n          content: prompt\n        }\n      ],\n      response_format: { type: \"json_object\" },\n    });\n\n    const result = JSON.parse(response.choices[0].message.content || '{}');\n    \n    const matchedContractor = result.matched_contractor_id \n      ? allContractors.find(c => c.id === result.matched_contractor_id)\n      : null;\n\n    return {\n      contractor: matchedContractor,\n      confidence: Math.max(0, Math.min(1, result.confidence || 0)),\n      reasoning: result.reasoning || 'No reasoning provided'\n    };\n\n  } catch (error) {\n    console.error('AI contractor matching error:', error);\n    // Fallback to exact string matching\n    const exactMatch = allContractors.find(c => \n      c.company.toLowerCase().trim() === submissionCompanyName.toLowerCase().trim()\n    );\n    \n    if (exactMatch) {\n      return {\n        contractor: exactMatch,\n        confidence: 1.0,\n        reasoning: 'Exact match found (AI fallback)'\n      };\n    }\n\n    return {\n      contractor: null,\n      confidence: 0,\n      reasoning: `AI matching failed: ${error.message}. No exact match found.`\n    };\n  }\n}\n\nexport async function registerRoutes(app: Express): Promise<Server> {\n  // Current user endpoint (Replit Auth)\n  app.get(\"/api/user\", async (req, res) => {\n    if (!req.isAuthenticated()) {\n      return res.status(401).json({ message: \"Not authenticated\" });\n    }\n    \n    const userClaims = (req.user as any)?.claims;\n    if (!userClaims?.sub) {\n      return res.status(401).json({ message: \"No user session\" });\n    }\n    \n    // Get user from database\n    const user = await storage.getUser(userClaims.sub);\n    if (!user) {\n      return res.status(404).json({ message: \"User not found\" });\n    }\n    \n    // Return user without sensitive data\n    res.json({\n      id: user.id,\n      email: user.email,\n      firstName: user.firstName,\n      lastName: user.lastName,\n      profileImageUrl: user.profileImageUrl,\n      role: user.role,\n      companyId: user.companyId,\n    });\n  });\n\n  // ============================================================================\n  // USER MANAGEMENT API (ADMIN only)\n  // ============================================================================\n\n  // List all users (ADMIN only)\n  app.get(\"/api/users\", requireAuth, async (req, res) => {\n    try {\n      // Allow ADMIN and MANAGER to list users\n      if (req.authenticatedUser?.role !== 'ADMIN' && req.authenticatedUser?.role !== 'MANAGER') {\n        return res.status(403).json({ message: \"Access denied. This endpoint is for ADMIN and MANAGER users only.\" });\n      }\n      \n      const users = await storage.getAllUsers();\n      \n      // Return users without sensitive data\n      const sanitizedUsers = users.map(user => ({\n        id: user.id,\n        email: user.email,\n        firstName: user.firstName,\n        lastName: user.lastName,\n        profileImageUrl: user.profileImageUrl,\n        role: user.role,\n        companyId: user.companyId,\n        createdAt: user.createdAt,\n        updatedAt: user.updatedAt,\n      }));\n      \n      res.json(sanitizedUsers);\n    } catch (error) {\n      console.error('List users error:', error);\n      res.status(500).json({ message: \"Failed to fetch users\" });\n    }\n  });\n\n  // Create new user (ADMIN only)\n  app.post(\"/api/users\", requireAuth, requireAdminRole, async (req, res) => {\n    try {\n      const userData = insertUserSchema.parse(req.body);\n      \n      // Business rule validation: CONTRACTOR must have companyId\n      if (userData.role === 'CONTRACTOR' && !userData.companyId) {\n        return res.status(400).json({ \n          message: \"CONTRACTOR users must be assigned to a company\" \n        });\n      }\n      \n      // Business rule validation: ADMIN and UTILITY should not have companyId\n      if ((userData.role === 'ADMIN' || userData.role === 'UTILITY') && userData.companyId) {\n        return res.status(400).json({ \n          message: `${userData.role} users cannot be assigned to a company` \n        });\n      }\n      \n      const user = await storage.createUser(userData);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'user.create',\n        entityType: 'user',\n        entityId: user.id,\n        details: { email: user.email, role: user.role, companyId: user.companyId },\n        context: getAuditContext(req),\n      });\n      \n      // Return user without sensitive data\n      res.json({\n        id: user.id,\n        email: user.email,\n        firstName: user.firstName,\n        lastName: user.lastName,\n        profileImageUrl: user.profileImageUrl,\n        role: user.role,\n        companyId: user.companyId,\n        createdAt: user.createdAt,\n        updatedAt: user.updatedAt,\n      });\n    } catch (error) {\n      console.error('Create user error:', error);\n      if (error instanceof Error) {\n        res.status(400).json({ message: error.message });\n      } else {\n        res.status(400).json({ message: \"Invalid user data\" });\n      }\n    }\n  });\n\n  // Update user (ADMIN only)\n  app.patch(\"/api/users/:id\", requireAuth, requireAdminRole, async (req, res) => {\n    try {\n      const updates = insertUserSchema.partial().parse(req.body);\n      \n      // Get current user to check role changes\n      const currentUser = await storage.getUser(req.params.id);\n      if (!currentUser) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      // Determine final role after update\n      const finalRole = updates.role || currentUser.role;\n      const finalCompanyId = updates.companyId !== undefined ? updates.companyId : currentUser.companyId;\n      \n      // Business rule validation: CONTRACTOR must have companyId\n      if (finalRole === 'CONTRACTOR' && !finalCompanyId) {\n        return res.status(400).json({ \n          message: \"CONTRACTOR users must be assigned to a company\" \n        });\n      }\n      \n      // Business rule validation: ADMIN and UTILITY should not have companyId\n      if ((finalRole === 'ADMIN' || finalRole === 'UTILITY') && finalCompanyId) {\n        return res.status(400).json({ \n          message: `${finalRole} users cannot be assigned to a company` \n        });\n      }\n      \n      const user = await storage.updateUser(req.params.id, updates);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found or deleted\" });\n      }\n      \n      // Audit log\n      await createAuditLog({\n        action: 'user.update',\n        entityType: 'user',\n        entityId: user.id,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      // Return user without sensitive data\n      res.json({\n        id: user.id,\n        email: user.email,\n        firstName: user.firstName,\n        lastName: user.lastName,\n        profileImageUrl: user.profileImageUrl,\n        role: user.role,\n        companyId: user.companyId,\n        createdAt: user.createdAt,\n        updatedAt: user.updatedAt,\n      });\n    } catch (error) {\n      console.error('Update user error:', error);\n      if (error instanceof Error) {\n        res.status(400).json({ message: error.message });\n      } else {\n        res.status(400).json({ message: \"Invalid user data\" });\n      }\n    }\n  });\n\n  // Delete user (soft delete, ADMIN only)\n  app.delete(\"/api/users/:id\", requireAuth, requireAdminRole, async (req, res) => {\n    try {\n      const user = await storage.deleteUser(req.params.id);\n      \n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      // Audit log\n      await createAuditLog({\n        action: 'user.delete',\n        entityType: 'user',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"User deleted successfully\" });\n    } catch (error) {\n      console.error('Delete user error:', error);\n      res.status(500).json({ message: \"Failed to delete user\" });\n    }\n  });\n\n  // ============================================================================\n  // USER COMPANY ACCESS API (MANAGER only)\n  // ============================================================================\n\n  // Grant UTILITY user access to a company (MANAGER only)\n  app.post(\"/api/user-company-access\", requireAuth, requireManager, async (req, res) => {\n    try {\n      // Client sends only userId and companyId, server adds grantedBy\n      const grantAccessSchema = insertUserCompanyAccessSchema.omit({ grantedBy: true });\n      const { userId, companyId } = grantAccessSchema.parse(req.body);\n      \n      // Verify the user exists and is UTILITY role\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      if (user.role !== 'UTILITY') {\n        return res.status(400).json({ \n          message: \"Company access can only be granted to UTILITY users\" \n        });\n      }\n      \n      // Verify the company exists\n      const company = await storage.getCompany(companyId);\n      if (!company) {\n        return res.status(404).json({ message: \"Company not found\" });\n      }\n      \n      // Grant access with grantedBy set to current manager\n      const access = await storage.grantUserCompanyAccess({\n        userId,\n        companyId,\n        grantedBy: req.authenticatedUser!.id,\n      });\n      \n      // Audit log\n      await createAuditLog({\n        action: 'user_company_access.grant',\n        entityType: 'user_company_access',\n        entityId: access.id,\n        details: { userId, companyId, grantedBy: req.authenticatedUser!.id },\n        context: getAuditContext(req),\n      });\n      \n      res.json(access);\n    } catch (error) {\n      console.error('Grant access error:', error);\n      if (error instanceof Error) {\n        res.status(400).json({ message: error.message });\n      } else {\n        res.status(400).json({ message: \"Failed to grant access\" });\n      }\n    }\n  });\n\n  // Revoke UTILITY user access to a company (MANAGER only)\n  app.delete(\"/api/user-company-access\", requireAuth, requireManager, async (req, res) => {\n    try {\n      // Validate request body (userId and companyId required)\n      const revokeAccessSchema = z.object({\n        userId: z.string(),\n        companyId: z.string(),\n      });\n      const { userId, companyId } = revokeAccessSchema.parse(req.body);\n      \n      // Find the access grant by userId and companyId\n      const accesses = await storage.getUserCompanyAccesses(userId);\n      const access = accesses.find(a => a.companyId === companyId);\n      \n      if (!access) {\n        return res.status(404).json({ \n          message: \"Access grant not found\" \n        });\n      }\n      \n      // Revoke access by ID\n      await storage.revokeUserCompanyAccess(access.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'user_company_access.revoke',\n        entityType: 'user_company_access',\n        entityId: access.id,\n        details: { userId, companyId, revokedBy: req.authenticatedUser!.id },\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Access revoked successfully\" });\n    } catch (error) {\n      console.error('Revoke access error:', error);\n      if (error instanceof Error) {\n        res.status(400).json({ message: error.message });\n      } else {\n        res.status(500).json({ message: \"Failed to revoke access\" });\n      }\n    }\n  });\n\n  // List company access grants for a user (MANAGER only)\n  app.get(\"/api/user-company-access/:userId\", requireAuth, requireManager, async (req, res) => {\n    try {\n      const { userId } = req.params;\n      \n      // Get user to verify they exist\n      const user = await storage.getUser(userId);\n      if (!user) {\n        return res.status(404).json({ message: \"User not found\" });\n      }\n      \n      // Get all companies the user has access to (efficient method)\n      const companies = await storage.getUserAccessibleCompanies(userId);\n      \n      res.json(companies);\n    } catch (error) {\n      console.error('List user access error:', error);\n      res.status(500).json({ message: \"Failed to fetch user access\" });\n    }\n  });\n\n  // ============================================================================\n  // COMPANIES API (Storm Response Management)\n  // ============================================================================\n\n  // Create company (MANAGER or UTILITY role)\n  app.post(\"/api/companies\", requireAuth, requireManagerOrUtility, async (req, res) => {\n    try {\n      const companyData = insertCompanySchema.parse(req.body);\n      const company = await storage.createCompany(companyData);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'company.create',\n        entityType: 'company',\n        entityId: company.id,\n        details: { name: company.name },\n        context: getAuditContext(req),\n      });\n      \n      res.json(company);\n    } catch (error) {\n      console.error('Create company error:', error);\n      res.status(400).json({ message: \"Invalid company data\" });\n    }\n  });\n\n  // List companies (ADMIN and MANAGER see all, CONTRACTOR sees own, UTILITY sees granted)\n  app.get(\"/api/companies\", requireAuth, async (req, res) => {\n    try {\n      const user = req.authenticatedUser!;\n      \n      // ADMIN and MANAGER see all companies\n      if (user.role === 'ADMIN' || user.role === 'MANAGER') {\n        const companies = await storage.getAllCompanies();\n        return res.json(companies);\n      }\n      \n      // CONTRACTOR sees only their own company\n      if (user.role === 'CONTRACTOR') {\n        if (!user.companyId) {\n          return res.status(403).json({ \n            message: \"Company assignment required. Contact your administrator.\" \n          });\n        }\n        const companies = await storage.getAllCompanies();\n        const filtered = companies.filter(c => c.id === user.companyId);\n        return res.json(filtered);\n      }\n      \n      // UTILITY sees only companies they've been granted access to\n      if (user.role === 'UTILITY') {\n        const companies = await storage.getUserAccessibleCompanies(user.id);\n        return res.json(companies);\n      }\n      \n      return res.status(403).json({ message: \"Access denied\" });\n    } catch (error) {\n      console.error('List companies error:', error);\n      res.status(500).json({ message: \"Failed to fetch companies\" });\n    }\n  });\n\n  // Get single company\n  app.get(\"/api/companies/:id\", requireAuth, requireCompanyAccess((req) => req.params.id), async (req, res) => {\n    try {\n      const company = await storage.getCompany(req.params.id);\n      \n      if (!company) {\n        return res.status(404).json({ message: \"Company not found\" });\n      }\n      \n      res.json(company);\n    } catch (error) {\n      console.error('Get company error:', error);\n      res.status(500).json({ message: \"Failed to fetch company\" });\n    }\n  });\n\n  // Update company (MANAGER role only)\n  app.patch(\"/api/companies/:id\", requireAuth, requireManager, async (req, res) => {\n    try {\n      const updates = insertCompanySchema.partial().parse(req.body);\n      const company = await storage.updateCompany(req.params.id, updates);\n      \n      if (!company) {\n        return res.status(404).json({ message: \"Company not found\" });\n      }\n      \n      // Audit log\n      await createAuditLog({\n        action: 'company.update',\n        entityType: 'company',\n        entityId: company.id,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      res.json(company);\n    } catch (error) {\n      console.error('Update company error:', error);\n      res.status(400).json({ message: \"Invalid company data\" });\n    }\n  });\n\n  // Delete company (MANAGER role only)\n  app.delete(\"/api/companies/:id\", requireAuth, requireManager, async (req, res) => {\n    try {\n      await storage.deleteCompany(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'company.delete',\n        entityType: 'company',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Company deleted successfully\" });\n    } catch (error) {\n      console.error('Delete company error:', error);\n      res.status(500).json({ message: \"Failed to delete company\" });\n    }\n  });\n\n  // Sync companies from contractors database\n  app.post(\"/api/companies/sync-from-contractors\", requireAuth, async (req, res) => {\n    try {\n      // Get all contractors with unique company names\n      const allContractors = await storage.getAllContractors();\n      const uniqueCompanyNames = [...new Set(allContractors.map(c => c.company).filter(Boolean))];\n      \n      // Get existing companies\n      const existingCompanies = await storage.getAllCompanies();\n      const existingCompanyNames = new Set(existingCompanies.map(c => c.name));\n      \n      // Create companies for new contractor companies\n      let createdCount = 0;\n      for (const companyName of uniqueCompanyNames) {\n        if (!existingCompanyNames.has(companyName)) {\n          await storage.createCompany({\n            name: companyName,\n            contactName: null,\n            contactEmail: null,\n            contactPhone: null,\n            billingAddress: null,\n            notes: 'Auto-synced from contractors database',\n          });\n          createdCount++;\n        }\n      }\n      \n      // Return updated list of companies\n      const companies = await storage.getAllCompanies();\n      \n      // Audit log\n      await createAuditLog({\n        action: 'company.sync',\n        entityType: 'company',\n        details: { \n          uniqueContractorCompanies: uniqueCompanyNames.length,\n          createdCount,\n          totalCompanies: companies.length \n        },\n        context: getAuditContext(req),\n      });\n      \n      res.json({ \n        message: `Synced ${createdCount} new companies from contractors database`,\n        createdCount,\n        totalCompanies: companies.length,\n        companies \n      });\n    } catch (error) {\n      console.error('Sync companies error:', error);\n      res.status(500).json({ message: \"Failed to sync companies\" });\n    }\n  });\n\n  // ============================================================================\n  // CONTRACTOR PROFILE API\n  // ============================================================================\n\n  // Get contractor profile (CONTRACTOR only)\n  app.get(\"/api/profile\", requireAuth, async (req, res) => {\n    try {\n      const user = req.authenticatedUser!;\n      \n      if (user.role !== 'CONTRACTOR') {\n        return res.status(403).json({ message: \"This endpoint is only available for CONTRACTOR users\" });\n      }\n      \n      if (!user.companyId) {\n        return res.status(404).json({ message: \"No company assigned to this contractor\" });\n      }\n      \n      const company = await storage.getCompany(user.companyId);\n      if (!company) {\n        return res.status(404).json({ message: \"Company not found\" });\n      }\n      \n      res.json(company);\n    } catch (error) {\n      console.error('Get profile error:', error);\n      res.status(500).json({ message: \"Failed to fetch profile\" });\n    }\n  });\n\n  // Update contractor profile (CONTRACTOR only)\n  app.patch(\"/api/profile\", requireAuth, async (req, res) => {\n    try {\n      const user = req.authenticatedUser!;\n      \n      if (user.role !== 'CONTRACTOR') {\n        return res.status(403).json({ message: \"This endpoint is only available for CONTRACTOR users\" });\n      }\n      \n      if (!user.companyId) {\n        return res.status(404).json({ message: \"No company assigned to this contractor\" });\n      }\n      \n      const updates = insertCompanySchema.partial().parse(req.body);\n      const updated = await storage.updateCompany(user.companyId, updates);\n      \n      if (!updated) {\n        return res.status(404).json({ message: \"Company not found\" });\n      }\n      \n      // Audit log\n      await createAuditLog({\n        action: 'company.update_profile',\n        entityType: 'company',\n        entityId: user.companyId,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update profile error:', error);\n      res.status(500).json({ message: \"Failed to update profile\" });\n    }\n  });\n\n  // ============================================================================\n  // STORM SESSIONS API\n  // ============================================================================\n\n  // Create storm session (ADMIN or MANAGER only)\n  app.post(\"/api/storm-sessions\", requireAuth, requireAdminOrManager, async (req, res) => {\n    try {\n      const sessionData = insertStormSessionSchema.parse(req.body);\n      \n      // If setting this session as active, first deactivate all other sessions\n      if (sessionData.isActive) {\n        await storage.deactivateAllSessions();\n      }\n      \n      const session = await storage.createStormSession(sessionData);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'session.create',\n        entityType: 'session',\n        entityId: session.id,\n        details: { name: session.name, status: session.status, isActive: session.isActive },\n        context: getAuditContext(req),\n      });\n      \n      res.json(session);\n    } catch (error) {\n      console.error('Create storm session error:', error);\n      res.status(400).json({ message: \"Invalid session data\" });\n    }\n  });\n\n  // List storm sessions\n  app.get(\"/api/storm-sessions\", requireAuth, async (req, res) => {\n    try {\n      const sessions = await storage.getAllStormSessions();\n      res.json(sessions);\n    } catch (error) {\n      console.error('List storm sessions error:', error);\n      res.status(500).json({ message: \"Failed to fetch sessions\" });\n    }\n  });\n\n  // Get single storm session\n  app.get(\"/api/storm-sessions/:id\", requireAuth, async (req, res) => {\n    try {\n      const session = await storage.getStormSession(req.params.id);\n      \n      if (!session) {\n        return res.status(404).json({ message: \"Session not found\" });\n      }\n      \n      res.json(session);\n    } catch (error) {\n      console.error('Get storm session error:', error);\n      res.status(500).json({ message: \"Failed to fetch session\" });\n    }\n  });\n\n  // Update storm session (ADMIN or MANAGER only)\n  app.patch(\"/api/storm-sessions/:id\", requireAuth, requireAdminOrManager, async (req, res) => {\n    try {\n      const updates = insertStormSessionSchema.partial().parse(req.body);\n      const session = await storage.updateStormSession(req.params.id, updates);\n      \n      if (!session) {\n        return res.status(404).json({ message: \"Session not found\" });\n      }\n      \n      // Audit log\n      await createAuditLog({\n        action: 'session.update',\n        entityType: 'session',\n        entityId: session.id,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      res.json(session);\n    } catch (error) {\n      console.error('Update storm session error:', error);\n      res.status(400).json({ message: \"Invalid session data\" });\n    }\n  });\n\n  // Close storm session (ADMIN or MANAGER only)\n  app.post(\"/api/storm-sessions/:id/close\", requireAuth, requireAdminOrManager, async (req, res) => {\n    try {\n      const session = await storage.closeStormSession(req.params.id);\n      \n      if (!session) {\n        return res.status(404).json({ message: \"Session not found\" });\n      }\n      \n      // Audit log\n      await createAuditLog({\n        action: 'session.close',\n        entityType: 'session',\n        entityId: session.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json(session);\n    } catch (error) {\n      console.error('Close storm session error:', error);\n      res.status(500).json({ message: \"Failed to close session\" });\n    }\n  });\n\n  // Reopen storm session (ADMIN or MANAGER only)\n  app.post(\"/api/storm-sessions/:id/reopen\", requireAuth, requireAdminOrManager, async (req, res) => {\n    try {\n      const session = await storage.reopenStormSession(req.params.id);\n      \n      if (!session) {\n        return res.status(404).json({ message: \"Session not found\" });\n      }\n      \n      // Audit log\n      await createAuditLog({\n        action: 'session.reopen',\n        entityType: 'session',\n        entityId: session.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json(session);\n    } catch (error) {\n      console.error('Reopen storm session error:', error);\n      res.status(500).json({ message: \"Failed to reopen session\" });\n    }\n  });\n\n  // Activate storm session (ADMIN or MANAGER only)\n  app.post(\"/api/storm-sessions/:id/activate\", requireAuth, requireAdminOrManager, async (req, res) => {\n    try {\n      const session = await storage.activateStormSession(req.params.id);\n      \n      if (!session) {\n        return res.status(404).json({ message: \"Session not found\" });\n      }\n      \n      // Audit log\n      await createAuditLog({\n        action: 'session.activate',\n        entityType: 'session',\n        entityId: session.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json(session);\n    } catch (error) {\n      console.error('Activate storm session error:', error);\n      res.status(500).json({ message: \"Failed to activate session\" });\n    }\n  });\n\n  // Deactivate storm session (ADMIN or MANAGER only)\n  app.post(\"/api/storm-sessions/:id/deactivate\", requireAuth, requireAdminOrManager, async (req, res) => {\n    try {\n      const session = await storage.deactivateStormSession(req.params.id);\n      \n      if (!session) {\n        return res.status(404).json({ message: \"Session not found\" });\n      }\n      \n      // Audit log\n      await createAuditLog({\n        action: 'session.deactivate',\n        entityType: 'session',\n        entityId: session.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json(session);\n    } catch (error) {\n      console.error('Deactivate storm session error:', error);\n      res.status(500).json({ message: \"Failed to deactivate session\" });\n    }\n  });\n\n  // Get active storm session\n  app.get(\"/api/storm-sessions/active\", requireAuth, async (req, res) => {\n    try {\n      const activeSession = await storage.getActiveStormSession();\n      \n      // Return null when no session is active (200 status, not 404)\n      res.json({ activeSession: activeSession || null });\n    } catch (error) {\n      console.error('Get active storm session error:', error);\n      res.status(500).json({ message: \"Failed to fetch active session\" });\n    }\n  });\n\n  // Add contractor to session (ADMIN or MANAGER only)\n  app.post(\"/api/storm-sessions/:id/contractors\", requireAuth, requireAdminOrManager, async (req, res) => {\n    try {\n      const { contractorCompanyId } = req.body;\n      \n      if (!contractorCompanyId) {\n        return res.status(400).json({ message: \"contractorCompanyId is required\" });\n      }\n      \n      await storage.addContractorToSession(req.params.id, contractorCompanyId);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'session.add_contractor',\n        entityType: 'session',\n        entityId: req.params.id,\n        details: { contractorCompanyId },\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Contractor added to session successfully\" });\n    } catch (error) {\n      console.error('Add contractor to session error:', error);\n      res.status(500).json({ message: \"Failed to add contractor to session\" });\n    }\n  });\n\n  // Remove contractor from session (ADMIN or MANAGER only)\n  app.delete(\"/api/storm-sessions/:id/contractors/:contractorId\", requireAuth, requireAdminOrManager, async (req, res) => {\n    try {\n      await storage.removeContractorFromSession(req.params.id, req.params.contractorId);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'session.remove_contractor',\n        entityType: 'session',\n        entityId: req.params.id,\n        details: { contractorCompanyId: req.params.contractorId },\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Contractor removed from session successfully\" });\n    } catch (error) {\n      console.error('Remove contractor from session error:', error);\n      res.status(500).json({ message: \"Failed to remove contractor from session\" });\n    }\n  });\n\n  // ============================================================================\n  // ROSTERS API\n  // ============================================================================\n\n  // Helper function to check roster company access based on RBAC rules\n  async function ensureRosterCompanyAccess(\n    user: { id: string; role: string; companyId: string | null },\n    companyId: string\n  ): Promise<{ allowed: boolean; message?: string }> {\n    // ADMIN and MANAGER have full access\n    if (user.role === 'ADMIN' || user.role === 'MANAGER') {\n      return { allowed: true };\n    }\n    \n    // CONTRACTOR can only access their own company\n    if (user.role === 'CONTRACTOR') {\n      if (!user.companyId) {\n        return { allowed: false, message: \"Company assignment required\" };\n      }\n      if (user.companyId !== companyId) {\n        return { allowed: false, message: \"Cannot access roster for another company\" };\n      }\n      return { allowed: true };\n    }\n    \n    // UTILITY can only access companies they've been granted access to\n    if (user.role === 'UTILITY') {\n      const hasAccess = await storage.hasUtilityCompanyAccess(user.id, companyId);\n      if (!hasAccess) {\n        return { allowed: false, message: \"Cannot access roster for this company\" };\n      }\n      return { allowed: true };\n    }\n    \n    return { allowed: false, message: \"Access denied\" };\n  }\n\n  // Create roster\n  app.post(\"/api/rosters\", requireAuth, async (req, res) => {\n    try {\n      const rosterData = insertRosterSchema.parse(req.body);\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, rosterData.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const roster = await storage.createRoster(rosterData);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'roster.create',\n        entityType: 'roster',\n        entityId: roster.id,\n        details: { sessionId: roster.sessionId, companyId: roster.companyId },\n        context: getAuditContext(req),\n      });\n      \n      res.json(roster);\n    } catch (error) {\n      console.error('Create roster error:', error);\n      res.status(400).json({ message: \"Invalid roster data\" });\n    }\n  });\n\n  // List rosters (filtered by session or company)\n  app.get(\"/api/rosters\", requireAuth, async (req, res) => {\n    try {\n      const { sessionId, companyId } = req.query;\n      const user = req.authenticatedUser!;\n      \n      // For UTILITY users, fetch accessible companies once (performance optimization)\n      let accessibleCompanyIds: Set<string> | null = null;\n      if (user.role === 'UTILITY') {\n        const companies = await storage.getUserAccessibleCompanies(user.id);\n        accessibleCompanyIds = new Set(companies.map(c => c.id));\n      }\n      \n      let rosters;\n      if (sessionId) {\n        // Fetch all rosters for the session\n        const allRosters = await storage.getRostersBySession(sessionId as string);\n        \n        // ADMIN and MANAGER see all rosters\n        if (user.role === 'ADMIN' || user.role === 'MANAGER') {\n          rosters = allRosters;\n        }\n        // CONTRACTOR sees only their company's rosters\n        else if (user.role === 'CONTRACTOR') {\n          if (!user.companyId) {\n            return res.status(403).json({ message: \"Company assignment required\" });\n          }\n          rosters = allRosters.filter(r => r.companyId === user.companyId);\n        }\n        // UTILITY sees only rosters for companies they have access to\n        else if (user.role === 'UTILITY') {\n          rosters = allRosters.filter(r => accessibleCompanyIds!.has(r.companyId));\n        } else {\n          return res.status(403).json({ message: \"Access denied\" });\n        }\n      } else if (companyId) {\n        // Verify company access\n        if (user.role === 'ADMIN' || user.role === 'MANAGER') {\n          rosters = await storage.getRostersByCompany(companyId as string);\n        } else if (user.role === 'CONTRACTOR') {\n          if (user.companyId !== companyId) {\n            return res.status(403).json({ message: \"Cannot access rosters for another company\" });\n          }\n          rosters = await storage.getRostersByCompany(companyId as string);\n        } else if (user.role === 'UTILITY') {\n          if (!accessibleCompanyIds!.has(companyId as string)) {\n            return res.status(403).json({ message: \"Cannot access rosters for this company\" });\n          }\n          rosters = await storage.getRostersByCompany(companyId as string);\n        } else {\n          return res.status(403).json({ message: \"Access denied\" });\n        }\n      } else {\n        return res.status(400).json({ message: \"sessionId or companyId query parameter required\" });\n      }\n      \n      res.json(rosters);\n    } catch (error) {\n      console.error('List rosters error:', error);\n      res.status(500).json({ message: \"Failed to fetch rosters\" });\n    }\n  });\n\n  // Download roster import template\n  app.get(\"/api/rosters/template\", requireAuth, async (req, res) => {\n    try {\n      const xlsxModule = await import('xlsx');\n      const XLSX = xlsxModule.default || xlsxModule;\n      \n      // Create workbook with two sheets: CREW and EQUIPMENTS\n      const workbook = XLSX.utils.book_new();\n      \n      // CREW sheet headers matching the import parser's expected format\n      const crewHeaders = [\n        'CREW ID',\n        'PERSONNEL ID',\n        'FIRST NAME',\n        'LAST NAME',\n        'EMAIL',\n        'CELL PHONE',\n        'GENDER',\n        'TEAM LEAD / GENERAL FOREMAN (Y/N)',\n        'CREW LEAD / FOREMAN(Y/N)',\n        'TEAM TYPE',\n        'RESOURCE TYPE',\n        'DEPARTURE CITY',\n        'DEPARTURE STATE'\n      ];\n      \n      // Sample data row for CREW\n      const crewSampleData = [\n        '001',\n        'EMP-001',\n        'John',\n        'Smith',\n        'john.smith@example.com',\n        '555-123-4567',\n        'M',\n        'No',\n        'Yes',\n        'Line',\n        'Lineman',\n        'Atlanta',\n        'GA'\n      ];\n      \n      const crewData = [crewHeaders, crewSampleData];\n      const crewSheet = XLSX.utils.aoa_to_sheet(crewData);\n      \n      // Set column widths for CREW sheet\n      crewSheet['!cols'] = [\n        { wch: 10 }, // CREW ID\n        { wch: 12 }, // PERSONNEL ID\n        { wch: 15 }, // FIRST NAME\n        { wch: 15 }, // LAST NAME\n        { wch: 25 }, // EMAIL\n        { wch: 15 }, // CELL PHONE\n        { wch: 8 },  // GENDER\n        { wch: 35 }, // TEAM LEAD / GENERAL FOREMAN (Y/N)\n        { wch: 25 }, // CREW LEAD / FOREMAN(Y/N)\n        { wch: 12 }, // TEAM TYPE\n        { wch: 15 }, // RESOURCE TYPE\n        { wch: 15 }, // DEPARTURE CITY\n        { wch: 15 }, // DEPARTURE STATE\n      ];\n      \n      XLSX.utils.book_append_sheet(workbook, crewSheet, 'CREW');\n      \n      // EQUIPMENTS sheet headers matching the import parser's expected format\n      const equipmentHeaders = [\n        'EQUIPMENT ID',\n        'EQUIPMENT TYPE',\n        'EQUIPMENT DESCRIPTION',\n        'EQUIPMENT FUEL TYPE',\n        'ASSIGNED EQUIPMENT CREW ID'\n      ];\n      \n      // Sample data row for EQUIPMENTS\n      const equipmentSampleData = [\n        'EQ-001',\n        'Bucket Truck',\n        'Ford F-550 Bucket Truck',\n        'Diesel',\n        '001'\n      ];\n      \n      const equipmentData = [equipmentHeaders, equipmentSampleData];\n      const equipmentSheet = XLSX.utils.aoa_to_sheet(equipmentData);\n      \n      // Set column widths for EQUIPMENTS sheet\n      equipmentSheet['!cols'] = [\n        { wch: 15 }, // EQUIPMENT ID\n        { wch: 15 }, // EQUIPMENT TYPE\n        { wch: 30 }, // EQUIPMENT DESCRIPTION\n        { wch: 20 }, // EQUIPMENT FUEL TYPE\n        { wch: 25 }, // ASSIGNED EQUIPMENT CREW ID\n      ];\n      \n      XLSX.utils.book_append_sheet(workbook, equipmentSheet, 'EQUIPMENTS');\n      \n      // Generate buffer\n      const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });\n      \n      res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n      res.setHeader('Content-Disposition', 'attachment; filename=\"roster-import-template.xlsx\"');\n      res.send(Buffer.from(buffer));\n    } catch (error) {\n      console.error('Generate template error:', error);\n      res.status(500).json({ message: \"Failed to generate template\" });\n    }\n  });\n\n  // Export all rosters for a session (combined into one Excel file)\n  app.get(\"/api/rosters/export-all\", requireAuth, async (req, res) => {\n    try {\n      const { sessionId } = req.query;\n      if (!sessionId) {\n        return res.status(400).json({ message: \"sessionId query parameter required\" });\n      }\n\n      const user = req.authenticatedUser!;\n      \n      // Get all rosters for the session\n      const allRosters = await storage.getRostersBySession(sessionId as string);\n      \n      // Filter based on user role and company access\n      let rosters;\n      if (user.role === 'ADMIN' || user.role === 'MANAGER') {\n        rosters = allRosters;\n      } else if (user.role === 'CONTRACTOR') {\n        if (!user.companyId) {\n          return res.status(403).json({ message: \"Company assignment required\" });\n        }\n        rosters = allRosters.filter(r => r.companyId === user.companyId);\n      } else if (user.role === 'UTILITY') {\n        const companies = await storage.getUserAccessibleCompanies(user.id);\n        const accessibleCompanyIds = new Set(companies.map(c => c.id));\n        rosters = allRosters.filter(r => accessibleCompanyIds.has(r.companyId));\n      } else {\n        return res.status(403).json({ message: \"Access denied\" });\n      }\n\n      if (rosters.length === 0) {\n        return res.status(404).json({ message: \"No rosters found\" });\n      }\n\n      // Collect all roster data\n      const allData: any[] = [];\n      \n      for (const roster of rosters) {\n        const company = await storage.getCompany(roster.companyId);\n        const crews = await storage.getCrewsByRoster(roster.id);\n        const personnel = await storage.getRosterPersonnel(roster.id);\n        const equipment = await storage.getRosterEquipment(roster.id);\n\n        // Create crew map for quick lookup\n        const crewMap = new Map(crews.map(c => [c.id, c.crewName]));\n        const companyName = company?.name || '';\n\n        // Add personnel\n        for (const person of personnel) {\n          const crewNumber = crewMap.get(person.crewId) || '';\n          allData.push({\n            'COMPANY NAME': companyName,\n            'CREW NUMBER': crewNumber,\n            'PERSONNEL ID': person.personnelId || '',\n            'FIRST NAME': person.firstName || '',\n            'LAST NAME': person.lastName || '',\n            'EMAIL': person.email || '',\n            'CELL PHONE': person.phone || '',\n            'GENDER': person.gender || '',\n            'TEAM LEAD / GENERAL FOREMAN (Y/N)': person.teamLead || '',\n            'CREW LEAD / FOREMAN(Y/N)': person.crewLeadFlag || '',\n            'TEAM TYPE': person.role || '',\n            'RESOURCE TYPE': person.classification || '',\n            'DEPARTURE CITY': person.departureCity || '',\n            'DEPARTURE STATE': person.departureState || ''\n          });\n        }\n\n        // Add blank line between sections\n        allData.push({});\n\n        // Add equipment\n        for (const equip of equipment) {\n          const crewNumber = crewMap.get(equip.crewId) || '';\n          allData.push({\n            'COMPANY NAME': companyName,\n            'CREW NUMBER': crewNumber,\n            'EQUIPMENT ID': equip.equipmentId || '',\n            'EQUIPMENT TYPE': equip.equipmentType || '',\n            'EQUIPMENT DESCRIPTION': equip.equipmentDescription || '',\n            'EQUIPMENT FUEL TYPE': equip.fuel || '',\n            'ASSIGNED EQUIPMENT CREW ID': equip.assignedCrewId || ''\n          });\n        }\n\n        allData.push({});\n      }\n\n      // Use XLSX to create workbook\n      const XLSX = await import('xlsx');\n      const workbook = XLSX.utils.book_new();\n      const worksheet = XLSX.utils.json_to_sheet(allData);\n      XLSX.utils.book_append_sheet(workbook, worksheet, 'Rosters');\n      \n      // Write to buffer\n      const buffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'buffer' });\n      \n      res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n      res.setHeader('Content-Disposition', `attachment; filename=\"all-rosters.xlsx\"`);\n      res.send(buffer);\n    } catch (error) {\n      console.error('Export all rosters error:', error);\n      res.status(500).json({ message: \"Failed to export rosters\" });\n    }\n  });\n\n  // Export single roster\n  app.get(\"/api/rosters/:id/export\", requireAuth, async (req, res) => {\n    try {\n      const roster = await storage.getRoster(req.params.id);\n      \n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n\n      // Verify company access\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n\n      // Fetch roster data\n      const crews = await storage.getCrewsByRoster(roster.id);\n      const personnel = await storage.getRosterPersonnel(roster.id);\n      const equipment = await storage.getRosterEquipment(roster.id);\n      const company = await storage.getCompany(roster.companyId);\n\n      // Build export data\n      const exportData: any[] = [];\n      \n      // Create crew map for quick lookup\n      const crewMap = new Map(crews.map(c => [c.id, c.crewName]));\n      const companyName = company?.name || '';\n\n      // Add personnel\n      for (const person of personnel) {\n        const crewNumber = crewMap.get(person.crewId) || '';\n        exportData.push({\n          'COMPANY NAME': companyName,\n          'CREW NUMBER': crewNumber,\n          'PERSONNEL ID': person.personnelId || '',\n          'FIRST NAME': person.firstName || '',\n          'LAST NAME': person.lastName || '',\n          'EMAIL': person.email || '',\n          'CELL PHONE': person.phone || '',\n          'GENDER': person.gender || '',\n          'TEAM LEAD / GENERAL FOREMAN (Y/N)': person.teamLead || '',\n          'CREW LEAD / FOREMAN(Y/N)': person.crewLeadFlag || '',\n          'TEAM TYPE': person.role || '',\n          'RESOURCE TYPE': person.classification || '',\n          'DEPARTURE CITY': person.departureCity || '',\n          'DEPARTURE STATE': person.departureState || ''\n        });\n      }\n\n      // Add blank line between sections\n      exportData.push({});\n\n      // Add equipment\n      for (const equip of equipment) {\n        const crewNumber = crewMap.get(equip.crewId) || '';\n        exportData.push({\n          'COMPANY NAME': companyName,\n          'CREW NUMBER': crewNumber,\n          'EQUIPMENT ID': equip.equipmentId || '',\n          'EQUIPMENT TYPE': equip.equipmentType || '',\n          'EQUIPMENT DESCRIPTION': equip.equipmentDescription || '',\n          'EQUIPMENT FUEL TYPE': equip.fuel || '',\n          'ASSIGNED EQUIPMENT CREW ID': equip.assignedCrewId || ''\n        });\n      }\n\n      // Use XLSX to create workbook\n      const XLSX = await import('xlsx');\n      const workbook = XLSX.utils.book_new();\n      const worksheet = XLSX.utils.json_to_sheet(exportData);\n      XLSX.utils.book_append_sheet(workbook, worksheet, 'Roster');\n      \n      // Write to buffer\n      const buffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'buffer' });\n      \n      res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n      res.setHeader('Content-Disposition', `attachment; filename=\"roster-${roster.id}.xlsx\"`);\n      res.send(buffer);\n    } catch (error) {\n      console.error('Export roster error:', error);\n      res.status(500).json({ message: \"Failed to export roster\" });\n    }\n  });\n\n  // Get single roster\n  app.get(\"/api/rosters/:id\", requireAuth, async (req, res) => {\n    try {\n      const roster = await storage.getRoster(req.params.id);\n      \n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      res.json(roster);\n    } catch (error) {\n      console.error('Get roster error:', error);\n      res.status(500).json({ message: \"Failed to fetch roster\" });\n    }\n  });\n\n  // Update roster\n  app.patch(\"/api/rosters/:id\", requireAuth, async (req, res) => {\n    try {\n      const roster = await storage.getRoster(req.params.id);\n      \n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const updates = insertRosterSchema.partial().parse(req.body);\n      const updated = await storage.updateRoster(req.params.id, updates);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'roster.update',\n        entityType: 'roster',\n        entityId: req.params.id,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update roster error:', error);\n      res.status(400).json({ message: \"Invalid roster data\" });\n    }\n  });\n\n  // Delete roster\n  app.delete(\"/api/rosters/:id\", requireAuth, async (req, res) => {\n    try {\n      const roster = await storage.getRoster(req.params.id);\n      \n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      await storage.deleteRoster(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'roster.delete',\n        entityType: 'roster',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Roster deleted successfully\" });\n    } catch (error) {\n      console.error('Delete roster error:', error);\n      res.status(500).json({ message: \"Failed to delete roster\" });\n    }\n  });\n\n  // Create crew\n  app.post(\"/api/rosters/:rosterId/crews\", requireAuth, async (req, res) => {\n    try {\n      const roster = await storage.getRoster(req.params.rosterId);\n      \n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const crewData = insertCrewSchema.parse({ ...req.body, rosterId: req.params.rosterId });\n      const crew = await storage.createCrew(crewData);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'crew.create',\n        entityType: 'crew',\n        entityId: crew.id,\n        details: { rosterId: roster.id, crewName: crew.crewName },\n        context: getAuditContext(req),\n      });\n      \n      res.json(crew);\n    } catch (error) {\n      console.error('Create crew error:', error);\n      res.status(400).json({ message: \"Invalid crew data\" });\n    }\n  });\n\n  // List crews for a roster\n  app.get(\"/api/rosters/:rosterId/crews\", requireAuth, async (req, res) => {\n    try {\n      const roster = await storage.getRoster(req.params.rosterId);\n      \n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const crews = await storage.getCrewsByRoster(req.params.rosterId);\n      res.json(crews);\n    } catch (error) {\n      console.error('List crews error:', error);\n      res.status(500).json({ message: \"Failed to fetch crews\" });\n    }\n  });\n\n  // Add personnel to roster\n  app.post(\"/api/rosters/:rosterId/personnel\", requireAuth, async (req, res) => {\n    try {\n      const roster = await storage.getRoster(req.params.rosterId);\n      \n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const personnelData = insertRosterPersonnelSchema.parse({ ...req.body, rosterId: req.params.rosterId });\n      const personnel = await storage.addRosterPersonnel(personnelData);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'roster_personnel.create',\n        entityType: 'roster_personnel',\n        entityId: personnel.id,\n        details: { rosterId: roster.id, name: personnel.name, role: personnel.role },\n        context: getAuditContext(req),\n      });\n      \n      res.json(personnel);\n    } catch (error) {\n      console.error('Add personnel error:', error);\n      res.status(400).json({ message: \"Invalid personnel data\" });\n    }\n  });\n\n  // List personnel for a roster\n  app.get(\"/api/rosters/:rosterId/personnel\", requireAuth, async (req, res) => {\n    try {\n      const roster = await storage.getRoster(req.params.rosterId);\n      \n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const personnel = await storage.getRosterPersonnel(req.params.rosterId);\n      res.json(personnel);\n    } catch (error) {\n      console.error('List personnel error:', error);\n      res.status(500).json({ message: \"Failed to fetch personnel\" });\n    }\n  });\n\n  // Add equipment to roster\n  app.post(\"/api/rosters/:rosterId/equipment\", requireAuth, async (req, res) => {\n    try {\n      const roster = await storage.getRoster(req.params.rosterId);\n      \n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const equipmentData = insertRosterEquipmentSchema.parse({ ...req.body, rosterId: req.params.rosterId });\n      const equipment = await storage.addRosterEquipment(equipmentData);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'roster_equipment.create',\n        entityType: 'roster_equipment',\n        entityId: equipment.id,\n        details: { rosterId: roster.id, type: equipment.type },\n        context: getAuditContext(req),\n      });\n      \n      res.json(equipment);\n    } catch (error) {\n      console.error('Add equipment error:', error);\n      res.status(400).json({ message: \"Invalid equipment data\" });\n    }\n  });\n\n  // List equipment for a roster\n  app.get(\"/api/rosters/:rosterId/equipment\", requireAuth, async (req, res) => {\n    try {\n      const roster = await storage.getRoster(req.params.rosterId);\n      \n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const equipment = await storage.getRosterEquipment(req.params.rosterId);\n      res.json(equipment);\n    } catch (error) {\n      console.error('List equipment error:', error);\n      res.status(500).json({ message: \"Failed to fetch equipment\" });\n    }\n  });\n\n  // Update crew\n  app.patch(\"/api/crews/:id\", requireAuth, async (req, res) => {\n    try {\n      const crew = await storage.getCrew(req.params.id);\n      \n      if (!crew) {\n        return res.status(404).json({ message: \"Crew not found\" });\n      }\n      \n      // Fetch roster to verify company access\n      const roster = await storage.getRoster(crew.rosterId);\n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access\n      if (req.authenticatedUser?.role !== 'UTILITY' && req.authenticatedUser?.companyId !== roster.companyId) {\n        return res.status(403).json({ message: \"Cannot update crew for another company's roster\" });\n      }\n      \n      const updates = insertCrewSchema.partial().parse(req.body);\n      const updated = await storage.updateCrew(req.params.id, updates);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'crew.update',\n        entityType: 'crew',\n        entityId: req.params.id,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update crew error:', error);\n      res.status(400).json({ message: \"Invalid crew data\" });\n    }\n  });\n\n  // Delete crew\n  app.delete(\"/api/crews/:id\", requireAuth, async (req, res) => {\n    try {\n      const crew = await storage.getCrew(req.params.id);\n      \n      if (!crew) {\n        return res.status(404).json({ message: \"Crew not found\" });\n      }\n      \n      // Fetch roster to verify company access\n      const roster = await storage.getRoster(crew.rosterId);\n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access\n      if (req.authenticatedUser?.role !== 'UTILITY' && req.authenticatedUser?.companyId !== roster.companyId) {\n        return res.status(403).json({ message: \"Cannot delete crew for another company's roster\" });\n      }\n      \n      await storage.deleteCrew(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'crew.delete',\n        entityType: 'crew',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Crew deleted successfully\" });\n    } catch (error) {\n      console.error('Delete crew error:', error);\n      res.status(500).json({ message: \"Failed to delete crew\" });\n    }\n  });\n\n  // Import roster from Excel file\n  app.post(\"/api/rosters/import-excel\", requireAuth, upload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n\n      const { sessionId, companyId } = req.body;\n      if (!sessionId || !companyId) {\n        return res.status(400).json({ message: \"sessionId and companyId are required\" });\n      }\n\n      // Verify company access (ADMIN, MANAGER, and UTILITY can import for any company)\n      if (req.authenticatedUser?.role !== 'ADMIN' && req.authenticatedUser?.role !== 'MANAGER' && req.authenticatedUser?.role !== 'UTILITY' && req.authenticatedUser?.companyId !== companyId) {\n        return res.status(403).json({ message: \"Cannot import roster for another company\" });\n      }\n\n      // Parse Excel file\n      const xlsxModule = await import('xlsx');\n      const XLSX = xlsxModule.default || xlsxModule;\n      const workbook = XLSX.readFile(req.file.path);\n      \n      // Parse CREW sheet\n      const crewSheet = workbook.Sheets['CREW'];\n      if (!crewSheet) {\n        return res.status(400).json({ message: \"CREW sheet not found in Excel file\" });\n      }\n      const crewData = XLSX.utils.sheet_to_json(crewSheet, { header: 1 }) as any[][];\n      \n      // Parse EQUIPMENTS sheet\n      const equipSheet = workbook.Sheets['EQUIPMENTS'];\n      const equipData = equipSheet ? XLSX.utils.sheet_to_json(equipSheet, { header: 1 }) as any[][] : [];\n\n      // Create roster\n      const roster = await storage.createRoster({\n        sessionId,\n        companyId,\n        status: 'DRAFT',\n      });\n\n      // Process crew data - use header row to find columns dynamically\n      const crewHeaders = crewData[0] || [];\n      const crewMap = new Map(); // Map crew ID to crew record\n      \n      // Create a map of header names to column indices\n      const headerMap: Record<string, number> = {};\n      crewHeaders.forEach((header, index) => {\n        const normalizedHeader = (header || '').toString().trim().toUpperCase();\n        headerMap[normalizedHeader] = index;\n      });\n      \n      // Log headers for debugging\n      console.log('CREW sheet headers:', crewHeaders);\n      console.log('Header map:', headerMap);\n      \n      for (let i = 1; i < crewData.length; i++) {\n        const row = crewData[i];\n        if (!row) continue; // Skip empty rows\n\n        // Extract data using exact header names from template\n        const crewId = (row[headerMap['CREW ID']] || '').toString().trim();\n        if (!crewId) continue; // Skip if no crew ID\n\n        const personnelId = (row[headerMap['PERSONNEL ID']] || '').toString().trim();\n        const lastName = (row[headerMap['LAST NAME']] || '').toString().trim();\n        const firstName = (row[headerMap['FIRST NAME']] || '').toString().trim();\n        const name = `${firstName} ${lastName}`.trim() || personnelId || crewId;\n        const email = (row[headerMap['EMAIL']] || '').toString().trim();\n        const phone = (row[headerMap['CELL PHONE']] || '').toString().trim();\n        const gender = (row[headerMap['GENDER']] || '').toString().trim();\n        const teamLead = (row[headerMap['TEAM LEAD / GENERAL FOREMAN (Y/N)']] || 'No').toString().trim();\n        const crewLead = (row[headerMap['CREW LEAD / FOREMAN(Y/N)']] || 'No').toString().trim();\n        const role = (row[headerMap['TEAM TYPE']] || '').toString().trim();\n        const classification = (row[headerMap['RESOURCE TYPE']] || '').toString().trim();\n        const departureCity = (row[headerMap['DEPARTURE CITY']] || '').toString().trim();\n        const departureState = (row[headerMap['DEPARTURE STATE']] || '').toString().trim();\n        const workArea = `${departureCity}, ${departureState}`.trim().replace(/^,\\s*|,\\s*$/g, '');\n\n        // Create or get crew\n        if (!crewMap.has(crewId)) {\n          const crew = await storage.createCrew({\n            rosterId: roster.id,\n            crewName: crewId,\n            crewLead: crewLead === 'Yes' || crewLead === 'YES' ? name : undefined,\n            workArea: workArea,\n          });\n          crewMap.set(crewId, crew);\n        }\n\n        const crew = crewMap.get(crewId);\n\n        // Create personnel with all captured data\n        await storage.addRosterPersonnel({\n          rosterId: roster.id,\n          crewId: crew.id,\n          personnelId: personnelId,\n          firstName: firstName,\n          lastName: lastName,\n          name: name,\n          role: role,\n          classification: classification,\n          rateCode: '', // Not in template\n          gender: gender,\n          stOtPtEligibility: '', // Not in template\n          email: email,\n          phone: phone,\n          teamLead: teamLead,\n          crewLeadFlag: crewLead,\n          departureCity: departureCity,\n          departureState: departureState,\n          notes: '',\n        });\n      }\n\n      // Process equipment data - use header row to find columns dynamically\n      if (equipData.length > 1) {\n        const equipHeaders = equipData[0] || [];\n        \n        // Create a map of header names to column indices\n        const equipHeaderMap: Record<string, number> = {};\n        equipHeaders.forEach((header, index) => {\n          const normalizedHeader = (header || '').toString().trim().toUpperCase();\n          equipHeaderMap[normalizedHeader] = index;\n        });\n        \n        // Log headers for debugging\n        console.log('EQUIPMENTS sheet headers:', equipHeaders);\n        console.log('Equipment header map:', equipHeaderMap);\n        \n        for (let i = 1; i < equipData.length; i++) {\n          const row = equipData[i];\n          if (!row) continue; // Skip empty rows\n\n          // Extract data using exact header names from template\n          const equipmentId = (row[equipHeaderMap['EQUIPMENT ID']] || '').toString().trim();\n          if (!equipmentId) continue; // Skip if no equipment ID\n\n          const equipmentType = (row[equipHeaderMap['EQUIPMENT TYPE']] || '').toString().trim();\n          const equipmentDescription = (row[equipHeaderMap['EQUIPMENT DESCRIPTION']] || '').toString().trim();\n          const fuelType = (row[equipHeaderMap['EQUIPMENT FUEL TYPE']] || '').toString().trim();\n          const assignedCrewId = (row[equipHeaderMap['ASSIGNED EQUIPMENT CREW ID']] || '').toString().trim();\n\n          const crew = crewMap.get(assignedCrewId);\n          \n          await storage.addRosterEquipment({\n            rosterId: roster.id,\n            crewId: crew?.id,\n            equipmentId: equipmentId,\n            equipmentType: equipmentType,\n            equipmentDescription: equipmentDescription,\n            type: equipmentDescription || equipmentType, // For backward compatibility\n            classification: equipmentType, // For backward compatibility\n            rateCode: '', // Not in template\n            ownership: '', // Not in template\n            fuel: fuelType,\n            assignedCrewId: assignedCrewId,\n            notes: '',\n          });\n        }\n      }\n\n      // Clean up uploaded file\n      await fs.unlink(req.file.path).catch(() => {});\n\n      // Audit log\n      await createAuditLog({\n        action: 'roster.import',\n        entityType: 'roster',\n        entityId: roster.id,\n        details: { \n          sessionId, \n          companyId, \n          crewCount: crewMap.size,\n          fileName: req.file.originalname \n        },\n        context: getAuditContext(req),\n      });\n\n      res.json({ \n        message: \"Roster imported successfully\",\n        roster,\n        crewCount: crewMap.size \n      });\n    } catch (error) {\n      console.error('Import roster error:', error);\n      res.status(500).json({ message: \"Failed to import roster\", error: error instanceof Error ? error.message : 'Unknown error' });\n    }\n  });\n\n  // Update personnel\n  app.patch(\"/api/personnel/:id\", requireAuth, async (req, res) => {\n    try {\n      // Get the personnel to find the rosterId\n      const personnelList = await db.select().from(rosterPersonnel).where(eq(rosterPersonnel.id, req.params.id));\n      const personnel = personnelList[0];\n      \n      if (!personnel) {\n        return res.status(404).json({ message: \"Personnel not found\" });\n      }\n      \n      // Fetch roster to verify company access\n      const roster = await storage.getRoster(personnel.rosterId);\n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const updates = insertRosterPersonnelSchema.partial().parse(req.body);\n      const updated = await storage.updateRosterPersonnel(req.params.id, updates);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'roster_personnel.update',\n        entityType: 'roster_personnel',\n        entityId: req.params.id,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update personnel error:', error);\n      res.status(400).json({ message: \"Invalid personnel data\" });\n    }\n  });\n\n  // Delete personnel\n  app.delete(\"/api/personnel/:id\", requireAuth, async (req, res) => {\n    try {\n      // Get the personnel to find the rosterId\n      const personnelList = await db.select().from(rosterPersonnel).where(eq(rosterPersonnel.id, req.params.id));\n      const personnel = personnelList[0];\n      \n      if (!personnel) {\n        return res.status(404).json({ message: \"Personnel not found\" });\n      }\n      \n      // Fetch roster to verify company access\n      const roster = await storage.getRoster(personnel.rosterId);\n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      await storage.removeRosterPersonnel(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'roster_personnel.delete',\n        entityType: 'roster_personnel',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Personnel deleted successfully\" });\n    } catch (error) {\n      console.error('Delete personnel error:', error);\n      res.status(500).json({ message: \"Failed to delete personnel\" });\n    }\n  });\n\n  // Update equipment\n  app.patch(\"/api/equipment/:id\", requireAuth, async (req, res) => {\n    try {\n      // Get the equipment to find the rosterId\n      const equipmentList = await db.select().from(rosterEquipment).where(eq(rosterEquipment.id, req.params.id));\n      const equipment = equipmentList[0];\n      \n      if (!equipment) {\n        return res.status(404).json({ message: \"Equipment not found\" });\n      }\n      \n      // Fetch roster to verify company access\n      const roster = await storage.getRoster(equipment.rosterId);\n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const updates = insertRosterEquipmentSchema.partial().parse(req.body);\n      const updated = await storage.updateRosterEquipment(req.params.id, updates);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'roster_equipment.update',\n        entityType: 'roster_equipment',\n        entityId: req.params.id,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update equipment error:', error);\n      res.status(400).json({ message: \"Invalid equipment data\" });\n    }\n  });\n\n  // Delete equipment\n  app.delete(\"/api/equipment/:id\", requireAuth, async (req, res) => {\n    try {\n      // Get the equipment to find the rosterId\n      const equipmentList = await db.select().from(rosterEquipment).where(eq(rosterEquipment.id, req.params.id));\n      const equipment = equipmentList[0];\n      \n      if (!equipment) {\n        return res.status(404).json({ message: \"Equipment not found\" });\n      }\n      \n      // Fetch roster to verify company access\n      const roster = await storage.getRoster(equipment.rosterId);\n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureRosterCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      await storage.removeRosterEquipment(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'roster_equipment.delete',\n        entityType: 'roster_equipment',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Equipment deleted successfully\" });\n    } catch (error) {\n      console.error('Delete equipment error:', error);\n      res.status(500).json({ message: \"Failed to delete equipment\" });\n    }\n  });\n\n  // ============================================================================\n  // TIMESHEETS API\n  // ============================================================================\n\n  // Helper function to check timesheet company access based on RBAC rules\n  async function ensureTimesheetCompanyAccess(\n    user: { id: string; role: string; companyId: string | null },\n    companyId: string\n  ): Promise<{ allowed: boolean; message?: string }> {\n    if (user.role === 'ADMIN' || user.role === 'MANAGER') {\n      return { allowed: true };\n    }\n    if (user.role === 'CONTRACTOR') {\n      if (!user.companyId) {\n        return { allowed: false, message: \"Company assignment required\" };\n      }\n      if (user.companyId !== companyId) {\n        return { allowed: false, message: \"Cannot access timesheet for another company\" };\n      }\n      return { allowed: true };\n    }\n    if (user.role === 'UTILITY') {\n      const hasAccess = await storage.hasUtilityCompanyAccess(user.id, companyId);\n      if (!hasAccess) {\n        return { allowed: false, message: \"Cannot access timesheet for this company\" };\n      }\n      return { allowed: true };\n    }\n    return { allowed: false, message: \"Access denied\" };\n  }\n\n  // Create timesheet from roster (auto-populate personnel and equipment)\n  app.post(\"/api/timesheets/from-roster\", requireAuth, async (req, res) => {\n    try {\n      const { rosterId, crewId, date, startTime, stopTime, ...additionalData } = req.body;\n      \n      if (!rosterId || !crewId || !date) {\n        return res.status(400).json({ message: \"rosterId, crewId, and date are required\" });\n      }\n\n      // Calculate total hours from start/stop time\n      let totalHours = 0;\n      let workSegment = null;\n      if (startTime && stopTime) {\n        const [startHour, startMin] = startTime.split(':').map(Number);\n        const [stopHour, stopMin] = stopTime.split(':').map(Number);\n        const startMinutes = startHour * 60 + startMin;\n        let stopMinutes = stopHour * 60 + stopMin;\n        \n        // Handle overnight shifts (if stop < start, add 24 hours)\n        if (stopMinutes < startMinutes) {\n          stopMinutes += 24 * 60;\n        }\n        \n        totalHours = (stopMinutes - startMinutes) / 60;\n        \n        // Create work segment for personnel  \n        workSegment = {\n          activityType: 'S', // Standby - general work hours without specific ticket\n          startTime,\n          endTime: stopTime,\n        };\n      }\n\n      // Fetch the roster to get session and company info\n      const roster = await storage.getRoster(rosterId);\n      if (!roster) {\n        return res.status(404).json({ message: \"Roster not found\" });\n      }\n\n      // Verify company access\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, roster.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n\n      // Fetch crew info\n      const crew = await storage.getCrew(crewId);\n      if (!crew) {\n        return res.status(404).json({ message: \"Crew not found\" });\n      }\n\n      // Fetch session info for auto-populate\n      const session = await storage.getStormSession(roster.sessionId);\n\n      // Get roster personnel to find the foreman\n      const rosterPersonnelList = await storage.getRosterPersonnel(rosterId);\n      const crewPersonnel = rosterPersonnelList.filter(p => p.crewId === crewId);\n      \n      // Find the foreman from roster personnel (look for \"foreman\" in role or classification)\n      const foremanPerson = crewPersonnel.find(p => {\n        const descriptor = `${p.role ?? ''} ${p.classification ?? ''}`.toLowerCase();\n        return descriptor.includes('foreman');\n      });\n      \n      // Set crew foreman name (person's name, not crew name)\n      const crewForemanName = foremanPerson?.name ?? '';\n      \n      // Set crew ID number (crew name like \"Crew-003\", not the UUID)\n      const crewIdNumber = crew.crewName || '';\n\n      // Create the timesheet header with auto-populated fields\n      const timesheet = await storage.createTimesheet({\n        sessionId: roster.sessionId,\n        companyId: roster.companyId,\n        crewId: crewId,\n        date: new Date(date),\n        crewForeman: crewForemanName,\n        crewIdNumber: crewIdNumber,\n        projectName: session?.name || '',\n        utilityName: session?.client || '',\n        jobLocations: session?.location || '',\n        locationAreaAssigned: '', // Don't auto-fill unless explicitly in session data\n        status: 'DRAFT',\n        ...additionalData,\n      });\n      for (const person of crewPersonnel) {\n        await storage.addTimesheetPersonnel({\n          timesheetId: timesheet.id,\n          employeeName: person.name,\n          classification: person.classification || person.role || 'Worker',\n          segments: workSegment ? [workSegment] : [],\n          startTime: startTime || null,\n          endTime: stopTime || null,\n          totalHours: totalHours,\n          mealsProvidedByUtility: 0,\n          perDiemMeals: 0,\n        });\n      }\n\n      // Auto-populate equipment from roster\n      const rosterEquipment = await storage.getRosterEquipment(rosterId);\n      const crewEquipment = rosterEquipment.filter(e => e.crewId === crewId);\n      for (const equip of crewEquipment) {\n        await storage.addTimesheetEquipment({\n          timesheetId: timesheet.id,\n          equipmentDescription: equip.type || 'Equipment',\n          equipmentNumber: equip.equipmentId || null,\n          startTime: startTime || null,\n          endTime: stopTime || null,\n          totalHours: totalHours,\n        });\n      }\n\n      // Audit log\n      await createAuditLog({\n        action: 'timesheet.create_from_roster',\n        entityType: 'timesheet',\n        entityId: timesheet.id,\n        details: { \n          rosterId, \n          crewId, \n          sessionId: timesheet.sessionId, \n          companyId: timesheet.companyId, \n          date: timesheet.date,\n          personnelCount: crewPersonnel.length,\n          equipmentCount: crewEquipment.length,\n        },\n        context: getAuditContext(req),\n      });\n      \n      res.json(timesheet);\n    } catch (error) {\n      console.error('Create timesheet from roster error:', error);\n      res.status(400).json({ message: \"Failed to create timesheet from roster\" });\n    }\n  });\n\n  // Create timesheet (manual)\n  app.post(\"/api/timesheets\", requireAuth, async (req, res) => {\n    try {\n      const timesheetData = insertTimesheetSchema.parse(req.body);\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheetData.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const timesheet = await storage.createTimesheet(timesheetData);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'timesheet.create',\n        entityType: 'timesheet',\n        entityId: timesheet.id,\n        details: { sessionId: timesheet.sessionId, companyId: timesheet.companyId, date: timesheet.date },\n        context: getAuditContext(req),\n      });\n      \n      res.json(timesheet);\n    } catch (error) {\n      console.error('Create timesheet error:', error);\n      res.status(400).json({ message: \"Invalid timesheet data\" });\n    }\n  });\n\n  // List timesheets (filtered by session or company)\n  app.get(\"/api/timesheets\", requireAuth, async (req, res) => {\n    try {\n      const { sessionId, companyId } = req.query;\n      const user = req.authenticatedUser!;\n      \n      // For UTILITY users, fetch accessible companies once (performance optimization)\n      let accessibleCompanyIds: Set<string> | null = null;\n      if (user.role === 'UTILITY') {\n        const companies = await storage.getUserAccessibleCompanies(user.id);\n        accessibleCompanyIds = new Set(companies.map(c => c.id));\n      }\n      \n      let timesheets;\n      if (sessionId) {\n        const allTimesheets = await storage.getTimesheetsBySession(sessionId as string);\n        \n        if (user.role === 'ADMIN' || user.role === 'MANAGER') {\n          timesheets = allTimesheets;\n        } else if (user.role === 'CONTRACTOR') {\n          if (!user.companyId) {\n            return res.status(403).json({ message: \"Company assignment required\" });\n          }\n          timesheets = allTimesheets.filter(t => t.companyId === user.companyId);\n        } else if (user.role === 'UTILITY') {\n          timesheets = allTimesheets.filter(t => accessibleCompanyIds!.has(t.companyId));\n        } else {\n          return res.status(403).json({ message: \"Access denied\" });\n        }\n      } else if (companyId) {\n        if (user.role === 'MANAGER') {\n          timesheets = await storage.getTimesheetsByCompany(companyId as string);\n        } else if (user.role === 'CONTRACTOR') {\n          if (user.companyId !== companyId) {\n            return res.status(403).json({ message: \"Cannot access timesheets for another company\" });\n          }\n          timesheets = await storage.getTimesheetsByCompany(companyId as string);\n        } else if (user.role === 'UTILITY') {\n          if (!accessibleCompanyIds!.has(companyId as string)) {\n            return res.status(403).json({ message: \"Cannot access timesheets for this company\" });\n          }\n          timesheets = await storage.getTimesheetsByCompany(companyId as string);\n        } else {\n          return res.status(403).json({ message: \"Access denied\" });\n        }\n      } else {\n        return res.status(400).json({ message: \"sessionId or companyId query parameter required\" });\n      }\n      \n      res.json(timesheets);\n    } catch (error) {\n      console.error('List timesheets error:', error);\n      res.status(500).json({ message: \"Failed to fetch timesheets\" });\n    }\n  });\n\n  // Get single timesheet\n  app.get(\"/api/timesheets/:id\", requireAuth, async (req, res) => {\n    try {\n      const timesheet = await storage.getTimesheet(req.params.id);\n      \n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      res.json(timesheet);\n    } catch (error) {\n      console.error('Get timesheet error:', error);\n      res.status(500).json({ message: \"Failed to fetch timesheet\" });\n    }\n  });\n\n  // Update timesheet\n  app.patch(\"/api/timesheets/:id\", requireAuth, async (req, res) => {\n    try {\n      const timesheet = await storage.getTimesheet(req.params.id);\n      \n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const updates = insertTimesheetSchema.partial().parse(req.body);\n      \n      // Prevent direct manipulation of workflow fields\n      const forbiddenFields = ['status', 'submittedBy', 'approvedBy', 'utilitySignedBy'];\n      const attemptedForbiddenFields = forbiddenFields.filter(field => updates.hasOwnProperty(field));\n      \n      if (attemptedForbiddenFields.length > 0) {\n        return res.status(400).json({ \n          message: `Cannot directly update workflow fields: ${attemptedForbiddenFields.join(', ')}. Use submit/approve endpoints instead.`\n        });\n      }\n      \n      const updated = await storage.updateTimesheet(req.params.id, updates);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'timesheet.update',\n        entityType: 'timesheet',\n        entityId: req.params.id,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update timesheet error:', error);\n      res.status(400).json({ message: \"Invalid timesheet data\" });\n    }\n  });\n\n  // Submit timesheet\n  app.post(\"/api/timesheets/:id/submit\", requireAuth, async (req, res) => {\n    try {\n      const timesheet = await storage.getTimesheet(req.params.id);\n      \n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      // Verify status transition (only DRAFT can be submitted)\n      if (timesheet.status !== 'DRAFT') {\n        return res.status(400).json({ \n          message: `Cannot submit timesheet with status ${timesheet.status}. Only DRAFT timesheets can be submitted.`\n        });\n      }\n      \n      const submitted = await storage.submitTimesheet(req.params.id, req.authenticatedUser!.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'timesheet.submit',\n        entityType: 'timesheet',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json(submitted);\n    } catch (error) {\n      console.error('Submit timesheet error:', error);\n      res.status(500).json({ message: \"Failed to submit timesheet\" });\n    }\n  });\n\n  // Approve timesheet (MANAGER or UTILITY only)\n  app.post(\"/api/timesheets/:id/approve\", requireAuth, requireManager, async (req, res) => {\n    try {\n      const timesheet = await storage.getTimesheet(req.params.id);\n      \n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify status transition (only SUBMITTED can be approved)\n      if (timesheet.status !== 'SUBMITTED') {\n        return res.status(400).json({ \n          message: `Cannot approve timesheet with status ${timesheet.status}. Only SUBMITTED timesheets can be approved.`\n        });\n      }\n      \n      const approved = await storage.approveTimesheet(req.params.id, req.authenticatedUser!.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'timesheet.approve',\n        entityType: 'timesheet',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json(approved);\n    } catch (error) {\n      console.error('Approve timesheet error:', error);\n      res.status(500).json({ message: \"Failed to approve timesheet\" });\n    }\n  });\n\n  // Delete timesheet\n  app.delete(\"/api/timesheets/:id\", requireAuth, requireAdminRole, async (req, res) => {\n    try {\n      const timesheet = await storage.getTimesheet(req.params.id);\n      \n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      await storage.deleteTimesheet(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'timesheet.delete',\n        entityType: 'timesheet',\n        entityId: req.params.id,\n        details: { \n          companyId: timesheet.companyId,\n          sessionId: timesheet.sessionId,\n          date: timesheet.date\n        },\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Timesheet deleted successfully\" });\n    } catch (error) {\n      console.error('Delete timesheet error:', error);\n      res.status(500).json({ message: \"Failed to delete timesheet\" });\n    }\n  });\n\n  // Add timesheet line\n  app.post(\"/api/timesheets/:timesheetId/lines\", requireAuth, async (req, res) => {\n    try {\n      const timesheet = await storage.getTimesheet(req.params.timesheetId);\n      \n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const lineData = insertTimesheetLineSchema.parse({ ...req.body, timesheetId: req.params.timesheetId });\n      const line = await storage.addTimesheetLine(lineData);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'timesheet_line.create',\n        entityType: 'timesheet_line',\n        entityId: line.id,\n        details: { timesheetId: timesheet.id, subjectType: line.subjectType },\n        context: getAuditContext(req),\n      });\n      \n      res.json(line);\n    } catch (error) {\n      console.error('Add timesheet line error:', error);\n      res.status(400).json({ message: \"Invalid timesheet line data\" });\n    }\n  });\n\n  // List timesheet lines\n  app.get(\"/api/timesheets/:timesheetId/lines\", requireAuth, async (req, res) => {\n    try {\n      const timesheet = await storage.getTimesheet(req.params.timesheetId);\n      \n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const lines = await storage.getTimesheetLines(req.params.timesheetId);\n      res.json(lines);\n    } catch (error) {\n      console.error('List timesheet lines error:', error);\n      res.status(500).json({ message: \"Failed to fetch timesheet lines\" });\n    }\n  });\n\n  // Update timesheet line\n  app.patch(\"/api/timesheet-lines/:id\", requireAuth, async (req, res) => {\n    try {\n      // Get the line to find the timesheetId\n      const linesList = await db.select().from(timesheetLines).where(eq(timesheetLines.id, req.params.id));\n      const line = linesList[0];\n      \n      if (!line) {\n        return res.status(404).json({ message: \"Timesheet line not found\" });\n      }\n      \n      // Fetch timesheet to verify company access\n      const timesheet = await storage.getTimesheet(line.timesheetId);\n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access\n      if (req.authenticatedUser?.role !== 'UTILITY' && req.authenticatedUser?.companyId !== timesheet.companyId) {\n        return res.status(403).json({ message: \"Cannot update line for timesheet from another company\" });\n      }\n      \n      const updates = insertTimesheetLineSchema.partial().parse(req.body);\n      const updated = await storage.updateTimesheetLine(req.params.id, updates);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'timesheet_line.update',\n        entityType: 'timesheet_line',\n        entityId: req.params.id,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update timesheet line error:', error);\n      res.status(400).json({ message: \"Invalid timesheet line data\" });\n    }\n  });\n\n  // Delete timesheet line\n  app.delete(\"/api/timesheet-lines/:id\", requireAuth, async (req, res) => {\n    try {\n      // Get the line to find the timesheetId\n      const linesList = await db.select().from(timesheetLines).where(eq(timesheetLines.id, req.params.id));\n      const line = linesList[0];\n      \n      if (!line) {\n        return res.status(404).json({ message: \"Timesheet line not found\" });\n      }\n      \n      // Fetch timesheet to verify company access\n      const timesheet = await storage.getTimesheet(line.timesheetId);\n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access\n      if (req.authenticatedUser?.role !== 'UTILITY' && req.authenticatedUser?.companyId !== timesheet.companyId) {\n        return res.status(403).json({ message: \"Cannot delete line from timesheet of another company\" });\n      }\n      \n      await storage.removeTimesheetLine(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'timesheet_line.delete',\n        entityType: 'timesheet_line',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Timesheet line deleted successfully\" });\n    } catch (error) {\n      console.error('Delete timesheet line error:', error);\n      res.status(500).json({ message: \"Failed to delete timesheet line\" });\n    }\n  });\n\n  // ============================================================================\n  // TIMESHEET PERSONNEL API\n  // ============================================================================\n\n  // Get timesheet personnel\n  app.get(\"/api/timesheets/:timesheetId/personnel\", requireAuth, async (req, res) => {\n    try {\n      const { timesheetId } = req.params;\n      \n      // Get the timesheet to check company access\n      const timesheet = await storage.getTimesheet(timesheetId);\n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const personnel = await storage.getTimesheetPersonnel(timesheetId);\n      res.json(personnel);\n    } catch (error) {\n      console.error('Get timesheet personnel error:', error);\n      res.status(500).json({ message: \"Failed to retrieve timesheet personnel\" });\n    }\n  });\n\n  // Add timesheet personnel\n  app.post(\"/api/timesheets/:timesheetId/personnel\", requireAuth, async (req, res) => {\n    try {\n      const { timesheetId } = req.params;\n      \n      // Get the timesheet to check company access\n      const timesheet = await storage.getTimesheet(timesheetId);\n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const personnelData = { ...req.body, timesheetId };\n      const personnel = await storage.addTimesheetPersonnel(personnelData);\n      \n      await createAuditLog({\n        action: 'timesheet_personnel.create',\n        entityType: 'timesheet_personnel',\n        entityId: personnel.id,\n        details: { timesheetId, employeeName: personnel.employeeName },\n        context: getAuditContext(req),\n      });\n      \n      res.json(personnel);\n    } catch (error) {\n      console.error('Add timesheet personnel error:', error);\n      res.status(400).json({ message: \"Invalid personnel data\" });\n    }\n  });\n\n  // Update timesheet personnel\n  app.patch(\"/api/timesheets/:timesheetId/personnel/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id, timesheetId } = req.params;\n      \n      // Get the timesheet to check company access\n      const timesheet = await storage.getTimesheet(timesheetId);\n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const updated = await storage.updateTimesheetPersonnel(id, req.body);\n      if (!updated) {\n        return res.status(404).json({ message: \"Personnel not found\" });\n      }\n      \n      await createAuditLog({\n        action: 'timesheet_personnel.update',\n        entityType: 'timesheet_personnel',\n        entityId: id,\n        details: { timesheetId },\n        context: getAuditContext(req),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update timesheet personnel error:', error);\n      res.status(400).json({ message: \"Failed to update personnel\" });\n    }\n  });\n\n  // Delete timesheet personnel\n  app.delete(\"/api/timesheets/:timesheetId/personnel/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id, timesheetId } = req.params;\n      \n      // Get the timesheet to check company access\n      const timesheet = await storage.getTimesheet(timesheetId);\n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      await storage.removeTimesheetPersonnel(id);\n      \n      await createAuditLog({\n        action: 'timesheet_personnel.delete',\n        entityType: 'timesheet_personnel',\n        entityId: id,\n        details: { timesheetId },\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Personnel deleted successfully\" });\n    } catch (error) {\n      console.error('Delete timesheet personnel error:', error);\n      res.status(500).json({ message: \"Failed to delete personnel\" });\n    }\n  });\n\n  // ============================================================================\n  // TIMESHEET EQUIPMENT API\n  // ============================================================================\n\n  // Get timesheet equipment\n  app.get(\"/api/timesheets/:timesheetId/equipment\", requireAuth, async (req, res) => {\n    try {\n      const { timesheetId } = req.params;\n      \n      // Get the timesheet to check company access\n      const timesheet = await storage.getTimesheet(timesheetId);\n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const equipment = await storage.getTimesheetEquipment(timesheetId);\n      res.json(equipment);\n    } catch (error) {\n      console.error('Get timesheet equipment error:', error);\n      res.status(500).json({ message: \"Failed to retrieve timesheet equipment\" });\n    }\n  });\n\n  // Add timesheet equipment\n  app.post(\"/api/timesheets/:timesheetId/equipment\", requireAuth, async (req, res) => {\n    try {\n      const { timesheetId } = req.params;\n      \n      // Get the timesheet to check company access\n      const timesheet = await storage.getTimesheet(timesheetId);\n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const equipmentData = { ...req.body, timesheetId };\n      const equipment = await storage.addTimesheetEquipment(equipmentData);\n      \n      await createAuditLog({\n        action: 'timesheet_equipment.create',\n        entityType: 'timesheet_equipment',\n        entityId: equipment.id,\n        details: { timesheetId, equipmentDescription: equipment.equipmentDescription },\n        context: getAuditContext(req),\n      });\n      \n      res.json(equipment);\n    } catch (error) {\n      console.error('Add timesheet equipment error:', error);\n      res.status(400).json({ message: \"Invalid equipment data\" });\n    }\n  });\n\n  // Update timesheet equipment\n  app.patch(\"/api/timesheets/:timesheetId/equipment/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id, timesheetId } = req.params;\n      \n      // Get the timesheet to check company access\n      const timesheet = await storage.getTimesheet(timesheetId);\n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const updated = await storage.updateTimesheetEquipment(id, req.body);\n      if (!updated) {\n        return res.status(404).json({ message: \"Equipment not found\" });\n      }\n      \n      await createAuditLog({\n        action: 'timesheet_equipment.update',\n        entityType: 'timesheet_equipment',\n        entityId: id,\n        details: { timesheetId },\n        context: getAuditContext(req),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update timesheet equipment error:', error);\n      res.status(400).json({ message: \"Failed to update equipment\" });\n    }\n  });\n\n  // Delete timesheet equipment\n  app.delete(\"/api/timesheets/:timesheetId/equipment/:id\", requireAuth, async (req, res) => {\n    try {\n      const { id, timesheetId } = req.params;\n      \n      // Get the timesheet to check company access\n      const timesheet = await storage.getTimesheet(timesheetId);\n      if (!timesheet) {\n        return res.status(404).json({ message: \"Timesheet not found\" });\n      }\n      \n      // Verify company access\n      const accessCheck = await ensureTimesheetCompanyAccess(req.authenticatedUser!, timesheet.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      await storage.removeTimesheetEquipment(id);\n      \n      await createAuditLog({\n        action: 'timesheet_equipment.delete',\n        entityType: 'timesheet_equipment',\n        entityId: id,\n        details: { timesheetId },\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Equipment deleted successfully\" });\n    } catch (error) {\n      console.error('Delete timesheet equipment error:', error);\n      res.status(500).json({ message: \"Failed to delete equipment\" });\n    }\n  });\n\n  // ============================================================================\n  // EXPENSES API\n  // ============================================================================\n\n  // Helper function to check expense company access based on RBAC rules\n  async function ensureExpenseCompanyAccess(\n    user: { id: string; role: string; companyId: string | null },\n    companyId: string\n  ): Promise<{ allowed: boolean; message?: string }> {\n    if (user.role === 'ADMIN') {\n      return { allowed: false, message: \"Access denied. This endpoint is not available for your role.\" };\n    }\n    if (user.role === 'MANAGER') {\n      return { allowed: true };\n    }\n    if (user.role === 'CONTRACTOR') {\n      if (!user.companyId) {\n        return { allowed: false, message: \"Company assignment required\" };\n      }\n      if (user.companyId !== companyId) {\n        return { allowed: false, message: \"Cannot access expense for another company\" };\n      }\n      return { allowed: true };\n    }\n    if (user.role === 'UTILITY') {\n      const hasAccess = await storage.hasUtilityCompanyAccess(user.id, companyId);\n      if (!hasAccess) {\n        return { allowed: false, message: \"Cannot access expense for this company\" };\n      }\n      return { allowed: true };\n    }\n    return { allowed: false, message: \"Access denied\" };\n  }\n\n  // Initialize Object Storage Service\n  const objectStorage = new ObjectStorageService();\n\n  // Create expense\n  app.post(\"/api/expenses\", requireAuth, async (req, res) => {\n    try {\n      const expenseData = insertExpenseSchema.parse(req.body);\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureExpenseCompanyAccess(req.authenticatedUser!, expenseData.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      // Set submittedBy to current user\n      const expense = await storage.createExpense({\n        ...expenseData,\n        submittedBy: req.authenticatedUser!.id,\n      });\n      \n      // Audit log\n      await createAuditLog({\n        action: 'expense.create',\n        entityType: 'expense',\n        entityId: expense.id,\n        details: { sessionId: expense.sessionId, companyId: expense.companyId, category: expense.category, amountCents: expense.amountCents },\n        context: getAuditContext(req),\n      });\n      \n      res.json(expense);\n    } catch (error) {\n      console.error('Create expense error:', error);\n      res.status(400).json({ message: \"Invalid expense data\" });\n    }\n  });\n\n  // List expenses (filtered by session or company)\n  app.get(\"/api/expenses\", requireAuth, async (req, res) => {\n    try {\n      const { sessionId, companyId } = req.query;\n      const user = req.authenticatedUser!;\n      \n      // ADMIN should not access this endpoint\n      if (user.role === 'ADMIN') {\n        return res.status(403).json({ \n          message: \"Access denied. This endpoint is not available for your role.\" \n        });\n      }\n      \n      // For UTILITY users, fetch accessible companies once\n      let accessibleCompanyIds: Set<string> | null = null;\n      if (user.role === 'UTILITY') {\n        const companies = await storage.getUserAccessibleCompanies(user.id);\n        accessibleCompanyIds = new Set(companies.map(c => c.id));\n      }\n      \n      let expenses;\n      if (sessionId) {\n        const allExpenses = await storage.getExpensesBySession(sessionId as string);\n        \n        if (user.role === 'MANAGER') {\n          expenses = allExpenses;\n        } else if (user.role === 'CONTRACTOR') {\n          if (!user.companyId) {\n            return res.status(403).json({ message: \"Company assignment required\" });\n          }\n          expenses = allExpenses.filter(e => e.companyId === user.companyId);\n        } else if (user.role === 'UTILITY') {\n          expenses = allExpenses.filter(e => accessibleCompanyIds!.has(e.companyId));\n        } else {\n          return res.status(403).json({ message: \"Access denied\" });\n        }\n      } else if (companyId) {\n        if (user.role === 'MANAGER') {\n          expenses = await storage.getExpensesByCompany(companyId as string);\n        } else if (user.role === 'CONTRACTOR') {\n          if (user.companyId !== companyId) {\n            return res.status(403).json({ message: \"Cannot access expenses for another company\" });\n          }\n          expenses = await storage.getExpensesByCompany(companyId as string);\n        } else if (user.role === 'UTILITY') {\n          if (!accessibleCompanyIds!.has(companyId as string)) {\n            return res.status(403).json({ message: \"Cannot access expenses for this company\" });\n          }\n          expenses = await storage.getExpensesByCompany(companyId as string);\n        } else {\n          return res.status(403).json({ message: \"Access denied\" });\n        }\n      } else {\n        return res.status(400).json({ message: \"sessionId or companyId query parameter required\" });\n      }\n      \n      res.json(expenses);\n    } catch (error) {\n      console.error('List expenses error:', error);\n      res.status(500).json({ message: \"Failed to fetch expenses\" });\n    }\n  });\n\n  // Get single expense\n  app.get(\"/api/expenses/:id\", requireAuth, async (req, res) => {\n    try {\n      const expense = await storage.getExpense(req.params.id);\n      \n      if (!expense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureExpenseCompanyAccess(req.authenticatedUser!, expense.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      res.json(expense);\n    } catch (error) {\n      console.error('Get expense error:', error);\n      res.status(500).json({ message: \"Failed to fetch expense\" });\n    }\n  });\n\n  // Update expense\n  app.patch(\"/api/expenses/:id\", requireAuth, async (req, res) => {\n    try {\n      const expense = await storage.getExpense(req.params.id);\n      \n      if (!expense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureExpenseCompanyAccess(req.authenticatedUser!, expense.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const updates = insertExpenseSchema.partial().parse(req.body);\n      \n      // Prevent direct manipulation of workflow fields\n      const forbiddenFields = ['status', 'submittedBy', 'approvedBy'];\n      const attemptedForbiddenFields = forbiddenFields.filter(field => updates.hasOwnProperty(field));\n      \n      if (attemptedForbiddenFields.length > 0) {\n        return res.status(400).json({ \n          message: `Cannot directly update workflow fields: ${attemptedForbiddenFields.join(', ')}. Use approve/reject endpoints instead.`\n        });\n      }\n      \n      const updated = await storage.updateExpense(req.params.id, updates);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'expense.update',\n        entityType: 'expense',\n        entityId: req.params.id,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update expense error:', error);\n      res.status(400).json({ message: \"Invalid expense data\" });\n    }\n  });\n\n  // Approve expense (MANAGER or UTILITY only)\n  app.post(\"/api/expenses/:id/approve\", requireAuth, requireManager, async (req, res) => {\n    try {\n      const expense = await storage.getExpense(req.params.id);\n      \n      if (!expense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      // Verify status transition (only SUBMITTED can be approved)\n      if (expense.status !== 'SUBMITTED') {\n        return res.status(400).json({ \n          message: `Cannot approve expense with status ${expense.status}. Only SUBMITTED expenses can be approved.`\n        });\n      }\n      \n      const approved = await storage.approveExpense(req.params.id, req.authenticatedUser!.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'expense.approve',\n        entityType: 'expense',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json(approved);\n    } catch (error) {\n      console.error('Approve expense error:', error);\n      res.status(500).json({ message: \"Failed to approve expense\" });\n    }\n  });\n\n  // Reject expense (MANAGER or UTILITY only)\n  app.post(\"/api/expenses/:id/reject\", requireAuth, requireManager, async (req, res) => {\n    try {\n      const expense = await storage.getExpense(req.params.id);\n      \n      if (!expense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      // Verify status transition (only SUBMITTED can be rejected)\n      if (expense.status !== 'SUBMITTED') {\n        return res.status(400).json({ \n          message: `Cannot reject expense with status ${expense.status}. Only SUBMITTED expenses can be rejected.`\n        });\n      }\n      \n      const rejected = await storage.rejectExpense(req.params.id, req.authenticatedUser!.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'expense.reject',\n        entityType: 'expense',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json(rejected);\n    } catch (error) {\n      console.error('Reject expense error:', error);\n      res.status(500).json({ message: \"Failed to reject expense\" });\n    }\n  });\n\n  // Delete expense\n  app.delete(\"/api/expenses/:id\", requireAuth, async (req, res) => {\n    try {\n      const expense = await storage.getExpense(req.params.id);\n      \n      if (!expense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureExpenseCompanyAccess(req.authenticatedUser!, expense.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      await storage.deleteExpense(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'expense.delete',\n        entityType: 'expense',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Expense deleted successfully\" });\n    } catch (error) {\n      console.error('Delete expense error:', error);\n      res.status(500).json({ message: \"Failed to delete expense\" });\n    }\n  });\n\n  // Upload expense receipt file\n  app.post(\"/api/expenses/:expenseId/files\", requireAuth, receiptUpload.single('file'), async (req, res) => {\n    try {\n      const expense = await storage.getExpense(req.params.expenseId);\n      \n      if (!expense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureExpenseCompanyAccess(req.authenticatedUser!, expense.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      if (!req.file) {\n        return res.status(400).json({ message: \"No file provided\" });\n      }\n      \n      // Generate unique file key\n      const fileId = randomUUID();\n      const ext = path.extname(req.file.originalname);\n      const privateDir = objectStorage.getPrivateObjectDir();\n      const fileKey = `${privateDir}/expenses/${req.params.expenseId}/${fileId}${ext}`;\n      \n      // Parse object path and upload to Object Storage\n      const { bucketName, objectName } = parseObjectPath(fileKey);\n      const bucket = objectStorageClient.bucket(bucketName);\n      const file = bucket.file(objectName);\n      \n      // Upload file buffer\n      await file.save(req.file.buffer, {\n        metadata: {\n          contentType: req.file.mimetype,\n        },\n      });\n      \n      // Save file metadata to database\n      const expenseFile = await storage.addExpenseFile({\n        expenseId: req.params.expenseId,\n        fileKey,\n        originalName: req.file.originalname,\n        mimeType: req.file.mimetype,\n        size: req.file.size,\n      });\n      \n      // Audit log\n      await createAuditLog({\n        action: 'expense_file.upload',\n        entityType: 'expense_file',\n        entityId: expenseFile.id,\n        details: { expenseId: expense.id, originalName: req.file.originalname, size: req.file.size },\n        context: getAuditContext(req),\n      });\n      \n      res.json(expenseFile);\n    } catch (error) {\n      console.error('Upload expense file error:', error);\n      res.status(500).json({ message: \"Failed to upload file\" });\n    }\n  });\n\n  // List expense files\n  app.get(\"/api/expenses/:expenseId/files\", requireAuth, async (req, res) => {\n    try {\n      const expense = await storage.getExpense(req.params.expenseId);\n      \n      if (!expense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureExpenseCompanyAccess(req.authenticatedUser!, expense.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const files = await storage.getExpenseFiles(req.params.expenseId);\n      res.json(files);\n    } catch (error) {\n      console.error('List expense files error:', error);\n      res.status(500).json({ message: \"Failed to fetch expense files\" });\n    }\n  });\n\n  // Delete expense file\n  app.delete(\"/api/expense-files/:id\", requireAuth, async (req, res) => {\n    try {\n      // Get the file to find the expenseId\n      const filesList = await db.select().from(expenseFiles).where(eq(expenseFiles.id, req.params.id));\n      const file = filesList[0];\n      \n      if (!file) {\n        return res.status(404).json({ message: \"Expense file not found\" });\n      }\n      \n      // Fetch expense to verify company access\n      const expense = await storage.getExpense(file.expenseId);\n      if (!expense) {\n        return res.status(404).json({ message: \"Expense not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureExpenseCompanyAccess(req.authenticatedUser!, expense.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      // Delete from Object Storage\n      try {\n        const { bucketName, objectName } = parseObjectPath(file.fileKey);\n        const bucket = objectStorageClient.bucket(bucketName);\n        const objectFile = bucket.file(objectName);\n        await objectFile.delete();\n      } catch (error) {\n        console.error('Error deleting file from object storage:', error);\n        // Continue with database deletion even if object storage deletion fails\n      }\n      \n      await storage.removeExpenseFile(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'expense_file.delete',\n        entityType: 'expense_file',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Expense file deleted successfully\" });\n    } catch (error) {\n      console.error('Delete expense file error:', error);\n      res.status(500).json({ message: \"Failed to delete expense file\" });\n    }\n  });\n\n  // ============================================================================\n  // INVOICES API\n  // ============================================================================\n\n  // Helper function to check invoice company access based on RBAC rules\n  async function ensureInvoiceCompanyAccess(\n    user: { id: string; role: string; companyId: string | null },\n    companyId: string\n  ): Promise<{ allowed: boolean; message?: string }> {\n    if (user.role === 'ADMIN') {\n      return { allowed: false, message: \"Access denied. This endpoint is not available for your role.\" };\n    }\n    if (user.role === 'MANAGER') {\n      return { allowed: true };\n    }\n    if (user.role === 'CONTRACTOR') {\n      if (!user.companyId) {\n        return { allowed: false, message: \"Company assignment required\" };\n      }\n      if (user.companyId !== companyId) {\n        return { allowed: false, message: \"Cannot access invoice for another company\" };\n      }\n      return { allowed: true };\n    }\n    if (user.role === 'UTILITY') {\n      const hasAccess = await storage.hasUtilityCompanyAccess(user.id, companyId);\n      if (!hasAccess) {\n        return { allowed: false, message: \"Cannot access invoice for this company\" };\n      }\n      return { allowed: true };\n    }\n    return { allowed: false, message: \"Access denied\" };\n  }\n\n  // Create invoice\n  app.post(\"/api/invoices\", requireAuth, requireManager, async (req, res) => {\n    try {\n      const invoiceData = insertInvoiceSchema.parse(req.body);\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureInvoiceCompanyAccess(req.authenticatedUser!, invoiceData.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const invoice = await storage.createInvoice(invoiceData);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'invoice.create',\n        entityType: 'invoice',\n        entityId: invoice.id,\n        details: { sessionId: invoice.sessionId, companyId: invoice.companyId, status: invoice.status },\n        context: getAuditContext(req),\n      });\n      \n      res.json(invoice);\n    } catch (error) {\n      console.error('Create invoice error:', error);\n      res.status(400).json({ message: \"Invalid invoice data\" });\n    }\n  });\n\n  // List invoices (filtered by session or company)\n  app.get(\"/api/invoices\", requireAuth, async (req, res) => {\n    try {\n      const { sessionId, companyId } = req.query;\n      const user = req.authenticatedUser!;\n      \n      // ADMIN should not access this endpoint\n      if (user.role === 'ADMIN') {\n        return res.status(403).json({ \n          message: \"Access denied. This endpoint is not available for your role.\" \n        });\n      }\n      \n      // For UTILITY users, fetch accessible companies once\n      let accessibleCompanyIds: Set<string> | null = null;\n      if (user.role === 'UTILITY') {\n        const companies = await storage.getUserAccessibleCompanies(user.id);\n        accessibleCompanyIds = new Set(companies.map(c => c.id));\n      }\n      \n      let invoices;\n      if (sessionId) {\n        const allInvoices = await storage.getInvoicesBySession(sessionId as string);\n        \n        if (user.role === 'MANAGER') {\n          invoices = allInvoices;\n        } else if (user.role === 'CONTRACTOR') {\n          if (!user.companyId) {\n            return res.status(403).json({ message: \"Company assignment required\" });\n          }\n          invoices = allInvoices.filter(i => i.companyId === user.companyId);\n        } else if (user.role === 'UTILITY') {\n          invoices = allInvoices.filter(i => accessibleCompanyIds!.has(i.companyId));\n        } else {\n          return res.status(403).json({ message: \"Access denied\" });\n        }\n      } else if (companyId) {\n        if (user.role === 'MANAGER') {\n          invoices = await storage.getInvoicesByCompany(companyId as string);\n        } else if (user.role === 'CONTRACTOR') {\n          if (user.companyId !== companyId) {\n            return res.status(403).json({ message: \"Cannot access invoices for another company\" });\n          }\n          invoices = await storage.getInvoicesByCompany(companyId as string);\n        } else if (user.role === 'UTILITY') {\n          if (!accessibleCompanyIds!.has(companyId as string)) {\n            return res.status(403).json({ message: \"Cannot access invoices for this company\" });\n          }\n          invoices = await storage.getInvoicesByCompany(companyId as string);\n        } else {\n          return res.status(403).json({ message: \"Access denied\" });\n        }\n      } else {\n        return res.status(400).json({ message: \"sessionId or companyId query parameter required\" });\n      }\n      \n      res.json(invoices);\n    } catch (error) {\n      console.error('List invoices error:', error);\n      res.status(500).json({ message: \"Failed to fetch invoices\" });\n    }\n  });\n\n  // Get single invoice\n  app.get(\"/api/invoices/:id\", requireAuth, async (req, res) => {\n    try {\n      const invoice = await storage.getInvoice(req.params.id);\n      \n      if (!invoice) {\n        return res.status(404).json({ message: \"Invoice not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureInvoiceCompanyAccess(req.authenticatedUser!, invoice.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      res.json(invoice);\n    } catch (error) {\n      console.error('Get invoice error:', error);\n      res.status(500).json({ message: \"Failed to fetch invoice\" });\n    }\n  });\n\n  // Update invoice\n  app.patch(\"/api/invoices/:id\", requireAuth, requireManager, async (req, res) => {\n    try {\n      const invoice = await storage.getInvoice(req.params.id);\n      \n      if (!invoice) {\n        return res.status(404).json({ message: \"Invoice not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureInvoiceCompanyAccess(req.authenticatedUser!, invoice.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const updates = insertInvoiceSchema.partial().parse(req.body);\n      \n      // Prevent direct manipulation of workflow and relational fields\n      const forbiddenFields = ['status', 'issuedAt', 'companyId', 'sessionId'];\n      const attemptedForbiddenFields = forbiddenFields.filter(field => updates.hasOwnProperty(field));\n      \n      if (attemptedForbiddenFields.length > 0) {\n        return res.status(400).json({ \n          message: `Cannot directly update protected fields: ${attemptedForbiddenFields.join(', ')}.`\n        });\n      }\n      \n      const updated = await storage.updateInvoice(req.params.id, updates);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'invoice.update',\n        entityType: 'invoice',\n        entityId: req.params.id,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update invoice error:', error);\n      res.status(400).json({ message: \"Invalid invoice data\" });\n    }\n  });\n\n  // Issue invoice (MANAGER or UTILITY only)\n  app.post(\"/api/invoices/:id/issue\", requireAuth, requireManager, async (req, res) => {\n    try {\n      const invoice = await storage.getInvoice(req.params.id);\n      \n      if (!invoice) {\n        return res.status(404).json({ message: \"Invoice not found\" });\n      }\n      \n      // Verify status transition (only DRAFT can be issued)\n      if (invoice.status !== 'DRAFT') {\n        return res.status(400).json({ \n          message: `Cannot issue invoice with status ${invoice.status}. Only DRAFT invoices can be issued.`\n        });\n      }\n      \n      const issued = await storage.issueInvoice(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'invoice.issue',\n        entityType: 'invoice',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json(issued);\n    } catch (error) {\n      console.error('Issue invoice error:', error);\n      res.status(500).json({ message: \"Failed to issue invoice\" });\n    }\n  });\n\n  // Mark invoice as paid (UTILITY only)\n  app.post(\"/api/invoices/:id/mark-paid\", requireAuth, requireUtility, async (req, res) => {\n    try {\n      const invoice = await storage.getInvoice(req.params.id);\n      \n      if (!invoice) {\n        return res.status(404).json({ message: \"Invoice not found\" });\n      }\n      \n      // Verify status transition (only ISSUED can be marked as paid)\n      if (invoice.status !== 'ISSUED') {\n        return res.status(400).json({ \n          message: `Cannot mark invoice as paid with status ${invoice.status}. Only ISSUED invoices can be marked as paid.`\n        });\n      }\n      \n      const paid = await storage.markInvoicePaid(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'invoice.mark_paid',\n        entityType: 'invoice',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json(paid);\n    } catch (error) {\n      console.error('Mark invoice paid error:', error);\n      res.status(500).json({ message: \"Failed to mark invoice as paid\" });\n    }\n  });\n\n  // Delete invoice\n  app.delete(\"/api/invoices/:id\", requireAuth, requireManager, async (req, res) => {\n    try {\n      const invoice = await storage.getInvoice(req.params.id);\n      \n      if (!invoice) {\n        return res.status(404).json({ message: \"Invoice not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureInvoiceCompanyAccess(req.authenticatedUser!, invoice.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      await storage.deleteInvoice(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'invoice.delete',\n        entityType: 'invoice',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Invoice deleted successfully\" });\n    } catch (error) {\n      console.error('Delete invoice error:', error);\n      res.status(500).json({ message: \"Failed to delete invoice\" });\n    }\n  });\n\n  // Add invoice line\n  app.post(\"/api/invoices/:invoiceId/lines\", requireAuth, requireManager, async (req, res) => {\n    try {\n      const invoice = await storage.getInvoice(req.params.invoiceId);\n      \n      if (!invoice) {\n        return res.status(404).json({ message: \"Invoice not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureInvoiceCompanyAccess(req.authenticatedUser!, invoice.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const lineData = insertInvoiceLineSchema.parse({ ...req.body, invoiceId: req.params.invoiceId });\n      const line = await storage.addInvoiceLine(lineData);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'invoice_line.create',\n        entityType: 'invoice_line',\n        entityId: line.id,\n        details: { invoiceId: invoice.id, source: line.source, amountCents: line.amountCents },\n        context: getAuditContext(req),\n      });\n      \n      res.json(line);\n    } catch (error) {\n      console.error('Add invoice line error:', error);\n      res.status(400).json({ message: \"Invalid invoice line data\" });\n    }\n  });\n\n  // List invoice lines\n  app.get(\"/api/invoices/:invoiceId/lines\", requireAuth, async (req, res) => {\n    try {\n      const invoice = await storage.getInvoice(req.params.invoiceId);\n      \n      if (!invoice) {\n        return res.status(404).json({ message: \"Invoice not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureInvoiceCompanyAccess(req.authenticatedUser!, invoice.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const lines = await storage.getInvoiceLines(req.params.invoiceId);\n      res.json(lines);\n    } catch (error) {\n      console.error('List invoice lines error:', error);\n      res.status(500).json({ message: \"Failed to fetch invoice lines\" });\n    }\n  });\n\n  // Update invoice line\n  app.patch(\"/api/invoice-lines/:id\", requireAuth, requireManager, async (req, res) => {\n    try {\n      // Get the line to find the invoiceId\n      const linesList = await db.select().from(invoiceLines).where(eq(invoiceLines.id, req.params.id));\n      const line = linesList[0];\n      \n      if (!line) {\n        return res.status(404).json({ message: \"Invoice line not found\" });\n      }\n      \n      // Fetch invoice to verify company access\n      const invoice = await storage.getInvoice(line.invoiceId);\n      if (!invoice) {\n        return res.status(404).json({ message: \"Invoice not found\" });\n      }\n      \n      // Verify company access using RBAC helper\n      const accessCheck = await ensureInvoiceCompanyAccess(req.authenticatedUser!, invoice.companyId);\n      if (!accessCheck.allowed) {\n        return res.status(403).json({ message: accessCheck.message });\n      }\n      \n      const updates = insertInvoiceLineSchema.partial().parse(req.body);\n      \n      // Prevent direct manipulation of relational fields\n      const forbiddenFields = ['invoiceId'];\n      const attemptedForbiddenFields = forbiddenFields.filter(field => updates.hasOwnProperty(field));\n      \n      if (attemptedForbiddenFields.length > 0) {\n        return res.status(400).json({ \n          message: `Cannot directly update protected fields: ${attemptedForbiddenFields.join(', ')}.`\n        });\n      }\n      \n      const updated = await storage.updateInvoiceLine(req.params.id, updates);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'invoice_line.update',\n        entityType: 'invoice_line',\n        entityId: req.params.id,\n        details: updates,\n        context: getAuditContext(req),\n      });\n      \n      res.json(updated);\n    } catch (error) {\n      console.error('Update invoice line error:', error);\n      res.status(400).json({ message: \"Invalid invoice line data\" });\n    }\n  });\n\n  // Delete invoice line\n  app.delete(\"/api/invoice-lines/:id\", requireAuth, requireManager, async (req, res) => {\n    try {\n      // Get the line to find the invoiceId\n      const linesList = await db.select().from(invoiceLines).where(eq(invoiceLines.id, req.params.id));\n      const line = linesList[0];\n      \n      if (!line) {\n        return res.status(404).json({ message: \"Invoice line not found\" });\n      }\n      \n      // Fetch invoice to verify company access\n      const invoice = await storage.getInvoice(line.invoiceId);\n      if (!invoice) {\n        return res.status(404).json({ message: \"Invoice not found\" });\n      }\n      \n      // Verify company access\n      if (req.authenticatedUser?.role === 'MANAGER' && req.authenticatedUser?.companyId !== invoice.companyId) {\n        return res.status(403).json({ message: \"Cannot delete line from invoice of another company\" });\n      }\n      \n      await storage.removeInvoiceLine(req.params.id);\n      \n      // Audit log\n      await createAuditLog({\n        action: 'invoice_line.delete',\n        entityType: 'invoice_line',\n        entityId: req.params.id,\n        context: getAuditContext(req),\n      });\n      \n      res.json({ message: \"Invoice line deleted successfully\" });\n    } catch (error) {\n      console.error('Delete invoice line error:', error);\n      res.status(500).json({ message: \"Failed to delete invoice line\" });\n    }\n  });\n\n  // Test database connection early\n  try {\n    console.log('Testing database connection...');\n    await db.select().from(users).limit(1);\n    console.log('Database connection successful');\n  } catch (error) {\n    console.error('Database connection failed:', error);\n    // Continue with server startup even if database fails\n    // This allows the app to start in a degraded state\n  }\n\n  // Lightweight ping endpoint to keep the app awake\n  app.get(\"/api/ping\", (req, res) => {\n    res.json({ status: \"ok\", timestamp: Date.now() });\n  });\n\n  // Upload file (KMZ, CSV, or Excel) and parse resources\n  app.post(\"/api/upload-file\", upload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n\n      const job = await storage.createAnalysisJob({\n        filename: req.file.originalname,\n        status: 'processing',\n        resourceCount: null,\n        error: null,\n      });\n\n      // Parse file in background\n      setImmediate(async () => {\n        try {\n          const ext = path.extname(req.file!.originalname).toLowerCase();\n          let resourceData;\n          let resources = [];\n\n          if (ext === '.kmz' || ext === '.kml') {\n            const placemarks = await parseKMZFile(req.file!.path);\n            resourceData = convertToResources(placemarks);\n\n            // Clear existing resources\n            await storage.deleteAllResources();\n\n            // Insert new resources\n            const resources = await Promise.all(\n              resourceData.map(data => storage.createResource(data))\n            );\n          } else if (ext === '.csv') {\n            const csvResources = await parseCSVFile(req.file!.path);\n\n            // Only clear contractor resources (preserve storage yards and other non-contractor resources)\n            const existingResources = await storage.getAllResources();\n            for (const resource of existingResources) {\n              if (resource.properties?.contractorId) {\n                await storage.deleteResource(resource.id);\n              }\n            }\n\n            // Save to contractors table and create corresponding resources\n            for (const csvResource of csvResources) {\n              const companyName = (csvResource as any).company || csvResource.name;\n              \n              // Try to find existing contractor by company name first, then by name\n              const existingContractor = await storage.findContractorByCompany(companyName) || \n                                       await storage.findContractorByName(csvResource.name);\n              \n              // Extract detailed information from parsed CSV (includes company, contact info, etc.)\n              const contractorData = {\n                name: csvResource.name,\n                company: companyName,\n                email: (csvResource as any).email || '',\n                phone: (csvResource as any).phone || '',\n                category: csvResource.type || 'Unknown',\n                city: (csvResource as any).city || '',\n                state: (csvResource as any).state || '',\n                fullAddress: csvResource.address || '',\n                latitude: csvResource.latitude,\n                longitude: csvResource.longitude,\n                birdRep: (csvResource as any).birdRep || '',\n                pipefile: (csvResource as any).pipefile || '',\n                avetta: (csvResource as any).avetta || '',\n                subRanking: (csvResource as any).subRanking || '',\n                fteCountsPerLocation: (csvResource as any).fteCounts || '',\n                pipefileUpdates: (csvResource as any).pipefileUpdates || '',\n                notes: csvResource.description || '',\n                newMsaComplete: (csvResource as any).msaStatus || (csvResource as any).newMsaComplete || '',\n                rating: parseFloat((csvResource as any).rating || '0')\n              };\n\n              let contractor;\n              if (existingContractor) {\n                // Update existing contractor\n                contractor = await storage.updateContractor(existingContractor.id, contractorData);\n              } else {\n                // Create new contractor\n                contractor = await storage.createContractor(contractorData);\n              }\n\n              // Also create a resource entry for map display\n              const resourceData = {\n                name: contractorData.company,\n                type: csvResource.type || 'Contractor',\n                latitude: csvResource.latitude,\n                longitude: csvResource.longitude,\n                description: csvResource.description,\n                properties: { \n                  address: csvResource.address,\n                  contractorId: contractor.id\n                }\n              };\n\n              const resource = await storage.createResource(resourceData);\n              resources.push(resource);\n            }\n          } else if (ext === '.xlsx' || ext === '.xls') {\n            const excelResources = await parseExcelFile(req.file!.path);\n            resourceData = convertCSVToResources(excelResources);\n\n            // Clear existing resources\n            await storage.deleteAllResources();\n\n            // Insert new resources\n            resources = await Promise.all(\n              resourceData.map(data => storage.createResource(data))\n            );\n          } else {\n            throw new Error('Unsupported file type');\n          }\n\n          const finalResourceCount = resources.length;\n\n          await storage.updateAnalysisJob(job.id, {\n            status: 'completed',\n            resourceCount: finalResourceCount,\n          });\n\n          // Clean up uploaded file\n          await fs.unlink(req.file!.path);\n        } catch (error) {\n          console.error('KMZ parsing error:', error);\n          await storage.updateAnalysisJob(job.id, {\n            status: 'failed',\n            error: error instanceof Error ? error.message : 'Unknown error',\n          });\n        }\n      });\n\n      res.json({ jobId: job.id, message: \"File uploaded successfully, processing...\" });\n    } catch (error) {\n      console.error('Upload error:', error);\n      res.status(500).json({ message: \"Failed to upload file\" });\n    }\n  });\n\n  // Get job status\n  app.get(\"/api/jobs/:id\", async (req, res) => {\n    try {\n      const jobId = parseInt(req.params.id);\n      const job = await storage.getAnalysisJob(jobId);\n\n      if (!job) {\n        return res.status(404).json({ message: \"Job not found\" });\n      }\n\n      res.json(job);\n    } catch (error) {\n      console.error('Job status error:', error);\n      res.status(500).json({ message: \"Failed to get job status\" });\n    }\n  });\n\n  // Get all resources - includes both contractors and storage yards\n  app.get(\"/api/resources\", async (req, res) => {\n    try {\n      const contractors = await storage.getAllContractors();\n      const storageYardResources = await storage.getAllResources();\n      \n      // Find contractors without coordinates that need geocoding\n      const needsGeocoding = contractors.filter(c => \n        (!c.latitude || !c.longitude || c.latitude === 0 || c.longitude === 0) && \n        (c.fullAddress || c.city)\n      );\n      \n      // Prioritize geocoding pending review contractors, then others\n      const needsReviewToGeocode = needsGeocoding.filter(c => c.needsReview);\n      const othersToGeocode = needsGeocoding.filter(c => !c.needsReview);\n      \n      // Geocode up to 20 contractors per request (prioritize pending review)\n      const batchSize = 20;\n      const toGeocode = [...needsReviewToGeocode.slice(0, batchSize), ...othersToGeocode.slice(0, Math.max(0, batchSize - needsReviewToGeocode.length))];\n      \n      if (toGeocode.length > 0) {\n        console.log(`Geocoding ${toGeocode.length} contractors (${needsReviewToGeocode.length} pending review, ${needsGeocoding.length} total without coordinates)...`);\n        \n        const mapboxToken = process.env.MAPBOX_ACCESS_TOKEN;\n        await Promise.all(\n          toGeocode.map(async (contractor) => {\n            const address = contractor.fullAddress || `${contractor.city || ''}, ${contractor.state || ''}`.trim();\n            try {\n              const encodedQuery = encodeURIComponent(address);\n              if (mapboxToken) {\n                const geocodeUrl = `https://api.mapbox.com/search/geocode/v6/forward?q=${encodedQuery}&country=us&limit=1&access_token=${mapboxToken}`;\n                const response = await fetch(geocodeUrl);\n                const data = await response.json();\n                \n                if (data.features && data.features.length > 0) {\n                  const [lng, lat] = data.features[0].geometry.coordinates;\n                  \n                  // Save geocoded coordinates back to database\n                  await storage.updateContractor(contractor.id, {\n                    latitude: lat,\n                    longitude: lng\n                  });\n                  \n                  // Update the contractor in the array for this response\n                  contractor.latitude = lat;\n                  contractor.longitude = lng;\n                  \n                  console.log(`✓ Geocoded ${contractor.company}: ${address}`);\n                }\n              }\n            } catch (geocodeError) {\n              console.error(`✗ Failed to geocode ${contractor.company}:`, geocodeError);\n            }\n          })\n        );\n      }\n      \n      // Sync contractors to resources table (ensure all contractors have a resource record)\n      // Create a map of contractorId -> resourceId for existing resources\n      const contractorResourceMap = new Map();\n      storageYardResources.forEach(resource => {\n        if (resource.properties?.contractorId) {\n          contractorResourceMap.set(resource.properties.contractorId, resource.id);\n        }\n      });\n      \n      // Create resources for contractors that don't have one\n      const contractorsWithCoords = contractors.filter(\n        contractor => contractor.latitude && contractor.longitude && \n                     contractor.latitude !== 0 && contractor.longitude !== 0\n      );\n      \n      for (const contractor of contractorsWithCoords) {\n        if (!contractorResourceMap.has(contractor.id)) {\n          // Create a resource for this contractor\n          const newResource = await storage.createResource({\n            name: contractor.company || contractor.name || 'Unknown Company',\n            type: contractor.category || 'Unknown',\n            latitude: contractor.latitude,\n            longitude: contractor.longitude,\n            description: contractor.notes || '',\n            properties: {\n              address: contractor.fullAddress || `${contractor.city || ''} ${contractor.state || ''}`.trim(),\n              contractorId: contractor.id,\n              needsReview: contractor.needsReview || false\n            }\n          });\n          contractorResourceMap.set(contractor.id, newResource.id);\n        } else {\n          // Update existing resource to sync ALL contractor fields\n          const resourceId = contractorResourceMap.get(contractor.id);\n          const existingResource = storageYardResources.find(r => r.id === resourceId);\n          if (existingResource) {\n            // Check if any fields have changed\n            const nameChanged = existingResource.name !== (contractor.company || contractor.name || 'Unknown Company');\n            const typeChanged = existingResource.type !== (contractor.category || 'Unknown');\n            const coordsChanged = existingResource.latitude !== contractor.latitude || existingResource.longitude !== contractor.longitude;\n            const descChanged = existingResource.description !== (contractor.notes || '');\n            const addressChanged = existingResource.properties?.address !== (contractor.fullAddress || `${contractor.city || ''} ${contractor.state || ''}`.trim());\n            const needsReviewChanged = existingResource.properties?.needsReview !== contractor.needsReview;\n            \n            if (nameChanged || typeChanged || coordsChanged || descChanged || addressChanged || needsReviewChanged) {\n              await storage.updateResource(resourceId, {\n                name: contractor.company || contractor.name || 'Unknown Company',\n                type: contractor.category || 'Unknown',\n                latitude: contractor.latitude,\n                longitude: contractor.longitude,\n                description: contractor.notes || '',\n                properties: {\n                  ...existingResource.properties,\n                  address: contractor.fullAddress || `${contractor.city || ''} ${contractor.state || ''}`.trim(),\n                  contractorId: contractor.id,\n                  needsReview: contractor.needsReview || false\n                }\n              });\n              \n              // If coordinates changed, log for potential distance recalculation\n              if (coordsChanged) {\n                console.log(`⚠ Coordinates changed for contractor ${contractor.company} (resource ${resourceId})`);\n              }\n            }\n          }\n        }\n      }\n      \n      // Clean up orphaned resources (resources linked to deleted contractors)\n      const contractorIds = new Set(contractors.map(c => c.id));\n      const orphanedResources = storageYardResources.filter(\n        resource => resource.properties?.contractorId && !contractorIds.has(resource.properties.contractorId)\n      );\n      \n      for (const orphan of orphanedResources) {\n        console.log(`🗑 Deleting orphaned resource ${orphan.id} (contractor ${orphan.properties.contractorId} no longer exists)`);\n        \n        // First, delete all distance calculations referencing this resource\n        await db.delete(distanceCalculations).where(eq(distanceCalculations.resourceId, orphan.id));\n        \n        // Then delete the resource\n        await storage.deleteResource(orphan.id);\n      }\n      \n      // Now get ALL resources (including newly created ones)\n      const allResources = await storage.getAllResources();\n      const contractorCount = allResources.filter(r => r.properties?.contractorId).length;\n      const storageYardCount = allResources.length - contractorCount;\n      \n      console.log(`Loaded ${allResources.length} resources (${contractorCount} contractors + ${storageYardCount} storage yards)`);\n      res.json(allResources);\n    } catch (error) {\n      console.error('Get resources error:', error);\n      res.status(500).json({ message: \"Failed to get resources\" });\n    }\n  });\n\n  // Contractors endpoints\n  app.get(\"/api/contractors\", async (req, res) => {\n    try {\n      const contractors = await storage.getAllContractors();\n      res.json(contractors);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Export all contractors\n  app.get(\"/api/contractors/export\", async (req, res) => {\n    try {\n      const contractors = await storage.getAllContractors();\n      const crewAvailability = await storage.getAllCrewAvailability();\n      \n      // Create a map of contractor ID to their crew availability records\n      const availabilityMap = new Map();\n      crewAvailability.forEach(crew => {\n        if (!availabilityMap.has(crew.contractorId)) {\n          availabilityMap.set(crew.contractorId, []);\n        }\n        availabilityMap.get(crew.contractorId).push(crew);\n      });\n      \n      // Prepare export data with all contractor information and ALL locations\n      const exportData = contractors.map((contractor) => {\n        const crewRecords = availabilityMap.get(contractor.id) || [];\n        \n        // Get departure locations from crew availability\n        const departureLocs = crewRecords\n          .filter(crew => crew.departureLatitude && crew.departureLongitude)\n          .map(crew => ({\n            location: crew.departureLocation || `${crew.departureCity || ''}, ${crew.departureState || ''}`.trim(),\n            latitude: crew.departureLatitude,\n            longitude: crew.departureLongitude\n          }));\n        \n        // Parse departureLocations JSONB if it exists\n        let additionalDepartureLocs: any[] = [];\n        if (contractor.departureLocations) {\n          try {\n            additionalDepartureLocs = Array.isArray(contractor.departureLocations) \n              ? contractor.departureLocations \n              : [];\n          } catch (e) {\n            additionalDepartureLocs = [];\n          }\n        }\n        \n        // Combine all departure locations (deduplicate by coordinates)\n        const allDepartureLocs = [...departureLocs, ...additionalDepartureLocs];\n        const uniqueDepartureLocs = allDepartureLocs.filter((loc, index, self) =>\n          loc.latitude && loc.longitude &&\n          index === self.findIndex(l => \n            Math.abs(l.latitude - loc.latitude) < 0.0001 && \n            Math.abs(l.longitude - loc.longitude) < 0.0001\n          )\n        );\n        \n        const row: any = {\n          'ID': contractor.id,\n          'Company': contractor.company || '',\n          'Contact Name': contractor.name || '',\n          'Email': contractor.email || '',\n          'Phone': contractor.phone || '',\n          'Category': contractor.category || '',\n          'City': contractor.city || '',\n          'State': contractor.state || '',\n          'Full Address': contractor.fullAddress || '',\n          \n          // Main Location (Mapbox compatible: separate lat/long columns)\n          'Main Latitude': contractor.latitude || '',\n          'Main Longitude': contractor.longitude || '',\n          'Mapbox Main Coords': contractor.latitude && contractor.longitude \n            ? `${contractor.longitude},${contractor.latitude}` \n            : '', // Mapbox format: longitude,latitude\n          \n          'Bird Rep': contractor.birdRep || '',\n          'Pipefile': contractor.pipefile || '',\n          'AVETTA': contractor.avetta || '',\n          'ISN Complete': contractor.isnComplete ? 'Yes' : 'No',\n          'Sub Ranking': contractor.subRanking || '',\n          'MSA Status': contractor.newMsaComplete || '',\n          'FTE Counts Per Location': contractor.fteCountsPerLocation || '',\n          'Pipefile Updates': contractor.pipefileUpdates || '',\n          'Notes': contractor.notes || '',\n          'Rating': contractor.rating || 0,\n          'Created At': contractor.createdAt ? new Date(contractor.createdAt).toLocaleDateString() : '',\n          'Updated At': contractor.updatedAt ? new Date(contractor.updatedAt).toLocaleDateString() : '',\n        };\n        \n        // Add departure locations (up to 5 departure locations to avoid excessive columns)\n        uniqueDepartureLocs.slice(0, 5).forEach((loc, index) => {\n          const num = index + 1;\n          row[`Departure ${num} Location`] = loc.location || '';\n          row[`Departure ${num} Latitude`] = loc.latitude || '';\n          row[`Departure ${num} Longitude`] = loc.longitude || '';\n          row[`Mapbox Departure ${num} Coords`] = loc.latitude && loc.longitude \n            ? `${loc.longitude},${loc.latitude}` \n            : '';\n        });\n        \n        // Add total departure location count\n        row['Total Departure Locations'] = uniqueDepartureLocs.length;\n        \n        return row;\n      });\n\n      // Get storage yards from resources table\n      const allResources = await storage.getAllResources();\n      const storageYards = allResources.filter(resource => \n        !resource.properties?.contractorId && resource.type === 'Storage Yard'\n      );\n\n      // Prepare storage yard export data\n      const storageYardData = storageYards.map((yard) => ({\n        'ID': yard.id,\n        'Name': yard.name || '',\n        'Type': yard.type || '',\n        'Description': yard.description || '',\n        'Latitude': yard.latitude || '',\n        'Longitude': yard.longitude || '',\n        'Mapbox Coords': yard.latitude && yard.longitude \n          ? `${yard.longitude},${yard.latitude}` \n          : '', // Mapbox format: longitude,latitude\n        'Created At': yard.createdAt ? new Date(yard.createdAt).toLocaleDateString() : '',\n      }));\n\n      // Import XLSX dynamically\n      const XLSX = await import('xlsx');\n      const workbook = XLSX.utils.book_new();\n      \n      // Add Contractors sheet\n      const contractorWorksheet = XLSX.utils.json_to_sheet(exportData);\n      const contractorHeaders = Object.keys(exportData[0] || {});\n      const contractorColWidths: any[] = [];\n      contractorHeaders.forEach((header, index) => {\n        const maxLength = Math.max(\n          header.length,\n          ...exportData.map((row: any) => String(row[header] || '').length)\n        );\n        contractorColWidths[index] = { width: Math.min(Math.max(maxLength + 2, 10), 30) };\n      });\n      contractorWorksheet['!cols'] = contractorColWidths;\n      XLSX.utils.book_append_sheet(workbook, contractorWorksheet, 'Contractors');\n\n      // Add Storage Yards sheet\n      if (storageYardData.length > 0) {\n        const storageYardWorksheet = XLSX.utils.json_to_sheet(storageYardData);\n        const storageYardHeaders = Object.keys(storageYardData[0] || {});\n        const storageYardColWidths: any[] = [];\n        storageYardHeaders.forEach((header, index) => {\n          const maxLength = Math.max(\n            header.length,\n            ...storageYardData.map((row: any) => String(row[header] || '').length)\n          );\n          storageYardColWidths[index] = { width: Math.min(Math.max(maxLength + 2, 10), 30) };\n        });\n        storageYardWorksheet['!cols'] = storageYardColWidths;\n        XLSX.utils.book_append_sheet(workbook, storageYardWorksheet, 'Storage Yards');\n      }\n\n      const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });\n\n      res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n      res.setHeader('Content-Disposition', `attachment; filename=\"contractors_export_${new Date().toISOString().slice(0, 10)}.xlsx\"`);\n      res.send(buffer);\n    } catch (error) {\n      console.error('Export contractors error:', error);\n      res.status(500).json({ message: \"Failed to export contractors\" });\n    }\n  });\n\n  // GeoJSON API endpoint for all contractor locations (main + departures)\n  app.get(\"/api/geojson/contractors\", async (req, res) => {\n    try {\n      const contractors = await storage.getAllContractors();\n      const crewAvailability = await storage.getAllCrewAvailability();\n      \n      // Create a GeoJSON FeatureCollection\n      const features: any[] = [];\n      \n      for (const contractor of contractors) {\n        // Get departure locations from crew availability\n        const contractorAvailability = crewAvailability.filter(\n          (avail) => avail.contractorId === contractor.id\n        );\n        \n        const departureLocs: Array<{ location: string; latitude: number; longitude: number }> = [];\n        \n        // Add departure locations from crew availability\n        contractorAvailability.forEach((avail) => {\n          if (avail.departureLocation && avail.departureLatitude && avail.departureLongitude) {\n            departureLocs.push({\n              location: avail.departureLocation,\n              latitude: avail.departureLatitude,\n              longitude: avail.departureLongitude,\n            });\n          }\n        });\n        \n        // Add departure locations from contractor's departureLocations field\n        if (contractor.departureLocations && Array.isArray(contractor.departureLocations)) {\n          contractor.departureLocations.forEach((loc: any) => {\n            if (loc.latitude && loc.longitude) {\n              departureLocs.push({\n                location: loc.location || '',\n                latitude: loc.latitude,\n                longitude: loc.longitude,\n              });\n            }\n          });\n        }\n        \n        // Deduplicate departure locations by coordinates (same logic as export)\n        const uniqueDepartureLocs = departureLocs.filter((loc, index, self) => {\n          // Filter out invalid coordinates\n          if (!loc.latitude || !loc.longitude) return false;\n          \n          // Find first occurrence with same coordinates (within tolerance)\n          return index === self.findIndex((l) =>\n            l.latitude && l.longitude &&\n            Math.abs(l.latitude - loc.latitude) < 0.0001 &&\n            Math.abs(l.longitude - loc.longitude) < 0.0001\n          );\n        });\n        \n        // Add main location as a feature\n        if (contractor.latitude && contractor.longitude) {\n          features.push({\n            type: \"Feature\",\n            geometry: {\n              type: \"Point\",\n              coordinates: [contractor.longitude, contractor.latitude] // GeoJSON uses [lng, lat]\n            },\n            properties: {\n              id: contractor.id,\n              locationType: \"main\",\n              name: contractor.name || '',\n              company: contractor.company || '',\n              email: contractor.email || '',\n              phone: contractor.phone || '',\n              fullAddress: contractor.fullAddress || '',\n              city: contractor.city || '',\n              state: contractor.state || '',\n              category: contractor.category || '',\n              birdRep: contractor.birdRep || '',\n              pipefile: contractor.pipefile || '',\n              avetta: contractor.avetta || '',\n              subRanking: contractor.subRanking || '',\n              notes: contractor.notes || '',\n              newMsaComplete: contractor.newMsaComplete || '',\n              isnComplete: contractor.isnComplete || false,\n              rating: contractor.rating || 0,\n              needsReview: contractor.needsReview || false,\n              totalDepartureLocations: uniqueDepartureLocs.length\n            }\n          });\n        }\n        \n        // Add each departure location as a separate feature\n        uniqueDepartureLocs.forEach((loc, index) => {\n          features.push({\n            type: \"Feature\",\n            geometry: {\n              type: \"Point\",\n              coordinates: [loc.longitude, loc.latitude] // GeoJSON uses [lng, lat]\n            },\n            properties: {\n              id: `${contractor.id}-dep-${index}`,\n              locationType: \"departure\",\n              departureNumber: index + 1,\n              departureLocation: loc.location,\n              contractorId: contractor.id,\n              company: contractor.company || '',\n              category: contractor.category || '',\n              birdRep: contractor.birdRep || '',\n              rating: contractor.rating || 0\n            }\n          });\n        });\n      }\n      \n      const geojson = {\n        type: \"FeatureCollection\",\n        features: features\n      };\n      \n      res.setHeader('Content-Type', 'application/json');\n      res.json(geojson);\n    } catch (error) {\n      console.error('GeoJSON contractors error:', error);\n      res.status(500).json({ message: \"Failed to generate GeoJSON for contractors\" });\n    }\n  });\n\n  // GeoJSON API endpoint for storage yards\n  app.get(\"/api/geojson/storage-yards\", async (req, res) => {\n    try {\n      const allResources = await storage.getAllResources();\n      const storageYards = allResources.filter(resource => \n        !resource.properties?.contractorId && resource.type === 'Storage Yard'\n      );\n      \n      const features = storageYards.map((yard) => ({\n        type: \"Feature\",\n        geometry: {\n          type: \"Point\",\n          coordinates: [yard.longitude, yard.latitude] // GeoJSON uses [lng, lat]\n        },\n        properties: {\n          id: yard.id,\n          locationType: \"storage-yard\",\n          name: yard.name || '',\n          type: yard.type || '',\n          description: yard.description || '',\n          createdAt: yard.createdAt ? new Date(yard.createdAt).toISOString() : ''\n        }\n      }));\n      \n      const geojson = {\n        type: \"FeatureCollection\",\n        features: features\n      };\n      \n      res.setHeader('Content-Type', 'application/json');\n      res.json(geojson);\n    } catch (error) {\n      console.error('GeoJSON storage yards error:', error);\n      res.status(500).json({ message: \"Failed to generate GeoJSON for storage yards\" });\n    }\n  });\n\n  // GeoJSON API endpoint for all locations (contractors + storage yards)\n  app.get(\"/api/geojson/all\", async (req, res) => {\n    try {\n      const contractors = await storage.getAllContractors();\n      const crewAvailability = await storage.getAllCrewAvailability();\n      const allResources = await storage.getAllResources();\n      const storageYards = allResources.filter(resource => \n        !resource.properties?.contractorId && resource.type === 'Storage Yard'\n      );\n      \n      const features: any[] = [];\n      \n      // Add contractor locations (main + departures)\n      for (const contractor of contractors) {\n        const contractorAvailability = crewAvailability.filter(\n          (avail) => avail.contractorId === contractor.id\n        );\n        \n        const departureLocs: Array<{ location: string; latitude: number; longitude: number }> = [];\n        \n        contractorAvailability.forEach((avail) => {\n          if (avail.departureLocation && avail.departureLatitude && avail.departureLongitude) {\n            departureLocs.push({\n              location: avail.departureLocation,\n              latitude: avail.departureLatitude,\n              longitude: avail.departureLongitude,\n            });\n          }\n        });\n        \n        if (contractor.departureLocations && Array.isArray(contractor.departureLocations)) {\n          contractor.departureLocations.forEach((loc: any) => {\n            if (loc.latitude && loc.longitude) {\n              departureLocs.push({\n                location: loc.location || '',\n                latitude: loc.latitude,\n                longitude: loc.longitude,\n              });\n            }\n          });\n        }\n        \n        const uniqueDepartureLocs = departureLocs.filter((loc, index, self) => {\n          // Filter out invalid coordinates\n          if (!loc.latitude || !loc.longitude) return false;\n          \n          // Find first occurrence with same coordinates (within tolerance)\n          return index === self.findIndex((l) =>\n            l.latitude && l.longitude &&\n            Math.abs(l.latitude - loc.latitude) < 0.0001 &&\n            Math.abs(l.longitude - loc.longitude) < 0.0001\n          );\n        });\n        \n        if (contractor.latitude && contractor.longitude) {\n          features.push({\n            type: \"Feature\",\n            geometry: {\n              type: \"Point\",\n              coordinates: [contractor.longitude, contractor.latitude]\n            },\n            properties: {\n              id: contractor.id,\n              locationType: \"main\",\n              name: contractor.name || '',\n              company: contractor.company || '',\n              email: contractor.email || '',\n              phone: contractor.phone || '',\n              fullAddress: contractor.fullAddress || '',\n              city: contractor.city || '',\n              state: contractor.state || '',\n              category: contractor.category || '',\n              birdRep: contractor.birdRep || '',\n              pipefile: contractor.pipefile || '',\n              avetta: contractor.avetta || '',\n              subRanking: contractor.subRanking || '',\n              notes: contractor.notes || '',\n              newMsaComplete: contractor.newMsaComplete || '',\n              isnComplete: contractor.isnComplete || false,\n              rating: contractor.rating || 0,\n              needsReview: contractor.needsReview || false,\n              totalDepartureLocations: uniqueDepartureLocs.length\n            }\n          });\n        }\n        \n        uniqueDepartureLocs.forEach((loc, index) => {\n          features.push({\n            type: \"Feature\",\n            geometry: {\n              type: \"Point\",\n              coordinates: [loc.longitude, loc.latitude]\n            },\n            properties: {\n              id: `${contractor.id}-dep-${index}`,\n              locationType: \"departure\",\n              departureNumber: index + 1,\n              departureLocation: loc.location,\n              contractorId: contractor.id,\n              company: contractor.company || '',\n              category: contractor.category || '',\n              birdRep: contractor.birdRep || '',\n              rating: contractor.rating || 0\n            }\n          });\n        });\n      }\n      \n      // Add storage yards\n      storageYards.forEach((yard) => {\n        features.push({\n          type: \"Feature\",\n          geometry: {\n            type: \"Point\",\n            coordinates: [yard.longitude, yard.latitude]\n          },\n          properties: {\n            id: yard.id,\n            locationType: \"storage-yard\",\n            name: yard.name || '',\n            type: yard.type || '',\n            description: yard.description || '',\n            createdAt: yard.createdAt ? new Date(yard.createdAt).toISOString() : ''\n          }\n        });\n      });\n      \n      const geojson = {\n        type: \"FeatureCollection\",\n        features: features\n      };\n      \n      res.setHeader('Content-Type', 'application/json');\n      res.json(geojson);\n    } catch (error) {\n      console.error('GeoJSON all locations error:', error);\n      res.status(500).json({ message: \"Failed to generate GeoJSON for all locations\" });\n    }\n  });\n\n  app.post(\"/api/contractors\", async (req, res) => {\n    try {\n      const contractorData = insertContractorSchema.parse(req.body);\n      const contractor = await storage.createContractor(contractorData);\n      res.status(201).json(contractor);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.get(\"/api/contractors/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const contractor = await storage.getContractor(id);\n      if (!contractor) {\n        return res.status(404).json({ error: \"Contractor not found\" });\n      }\n      res.json(contractor);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.put(\"/api/contractors/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updates = insertContractorSchema.partial().parse(req.body);\n      const contractor = await storage.updateContractor(id, updates);\n      if (!contractor) {\n        return res.status(404).json({ error: \"Contractor not found\" });\n      }\n      res.json(contractor);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.put(\"/api/contractors/:id/departure-locations\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const { locations } = req.body;\n      \n      console.log(`Updating departure locations for contractor ${id}:`, locations);\n      \n      if (!Array.isArray(locations)) {\n        return res.status(400).json({ error: \"locations must be an array\" });\n      }\n      \n      await storage.setContractorDepartureLocations(id, locations);\n      \n      // Get the contractor to create resources\n      const contractor = await storage.getContractor(id);\n      \n      if (contractor) {\n        console.log(`Found contractor: ${contractor.company}`);\n        \n        // Delete existing storage yard resources for this contractor\n        const allResources = await storage.getAllResources();\n        const existingStorageYards = allResources.filter(r => \n          r.type === 'Storage Yard' && r.description?.includes(`Contractor ID: ${id}`)\n        );\n        \n        console.log(`Deleting ${existingStorageYards.length} existing storage yards for contractor ${id}`);\n        \n        for (const resource of existingStorageYards) {\n          try {\n            await storage.deleteResource(resource.id);\n            console.log(`Deleted storage yard resource ${resource.id}`);\n          } catch (e) {\n            console.error(`Failed to delete storage yard resource ${resource.id}:`, e);\n          }\n        }\n        \n        // Create new resources for each storage yard\n        console.log(`Creating ${locations.length} new storage yard resources`);\n        let createdCount = 0;\n        \n        for (const location of locations) {\n          if (location.latitude && location.longitude) {\n            try {\n              const newResource = await storage.createResource({\n                name: contractor.company,\n                type: 'Storage Yard',\n                latitude: location.latitude,\n                longitude: location.longitude,\n                description: `${location.location}\\nContact: ${contractor.name}\\nContractor ID: ${id}`,\n                properties: {\n                  contractorId: id,\n                  company: contractor.company,\n                  contactName: contractor.name,\n                  address: location.location\n                }\n              });\n              console.log(`Created storage yard resource ${newResource.id} for ${contractor.company} at ${location.location}`);\n              createdCount++;\n            } catch (e) {\n              console.error(`Failed to create storage yard resource for location ${location.location}:`, e);\n            }\n          } else {\n            console.warn(`Skipping location without coordinates:`, location);\n          }\n        }\n        \n        console.log(`Successfully created ${createdCount} storage yard resources for contractor ${id}`);\n      } else {\n        console.error(`Contractor ${id} not found`);\n      }\n      \n      res.json(contractor);\n    } catch (error: any) {\n      console.error('Error updating departure locations:', error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.delete(\"/api/contractors/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.deleteContractor(id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Merge contractors - combine sourceId into targetId\n  app.post(\"/api/contractors/merge\", async (req, res) => {\n    try {\n      const { sourceId, targetId, mergedData } = req.body;\n      \n      if (!sourceId || !targetId) {\n        return res.status(400).json({ error: \"Both sourceId and targetId are required\" });\n      }\n      \n      if (sourceId === targetId) {\n        return res.status(400).json({ error: \"Cannot merge a contractor with itself\" });\n      }\n\n      // Get both contractors\n      const source = await storage.getContractor(sourceId);\n      const target = await storage.getContractor(targetId);\n\n      if (!source || !target) {\n        return res.status(404).json({ error: \"One or both contractors not found\" });\n      }\n\n      // Build update data from merged data if provided, otherwise merge automatically\n      const updateData: any = {};\n      \n      if (mergedData) {\n        // Use the manually reviewed and merged data from frontend\n        if (mergedData.name) {\n          updateData.name = mergedData.name;\n        }\n        if (mergedData.email) {\n          updateData.email = mergedData.email;\n        }\n        if (mergedData.phone) {\n          updateData.phone = mergedData.phone;\n        }\n      } else {\n        // Legacy automatic merge logic (for backward compatibility)\n        // Merge emails (support both semicolon and comma separators)\n        if (source.email && source.email.trim() !== '') {\n          const currentEmails = target.email || '';\n          const sourceEmails = source.email.split(/[;,]/).map(e => e.trim().toLowerCase());\n          const targetEmails = currentEmails.split(/[;,]/).map(e => e.trim().toLowerCase());\n          const newEmails = sourceEmails.filter(e => e && !targetEmails.includes(e));\n          if (newEmails.length > 0) {\n            const mergedEmails = [...currentEmails.split(/[;,]/).map(e => e.trim()).filter(e => e), ...source.email.split(/[;,]/).map(e => e.trim()).filter(e => e)];\n            updateData.email = mergedEmails.join('; ');\n          }\n        }\n        \n        // Merge phones (support both semicolon and comma separators)\n        if (source.phone && source.phone.trim() !== '') {\n          const currentPhones = target.phone || '';\n          const sourcePhones = source.phone.split(/[;,]/).map(p => p.trim());\n          const targetPhones = currentPhones.split(/[;,]/).map(p => p.trim());\n          const newPhones = sourcePhones.filter(p => p && !targetPhones.includes(p));\n          if (newPhones.length > 0) {\n            const mergedPhones = [...currentPhones.split(/[;,]/).map(p => p.trim()).filter(p => p), ...source.phone.split(/[;,]/).map(p => p.trim()).filter(p => p)];\n            updateData.phone = mergedPhones.join('; ');\n          }\n        }\n      }\n      \n      // Update other fields if target doesn't have them\n      if (source.city && (!target.city || target.city.trim() === '')) {\n        updateData.city = source.city;\n      }\n      if (source.state && (!target.state || target.state.trim() === '')) {\n        updateData.state = source.state;\n      }\n      if (source.fullAddress && (!target.fullAddress || target.fullAddress.trim() === '')) {\n        updateData.fullAddress = source.fullAddress;\n      }\n      if (source.latitude && (!target.latitude || target.latitude === 0)) {\n        updateData.latitude = source.latitude;\n      }\n      if (source.longitude && (!target.longitude || target.longitude === 0)) {\n        updateData.longitude = source.longitude;\n      }\n      if (source.birdRep && (!target.birdRep || target.birdRep === 'TBD')) {\n        updateData.birdRep = source.birdRep;\n      }\n      if (source.pipefile && (!target.pipefile || target.pipefile.trim() === '')) {\n        updateData.pipefile = source.pipefile;\n      }\n      if (source.avetta && (!target.avetta || target.avetta.trim() === '')) {\n        updateData.avetta = source.avetta;\n      }\n      if (source.subRanking && (!target.subRanking || target.subRanking.trim() === '')) {\n        updateData.subRanking = source.subRanking;\n      }\n      \n      // Append notes\n      if (source.notes && source.notes.trim() !== '') {\n        const currentNotes = target.notes || '';\n        if (!currentNotes.includes(source.notes)) {\n          updateData.notes = currentNotes ? `${currentNotes}\\n\\n[Merged from ID ${sourceId}]: ${source.notes}` : source.notes;\n        }\n      }\n      \n      // Clear needsReview flag when merging (contractor has been reviewed and merged)\n      if (source.needsReview || target.needsReview) {\n        updateData.needsReview = false;\n      }\n\n      // Update target contractor with merged data\n      if (Object.keys(updateData).length > 0) {\n        await storage.updateContractor(targetId, updateData);\n      }\n\n      // Update all foreign key references in related tables\n      await storage.mergeContractorReferences(sourceId, targetId);\n\n      // Collect and update departure locations from all crew availability submissions\n      await storage.updateContractorDepartureLocations(targetId);\n\n      // Delete the source contractor\n      await storage.deleteContractor(sourceId);\n\n      res.json({ success: true, message: `Successfully merged contractor ${sourceId} into ${targetId}` });\n    } catch (error: any) {\n      console.error('Merge contractors error:', error);\n      res.status(500).json({ error: error.message || \"Failed to merge contractors\" });\n    }\n  });\n\n  // Contractor file endpoints\n  app.post(\"/api/contractors/:id/files\", upload.single('file'), async (req, res) => {\n    try {\n      const contractorId = parseInt(req.params.id);\n\n      if (!req.file) {\n        return res.status(400).json({ error: \"No file uploaded\" });\n      }\n\n      // Check if contractor exists\n      const contractor = await storage.getContractor(contractorId);\n      if (!contractor) {\n        return res.status(404).json({ error: \"Contractor not found\" });\n      }\n\n      const fileData = {\n        contractorId,\n        filename: req.file.filename,\n        originalName: req.file.originalname,\n        filePath: req.file.path,\n        fileSize: req.file.size,\n        mimeType: req.file.mimetype,\n      };\n\n      const contractorFile = await storage.createContractorFile(fileData);\n      res.status(201).json(contractorFile);\n    } catch (error: any) {\n      console.error('File upload error:', error);\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.get(\"/api/contractors/:id/files\", async (req, res) => {\n    try {\n      const contractorId = parseInt(req.params.id);\n      const files = await storage.getContractorFiles(contractorId);\n      res.json(files);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.delete(\"/api/contractor-files/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.deleteContractorFile(id);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.get(\"/api/contractor-files/:id/download\", async (req, res) => {\n    try {\n      const fileId = parseInt(req.params.id);\n      const [file] = await db.select().from(contractorFiles).where(eq(contractorFiles.id, fileId));\n\n      if (!file) {\n        return res.status(404).json({ error: \"File not found\" });\n      }\n\n      res.download(file.filePath, file.originalName);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Contractor review endpoints\n  app.post(\"/api/contractor-reviews\", async (req, res) => {\n    try {\n      const reviewData = insertContractorReviewSchema.parse(req.body);\n      const review = await storage.createContractorReview(reviewData);\n      res.status(201).json(review);\n    } catch (error: any) {\n      res.status(400).json({ error: error.message });\n    }\n  });\n\n  app.get(\"/api/contractor-reviews/:contractorId\", async (req, res) => {\n    try {\n      const contractorId = parseInt(req.params.contractorId);\n      const reviews = await storage.getContractorReviews(contractorId);\n      res.json(reviews);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Delete a contractor review\n  app.delete(\"/api/contractor-reviews/:reviewId\", async (req, res) => {\n    try {\n      const reviewId = parseInt(req.params.reviewId);\n      await storage.deleteContractorReview(reviewId);\n      res.status(204).send();\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  app.get(\"/api/contractor-reviews\", async (req, res) => {\n    try {\n      const reviews = await storage.getAllContractorReviews();\n      res.json(reviews);\n    } catch (error: any) {\n      res.status(500).json({ error: error.message });\n    }\n  });\n\n  // Create analysis point\n  app.post(\"/api/analysis-points\", async (req, res) => {\n    try {\n      const sessionId = getSessionId(req);\n      const validatedData = insertAnalysisPointSchema.parse({\n        ...req.body,\n        sessionId\n      });\n      const point = await storage.createAnalysisPoint(validatedData);\n      res.json(point);\n    } catch (error) {\n      console.error('Create analysis point error:', error);\n      res.status(400).json({ message: \"Invalid analysis point data\" });\n    }\n  });\n\n  // Get all analysis points\n  app.get(\"/api/analysis-points\", async (req, res) => {\n    try {\n      const sessionId = getSessionId(req);\n      const points = await storage.getAllAnalysisPoints(sessionId);\n      res.json(points);\n    } catch (error) {\n      console.error('Get analysis points error:', error);\n      res.status(500).json({ message: \"Failed to get analysis points\" });\n    }\n  });\n\n  // Delete analysis point\n  app.delete(\"/api/analysis-points/:id\", async (req, res) => {\n    try {\n      const pointId = parseInt(req.params.id);\n      const sessionId = getSessionId(req);\n      await storage.deleteAnalysisPoint(pointId, sessionId);\n      res.json({ message: \"Analysis point deleted\" });\n    } catch (error) {\n      console.error('Delete analysis point error:', error);\n      res.status(500).json({ message: \"Failed to delete analysis point\" });\n    }\n  });\n\n  // Calculate distances for a point\n  app.post(\"/api/calculate-distances/:pointId\", async (req, res) => {\n    try {\n      const pointId = parseInt(req.params.pointId);\n      const sessionId = getSessionId(req);\n      const { maxDistance } = req.body; // Optional max distance in miles\n      const points = await storage.getAllAnalysisPoints(sessionId);\n      \n      // Get ALL contractors and existing resources\n      const contractors = await storage.getAllContractors();\n      const existingResources = await storage.getAllResources();\n      \n      // Create a map of contractorId -> resourceId for existing resources\n      const contractorResourceMap = new Map();\n      existingResources.forEach(resource => {\n        if (resource.properties?.contractorId) {\n          contractorResourceMap.set(resource.properties.contractorId, resource.id);\n        }\n      });\n      \n      // Sync contractors to resources table (create resources for contractors that don't have one)\n      const contractorsWithCoords = contractors.filter(\n        contractor => contractor.latitude && contractor.longitude && \n                     contractor.latitude !== 0 && contractor.longitude !== 0\n      );\n      \n      for (const contractor of contractorsWithCoords) {\n        if (!contractorResourceMap.has(contractor.id)) {\n          // Create a resource for this contractor\n          const newResource = await storage.createResource({\n            name: contractor.name || contractor.company,\n            type: contractor.category || 'Unknown',\n            latitude: contractor.latitude,\n            longitude: contractor.longitude,\n            description: contractor.notes || '',\n            properties: {\n              address: contractor.fullAddress || `${contractor.city || ''} ${contractor.state || ''}`.trim(),\n              contractorId: contractor.id,\n              needsReview: contractor.needsReview || false\n            }\n          });\n          contractorResourceMap.set(contractor.id, newResource.id);\n        }\n      }\n      \n      // Now get ALL resources (including newly created ones)\n      const resources = await storage.getAllResources();\n\n      const point = points.find(p => p.id === pointId);\n      if (!point) {\n        return res.status(404).json({ message: \"Analysis point not found\" });\n      }\n\n      if (resources.length === 0) {\n        return res.status(400).json({ message: \"No resources available for calculation\" });\n      }\n\n      const contractorResources = resources.filter(r => r.properties?.contractorId);\n      const storageYardResources = resources.filter(r => !r.properties?.contractorId);\n      console.log(`Calculating distances for ${resources.length} resources (${contractorResources.length} contractors + ${storageYardResources.length} storage yards) from point: ${point.label}`);\n\n      // Clear existing calculations for this point to avoid duplicates\n      await storage.clearCalculationsForPoint(pointId, sessionId);\n\n      // Calculate routes to all resources\n      const routes = await routingService.calculateBatchRoutes(point, resources);\n\n      // Convert all routes to calculations and store them (no filtering at storage level)\n      const calculationData = routes.map((route, index) => {\n        const distanceInMiles = route.distance / 1609.34; // Convert meters to miles\n        return {\n          route,\n          resource: resources[index],\n          distanceInMiles,\n          calculationData: {\n            analysisPointId: pointId,\n            resourceId: resources[index].id,\n            distance: distanceInMiles,\n            duration: route.duration,\n            route: route.geometry,\n            sessionId: sessionId,\n          }\n        };\n      });\n\n      // Count resources within range for logging (but store all calculations)\n      const withinRangeCount = maxDistance \n        ? calculationData.filter(item => item.distanceInMiles <= maxDistance).length\n        : calculationData.length;\n\n      console.log(`${withinRangeCount} resources within range`);\n\n      // Store all calculations (let filtering happen when retrieving data)\n      const calculations = await Promise.all(\n        calculationData.map(item => \n          storage.createDistanceCalculation(item.calculationData)\n        )\n      );\n\n      res.json({ message: \"Distances calculated successfully\", count: calculations.length });\n    } catch (error) {\n      console.error('Calculate distances error:', error);\n      res.status(500).json({ message: \"Failed to calculate distances\" });\n    }\n  });\n\n  // Get calculations with resources for a point\n  app.get(\"/api/analysis-points/:pointId/calculations\", async (req, res) => {\n    try {\n      const pointId = parseInt(req.params.pointId);\n      const sessionId = getSessionId(req);\n      const { sort = 'distance' } = req.query;\n\n      const calculations = await storage.getCalculationsWithResources(pointId, sessionId);\n\n      console.log(`Found ${calculations.length} calculations for point ${pointId}`);\n      if (calculations.length > 0) {\n        console.log('Sample calculation:', JSON.stringify(calculations[0], null, 2));\n      }\n\n      // Sort results\n      calculations.sort((a: any, b: any) => {\n        switch (sort) {\n          case 'time':\n          case 'duration':\n            return a.duration - b.duration;\n          case 'name':\n            return a.resource.name.localeCompare(b.resource.name);\n          case 'distance':\n          default:\n            return a.distance - b.distance;\n        }\n      });\n\n      res.json(calculations);\n    } catch (error) {\n      console.error('Get calculations error:', error);\n      res.status(500).json({ message: \"Failed to get calculations\" });\n    }\n  });\n\n  // Export results\n  app.post(\"/api/export\", async (req, res) => {\n    try {\n      const { format = 'json', pointId, options = {} } = req.body;\n\n      if (!pointId) {\n        return res.status(400).json({ message: \"Point ID required for export\" });\n      }\n\n      const sessionId = getSessionId(req);\n      const calculations = await storage.getCalculationsWithResources(pointId, sessionId);\n      const selectedPoint = await storage.getAllAnalysisPoints(sessionId);\n      const point = selectedPoint.find(p => p.id === pointId);\n\n      switch (format) {\n        case 'csv':\n          const csvData = generateCSV(calculations, options);\n          res.setHeader('Content-Type', 'text/csv');\n          res.setHeader('Content-Disposition', `attachment; filename=\"distance_analysis_${point?.label.replace(/\\s+/g, '_') || 'export'}.csv\"`);\n          return res.send(csvData);\n\n        case 'excel':\n          // Get contractor data to enrich export\n          const allContractors = await storage.getAllContractors();\n          const contractorMap = new Map(allContractors.map(c => [c.id, c]));\n          \n          const excelData = calculations.map((calc: any) => {\n            // Find contractor associated with this resource\n            const contractorId = calc.resource.properties?.contractorId;\n            const contractor = contractorMap.get(contractorId);\n            \n            const row: any = {\n              'Resource Name': calc.resource.name,\n              'Resource Type': calc.resource.type,\n            };\n\n            if (options.includeDistances !== false) {\n              row['Distance (miles)'] = parseFloat(calc.distance.toFixed(2)); // Keep as number for sorting\n            }\n\n            if (options.includeTimes !== false) {\n              row['Travel Time (hours)'] = parseFloat((calc.duration / 3600).toFixed(2)); // Hours as number\n              row['Travel Time (formatted)'] = formatDuration(calc.duration); // Formatted string\n            }\n\n            row['Latitude'] = parseFloat(calc.resource.latitude.toFixed(6));\n            row['Longitude'] = parseFloat(calc.resource.longitude.toFixed(6));\n            row['Description'] = calc.resource.description || '';\n            \n            // Add contractor information if available\n            if (contractor) {\n              row['Company'] = contractor.company || '';\n              row['Contact Name'] = contractor.name || '';\n              row['Email'] = contractor.email || '';\n              row['Phone'] = contractor.phone || '';\n              row['City'] = contractor.city || '';\n              row['State'] = contractor.state || '';\n              row['Category'] = contractor.category || '';\n              row['Rating'] = contractor.rating || 0;\n              row['BIRD REP'] = contractor.birdRep || '';\n              row['Pipefile'] = contractor.pipefile || '';\n              row['AVETTA'] = contractor.avetta || '';\n              row['ISN Complete'] = contractor.isnComplete ? 'Yes' : 'No';\n            }\n\n            return row;\n          });\n\n          const buffer = exportToExcel(excelData, 'distance_analysis');\n\n          res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n          res.setHeader('Content-Disposition', `attachment; filename=\"distance_analysis_${point?.label.replace(/\\s+/g, '_') || 'export'}.xlsx\"`);\n          return res.send(buffer);\n\n        case 'json':\n        default:\n          const jsonData: any = {\n            exportedAt: new Date().toISOString(),\n            pointId,\n            calculations: calculations.map((calc: any) => {\n              const item: any = {\n                resource: calc.resource,\n              };\n\n              if (options.includeDistances !== false) {\n                item.distance = calc.distance;\n              }\n\n              if (options.includeTimes !== false) {\n                item.duration = calc.duration;\n                item.travelTime = formatDuration(calc.duration);\n              }\n\n              return item;\n            }),\n          };\n\n          res.json(jsonData);\n      }\n    } catch (error) {\n      console.error('Export error:', error);\n      res.status(500).json({ message: \"Failed to export data\" });\n    }\n  });\n\n  // Export calculations for results table\n  app.get(\"/api/analysis-points/:pointId/calculations/export\", async (req, res) => {\n    try {\n      const pointId = parseInt(req.params.pointId);\n      const sessionId = await getEffectiveSessionId(req, pointId);\n      const format = req.query.format as string || 'csv';\n\n      console.log(`Export request - pointId: ${pointId}, sessionId: ${sessionId}, format: ${format}`);\n      const groupByBirdRep = req.query.groupByBirdRep === 'true'; // New option for Bird Rep grouping\n      const maxDistance = req.query.maxDistance ? parseFloat(req.query.maxDistance as string) : null;\n      const maxTime = req.query.maxTime ? parseFloat(req.query.maxTime as string) * 60 : null; // Convert minutes to seconds\n\n      let calculations = await storage.getCalculationsWithResources(pointId, sessionId);\n\n      // If no calculations found with sessionId, try without sessionId for backward compatibility\n      if (calculations.length === 0) {\n        console.log(`No calculations found for sessionId ${sessionId}, trying without sessionId`);\n        calculations = await storage.getCalculationsWithResources(pointId);\n      }\n\n      // Apply distance filter (same logic as Results Table)\n      if (maxDistance) {\n        calculations = calculations.filter((calc: any) => calc.distance <= maxDistance);\n      }\n\n      // Apply time filter (same logic as Results Table)\n      if (maxTime) {\n        calculations = calculations.filter((calc: any) => calc.duration <= maxTime);\n      }\n\n      // Get unique contractor IDs from the filtered calculations\n      const contractorIds = calculations\n        .map((calc: any) => calc.resource.properties?.contractorId)\n        .filter(id => id !== undefined);\n\n      // Fetch only the contractors that are in the filtered analysis results\n      const allContractors = await storage.getAllContractors();\n      const relevantContractors = allContractors.filter(c => contractorIds.includes(c.id));\n\n      // Create a map for quick contractor lookup\n      const contractorMap = new Map(relevantContractors.map(c => [c.id, c]));\n\n      // Build export data with all contractor fields from database\n      console.log(`Found ${calculations.length} calculations for export`);\n      console.log('Sample calculation:', calculations[0]);\n\n      const exportData = calculations.map((calc: any) => {\n        const contractorId = calc.resource.properties?.contractorId;\n        const contractor = contractorId ? contractorMap.get(contractorId) : null;\n\n        return {\n          'Name': contractor?.name || calc.resource.name,\n          'Distance (miles)': parseFloat(calc.distance.toFixed(2)), // Keep as number for Excel sorting\n          'Drive Time (hours)': parseFloat((calc.duration / 3600).toFixed(2)), // Hours as number for Excel sorting\n          'Drive Time (formatted)': formatDuration(calc.duration), // Formatted string for readability\n          'Company': contractor?.company || '',\n          'Category': contractor?.category || calc.resource.type,\n          'Pipefile': contractor?.pipefile || '',\n          'AVETTA': contractor?.avetta || '',\n          'ISN Complete': contractor?.isnComplete ? 'Yes' : 'No',\n          'City': contractor?.city || '',\n          'State': contractor?.state || '',\n          'Full Address': contractor?.fullAddress || '',\n          'Latitude': parseFloat((contractor?.latitude || calc.resource.latitude).toFixed(6)),\n          'Longitude': parseFloat((contractor?.longitude || calc.resource.longitude).toFixed(6)),\n          'Phone': contractor?.phone || '',\n          'Email': contractor?.email || '',\n          'BIRD REP': contractor?.birdRep || '',\n          'SUB Ranking': contractor?.subRanking || '',\n          'MSA Status': contractor?.newMsaComplete || '',\n          'FTE Counts Per Location': contractor?.fteCountsPerLocation || '',\n          'Pipefile updates': contractor?.pipefileUpdates || '',\n          'Notes': contractor?.notes || '',\n          'Rating': contractor?.rating || 0,\n        };\n      });\n\n      console.log(`Export data length: ${exportData.length}`);\n      if (exportData.length > 0) {\n        console.log('Sample export data:', exportData[0]);\n      }\n\n      // Filter out rows that are essentially blank (only have distance/time but no meaningful contractor data)\n      const filteredExportData = exportData.filter((row: any) => {\n        // Keep the row if it has at least one of these key fields populated\n        const hasName = row['Name'] && row['Name'].trim() !== '';\n        const hasCompany = row['Company'] && row['Company'].trim() !== '';\n        const hasPhone = row['Phone'] && row['Phone'].trim() !== '';\n        const hasEmail = row['Email'] && row['Email'].trim() !== '';\n        const hasCategory = row['Category'] && row['Category'].trim() !== '';\n        \n        // Row must have a name at minimum\n        return hasName && (hasCompany || hasPhone || hasEmail || hasCategory);\n      });\n\n      console.log(`Filtered export data length: ${filteredExportData.length} (removed ${exportData.length - filteredExportData.length} blank rows)`);\n\n      // Remove duplicates based on email and phone number\n      // Keep the first occurrence (which will be the closest due to distance sorting)\n      const seenContacts = new Set<string>();\n      const deduplicatedData = filteredExportData.filter((row: any) => {\n        const email = (row['Email'] || '').trim().toLowerCase();\n        const phone = (row['Phone'] || '').trim();\n        \n        // Create a unique key from email and/or phone\n        // If both are empty, keep the row (might be storage yard or other resource)\n        if (!email && !phone) {\n          return true;\n        }\n        \n        const contactKey = `${email}|${phone}`;\n        \n        // If we've seen this exact email/phone combination, skip it\n        if (seenContacts.has(contactKey)) {\n          return false;\n        }\n        \n        // Mark this contact as seen\n        seenContacts.add(contactKey);\n        return true;\n      });\n\n      console.log(`Deduplicated export data length: ${deduplicatedData.length} (removed ${filteredExportData.length - deduplicatedData.length} duplicates)`);\n\n      if (format === 'excel') {\n        const buffer = exportToExcelWithBirdRepSheets(deduplicatedData, 'distance_analysis');\n\n        res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n        res.setHeader('Content-Disposition', 'attachment; filename=\"distance_analysis.xlsx\"');\n        return res.send(buffer);\n      } else if (format === 'csv') {\n        if (groupByBirdRep) {\n          // Create ZIP file with separate CSV files for each Bird Rep\n          const { files } = exportToCSVWithBirdRepFiles(deduplicatedData, 'distance_analysis');\n\n          // Create ZIP file with archiver\n\n          res.setHeader('Content-Type', 'application/zip');\n          res.setHeader('Content-Disposition', 'attachment; filename=\"distance_analysis_by_bird_rep.zip\"');\n\n          const archive = archiver('zip', { zlib: { level: 9 } });\n          archive.pipe(res);\n\n          // Add each CSV file to the archive\n          files.forEach(file => {\n            archive.append(file.content, { name: file.name });\n          });\n\n          await archive.finalize();\n          return;\n        } else {\n          // Regular single CSV export\n          const csvHeaders = Object.keys(deduplicatedData[0] || {});\n          const csvRows = deduplicatedData.map(row => \n            csvHeaders.map(header => `\"${(row as any)[header] || ''}\"`).join(',')\n          );\n          const csv = [csvHeaders.join(','), ...csvRows].join('\\n');\n\n          res.setHeader('Content-Type', 'text/csv');\n          res.setHeader('Content-Disposition', 'attachment; filename=\"distance_analysis.csv\"');\n          return res.send(csv);\n        }\n      } else if (format === 'webeoc') {\n        // WebEOC Contact Export - only contact information (using deduplicated data)\n        const webeocData = deduplicatedData.map((row: any) => {\n          // Split name into first and last name\n          const fullName = row['Name'] || '';\n          const nameParts = fullName.trim().split(/\\s+/);\n          const lastName = nameParts.length > 0 ? nameParts[nameParts.length - 1] : '';\n          const firstName = nameParts.length > 1 ? nameParts.slice(0, -1).join(' ') : nameParts[0] || '';\n          \n          return {\n            'LAST_NAME': lastName,\n            'FIRST_NAME': firstName,\n            'CONTACT_EMAIL': row['Email'] || '',\n            'CONTACT_PHONE_NUMBER_TEXT': row['Phone'] || '',\n          };\n        });\n\n        const csvHeaders = ['LAST_NAME', 'FIRST_NAME', 'CONTACT_EMAIL', 'CONTACT_PHONE_NUMBER_TEXT'];\n        const csvRows = webeocData.map(row => \n          csvHeaders.map(header => `\"${(row as any)[header] || ''}\"`).join(',')\n        );\n        const csv = [csvHeaders.join(','), ...csvRows].join('\\n');\n\n        res.setHeader('Content-Type', 'text/csv');\n        res.setHeader('Content-Disposition', 'attachment; filename=\"webeoc_contacts.csv\"');\n        return res.send(csv);\n      }\n    } catch (error) {\n      console.error('Export calculations error:', error);\n      res.status(500).json({ message: \"Failed to export calculations\" });\n    }\n  });\n\n  // Clear all database data\n  app.post(\"/api/database/clear\", async (req, res) => {\n    try {\n      await storage.deleteAllResources();\n      await db.delete(distanceCalculations);\n      await db.delete(analysisPoints);\n      await db.delete(contractors);\n      res.json({ message: \"Database cleared successfully\" });\n    } catch (error) {\n      console.error('Clear database error:', error);\n      res.status(500).json({ message: \"Failed to clear database\" });\n    }\n  });\n\n  // Note: Authentication routes (/api/login, /api/callback, /api/logout) \n  // are handled by replitAuth.ts setupAuth() which is called in index.ts\n\n  // Contractor Submission Route (Public - No Auth Required)\n  app.post(\"/api/contractor-submissions\", async (req, res) => {\n    try {\n      const { hasSubcontractor, subcontractorData, ...submissionData } = req.body;\n\n      // Create or find the contractor first\n      let contractorId;\n\n      // Use enhanced fuzzy matching (handles case, phone formatting, and email variations)\n      const existingContractor = await storage.findContractorByNormalizedMatch(\n        submissionData.companyName,\n        submissionData.contractorName,\n        submissionData.email,\n        submissionData.phone\n      );\n\n      if (existingContractor) {\n        contractorId = existingContractor.id;\n        console.log(`✓ Matched existing contractor #${contractorId}: ${existingContractor.company}`);\n\n        // Merge new information with existing contractor data\n        const updateData: any = {};\n        \n        // Helper to normalize email for comparison (MUST match storage.ts logic)\n        const normalizeEmail = (email: string) => email.toLowerCase().trim();\n        \n        // Helper to normalize phone for comparison (MUST match storage.ts logic)\n        const normalizePhone = (phone: string) => {\n          let digits = phone.replace(/\\D/g, ''); // Remove all non-digits\n          \n          // Handle US country code: if starts with \"1\" and has 11 digits, remove leading \"1\"\n          if (digits.length === 11 && digits.startsWith('1')) {\n            digits = digits.substring(1);\n          }\n          \n          // Only keep first 10 digits (ignore extensions)\n          if (digits.length > 10) {\n            digits = digits.substring(0, 10);\n          }\n          \n          return digits;\n        };\n        \n        // Add email if new and different (using normalized comparison, support both ; and , separators)\n        if (submissionData.email && submissionData.email.trim() !== '') {\n          const currentEmails = (existingContractor.email || '').split(/[;,]/).map(e => normalizeEmail(e));\n          const newEmail = normalizeEmail(submissionData.email);\n          \n          if (!currentEmails.some(e => e === newEmail)) {\n            updateData.email = existingContractor.email ? `${existingContractor.email}; ${submissionData.email.trim()}` : submissionData.email.trim();\n            console.log(`  → Adding new email: ${submissionData.email.trim()}`);\n          } else {\n            console.log(`  → Email already exists (normalized match)`);\n          }\n        }\n        \n        // Add phone if new and different (using normalized comparison, support both ; and , separators)\n        if (submissionData.phone && submissionData.phone.trim() !== '') {\n          const currentPhones = (existingContractor.phone || '').split(/[;,]/).map(p => normalizePhone(p));\n          const newPhone = normalizePhone(submissionData.phone);\n          \n          if (!currentPhones.some(p => p === newPhone && p.length >= 10)) {\n            updateData.phone = existingContractor.phone ? `${existingContractor.phone}; ${submissionData.phone.trim()}` : submissionData.phone.trim();\n            console.log(`  → Adding new phone: ${submissionData.phone.trim()}`);\n          } else {\n            console.log(`  → Phone already exists (normalized match)`);\n          }\n        }\n        \n        // Update category if provided and not set\n        if (submissionData.category && (!existingContractor.category || existingContractor.category === 'Unknown')) {\n          updateData.category = submissionData.category;\n        }\n        \n        // Update bird rep if provided and not set\n        if (submissionData.birdRep && (!existingContractor.birdRep || existingContractor.birdRep === 'TBD')) {\n          updateData.birdRep = submissionData.birdRep;\n        }\n\n        if (Object.keys(updateData).length > 0) {\n          await storage.updateContractor(contractorId, updateData);\n        }\n      } else {\n        // Create new contractor and mark for review\n        const newContractor = await storage.createContractor({\n          name: submissionData.contractorName,\n          company: submissionData.companyName,\n          email: submissionData.email || '',\n          phone: submissionData.phone || '',\n          category: submissionData.category,\n          city: '',\n          state: '',\n          birdRep: submissionData.birdRep || 'TBD',\n          rating: 0,\n          notes: 'Created from contractor availability submission',\n          needsReview: true\n        });\n        contractorId = newContractor.id;\n      }\n\n      // Create availability submission record\n      const submission = await storage.createAvailabilitySubmission({\n        filename: 'contractor_form_submission',\n        originalName: `Submission from ${submissionData.companyName}`,\n        filePath: '',\n        submissionType: 'web_form',\n        status: 'submitted',\n        submittedBy: submissionData.submittedBy || 'contractor'\n      });\n\n      // Determine session ID for this submission\n      let sessionIdForSubmission = submissionData.sessionId || 'active';\n      \n      // If a numeric session ID is provided, verify it exists\n      if (sessionIdForSubmission !== 'active' && !isNaN(parseInt(sessionIdForSubmission))) {\n        const session = await storage.getAvailabilitySessionById(parseInt(sessionIdForSubmission));\n        if (!session) {\n          // Fall back to active if session doesn't exist\n          sessionIdForSubmission = 'active';\n        }\n      }\n\n      // Create main contractor availability\n      const availabilityData = {\n        contractorId,\n        departureLocation: submissionData.departureLocation,\n        departureLatitude: submissionData.departureLatitude || null,\n        departureLongitude: submissionData.departureLongitude || null,\n        totalFTE: submissionData.totalFTE || 0,\n        buckets: submissionData.buckets || 0,\n        diggers: submissionData.diggers || 0,\n        pickups: submissionData.pickups || 0,\n        backyardMachines: submissionData.backyardMachines || 0,\n        notes: submissionData.notes || '',\n        submittedBy: submissionData.submittedBy || 'contractor',\n        availableStartDate: new Date(),\n        status: 'submitted',\n        sessionId: sessionIdForSubmission\n      };\n\n      const availability = await storage.createCrewAvailability(availabilityData);\n\n      // Handle subcontractor if present\n      if (hasSubcontractor && subcontractorData) {\n        // Check if subcontractor already exists using enhanced fuzzy matching\n        let subcontractor = await storage.findContractorByNormalizedMatch(\n          subcontractorData.company,\n          subcontractorData.name,\n          subcontractorData.email,\n          subcontractorData.phone\n        );\n        \n        if (!subcontractor) {\n          // Create subcontractor record only if it doesn't exist\n          subcontractor = await storage.createContractor({\n            name: subcontractorData.name,\n            company: subcontractorData.company,\n            category: 'Subcontractor',\n            email: '', \n            phone: '',\n            city: '',\n            state: '',\n            birdRep: submissionData.birdRep || 'TBD',\n            rating: 0,\n            notes: `Subcontractor brought by ${submissionData.companyName} (ID: ${contractorId})`,\n            needsReview: true\n          });\n        }\n\n        // Create subcontractor availability\n        const subAvailabilityData = {\n          contractorId: subcontractor.id,\n          departureLocation: subcontractorData.departureLocation,\n          departureLatitude: subcontractorData.departureLatitude || null,\n          departureLongitude: subcontractorData.departureLongitude || null,\n          totalFTE: subcontractorData.totalFTE || 0,\n          buckets: subcontractorData.buckets || 0,\n          diggers: subcontractorData.diggers || 0,\n          pickups: subcontractorData.pickups || 0,\n          backyardMachines: subcontractorData.backyardMachines || 0,\n          notes: `Subcontractor for ${submissionData.companyName}`,\n          submittedBy: submissionData.submittedBy || 'contractor',\n          availableStartDate: new Date(),\n          status: 'submitted',\n          sessionId: sessionIdForSubmission\n        };\n\n        await storage.createCrewAvailability(subAvailabilityData);\n      }\n\n      console.log(`Contractor submission processed successfully for ${submissionData.companyName}`);\n\n      res.json({ \n        message: \"Submission received successfully\",\n        submissionId: submission.id,\n        contractorId: contractorId\n      });\n\n    } catch (error) {\n      console.error('Contractor submission error:', error);\n      res.status(500).json({ message: \"Failed to process submission\" });\n    }\n  });\n\n  // Availability Sessions endpoints\n  app.get(\"/api/availability-sessions\", async (req, res) => {\n    try {\n      const sessions = await storage.getAvailabilitySessions();\n      \n      // Get counts for each session\n      const sessionsWithCounts = await Promise.all(\n        sessions.map(async (session) => {\n          const availability = await storage.getCrewAvailabilityBySession(session.id);\n          return {\n            ...session,\n            recordCount: availability.length\n          };\n        })\n      );\n\n      // Get unassigned count\n      const unassigned = await storage.getCrewAvailabilityBySession('unassigned');\n      \n      res.json({\n        sessions: sessionsWithCounts,\n        unassignedCount: unassigned.length\n      });\n    } catch (error) {\n      console.error('Get availability sessions error:', error);\n      res.status(500).json({ message: \"Failed to get availability sessions\" });\n    }\n  });\n\n  app.get(\"/api/availability-sessions/:id\", async (req, res) => {\n    try {\n      const sessionId = parseInt(req.params.id);\n      const session = await storage.getAvailabilitySessionById(sessionId);\n      \n      if (!session) {\n        return res.status(404).json({ message: \"Session not found\" });\n      }\n      \n      res.json(session);\n    } catch (error) {\n      console.error('Get availability session error:', error);\n      res.status(500).json({ message: \"Failed to get availability session\" });\n    }\n  });\n\n  app.post(\"/api/availability-sessions/start-new\", async (req, res) => {\n    try {\n      const { label } = req.body;\n      const newSession = await storage.startNewAvailabilitySession(label);\n      res.json(newSession);\n    } catch (error) {\n      console.error('Start new availability session error:', error);\n      res.status(500).json({ message: \"Failed to start new availability session\" });\n    }\n  });\n\n  // Crew Availability Routes\n  app.get(\"/api/crew-availability\", async (req, res) => {\n    try {\n      const { sessionId } = req.query;\n      \n      // Get availability filtered by session\n      let availabilities;\n      if (sessionId === 'active') {\n        availabilities = await storage.getCrewAvailabilityBySession('active');\n      } else if (sessionId === 'unassigned') {\n        availabilities = await storage.getCrewAvailabilityBySession('unassigned');\n      } else if (sessionId && !isNaN(parseInt(sessionId as string))) {\n        availabilities = await storage.getCrewAvailabilityBySession(parseInt(sessionId as string));\n      } else {\n        // Default to active session\n        availabilities = await storage.getCrewAvailabilityBySession('active');\n      }\n\n      // Get contractor information for each availability\n      const availabilitiesWithContractors = await Promise.all(\n        availabilities.map(async (availability) => {\n          const contractor = await storage.getContractor(availability.contractorId);\n          return {\n            ...availability,\n            contractor: contractor ? {\n              name: contractor.name,\n              company: contractor.company,\n              category: contractor.category,\n              email: contractor.email,\n              phone: contractor.phone,\n              birdRep: contractor.birdRep,\n              subRanking: contractor.subRanking,\n              newMsaComplete: contractor.newMsaComplete,\n              isnComplete: contractor.isnComplete\n            } : null\n          };\n        })\n      );\n\n      res.json(availabilitiesWithContractors);\n    } catch (error) {\n      console.error('Get crew availability error:', error);\n      // Fallback to getting all availability if session filtering fails\n      try {\n        const availabilities = await storage.getAllCrewAvailability();\n        const availabilitiesWithContractors = await Promise.all(\n          availabilities.map(async (availability) => {\n            const contractor = await storage.getContractor(availability.contractorId);\n            return {\n              ...availability,\n              contractor: contractor ? {\n                name: contractor.name,\n                company: contractor.company,\n                category: contractor.category,\n                email: contractor.email,\n                phone: contractor.phone,\n                birdRep: contractor.birdRep,\n                subRanking: contractor.subRanking,\n                newMsaComplete: contractor.newMsaComplete\n              } : null\n            };\n          })\n        );\n        res.json(availabilitiesWithContractors);\n      } catch (fallbackError) {\n        res.status(500).json({ message: \"Failed to get crew availability\" });\n      }\n    }\n  });\n\n  // Fallback route for availability data when sessions aren't available\n  app.get(\"/api/crew-availability-fallback\", async (req, res) => {\n    try {\n      // Get all availability data using the original method\n      const availabilities = await storage.getAllCrewAvailability();\n\n      // Get contractor information for each availability\n      const availabilitiesWithContractors = await Promise.all(\n        availabilities.map(async (availability) => {\n          const contractor = await storage.getContractor(availability.contractorId);\n          return {\n            ...availability,\n            contractor: contractor ? {\n              name: contractor.name,\n              company: contractor.company,\n              category: contractor.category,\n              email: contractor.email,\n              phone: contractor.phone,\n              birdRep: contractor.birdRep,\n              subRanking: contractor.subRanking,\n              newMsaComplete: contractor.newMsaComplete,\n              isnComplete: contractor.isnComplete\n            } : null\n          };\n        })\n      );\n\n      res.json(availabilitiesWithContractors);\n    } catch (error) {\n      console.error('Get crew availability fallback error:', error);\n      res.status(500).json({ message: \"Failed to get crew availability\" });\n    }\n  });\n\n  app.post(\"/api/crew-availability\", async (req, res) => {\n    try {\n      const { hasSubcontractor, subcontractorData, isNewCompany, ...availabilityData } = req.body;\n\n      // Debug logging\n      console.log('Received crew availability data:', {\n        contractorId: availabilityData.contractorId,\n        contractorIdType: typeof availabilityData.contractorId,\n        isNewCompany,\n        fullBody: req.body\n      });\n\n      // Validate contractorId\n      if (!availabilityData.contractorId) {\n        console.error('Missing contractorId in request');\n        return res.status(400).json({ message: \"Contractor ID is required\" });\n      }\n\n      // Ensure contractorId is a number\n      const contractorId = parseInt(availabilityData.contractorId);\n      if (isNaN(contractorId)) {\n        console.error('Invalid contractorId:', availabilityData.contractorId);\n        return res.status(400).json({ message: \"Invalid contractor ID format\" });\n      }\n\n      // Update the data with parsed contractorId\n      availabilityData.contractorId = contractorId;\n\n      // Add default dates if not provided\n      const currentDate = new Date();\n      const dataWithDefaults = {\n        ...availabilityData,\n        availableStartDate: availabilityData.availableStartDate || currentDate,\n        availableEndDate: availabilityData.availableEndDate || undefined,\n        submissionDate: currentDate\n      };\n\n      // Create main contractor availability\n      const availability = await storage.createCrewAvailability(dataWithDefaults);\n\n      // If there's a subcontractor, create a separate availability record\n      if (hasSubcontractor && subcontractorData) {\n        // Check if subcontractor already exists using enhanced fuzzy matching\n        let subcontractor = await storage.findContractorByNormalizedMatch(\n          subcontractorData.company,\n          subcontractorData.name,\n          subcontractorData.email,\n          subcontractorData.phone\n        );\n        \n        if (!subcontractor) {\n          // Create subcontractor only if it doesn't exist\n          subcontractor = await storage.createContractor({\n            name: subcontractorData.name,\n            company: subcontractorData.company,\n            category: 'Subcontractor',\n            email: '',\n            phone: '',\n            city: '',\n            state: '',\n            birdRep: '',\n            rating: 0,\n            notes: `Subcontractor brought by contractor ID ${availabilityData.contractorId}`,\n            needsReview: true\n          });\n        }\n\n        // Create availability record for subcontractor\n        await storage.createCrewAvailability({\n          contractorId: subcontractor.id,\n          availableStartDate: currentDate,\n          availableEndDate: undefined,\n          submissionDate: currentDate,\n          departureLocation: subcontractorData.departureLocation,\n          totalFTE: subcontractorData.totalFTE || 0,\n          buckets: subcontractorData.buckets || 0,\n          diggers: subcontractorData.diggers || 0,\n          pickups: subcontractorData.pickups || 0,\n          backyardMachines: subcontractorData.backyardMachines || 0,\n          linemenCount: 0, // Legacy field\n          groundmenCount: 0, // Legacy field\n          operatorsCount: 0, // Legacy field\n          foremanCount: 0, // Legacy field\n          apprenticesCount: 0, // Legacy field\n          status: 'submitted',\n          notes: `Subcontractor availability brought by contractor ID ${availabilityData.contractorId}`,\n          submittedBy: availabilityData.submittedBy\n        });\n      }\n\n      res.json(availability);\n    } catch (error) {\n      console.error('Create crew availability error:', error);\n      res.status(500).json({ message: \"Failed to create crew availability\" });\n    }\n  });\n\n  app.patch(\"/api/crew-availability/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updated = await storage.updateCrewAvailability(id, req.body);\n      if (!updated) {\n        return res.status(404).json({ message: \"Crew availability not found\" });\n      }\n      res.json(updated);\n    } catch (error) {\n      console.error('Update crew availability error:', error);\n      res.status(500).json({ message: \"Failed to update crew availability\" });\n    }\n  });\n\n  app.delete(\"/api/crew-availability/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      await storage.deleteCrewAvailability(id);\n      res.json({ message: \"Crew availability deleted successfully\" });\n    } catch (error) {\n      console.error('Delete crew availability error:', error);\n      res.status(500).json({ message: \"Failed to delete crew availability\" });\n    }\n  });\n\n  // Availability Submissions routes\n  app.get(\"/api/availability-submissions\", async (req, res) => {\n    try {\n      const submissions = await storage.getAvailabilitySubmissions();\n      res.json(submissions);\n    } catch (error) {\n      console.error('Get availability submissions error:', error);\n      res.status(500).json({ message: \"Failed to get availability submissions\" });\n    }\n  });\n\n  app.patch(\"/api/availability-submissions/:id\", async (req, res) => {\n    try {\n      const id = parseInt(req.params.id);\n      const updated = await storage.updateAvailabilitySubmission(id, req.body);\n      if (!updated) {\n        return res.status(404).json({ message: \"Availability submission not found\" });\n      }\n      res.json(updated);\n    } catch (error) {\n      console.error('Update availability submission error:', error);\n      res.status(500).json({ message: \"Failed to update availability submission\" });\n    }\n  });\n\n  // Excel export route for distance analysis\n  app.post(\"/api/export-excel\", async (req, res) => {\n    try {\n      const { data, filename, sheetName } = req.body;\n\n      // Import XLSX dynamically\n      const XLSX = await import('xlsx');\n      const workbook = XLSX.utils.book_new();\n      const worksheet = XLSX.utils.json_to_sheet(data);\n\n      // Auto-size columns\n      const colWidths: any[] = [];\n      const headers = Object.keys(data[0] || {});\n      headers.forEach((header, index) => {\n        const maxLength = Math.max(\n          header.length,\n          ...data.map((row: any) => String(row[header] || '').length)\n        );\n        colWidths[index] = { width: Math.min(Math.max(maxLength + 2, 10), 30) };\n      });\n      worksheet['!cols'] = colWidths;\n\n      XLSX.utils.book_append_sheet(workbook, worksheet, sheetName || 'Sheet1');\n\n      const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });\n\n      res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n      res.setHeader('Content-Disposition', `attachment; filename=\"${filename || 'export.xlsx'}\"`);\n      res.send(buffer);\n    } catch (error) {\n      console.error('Excel export error:', error);\n      res.status(500).json({ message: \"Failed to export Excel file\" });\n    }\n  });\n\n  // Color-coded Excel export route for distance analysis (time only)\n  app.post(\"/api/export-excel-color-coded\", async (req, res) => {\n    try {\n      const { data, filename, sheetName, destinations } = req.body;\n\n      // Import ExcelJS dynamically\n      const ExcelJSModule = await import('exceljs');\n      const ExcelJS = ExcelJSModule.default || ExcelJSModule;\n      const workbook = new ExcelJS.Workbook();\n      const worksheet = workbook.addWorksheet(sheetName || 'Sheet1');\n\n      // Helper function to get cell fill color based on hours\n      const getCellColor = (hours: number): string => {\n        if (hours <= 4) return 'FF90EE90'; // Green\n        if (hours <= 8) return 'FFFFFF00'; // Yellow\n        if (hours <= 12) return 'FFFFA500'; // Orange\n        return 'FFADD8E6'; // Light Blue\n      };\n\n      // Get headers from data\n      const headers = Object.keys(data[0] || {});\n      \n      // Find time column indices\n      const timeColumnIndices: number[] = [];\n      headers.forEach((header, index) => {\n        if (header.includes('Travel Time')) {\n          timeColumnIndices.push(index + 1); // ExcelJS is 1-indexed\n        }\n      });\n\n      // Add header row with bold formatting\n      const headerRow = worksheet.addRow(headers);\n      headerRow.font = { bold: true };\n      headerRow.alignment = { horizontal: 'center', vertical: 'middle' };\n\n      // Add data rows\n      data.forEach((row: any) => {\n        const rowValues = headers.map(header => row[header]);\n        const excelRow = worksheet.addRow(rowValues);\n        \n        // Apply color to time columns\n        timeColumnIndices.forEach(colIndex => {\n          const cell = excelRow.getCell(colIndex);\n          const hours = cell.value as number;\n          \n          if (typeof hours === 'number' && hours > 0) {\n            cell.fill = {\n              type: 'pattern',\n              pattern: 'solid',\n              fgColor: { argb: getCellColor(hours) }\n            };\n          }\n          cell.alignment = { horizontal: 'center', vertical: 'middle' };\n        });\n      });\n\n      // Auto-size columns\n      worksheet.columns.forEach((column, index) => {\n        if (column) {\n          const header = headers[index];\n          const maxLength = Math.max(\n            header.length,\n            ...data.map((row: any) => String(row[header] || '').length)\n          );\n          column.width = Math.min(Math.max(maxLength + 2, 10), 30);\n        }\n      });\n\n      // Write to buffer\n      const buffer = await workbook.xlsx.writeBuffer();\n\n      res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n      res.setHeader('Content-Disposition', `attachment; filename=\"${filename || 'export-color-coded.xlsx'}\"`);\n      res.send(buffer);\n    } catch (error) {\n      console.error('Color-coded Excel export error:', error);\n      res.status(500).json({ message: \"Failed to export color-coded Excel file\" });\n    }\n  });\n\n  // Export availability submissions endpoint\n  app.get(\"/api/crew-availability/export\", async (req, res) => {\n    try {\n      const format = req.query.format as string || 'excel';\n      const sessionParam = req.query.session as string;\n      \n      // Get availability data filtered by session if provided\n      let availabilities;\n      let sessionLabel = '';\n      \n      if (sessionParam) {\n        if (sessionParam === 'active') {\n          availabilities = await storage.getCrewAvailabilityBySession('active');\n          const activeSession = await storage.getActiveAvailabilitySession();\n          sessionLabel = activeSession?.label || 'Active Session';\n        } else if (sessionParam === 'unassigned') {\n          availabilities = await storage.getCrewAvailabilityBySession('unassigned');\n          sessionLabel = 'Unassigned';\n        } else {\n          const sessionId = parseInt(sessionParam);\n          availabilities = await storage.getCrewAvailabilityBySession(sessionId);\n          const session = await storage.getAvailabilitySessionById(sessionId);\n          sessionLabel = session?.label || `Session ${sessionId}`;\n        }\n      } else {\n        availabilities = await storage.getAllCrewAvailability();\n        sessionLabel = 'All Sessions';\n      }\n      \n      // Get contractor information for each availability\n      const availabilitiesWithContractors = await Promise.all(\n        availabilities.map(async (availability) => {\n          const contractor = await storage.getContractor(availability.contractorId);\n          return {\n            ...availability,\n            contractor: contractor ? {\n              name: contractor.name,\n              company: contractor.company,\n              category: contractor.category,\n              email: contractor.email,\n              phone: contractor.phone,\n              birdRep: contractor.birdRep,\n              subRanking: contractor.subRanking,\n              newMsaComplete: contractor.newMsaComplete,\n              isnComplete: contractor.isnComplete\n            } : null\n          };\n        })\n      );\n\n      // Format export data\n      const exportData = availabilitiesWithContractors.map((item) => ({\n        'Contractor': item.contractor?.company || 'Unknown',\n        'Contact Person': item.contractor?.name || 'Unknown',\n        'Category': item.contractor?.category || 'Not specified',\n\n        'Email': item.contractor?.email || 'Not provided',\n        'Phone': item.contractor?.phone || 'Not provided',\n        'Bird Rep': item.contractor?.birdRep || 'Not assigned',\n        'Sub Ranking': item.contractor?.subRanking || '',\n        'ISN Complete': item.contractor?.isnComplete ? 'Yes' : 'No',\n        'Departure City': item.departureCity || (item.departureLocation ? item.departureLocation.split(',')[0]?.trim() : ''),\n        'Departure State': item.departureState || (item.departureLocation ? item.departureLocation.split(',')[1]?.trim() : ''),\n        'Total FTE': item.totalFTE || 0,\n        'Linemen': item.linemenCount || 0,\n        'Groundmen': item.groundmenCount || 0,\n        'Operators': item.operatorsCount || 0,\n        'Foreman': item.foremanCount || 0,\n        'Apprentices': item.apprenticesCount || 0,\n        'Buckets': item.buckets || 0,\n        'Diggers': item.diggers || 0,\n        'Pickups': item.pickups || 0,\n        'Backyard Machines': item.backyardMachines || 0,\n        'Available Start Date': item.availableStartDate ? new Date(item.availableStartDate).toLocaleDateString() : '',\n        'Available End Date': item.availableEndDate ? new Date(item.availableEndDate).toLocaleDateString() : 'Open ended',\n        'Status': item.status,\n        'Submitted By': item.submittedBy || 'Unknown',\n        'Reviewed By': item.reviewedBy || 'Pending',\n        'Submission Date': item.submissionDate ? new Date(item.submissionDate).toLocaleDateString() : '',\n        'Notes': item.notes || ''\n      }));\n\n      if (format === 'excel') {\n        // Import XLSX dynamically\n        const XLSX = await import('xlsx');\n        const workbook = XLSX.utils.book_new();\n        const worksheet = XLSX.utils.json_to_sheet(exportData);\n\n        // Auto-size columns\n        const colWidths: any[] = [];\n        const headers = Object.keys(exportData[0] || {});\n        headers.forEach((header, index) => {\n          const maxLength = Math.max(\n            header.length,\n            ...exportData.map((row: any) => String(row[header] || '').length)\n          );\n          colWidths[index] = { width: Math.min(Math.max(maxLength + 2, 10), 30) };\n        });\n        worksheet['!cols'] = colWidths;\n\n        XLSX.utils.book_append_sheet(workbook, worksheet, 'Availability Submissions');\n        const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });\n\n        const sanitizedSessionLabel = sessionLabel.replace(/[^a-zA-Z0-9_-]/g, '_');\n        const filename = `availability_${sanitizedSessionLabel}_${new Date().toISOString().slice(0, 10)}.xlsx`;\n        \n        res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n        res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n        return res.send(buffer);\n      } else if (format === 'csv') {\n        // Generate CSV\n        const csvHeaders = Object.keys(exportData[0] || {});\n        const csvRows = exportData.map(row => \n          csvHeaders.map(header => `\"${(row as any)[header] || ''}\"`).join(',')\n        );\n        const csv = [csvHeaders.join(','), ...csvRows].join('\\n');\n\n        const sanitizedSessionLabel = sessionLabel.replace(/[^a-zA-Z0-9_-]/g, '_');\n        const filename = `availability_${sanitizedSessionLabel}_${new Date().toISOString().slice(0, 10)}.csv`;\n        \n        res.setHeader('Content-Type', 'text/csv');\n        res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n        return res.send(csv);\n      }\n\n      res.status(400).json({ message: \"Invalid format. Use 'excel' or 'csv'\" });\n    } catch (error) {\n      console.error('Export availability submissions error:', error);\n      res.status(500).json({ message: \"Failed to export availability submissions\" });\n    }\n  });\n\n  // AI-Enhanced Export availability submissions endpoint\n  app.get(\"/api/crew-availability/export-ai-matched\", async (req, res) => {\n    try {\n      const format = req.query.format as string || 'excel';\n      const sessionParam = req.query.session as string;\n      \n      // Get availability data filtered by session if provided\n      let availabilities;\n      let sessionLabel = '';\n      \n      if (sessionParam) {\n        if (sessionParam === 'active') {\n          availabilities = await storage.getCrewAvailabilityBySession('active');\n          const activeSession = await storage.getActiveAvailabilitySession();\n          sessionLabel = activeSession?.label || 'Active Session';\n        } else if (sessionParam === 'unassigned') {\n          availabilities = await storage.getCrewAvailabilityBySession('unassigned');\n          sessionLabel = 'Unassigned';\n        } else {\n          const sessionId = parseInt(sessionParam);\n          availabilities = await storage.getCrewAvailabilityBySession(sessionId);\n          const session = await storage.getAvailabilitySessionById(sessionId);\n          sessionLabel = session?.label || `Session ${sessionId}`;\n        }\n      } else {\n        availabilities = await storage.getAllCrewAvailability();\n        sessionLabel = 'All Sessions';\n      }\n      \n      // Get all contractors for AI matching\n      const allContractors = await storage.getAllContractors();\n      \n      console.log(`Starting AI matching for ${availabilities.length} availability submissions against ${allContractors.length} contractors`);\n      \n      // Process each availability submission with AI matching\n      const aiMatchedData = await Promise.all(\n        availabilities.map(async (availability) => {\n          let contractor = null;\n          let matchConfidence = 0;\n          let matchReasoning = 'No contractor linked';\n          let submissionCompanyName = 'Unknown';\n          \n          // First try to get the linked contractor (existing system)\n          if (availability.contractorId) {\n            contractor = await storage.getContractor(availability.contractorId);\n            if (contractor) {\n              matchConfidence = 1.0;\n              matchReasoning = 'Direct database link';\n              submissionCompanyName = contractor.company;\n            }\n          }\n          \n          // If no direct link, try AI matching using the availability notes or any company name we can extract\n          if (!contractor) {\n            // Try to extract company name from notes or other fields\n            const extractedCompanyName = availability.notes || availability.submittedBy || 'Unknown Company';\n            \n            if (extractedCompanyName && extractedCompanyName !== 'Unknown Company' && extractedCompanyName !== 'admin') {\n              const aiMatch = await findBestContractorMatch(extractedCompanyName, allContractors);\n              contractor = aiMatch.contractor;\n              matchConfidence = aiMatch.confidence;\n              matchReasoning = aiMatch.reasoning;\n              submissionCompanyName = extractedCompanyName;\n            }\n          }\n          \n          return {\n            availability,\n            contractor,\n            matchConfidence,\n            matchReasoning,\n            submissionCompanyName\n          };\n        })\n      );\n      \n      console.log(`AI matching complete. Found matches for ${aiMatchedData.filter(d => d.contractor).length} submissions`);\n\n      // Format export data with AI matching information\n      const exportData = aiMatchedData.map((item) => ({\n        // Submission Information\n        'Submission Company Name': item.submissionCompanyName,\n        'Submission Notes': item.availability.notes || '',\n        'Submitted By': item.availability.submittedBy || 'Unknown',\n        'Submission Date': item.availability.submissionDate ? new Date(item.availability.submissionDate).toLocaleDateString() : '',\n        'Status': item.availability.status,\n        \n        // AI Matching Information\n        'Match Confidence': Math.round(item.matchConfidence * 100) + '%',\n        'Match Reasoning': item.matchReasoning,\n        \n        // Matched Contractor Information (from database)\n        'Database Company': item.contractor?.company || 'No Match Found',\n        'Contact Person': item.contractor?.name || '',\n        'Category': item.contractor?.category || '',\n\n        'Email': item.contractor?.email || '',\n        'Phone': item.contractor?.phone || '',\n        'Bird Rep': item.contractor?.birdRep || '',\n        'Sub Ranking': item.contractor?.subRanking || '',\n        'Full Address': item.contractor?.fullAddress || '',\n        'City': item.contractor?.city || '',\n        'State': item.contractor?.state || '',\n        'Pipefile': item.contractor?.pipefile || '',\n        'AVETTA': item.contractor?.avetta || '',\n        'ISN Complete': item.contractor?.isnComplete ? 'Yes' : 'No',\n        \n        // Availability Details\n        'Departure City': item.availability.departureCity || (item.availability.departureLocation ? item.availability.departureLocation.split(',')[0]?.trim() : ''),\n        'Departure State': item.availability.departureState || (item.availability.departureLocation ? item.availability.departureLocation.split(',')[1]?.trim() : ''),\n        'Total FTE': item.availability.totalFTE || 0,\n        'Linemen': item.availability.linemenCount || 0,\n        'Groundmen': item.availability.groundmenCount || 0,\n        'Operators': item.availability.operatorsCount || 0,\n        'Foreman': item.availability.foremanCount || 0,\n        'Apprentices': item.availability.apprenticesCount || 0,\n        'Buckets': item.availability.buckets || 0,\n        'Diggers': item.availability.diggers || 0,\n        'Pickups': item.availability.pickups || 0,\n        'Backyard Machines': item.availability.backyardMachines || 0,\n        'Available Start Date': item.availability.availableStartDate ? new Date(item.availability.availableStartDate).toLocaleDateString() : '',\n        'Available End Date': item.availability.availableEndDate ? new Date(item.availability.availableEndDate).toLocaleDateString() : 'Open ended',\n        'Reviewed By': item.availability.reviewedBy || 'Pending',\n      }));\n\n      if (format === 'excel') {\n        // Import XLSX dynamically\n        const XLSX = await import('xlsx');\n        const workbook = XLSX.utils.book_new();\n        const worksheet = XLSX.utils.json_to_sheet(exportData);\n\n        // Auto-size columns\n        const colWidths: any[] = [];\n        const headers = Object.keys(exportData[0] || {});\n        headers.forEach((header, index) => {\n          const maxLength = Math.max(\n            header.length,\n            ...exportData.map((row: any) => String(row[header] || '').length)\n          );\n          colWidths[index] = { width: Math.min(Math.max(maxLength + 2, 10), 30) };\n        });\n        worksheet['!cols'] = colWidths;\n\n        XLSX.utils.book_append_sheet(workbook, worksheet, 'AI Matched Availability');\n        const buffer = XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });\n\n        const sanitizedSessionLabel = sessionLabel.replace(/[^a-zA-Z0-9_-]/g, '_');\n        const filename = `ai_matched_${sanitizedSessionLabel}_${new Date().toISOString().slice(0, 10)}.xlsx`;\n        \n        res.setHeader('Content-Type', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');\n        res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n        return res.send(buffer);\n      } else if (format === 'csv') {\n        // Generate CSV\n        const csvHeaders = Object.keys(exportData[0] || {});\n        const csvRows = exportData.map(row => \n          csvHeaders.map(header => `\"${(row as any)[header] || ''}\"`).join(',')\n        );\n        const csv = [csvHeaders.join(','), ...csvRows].join('\\n');\n\n        const sanitizedSessionLabel = sessionLabel.replace(/[^a-zA-Z0-9_-]/g, '_');\n        const filename = `ai_matched_${sanitizedSessionLabel}_${new Date().toISOString().slice(0, 10)}.csv`;\n        \n        res.setHeader('Content-Type', 'text/csv');\n        res.setHeader('Content-Disposition', `attachment; filename=\"${filename}\"`);\n        return res.send(csv);\n      }\n\n      res.status(400).json({ message: \"Invalid format. Use 'excel' or 'csv'\" });\n    } catch (error) {\n      console.error('AI-enhanced export error:', error);\n      res.status(500).json({ message: \"Failed to export AI-matched availability submissions\" });\n    }\n  });\n\n  // Availability File Upload Route\n  app.post(\"/api/availability/upload\", upload.single('file'), async (req, res) => {\n    try {\n      if (!req.file) {\n        return res.status(400).json({ message: \"No file uploaded\" });\n      }\n\n      const submittedBy = req.body.submittedBy || 'unknown';\n      const filePath = req.file.path;\n\n      // Parse the FTE file\n      const { parseFTEFile, convertFTEToAvailabilityData } = require('./services/availabilityParser');\n      const fteRows = await parseFTEFile(filePath);\n\n      let recordsCreated = 0;\n      const errors: string[] = [];\n\n      // Create availability submission record\n      const submission = await storage.createAvailabilitySubmission({\n        filename: req.file.filename,\n        originalName: req.file.originalname,\n        filePath: req.file.path,\n        submissionType: 'file_upload',\n        status: 'pending',\n        submittedBy,\n        recordsCreated: 0,\n        errors: null\n      });\n\n      // Process each FTE row\n      for (const fteRow of fteRows) {\n        try {\n          // Find matching contractor by name\n          const contractors = await storage.getAllContractors();\n          const matchingContractor = contractors.find(c => \n            c.name.toLowerCase().trim() === fteRow.contractor.toLowerCase().trim()\n          );\n\n          if (!matchingContractor) {\n            errors.push(`No matching contractor found for: ${fteRow.contractor}`);\n            continue;\n          }\n\n          // Convert FTE data to availability format\n          const availabilityStartDate = new Date();\n          availabilityStartDate.setDate(availabilityStartDate.getDate() + 1); // Available from tomorrow\n\n          const { crewAvailability, equipmentAvailability } = convertFTEToAvailabilityData(\n            fteRow, \n            matchingContractor.id, \n            availabilityStartDate, \n            submittedBy\n          );\n\n          // Create crew availability record\n          const createdAvailability = await storage.createCrewAvailability({\n            ...crewAvailability,\n            contractorId: matchingContractor.id\n          });\n\n          // Create equipment availability records\n          for (const equipment of equipmentAvailability) {\n            await storage.createEquipmentAvailability({\n              ...equipment,\n              contractorId: matchingContractor.id,\n              crewAvailabilityId: createdAvailability.id\n            });\n          }\n\n          recordsCreated++;\n        } catch (error) {\n          console.error(`Error processing row for ${fteRow.contractor}:`, error);\n          const errorMessage = error instanceof Error ? error.message : String(error);\n          errors.push(`Error processing ${fteRow.contractor}: ${errorMessage}`);\n        }\n      }\n\n      // Update submission status\n      await storage.updateAvailabilitySubmission(submission.id, {\n        status: errors.length > 0 ? 'failed' : 'processed',\n        recordsCreated,\n        errors: errors.length > 0 ? JSON.stringify(errors) : null,\n        processedAt: new Date()\n      });\n\n      res.json({\n        message: \"File processed successfully\",\n        recordsCreated,\n        errors: errors.length > 0 ? errors : undefined\n      });\n\n    } catch (error) {\n      console.error('Availability upload error:', error);\n      res.status(500).json({ message: \"Failed to process availability file\" });\n    }\n  });\n\n  // Weather API endpoints\n  app.get(\"/api/weather/spc-outlook\", async (req, res) => {\n    try {\n      const { days = \"1,2,3\", risks = \"ENH,MDT,HIGH\" } = req.query;\n      const dayList = (days as string).split(',').map(d => parseInt(d.trim()));\n      const riskList = (risks as string).split(',').map(r => r.trim());\n\n      console.log('Fetching SPC outlook for days:', dayList, 'risks:', riskList);\n\n      const combinedOutlook = await fetchSPCOutlook(dayList);\n      console.log('SPC outlook result:', combinedOutlook.features.length, 'features');\n\n      res.json(combinedOutlook);\n    } catch (error) {\n      console.error('SPC Outlook fetch error:', error);\n      res.status(500).json({ message: \"Failed to fetch SPC outlook data\" });\n    }\n  });\n\n  // Custom utility data storage - use file system for persistence\n  const UTILITY_DATA_FILE = path.join(process.cwd(), 'data', 'custom_utility_data.json');\n\n  // Ensure data directory exists\n  const dataDir = path.dirname(UTILITY_DATA_FILE);\n  if (!await fs.access(dataDir).then(() => true).catch(() => false)) {\n    await fs.mkdir(dataDir, { recursive: true });\n  }\n\n  // Helper function to load custom utility data\n  async function loadCustomUtilityData() {\n    try {\n      const data = await fs.readFile(UTILITY_DATA_FILE, 'utf8');\n      return JSON.parse(data);\n    } catch (error) {\n      return null; // File doesn't exist or is invalid\n    }\n  }\n\n  // Helper function to save custom utility data\n  async function saveCustomUtilityData(data: any) {\n    await fs.writeFile(UTILITY_DATA_FILE, JSON.stringify(data, null, 2));\n  }\n\n  // Endpoint to upload custom electric utility GeoJSON data\n  app.post(\"/api/weather/electric-utilities\", async (req, res) => {\n    try {\n      const data = req.body;\n\n      // Validate GeoJSON structure\n      if (!data || data.type !== \"FeatureCollection\" || !Array.isArray(data.features)) {\n        return res.status(400).json({\n          error: \"Invalid GeoJSON format. Expected FeatureCollection with features array.\"\n        });\n      }\n\n      // Validate features have required properties\n      const invalidFeatures = data.features.filter((feature: any) => {\n        return !feature.geometry || !feature.properties || \n               (!feature.properties.NAME && !feature.properties.name && !feature.properties.COMPANY);\n      });\n\n      if (invalidFeatures.length > 0) {\n        return res.status(400).json({\n          error: \"Some features missing required properties. Each feature needs geometry and properties with NAME/name/COMPANY field.\"\n        });\n      }\n\n      // Store the custom data persistently\n      await saveCustomUtilityData(data);\n      console.log(`Custom electric utility data uploaded: ${data.features.length} utilities`);\n\n      res.json({\n        message: \"Electric utility data uploaded successfully\",\n        featureCount: data.features.length,\n        timestamp: new Date().toISOString()\n      });\n    } catch (error) {\n      console.error('Error uploading custom utility data:', error);\n      res.status(500).json({\n        error: \"Failed to upload utility data\",\n        details: error instanceof Error ? error.message : 'Unknown error'\n      });\n    }\n  });\n\n  app.get(\"/api/weather/electric-utilities\", async (req, res) => {\n    try {\n      console.log('Electric utilities API called');\n\n      // Use custom data if available\n      const customUtilityData = await loadCustomUtilityData();\n      if (customUtilityData) {\n        console.log(`Returning custom utility data: ${customUtilityData.features?.length || 0} utilities`);\n        res.json({\n          ...customUtilityData,\n          source: \"custom\",\n          message: \"Using custom uploaded utility data\"\n        });\n        return;\n      }\n\n      // Fall back to external APIs\n      const utilities = await fetchElectricUtilities();\n\n      // Check if this is fallback data\n      if (utilities.fallback) {\n        console.log('Returning fallback utility data for deployment compatibility');\n        res.json({\n          ...utilities,\n          message: \"Using cached utility data - external APIs unavailable in deployment environment\"\n        });\n      } else {\n        console.log(`Returning live utility data: ${utilities.features?.length || 0} utilities`);\n        res.json(utilities);\n      }\n    } catch (error) {\n      console.error('Electric utilities fetch error:', error);\n\n      // This should not happen with the new fallback system, but provide safety net\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error occurred';\n      console.log(`Electric utilities API completely failed: ${errorMessage}`);\n\n      const fallbackResponse = {\n        type: \"FeatureCollection\",\n        features: [],\n        error: {\n          message: \"Electric utilities data temporarily unavailable\",\n          details: errorMessage,\n          timestamp: new Date().toISOString(),\n          suggestion: \"All utility data sources failed. Contact support if this persists.\"\n        }\n      };\n\n      res.json(fallbackResponse);\n    }\n  });\n\n  app.post(\"/api/weather/affected-utilities\", async (req, res) => {\n    try {\n      const { outlookGeojson } = req.body;\n      if (!outlookGeojson) {\n        return res.status(400).json({ message: \"Outlook GeoJSON data is required\" });\n      }\n\n      const affectedUtilities = await calculateAffectedUtilities(outlookGeojson);\n      res.json(affectedUtilities);\n    } catch (error) {\n      console.error('Affected utilities calculation error:', error);\n      res.status(500).json({ message: \"Failed to calculate affected utilities\" });\n    }\n  });\n\n  // Geocoding endpoint for city/state validation\n  app.post(\"/api/geocode\", async (req, res) => {\n    try {\n      const { location, city, state } = req.body;\n      \n      // Support both old format (single location string) and new format (city + state)\n      let searchQuery: string;\n      if (city && state) {\n        searchQuery = `${city}, ${state}`;\n      } else if (location && typeof location === 'string') {\n        searchQuery = location;\n      } else {\n        return res.status(400).json({ \n          success: false,\n          message: \"Either location string or city and state are required\" \n        });\n      }\n\n      // Use Mapbox Geocoding API v6 - cost-effective (100k free requests/month)\n      const mapboxToken = process.env.MAPBOX_ACCESS_TOKEN;\n      if (!mapboxToken) {\n        throw new Error('Mapbox access token not configured');\n      }\n\n      const encodedQuery = encodeURIComponent(searchQuery);\n      const mapboxUrl = `https://api.mapbox.com/search/geocode/v6/forward?q=${encodedQuery}&country=us&limit=1&access_token=${mapboxToken}`;\n      \n      const response = await fetch(mapboxUrl);\n\n      if (!response.ok) {\n        throw new Error('Geocoding service unavailable');\n      }\n\n      const data = await response.json();\n\n      if (!data.features || data.features.length === 0) {\n        return res.json({ \n          success: false,\n          message: \"Location not found. Please enter a valid city and state (e.g., 'Atlanta, GA')\" \n        });\n      }\n\n      const result = data.features[0];\n      const [longitude, latitude] = result.geometry.coordinates;\n      \n      res.json({\n        success: true,\n        latitude: latitude,\n        longitude: longitude,\n        displayName: result.properties.full_address || result.properties.name || searchQuery\n      });\n\n    } catch (error) {\n      console.error('Geocoding error:', error);\n      res.status(500).json({ \n        success: false,\n        message: \"Failed to validate location\" \n      });\n    }\n  });\n\n  // Batch distance calculation endpoint for availability management\n  app.post(\"/api/calculate-distances\", async (req, res) => {\n    try {\n      const { contractors, destinations } = req.body;\n\n      if (!Array.isArray(contractors) || !Array.isArray(destinations)) {\n        return res.status(400).json({ \n          message: \"contractors and destinations arrays are required\" \n        });\n      }\n\n      if (destinations.length === 0) {\n        return res.status(400).json({ \n          message: \"At least one destination is required\" \n        });\n      }\n\n      // Geocode destinations first using Mapbox Geocoding API (in parallel)\n      const mapboxToken = process.env.MAPBOX_ACCESS_TOKEN;\n      const destinationGeocodes = await Promise.all(\n        destinations.map(async (location) => {\n          try {\n            const encodedQuery = encodeURIComponent(location);\n            const geocodeUrl = `https://api.mapbox.com/search/geocode/v6/forward?q=${encodedQuery}&country=us&limit=1&access_token=${mapboxToken}`;\n            \n            const response = await fetch(geocodeUrl);\n            const data = await response.json();\n\n            if (!data.features || data.features.length === 0) {\n              console.error(`Mapbox Geocoding failed for ${location}: No results`);\n              return null;\n            }\n\n            const result = data.features[0];\n            const [longitude, latitude] = result.geometry.coordinates;\n            const formattedAddress = result.properties.full_address || result.properties.name || location;\n            \n            console.log(`Geocoded \"${location}\" -> ${formattedAddress}`);\n\n            return {\n              location,\n              latitude: latitude,\n              longitude: longitude,\n              formatted_address: formattedAddress\n            };\n          } catch (error) {\n            console.error(`Geocoding error for ${location}:`, error);\n            return null;\n          }\n        })\n      );\n\n      // Filter out failed geocodes\n      const validDestinations = destinationGeocodes.filter(d => d !== null);\n\n      if (validDestinations.length === 0) {\n        return res.status(400).json({ \n          message: \"Could not geocode any destinations. Please check the location names.\" \n        });\n      }\n\n      // Log which destinations were successfully geocoded\n      console.log(`Successfully geocoded ${validDestinations.length} of ${destinations.length} destinations`);\n\n      // Process each contractor in parallel\n      const results = await Promise.all(\n        contractors.map(async (contractor) => {\n          try {\n            // Get contractor coordinates\n            let contractorLat = contractor.departureLatitude;\n            let contractorLng = contractor.departureLongitude;\n\n            // If no coordinates, geocode the departure location using Mapbox\n            if (!contractorLat || !contractorLng) {\n              if (!contractor.departureLocation) {\n                return { ...contractor, error: \"No departure location\" };\n              }\n\n              try {\n                const encodedQuery = encodeURIComponent(contractor.departureLocation);\n                const geocodeUrl = `https://api.mapbox.com/search/geocode/v6/forward?q=${encodedQuery}&country=us&limit=1&access_token=${mapboxToken}`;\n                \n                const response = await fetch(geocodeUrl);\n                const data = await response.json();\n\n                if (data.features && data.features.length > 0) {\n                  const [longitude, latitude] = data.features[0].geometry.coordinates;\n                  contractorLat = latitude;\n                  contractorLng = longitude;\n                }\n              } catch (error) {\n                console.error(`Error geocoding contractor location ${contractor.departureLocation}:`, error);\n              }\n            }\n\n            if (!contractorLat || !contractorLng) {\n              return { ...contractor, error: \"Could not geocode contractor location\" };\n            }\n\n            // Calculate routes to all destinations in parallel\n            const routePromises = validDestinations.map(async (dest, index) => {\n              const from = { \n                latitude: contractorLat, \n                longitude: contractorLng,\n                label: '',\n                id: 0,\n                createdAt: null,\n                sessionId: ''\n              };\n              const to = { \n                latitude: dest.latitude, \n                longitude: dest.longitude,\n                name: dest.location,\n                type: 'destination',\n                id: index,\n                description: null,\n                properties: {},\n                createdAt: null\n              };\n\n              try {\n                const route = await routingService.calculateRoute(from, to);\n                \n                // Convert meters to miles\n                const distanceMiles = route.distance * 0.000621371;\n                \n                // Calculate travel time at 55mph (company vehicle speed limit)\n                const travelTimeHours55mph = distanceMiles / 55;\n                \n                // Round travel time UP to nearest whole hour\n                const travelTimeHours = Math.ceil(travelTimeHours55mph);\n                \n                return {\n                  index,\n                  distance: distanceMiles.toFixed(1),\n                  duration: route.duration,\n                  durationFormatted: `${travelTimeHours} ${travelTimeHours === 1 ? 'hour' : 'hours'}`,\n                  durationHours: travelTimeHours.toString()\n                };\n              } catch (error) {\n                console.error(`Route calculation error for contractor ${contractor.id}:`, error);\n                return null;\n              }\n            });\n\n            const routes = await Promise.all(routePromises);\n            \n            // Build result object with distances and times for each destination\n            const result: any = { ...contractor };\n            \n            routes.forEach((route, index) => {\n              if (route) {\n                result[`distance_${index}`] = route.distance;\n                result[`travelTime_${index}`] = route.durationFormatted;\n                result[`travelTimeHours_${index}`] = route.durationHours;\n              }\n            });\n\n            return result;\n          } catch (error) {\n            console.error(`Error processing contractor ${contractor.id}:`, error);\n            return { ...contractor, error: \"Processing failed\" };\n          }\n        })\n      );\n\n      // Sort by distance to first destination\n      results.sort((a, b) => {\n        const aDistance = parseFloat(a.distance_0) || Infinity;\n        const bDistance = parseFloat(b.distance_0) || Infinity;\n        return aDistance - bDistance;\n      });\n\n      res.json({\n        results,\n        destinations: validDestinations.map(d => d.location),\n        calculatedAt: new Date().toISOString()\n      });\n\n    } catch (error) {\n      console.error('Batch distance calculation error:', error);\n      res.status(500).json({ \n        message: \"Failed to calculate distances\",\n        error: error instanceof Error ? error.message : 'Unknown error'\n      });\n    }\n  });\n\n  // Migration endpoint to populate pending review contractors with departure locations\n  app.post(\"/api/contractors/migrate-locations\", async (req, res) => {\n    try {\n      const pendingReviewContractors = await storage.getAllContractors();\n      const needsMigration = pendingReviewContractors.filter(c => c.needsReview);\n      \n      let migratedCount = 0;\n      let skippedCount = 0;\n      const results = [];\n      \n      for (const contractor of needsMigration) {\n        // Get all crew availability submissions for this contractor\n        const submissions = await storage.getCrewAvailabilityByContractor(contractor.id);\n        \n        if (submissions.length === 0) {\n          skippedCount++;\n          continue;\n        }\n        \n        // Collect unique departure locations\n        const locationMap = new Map();\n        for (const submission of submissions) {\n          if (submission.departureLocation && submission.departureLocation.trim()) {\n            const key = submission.departureLocation.toLowerCase().trim();\n            if (!locationMap.has(key)) {\n              locationMap.set(key, {\n                location: submission.departureLocation,\n                latitude: submission.departureLatitude || null,\n                longitude: submission.departureLongitude || null\n              });\n            }\n          }\n        }\n        \n        const locations = Array.from(locationMap.values());\n        \n        if (locations.length === 0) {\n          skippedCount++;\n          continue;\n        }\n        \n        // Find first location with coordinates for primary location\n        const primaryLocation = locations.find(l => l.latitude && l.longitude) || locations[0];\n        \n        // Update contractor\n        const updates: any = {\n          departureLocations: locations\n        };\n        \n        // Set primary coordinates if available and contractor doesn't have them\n        if (primaryLocation.latitude && primaryLocation.longitude) {\n          if (!contractor.latitude || !contractor.longitude || contractor.latitude === 0 || contractor.longitude === 0) {\n            updates.latitude = primaryLocation.latitude;\n            updates.longitude = primaryLocation.longitude;\n          }\n        }\n        \n        // Set address if not present\n        if (!contractor.fullAddress || contractor.fullAddress.trim() === '') {\n          updates.fullAddress = primaryLocation.location;\n        }\n        \n        await storage.updateContractor(contractor.id, updates);\n        \n        migratedCount++;\n        results.push({\n          id: contractor.id,\n          company: contractor.company,\n          locationsAdded: locations.length,\n          primaryLocation: primaryLocation.location,\n          coordinatesSet: !!(updates.latitude && updates.longitude)\n        });\n      }\n      \n      res.json({\n        success: true,\n        migratedCount,\n        skippedCount,\n        totalPendingReview: needsMigration.length,\n        results\n      });\n    } catch (error: any) {\n      console.error('Migration error:', error);\n      res.status(500).json({ error: error.message || \"Failed to migrate locations\" });\n    }\n  });\n\n  // ===== TICKETING MODULE ROUTES =====\n\n  // Helper: check if user can access a ticket\n  function canAccessTicket(user: any, ticket: any): boolean {\n    if (!user) return false;\n    if (user.role === 'ADMIN' || user.role === 'MANAGER' || user.role === 'UTILITY') return true;\n    if (user.role === 'CONTRACTOR' && user.companyId && ticket.companyId === user.companyId) return true;\n    return false;\n  }\n\n  // Valid status transitions\n  const VALID_TRANSITIONS: Record<string, string[]> = {\n    CREATED: ['ASSIGNED', 'CANCELLED'],\n    ASSIGNED: ['ACCEPTED', 'CANCELLED'],\n    ACCEPTED: ['ENROUTE', 'ON_SITE', 'WORKING', 'CANCELLED'],\n    ENROUTE: ['ON_SITE', 'WORKING', 'BLOCKED', 'CANCELLED'],\n    ON_SITE: ['WORKING', 'COMPLETED', 'BLOCKED', 'CANCELLED'],\n    WORKING: ['COMPLETED', 'BLOCKED', 'CANCELLED'],\n    BLOCKED: ['WORKING', 'CANCELLED', 'CLOSED'],\n    COMPLETED: ['CLOSED'],\n  };\n\n  // Issue Types CRUD\n  app.get(\"/api/issue-types\", requireAuth, async (req, res) => {\n    try {\n      const issueTypes = await storage.getAllIssueTypes();\n      res.json(issueTypes);\n    } catch (error: any) {\n      console.error('Error fetching issue types:', error);\n      res.status(500).json({ message: error.message || \"Failed to fetch issue types\" });\n    }\n  });\n\n  app.post(\"/api/issue-types\", requireAuth, requireManager, async (req, res) => {\n    try {\n      const parsed = insertIssueTypeSchema.parse(req.body);\n      const issueType = await storage.createIssueType(parsed);\n      await createAuditLog({ action: 'issue_type.create', entityType: 'issue_types', entityId: issueType.id, details: parsed, context: getAuditContext(req) });\n      res.status(201).json(issueType);\n    } catch (error: any) {\n      console.error('Error creating issue type:', error);\n      res.status(400).json({ message: error.message || \"Failed to create issue type\" });\n    }\n  });\n\n  app.patch(\"/api/issue-types/:id\", requireAuth, requireManager, async (req, res) => {\n    try {\n      const result = await storage.updateIssueType(req.params.id, req.body);\n      if (!result) return res.status(404).json({ message: \"Issue type not found\" });\n      res.json(result);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message || \"Failed to update issue type\" });\n    }\n  });\n\n  // Tickets CRUD\n  app.get(\"/api/tickets\", requireAuth, async (req, res) => {\n    try {\n      const { sessionId, companyId } = req.query;\n      let ticketList: any[] = [];\n\n      if (sessionId) {\n        ticketList = await storage.getTicketsBySession(sessionId as string);\n      } else if (companyId) {\n        ticketList = await storage.getTicketsByCompany(companyId as string);\n      } else if (req.authenticatedUser?.role === 'CONTRACTOR' && req.authenticatedUser.companyId) {\n        ticketList = await storage.getTicketsByCompany(req.authenticatedUser.companyId);\n      } else {\n        // For MANAGER/UTILITY, return empty unless filtered\n        ticketList = [];\n      }\n\n      res.json(ticketList);\n    } catch (error: any) {\n      console.error('Error fetching tickets:', error);\n      res.status(500).json({ message: error.message || \"Failed to fetch tickets\" });\n    }\n  });\n\n  app.get(\"/api/tickets/:id\", requireAuth, async (req, res) => {\n    try {\n      const ticket = await storage.getTicket(req.params.id);\n      if (!ticket) return res.status(404).json({ message: \"Ticket not found\" });\n      if (!canAccessTicket(req.authenticatedUser, ticket)) return res.status(403).json({ message: \"Forbidden\" });\n      res.json(ticket);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message || \"Failed to fetch ticket\" });\n    }\n  });\n\n  app.post(\"/api/tickets\", requireAuth, requireManagerOrUtility, async (req, res) => {\n    try {\n      const parsed = insertTicketSchema.parse({\n        ...req.body,\n        createdByUserId: req.authenticatedUser!.id,\n      });\n      const ticket = await storage.createTicket(parsed);\n\n      // Create initial status event\n      await storage.createTicketStatusEvent({\n        ticketId: ticket.id,\n        oldStatus: null,\n        newStatus: 'CREATED',\n        changedByUserId: req.authenticatedUser!.id,\n        note: 'Ticket created',\n      });\n\n      await createAuditLog({ action: 'ticket.create', entityType: 'tickets', entityId: ticket.id, details: { title: ticket.title, sessionId: ticket.sessionId }, context: getAuditContext(req) });\n      res.status(201).json(ticket);\n    } catch (error: any) {\n      console.error('Error creating ticket:', error);\n      res.status(400).json({ message: error.message || \"Failed to create ticket\" });\n    }\n  });\n\n  app.patch(\"/api/tickets/:id\", requireAuth, requireManagerOrUtility, async (req, res) => {\n    try {\n      const ticket = await storage.getTicket(req.params.id);\n      if (!ticket) return res.status(404).json({ message: \"Ticket not found\" });\n\n      const result = await storage.updateTicket(req.params.id, req.body);\n      res.json(result);\n    } catch (error: any) {\n      res.status(400).json({ message: error.message || \"Failed to update ticket\" });\n    }\n  });\n\n  // Ticket status update with work segment logic\n  app.post(\"/api/tickets/:id/status\", requireAuth, async (req, res) => {\n    try {\n      const ticket = await storage.getTicket(req.params.id);\n      if (!ticket) return res.status(404).json({ message: \"Ticket not found\" });\n      if (!canAccessTicket(req.authenticatedUser, ticket)) return res.status(403).json({ message: \"Forbidden\" });\n\n      const { status, note } = req.body;\n      if (!status) return res.status(400).json({ message: \"Status is required\" });\n\n      const oldStatus = ticket.status;\n\n      // Validate transition\n      const allowed = VALID_TRANSITIONS[oldStatus || 'CREATED'] || [];\n      if (!allowed.includes(status)) {\n        return res.status(400).json({ message: `Invalid status transition from ${oldStatus} to ${status}` });\n      }\n      const workingStates = ['ON_SITE', 'WORKING'];\n      const exitStates = ['COMPLETED', 'BLOCKED', 'CANCELLED', 'CLOSED'];\n\n      // Get active assignment to find crew\n      const activeAssignment = await storage.getActiveTicketAssignment(ticket.id);\n\n      // Handle work segment logic\n      if (activeAssignment) {\n        if (workingStates.includes(status) && !workingStates.includes(oldStatus!)) {\n          // Entering working state - create segment\n          const existing = await storage.getOpenWorkSegment(ticket.id, activeAssignment.crewId);\n          if (!existing) {\n            await storage.createTicketWorkSegment({\n              ticketId: ticket.id,\n              sessionId: ticket.sessionId,\n              companyId: activeAssignment.companyId,\n              crewId: activeAssignment.crewId,\n              startedAt: new Date(),\n              createdByUserId: req.authenticatedUser!.id,\n            });\n          }\n        } else if (exitStates.includes(status) && workingStates.includes(oldStatus!)) {\n          // Exiting working state - close segment\n          const openSegment = await storage.getOpenWorkSegment(ticket.id, activeAssignment.crewId);\n          if (openSegment) {\n            await storage.closeWorkSegment(openSegment.id);\n          }\n        }\n      }\n\n      // Update ticket status\n      const updates: any = { status };\n      if (exitStates.includes(status)) {\n        updates.closedAt = new Date();\n      }\n      const updatedTicket = await storage.updateTicket(ticket.id, updates);\n\n      // Create status event\n      await storage.createTicketStatusEvent({\n        ticketId: ticket.id,\n        oldStatus,\n        newStatus: status,\n        changedByUserId: req.authenticatedUser!.id,\n        note: note || null,\n      });\n\n      await createAuditLog({ action: 'ticket.status_change', entityType: 'tickets', entityId: ticket.id, details: { oldStatus, newStatus: status }, context: getAuditContext(req) });\n      res.json(updatedTicket);\n    } catch (error: any) {\n      console.error('Error updating ticket status:', error);\n      res.status(500).json({ message: error.message || \"Failed to update ticket status\" });\n    }\n  });\n\n  // Ticket assignments\n  app.get(\"/api/tickets/:id/assignments\", requireAuth, async (req, res) => {\n    try {\n      const ticket = await storage.getTicket(req.params.id);\n      if (!ticket) return res.status(404).json({ message: \"Ticket not found\" });\n      if (!canAccessTicket(req.authenticatedUser, ticket)) return res.status(403).json({ message: \"Forbidden\" });\n      const assignments = await storage.getTicketAssignments(req.params.id);\n      res.json(assignments);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message || \"Failed to fetch assignments\" });\n    }\n  });\n\n  app.post(\"/api/tickets/:id/assign\", requireAuth, requireManagerOrUtility, async (req, res) => {\n    try {\n      const ticket = await storage.getTicket(req.params.id);\n      if (!ticket) return res.status(404).json({ message: \"Ticket not found\" });\n\n      const { companyId, crewId } = req.body;\n      if (!companyId || !crewId) return res.status(400).json({ message: \"companyId and crewId are required\" });\n\n      // Deactivate any existing active assignment\n      const existing = await storage.getActiveTicketAssignment(ticket.id);\n      if (existing) {\n        await storage.updateTicketAssignment(existing.id, { isActive: false, status: 'REASSIGNED' });\n      }\n\n      const assignment = await storage.createTicketAssignment({\n        ticketId: ticket.id,\n        companyId,\n        crewId,\n        status: 'PENDING_ACCEPT',\n        assignedByUserId: req.authenticatedUser!.id,\n        isActive: true,\n      });\n\n      // Update ticket status and company\n      await storage.updateTicket(ticket.id, { status: 'ASSIGNED', companyId });\n\n      // Create status event\n      await storage.createTicketStatusEvent({\n        ticketId: ticket.id,\n        oldStatus: ticket.status,\n        newStatus: 'ASSIGNED',\n        changedByUserId: req.authenticatedUser!.id,\n        note: `Assigned to crew`,\n      });\n\n      await createAuditLog({ action: 'ticket.assign', entityType: 'ticket_assignments', entityId: assignment.id, details: { ticketId: ticket.id, companyId, crewId }, context: getAuditContext(req) });\n      res.status(201).json(assignment);\n    } catch (error: any) {\n      console.error('Error assigning ticket:', error);\n      res.status(500).json({ message: error.message || \"Failed to assign ticket\" });\n    }\n  });\n\n  // Accept/Reject assignment\n  app.post(\"/api/ticket-assignments/:id/respond\", requireAuth, async (req, res) => {\n    try {\n      const { action, note } = req.body;\n      if (!action || !['accept', 'reject'].includes(action)) {\n        return res.status(400).json({ message: \"action must be 'accept' or 'reject'\" });\n      }\n\n      const assignments = await db.select().from(ticketAssignments).where(eq(ticketAssignments.id, req.params.id));\n      const assignment = assignments[0];\n      if (!assignment) return res.status(404).json({ message: \"Assignment not found\" });\n\n      // Only the assigned company can respond\n      if (req.authenticatedUser?.role === 'CONTRACTOR' && req.authenticatedUser.companyId !== assignment.companyId) {\n        return res.status(403).json({ message: \"Forbidden: assignment belongs to another company\" });\n      }\n\n      if (assignment.status !== 'PENDING_ACCEPT') {\n        return res.status(400).json({ message: \"Assignment has already been responded to\" });\n      }\n\n      const ticket = await storage.getTicket(assignment.ticketId);\n      if (!ticket) return res.status(404).json({ message: \"Ticket not found\" });\n\n      if (action === 'accept') {\n        await storage.updateTicketAssignment(assignment.id, {\n          status: 'ACCEPTED',\n          respondedAt: new Date(),\n          responseNote: note || null,\n        });\n        await storage.updateTicket(ticket.id, { status: 'ACCEPTED' });\n        await storage.createTicketStatusEvent({\n          ticketId: ticket.id,\n          oldStatus: ticket.status,\n          newStatus: 'ACCEPTED',\n          changedByUserId: req.authenticatedUser!.id,\n          note: 'Assignment accepted',\n        });\n      } else {\n        await storage.updateTicketAssignment(assignment.id, {\n          status: 'REJECTED',\n          respondedAt: new Date(),\n          responseNote: note || null,\n        });\n        await storage.createTicketStatusEvent({\n          ticketId: ticket.id,\n          oldStatus: ticket.status,\n          newStatus: ticket.status!,\n          changedByUserId: req.authenticatedUser!.id,\n          note: `Assignment rejected: ${note || 'No reason provided'}`,\n        });\n      }\n\n      const updated = await storage.getTicket(ticket.id);\n      res.json(updated);\n    } catch (error: any) {\n      console.error('Error responding to assignment:', error);\n      res.status(500).json({ message: error.message || \"Failed to respond to assignment\" });\n    }\n  });\n\n  // Ticket status events (timeline)\n  app.get(\"/api/tickets/:id/events\", requireAuth, async (req, res) => {\n    try {\n      const ticket = await storage.getTicket(req.params.id);\n      if (!ticket) return res.status(404).json({ message: \"Ticket not found\" });\n      if (!canAccessTicket(req.authenticatedUser, ticket)) return res.status(403).json({ message: \"Forbidden\" });\n      const events = await storage.getTicketStatusEvents(req.params.id);\n      res.json(events);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message || \"Failed to fetch status events\" });\n    }\n  });\n\n  // Ticket work segments\n  app.get(\"/api/tickets/:id/segments\", requireAuth, async (req, res) => {\n    try {\n      const ticket = await storage.getTicket(req.params.id);\n      if (!ticket) return res.status(404).json({ message: \"Ticket not found\" });\n      if (!canAccessTicket(req.authenticatedUser, ticket)) return res.status(403).json({ message: \"Forbidden\" });\n      const segments = await storage.getWorkSegmentsByTicket(req.params.id);\n      res.json(segments);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message || \"Failed to fetch work segments\" });\n    }\n  });\n\n  // Notifications\n  app.get(\"/api/notifications\", requireAuth, async (req, res) => {\n    try {\n      const notifs = await storage.getNotificationsByUser(req.authenticatedUser!.id);\n      res.json(notifs);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message || \"Failed to fetch notifications\" });\n    }\n  });\n\n  app.patch(\"/api/notifications/:id/read\", requireAuth, async (req, res) => {\n    try {\n      const result = await storage.markNotificationRead(req.params.id);\n      if (!result) return res.status(404).json({ message: \"Notification not found\" });\n      res.json(result);\n    } catch (error: any) {\n      res.status(500).json({ message: error.message || \"Failed to mark notification read\" });\n    }\n  });\n\n  const httpServer = createServer(app);\n  return httpServer;\n}\n\nfunction generateCSV(calculations: any[], options: any = {}): string {\n  const headers = ['Resource Name', 'Type'];\n\n  if (options.includeDistances !== false) {\n    headers.push('Distance (miles)');\n  }\n\n  if (options.includeTimes !== false) {\n    headers.push('Travel Time (minutes)');\n  }\n\n  headers.push('Latitude', 'Longitude');\n\n  const rows = calculations.map(calc => {\n    const row = [\n      calc.resource.name,\n      calc.resource.type,\n    ];\n\n    if (options.includeDistances !== false) {\n      row.push(calc.distance.toFixed(2));\n    }\n\n    if (options.includeTimes !== false) {\n      row.push(Math.round(calc.duration / 60).toString());\n    }\n\n    row.push(calc.resource.latitude.toString(), calc.resource.longitude.toString());\n\n    return row;\n  });\n\n  return [headers, ...rows].map(row => row.join(',')).join('\\n');\n}\n\nfunction formatDuration(seconds: number): string {\n  const minutes = Math.round(seconds / 60);\n  const hours = Math.floor(minutes / 60);\n  const remainingMinutes = minutes % 60;\n\n  if (hours > 0) {\n    return `${hours}h ${remainingMinutes}m`;\n  }\n  return `${minutes}m`;\n}","path":null,"size_bytes":281576,"size_tokens":null},"client/src/components/ui/dialog.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as DialogPrimitive from \"@radix-ui/react-dialog\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Dialog = DialogPrimitive.Root\n\nconst DialogTrigger = DialogPrimitive.Trigger\n\nconst DialogPortal = DialogPrimitive.Portal\n\nconst DialogClose = DialogPrimitive.Close\n\nconst DialogOverlay = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Overlay\n    ref={ref}\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogOverlay.displayName = DialogPrimitive.Overlay.displayName\n\nconst DialogContent = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DialogPortal>\n    <DialogOverlay />\n    <DialogPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <DialogPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </DialogPrimitive.Close>\n    </DialogPrimitive.Content>\n  </DialogPortal>\n))\nDialogContent.displayName = DialogPrimitive.Content.displayName\n\nconst DialogHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-1.5 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogHeader.displayName = \"DialogHeader\"\n\nconst DialogFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nDialogFooter.displayName = \"DialogFooter\"\n\nconst DialogTitle = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDialogTitle.displayName = DialogPrimitive.Title.displayName\n\nconst DialogDescription = React.forwardRef<\n  React.ElementRef<typeof DialogPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DialogPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DialogPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDialogDescription.displayName = DialogPrimitive.Description.displayName\n\nexport {\n  Dialog,\n  DialogPortal,\n  DialogOverlay,\n  DialogClose,\n  DialogTrigger,\n  DialogContent,\n  DialogHeader,\n  DialogFooter,\n  DialogTitle,\n  DialogDescription,\n}\n","path":null,"size_bytes":3848,"size_tokens":null},"client/src/pages/map.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport AppHeader from \"@/components/AppHeader\";\nimport Sidebar from \"@/components/Sidebar\";\nimport MapContainer from \"@/components/MapContainer\";\nimport ResultsTable from \"@/components/ResultsTable\";\nimport ExportModal from \"@/components/ExportModal\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Button } from \"@/components/ui/button\";\nimport { Menu, X } from \"lucide-react\";\nimport { useMapData } from \"@/hooks/useMapData\";\nimport type { Contractor } from \"@shared/schema\";\n\nexport default function MapPage() {\n  const [isExportModalOpen, setIsExportModalOpen] = useState(false);\n  const [selectedPointId, setSelectedPointId] = useState<number | null>(null);\n  const [isSelectingPoint, setIsSelectingPoint] = useState(false);\n  const [closestDistance, setClosestDistance] = useState<number | null>(null);\n  const [maxDistance, setMaxDistance] = useState<number | null>(null);\n  const [maxHours, setMaxHours] = useState<number | null>(null);\n  const [isSidebarOpen, setIsSidebarOpen] = useState(typeof window !== 'undefined' && window.innerWidth >= 768);\n  const [isOutlookLayerVisible, setIsOutlookLayerVisible] = useState(false);\n  const [isUtilitiesLayerVisible, setIsUtilitiesLayerVisible] = useState(false);\n  const [visibleDays, setVisibleDays] = useState<{ [key: number]: boolean }>({\n    1: true,\n    2: true,\n    3: true\n  });\n  const { \n    resources, \n    analysisPoints, \n    uploadFile, \n    createAnalysisPoint, \n    deleteAnalysisPoint,\n    calculateDistances,\n    isLoading \n  } = useMapData((pointId) => setSelectedPointId(pointId));\n\n  // Fetch contractors to display their departure locations on the map\n  const { data: contractors = [] } = useQuery<Contractor[]>({\n    queryKey: [\"/api/contractors\"],\n  });\n\n  const handleCreatePoint = (point: { label: string; latitude: number; longitude: number }) => {\n    createAnalysisPoint(point);\n    setIsSelectingPoint(false);\n  };\n\n  const handleRecalculateDistances = (pointId: number, maxDistance?: number) => {\n    // Check if point still exists before calculating\n    const pointExists = analysisPoints.some(p => p.id === pointId);\n    if (!pointExists) {\n      console.error('Cannot recalculate: analysis point no longer exists');\n      return;\n    }\n    calculateDistances({ pointId, maxDistance });\n  };\n\n  const handleToggleDay = (day: number, enabled: boolean) => {\n    setVisibleDays(prev => ({\n      ...prev,\n      [day]: enabled\n    }));\n  };\n\n  const handleToggleOutlookLayer = (enabled: boolean) => {\n    setIsOutlookLayerVisible(enabled);\n    // Auto-enable all days when turning on SPC outlook\n    if (enabled) {\n      setVisibleDays({ 1: true, 2: true, 3: true });\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <AppHeader />\n      \n      {/* Main content area with proper mobile spacing */}\n      <div className=\"pt-14 sm:pt-16 h-screen flex flex-col\">\n        <div className=\"flex-1 flex relative overflow-hidden\">\n          {/* Sidebar - Responsive */}\n          <div className={`\n            ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} \n            fixed md:relative z-[9998] md:z-auto\n            w-80 md:w-80 \n            h-[calc(100vh-3.5rem)] sm:h-[calc(100vh-4rem)] md:h-full\n            top-14 sm:top-16 md:top-0\n            transition-transform duration-300 ease-in-out\n            md:transform-none\n            bg-white shadow-lg md:shadow-none\n            overflow-y-auto\n          `}>\n            <Sidebar\n              resources={resources}\n              analysisPoints={analysisPoints}\n              onUploadFile={uploadFile}\n              onCreatePoint={handleCreatePoint}\n              onDeletePoint={deleteAnalysisPoint}\n              onSelectPoint={setSelectedPointId}\n              selectedPointId={selectedPointId}\n              isLoading={isLoading}\n              isSelectingPoint={isSelectingPoint}\n              onTogglePointSelection={() => setIsSelectingPoint(!isSelectingPoint)}\n              onClosestDistanceChange={setClosestDistance}\n              onMaxDistanceChange={setMaxDistance}\n              onMaxHoursChange={setMaxHours}\n              onRecalculateDistances={handleRecalculateDistances}\n              onToggleOutlookLayer={setIsOutlookLayerVisible}\n              onToggleUtilitiesLayer={setIsUtilitiesLayerVisible}\n              isOutlookLayerVisible={isOutlookLayerVisible}\n              isUtilitiesLayerVisible={isUtilitiesLayerVisible}\n              visibleDays={visibleDays}\n              onToggleDay={handleToggleDay}\n            />\n          </div>\n\n          {/* Overlay for mobile when sidebar is open */}\n          {isSidebarOpen && (\n            <div \n              className=\"fixed inset-0 bg-black/20 z-[9997] md:hidden top-14 sm:top-16\"\n              onClick={() => setIsSidebarOpen(false)}\n            />\n          )}\n          \n          {/* Main content area */}\n          <div className=\"flex-1 flex flex-col overflow-hidden\">\n            <Tabs defaultValue=\"map\" className=\"flex-1 flex flex-col h-full overflow-hidden\">\n              {/* Tab header with sidebar toggle - Fixed positioning on mobile */}\n              <div className=\"fixed md:sticky top-14 sm:top-16 md:top-0 left-0 right-0 z-[9996] md:z-10 border-b bg-white px-2 sm:px-4 py-2 sm:py-3 flex items-center justify-between shadow-md\">\n                <div className=\"flex items-center gap-2 sm:gap-4\">\n                  {/* Mobile Sidebar Toggle */}\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    className=\"md:hidden min-h-[44px] px-3\"\n                    onClick={() => setIsSidebarOpen(!isSidebarOpen)}\n                  >\n                    {isSidebarOpen ? <X size={16} /> : <Menu size={16} />}\n                    <span className=\"ml-1 text-xs\">Tools</span>\n                  </Button>\n                  \n                  <TabsList className=\"grid w-full max-w-64 sm:max-w-80 grid-cols-2 h-10 sm:h-12 bg-gray-100 border-2 border-gray-200 shadow-md rounded-lg p-1\">\n                    <TabsTrigger value=\"map\" className=\"text-xs sm:text-sm font-semibold h-full data-[state=active]:bg-blue-600 data-[state=active]:text-white data-[state=active]:shadow-lg transition-all duration-200\">Map</TabsTrigger>\n                    <TabsTrigger value=\"table\" className=\"text-xs sm:text-sm font-semibold h-full data-[state=active]:bg-blue-600 data-[state=active]:text-white data-[state=active]:shadow-lg transition-all duration-200\">Results</TabsTrigger>\n                  </TabsList>\n                </div>\n                \n                {/* Desktop Sidebar Toggle */}\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  className=\"hidden md:flex items-center gap-2\"\n                  onClick={() => setIsSidebarOpen(!isSidebarOpen)}\n                >\n                  <Menu size={16} />\n                  {isSidebarOpen ? 'Hide' : 'Show'} Sidebar\n                </Button>\n              </div>\n              \n              <TabsContent value=\"map\" className=\"flex-1 m-0 p-0 h-full pt-16 md:pt-0\">\n                <div className=\"w-full h-full relative\">\n                  <MapContainer\n                    key=\"map-container\"\n                    resources={resources}\n                    analysisPoints={analysisPoints}\n                    contractors={contractors}\n                    selectedPointId={selectedPointId}\n                    onCreatePoint={handleCreatePoint}\n                    isSelectingPoint={isSelectingPoint}\n                    closestDistance={closestDistance}\n                    maxDistance={maxDistance}\n                    maxHours={maxHours}\n                    isOutlookLayerVisible={isOutlookLayerVisible}\n                    isUtilitiesLayerVisible={isUtilitiesLayerVisible}\n                    visibleDays={visibleDays}\n                  />\n                </div>\n              </TabsContent>\n              \n              <TabsContent value=\"table\" className=\"flex-1 m-0 p-2 sm:p-4 pt-16 md:pt-2\">\n                <ResultsTable\n                  analysisPoints={analysisPoints}\n                  selectedPointId={selectedPointId}\n                  onSelectPoint={setSelectedPointId}\n                  maxDistance={maxDistance}\n                  maxHours={maxHours}\n                />\n              </TabsContent>\n            </Tabs>\n          </div>\n        </div>\n      </div>\n\n      <ExportModal\n        isOpen={isExportModalOpen}\n        onClose={() => setIsExportModalOpen(false)}\n        selectedPointId={selectedPointId}\n      />\n    </div>\n  );\n}\n","path":null,"size_bytes":8680,"size_tokens":null},"client/src/components/ui/tabs.tsx":{"content":"import * as React from \"react\"\nimport * as TabsPrimitive from \"@radix-ui/react-tabs\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Tabs = TabsPrimitive.Root\n\nconst TabsList = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.List\n    ref={ref}\n    className={cn(\n      \"inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsList.displayName = TabsPrimitive.List.displayName\n\nconst TabsTrigger = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsTrigger.displayName = TabsPrimitive.Trigger.displayName\n\nconst TabsContent = React.forwardRef<\n  React.ElementRef<typeof TabsPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TabsPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <TabsPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2\",\n      className\n    )}\n    {...props}\n  />\n))\nTabsContent.displayName = TabsPrimitive.Content.displayName\n\nexport { Tabs, TabsList, TabsTrigger, TabsContent }\n","path":null,"size_bytes":1883,"size_tokens":null},"backup/CURRENT_BUILD_SNAPSHOT.md":{"content":"# Current Build Snapshot - June 27, 2025\n\n## Verified Working State\nThis snapshot captures the exact state of the working Interactive Map Analysis Application before new feature development.\n\n## Test Results Confirmation\n✅ Map displays 304 contractor resources correctly\n✅ Analysis points creation via address geocoding works (lawrence, ks and liberal, KS tested)\n✅ Distance calculations complete in ~1.3 seconds\n✅ Export functionality generates Excel files successfully\n✅ Contractors page CRUD operations working\n✅ Database persistence confirmed with PostgreSQL\n✅ File upload processing CSV/Excel formats correctly\n\n## Database Schema Snapshot\nCurrent tables:\n- resources (304 records)\n- contractors (multiple records)\n- analysis_points (can create/delete)\n- distance_calculations (auto-generated)\n- analysis_jobs (tracking functionality)\n\n## Package Dependencies Locked\nAll current package versions are working and should be preserved.\nSee package.json for exact versions.\n\n## Rollback Instructions\nIf new features break the application:\n1. Reference BUILD_BACKUP.md for feature list\n2. Check this snapshot for verified working state\n3. Compare current code against backup files\n4. Restore from backup/ directory if needed\n\nCreated: 2025-06-27 00:30:00 UTC\nStatus: STABLE_WORKING_BUILD","path":null,"size_bytes":1301,"size_tokens":null},"client/src/components/ui/toggle.tsx":{"content":"import * as React from \"react\"\nimport * as TogglePrimitive from \"@radix-ui/react-toggle\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst toggleVariants = cva(\n  \"inline-flex items-center justify-center rounded-md text-sm font-medium ring-offset-background transition-colors hover:bg-muted hover:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 gap-2\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-transparent\",\n        outline:\n          \"border border-input bg-transparent hover:bg-accent hover:text-accent-foreground\",\n      },\n      size: {\n        default: \"h-10 px-3 min-w-10\",\n        sm: \"h-9 px-2.5 min-w-9\",\n        lg: \"h-11 px-5 min-w-11\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nconst Toggle = React.forwardRef<\n  React.ElementRef<typeof TogglePrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof TogglePrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, ...props }, ref) => (\n  <TogglePrimitive.Root\n    ref={ref}\n    className={cn(toggleVariants({ variant, size, className }))}\n    {...props}\n  />\n))\n\nToggle.displayName = TogglePrimitive.Root.displayName\n\nexport { Toggle, toggleVariants }\n","path":null,"size_bytes":1527,"size_tokens":null},"server/storage.ts":{"content":"import { \n  resources, \n  analysisPoints, \n  distanceCalculations, \n  analysisJobs,\n  contractors,\n  contractorFiles,\n  contractorReviews,\n  users,\n  userCompanyAccess,\n  companies,\n  stormSessions,\n  sessionContractors,\n  rosters,\n  crews,\n  rosterPersonnel,\n  rosterEquipment,\n  timesheets,\n  timesheetPersonnel,\n  timesheetEquipment,\n  timesheetLines,\n  expenses,\n  expenseFiles,\n  invoices,\n  invoiceLines,\n  crewAvailability,\n  equipmentAvailability,\n  availabilitySubmissions,\n  availabilitySessions,\n  incidents,\n  incidentAssignments,\n  crewRosters,\n  type Resource, \n  type InsertResource,\n  type AnalysisPoint,\n  type InsertAnalysisPoint,\n  type DistanceCalculation,\n  type InsertDistanceCalculation,\n  type AnalysisJob,\n  type InsertAnalysisJob,\n  type Contractor,\n  type InsertContractor,\n  type ContractorFile,\n  type InsertContractorFile,\n  type ContractorReview,\n  type InsertContractorReview,\n  type User,\n  type UpsertUser,\n  type InsertUser,\n  type UserCompanyAccess,\n  type InsertUserCompanyAccess,\n  type Company,\n  type InsertCompany,\n  type StormSession,\n  type InsertStormSession,\n  type Roster,\n  type InsertRoster,\n  type Crew,\n  type InsertCrew,\n  type RosterPersonnel,\n  type InsertRosterPersonnel,\n  type RosterEquipment,\n  type InsertRosterEquipment,\n  type Timesheet,\n  type InsertTimesheet,\n  type TimesheetPersonnel,\n  type InsertTimesheetPersonnel,\n  type TimesheetEquipment,\n  type InsertTimesheetEquipment,\n  type TimesheetLine,\n  type InsertTimesheetLine,\n  type Expense,\n  type InsertExpense,\n  type ExpenseFile,\n  type InsertExpenseFile,\n  type Invoice,\n  type InsertInvoice,\n  type InvoiceLine,\n  type InsertInvoiceLine,\n  type CrewAvailability,\n  type InsertCrewAvailability,\n  type EquipmentAvailability,\n  type InsertEquipmentAvailability,\n  type AvailabilitySubmission,\n  type InsertAvailabilitySubmission,\n  type AvailabilitySession,\n  type InsertAvailabilitySession,\n  type Incident,\n  type InsertIncident,\n  type IncidentAssignment,\n  type InsertIncidentAssignment,\n  type CrewRoster,\n  type InsertCrewRoster,\n  issueTypes,\n  tickets,\n  ticketAssignments,\n  ticketStatusEvents,\n  ticketWorkSegments,\n  notifications,\n  type IssueType,\n  type InsertIssueType,\n  type Ticket,\n  type InsertTicket,\n  type TicketAssignment,\n  type InsertTicketAssignment,\n  type TicketStatusEvent,\n  type InsertTicketStatusEvent,\n  type TicketWorkSegment,\n  type InsertTicketWorkSegment,\n  type Notification,\n  type InsertNotification\n} from \"@shared/schema\";\n\nexport interface IStorage {\n  // Resources\n  createResource(resource: InsertResource): Promise<Resource>;\n  getAllResources(): Promise<Resource[]>;\n  updateResource(id: number, updates: Partial<InsertResource>): Promise<Resource | undefined>;\n  deleteResource(id: number): Promise<void>;\n  deleteAllResources(): Promise<void>;\n\n  // Contractors\n  createContractor(contractor: InsertContractor): Promise<Contractor>;\n  getAllContractors(): Promise<Contractor[]>;\n  getContractor(id: number): Promise<Contractor | undefined>;\n  updateContractor(id: number, updates: Partial<InsertContractor>): Promise<Contractor | undefined>;\n  deleteContractor(id: number): Promise<void>;\n  collectDepartureLocations(contractorId: number): Promise<any[]>;\n  updateContractorDepartureLocations(contractorId: number): Promise<void>;\n  setContractorDepartureLocations(contractorId: number, locations: Array<{location: string, latitude: number | null, longitude: number | null}>): Promise<void>;\n  mergeContractorReferences(sourceId: number, targetId: number): Promise<void>;\n\n  // Analysis Points\n  createAnalysisPoint(point: InsertAnalysisPoint): Promise<AnalysisPoint>;\n  getAllAnalysisPoints(sessionId?: string): Promise<AnalysisPoint[]>;\n  deleteAnalysisPoint(id: number, sessionId?: string): Promise<void>;\n\n  // Distance Calculations\n  createDistanceCalculation(calculation: InsertDistanceCalculation): Promise<DistanceCalculation>;\n  getCalculationsByPointId(pointId: number, sessionId?: string): Promise<DistanceCalculation[]>;\n  getCalculationsWithResources(pointId: number, sessionId?: string): Promise<(DistanceCalculation & { resource: Resource })[]>;\n\n  clearCalculationsForPoint(pointId: number, sessionId?: string): Promise<void>;\n\n  // Analysis Jobs\n  createAnalysisJob(job: InsertAnalysisJob): Promise<AnalysisJob>;\n  updateAnalysisJob(id: number, updates: Partial<AnalysisJob>): Promise<AnalysisJob | undefined>;\n  getAnalysisJob(id: number): Promise<AnalysisJob | undefined>;\n\n  // Contractor Files\n  createContractorFile(file: InsertContractorFile): Promise<ContractorFile>;\n  getContractorFiles(contractorId: number): Promise<ContractorFile[]>;\n  deleteContractorFile(id: number): Promise<void>;\n\n  // Contractor Reviews\n  createContractorReview(review: InsertContractorReview): Promise<ContractorReview>;\n  getContractorReviews(contractorId: number): Promise<ContractorReview[]>;\n  getAllContractorReviews(): Promise<ContractorReview[]>;\n  deleteContractorReview(reviewId: number): Promise<void>;\n\n  // User Authentication (Replit Auth)\n  getUser(id: string): Promise<User | undefined>;\n  getUserByEmail(email: string): Promise<User | undefined>;\n  upsertUser(user: UpsertUser): Promise<User>;\n  getAllUsers(): Promise<User[]>;\n  createUser(user: InsertUser): Promise<User>;\n  updateUser(id: string, updates: Partial<InsertUser>): Promise<User | undefined>;\n  deleteUser(id: string): Promise<User | undefined>; // Soft delete, returns updated user\n\n  // User Company Access\n  grantUserCompanyAccess(access: InsertUserCompanyAccess): Promise<UserCompanyAccess>;\n  revokeUserCompanyAccess(accessId: string): Promise<void>;\n  getUserCompanyAccesses(userId: string): Promise<UserCompanyAccess[]>;\n  getCompanyUserAccesses(companyId: string): Promise<UserCompanyAccess[]>;\n  getUserAccessibleCompanies(userId: string): Promise<Company[]>; // Get companies user can access with full company details\n  hasUtilityCompanyAccess(userId: string, companyId: string): Promise<boolean>; // Check if UTILITY user has access to specific company\n\n  // Companies (Storm Response Management)\n  createCompany(company: InsertCompany): Promise<Company>;\n  getAllCompanies(): Promise<Company[]>;\n  getCompany(id: string): Promise<Company | undefined>;\n  updateCompany(id: string, updates: Partial<InsertCompany>): Promise<Company | undefined>;\n  deleteCompany(id: string): Promise<void>;\n\n  // Storm Sessions\n  createStormSession(session: InsertStormSession): Promise<StormSession>;\n  getAllStormSessions(): Promise<StormSession[]>;\n  getStormSession(id: string): Promise<StormSession | undefined>;\n  updateStormSession(id: string, updates: Partial<InsertStormSession>): Promise<StormSession | undefined>;\n  closeStormSession(id: string): Promise<StormSession | undefined>;\n  reopenStormSession(id: string): Promise<StormSession | undefined>;\n  activateStormSession(id: string): Promise<StormSession | undefined>;\n  deactivateStormSession(id: string): Promise<StormSession | undefined>;\n  getActiveStormSession(): Promise<StormSession | undefined>;\n  deactivateAllSessions(): Promise<void>;\n  addContractorToSession(sessionId: string, contractorCompanyId: string): Promise<void>;\n  removeContractorFromSession(sessionId: string, contractorCompanyId: string): Promise<void>;\n\n  // Crew Availability\n  createCrewAvailability(availability: InsertCrewAvailability): Promise<CrewAvailability>;\n  getCrewAvailabilityByContractor(contractorId: number): Promise<CrewAvailability[]>;\n  getAllCrewAvailability(): Promise<CrewAvailability[]>;\n  updateCrewAvailability(id: number, updates: Partial<InsertCrewAvailability>): Promise<CrewAvailability | undefined>;\n  deleteCrewAvailability(id: number): Promise<void>;\n\n  // Equipment Availability\n  createEquipmentAvailability(equipment: InsertEquipmentAvailability): Promise<EquipmentAvailability>;\n  getEquipmentAvailabilityByContractor(contractorId: number): Promise<EquipmentAvailability[]>;\n  getEquipmentAvailabilityByCrew(crewAvailabilityId: number): Promise<EquipmentAvailability[]>;\n  deleteEquipmentAvailability(id: number): Promise<void>;\n\n  // Availability Submissions\n  createAvailabilitySubmission(submission: InsertAvailabilitySubmission): Promise<AvailabilitySubmission>;\n  getAvailabilitySubmissions(): Promise<AvailabilitySubmission[]>;\n  updateAvailabilitySubmission(id: number, updates: Partial<AvailabilitySubmission>): Promise<AvailabilitySubmission | undefined>;\n\n  // Availability Sessions\n  createAvailabilitySession(session: InsertAvailabilitySession): Promise<AvailabilitySession>;\n  getAvailabilitySessions(): Promise<AvailabilitySession[]>;\n  getAvailabilitySessionById(id: number): Promise<AvailabilitySession | undefined>;\n  getActiveAvailabilitySession(): Promise<AvailabilitySession | undefined>;\n  closeAvailabilitySession(id: number): Promise<AvailabilitySession | undefined>;\n  startNewAvailabilitySession(): Promise<AvailabilitySession>;\n  getCrewAvailabilityBySession(sessionId?: number | 'active' | 'unassigned'): Promise<CrewAvailability[]>;\n  assignUnassignedToSession(sessionId: number): Promise<void>;\n\n  // Incident Management\n  createIncident(incident: InsertIncident): Promise<Incident>;\n  getAllIncidents(): Promise<Incident[]>;\n  getIncident(id: number): Promise<Incident | undefined>;\n  updateIncident(id: number, updates: Partial<InsertIncident>): Promise<Incident | undefined>;\n  deleteIncident(id: number): Promise<void>;\n\n  // Incident Assignments\n  createIncidentAssignment(assignment: InsertIncidentAssignment): Promise<IncidentAssignment>;\n  getIncidentAssignments(incidentId?: number): Promise<IncidentAssignment[]>;\n  updateIncidentAssignment(id: number, updates: Partial<InsertIncidentAssignment>): Promise<IncidentAssignment | undefined>;\n  deleteIncidentAssignment(id: number): Promise<void>;\n\n  // Crew Rosters\n  createCrewRoster(roster: InsertCrewRoster): Promise<CrewRoster>;\n  getCrewRostersByAssignment(assignmentId: number): Promise<CrewRoster[]>;\n  updateCrewRoster(id: number, updates: Partial<InsertCrewRoster>): Promise<CrewRoster | undefined>;\n  deleteCrewRoster(id: number): Promise<void>;\n\n  // Issue Types\n  createIssueType(issueType: InsertIssueType): Promise<IssueType>;\n  getAllIssueTypes(): Promise<IssueType[]>;\n  getIssueType(id: string): Promise<IssueType | undefined>;\n  updateIssueType(id: string, updates: Partial<InsertIssueType>): Promise<IssueType | undefined>;\n\n  // Tickets\n  createTicket(ticket: InsertTicket): Promise<Ticket>;\n  getTicket(id: string): Promise<Ticket | undefined>;\n  getTicketsBySession(sessionId: string): Promise<Ticket[]>;\n  getTicketsByCompany(companyId: string): Promise<Ticket[]>;\n  updateTicket(id: string, updates: Partial<InsertTicket>): Promise<Ticket | undefined>;\n\n  // Ticket Assignments\n  createTicketAssignment(assignment: InsertTicketAssignment): Promise<TicketAssignment>;\n  getTicketAssignments(ticketId: string): Promise<TicketAssignment[]>;\n  getActiveTicketAssignment(ticketId: string): Promise<TicketAssignment | undefined>;\n  updateTicketAssignment(id: string, updates: Partial<InsertTicketAssignment>): Promise<TicketAssignment | undefined>;\n\n  // Ticket Status Events\n  createTicketStatusEvent(event: InsertTicketStatusEvent): Promise<TicketStatusEvent>;\n  getTicketStatusEvents(ticketId: string): Promise<TicketStatusEvent[]>;\n\n  // Ticket Work Segments\n  createTicketWorkSegment(segment: InsertTicketWorkSegment): Promise<TicketWorkSegment>;\n  getOpenWorkSegment(ticketId: string, crewId: string): Promise<TicketWorkSegment | undefined>;\n  closeWorkSegment(id: string): Promise<TicketWorkSegment | undefined>;\n  getWorkSegmentsByTicket(ticketId: string): Promise<TicketWorkSegment[]>;\n\n  // Notifications\n  createNotification(notification: InsertNotification): Promise<Notification>;\n  getNotificationsByUser(userId: string): Promise<Notification[]>;\n  markNotificationRead(id: string): Promise<Notification | undefined>;\n}\n\nexport class MemStorage implements IStorage {\n  private resources: Map<number, Resource> = new Map();\n  private contractors: Map<number, Contractor> = new Map();\n  private analysisPoints: Map<number, AnalysisPoint> = new Map();\n  private distanceCalculations: Map<number, DistanceCalculation> = new Map();\n  private analysisJobs: Map<number, AnalysisJob> = new Map();\n  private users: Map<string, User> = new Map();\n  private userCompanyAccesses: Map<string, UserCompanyAccess> = new Map();\n  private companies: Map<string, Company> = new Map();\n  private currentResourceId = 1;\n  private currentContractorId = 1;\n  private currentPointId = 1;\n  private currentCalculationId = 1;\n  private currentJobId = 1;\n\n  async createResource(insertResource: InsertResource): Promise<Resource> {\n    const id = this.currentResourceId++;\n    const resource: Resource = {\n      id,\n      name: insertResource.name,\n      type: insertResource.type,\n      latitude: insertResource.latitude,\n      longitude: insertResource.longitude,\n      description: insertResource.description || null,\n      properties: insertResource.properties || null,\n      createdAt: new Date(),\n    };\n    this.resources.set(id, resource);\n    return resource;\n  }\n\n  async getAllResources(): Promise<Resource[]> {\n    return Array.from(this.resources.values());\n  }\n\n  async updateResource(id: number, updates: Partial<InsertResource>): Promise<Resource | undefined> {\n    const resource = this.resources.get(id);\n    if (!resource) return undefined;\n    \n    const updated: Resource = {\n      ...resource,\n      ...updates,\n      id: resource.id, // Keep original ID\n      createdAt: resource.createdAt // Keep original creation date\n    };\n    this.resources.set(id, updated);\n    return updated;\n  }\n\n  async deleteResource(id: number): Promise<void> {\n    this.resources.delete(id);\n  }\n\n  async deleteAllResources(): Promise<void> {\n    this.resources.clear();\n    this.currentResourceId = 1;\n  }\n\n  async createContractor(insertContractor: InsertContractor): Promise<Contractor> {\n    const id = this.currentContractorId++;\n    const contractor: Contractor = {\n      id,\n      name: insertContractor.name,\n      company: insertContractor.company,\n      email: insertContractor.email || null,\n      phone: insertContractor.phone || null,\n      category: insertContractor.category,\n      city: insertContractor.city || null,\n      state: insertContractor.state || null,\n      fullAddress: insertContractor.fullAddress || null,\n      latitude: insertContractor.latitude || null,\n      longitude: insertContractor.longitude || null,\n      birdRep: insertContractor.birdRep || null,\n      pipefile: insertContractor.pipefile || null,\n      avetta: insertContractor.avetta || null,\n      subRanking: insertContractor.subRanking || null,\n      fteCountsPerLocation: insertContractor.fteCountsPerLocation || null,\n      pipefileUpdates: insertContractor.pipefileUpdates || null,\n      notes: insertContractor.notes || null,\n      rating: insertContractor.rating || 0,\n      createdAt: new Date(),\n      updatedAt: new Date(),\n    };\n    this.contractors.set(id, contractor);\n    return contractor;\n  }\n\n  async getAllContractors(): Promise<Contractor[]> {\n    return Array.from(this.contractors.values());\n  }\n\n  async getContractor(id: number): Promise<Contractor | undefined> {\n    return this.contractors.get(id);\n  }\n\n  async updateContractor(id: number, updates: Partial<InsertContractor>): Promise<Contractor | undefined> {\n    const contractor = this.contractors.get(id);\n    if (!contractor) return undefined;\n    \n    const updated: Contractor = {\n      ...contractor,\n      ...updates,\n      updatedAt: new Date(),\n    };\n    this.contractors.set(id, updated);\n    return updated;\n  }\n\n  async deleteContractor(id: number): Promise<void> {\n    this.contractors.delete(id);\n  }\n\n  async collectDepartureLocations(contractorId: number): Promise<any[]> {\n    return [];\n  }\n\n  async updateContractorDepartureLocations(contractorId: number): Promise<void> {\n    // No-op for in-memory storage\n  }\n\n  async setContractorDepartureLocations(contractorId: number, locations: Array<{location: string, latitude: number | null, longitude: number | null}>): Promise<void> {\n    const contractor = this.contractors.get(contractorId);\n    if (contractor) {\n      contractor.departureLocations = locations as any;\n      this.contractors.set(contractorId, contractor);\n    }\n  }\n\n  async mergeContractorReferences(sourceId: number, targetId: number): Promise<void> {\n    // No-op for in-memory storage\n  }\n\n  async createAnalysisPoint(insertPoint: InsertAnalysisPoint): Promise<AnalysisPoint> {\n    const id = this.currentPointId++;\n    const point: AnalysisPoint = {\n      ...insertPoint,\n      id,\n      createdAt: new Date(),\n    };\n    this.analysisPoints.set(id, point);\n    return point;\n  }\n\n  async getAllAnalysisPoints(sessionId?: string): Promise<AnalysisPoint[]> {\n    return Array.from(this.analysisPoints.values());\n  }\n\n  async deleteAnalysisPoint(id: number, sessionId?: string): Promise<void> {\n    this.analysisPoints.delete(id);\n    // Also delete related calculations\n    const calcIds = Array.from(this.distanceCalculations.entries())\n      .filter(([, calc]) => calc.analysisPointId === id)\n      .map(([calcId]) => calcId);\n    \n    calcIds.forEach(calcId => this.distanceCalculations.delete(calcId));\n  }\n\n  async createDistanceCalculation(insertCalculation: InsertDistanceCalculation): Promise<DistanceCalculation> {\n    const id = this.currentCalculationId++;\n    const calculation: DistanceCalculation = {\n      id,\n      analysisPointId: insertCalculation.analysisPointId || null,\n      resourceId: insertCalculation.resourceId || null,\n      distance: insertCalculation.distance,\n      duration: insertCalculation.duration,\n      route: insertCalculation.route || null,\n      createdAt: new Date(),\n    };\n    this.distanceCalculations.set(id, calculation);\n    return calculation;\n  }\n\n  async getCalculationsByPointId(pointId: number, sessionId?: string): Promise<DistanceCalculation[]> {\n    return Array.from(this.distanceCalculations.values()).filter(\n      calc => calc.analysisPointId === pointId\n    );\n  }\n\n  async getCalculationsWithResources(pointId: number, sessionId?: string): Promise<(DistanceCalculation & { resource: Resource })[]> {\n    const calculations = await this.getCalculationsByPointId(pointId, sessionId);\n    return calculations.map(calc => {\n      const resource = this.resources.get(calc.resourceId!);\n      return { ...calc, resource: resource! };\n    }).filter(calc => calc.resource);\n  }\n\n  async clearCalculationsForPoint(pointId: number, sessionId?: string): Promise<void> {\n    // Remove all calculations for this point\n    const idsToDelete: number[] = [];\n    this.distanceCalculations.forEach((calc, id) => {\n      if (calc.analysisPointId === pointId) {\n        idsToDelete.push(id);\n      }\n    });\n    idsToDelete.forEach(id => this.distanceCalculations.delete(id));\n  }\n\n  async createAnalysisJob(insertJob: InsertAnalysisJob): Promise<AnalysisJob> {\n    const id = this.currentJobId++;\n    const job: AnalysisJob = {\n      id,\n      filename: insertJob.filename,\n      status: insertJob.status,\n      resourceCount: insertJob.resourceCount || null,\n      error: insertJob.error || null,\n      createdAt: new Date(),\n    };\n    this.analysisJobs.set(id, job);\n    return job;\n  }\n\n  async updateAnalysisJob(id: number, updates: Partial<AnalysisJob>): Promise<AnalysisJob | undefined> {\n    const job = this.analysisJobs.get(id);\n    if (!job) return undefined;\n    \n    const updatedJob = { ...job, ...updates };\n    this.analysisJobs.set(id, updatedJob);\n    return updatedJob;\n  }\n\n  async getAnalysisJob(id: number): Promise<AnalysisJob | undefined> {\n    return this.analysisJobs.get(id);\n  }\n\n  async createContractorFile(insertFile: InsertContractorFile): Promise<ContractorFile> {\n    // MemStorage doesn't support file uploads, return a placeholder\n    throw new Error(\"File uploads not supported in memory storage\");\n  }\n\n  async getContractorFiles(contractorId: number): Promise<ContractorFile[]> {\n    return [];\n  }\n\n  async deleteContractorFile(id: number): Promise<void> {\n    // No-op for memory storage\n  }\n\n  // Contractor Reviews\n  async createContractorReview(insertReview: InsertContractorReview): Promise<ContractorReview> {\n    throw new Error(\"Contractor reviews not supported in memory storage\");\n  }\n\n  async getContractorReviews(contractorId: number): Promise<ContractorReview[]> {\n    return [];\n  }\n\n  async getAllContractorReviews(): Promise<ContractorReview[]> {\n    return [];\n  }\n\n  async deleteContractorReview(reviewId: number): Promise<void> {\n    throw new Error(\"Contractor review deletion not supported in memory storage\");\n  }\n\n  // User Authentication methods (Replit Auth)\n  async getUser(id: string): Promise<User | undefined> {\n    return this.users.get(id);\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    return Array.from(this.users.values()).find(\n      u => u.email === email && !u.deletedAt\n    );\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const now = new Date();\n    const existing = this.users.get(userData.id);\n    \n    const user: User = {\n      ...userData,\n      createdAt: existing?.createdAt || now,\n      updatedAt: now,\n      deletedAt: existing?.deletedAt || null,\n    };\n    \n    this.users.set(userData.id, user);\n    return user;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return Array.from(this.users.values()).filter(u => !u.deletedAt);\n  }\n\n  async createUser(userData: InsertUser): Promise<User> {\n    const id = crypto.randomUUID();\n    const now = new Date();\n    \n    const user: User = {\n      id,\n      ...userData,\n      createdAt: now,\n      updatedAt: now,\n      deletedAt: null,\n    };\n    \n    this.users.set(id, user);\n    return user;\n  }\n\n  async updateUser(id: string, updates: Partial<InsertUser>): Promise<User | undefined> {\n    const user = this.users.get(id);\n    if (!user || user.deletedAt) return undefined;\n    \n    const updated: User = {\n      ...user,\n      ...updates,\n      id: user.id,\n      createdAt: user.createdAt,\n      updatedAt: new Date(),\n    };\n    \n    this.users.set(id, updated);\n    return updated;\n  }\n\n  async deleteUser(id: string): Promise<User | undefined> {\n    const user = this.users.get(id);\n    if (!user) return undefined;\n    \n    const now = new Date();\n    const deleted: User = {\n      ...user,\n      deletedAt: now,\n      updatedAt: now,\n    };\n    \n    this.users.set(id, deleted);\n    return deleted;\n  }\n\n  // User Company Access\n  async grantUserCompanyAccess(access: InsertUserCompanyAccess): Promise<UserCompanyAccess> {\n    const id = crypto.randomUUID();\n    const now = new Date();\n    \n    const granted: UserCompanyAccess = {\n      id,\n      ...access,\n      grantedAt: now,\n    };\n    \n    this.userCompanyAccesses.set(id, granted);\n    return granted;\n  }\n\n  async revokeUserCompanyAccess(accessId: string): Promise<void> {\n    this.userCompanyAccesses.delete(accessId);\n  }\n\n  async getUserCompanyAccesses(userId: string): Promise<UserCompanyAccess[]> {\n    return Array.from(this.userCompanyAccesses.values()).filter(\n      a => a.userId === userId\n    );\n  }\n\n  async getCompanyUserAccesses(companyId: string): Promise<UserCompanyAccess[]> {\n    return Array.from(this.userCompanyAccesses.values()).filter(\n      a => a.companyId === companyId\n    );\n  }\n\n  async getUserAccessibleCompanies(userId: string): Promise<Company[]> {\n    const accesses = Array.from(this.userCompanyAccesses.values()).filter(\n      a => a.userId === userId\n    );\n    \n    const companies: Company[] = [];\n    for (const access of accesses) {\n      const company = this.companies.get(access.companyId);\n      if (company && !company.deletedAt) {\n        companies.push(company);\n      }\n    }\n    \n    return companies;\n  }\n\n  async hasUtilityCompanyAccess(userId: string, companyId: string): Promise<boolean> {\n    const company = this.companies.get(companyId);\n    if (!company || company.deletedAt) return false;\n    \n    return Array.from(this.userCompanyAccesses.values()).some(\n      a => a.userId === userId && a.companyId === companyId\n    );\n  }\n\n  // Availability-related methods (not supported in memory storage)\n  async createCrewAvailability(availability: InsertCrewAvailability): Promise<CrewAvailability> {\n    throw new Error(\"Crew availability not supported in memory storage\");\n  }\n\n  async getCrewAvailabilityByContractor(contractorId: number): Promise<CrewAvailability[]> {\n    return [];\n  }\n\n  async getAllCrewAvailability(): Promise<CrewAvailability[]> {\n    return [];\n  }\n\n  async updateCrewAvailability(id: number, updates: Partial<InsertCrewAvailability>): Promise<CrewAvailability | undefined> {\n    throw new Error(\"Crew availability not supported in memory storage\");\n  }\n\n  async deleteCrewAvailability(id: number): Promise<void> {\n    throw new Error(\"Crew availability not supported in memory storage\");\n  }\n\n  async createEquipmentAvailability(equipment: InsertEquipmentAvailability): Promise<EquipmentAvailability> {\n    throw new Error(\"Equipment availability not supported in memory storage\");\n  }\n\n  async getEquipmentAvailabilityByContractor(contractorId: number): Promise<EquipmentAvailability[]> {\n    return [];\n  }\n\n  async getEquipmentAvailabilityByCrew(crewAvailabilityId: number): Promise<EquipmentAvailability[]> {\n    return [];\n  }\n\n  async deleteEquipmentAvailability(id: number): Promise<void> {\n    throw new Error(\"Equipment availability not supported in memory storage\");\n  }\n\n  async createAvailabilitySubmission(submission: InsertAvailabilitySubmission): Promise<AvailabilitySubmission> {\n    throw new Error(\"Availability submission not supported in memory storage\");\n  }\n\n  async getAvailabilitySubmissions(): Promise<AvailabilitySubmission[]> {\n    return [];\n  }\n\n  async updateAvailabilitySubmission(id: number, updates: Partial<AvailabilitySubmission>): Promise<AvailabilitySubmission | undefined> {\n    throw new Error(\"Availability submission not supported in memory storage\");\n  }\n\n  async createAvailabilitySession(session: InsertAvailabilitySession): Promise<AvailabilitySession> {\n    throw new Error(\"Availability sessions not supported in memory storage\");\n  }\n\n  async getAvailabilitySessions(): Promise<AvailabilitySession[]> {\n    return [];\n  }\n\n  async getAvailabilitySessionById(id: number): Promise<AvailabilitySession | undefined> {\n    return undefined;\n  }\n\n  async getActiveAvailabilitySession(): Promise<AvailabilitySession | undefined> {\n    return undefined;\n  }\n\n  async closeAvailabilitySession(id: number): Promise<AvailabilitySession | undefined> {\n    throw new Error(\"Availability sessions not supported in memory storage\");\n  }\n\n  async startNewAvailabilitySession(): Promise<AvailabilitySession> {\n    throw new Error(\"Availability sessions not supported in memory storage\");\n  }\n\n  async getCrewAvailabilityBySession(sessionId?: number | 'active' | 'unassigned'): Promise<CrewAvailability[]> {\n    return [];\n  }\n\n  async assignUnassignedToSession(sessionId: number): Promise<void> {\n    throw new Error(\"Availability sessions not supported in memory storage\");\n  }\n\n  async createIncident(incident: InsertIncident): Promise<Incident> {\n    throw new Error(\"Incidents not supported in memory storage\");\n  }\n\n  async getAllIncidents(): Promise<Incident[]> {\n    return [];\n  }\n\n  async getIncident(id: number): Promise<Incident | undefined> {\n    return undefined;\n  }\n\n  async updateIncident(id: number, updates: Partial<InsertIncident>): Promise<Incident | undefined> {\n    throw new Error(\"Incidents not supported in memory storage\");\n  }\n\n  async deleteIncident(id: number): Promise<void> {\n    throw new Error(\"Incidents not supported in memory storage\");\n  }\n\n  async createIncidentAssignment(assignment: InsertIncidentAssignment): Promise<IncidentAssignment> {\n    throw new Error(\"Incident assignments not supported in memory storage\");\n  }\n\n  async getIncidentAssignments(incidentId?: number): Promise<IncidentAssignment[]> {\n    return [];\n  }\n\n  async updateIncidentAssignment(id: number, updates: Partial<InsertIncidentAssignment>): Promise<IncidentAssignment | undefined> {\n    throw new Error(\"Incident assignments not supported in memory storage\");\n  }\n\n  async deleteIncidentAssignment(id: number): Promise<void> {\n    throw new Error(\"Incident assignments not supported in memory storage\");\n  }\n\n  async createCrewRoster(roster: InsertCrewRoster): Promise<CrewRoster> {\n    throw new Error(\"Crew rosters not supported in memory storage\");\n  }\n\n  async getCrewRostersByAssignment(assignmentId: number): Promise<CrewRoster[]> {\n    return [];\n  }\n\n  async updateCrewRoster(id: number, updates: Partial<InsertCrewRoster>): Promise<CrewRoster | undefined> {\n    throw new Error(\"Crew rosters not supported in memory storage\");\n  }\n\n  async deleteCrewRoster(id: number): Promise<void> {\n    throw new Error(\"Crew rosters not supported in memory storage\");\n  }\n\n  async findContractorByNormalizedMatch(company: string, name: string): Promise<Contractor | undefined> {\n    return undefined;\n  }\n\n  async mergeContractorReferences(sourceId: number, targetId: number): Promise<void> {\n    throw new Error(\"Contractor merge not supported in memory storage\");\n  }\n}\n\n// Database implementation\nimport { db } from \"./db\";\nimport { eq, and, isNull } from \"drizzle-orm\";\n\nexport class DatabaseStorage implements IStorage {\n  async createResource(insertResource: InsertResource): Promise<Resource> {\n    const [resource] = await db.insert(resources).values(insertResource).returning();\n    return resource;\n  }\n\n  async getAllResources(): Promise<Resource[]> {\n    return await db.select().from(resources);\n  }\n\n  async updateResource(id: number, updates: Partial<InsertResource>): Promise<Resource | undefined> {\n    const [resource] = await db.update(resources)\n      .set(updates)\n      .where(eq(resources.id, id))\n      .returning();\n    return resource;\n  }\n\n  async deleteResource(id: number): Promise<void> {\n    await db.delete(resources).where(eq(resources.id, id));\n  }\n\n  async deleteAllResources(): Promise<void> {\n    await db.delete(resources);\n  }\n\n  async createContractor(insertContractor: InsertContractor): Promise<Contractor> {\n    const [contractor] = await db.insert(contractors).values({\n      ...insertContractor,\n      updatedAt: new Date()\n    }).returning();\n    return contractor;\n  }\n\n  async getAllContractors(): Promise<Contractor[]> {\n    return await db.select().from(contractors);\n  }\n\n  async getContractor(id: number): Promise<Contractor | undefined> {\n    const [contractor] = await db.select().from(contractors).where(eq(contractors.id, id));\n    return contractor;\n  }\n\n  async updateContractor(id: number, updates: Partial<InsertContractor>): Promise<Contractor | undefined> {\n    const [contractor] = await db.update(contractors)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(contractors.id, id))\n      .returning();\n    return contractor;\n  }\n\n  async deleteContractor(id: number): Promise<void> {\n    await db.delete(contractors).where(eq(contractors.id, id));\n  }\n\n  // Utility function to normalize phone numbers (strips all non-digit characters)\n  private normalizePhone(phone: string | null | undefined): string {\n    if (!phone) return '';\n    \n    // Remove all non-digits\n    let digits = phone.replace(/\\D/g, '');\n    \n    // Handle country code: if starts with \"1\" and has 11 digits, remove the leading \"1\"\n    // This handles +1-555-123-4567 vs 555-123-4567\n    if (digits.length === 11 && digits.startsWith('1')) {\n      digits = digits.substring(1);\n    }\n    \n    // Only keep the main 10 digits (ignore extensions)\n    // This handles cases like \"555-123-4567 x89\" vs \"555-123-4567\"\n    if (digits.length > 10) {\n      digits = digits.substring(0, 10);\n    }\n    \n    return digits;\n  }\n\n  // Utility function to normalize email addresses\n  private normalizeEmail(email: string | null | undefined): string {\n    if (!email) return '';\n    return email.toLowerCase().trim();\n  }\n\n  // Utility function to normalize text (company names, person names)\n  private normalizeText(text: string | null | undefined): string {\n    if (!text) return '';\n    return text.toLowerCase().trim();\n  }\n\n  async findContractorByNormalizedMatch(\n    company: string, \n    name: string, \n    email?: string, \n    phone?: string\n  ): Promise<Contractor | undefined> {\n    // Normalize all input data\n    const normalizedCompany = this.normalizeText(company);\n    const normalizedName = this.normalizeText(name);\n    const normalizedEmail = this.normalizeEmail(email);\n    const normalizedPhone = this.normalizePhone(phone);\n    \n    const allContractors = await this.getAllContractors();\n    \n    // Try multiple matching strategies in order of confidence\n    \n    // Strategy 1: Exact match on company + name (highest confidence)\n    let match = allContractors.find(c => \n      this.normalizeText(c.company) === normalizedCompany &&\n      this.normalizeText(c.name) === normalizedName\n    );\n    if (match) {\n      console.log(`  ✓ Matched via Strategy 1 (Company + Name): ${match.company} - ${match.name}`);\n      return match;\n    }\n    \n    // Strategy 2: Match on company + email (high confidence)\n    if (normalizedEmail && normalizedCompany) {\n      match = allContractors.find(c => {\n        const contractorEmails = (c.email || '').split(',').map(e => this.normalizeEmail(e));\n        return this.normalizeText(c.company) === normalizedCompany &&\n               contractorEmails.some(ce => ce === normalizedEmail);\n      });\n      if (match) {\n        console.log(`  ✓ Matched via Strategy 2 (Company + Email): ${match.company} - ${normalizedEmail}`);\n        return match;\n      }\n    }\n    \n    // Strategy 3: Match on company + phone (high confidence)\n    if (normalizedPhone && normalizedCompany) {\n      match = allContractors.find(c => {\n        const contractorPhones = (c.phone || '').split(',').map(p => this.normalizePhone(p));\n        return this.normalizeText(c.company) === normalizedCompany &&\n               contractorPhones.some(cp => cp === normalizedPhone && cp.length >= 10);\n      });\n      if (match) {\n        console.log(`  ✓ Matched via Strategy 3 (Company + Phone): ${match.company} - ${normalizedPhone}`);\n        return match;\n      }\n    }\n    \n    // Strategy 4: Match on email alone (medium confidence - only if email is unique)\n    if (normalizedEmail) {\n      const emailMatches = allContractors.filter(c => {\n        const contractorEmails = (c.email || '').split(',').map(e => this.normalizeEmail(e));\n        return contractorEmails.some(ce => ce === normalizedEmail);\n      });\n      if (emailMatches.length === 1) {\n        console.log(`  ✓ Matched via Strategy 4 (Email only): ${emailMatches[0].company} - ${normalizedEmail}`);\n        return emailMatches[0];\n      }\n    }\n    \n    // Strategy 5: Match on phone alone (medium confidence - only if phone is unique and has 10+ digits)\n    if (normalizedPhone && normalizedPhone.length >= 10) {\n      const phoneMatches = allContractors.filter(c => {\n        const contractorPhones = (c.phone || '').split(',').map(p => this.normalizePhone(p));\n        return contractorPhones.some(cp => cp === normalizedPhone);\n      });\n      if (phoneMatches.length === 1) {\n        console.log(`  ✓ Matched via Strategy 5 (Phone only): ${phoneMatches[0].company} - ${normalizedPhone}`);\n        return phoneMatches[0];\n      }\n    }\n    \n    // No match found\n    console.log(`  ✗ No match found for: ${company} / ${name} / ${email || 'no email'} / ${phone || 'no phone'}`);\n    return undefined;\n  }\n\n  async collectDepartureLocations(contractorId: number): Promise<any[]> {\n    // Get all crew availability records for this contractor\n    const submissions = await db.select()\n      .from(crewAvailability)\n      .where(eq(crewAvailability.contractorId, contractorId));\n    \n    // Extract unique departure locations\n    const locationMap = new Map<string, any>();\n    \n    for (const submission of submissions) {\n      if (submission.departureLocation && submission.departureLocation.trim() !== '') {\n        const key = submission.departureLocation.toLowerCase().trim();\n        \n        // Only add if we haven't seen this location before\n        if (!locationMap.has(key)) {\n          locationMap.set(key, {\n            location: submission.departureLocation,\n            latitude: submission.departureLatitude || null,\n            longitude: submission.departureLongitude || null\n          });\n        }\n      }\n    }\n    \n    return Array.from(locationMap.values());\n  }\n\n  async updateContractorDepartureLocations(contractorId: number): Promise<void> {\n    const locations = await this.collectDepartureLocations(contractorId);\n    \n    if (locations.length > 0) {\n      await db.update(contractors)\n        .set({ \n          departureLocations: locations as any,\n          updatedAt: new Date() \n        })\n        .where(eq(contractors.id, contractorId));\n    }\n  }\n\n  async setContractorDepartureLocations(contractorId: number, locations: Array<{location: string, latitude: number | null, longitude: number | null}>): Promise<void> {\n    await db.update(contractors)\n      .set({ \n        departureLocations: locations as any,\n        updatedAt: new Date() \n      })\n      .where(eq(contractors.id, contractorId));\n  }\n\n  async mergeContractorReferences(sourceId: number, targetId: number): Promise<void> {\n    // Update all foreign key references to point to targetId instead of sourceId\n    \n    // Update crew availability records\n    await db.update(crewAvailability)\n      .set({ contractorId: targetId })\n      .where(eq(crewAvailability.contractorId, sourceId));\n    \n    // Update equipment availability records\n    await db.update(equipmentAvailability)\n      .set({ contractorId: targetId })\n      .where(eq(equipmentAvailability.contractorId, sourceId));\n    \n    // Update contractor files\n    await db.update(contractorFiles)\n      .set({ contractorId: targetId })\n      .where(eq(contractorFiles.contractorId, sourceId));\n    \n    // Update contractor reviews\n    await db.update(contractorReviews)\n      .set({ contractorId: targetId })\n      .where(eq(contractorReviews.contractorId, sourceId));\n    \n    // Update users (if contractors have associated user accounts)\n    await db.update(users)\n      .set({ contractorId: targetId })\n      .where(eq(users.contractorId, sourceId));\n    \n    // Note: incidentAssignments and crewRosters are linked through crewAvailability,\n    // so updating crewAvailability.contractorId above handles those relationships\n  }\n\n  async createAnalysisPoint(insertPoint: InsertAnalysisPoint): Promise<AnalysisPoint> {\n    const [point] = await db.insert(analysisPoints).values(insertPoint).returning();\n    return point;\n  }\n\n  async getAllAnalysisPoints(sessionId?: string): Promise<AnalysisPoint[]> {\n    if (sessionId) {\n      return await db.select().from(analysisPoints).where(eq(analysisPoints.sessionId, sessionId));\n    }\n    return await db.select().from(analysisPoints);\n  }\n\n  async deleteAnalysisPoint(id: number, sessionId?: string): Promise<void> {\n    // First delete related distance calculations\n    if (sessionId) {\n      await db.delete(distanceCalculations).where(\n        and(eq(distanceCalculations.analysisPointId, id), eq(distanceCalculations.sessionId, sessionId))\n      );\n      // Then delete the analysis point\n      await db.delete(analysisPoints).where(\n        and(eq(analysisPoints.id, id), eq(analysisPoints.sessionId, sessionId))\n      );\n    } else {\n      await db.delete(distanceCalculations).where(eq(distanceCalculations.analysisPointId, id));\n      await db.delete(analysisPoints).where(eq(analysisPoints.id, id));\n    }\n  }\n\n  async createDistanceCalculation(insertCalculation: InsertDistanceCalculation): Promise<DistanceCalculation> {\n    const [calculation] = await db.insert(distanceCalculations).values(insertCalculation).returning();\n    return calculation;\n  }\n\n  async getCalculationsByPointId(pointId: number, sessionId?: string): Promise<DistanceCalculation[]> {\n    if (sessionId) {\n      return await db.select().from(distanceCalculations).where(\n        and(eq(distanceCalculations.analysisPointId, pointId), eq(distanceCalculations.sessionId, sessionId))\n      );\n    }\n    return await db.select().from(distanceCalculations).where(eq(distanceCalculations.analysisPointId, pointId));\n  }\n\n  async getCalculationsWithResources(pointId: number, sessionId?: string): Promise<(DistanceCalculation & { resource: Resource })[]> {\n    const calculations = await db.select({\n      id: distanceCalculations.id,\n      analysisPointId: distanceCalculations.analysisPointId,\n      resourceId: distanceCalculations.resourceId,\n      distance: distanceCalculations.distance,\n      duration: distanceCalculations.duration,\n      route: distanceCalculations.route,\n      createdAt: distanceCalculations.createdAt,\n      sessionId: distanceCalculations.sessionId,\n      resource: resources\n    })\n    .from(distanceCalculations)\n    .innerJoin(resources, eq(distanceCalculations.resourceId, resources.id))\n    .where(sessionId \n      ? and(eq(distanceCalculations.analysisPointId, pointId), eq(distanceCalculations.sessionId, sessionId))\n      : eq(distanceCalculations.analysisPointId, pointId)\n    );\n\n    return calculations.map(calc => ({\n      ...calc,\n      resource: calc.resource\n    }));\n  }\n\n\n\n  async clearCalculationsForPoint(pointId: number, sessionId?: string): Promise<void> {\n    if (sessionId) {\n      await db.delete(distanceCalculations).where(\n        and(eq(distanceCalculations.analysisPointId, pointId), eq(distanceCalculations.sessionId, sessionId))\n      );\n    } else {\n      await db.delete(distanceCalculations).where(eq(distanceCalculations.analysisPointId, pointId));\n    }\n  }\n\n  async createAnalysisJob(insertJob: InsertAnalysisJob): Promise<AnalysisJob> {\n    const [job] = await db.insert(analysisJobs).values(insertJob).returning();\n    return job;\n  }\n\n  async updateAnalysisJob(id: number, updates: Partial<AnalysisJob>): Promise<AnalysisJob | undefined> {\n    const [job] = await db.update(analysisJobs)\n      .set(updates)\n      .where(eq(analysisJobs.id, id))\n      .returning();\n    return job;\n  }\n\n  async getAnalysisJob(id: number): Promise<AnalysisJob | undefined> {\n    const [job] = await db.select().from(analysisJobs).where(eq(analysisJobs.id, id));\n    return job;\n  }\n\n  async createContractorFile(insertFile: InsertContractorFile): Promise<ContractorFile> {\n    const [file] = await db.insert(contractorFiles).values(insertFile).returning();\n    return file;\n  }\n\n  async getContractorFiles(contractorId: number): Promise<ContractorFile[]> {\n    return await db.select().from(contractorFiles).where(eq(contractorFiles.contractorId, contractorId));\n  }\n\n  async deleteContractorFile(id: number): Promise<void> {\n    await db.delete(contractorFiles).where(eq(contractorFiles.id, id));\n  }\n\n  // Contractor Reviews\n  async createContractorReview(insertReview: InsertContractorReview): Promise<ContractorReview> {\n    const [review] = await db.insert(contractorReviews).values(insertReview).returning();\n    return review;\n  }\n\n  async getContractorReviews(contractorId: number): Promise<ContractorReview[]> {\n    return await db.select().from(contractorReviews).where(eq(contractorReviews.contractorId, contractorId));\n  }\n\n  async getAllContractorReviews(): Promise<ContractorReview[]> {\n    return await db.select().from(contractorReviews);\n  }\n\n  async deleteContractorReview(reviewId: number): Promise<void> {\n    await db.delete(contractorReviews).where(eq(contractorReviews.id, reviewId));\n  }\n\n  // User Authentication methods (Replit Auth)\n  async getUser(id: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(eq(users.id, id));\n    return user;\n  }\n\n  async upsertUser(userData: UpsertUser): Promise<User> {\n    const [user] = await db\n      .insert(users)\n      .values(userData)\n      .onConflictDoUpdate({\n        target: users.id,\n        set: {\n          ...userData,\n          updatedAt: new Date(),\n        },\n      })\n      .returning();\n    return user;\n  }\n\n  async getAllUsers(): Promise<User[]> {\n    return await db.select().from(users).where(isNull(users.deletedAt));\n  }\n\n  async getUserByEmail(email: string): Promise<User | undefined> {\n    const [user] = await db.select().from(users).where(\n      and(\n        eq(users.email, email),\n        isNull(users.deletedAt)\n      )\n    );\n    return user;\n  }\n\n  async createUser(userData: InsertUser): Promise<User> {\n    const now = new Date();\n    const [user] = await db\n      .insert(users)\n      .values({\n        ...userData,\n        createdAt: now,\n        updatedAt: now,\n      })\n      .returning();\n    return user;\n  }\n\n  async updateUser(id: string, updates: Partial<InsertUser>): Promise<User | undefined> {\n    const [updated] = await db\n      .update(users)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(and(eq(users.id, id), isNull(users.deletedAt)))\n      .returning();\n    return updated;\n  }\n\n  async deleteUser(id: string): Promise<User | undefined> {\n    const now = new Date();\n    const [deleted] = await db\n      .update(users)\n      .set({ deletedAt: now, updatedAt: now })\n      .where(eq(users.id, id))\n      .returning();\n    return deleted;\n  }\n\n  // User Company Access\n  async grantUserCompanyAccess(access: InsertUserCompanyAccess): Promise<UserCompanyAccess> {\n    const [granted] = await db\n      .insert(userCompanyAccess)\n      .values(access)\n      .returning();\n    return granted;\n  }\n\n  async revokeUserCompanyAccess(accessId: string): Promise<void> {\n    await db.delete(userCompanyAccess).where(eq(userCompanyAccess.id, accessId));\n  }\n\n  async getUserCompanyAccesses(userId: string): Promise<UserCompanyAccess[]> {\n    return await db\n      .select()\n      .from(userCompanyAccess)\n      .where(eq(userCompanyAccess.userId, userId));\n  }\n\n  async getCompanyUserAccesses(companyId: string): Promise<UserCompanyAccess[]> {\n    return await db\n      .select()\n      .from(userCompanyAccess)\n      .where(eq(userCompanyAccess.companyId, companyId));\n  }\n\n  async getUserAccessibleCompanies(userId: string): Promise<Company[]> {\n    const result = await db\n      .select({\n        id: companies.id,\n        name: companies.name,\n        contactName: companies.contactName,\n        contactEmail: companies.contactEmail,\n        contactPhone: companies.contactPhone,\n        billingAddress: companies.billingAddress,\n        notes: companies.notes,\n        createdAt: companies.createdAt,\n        updatedAt: companies.updatedAt,\n        deletedAt: companies.deletedAt,\n      })\n      .from(userCompanyAccess)\n      .innerJoin(companies, eq(userCompanyAccess.companyId, companies.id))\n      .where(\n        and(\n          eq(userCompanyAccess.userId, userId),\n          isNull(companies.deletedAt)\n        )\n      );\n    return result;\n  }\n\n  async hasUtilityCompanyAccess(userId: string, companyId: string): Promise<boolean> {\n    const [access] = await db\n      .select()\n      .from(userCompanyAccess)\n      .innerJoin(companies, eq(userCompanyAccess.companyId, companies.id))\n      .where(\n        and(\n          eq(userCompanyAccess.userId, userId),\n          eq(userCompanyAccess.companyId, companyId),\n          isNull(companies.deletedAt)\n        )\n      )\n      .limit(1);\n    return access !== undefined;\n  }\n\n  // Companies (Storm Response Management)\n  async createCompany(companyData: InsertCompany): Promise<Company> {\n    const [company] = await db.insert(companies).values(companyData).returning();\n    return company;\n  }\n\n  async getAllCompanies(): Promise<Company[]> {\n    return await db.select().from(companies).where(isNull(companies.deletedAt));\n  }\n\n  async getCompany(id: string): Promise<Company | undefined> {\n    const [company] = await db.select().from(companies).where(\n      and(\n        eq(companies.id, id),\n        isNull(companies.deletedAt)\n      )\n    );\n    return company;\n  }\n\n  async updateCompany(id: string, updates: Partial<InsertCompany>): Promise<Company | undefined> {\n    const [updated] = await db\n      .update(companies)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(companies.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCompany(id: string): Promise<void> {\n    // Soft delete\n    await db\n      .update(companies)\n      .set({ deletedAt: new Date() })\n      .where(eq(companies.id, id));\n  }\n\n  // Storm Sessions\n  async createStormSession(sessionData: InsertStormSession): Promise<StormSession> {\n    const [session] = await db.insert(stormSessions).values(sessionData).returning();\n    return session;\n  }\n\n  async getAllStormSessions(): Promise<StormSession[]> {\n    return await db.select().from(stormSessions).where(isNull(stormSessions.deletedAt));\n  }\n\n  async getStormSession(id: string): Promise<StormSession | undefined> {\n    const [session] = await db.select().from(stormSessions).where(\n      and(\n        eq(stormSessions.id, id),\n        isNull(stormSessions.deletedAt)\n      )\n    );\n    return session;\n  }\n\n  async updateStormSession(id: string, updates: Partial<InsertStormSession>): Promise<StormSession | undefined> {\n    const [updated] = await db\n      .update(stormSessions)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(stormSessions.id, id))\n      .returning();\n    return updated;\n  }\n\n  async closeStormSession(id: string): Promise<StormSession | undefined> {\n    const [closed] = await db\n      .update(stormSessions)\n      .set({ status: 'CLOSED', closedAt: new Date(), updatedAt: new Date() })\n      .where(eq(stormSessions.id, id))\n      .returning();\n    return closed;\n  }\n\n  async deactivateAllSessions(): Promise<void> {\n    await db\n      .update(stormSessions)\n      .set({ isActive: false, updatedAt: new Date() })\n      .where(isNull(stormSessions.deletedAt));\n  }\n\n  async reopenStormSession(id: string): Promise<StormSession | undefined> {\n    const [reopened] = await db\n      .update(stormSessions)\n      .set({ status: 'DRAFT', isActive: false, updatedAt: new Date() })\n      .where(eq(stormSessions.id, id))\n      .returning();\n    return reopened;\n  }\n\n  async activateStormSession(id: string): Promise<StormSession | undefined> {\n    // First deactivate all sessions\n    await this.deactivateAllSessions();\n    \n    // Then activate the target session and set status to ACTIVE\n    const [activated] = await db\n      .update(stormSessions)\n      .set({ isActive: true, status: 'ACTIVE', updatedAt: new Date() })\n      .where(\n        and(\n          eq(stormSessions.id, id),\n          isNull(stormSessions.deletedAt)\n        )\n      )\n      .returning();\n    return activated;\n  }\n\n  async deactivateStormSession(id: string): Promise<StormSession | undefined> {\n    const [deactivated] = await db\n      .update(stormSessions)\n      .set({ isActive: false, status: 'DRAFT', updatedAt: new Date() })\n      .where(eq(stormSessions.id, id))\n      .returning();\n    return deactivated;\n  }\n\n  async getActiveStormSession(): Promise<StormSession | undefined> {\n    const [activeSession] = await db\n      .select()\n      .from(stormSessions)\n      .where(\n        and(\n          eq(stormSessions.isActive, true),\n          isNull(stormSessions.deletedAt)\n        )\n      )\n      .limit(1);\n    return activeSession;\n  }\n\n  async addContractorToSession(sessionId: string, contractorCompanyId: string): Promise<void> {\n    await db.insert(sessionContractors).values({\n      sessionId,\n      contractorCompanyId,\n    }).onConflictDoNothing();\n  }\n\n  async removeContractorFromSession(sessionId: string, contractorCompanyId: string): Promise<void> {\n    await db\n      .delete(sessionContractors)\n      .where(\n        and(\n          eq(sessionContractors.sessionId, sessionId),\n          eq(sessionContractors.contractorCompanyId, contractorCompanyId)\n        )\n      );\n  }\n\n  // Rosters\n  async createRoster(rosterData: InsertRoster): Promise<Roster> {\n    const [roster] = await db.insert(rosters).values(rosterData).returning();\n    return roster;\n  }\n\n  async getRostersBySession(sessionId: string): Promise<Roster[]> {\n    return await db\n      .select()\n      .from(rosters)\n      .where(and(eq(rosters.sessionId, sessionId), isNull(rosters.deletedAt)));\n  }\n\n  async getRostersByCompany(companyId: string): Promise<Roster[]> {\n    return await db\n      .select()\n      .from(rosters)\n      .where(and(eq(rosters.companyId, companyId), isNull(rosters.deletedAt)));\n  }\n\n  async getRoster(id: string): Promise<Roster | undefined> {\n    const [roster] = await db\n      .select()\n      .from(rosters)\n      .where(and(eq(rosters.id, id), isNull(rosters.deletedAt)));\n    return roster;\n  }\n\n  async updateRoster(id: string, updates: Partial<InsertRoster>): Promise<Roster | undefined> {\n    const [updated] = await db\n      .update(rosters)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(rosters.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteRoster(id: string): Promise<void> {\n    // Soft delete\n    await db.update(rosters).set({ deletedAt: new Date() }).where(eq(rosters.id, id));\n  }\n\n  // Crews\n  async createCrew(crewData: InsertCrew): Promise<Crew> {\n    const [crew] = await db.insert(crews).values(crewData).returning();\n    return crew;\n  }\n\n  async getCrewsByRoster(rosterId: string): Promise<Crew[]> {\n    return await db\n      .select()\n      .from(crews)\n      .where(and(eq(crews.rosterId, rosterId), isNull(crews.deletedAt)));\n  }\n\n  async getCrew(id: string): Promise<Crew | undefined> {\n    const [crew] = await db\n      .select()\n      .from(crews)\n      .where(and(eq(crews.id, id), isNull(crews.deletedAt)));\n    return crew;\n  }\n\n  async updateCrew(id: string, updates: Partial<InsertCrew>): Promise<Crew | undefined> {\n    const [updated] = await db\n      .update(crews)\n      .set(updates)\n      .where(eq(crews.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCrew(id: string): Promise<void> {\n    // Soft delete\n    await db.update(crews).set({ deletedAt: new Date() }).where(eq(crews.id, id));\n  }\n\n  // Roster Personnel\n  async addRosterPersonnel(personnelData: InsertRosterPersonnel): Promise<RosterPersonnel> {\n    const [personnel] = await db.insert(rosterPersonnel).values(personnelData).returning();\n    return personnel;\n  }\n\n  async getRosterPersonnel(rosterId: string): Promise<RosterPersonnel[]> {\n    return await db\n      .select()\n      .from(rosterPersonnel)\n      .where(and(eq(rosterPersonnel.rosterId, rosterId), isNull(rosterPersonnel.deletedAt)));\n  }\n\n  async updateRosterPersonnel(id: string, updates: Partial<InsertRosterPersonnel>): Promise<RosterPersonnel | undefined> {\n    const [updated] = await db\n      .update(rosterPersonnel)\n      .set(updates)\n      .where(eq(rosterPersonnel.id, id))\n      .returning();\n    return updated;\n  }\n\n  async removeRosterPersonnel(id: string): Promise<void> {\n    // Soft delete\n    await db.update(rosterPersonnel).set({ deletedAt: new Date() }).where(eq(rosterPersonnel.id, id));\n  }\n\n  // Roster Equipment\n  async addRosterEquipment(equipmentData: InsertRosterEquipment): Promise<RosterEquipment> {\n    const [equipment] = await db.insert(rosterEquipment).values(equipmentData).returning();\n    return equipment;\n  }\n\n  async getRosterEquipment(rosterId: string): Promise<RosterEquipment[]> {\n    return await db\n      .select()\n      .from(rosterEquipment)\n      .where(and(eq(rosterEquipment.rosterId, rosterId), isNull(rosterEquipment.deletedAt)));\n  }\n\n  async updateRosterEquipment(id: string, updates: Partial<InsertRosterEquipment>): Promise<RosterEquipment | undefined> {\n    const [updated] = await db\n      .update(rosterEquipment)\n      .set(updates)\n      .where(eq(rosterEquipment.id, id))\n      .returning();\n    return updated;\n  }\n\n  async removeRosterEquipment(id: string): Promise<void> {\n    // Soft delete\n    await db.update(rosterEquipment).set({ deletedAt: new Date() }).where(eq(rosterEquipment.id, id));\n  }\n\n  // Timesheets\n  async createTimesheet(timesheetData: InsertTimesheet): Promise<Timesheet> {\n    const [timesheet] = await db.insert(timesheets).values(timesheetData).returning();\n    return timesheet;\n  }\n\n  async getTimesheetsBySession(sessionId: string): Promise<Timesheet[]> {\n    return await db\n      .select()\n      .from(timesheets)\n      .where(and(eq(timesheets.sessionId, sessionId), isNull(timesheets.deletedAt)));\n  }\n\n  async getTimesheetsByCompany(companyId: string): Promise<Timesheet[]> {\n    return await db\n      .select()\n      .from(timesheets)\n      .where(and(eq(timesheets.companyId, companyId), isNull(timesheets.deletedAt)));\n  }\n\n  async getTimesheet(id: string): Promise<Timesheet | undefined> {\n    const [timesheet] = await db\n      .select()\n      .from(timesheets)\n      .where(and(eq(timesheets.id, id), isNull(timesheets.deletedAt)));\n    return timesheet;\n  }\n\n  async updateTimesheet(id: string, updates: Partial<InsertTimesheet>): Promise<Timesheet | undefined> {\n    const [updated] = await db\n      .update(timesheets)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(timesheets.id, id))\n      .returning();\n    return updated;\n  }\n\n  async submitTimesheet(id: string, userId: string): Promise<Timesheet | undefined> {\n    const [submitted] = await db\n      .update(timesheets)\n      .set({ \n        status: 'SUBMITTED', \n        submittedBy: userId,\n        updatedAt: new Date() \n      })\n      .where(eq(timesheets.id, id))\n      .returning();\n    return submitted;\n  }\n\n  async approveTimesheet(id: string, userId: string): Promise<Timesheet | undefined> {\n    const [approved] = await db\n      .update(timesheets)\n      .set({ \n        status: 'APPROVED', \n        approvedBy: userId,\n        updatedAt: new Date() \n      })\n      .where(eq(timesheets.id, id))\n      .returning();\n    return approved;\n  }\n\n  async deleteTimesheet(id: string): Promise<void> {\n    // Soft delete\n    await db.update(timesheets).set({ deletedAt: new Date() }).where(eq(timesheets.id, id));\n  }\n\n  // Timesheet Personnel\n  async addTimesheetPersonnel(personnelData: InsertTimesheetPersonnel): Promise<TimesheetPersonnel> {\n    const [personnel] = await db.insert(timesheetPersonnel).values(personnelData).returning();\n    return personnel;\n  }\n\n  async getTimesheetPersonnel(timesheetId: string): Promise<TimesheetPersonnel[]> {\n    return await db\n      .select()\n      .from(timesheetPersonnel)\n      .where(and(eq(timesheetPersonnel.timesheetId, timesheetId), isNull(timesheetPersonnel.deletedAt)));\n  }\n\n  async updateTimesheetPersonnel(id: string, updates: Partial<InsertTimesheetPersonnel>): Promise<TimesheetPersonnel | undefined> {\n    const [updated] = await db\n      .update(timesheetPersonnel)\n      .set(updates)\n      .where(eq(timesheetPersonnel.id, id))\n      .returning();\n    return updated;\n  }\n\n  async removeTimesheetPersonnel(id: string): Promise<void> {\n    await db.update(timesheetPersonnel).set({ deletedAt: new Date() }).where(eq(timesheetPersonnel.id, id));\n  }\n\n  // Timesheet Equipment\n  async addTimesheetEquipment(equipmentData: InsertTimesheetEquipment): Promise<TimesheetEquipment> {\n    const [equipment] = await db.insert(timesheetEquipment).values(equipmentData).returning();\n    return equipment;\n  }\n\n  async getTimesheetEquipment(timesheetId: string): Promise<TimesheetEquipment[]> {\n    return await db\n      .select()\n      .from(timesheetEquipment)\n      .where(and(eq(timesheetEquipment.timesheetId, timesheetId), isNull(timesheetEquipment.deletedAt)));\n  }\n\n  async updateTimesheetEquipment(id: string, updates: Partial<InsertTimesheetEquipment>): Promise<TimesheetEquipment | undefined> {\n    const [updated] = await db\n      .update(timesheetEquipment)\n      .set(updates)\n      .where(eq(timesheetEquipment.id, id))\n      .returning();\n    return updated;\n  }\n\n  async removeTimesheetEquipment(id: string): Promise<void> {\n    await db.update(timesheetEquipment).set({ deletedAt: new Date() }).where(eq(timesheetEquipment.id, id));\n  }\n\n  // Timesheet Lines (legacy)\n  async addTimesheetLine(lineData: InsertTimesheetLine): Promise<TimesheetLine> {\n    const [line] = await db.insert(timesheetLines).values(lineData).returning();\n    return line;\n  }\n\n  async getTimesheetLines(timesheetId: string): Promise<TimesheetLine[]> {\n    return await db\n      .select()\n      .from(timesheetLines)\n      .where(and(eq(timesheetLines.timesheetId, timesheetId), isNull(timesheetLines.deletedAt)));\n  }\n\n  async updateTimesheetLine(id: string, updates: Partial<InsertTimesheetLine>): Promise<TimesheetLine | undefined> {\n    const [updated] = await db\n      .update(timesheetLines)\n      .set(updates)\n      .where(eq(timesheetLines.id, id))\n      .returning();\n    return updated;\n  }\n\n  async removeTimesheetLine(id: string): Promise<void> {\n    // Soft delete\n    await db.update(timesheetLines).set({ deletedAt: new Date() }).where(eq(timesheetLines.id, id));\n  }\n\n  // Expenses\n  async createExpense(expenseData: InsertExpense): Promise<Expense> {\n    const [expense] = await db.insert(expenses).values(expenseData).returning();\n    return expense;\n  }\n\n  async getExpensesBySession(sessionId: string): Promise<Expense[]> {\n    return await db\n      .select()\n      .from(expenses)\n      .where(and(eq(expenses.sessionId, sessionId), isNull(expenses.deletedAt)));\n  }\n\n  async getExpensesByCompany(companyId: string): Promise<Expense[]> {\n    return await db\n      .select()\n      .from(expenses)\n      .where(and(eq(expenses.companyId, companyId), isNull(expenses.deletedAt)));\n  }\n\n  async getExpense(id: string): Promise<Expense | undefined> {\n    const [expense] = await db\n      .select()\n      .from(expenses)\n      .where(and(eq(expenses.id, id), isNull(expenses.deletedAt)));\n    return expense;\n  }\n\n  async updateExpense(id: string, updates: Partial<InsertExpense>): Promise<Expense | undefined> {\n    const [updated] = await db\n      .update(expenses)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(expenses.id, id))\n      .returning();\n    return updated;\n  }\n\n  async approveExpense(id: string, userId: string): Promise<Expense | undefined> {\n    const [approved] = await db\n      .update(expenses)\n      .set({ \n        status: 'APPROVED', \n        approvedBy: userId,\n        updatedAt: new Date() \n      })\n      .where(eq(expenses.id, id))\n      .returning();\n    return approved;\n  }\n\n  async rejectExpense(id: string, userId: string): Promise<Expense | undefined> {\n    const [rejected] = await db\n      .update(expenses)\n      .set({ \n        status: 'REJECTED', \n        approvedBy: userId,\n        updatedAt: new Date() \n      })\n      .where(eq(expenses.id, id))\n      .returning();\n    return rejected;\n  }\n\n  async deleteExpense(id: string): Promise<void> {\n    // Soft delete\n    await db.update(expenses).set({ deletedAt: new Date() }).where(eq(expenses.id, id));\n  }\n\n  // Expense Files\n  async addExpenseFile(fileData: InsertExpenseFile): Promise<ExpenseFile> {\n    const [file] = await db.insert(expenseFiles).values(fileData).returning();\n    return file;\n  }\n\n  async getExpenseFiles(expenseId: string): Promise<ExpenseFile[]> {\n    return await db\n      .select()\n      .from(expenseFiles)\n      .where(and(eq(expenseFiles.expenseId, expenseId), isNull(expenseFiles.deletedAt)));\n  }\n\n  async removeExpenseFile(id: string): Promise<void> {\n    // Soft delete\n    await db.update(expenseFiles).set({ deletedAt: new Date() }).where(eq(expenseFiles.id, id));\n  }\n\n  // Invoices\n  async createInvoice(invoiceData: InsertInvoice): Promise<Invoice> {\n    const [invoice] = await db.insert(invoices).values(invoiceData).returning();\n    return invoice;\n  }\n\n  async getInvoicesBySession(sessionId: string): Promise<Invoice[]> {\n    return await db\n      .select()\n      .from(invoices)\n      .where(and(eq(invoices.sessionId, sessionId), isNull(invoices.deletedAt)));\n  }\n\n  async getInvoicesByCompany(companyId: string): Promise<Invoice[]> {\n    return await db\n      .select()\n      .from(invoices)\n      .where(and(eq(invoices.companyId, companyId), isNull(invoices.deletedAt)));\n  }\n\n  async getInvoice(id: string): Promise<Invoice | undefined> {\n    const [invoice] = await db\n      .select()\n      .from(invoices)\n      .where(and(eq(invoices.id, id), isNull(invoices.deletedAt)));\n    return invoice;\n  }\n\n  async updateInvoice(id: string, updates: Partial<InsertInvoice>): Promise<Invoice | undefined> {\n    const [updated] = await db\n      .update(invoices)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(invoices.id, id))\n      .returning();\n    return updated;\n  }\n\n  async issueInvoice(id: string): Promise<Invoice | undefined> {\n    const [issued] = await db\n      .update(invoices)\n      .set({ \n        status: 'ISSUED', \n        issuedAt: new Date(),\n        updatedAt: new Date() \n      })\n      .where(eq(invoices.id, id))\n      .returning();\n    return issued;\n  }\n\n  async markInvoicePaid(id: string): Promise<Invoice | undefined> {\n    const [paid] = await db\n      .update(invoices)\n      .set({ \n        status: 'PAID',\n        updatedAt: new Date() \n      })\n      .where(eq(invoices.id, id))\n      .returning();\n    return paid;\n  }\n\n  async deleteInvoice(id: string): Promise<void> {\n    // Soft delete\n    await db.update(invoices).set({ deletedAt: new Date() }).where(eq(invoices.id, id));\n  }\n\n  // Invoice Lines\n  async addInvoiceLine(lineData: InsertInvoiceLine): Promise<InvoiceLine> {\n    const [line] = await db.insert(invoiceLines).values(lineData).returning();\n    return line;\n  }\n\n  async getInvoiceLines(invoiceId: string): Promise<InvoiceLine[]> {\n    return await db\n      .select()\n      .from(invoiceLines)\n      .where(and(eq(invoiceLines.invoiceId, invoiceId), isNull(invoiceLines.deletedAt)));\n  }\n\n  async updateInvoiceLine(id: string, updates: Partial<InsertInvoiceLine>): Promise<InvoiceLine | undefined> {\n    const [updated] = await db\n      .update(invoiceLines)\n      .set(updates)\n      .where(eq(invoiceLines.id, id))\n      .returning();\n    return updated;\n  }\n\n  async removeInvoiceLine(id: string): Promise<void> {\n    // Soft delete\n    await db.update(invoiceLines).set({ deletedAt: new Date() }).where(eq(invoiceLines.id, id));\n  }\n\n  // Crew Availability\n  async createCrewAvailability(insertAvailability: InsertCrewAvailability): Promise<CrewAvailability> {\n    // Assign to active session if no sessionId provided\n    let availabilityData = { ...insertAvailability };\n    if (!availabilityData.sessionId) {\n      const activeSession = await this.getActiveAvailabilitySession();\n      if (activeSession) {\n        availabilityData.sessionId = activeSession.id;\n      }\n    }\n    \n    const [availability] = await db.insert(crewAvailability).values(availabilityData).returning();\n    return availability;\n  }\n\n  async getCrewAvailabilityByContractor(contractorId: number): Promise<CrewAvailability[]> {\n    return await db.select().from(crewAvailability).where(eq(crewAvailability.contractorId, contractorId));\n  }\n\n  async getAllCrewAvailability(): Promise<CrewAvailability[]> {\n    return await db.select().from(crewAvailability);\n  }\n\n  async updateCrewAvailability(id: number, updates: Partial<InsertCrewAvailability>): Promise<CrewAvailability | undefined> {\n    const [updated] = await db.update(crewAvailability)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(crewAvailability.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCrewAvailability(id: number): Promise<void> {\n    await db.delete(crewAvailability).where(eq(crewAvailability.id, id));\n  }\n\n  // Equipment Availability\n  async createEquipmentAvailability(insertEquipment: InsertEquipmentAvailability): Promise<EquipmentAvailability> {\n    const [equipment] = await db.insert(equipmentAvailability).values(insertEquipment).returning();\n    return equipment;\n  }\n\n  async getEquipmentAvailabilityByContractor(contractorId: number): Promise<EquipmentAvailability[]> {\n    return await db.select().from(equipmentAvailability).where(eq(equipmentAvailability.contractorId, contractorId));\n  }\n\n  async getEquipmentAvailabilityByCrew(crewAvailabilityId: number): Promise<EquipmentAvailability[]> {\n    return await db.select().from(equipmentAvailability).where(eq(equipmentAvailability.crewAvailabilityId, crewAvailabilityId));\n  }\n\n  async deleteEquipmentAvailability(id: number): Promise<void> {\n    await db.delete(equipmentAvailability).where(eq(equipmentAvailability.id, id));\n  }\n\n  // Availability Submissions\n  async createAvailabilitySubmission(insertSubmission: InsertAvailabilitySubmission): Promise<AvailabilitySubmission> {\n    const [submission] = await db.insert(availabilitySubmissions).values(insertSubmission).returning();\n    return submission;\n  }\n\n  async getAvailabilitySubmissions(): Promise<AvailabilitySubmission[]> {\n    return await db.select().from(availabilitySubmissions);\n  }\n\n  async updateAvailabilitySubmission(id: number, updates: Partial<AvailabilitySubmission>): Promise<AvailabilitySubmission | undefined> {\n    const [updated] = await db.update(availabilitySubmissions)\n      .set(updates)\n      .where(eq(availabilitySubmissions.id, id))\n      .returning();\n    return updated;\n  }\n\n  // Availability Sessions\n  async createAvailabilitySession(insertSession: InsertAvailabilitySession): Promise<AvailabilitySession> {\n    const [session] = await db.insert(availabilitySessions).values(insertSession).returning();\n    return session;\n  }\n\n  async getAvailabilitySessions(): Promise<AvailabilitySession[]> {\n    return await db.select().from(availabilitySessions).orderBy(availabilitySessions.createdAt);\n  }\n\n  async getAvailabilitySessionById(id: number): Promise<AvailabilitySession | undefined> {\n    const [session] = await db.select()\n      .from(availabilitySessions)\n      .where(eq(availabilitySessions.id, id))\n      .limit(1);\n    return session;\n  }\n\n  async getActiveAvailabilitySession(): Promise<AvailabilitySession | undefined> {\n    const [session] = await db.select()\n      .from(availabilitySessions)\n      .where(eq(availabilitySessions.isActive, true))\n      .limit(1);\n    return session;\n  }\n\n  async closeAvailabilitySession(id: number): Promise<AvailabilitySession | undefined> {\n    const [updated] = await db.update(availabilitySessions)\n      .set({ isActive: false, endDate: new Date(), closedAt: new Date() })\n      .where(eq(availabilitySessions.id, id))\n      .returning();\n    return updated;\n  }\n\n  async startNewAvailabilitySession(label?: string): Promise<AvailabilitySession> {\n    // Close any existing active session\n    const activeSession = await this.getActiveAvailabilitySession();\n    if (activeSession) {\n      await this.closeAvailabilitySession(activeSession.id);\n    } else {\n      // If no active session, create a snapshot session for unassigned records\n      const unassignedRecords = await db.select()\n        .from(crewAvailability)\n        .where(isNull(crewAvailability.sessionId));\n      \n      if (unassignedRecords.length > 0) {\n        const snapshotSession = await this.createAvailabilitySession({\n          label: `Historical Data - ${new Date().toLocaleDateString()}`,\n          isActive: false,\n          endDate: new Date(),\n          closedAt: new Date()\n        });\n        \n        // Assign unassigned records to the snapshot\n        await this.assignUnassignedToSession(snapshotSession.id);\n      }\n    }\n\n    // Create new active session with provided label or default\n    const newLabel = label || `Week of ${new Date().toLocaleDateString()}`;\n    return await this.createAvailabilitySession({\n      label: newLabel,\n      isActive: true\n    });\n  }\n\n  async getCrewAvailabilityBySession(sessionId?: number | 'active' | 'unassigned'): Promise<CrewAvailability[]> {\n    if (sessionId === 'active') {\n      const activeSession = await this.getActiveAvailabilitySession();\n      if (!activeSession) return [];\n      return await db.select()\n        .from(crewAvailability)\n        .where(eq(crewAvailability.sessionId, activeSession.id));\n    } else if (sessionId === 'unassigned') {\n      return await db.select()\n        .from(crewAvailability)\n        .where(isNull(crewAvailability.sessionId));\n    } else if (sessionId) {\n      return await db.select()\n        .from(crewAvailability)\n        .where(eq(crewAvailability.sessionId, sessionId));\n    } else {\n      // Default to active session\n      return await this.getCrewAvailabilityBySession('active');\n    }\n  }\n\n  async assignUnassignedToSession(sessionId: number): Promise<void> {\n    await db.update(crewAvailability)\n      .set({ sessionId })\n      .where(isNull(crewAvailability.sessionId));\n  }\n\n  // Incident Management\n  async createIncident(insertIncident: InsertIncident): Promise<Incident> {\n    const [incident] = await db.insert(incidents).values(insertIncident).returning();\n    return incident;\n  }\n\n  async getAllIncidents(): Promise<Incident[]> {\n    return await db.select().from(incidents).orderBy(incidents.createdAt);\n  }\n\n  async getIncident(id: number): Promise<Incident | undefined> {\n    const [incident] = await db.select().from(incidents).where(eq(incidents.id, id)).limit(1);\n    return incident;\n  }\n\n  async updateIncident(id: number, updates: Partial<InsertIncident>): Promise<Incident | undefined> {\n    const [updated] = await db\n      .update(incidents)\n      .set(updates)\n      .where(eq(incidents.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteIncident(id: number): Promise<void> {\n    await db.delete(incidents).where(eq(incidents.id, id));\n  }\n\n  // Incident Assignments\n  async createIncidentAssignment(insertAssignment: InsertIncidentAssignment): Promise<IncidentAssignment> {\n    const [assignment] = await db.insert(incidentAssignments).values(insertAssignment).returning();\n    return assignment;\n  }\n\n  async getIncidentAssignments(incidentId?: number): Promise<IncidentAssignment[]> {\n    if (incidentId) {\n      return await db.select().from(incidentAssignments).where(eq(incidentAssignments.incidentId, incidentId));\n    }\n    return await db.select().from(incidentAssignments);\n  }\n\n  async updateIncidentAssignment(id: number, updates: Partial<InsertIncidentAssignment>): Promise<IncidentAssignment | undefined> {\n    const [updated] = await db\n      .update(incidentAssignments)\n      .set(updates)\n      .where(eq(incidentAssignments.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteIncidentAssignment(id: number): Promise<void> {\n    await db.delete(incidentAssignments).where(eq(incidentAssignments.id, id));\n  }\n\n  // Crew Rosters\n  async createCrewRoster(insertRoster: InsertCrewRoster): Promise<CrewRoster> {\n    const [roster] = await db.insert(crewRosters).values(insertRoster).returning();\n    return roster;\n  }\n\n  async getCrewRostersByAssignment(assignmentId: number): Promise<CrewRoster[]> {\n    return await db.select().from(crewRosters).where(eq(crewRosters.incidentAssignmentId, assignmentId));\n  }\n\n  async updateCrewRoster(id: number, updates: Partial<InsertCrewRoster>): Promise<CrewRoster | undefined> {\n    const [updated] = await db\n      .update(crewRosters)\n      .set({ ...updates, updatedAt: new Date() })\n      .where(eq(crewRosters.id, id))\n      .returning();\n    return updated;\n  }\n\n  async deleteCrewRoster(id: number): Promise<void> {\n    await db.delete(crewRosters).where(eq(crewRosters.id, id));\n  }\n\n  // ===== TICKETING MODULE =====\n\n  async createIssueType(insertData: InsertIssueType): Promise<IssueType> {\n    const [result] = await db.insert(issueTypes).values(insertData).returning();\n    return result;\n  }\n\n  async getAllIssueTypes(): Promise<IssueType[]> {\n    return await db.select().from(issueTypes).orderBy(issueTypes.name);\n  }\n\n  async getIssueType(id: string): Promise<IssueType | undefined> {\n    const [result] = await db.select().from(issueTypes).where(eq(issueTypes.id, id)).limit(1);\n    return result;\n  }\n\n  async updateIssueType(id: string, updates: Partial<InsertIssueType>): Promise<IssueType | undefined> {\n    const [result] = await db.update(issueTypes).set({ ...updates, updatedAt: new Date() }).where(eq(issueTypes.id, id)).returning();\n    return result;\n  }\n\n  async createTicket(insertData: InsertTicket): Promise<Ticket> {\n    const [result] = await db.insert(tickets).values(insertData).returning();\n    return result;\n  }\n\n  async getTicket(id: string): Promise<Ticket | undefined> {\n    const [result] = await db.select().from(tickets).where(eq(tickets.id, id)).limit(1);\n    return result;\n  }\n\n  async getTicketsBySession(sessionId: string): Promise<Ticket[]> {\n    return await db.select().from(tickets).where(eq(tickets.sessionId, sessionId)).orderBy(tickets.createdAt);\n  }\n\n  async getTicketsByCompany(companyId: string): Promise<Ticket[]> {\n    return await db.select().from(tickets).where(eq(tickets.companyId, companyId)).orderBy(tickets.createdAt);\n  }\n\n  async updateTicket(id: string, updates: Partial<InsertTicket>): Promise<Ticket | undefined> {\n    const [result] = await db.update(tickets).set({ ...updates, updatedAt: new Date() }).where(eq(tickets.id, id)).returning();\n    return result;\n  }\n\n  async createTicketAssignment(insertData: InsertTicketAssignment): Promise<TicketAssignment> {\n    const [result] = await db.insert(ticketAssignments).values(insertData).returning();\n    return result;\n  }\n\n  async getTicketAssignments(ticketId: string): Promise<TicketAssignment[]> {\n    return await db.select().from(ticketAssignments).where(eq(ticketAssignments.ticketId, ticketId));\n  }\n\n  async getActiveTicketAssignment(ticketId: string): Promise<TicketAssignment | undefined> {\n    const [result] = await db.select().from(ticketAssignments)\n      .where(and(eq(ticketAssignments.ticketId, ticketId), eq(ticketAssignments.isActive, true)))\n      .limit(1);\n    return result;\n  }\n\n  async updateTicketAssignment(id: string, updates: Partial<InsertTicketAssignment>): Promise<TicketAssignment | undefined> {\n    const [result] = await db.update(ticketAssignments).set(updates).where(eq(ticketAssignments.id, id)).returning();\n    return result;\n  }\n\n  async createTicketStatusEvent(insertData: InsertTicketStatusEvent): Promise<TicketStatusEvent> {\n    const [result] = await db.insert(ticketStatusEvents).values(insertData).returning();\n    return result;\n  }\n\n  async getTicketStatusEvents(ticketId: string): Promise<TicketStatusEvent[]> {\n    return await db.select().from(ticketStatusEvents).where(eq(ticketStatusEvents.ticketId, ticketId)).orderBy(ticketStatusEvents.changedAt);\n  }\n\n  async createTicketWorkSegment(insertData: InsertTicketWorkSegment): Promise<TicketWorkSegment> {\n    const [result] = await db.insert(ticketWorkSegments).values(insertData).returning();\n    return result;\n  }\n\n  async getOpenWorkSegment(ticketId: string, crewId: string): Promise<TicketWorkSegment | undefined> {\n    const [result] = await db.select().from(ticketWorkSegments)\n      .where(and(\n        eq(ticketWorkSegments.ticketId, ticketId),\n        eq(ticketWorkSegments.crewId, crewId),\n        isNull(ticketWorkSegments.endedAt)\n      ))\n      .limit(1);\n    return result;\n  }\n\n  async closeWorkSegment(id: string): Promise<TicketWorkSegment | undefined> {\n    const [result] = await db.update(ticketWorkSegments)\n      .set({ endedAt: new Date() })\n      .where(eq(ticketWorkSegments.id, id))\n      .returning();\n    return result;\n  }\n\n  async getWorkSegmentsByTicket(ticketId: string): Promise<TicketWorkSegment[]> {\n    return await db.select().from(ticketWorkSegments).where(eq(ticketWorkSegments.ticketId, ticketId));\n  }\n\n  async createNotification(insertData: InsertNotification): Promise<Notification> {\n    const [result] = await db.insert(notifications).values(insertData).returning();\n    return result;\n  }\n\n  async getNotificationsByUser(userId: string): Promise<Notification[]> {\n    return await db.select().from(notifications).where(eq(notifications.userId, userId)).orderBy(notifications.createdAt);\n  }\n\n  async markNotificationRead(id: string): Promise<Notification | undefined> {\n    const [result] = await db.update(notifications).set({ readAt: new Date() }).where(eq(notifications.id, id)).returning();\n    return result;\n  }\n}\n\nexport const storage = new DatabaseStorage();\n","path":null,"size_bytes":80319,"size_tokens":null},"client/src/components/Sidebar.tsx":{"content":"import React, { useState, useRef, useEffect } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Input } from \"@/components/ui/input\";\nimport { CloudUpload, Crosshair, X, FileArchive, MapPin, Search, Filter, RefreshCw } from \"lucide-react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { formatDuration, getMarkerColor } from \"@/lib/mapUtils\";\nimport WeatherOverlayPanel from \"./WeatherOverlayPanel\";\nimport type { Resource, AnalysisPoint } from \"@shared/schema\";\n\ninterface SidebarProps {\n  resources: Resource[];\n  analysisPoints: AnalysisPoint[];\n  onUploadFile: (file: File) => void;\n  onCreatePoint: (point: { label: string; latitude: number; longitude: number }) => void;\n  onDeletePoint: (id: number) => void;\n  onSelectPoint: (id: number | null) => void;\n  selectedPointId: number | null;\n  isLoading: boolean;\n  isSelectingPoint: boolean;\n  onTogglePointSelection: () => void;\n  onClosestDistanceChange?: (distance: number | null) => void;\n  onMaxDistanceChange?: (distance: number | null) => void;\n  onMaxHoursChange?: (hours: number | null) => void;\n  onRecalculateDistances?: (pointId: number, maxDistance?: number) => void;\n  onToggleOutlookLayer?: (enabled: boolean) => void;\n  onToggleUtilitiesLayer?: (enabled: boolean) => void;\n  isOutlookLayerVisible?: boolean;\n  isUtilitiesLayerVisible?: boolean;\n  visibleDays?: { [key: number]: boolean };\n  onToggleDay?: (day: number, enabled: boolean) => void;\n}\n\nexport default function Sidebar({\n  resources,\n  analysisPoints,\n  onUploadFile,\n  onCreatePoint,\n  onDeletePoint,\n  onSelectPoint,\n  selectedPointId,\n  isLoading,\n  isSelectingPoint,\n  onTogglePointSelection,\n  onClosestDistanceChange,\n  onMaxDistanceChange,\n  onMaxHoursChange,\n  onRecalculateDistances,\n  onToggleOutlookLayer = () => {},\n  onToggleUtilitiesLayer = () => {},\n  isOutlookLayerVisible = false,\n  isUtilitiesLayerVisible = false,\n  visibleDays = { 1: true, 2: true, 3: true },\n  onToggleDay = () => {}\n}: SidebarProps) {\n  const [sortBy, setSortBy] = useState('distance');\n  const [addressInput, setAddressInput] = useState('');\n  const [isGeocodingAddress, setIsGeocodingAddress] = useState(false);\n  const [maxDistance, setMaxDistance] = useState('');\n  const [maxHours, setMaxHours] = useState('');\n  \n  // Conversion factors: assume 55 mph average driving speed\n  const convertDistanceToHours = (distance: number): number => {\n    return distance / 55; // miles per hour\n  };\n  \n  const convertHoursToDistance = (hours: number): number => {\n    return hours * 55; // miles\n  };\n  const [isDragOver, setIsDragOver] = useState(false);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n\n  const { data: calculations = [], isLoading: isCalculating } = useQuery<any[]>({\n    queryKey: [`/api/analysis-points/${selectedPointId}/calculations`],\n    enabled: !!selectedPointId,\n  });\n\n  // Notify parent when maxDistance changes\n  useEffect(() => {\n    const distanceValue = maxDistance ? parseFloat(maxDistance) : null;\n    onMaxDistanceChange?.(distanceValue);\n  }, [maxDistance, onMaxDistanceChange]);\n\n  // Notify parent when maxHours changes\n  useEffect(() => {\n    const hoursValue = maxHours ? parseFloat(maxHours) : null;\n    onMaxHoursChange?.(hoursValue);\n  }, [maxHours, onMaxHoursChange]);\n\n  // Filter and sort calculations by distance and hours\n  const filteredCalculations = calculations\n    .filter((calc: any) => {\n      const distanceValue = calc.distance;\n      const maxDistanceValue = maxDistance ? parseFloat(maxDistance) : null;\n      \n      // Filter by distance if specified (show resources WITHIN the distance)\n      if (maxDistanceValue && distanceValue > maxDistanceValue) {\n        return false;\n      }\n      \n      // Filter by hours if specified (convert miles to hours at 55mph)\n      if (maxHours) {\n        const hoursToDestination = distanceValue / 55; // 55 mph average speed\n        const maxHoursValue = parseFloat(maxHours);\n        if (hoursToDestination > maxHoursValue) {\n          return false;\n        }\n      }\n      \n      return true;\n    })\n    .sort((a: any, b: any) => {\n      // Sort calculations based on sortBy value\n      switch (sortBy) {\n        case 'time':\n        case 'duration':\n          return a.duration - b.duration;\n        case 'name':\n          return a.resource?.name?.localeCompare(b.resource?.name) || 0;\n        case 'distance':\n        default:\n          return a.distance - b.distance;\n      }\n    });\n\n  // Get the closest distance for circle visualization\n  const closestDistance = filteredCalculations.length > 0 \n    ? Math.min(...(filteredCalculations as any[]).map((c: any) => c.distance))\n    : null;\n\n  // Notify parent of closest distance changes\n  useEffect(() => {\n    if (onClosestDistanceChange) {\n      onClosestDistanceChange(closestDistance);\n    }\n  }, [closestDistance, onClosestDistanceChange]);\n\n  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (file) {\n      onUploadFile(file);\n    }\n  };\n\n  const handlePointSelection = () => {\n    onTogglePointSelection();\n  };\n\n  const handleAddressGeocode = async () => {\n    if (!addressInput.trim()) return;\n    \n    setIsGeocodingAddress(true);\n    try {\n      // Use OpenStreetMap Nominatim for geocoding (free service)\n      const response = await fetch(\n        `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(addressInput)}&format=json&limit=1&countrycodes=us`\n      );\n      \n      if (!response.ok) throw new Error('Geocoding failed');\n      \n      const results = await response.json();\n      \n      if (results.length > 0) {\n        const result = results[0];\n        const pointLabel = `${addressInput} (${String.fromCharCode(65 + analysisPoints.length)})`;\n        \n        onCreatePoint({\n          label: pointLabel,\n          latitude: parseFloat(result.lat),\n          longitude: parseFloat(result.lon),\n        });\n        \n        setAddressInput('');\n      } else {\n        alert('Address not found. Please try a different address or use the map to select a point.');\n      }\n    } catch (error) {\n      alert('Failed to geocode address. Please try again or use the map to select a point.');\n    } finally {\n      setIsGeocodingAddress(false);\n    }\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(true);\n  };\n\n  const handleDragLeave = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n  };\n\n  const handleDrop = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n    \n    const files = e.dataTransfer.files;\n    if (files.length > 0) {\n      const file = files[0];\n      const ext = file.name.toLowerCase();\n      if (ext.endsWith('.kmz') || ext.endsWith('.kml') || ext.endsWith('.csv') || ext.endsWith('.xlsx') || ext.endsWith('.xls')) {\n        onUploadFile(file);\n      } else {\n        alert('Please upload a KMZ, KML, CSV, or Excel file.');\n      }\n    }\n  };\n\n  return (\n    <div className=\"w-80 bg-white shadow-lg border-r border-gray-200 flex flex-col h-full overflow-y-auto\">\n      <div className=\"p-4 border-b border-gray-200\">\n        <h3 className=\"font-medium text-gray-900 mb-3\">Resource Information</h3>\n        \n        {resources.length > 0 ? (\n          <Card className=\"bg-emerald-50 border-emerald-200\">\n            <CardContent className=\"p-3\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"flex items-center space-x-2\">\n                  <FileArchive className=\"text-emerald-600\" size={16} />\n                  <span className=\"text-sm font-medium text-emerald-800\">Resources loaded</span>\n                </div>\n                <Badge variant=\"secondary\" className=\"text-emerald-600 bg-emerald-100\">\n                  {resources.length} resources\n                </Badge>\n              </div>\n            </CardContent>\n          </Card>\n        ) : (\n          <Card className=\"bg-blue-50 border-blue-200\">\n            <CardContent className=\"p-3\">\n              <div className=\"text-center\">\n                <p className=\"text-sm text-blue-800\">Upload contractors from the Contractors page to see resources on the map</p>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n\n\n      {/* Map Controls */}\n      <div className=\"p-4 border-b border-gray-200\">\n        <h3 className=\"font-medium text-gray-900 mb-3\">Analysis Points</h3>\n        \n        {/* Address Input */}\n        <div className=\"mb-3\">\n          <div className=\"flex flex-col sm:flex-row gap-2\">\n            <Input\n              placeholder=\"Enter address or zip code...\"\n              value={addressInput}\n              onChange={(e) => setAddressInput(e.target.value)}\n              onKeyPress={(e) => e.key === 'Enter' && handleAddressGeocode()}\n              className=\"flex-1 min-h-[44px]\"\n            />\n            <Button \n              onClick={handleAddressGeocode}\n              disabled={!addressInput.trim() || isGeocodingAddress}\n              size=\"sm\"\n              className=\"min-h-[44px] w-full sm:w-auto\"\n            >\n              {isGeocodingAddress ? (\n                <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white\"></div>\n              ) : (\n                <Search size={16} />\n              )}\n            </Button>\n          </div>\n        </div>\n\n        <div className=\"relative mb-3\">\n          <div className=\"absolute inset-0 flex items-center\">\n            <span className=\"w-full border-t border-gray-300\" />\n          </div>\n          <div className=\"relative flex justify-center text-xs\">\n            <span className=\"bg-white px-2 text-gray-500\">OR</span>\n          </div>\n        </div>\n        \n        <Button \n          className=\"w-full mb-3\" \n          onClick={handlePointSelection}\n          disabled={isSelectingPoint}\n          variant={isSelectingPoint ? \"default\" : \"outline\"}\n        >\n          <MapPin className=\"mr-2\" size={16} />\n          {isSelectingPoint ? 'Click on Map to Place Point' : 'Select Point on Map'}\n        </Button>\n        \n        {analysisPoints.map((point) => (\n          <Card key={point.id} className={`mb-2 ${selectedPointId === point.id ? 'ring-2 ring-primary' : ''}`}>\n            <CardContent className=\"p-3\">\n              <div className=\"flex items-center justify-between\">\n                <div className=\"cursor-pointer flex-1\" onClick={() => onSelectPoint(point.id)}>\n                  <div className=\"text-sm font-medium text-blue-900\">{point.label}</div>\n                  <div className=\"text-xs text-blue-600\">\n                    {point.latitude.toFixed(4)}, {point.longitude.toFixed(4)}\n                  </div>\n                </div>\n                <Button\n                  variant=\"ghost\"\n                  size=\"sm\"\n                  onClick={() => onDeletePoint(point.id)}\n                  className=\"text-blue-600 hover:text-blue-800 p-1\"\n                >\n                  <X size={14} />\n                </Button>\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n      </div>\n\n      {/* Results Section */}\n      <div className=\"flex-1 p-4\">\n        <div className=\"mb-3\">\n          <div className=\"flex items-center justify-between mb-2\">\n            <h3 className=\"font-medium text-gray-900\">Closest Resources</h3>\n            <Select value={sortBy} onValueChange={setSortBy}>\n              <SelectTrigger className=\"w-auto\">\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"distance\">Sort by Distance</SelectItem>\n                <SelectItem value=\"time\">Sort by Time</SelectItem>\n                <SelectItem value=\"name\">Sort by Name</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          \n          {/* Distance Filter */}\n          <div className=\"flex flex-col sm:flex-row gap-2 mb-2\">\n            <Input\n              placeholder=\"Max distance (miles)\"\n              value={maxDistance}\n              onChange={(e) => {\n                const distance = e.target.value;\n                setMaxDistance(distance);\n                // Auto-fill hours when distance changes\n                if (distance && !isNaN(parseFloat(distance))) {\n                  const hours = convertDistanceToHours(parseFloat(distance));\n                  setMaxHours(hours.toFixed(1));\n                  onMaxDistanceChange?.(parseFloat(distance));\n                  onMaxHoursChange?.(hours);\n                } else {\n                  setMaxHours('');\n                  onMaxDistanceChange?.(null);\n                  onMaxHoursChange?.(null);\n                }\n              }}\n              type=\"number\"\n              min=\"0\"\n              step=\"0.1\"\n              className=\"flex-1 min-h-[44px]\"\n            />\n            <Button \n              variant=\"outline\" \n              size=\"sm\"\n              onClick={() => {\n                setMaxDistance('');\n                setMaxHours('');\n                onMaxDistanceChange?.(null);\n                onMaxHoursChange?.(null);\n              }}\n              disabled={!maxDistance && !maxHours}\n              className=\"min-h-[44px] w-full sm:w-auto\"\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n\n          {/* Hours Filter */}\n          <div className=\"flex flex-col sm:flex-row gap-2 mb-2\">\n            <Input\n              placeholder=\"Max hours (driving @ 55mph)\"\n              value={maxHours}\n              onChange={(e) => {\n                const hours = e.target.value;\n                setMaxHours(hours);\n                // Auto-fill distance when hours changes\n                if (hours && !isNaN(parseFloat(hours))) {\n                  const distance = convertHoursToDistance(parseFloat(hours));\n                  setMaxDistance(distance.toFixed(1));\n                  onMaxDistanceChange?.(distance);\n                  onMaxHoursChange?.(parseFloat(hours));\n                } else {\n                  setMaxDistance('');\n                  onMaxDistanceChange?.(null);\n                  onMaxHoursChange?.(null);\n                }\n              }}\n              type=\"number\"\n              min=\"0\"\n              step=\"0.1\"\n              className=\"flex-1 min-h-[44px]\"\n            />\n            <Button \n              variant=\"outline\" \n              size=\"sm\"\n              onClick={() => {\n                setMaxDistance('');\n                setMaxHours('');\n                onMaxDistanceChange?.(null);\n                onMaxHoursChange?.(null);\n              }}\n              disabled={!maxDistance && !maxHours}\n              className=\"min-h-[44px] w-full sm:w-auto\"\n            >\n              <X className=\"h-4 w-4\" />\n            </Button>\n          </div>\n\n          {/* Recalculate Button */}\n          {selectedPointId && onRecalculateDistances && (\n            <Button \n              variant=\"outline\" \n              size=\"sm\"\n              onClick={() => onRecalculateDistances(selectedPointId, maxDistance ? parseFloat(maxDistance) : undefined)}\n              className=\"w-full mb-2\"\n            >\n              <RefreshCw className=\"h-4 w-4 mr-2\" />\n              Recalculate with Distance Filter\n            </Button>\n          )}\n        </div>\n\n        {/* Analysis Summary - individual resources shown in Results tab */}\n        {!selectedPointId ? (\n          <p className=\"text-sm text-gray-500 text-center py-8\">\n            Select an analysis point to see analysis summary\n          </p>\n        ) : isCalculating ? (\n          <Card className=\"p-3 bg-blue-50 border-blue-200\">\n            <div className=\"text-sm font-medium text-blue-900 mb-2\">Loading Analysis...</div>\n            <Skeleton className=\"h-4 w-3/4 mb-2\" />\n            <Skeleton className=\"h-3 w-1/2 mb-1\" />\n            <Skeleton className=\"h-3 w-2/3\" />\n          </Card>\n        ) : filteredCalculations.length === 0 ? (\n          <p className=\"text-sm text-gray-500 text-center py-8\">\n            No calculations available. Make sure resources are loaded.\n          </p>\n        ) : (\n          <Card className=\"bg-blue-50 border-blue-200\">\n            <CardContent className=\"p-3\">\n              <div className=\"text-sm font-medium text-blue-900 mb-2\">Analysis Summary</div>\n              <div className=\"grid grid-cols-2 gap-2 text-xs\">\n                <div>\n                  <span className=\"text-blue-600\">Closest:</span>\n                  <span className=\"font-medium text-blue-900 ml-1\">\n                    {Math.min(...(filteredCalculations as any[]).map((c: any) => c.distance)).toFixed(1)} mi\n                  </span>\n                </div>\n                <div>\n                  <span className=\"text-blue-600\">Avg Distance:</span>\n                  <span className=\"font-medium text-blue-900 ml-1\">\n                    {((filteredCalculations as any[]).reduce((sum: number, c: any) => sum + c.distance, 0) / (filteredCalculations as any[]).length).toFixed(1)} mi\n                  </span>\n                </div>\n                <div>\n                  <span className=\"text-blue-600\">Total Resources:</span>\n                  <span className=\"font-medium text-blue-900 ml-1\">{(filteredCalculations as any[]).length}</span>\n                </div>\n                <div>\n                  <span className=\"text-blue-600\">Within 10 mi:</span>\n                  <span className=\"font-medium text-blue-900 ml-1\">\n                    {(filteredCalculations as any[]).filter((c: any) => c.distance <= 10).length}\n                  </span>\n                </div>\n              </div>\n            </CardContent>\n          </Card>\n        )}\n      </div>\n      \n      {/* Weather Overlay Panel - Moved to bottom */}\n      <div className=\"p-4 border-t border-gray-200\">\n        <WeatherOverlayPanel\n          onToggleOutlookLayer={onToggleOutlookLayer}\n          onToggleUtilitiesLayer={onToggleUtilitiesLayer}\n          isOutlookLayerVisible={isOutlookLayerVisible}\n          isUtilitiesLayerVisible={isUtilitiesLayerVisible}\n          visibleDays={visibleDays}\n          onToggleDay={onToggleDay}\n        />\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":18479,"size_tokens":null},"server/services/csvParser.ts":{"content":"import Papa from 'papaparse';\nimport * as XLSX from 'xlsx';\nimport type { InsertResource } from '@shared/schema';\n\nexport interface CSVResource {\n  name: string;\n  type?: string;\n  latitude: number;\n  longitude: number;\n  description?: string;\n  address?: string;\n  // New contractor fields\n  category?: string;\n  pipefile?: string;\n  avetta?: string;\n  company?: string;\n  email?: string;\n  city?: string;\n  state?: string;\n  phone?: string;\n  birdRep?: string;\n  subRanking?: string;\n  fteCounts?: string;\n  pipefileUpdates?: string;\n  newMsaComplete?: string;\n  msaStatus?: string;\n  rating?: string;\n  companyId?: string;\n}\n\nexport async function parseCSVFile(filePath: string): Promise<CSVResource[]> {\n  const fs = await import('fs/promises');\n  const csvContent = await fs.readFile(filePath, 'utf-8');\n  \n  return new Promise((resolve, reject) => {\n    Papa.parse(csvContent, {\n      header: false, // Parse without headers first to handle complex structure\n      skipEmptyLines: true,\n      complete: (results) => {\n        try {\n          console.log('Raw CSV data sample:', results.data.slice(0, 5));\n          \n          // Find the actual header row\n          let headerRowIndex = -1;\n          let headers: string[] = [];\n          \n          for (let i = 0; i < Math.min(results.data.length, 100); i++) {\n            const row = results.data[i] as string[];\n            if (row && row.some(cell => cell && cell.toLowerCase().includes('latitude'))) {\n              headerRowIndex = i;\n              headers = row.map(h => h ? h.toLowerCase().trim() : '');\n              break;\n            }\n          }\n\n          console.log('Found headers at row:', headerRowIndex, headers);\n\n          if (headerRowIndex === -1) {\n            // No headers found, try positional parsing for this specific format\n            const resources: CSVResource[] = [];\n            \n            for (let i = 0; i < Math.min(results.data.length, 80); i++) {\n              const row = results.data[i] as string[];\n              if (!row || row.length < 11) continue;\n              \n              // Skip if this looks like a header row\n              if (row.some(cell => cell && cell.toLowerCase().includes('category'))) continue;\n              \n              const company = row[4]?.trim();\n              const name = row[3]?.trim();\n              const resourceName = company || name || 'Unnamed Resource';\n              const type = row[0]?.trim() || 'Unknown';\n              const latitude = parseFloat(row[9] || '0');\n              const longitude = parseFloat(row[10] || '0');\n              const address = row[8]?.trim() || '';\n              const description = row[15]?.trim() || '';\n\n              if (!isNaN(latitude) && !isNaN(longitude) && latitude !== 0 && longitude !== 0) {\n                resources.push({\n                  name: resourceName,\n                  type,\n                  latitude,\n                  longitude,\n                  description,\n                  address\n                });\n              }\n            }\n            \n            console.log('Parsed resources (positional):', resources.length);\n            resolve(resources);\n            return;\n          }\n\n          // Parse using your specific header structure - support both formats\n          const nameIndex = headers.findIndex(h => h.toLowerCase().trim() === 'name');\n          const companyIndex = headers.findIndex(h => h.toLowerCase().trim() === 'company');\n          const emailIndex = headers.findIndex(h => h.toLowerCase().trim() === 'email');\n          const phoneIndex = headers.findIndex(h => h.toLowerCase().trim() === 'phone');\n          const categoryIndex = headers.findIndex(h => h.toLowerCase().trim() === 'category');\n          const cityIndex = headers.findIndex(h => h.toLowerCase().trim() === 'city');\n          const stateIndex = headers.findIndex(h => h.toLowerCase().trim() === 'state');\n          const latIndex = headers.findIndex(h => h.toLowerCase().trim() === 'latitude');\n          const lngIndex = headers.findIndex(h => h.toLowerCase().trim() === 'longitude');\n          const birdRepIndex = headers.findIndex(h => h.toLowerCase().trim() === 'bird rep');\n          const pipefileIndex = headers.findIndex(h => h.toLowerCase().trim() === 'pipefile');\n          const avettaIndex = headers.findIndex(h => h.toLowerCase().trim() === 'avetta');\n          const subRankingIndex = headers.findIndex(h => {\n            const normalized = h.toLowerCase().trim().replace(/[-_\\s]/g, '');\n            return normalized === 'subranking' || normalized === 'sub' || h.toLowerCase().trim() === 'sub ranking' || h.toLowerCase().trim() === 'rating';\n          });\n          const ratingIndex = headers.findIndex(h => h.toLowerCase().trim() === 'star rating' || h.toLowerCase().trim() === 'overall rating');\n          const fteCountsIndex = headers.findIndex(h => h.toLowerCase().trim() === 'fte counts');\n          const pipefileUpdatesIndex = headers.findIndex(h => h.toLowerCase().trim() === 'pipefile updates');\n          const notesIndex = headers.findIndex(h => h.toLowerCase().trim() === 'notes');\n          const newMsaCompleteIndex = headers.findIndex(h => h.toLowerCase().trim() === 'new msa complete');\n          const msaStatusIndex = headers.findIndex(h => h.toLowerCase().trim() === 'msa status');\n          const companyIdIndex = headers.findIndex(h => h.toLowerCase().trim() === 'company id');\n          const addressIndex = headers.findIndex(h => h.toLowerCase().includes('address')); // Keep flexible for address field\n\n          const resources: CSVResource[] = [];\n          \n          for (let i = headerRowIndex + 1; i < results.data.length; i++) {\n            const row = results.data[i] as string[];\n            if (!row || row.length <= Math.max(latIndex, lngIndex)) continue;\n            \n            const category = categoryIndex >= 0 ? row[categoryIndex]?.trim() : 'Unknown';\n            const pipefile = pipefileIndex >= 0 ? row[pipefileIndex]?.trim() : '';\n            const avetta = avettaIndex >= 0 ? row[avettaIndex]?.trim() : '';\n            const name = nameIndex >= 0 ? row[nameIndex]?.trim() : '';\n            const company = companyIndex >= 0 ? row[companyIndex]?.trim() : '';\n            const email = emailIndex >= 0 ? row[emailIndex]?.trim() : '';\n            const city = cityIndex >= 0 ? row[cityIndex]?.trim() : '';\n            const state = stateIndex >= 0 ? row[stateIndex]?.trim() : '';\n            const fullAddress = addressIndex >= 0 ? row[addressIndex]?.trim() : '';\n            const latitude = parseFloat(row[latIndex] || '0');\n            const longitude = parseFloat(row[lngIndex] || '0');\n            const phone = phoneIndex >= 0 ? row[phoneIndex]?.trim() : '';\n            const birdRep = birdRepIndex >= 0 ? row[birdRepIndex]?.trim() : '';\n            const subRanking = subRankingIndex >= 0 ? row[subRankingIndex]?.trim() : '';\n            const rating = ratingIndex >= 0 ? row[ratingIndex]?.trim() : '';\n            const fteCounts = fteCountsIndex >= 0 ? row[fteCountsIndex]?.trim() : '';\n            const pipefileUpdates = pipefileUpdatesIndex >= 0 ? row[pipefileUpdatesIndex]?.trim() : '';\n            const notes = notesIndex >= 0 ? row[notesIndex]?.trim() : '';\n            const newMsaComplete = newMsaCompleteIndex >= 0 ? row[newMsaCompleteIndex]?.trim() : '';\n            const msaStatus = msaStatusIndex >= 0 ? row[msaStatusIndex]?.trim() : '';\n            const companyId = companyIdIndex >= 0 ? row[companyIdIndex]?.trim() : '';\n\n            const resourceName = name || company || 'Unnamed Resource';\n\n            if (!isNaN(latitude) && !isNaN(longitude) && latitude !== 0 && longitude !== 0) {\n              resources.push({\n                name: resourceName,\n                type: category,\n                latitude,\n                longitude,\n                description: notes,\n                address: fullAddress,\n                pipefile,\n                avetta,\n                company,\n                email,\n                city,\n                state,\n                phone,\n                birdRep,\n                subRanking,\n                rating,\n                fteCounts,\n                pipefileUpdates,\n                newMsaComplete,\n                msaStatus,\n                companyId\n              });\n            }\n          }\n\n          console.log('Parsed resources (header-based):', resources.length);\n          resolve(resources);\n        } catch (error) {\n          console.error('CSV parsing error:', error);\n          reject(error);\n        }\n      },\n      error: (error: any) => {\n        reject(new Error(`CSV parsing error: ${error.message}`));\n      }\n    });\n  });\n}\n\nexport async function parseExcelFile(filePath: string): Promise<CSVResource[]> {\n  const fs = await import('fs');\n  const workbook = XLSX.readFile(filePath);\n  const sheetName = workbook.SheetNames[0];\n  const worksheet = workbook.Sheets[sheetName];\n  \n  // Convert to JSON with header normalization\n  const jsonData = XLSX.utils.sheet_to_json(worksheet, { \n    header: 1,\n    defval: ''\n  });\n\n  if (jsonData.length < 2) {\n    throw new Error('Excel file must have at least a header row and one data row');\n  }\n\n  // Get headers and normalize them\n  const headers = (jsonData[0] as string[]).map(h => h.toLowerCase().trim());\n  const dataRows = jsonData.slice(1) as any[][];\n\n  const resources = dataRows.map((row, index) => {\n    const rowObj: any = {};\n    headers.forEach((header, i) => {\n      rowObj[header] = row[i] || '';\n    });\n\n    const name = rowObj.name || rowObj.title || rowObj.resource_name || rowObj.facility_name || `Resource ${index + 1}`;\n    const type = rowObj.type || rowObj.category || rowObj.resource_type || 'Unknown';\n    const latitude = parseFloat(rowObj.latitude || rowObj.lat || rowObj.y || '0');\n    const longitude = parseFloat(rowObj.longitude || rowObj.lng || rowObj.lon || rowObj.x || '0');\n    const description = rowObj.description || rowObj.desc || rowObj.notes || '';\n    const address = rowObj.address || rowObj.location || '';\n\n    // Validate coordinates\n    if (isNaN(latitude) || isNaN(longitude) || latitude === 0 || longitude === 0) {\n      throw new Error(`Invalid coordinates for resource: ${name} at row ${index + 2}`);\n    }\n\n    return {\n      name,\n      type,\n      latitude,\n      longitude,\n      description,\n      address\n    };\n  }).filter(resource => resource.latitude !== 0 && resource.longitude !== 0);\n\n  return resources;\n}\n\nexport function convertCSVToResources(csvResources: CSVResource[]): InsertResource[] {\n  return csvResources.map(csvResource => ({\n    name: csvResource.name,\n    type: csvResource.type || 'Unknown',\n    latitude: csvResource.latitude,\n    longitude: csvResource.longitude,\n    description: csvResource.description || '',\n    properties: csvResource.address ? { address: csvResource.address } : undefined\n  }));\n}\n\nexport function exportToExcel(data: any[], filename: string): Buffer {\n  const worksheet = XLSX.utils.json_to_sheet(data);\n  \n  // Auto-width columns\n  const columnWidths: any[] = [];\n  if (data.length > 0) {\n    const headers = Object.keys(data[0]);\n    headers.forEach((header, index) => {\n      let maxWidth = header.length;\n      data.forEach(row => {\n        const cellValue = String(row[header] || '');\n        maxWidth = Math.max(maxWidth, cellValue.length);\n      });\n      columnWidths[index] = { wch: Math.min(maxWidth + 2, 50) }; // Cap at 50 characters\n    });\n    worksheet['!cols'] = columnWidths;\n  }\n  \n  const workbook = XLSX.utils.book_new();\n  XLSX.utils.book_append_sheet(workbook, worksheet, 'Results');\n  \n  return XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });\n}\n\nexport function exportToExcelWithBirdRepSheets(data: any[], filename: string): Buffer {\n  const workbook = XLSX.utils.book_new();\n  \n  // Helper function to add auto-width columns to a worksheet\n  const addAutoWidthColumns = (worksheet: any, data: any[]) => {\n    if (data.length > 0) {\n      const headers = Object.keys(data[0]);\n      const columnWidths: any[] = [];\n      headers.forEach((header, index) => {\n        let maxWidth = header.length;\n        data.forEach(row => {\n          const cellValue = String(row[header] || '');\n          maxWidth = Math.max(maxWidth, cellValue.length);\n        });\n        columnWidths[index] = { wch: Math.min(maxWidth + 2, 50) }; // Cap at 50 characters\n      });\n      worksheet['!cols'] = columnWidths;\n    }\n  };\n  \n  // Create master sheet with all data\n  const masterWorksheet = XLSX.utils.json_to_sheet(data);\n  addAutoWidthColumns(masterWorksheet, data);\n  XLSX.utils.book_append_sheet(workbook, masterWorksheet, 'All Results');\n  \n  // Group data by Bird Rep\n  const birdRepGroups = new Map<string, any[]>();\n  \n  data.forEach(row => {\n    const birdRepRaw = row['BIRD REP'] || 'Unassigned';\n    // Extract first name if there are multiple names separated by / or &\n    const birdRep = birdRepRaw.split(/[\\/&]/)[0].trim() || 'Unassigned';\n    \n    if (!birdRepGroups.has(birdRep)) {\n      birdRepGroups.set(birdRep, []);\n    }\n    birdRepGroups.get(birdRep)!.push(row);\n  });\n  \n  // Sort Bird Reps alphabetically, but put 'Unassigned' last\n  const sortedBirdReps = Array.from(birdRepGroups.keys()).sort((a, b) => {\n    if (a === 'Unassigned') return 1;\n    if (b === 'Unassigned') return -1;\n    return a.localeCompare(b);\n  });\n  \n  // Create a worksheet for each Bird Rep\n  sortedBirdReps.forEach(birdRep => {\n    const birdRepData = birdRepGroups.get(birdRep)!;\n    \n    // Sort the data within each Bird Rep by distance (ascending)\n    birdRepData.sort((a, b) => {\n      const distanceA = parseFloat(a['Distance (miles)']) || 0;\n      const distanceB = parseFloat(b['Distance (miles)']) || 0;\n      return distanceA - distanceB;\n    });\n    \n    const worksheet = XLSX.utils.json_to_sheet(birdRepData);\n    addAutoWidthColumns(worksheet, birdRepData);\n    \n    // Clean up sheet name for Excel compatibility\n    const cleanSheetName = birdRep\n      .replace(/[\\\\\\/\\?\\*\\[\\]]/g, '') // Remove invalid characters\n      .substring(0, 31); // Excel sheet names max 31 chars\n    \n    XLSX.utils.book_append_sheet(workbook, worksheet, cleanSheetName);\n  });\n  \n  return XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });\n}\nexport function exportToCSVWithBirdRepFiles(data: any[], baseFilename: string): { files: Array<{ name: string, content: string }> } {\n  const files: Array<{ name: string, content: string }> = [];\n  \n  // Create master CSV with all data\n  const csvHeaders = Object.keys(data[0] || {});\n  const masterCsvRows = data.map(row => \n    csvHeaders.map(header => `\"${(row as any)[header] || \"\"}\"`).join(\",\")\n  );\n  const masterCsv = [csvHeaders.join(\",\"), ...masterCsvRows].join(\"\\n\");\n  \n  files.push({\n    name: `${baseFilename}_all_results.csv`,\n    content: masterCsv\n  });\n  \n  // Group data by Bird Rep\n  const birdRepGroups = new Map<string, any[]>();\n  \n  data.forEach(row => {\n    const birdRepRaw = row[\"BIRD REP\"] || \"Unassigned\";\n    // Extract first name if there are multiple names separated by / or &\n    const birdRep = birdRepRaw.split(/[\\/&]/)[0].trim() || \"Unassigned\";\n    \n    if (!birdRepGroups.has(birdRep)) {\n      birdRepGroups.set(birdRep, []);\n    }\n    birdRepGroups.get(birdRep)!.push(row);\n  });\n  \n  // Sort Bird Reps alphabetically, but put \"Unassigned\" last\n  const sortedBirdReps = Array.from(birdRepGroups.keys()).sort((a, b) => {\n    if (a === \"Unassigned\") return 1;\n    if (b === \"Unassigned\") return -1;\n    return a.localeCompare(b);\n  });\n  \n  // Create a CSV file for each Bird Rep\n  sortedBirdReps.forEach(birdRep => {\n    const birdRepData = birdRepGroups.get(birdRep)!;\n    \n    // Sort the data within each Bird Rep by distance (ascending)\n    birdRepData.sort((a, b) => {\n      const distanceA = parseFloat(a[\"Distance (miles)\"]) || 0;\n      const distanceB = parseFloat(b[\"Distance (miles)\"]) || 0;\n      return distanceA - distanceB;\n    });\n    \n    const birdRepCsvRows = birdRepData.map(row => \n      csvHeaders.map(header => `\"${(row as any)[header] || \"\"}\"`).join(\",\")\n    );\n    const birdRepCsv = [csvHeaders.join(\",\"), ...birdRepCsvRows].join(\"\\n\");\n    \n    // Clean up filename for filesystem compatibility\n    const cleanFilename = birdRep\n      .replace(/[\\\\\\/\\?\\*\\[\\]<>|:\"]/g, \"_\") // Replace invalid characters\n      .replace(/\\s+/g, \"_\"); // Replace spaces with underscores\n    \n    files.push({\n      name: `${baseFilename}_${cleanFilename}.csv`,\n      content: birdRepCsv\n    });\n  });\n  \n  return { files };\n}\n","path":null,"size_bytes":16539,"size_tokens":null},"replit.md":{"content":"# Utility Storm Response Management System\n\n## Overview\nThis comprehensive storm response management system combines interactive resource mapping with complete contractor management, storm session tracking, roster/crew management, timesheet recording, expense tracking, and automated invoicing. Built with granular role-based access control (RBAC), the system serves multiple user types: administrators managing users, managers orchestrating storm response operations, contractors viewing their own company data, and utility clients with access to specific contractors. The platform integrates PostgreSQL for data persistence, Replit Object Storage for receipts/documents, and complete audit logging for compliance and accountability.\n\n## User Preferences\n- Keep implementation simple and streamlined - no fancy stuff, just get it done\n- Never use fake or sample data\n- Prioritize resource marker visibility during map operations\n- Excel export functionality is essential for data analysis\n- Clear error handling for file uploads with various formats\n- Comprehensive tabular data display with sorting capabilities\n\n## Role-Based Access Control (RBAC)\n\nThe system implements a 4-role security model with both backend and frontend enforcement:\n\n### Roles\n1. **ADMIN**: User management only\n   - Create, edit, delete users\n   - Assign roles to users\n   - Access: `/users` page only\n   \n2. **MANAGER**: Full system access\n   - All storm response operations (companies, sessions, rosters, timesheets, expenses, invoices)\n   - Grant/revoke UTILITY user access to specific companies\n   - Access: All pages except `/users`\n   \n3. **CONTRACTOR**: Own company data only\n   - View and edit own company profile\n   - View own rosters, timesheets, expenses\n   - Access: `/profile` page and own company data\n   \n4. **UTILITY**: Access to granted companies only\n   - View data for companies granted by MANAGER\n   - Same features as MANAGER but filtered to accessible companies\n   - Access: Storm response pages for granted companies only\n\n### Backend RBAC Implementation\n- Helper functions for each entity type: `ensureRosterCompanyAccess`, `ensureTimesheetCompanyAccess`, etc.\n- Performance optimization: UTILITY users' accessible companies cached to avoid O(n) queries\n- Security: 404-before-403 error handling (fetch entity, check existence, then check access)\n- Data integrity: All update operations verify non-null returns before responding\n\n### Frontend RBAC Implementation\n- Role guards on all restricted pages (ADMIN, MANAGER, CONTRACTOR checks)\n- Navigation dynamically shows/hides links based on user role (desktop + mobile)\n- Access management UI for MANAGERs to grant UTILITY access\n- User management UI for ADMINs only\n\n## System Architecture\nThe application is built with a React frontend, utilizing TypeScript and Leaflet with OpenStreetMap tiles for interactive mapping. The backend is an Express.js server handling file uploads and API requests. PostgreSQL with Drizzle ORM ensures persistent data storage. Tailwind CSS and shadcn/ui components are used for the user interface.\n\n### Data Flow & Synchronization\nThe system maintains seamless data synchronization across three main pages:\n\n1. **Contractor Management Page** → **Map Analysis Page**:\n   - Initial contractors imported via CSV/Excel to Contractor Management\n   - Contractors with locations are automatically displayed on map\n   - Auto-geocoding processes 20 contractors per page load (prioritizes pending review)\n   - **Resource Sync**: Resources auto-update when contractors change (company name, category, coordinates, notes, address)\n   - Orphaned resources (linked to deleted contractors) are automatically cleaned up\n   \n2. **Availability Management Page** → **Contractor Management Page** → **Map Analysis Page**:\n   - Availability forms sent to contractors (existing + new)\n   - Form submissions create new contractors marked as \"Pending Review\" with departure locations\n   - Auto-merge detects duplicates (fuzzy matching on company + name)\n   - Manual merge available for handling duplicates\n   - When merged, needsReview flag automatically cleared\n   \n3. **Map Analysis Page** pulls ALL resources:\n   - All contractors with valid coordinates (from both sources)\n   - All storage yards\n   - **Resource Naming**: Map markers display company name (not person name) for clear identification\n   - **Visual indicators**: All markers display consistently with white borders (dot color = resource type category)\n   - Analysis calculations include ALL resources (contractors + storage yards)\n   - Results table separates \"Contractor Name\" (person) and \"Company\" (business) columns\n   - Results and exports include complete dataset with accurate, up-to-date contractor information\n\n### Key Features\n\n#### Resource Mapping & Analysis\n-   **Interactive Map**: Leaflet-based map with marker management and zoom controls. Displays 821+ resources (516 contractors + 305 storage yards).\n-   **Contractor Management**: Full CRUD operations for contractors, including a 5-star rating system and file management (upload, download, delete for PDFs, docs, images).\n-   **Bulk Import**: Support for CSV, Excel (.xlsx), and KMZ file formats.\n-   **Analysis & Export**: User-created analysis points, Mapbox Matrix API calculations for highly cost-effective distance/time (100k free elements/month), and Excel/CSV export of results, including Bird Rep-specific groupings.\n-   **GeoJSON API Endpoints**: Live GeoJSON feeds for direct Mapbox integration:\n    - `/api/geojson/contractors` - All contractor main and departure locations\n    - `/api/geojson/storage-yards` - All storage yard locations\n    - `/api/geojson/all` - Combined feed with all locations (contractors + storage yards)\n    - Proper GeoJSON FeatureCollection format with [longitude, latitude] coordinates\n    - Rich metadata in properties for filtering and display\n-   **Weather Overlay**: Integration of NOAA SPC wind outlook (5%+ probability for 3 days) with color-coded risk levels.\n-   **Utility Impact Analysis**: Overlay of authentic ArcGIS electric utility service territories, calculation of affected customer counts, and Excel export of impact data.\n-   **Contractor Availability System**: Management system with FTE file processing, dual input (self-service portal and manual entry), crew/equipment tracking, and approval workflow.\n\n#### Storm Response Management\n-   **Company Management**: Integration with existing 309 contractors database\n-   **Storm Sessions**: Create and manage storm events with date ranges and descriptions\n-   **Roster Management**: Excel import and live editing of crew rosters with personnel and equipment tracking\n-   **Timesheet Tracking**: Daily time entry for crews with regular/overtime hours\n-   **Expense Management**: Receipt uploads via Object Storage with category tracking\n-   **Invoice Generation**: Automated invoice creation from timesheets and expenses\n-   **Audit Logging**: Complete audit trail of all changes for compliance\n-   **Document Storage**: Replit Object Storage integration for receipts and supporting documents\n-   **Role-Based Access**: Granular permissions for ADMIN, MANAGER, CONTRACTOR, and UTILITY roles\n-   **User Management**: ADMIN-only interface for user creation and role assignment\n-   **Access Management**: MANAGER interface to grant UTILITY users access to specific companies\n-   **Contractor Profile**: Self-service profile editing for CONTRACTOR users\n\n#### Ticketing Module\n-   **Issue Types**: Configurable issue type catalog (Wire Down, Pole Damage, Transformer, Tree Trimming, Outage, Inspection, Debris) with default priorities\n-   **Ticket Lifecycle**: Full status flow CREATED → ASSIGNED → ACCEPTED → ENROUTE → ON_SITE → WORKING → COMPLETED → CLOSED (with BLOCKED/CANCELLED branches)\n-   **Server-side Transition Validation**: Only valid status transitions are allowed\n-   **Crew Assignment**: Assign tickets to crews from company rosters with accept/reject workflow\n-   **Work Segments**: Automatic work segment tracking tied to status changes (open on WORKING/ON_SITE, close on exit states)\n-   **Timeline**: Full status event history with timestamps and notes\n-   **RBAC**: Ticket creation/assignment restricted to MANAGER/UTILITY; CONTRACTOR sees only company tickets; company access enforced on all endpoints\n-   **Tables**: issue_types, tickets, ticket_assignments, ticket_status_events, ticket_work_segments, notifications\n-   **Future**: Timesheet auto-generation from ticket work segments\n\n#### Technical Features\n-   **Authentication**: Secure user authentication with Replit Auth and role-based routing protection\n-   **UI/UX**: Responsive design optimized for mobile and desktop with consistent shadcn/ui components\n-   **Performance**: Optimized RBAC queries with caching for UTILITY role filtering\n\n## External Dependencies\n-   **Mapping**: OpenStreetMap (via Leaflet)\n-   **Database**: PostgreSQL\n-   **ORM**: Drizzle ORM\n-   **Weather Data**: NOAA Storm Prediction Center (SPC) API (for wind outlooks)\n-   **Utility Data**: ArcGIS Retail Service Territories database service\n-   **Frontend Libraries**: React, TypeScript, Leaflet\n-   **Backend Framework**: Express.js\n-   **Styling**: Tailwind CSS, shadcn/ui\n-   **File Processing**: Libraries for CSV, Excel, and KMZ parsing\n-   **Distance Calculations**: Mapbox Matrix API - highly cost-optimized (100k free elements/month, then $2/1k elements)\n-   **Geocoding**: Mapbox Geocoding API v6 - cost-effective (100k free requests/month, then $0.75/1k requests)","path":null,"size_bytes":9546,"size_tokens":null},"client/src/components/WeatherOverlayPanel.tsx":{"content":"import React, { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Skeleton } from \"@/components/ui/skeleton\";\nimport { Switch } from \"@/components/ui/switch\";\nimport { Label } from \"@/components/ui/label\";\nimport { Alert, AlertDescription } from \"@/components/ui/alert\";\nimport { Cloud, Zap, AlertTriangle, Users, RefreshCw, Eye, EyeOff, Download } from \"lucide-react\";\nimport { useWeatherData } from \"@/hooks/useWeatherData\";\nimport type { ElectricUtility } from \"@/hooks/useWeatherData\";\n\ninterface WeatherOverlayPanelProps {\n  onToggleOutlookLayer: (enabled: boolean) => void;\n  onToggleUtilitiesLayer: (enabled: boolean) => void;\n  isOutlookLayerVisible: boolean;\n  isUtilitiesLayerVisible: boolean;\n  visibleDays?: { [key: number]: boolean };\n  onToggleDay?: (day: number, enabled: boolean) => void;\n}\n\nexport default function WeatherOverlayPanel({\n  onToggleOutlookLayer,\n  onToggleUtilitiesLayer,\n  isOutlookLayerVisible,\n  isUtilitiesLayerVisible,\n  visibleDays = { 1: true, 2: true, 3: true },\n  onToggleDay = () => {}\n}: WeatherOverlayPanelProps) {\n  const [affectedUtilities, setAffectedUtilities] = useState<ElectricUtility[]>([]);\n  const [showUtilitiesList, setShowUtilitiesList] = useState(false);\n  \n  const {\n    outlookData,\n    utilitiesData,\n    isOutlookLoading,\n    isUtilitiesLoading,\n    isCalculatingAffected,\n    outlookError,\n    utilitiesError,\n    calculationError,\n    loadWeatherData,\n    calculateAffectedUtilities\n  } = useWeatherData();\n\n  const handleLoadWeatherData = async () => {\n    try {\n      await loadWeatherData();\n    } catch (error) {\n      console.error('Failed to load weather data:', error);\n    }\n  };\n\n  const handleCalculateAffected = async () => {\n    if (!outlookData) {\n      return;\n    }\n    \n    try {\n      const utilities = await calculateAffectedUtilities(outlookData);\n      setAffectedUtilities(utilities);\n      setShowUtilitiesList(true);\n    } catch (error) {\n      console.error('Failed to calculate affected utilities:', error);\n    }\n  };\n\n  const getRiskColor = (category: string): string => {\n    switch (category.toUpperCase()) {\n      case 'HIGH': return 'bg-red-600';\n      case 'MDT': return 'bg-orange-500';\n      case 'ENH': return 'bg-yellow-500';\n      case 'SLGT': return 'bg-green-500';\n      default: return 'bg-gray-400';\n    }\n  };\n\n  const getRiskLabel = (category: string): string => {\n    switch (category.toUpperCase()) {\n      case 'HIGH': return 'High Risk';\n      case 'MDT': return 'Moderate Risk';\n      case 'ENH': return 'Enhanced Risk';\n      case 'SLGT': return 'Slight Risk';\n      default: return category;\n    }\n  };\n\n  const getTotalCustomersAffected = (): number => {\n    return affectedUtilities.reduce((total, utility) => total + utility.customers, 0);\n  };\n\n  const exportToExcel = () => {\n    if (affectedUtilities.length === 0) return;\n\n    // Prepare data for Excel export\n    const exportData = affectedUtilities.map((utility, index) => ({\n      'Rank': index + 1,\n      'Utility Name': utility.name,\n      'Customers': utility.customers,\n      'Highest Risk Level': utility.highestRiskLevel || 'Unknown',\n      'All Risk Levels': utility.riskLevels ? utility.riskLevels.join(', ') : utility.highestRiskLevel || 'Unknown',\n      'Intersecting Area (sq units)': utility.intersectingArea || 0\n    }));\n\n    // Add summary row\n    const summaryData = {\n      'Rank': 'TOTAL',\n      'Utility Name': 'ALL AFFECTED UTILITIES',\n      'Customers': getTotalCustomersAffected(),\n      'Highest Risk Level': '',\n      'All Risk Levels': '',\n      'Intersecting Area (sq units)': ''\n    };\n\n    const finalData = [...exportData, summaryData];\n\n    // Create CSV content\n    const headers = Object.keys(exportData[0]);\n    const csvContent = [\n      headers.join(','),\n      ...exportData.map(row => headers.map(header => `\"${(row as any)[header]}\"`).join(',')),\n      // Add summary row separately to avoid type issues\n      `\"TOTAL\",\"ALL AFFECTED UTILITIES\",\"${getTotalCustomersAffected()}\",\"\",\"\",\"\"`\n    ].join('\\n');\n\n    // Download file\n    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });\n    const link = document.createElement('a');\n    const url = URL.createObjectURL(blob);\n    link.setAttribute('href', url);\n    \n    const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');\n    link.setAttribute('download', `affected_utilities_${timestamp}.csv`);\n    \n    document.body.appendChild(link);\n    link.click();\n    document.body.removeChild(link);\n    URL.revokeObjectURL(url);\n  };\n\n  return (\n    <Card className=\"mb-4\">\n      <CardHeader className=\"pb-3\">\n        <CardTitle className=\"flex items-center text-sm font-medium\">\n          <Cloud className=\"w-4 h-4 mr-2 text-blue-600\" />\n          Wind Outlook (5%+)\n        </CardTitle>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        \n        {/* Load Weather Data Button */}\n        <Button \n          onClick={handleLoadWeatherData}\n          disabled={isOutlookLoading || isUtilitiesLoading}\n          className=\"w-full\"\n          size=\"sm\"\n        >\n          {(isOutlookLoading || isUtilitiesLoading) ? (\n            <>\n              <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n              Loading...\n            </>\n          ) : (\n            <>\n              <Cloud className=\"w-4 h-4 mr-2\" />\n              Load Weather Data\n            </>\n          )}\n        </Button>\n\n        {/* Error Handling */}\n        {(outlookError || utilitiesError || calculationError) && (\n          <Alert variant=\"destructive\">\n            <AlertTriangle className=\"h-4 w-4\" />\n            <AlertDescription className=\"text-xs\">\n              {outlookError?.message || utilitiesError?.message || calculationError?.message || 'Weather data error'}\n            </AlertDescription>\n          </Alert>\n        )}\n\n        {/* Layer Controls */}\n        {outlookData && (\n          <div className=\"space-y-3\">\n            <div className=\"flex items-center justify-between\">\n              <Label htmlFor=\"outlook-layer\" className=\"text-xs\">SPC Outlook (All Days)</Label>\n              <div className=\"flex items-center space-x-2\">\n                <Switch\n                  id=\"outlook-layer\"\n                  checked={isOutlookLayerVisible}\n                  onCheckedChange={(checked) => {\n                    onToggleOutlookLayer(checked);\n                    // Auto-enable all days when turning on SPC outlook\n                    if (checked) {\n                      console.log('Auto-enabling all day layers for SPC outlook');\n                    }\n                  }}\n                />\n                {isOutlookLayerVisible ? (\n                  <Eye className=\"w-3 h-3 text-gray-500\" />\n                ) : (\n                  <EyeOff className=\"w-3 h-3 text-gray-400\" />\n                )}\n              </div>\n            </div>\n\n            {/* Individual Day Controls - show when outlook is enabled */}\n            {isOutlookLayerVisible && (\n              <div className=\"ml-4 space-y-2 border-l-2 border-gray-200 pl-3\">\n                <div className=\"text-xs text-gray-600\">Show Days:</div>\n                {[1, 2, 3].map(day => {\n                  const dayFeatures = outlookData.features.filter(f => f.properties.outlook_day === day);\n                  const hasData = dayFeatures.length > 0;\n                  const categorySet = new Set(dayFeatures.map(f => f.properties.category));\n                  const riskLevels = Array.from(categorySet);\n                  \n                  return (\n                    <div key={day} className=\"flex items-center justify-between\">\n                      <div className=\"flex items-center space-x-2\">\n                        <Label htmlFor={`day-${day}`} className=\"text-xs\">\n                          Day {day} \n                          {hasData && (\n                            <span className=\"text-gray-500\">\n                              ({riskLevels.join(', ')})\n                            </span>\n                          )}\n                        </Label>\n                      </div>\n                      <Switch\n                        id={`day-${day}`}\n                        checked={hasData && visibleDays[day]}\n                        disabled={!hasData}\n                        onCheckedChange={(checked) => onToggleDay(day, checked)}\n                      />\n                    </div>\n                  );\n                })}\n              </div>\n            )}\n\n            {utilitiesData && (\n              <div className=\"space-y-2\">\n                <div className=\"flex items-center justify-between\">\n                  <Label htmlFor=\"utilities-layer\" className=\"text-xs\">Electric Utilities</Label>\n                  <div className=\"flex items-center space-x-2\">\n                    <Switch\n                      id=\"utilities-layer\"\n                      checked={isUtilitiesLayerVisible && utilitiesData.features.length > 0}\n                      onCheckedChange={onToggleUtilitiesLayer}\n                      disabled={utilitiesData.features.length === 0}\n                    />\n                    {isUtilitiesLayerVisible ? (\n                      <Eye className=\"w-3 h-3 text-gray-500\" />\n                    ) : (\n                      <EyeOff className=\"w-3 h-3 text-gray-400\" />\n                    )}\n                  </div>\n                </div>\n                \n                {utilitiesData.error && (\n                  <Alert className=\"border-orange-200 bg-orange-50\">\n                    <AlertTriangle className=\"h-3 w-3 text-orange-600\" />\n                    <AlertDescription className=\"text-xs text-orange-700\">\n                      {utilitiesData.error.message}\n                      <div className=\"mt-1 text-xs text-orange-600\">\n                        All other map features remain fully functional.\n                      </div>\n                    </AlertDescription>\n                  </Alert>\n                )}\n              </div>\n            )}\n          </div>\n        )}\n\n        \n\n        {/* Calculate Affected Utilities */}\n        {outlookData && utilitiesData && (\n          <Button \n            onClick={handleCalculateAffected}\n            disabled={isCalculatingAffected}\n            variant=\"outline\"\n            className=\"w-full\"\n            size=\"sm\"\n          >\n            {isCalculatingAffected ? (\n              <>\n                <RefreshCw className=\"w-4 h-4 mr-2 animate-spin\" />\n                Calculating...\n              </>\n            ) : (\n              <>\n                <Zap className=\"w-4 h-4 mr-2\" />\n                Find Affected Utilities\n              </>\n            )}\n          </Button>\n        )}\n\n        {/* Affected Utilities Results */}\n        {showUtilitiesList && affectedUtilities.length > 0 && (\n          <div className=\"space-y-2\">\n            <div className=\"flex items-center justify-between\">\n              <h4 className=\"text-xs font-medium text-gray-700\">Potentially Affected Utilities</h4>\n              <div className=\"flex items-center space-x-2\">\n                <Badge variant=\"secondary\" className=\"text-xs\">\n                  <Users className=\"w-3 h-3 mr-1\" />\n                  {getTotalCustomersAffected().toLocaleString()} customers\n                </Badge>\n                <Button\n                  onClick={exportToExcel}\n                  variant=\"outline\"\n                  size=\"sm\"\n                  className=\"h-6 px-2 text-xs\"\n                  title=\"Export to Excel/CSV\"\n                >\n                  <Download className=\"w-3 h-3\" />\n                </Button>\n              </div>\n            </div>\n            \n            <div className=\"max-h-40 overflow-y-auto space-y-1\">\n              {affectedUtilities.slice(0, 10).map((utility, index) => (\n                <div key={index} className=\"flex items-center justify-between p-2 bg-gray-50 rounded text-xs\">\n                  <div className=\"flex-1 min-w-0\">\n                    <div className=\"font-medium text-gray-900 truncate\">{utility.name}</div>\n                    {utility.highestRiskLevel && (\n                      <div className=\"flex items-center space-x-1 mt-1\">\n                        <Badge \n                          variant=\"secondary\" \n                          className={`text-white text-xs px-1 py-0 ${getRiskColor(utility.highestRiskLevel)}`}\n                        >\n                          {utility.highestRiskLevel}\n                        </Badge>\n                        {utility.riskLevels && utility.riskLevels.length > 1 && (\n                          <span className=\"text-gray-400 text-xs\">+{utility.riskLevels.length - 1}</span>\n                        )}\n                      </div>\n                    )}\n                  </div>\n                  <div className=\"text-right\">\n                    <div className=\"font-bold text-blue-600 text-sm\">{utility.customers.toLocaleString()}</div>\n                    <div className=\"text-gray-400 text-xs\">customers</div>\n                  </div>\n                </div>\n              ))}\n              \n              {affectedUtilities.length > 10 && (\n                <div className=\"text-xs text-gray-500 text-center py-1\">\n                  +{affectedUtilities.length - 10} more utilities\n                </div>\n              )}\n            </div>\n          </div>\n        )}\n\n        {showUtilitiesList && affectedUtilities.length === 0 && (\n          <div className=\"text-xs text-gray-500 text-center py-2\">\n            No utilities found in risk areas\n          </div>\n        )}\n\n        </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":13753,"size_tokens":null},"client/src/components/ui/breadcrumb.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { ChevronRight, MoreHorizontal } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Breadcrumb = React.forwardRef<\n  HTMLElement,\n  React.ComponentPropsWithoutRef<\"nav\"> & {\n    separator?: React.ReactNode\n  }\n>(({ ...props }, ref) => <nav ref={ref} aria-label=\"breadcrumb\" {...props} />)\nBreadcrumb.displayName = \"Breadcrumb\"\n\nconst BreadcrumbList = React.forwardRef<\n  HTMLOListElement,\n  React.ComponentPropsWithoutRef<\"ol\">\n>(({ className, ...props }, ref) => (\n  <ol\n    ref={ref}\n    className={cn(\n      \"flex flex-wrap items-center gap-1.5 break-words text-sm text-muted-foreground sm:gap-2.5\",\n      className\n    )}\n    {...props}\n  />\n))\nBreadcrumbList.displayName = \"BreadcrumbList\"\n\nconst BreadcrumbItem = React.forwardRef<\n  HTMLLIElement,\n  React.ComponentPropsWithoutRef<\"li\">\n>(({ className, ...props }, ref) => (\n  <li\n    ref={ref}\n    className={cn(\"inline-flex items-center gap-1.5\", className)}\n    {...props}\n  />\n))\nBreadcrumbItem.displayName = \"BreadcrumbItem\"\n\nconst BreadcrumbLink = React.forwardRef<\n  HTMLAnchorElement,\n  React.ComponentPropsWithoutRef<\"a\"> & {\n    asChild?: boolean\n  }\n>(({ asChild, className, ...props }, ref) => {\n  const Comp = asChild ? Slot : \"a\"\n\n  return (\n    <Comp\n      ref={ref}\n      className={cn(\"transition-colors hover:text-foreground\", className)}\n      {...props}\n    />\n  )\n})\nBreadcrumbLink.displayName = \"BreadcrumbLink\"\n\nconst BreadcrumbPage = React.forwardRef<\n  HTMLSpanElement,\n  React.ComponentPropsWithoutRef<\"span\">\n>(({ className, ...props }, ref) => (\n  <span\n    ref={ref}\n    role=\"link\"\n    aria-disabled=\"true\"\n    aria-current=\"page\"\n    className={cn(\"font-normal text-foreground\", className)}\n    {...props}\n  />\n))\nBreadcrumbPage.displayName = \"BreadcrumbPage\"\n\nconst BreadcrumbSeparator = ({\n  children,\n  className,\n  ...props\n}: React.ComponentProps<\"li\">) => (\n  <li\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"[&>svg]:w-3.5 [&>svg]:h-3.5\", className)}\n    {...props}\n  >\n    {children ?? <ChevronRight />}\n  </li>\n)\nBreadcrumbSeparator.displayName = \"BreadcrumbSeparator\"\n\nconst BreadcrumbEllipsis = ({\n  className,\n  ...props\n}: React.ComponentProps<\"span\">) => (\n  <span\n    role=\"presentation\"\n    aria-hidden=\"true\"\n    className={cn(\"flex h-9 w-9 items-center justify-center\", className)}\n    {...props}\n  >\n    <MoreHorizontal className=\"h-4 w-4\" />\n    <span className=\"sr-only\">More</span>\n  </span>\n)\nBreadcrumbEllipsis.displayName = \"BreadcrumbElipssis\"\n\nexport {\n  Breadcrumb,\n  BreadcrumbList,\n  BreadcrumbItem,\n  BreadcrumbLink,\n  BreadcrumbPage,\n  BreadcrumbSeparator,\n  BreadcrumbEllipsis,\n}\n","path":null,"size_bytes":2712,"size_tokens":null},"server/services/kmzParser.ts":{"content":"import { promises as fs } from 'fs';\nimport * as yauzl from 'yauzl';\nimport { parseString } from 'xml2js';\nimport type { InsertResource } from '@shared/schema';\n\nexport interface KMLPlacemark {\n  name: string;\n  description?: string;\n  coordinates: [number, number]; // [longitude, latitude]\n  properties?: Record<string, any>;\n}\n\nexport async function parseKMZFile(filePath: string): Promise<KMLPlacemark[]> {\n  try {\n    // Extract KMZ file (it's a ZIP containing KML)\n    const kmlContent = await extractKMLFromKMZ(filePath);\n    \n    // Parse KML XML\n    const placemarks = await parseKML(kmlContent);\n    \n    return placemarks;\n  } catch (error) {\n    console.error('Error parsing KMZ file:', error);\n    throw new Error('Failed to parse KMZ file');\n  }\n}\n\nasync function extractKMLFromKMZ(kmzPath: string): Promise<string> {\n  return new Promise((resolve, reject) => {\n    yauzl.open(kmzPath, { lazyEntries: true }, (err: any, zipfile: any) => {\n      if (err) {\n        reject(err);\n        return;\n      }\n\n      let kmlContent = '';\n      \n      zipfile.readEntry();\n      zipfile.on('entry', (entry: any) => {\n        if (entry.fileName.toLowerCase().endsWith('.kml')) {\n          zipfile.openReadStream(entry, (err: any, readStream: any) => {\n            if (err) {\n              reject(err);\n              return;\n            }\n\n            const chunks: Buffer[] = [];\n            readStream.on('data', (chunk: any) => chunks.push(chunk));\n            readStream.on('end', () => {\n              kmlContent = Buffer.concat(chunks).toString('utf8');\n              resolve(kmlContent);\n            });\n            readStream.on('error', reject);\n          });\n        } else {\n          zipfile.readEntry();\n        }\n      });\n\n      zipfile.on('end', () => {\n        if (!kmlContent) {\n          reject(new Error('No KML file found in KMZ archive'));\n        }\n      });\n\n      zipfile.on('error', reject);\n    });\n  });\n}\n\nasync function parseKML(kmlContent: string): Promise<KMLPlacemark[]> {\n  return new Promise((resolve, reject) => {\n    parseString(kmlContent, (err, result) => {\n      if (err) {\n        reject(err);\n        return;\n      }\n\n      try {\n        const placemarks: KMLPlacemark[] = [];\n        \n        // Navigate through KML structure\n        const kml = result.kml || result.Document;\n        const document = kml.Document?.[0] || kml;\n        const folders = document.Folder || [];\n        const directPlacemarks = document.Placemark || [];\n\n        // Process direct placemarks\n        if (directPlacemarks.length > 0) {\n          placemarks.push(...extractPlacemarks(directPlacemarks));\n        }\n\n        // Process folders containing placemarks\n        folders.forEach((folder: any) => {\n          if (folder.Placemark) {\n            placemarks.push(...extractPlacemarks(folder.Placemark));\n          }\n        });\n\n        resolve(placemarks);\n      } catch (error) {\n        reject(error);\n      }\n    });\n  });\n}\n\nfunction extractPlacemarks(placemarkArray: any[]): KMLPlacemark[] {\n  return placemarkArray.map((placemark) => {\n    const name = placemark.name?.[0] || 'Unnamed Resource';\n    const description = placemark.description?.[0] || '';\n    \n    // Extract coordinates from Point geometry\n    let coordinates: [number, number] = [0, 0];\n    \n    if (placemark.Point?.[0]?.coordinates?.[0]) {\n      const coordString = placemark.Point[0].coordinates[0].trim();\n      const [lng, lat] = coordString.split(',').map(parseFloat);\n      coordinates = [lng, lat];\n    }\n\n    // Extract extended data as properties\n    const properties: Record<string, any> = {};\n    if (placemark.ExtendedData?.[0]?.Data) {\n      placemark.ExtendedData[0].Data.forEach((data: any) => {\n        const key = data.$.name;\n        const value = data.value?.[0] || '';\n        properties[key] = value;\n      });\n    }\n\n    return {\n      name,\n      description,\n      coordinates,\n      properties,\n    };\n  }).filter(p => p.coordinates[0] !== 0 && p.coordinates[1] !== 0); // Filter out invalid coordinates\n}\n\nexport function convertToResources(placemarks: KMLPlacemark[]): InsertResource[] {\n  return placemarks.map((placemark) => {\n    // Try to extract type from various fields\n    let type = 'Unknown';\n    \n    if (placemark.properties) {\n      // Common field names for type/category\n      type = placemark.properties.type ||\n             placemark.properties.category ||\n             placemark.properties.Type ||\n             placemark.properties.Category ||\n             placemark.properties.CLASS ||\n             placemark.properties.class ||\n             'Unknown';\n    }\n    \n    // If still unknown, try to infer from name or description\n    if (type === 'Unknown') {\n      const text = `${placemark.name} ${placemark.description || ''}`.toLowerCase();\n      \n      if (text.includes('union') && !text.includes('non-union')) {\n        type = 'Union';\n      } else if (text.includes('non-union') || text.includes('nonunion')) {\n        type = 'Non-union';\n      } else if (text.includes('veg') || text.includes('vegetable')) {\n        type = 'Veg';\n      } else if (text.includes('hvac') || text.includes('heating') || text.includes('cooling')) {\n        type = 'HVAC';\n      } else if (text.includes('dat') || text.includes('data')) {\n        type = 'DAT';\n      } else if (text.includes('consult')) {\n        type = 'Consulting';\n      } else if (text.includes('logistic') || text.includes('transport') || text.includes('shipping')) {\n        type = 'Logistics';\n      }\n    }\n\n    return {\n      name: placemark.name,\n      type: type,\n      latitude: placemark.coordinates[1],\n      longitude: placemark.coordinates[0],\n      description: placemark.description,\n      properties: placemark.properties,\n    };\n  });\n}\n","path":null,"size_bytes":5759,"size_tokens":null},"client/src/services/pingService.ts":{"content":"\nclass PingService {\n  private intervalId: NodeJS.Timeout | null = null;\n  private readonly PING_INTERVAL = 2 * 60 * 1000; // 2 minutes in milliseconds\n\n  start(): void {\n    if (this.intervalId) {\n      return; // Already running\n    }\n\n    this.intervalId = setInterval(() => {\n      this.ping();\n    }, this.PING_INTERVAL);\n\n    // Send initial ping\n    this.ping();\n  }\n\n  stop(): void {\n    if (this.intervalId) {\n      clearInterval(this.intervalId);\n      this.intervalId = null;\n    }\n  }\n\n  private async ping(): Promise<void> {\n    try {\n      const response = await fetch('/api/ping', {\n        method: 'GET',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n      });\n      \n      if (!response.ok) {\n        console.warn('Ping failed:', response.status);\n      }\n    } catch (error) {\n      console.warn('Ping error:', error);\n    }\n  }\n}\n\nexport const pingService = new PingService();\n","path":null,"size_bytes":926,"size_tokens":null},"client/src/components/ui/checkbox.tsx":{"content":"import * as React from \"react\"\nimport * as CheckboxPrimitive from \"@radix-ui/react-checkbox\"\nimport { Check } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Checkbox = React.forwardRef<\n  React.ElementRef<typeof CheckboxPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof CheckboxPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <CheckboxPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground\",\n      className\n    )}\n    {...props}\n  >\n    <CheckboxPrimitive.Indicator\n      className={cn(\"flex items-center justify-center text-current\")}\n    >\n      <Check className=\"h-4 w-4\" />\n    </CheckboxPrimitive.Indicator>\n  </CheckboxPrimitive.Root>\n))\nCheckbox.displayName = CheckboxPrimitive.Root.displayName\n\nexport { Checkbox }\n","path":null,"size_bytes":1056,"size_tokens":null},"client/src/components/ui/toast.tsx":{"content":"import * as React from \"react\"\nimport * as ToastPrimitives from \"@radix-ui/react-toast\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ToastProvider = ToastPrimitives.Provider\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      \"fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]\",\n      className\n    )}\n    {...props}\n  />\n))\nToastViewport.displayName = ToastPrimitives.Viewport.displayName\n\nconst toastVariants = cva(\n  \"group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full\",\n  {\n    variants: {\n      variant: {\n        default: \"border bg-background text-foreground\",\n        destructive:\n          \"destructive group border-destructive bg-destructive text-destructive-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  )\n})\nToast.displayName = ToastPrimitives.Root.displayName\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      \"inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 group-[.destructive]:border-muted/40 group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground group-[.destructive]:focus:ring-destructive\",\n      className\n    )}\n    {...props}\n  />\n))\nToastAction.displayName = ToastPrimitives.Action.displayName\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      \"absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100 group-[.destructive]:text-red-300 group-[.destructive]:hover:text-red-50 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600\",\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n))\nToastClose.displayName = ToastPrimitives.Close.displayName\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn(\"text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nToastTitle.displayName = ToastPrimitives.Title.displayName\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn(\"text-sm opacity-90\", className)}\n    {...props}\n  />\n))\nToastDescription.displayName = ToastPrimitives.Description.displayName\n\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>\n\ntype ToastActionElement = React.ReactElement<typeof ToastAction>\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n}\n","path":null,"size_bytes":4845,"size_tokens":null},"client/src/index.css":{"content":"@tailwind base;\n@tailwind components;\n@tailwind utilities;\n\n/* Prevent horizontal scrolling globally */\nhtml, body {\n  overflow-x: hidden;\n  max-width: 100vw;\n}\n\n* {\n  box-sizing: border-box;\n}\n\n:root {\n  --background: hsl(0, 0%, 100%);\n  --foreground: hsl(20, 14.3%, 4.1%);\n  --muted: hsl(60, 4.8%, 95.9%);\n  --muted-foreground: hsl(25, 5.3%, 44.7%);\n  --popover: hsl(0, 0%, 100%);\n  --popover-foreground: hsl(20, 14.3%, 4.1%);\n  --card: hsl(0, 0%, 100%);\n  --card-foreground: hsl(20, 14.3%, 4.1%);\n  --border: hsl(20, 5.9%, 90%);\n  --input: hsl(20, 5.9%, 90%);\n  --primary: hsl(220, 90%, 56%);\n  --primary-foreground: hsl(210, 40%, 98%);\n  --secondary: hsl(60, 4.8%, 95.9%);\n  --secondary-foreground: hsl(24, 9.8%, 10%);\n  --accent: hsl(60, 4.8%, 95.9%);\n  --accent-foreground: hsl(24, 9.8%, 10%);\n  --destructive: hsl(0, 84.2%, 60.2%);\n  --destructive-foreground: hsl(60, 9.1%, 97.8%);\n  --ring: hsl(20, 14.3%, 4.1%);\n  --radius: 0.5rem;\n}\n\n.dark {\n  --background: hsl(240, 10%, 3.9%);\n  --foreground: hsl(0, 0%, 98%);\n  --muted: hsl(240, 3.7%, 15.9%);\n  --muted-foreground: hsl(240, 5%, 64.9%);\n  --popover: hsl(240, 10%, 3.9%);\n  --popover-foreground: hsl(0, 0%, 98%);\n  --card: hsl(240, 10%, 3.9%);\n  --card-foreground: hsl(0, 0%, 98%);\n  --border: hsl(240, 3.7%, 15.9%);\n  --input: hsl(240, 3.7%, 15.9%);\n  --primary: hsl(220, 90%, 56%);\n  --primary-foreground: hsl(210, 40%, 98%);\n  --secondary: hsl(240, 3.7%, 15.9%);\n  --secondary-foreground: hsl(0, 0%, 98%);\n  --accent: hsl(240, 3.7%, 15.9%);\n  --accent-foreground: hsl(0, 0%, 98%);\n  --destructive: hsl(0, 62.8%, 30.6%);\n  --destructive-foreground: hsl(0, 0%, 98%);\n  --ring: hsl(240, 4.9%, 83.9%);\n  --radius: 0.5rem;\n}\n\n@layer base {\n  * {\n    @apply border-border;\n  }\n\n  body {\n    @apply font-sans antialiased bg-background text-foreground;\n    font-family: 'Inter', system-ui, sans-serif;\n  }\n}\n\n/* Leaflet map styles */\n.leaflet-container {\n  font-family: 'Inter', system-ui, sans-serif;\n}\n\n.leaflet-popup-content-wrapper {\n  border-radius: 0.5rem;\n  box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);\n}\n\n.leaflet-popup-tip {\n  box-shadow: 0 3px 6px rgb(0 0 0 / 0.1);\n}\n\n/* Ensure Leaflet controls stay below sidebar */\n.leaflet-control-container {\n  z-index: 400 !important;\n}\n\n.leaflet-control-zoom {\n  z-index: 400 !important;\n}\n\n/* Resource label styling */\n.resource-label {\n  background: transparent !important;\n  border: none !important;\n  box-shadow: none !important;\n}\n\n/* Mobile responsive improvements */\n@media (max-width: 768px) {\n  /* Ensure touch targets are at least 44px */\n  button, \n  [role=\"button\"],\n  input[type=\"button\"],\n  input[type=\"submit\"],\n  .leaflet-control-zoom a {\n    min-height: 44px !important;\n    min-width: 44px !important;\n  }\n  \n  /* Better form field spacing on mobile */\n  .space-y-2 > * + * {\n    margin-top: 0.75rem;\n  }\n  \n  /* Ensure select dropdowns are readable */\n  select,\n  [role=\"combobox\"] {\n    min-height: 44px;\n    font-size: 16px; /* Prevents zoom on iOS */\n  }\n  \n  /* Better card spacing on mobile */\n  .grid.gap-4 {\n    gap: 0.75rem;\n  }\n  \n  /* Leaflet controls positioning for mobile - adjust for new layout */\n  .leaflet-control-container .leaflet-top.leaflet-left {\n    top: 10px;\n    left: 10px;\n  }\n  \n  /* Ensure proper mobile scrolling */\n  .overflow-y-auto {\n    -webkit-overflow-scrolling: touch;\n  }\n  \n  /* Better mobile table cards */\n  .block.md\\\\:hidden .space-y-3 > * + * {\n    margin-top: 0.75rem;\n  }\n}\n\n.resource-label div {\n  font-family: 'Inter', system-ui, sans-serif !important;\n  pointer-events: none;\n  white-space: nowrap;\n  font-size: 9px !important;\n  line-height: 1.2 !important;\n  max-width: 100px !important;\n  overflow: hidden !important;\n  text-overflow: ellipsis !important;\n  color: black !important;\n  font-weight: 500 !important;\n  text-shadow: 1px 1px 1px white, -1px -1px 1px white, 1px -1px 1px white, -1px 1px 1px white !important;\n}\n\n/* Dialog overlay styles to ensure proper z-index */\n[data-radix-dialog-overlay] {\n  z-index: 9998 !important;\n}\n\n[data-radix-dialog-content] {\n  z-index: 9999 !important;\n}\n","path":null,"size_bytes":4109,"size_tokens":null},"client/src/components/ui/dropdown-menu.tsx":{"content":"import * as React from \"react\"\nimport * as DropdownMenuPrimitive from \"@radix-ui/react-dropdown-menu\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst DropdownMenu = DropdownMenuPrimitive.Root\n\nconst DropdownMenuTrigger = DropdownMenuPrimitive.Trigger\n\nconst DropdownMenuGroup = DropdownMenuPrimitive.Group\n\nconst DropdownMenuPortal = DropdownMenuPrimitive.Portal\n\nconst DropdownMenuSub = DropdownMenuPrimitive.Sub\n\nconst DropdownMenuRadioGroup = DropdownMenuPrimitive.RadioGroup\n\nconst DropdownMenuSubTrigger = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent data-[state=open]:bg-accent [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto\" />\n  </DropdownMenuPrimitive.SubTrigger>\n))\nDropdownMenuSubTrigger.displayName =\n  DropdownMenuPrimitive.SubTrigger.displayName\n\nconst DropdownMenuSubContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuSubContent.displayName =\n  DropdownMenuPrimitive.SubContent.displayName\n\nconst DropdownMenuContent = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <DropdownMenuPrimitive.Portal>\n    <DropdownMenuPrimitive.Content\n      ref={ref}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 max-h-[var(--radix-dropdown-menu-content-available-height)] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-dropdown-menu-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </DropdownMenuPrimitive.Portal>\n))\nDropdownMenuContent.displayName = DropdownMenuPrimitive.Content.displayName\n\nconst DropdownMenuItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuItem.displayName = DropdownMenuPrimitive.Item.displayName\n\nconst DropdownMenuCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <DropdownMenuPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.CheckboxItem>\n))\nDropdownMenuCheckboxItem.displayName =\n  DropdownMenuPrimitive.CheckboxItem.displayName\n\nconst DropdownMenuRadioItem = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <DropdownMenuPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <DropdownMenuPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </DropdownMenuPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </DropdownMenuPrimitive.RadioItem>\n))\nDropdownMenuRadioItem.displayName = DropdownMenuPrimitive.RadioItem.displayName\n\nconst DropdownMenuLabel = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <DropdownMenuPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nDropdownMenuLabel.displayName = DropdownMenuPrimitive.Label.displayName\n\nconst DropdownMenuSeparator = React.forwardRef<\n  React.ElementRef<typeof DropdownMenuPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof DropdownMenuPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <DropdownMenuPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nDropdownMenuSeparator.displayName = DropdownMenuPrimitive.Separator.displayName\n\nconst DropdownMenuShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\"ml-auto text-xs tracking-widest opacity-60\", className)}\n      {...props}\n    />\n  )\n}\nDropdownMenuShortcut.displayName = \"DropdownMenuShortcut\"\n\nexport {\n  DropdownMenu,\n  DropdownMenuTrigger,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuCheckboxItem,\n  DropdownMenuRadioItem,\n  DropdownMenuLabel,\n  DropdownMenuSeparator,\n  DropdownMenuShortcut,\n  DropdownMenuGroup,\n  DropdownMenuPortal,\n  DropdownMenuSub,\n  DropdownMenuSubContent,\n  DropdownMenuSubTrigger,\n  DropdownMenuRadioGroup,\n}\n","path":null,"size_bytes":7609,"size_tokens":null},"client/src/pages/login.tsx":{"content":"import { useAuth } from '@/context/AuthContext';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Zap, MapPin, Activity, LogIn } from 'lucide-react';\n\nexport default function LoginPage() {\n  const { login, isLoading } = useAuth();\n\n  const handleLogin = () => {\n    login(); // Redirects to /api/login\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800 flex items-center justify-center p-4\">\n      <div className=\"w-full max-w-md space-y-8\">\n        {/* Logo and Title */}\n        <div className=\"text-center space-y-4\">\n          <div className=\"inline-flex items-center justify-center w-16 h-16 bg-blue-600 text-white rounded-full\">\n            <Zap className=\"w-8 h-8\" />\n          </div>\n          <div>\n            <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white\">BirdStorm</h1>\n            <p className=\"text-gray-600 dark:text-gray-300 mt-2\">Utility Storm Response Management</p>\n          </div>\n        </div>\n\n        {/* Login Card */}\n        <Card className=\"shadow-xl\">\n          <CardHeader className=\"space-y-1\">\n            <CardTitle className=\"text-2xl text-center\">Sign In</CardTitle>\n            <CardDescription className=\"text-center\">\n              Sign in with your Replit account to access storm response management\n            </CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Button \n              onClick={handleLogin} \n              className=\"w-full h-12\" \n              disabled={isLoading}\n              data-testid=\"button-login\"\n            >\n              <LogIn className=\"mr-2 h-5 w-5\" />\n              Sign in with Replit\n            </Button>\n            <p className=\"text-xs text-center text-gray-500 dark:text-gray-400 mt-4\">\n              You'll be redirected to Replit to authenticate\n            </p>\n          </CardContent>\n        </Card>\n\n        {/* Features Preview */}\n        <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4 text-center\">\n          <div className=\"bg-white dark:bg-gray-800 p-4 rounded-lg shadow\">\n            <MapPin className=\"w-6 h-6 text-blue-600 mx-auto mb-2\" />\n            <h3 className=\"font-semibold text-sm\">Resource Mapping</h3>\n            <p className=\"text-xs text-gray-600 dark:text-gray-400\">Locate resources instantly</p>\n          </div>\n          <div className=\"bg-white dark:bg-gray-800 p-4 rounded-lg shadow\">\n            <Activity className=\"w-6 h-6 text-green-600 mx-auto mb-2\" />\n            <h3 className=\"font-semibold text-sm\">Crew Management</h3>\n            <p className=\"text-xs text-gray-600 dark:text-gray-400\">Track crews and equipment</p>\n          </div>\n          <div className=\"bg-white dark:bg-gray-800 p-4 rounded-lg shadow\">\n            <Zap className=\"w-6 h-6 text-yellow-600 mx-auto mb-2\" />\n            <h3 className=\"font-semibold text-sm\">Storm Response</h3>\n            <p className=\"text-xs text-gray-600 dark:text-gray-400\">Fast emergency response</p>\n          </div>\n        </div>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":3174,"size_tokens":null},"client/src/components/ExportModal.tsx":{"content":"import { useState } from \"react\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Download } from \"lucide-react\";\nimport { useMutation } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { getSessionId } from \"@/lib/sessionUtils\";\n\ninterface ExportModalProps {\n  isOpen: boolean;\n  onClose: () => void;\n  selectedPointId: number | null;\n}\n\nexport default function ExportModal({ isOpen, onClose, selectedPointId }: ExportModalProps) {\n  const [format, setFormat] = useState(\"excel\");\n  const [includeDistances, setIncludeDistances] = useState(true);\n  const [includeTimes, setIncludeTimes] = useState(true);\n  const [includeMap, setIncludeMap] = useState(false);\n  const { toast } = useToast();\n\n  const exportMutation = useMutation({\n    mutationFn: async (data: any) => {\n      const { pointId, format, options } = data;\n      \n      // Build query parameters\n      const params = new URLSearchParams({\n        format: format\n      });\n      \n      // Add optional parameters based on options\n      if (options.includeDistances === false) {\n        params.append('includeDistances', 'false');\n      }\n      if (options.includeTimes === false) {\n        params.append('includeTimes', 'false');\n      }\n      \n      const url = `/api/analysis-points/${pointId}/calculations/export?${params.toString()}`;\n      \n      const response = await fetch(url, {\n        method: 'GET',\n        headers: {\n          'X-Session-ID': getSessionId()\n        },\n        credentials: 'include'\n      });\n      \n      if (!response.ok) {\n        throw new Error(`Export failed: ${response.status} ${response.statusText}`);\n      }\n      \n      return { response, format };\n    },\n    onSuccess: async ({ response, format: responseFormat }) => {\n      try {\n        if (responseFormat === 'csv' || responseFormat === 'excel') {\n          const blob = await response.blob();\n          const url = window.URL.createObjectURL(blob);\n          const a = document.createElement('a');\n          a.href = url;\n          \n          // Get filename from Content-Disposition header or use default\n          const contentDisposition = response.headers.get('content-disposition');\n          let filename = responseFormat === 'excel' ? 'distance-analysis.xlsx' : 'distance-analysis.csv';\n          \n          if (contentDisposition) {\n            const filenameMatch = contentDisposition.match(/filename[^;=\\n]*=((['\"]).*?\\2|[^;\\n]*)/);\n            if (filenameMatch && filenameMatch[1]) {\n              filename = filenameMatch[1].replace(/['\"]/g, '');\n            }\n          }\n          \n          a.download = filename;\n          document.body.appendChild(a);\n          a.click();\n          window.URL.revokeObjectURL(url);\n          document.body.removeChild(a);\n        } else {\n          const data = await response.json();\n          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });\n          const url = window.URL.createObjectURL(blob);\n          const a = document.createElement('a');\n          a.href = url;\n          a.download = 'distance-analysis.json';\n          document.body.appendChild(a);\n          a.click();\n          window.URL.revokeObjectURL(url);\n          document.body.removeChild(a);\n        }\n\n        toast({\n          title: \"Export successful\",\n          description: \"Your analysis has been exported successfully.\",\n        });\n        onClose();\n      } catch (downloadError) {\n        console.error('Download error:', downloadError);\n        toast({\n          title: \"Download failed\",\n          description: \"Failed to download the exported file.\",\n          variant: \"destructive\",\n        });\n      }\n    },\n    onError: (error) => {\n      console.error('Export error:', error);\n      toast({\n        title: \"Export failed\",\n        description: \"Failed to export analysis data.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const handleExport = () => {\n    if (!selectedPointId) {\n      toast({\n        title: \"No point selected\",\n        description: \"Please select an analysis point to export.\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    console.log('Exporting with options:', {\n      format,\n      pointId: selectedPointId,\n      options: {\n        includeDistances,\n        includeTimes,\n        includeMap,\n      },\n    });\n\n    exportMutation.mutate({\n      format,\n      pointId: selectedPointId,\n      options: {\n        includeDistances,\n        includeTimes,\n        includeMap,\n      },\n    });\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-lg\" style={{ zIndex: 9999 }}>\n        <DialogHeader>\n          <DialogTitle>Export Results</DialogTitle>\n        </DialogHeader>\n        \n        <div className=\"space-y-4 py-4\">\n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">Export Format</label>\n            <Select value={format} onValueChange={setFormat}>\n              <SelectTrigger>\n                <SelectValue />\n              </SelectTrigger>\n              <SelectContent>\n                <SelectItem value=\"excel\">Excel (.xlsx)</SelectItem>\n                <SelectItem value=\"csv\">CSV Spreadsheet</SelectItem>\n                <SelectItem value=\"json\">JSON Data</SelectItem>\n              </SelectContent>\n            </Select>\n          </div>\n          \n          <div>\n            <label className=\"block text-sm font-medium text-gray-700 mb-2\">Include</label>\n            <div className=\"space-y-2\">\n              <div className=\"flex items-center space-x-2\">\n                <Checkbox\n                  id=\"distances\"\n                  checked={includeDistances}\n                  onCheckedChange={(checked) => setIncludeDistances(checked === true)}\n                />\n                <label htmlFor=\"distances\" className=\"text-sm text-gray-700\">\n                  Distance calculations\n                </label>\n              </div>\n              <div className=\"flex items-center space-x-2\">\n                <Checkbox\n                  id=\"times\"\n                  checked={includeTimes}\n                  onCheckedChange={(checked) => setIncludeTimes(checked === true)}\n                />\n                <label htmlFor=\"times\" className=\"text-sm text-gray-700\">\n                  Travel time estimates\n                </label>\n              </div>\n              <div className=\"flex items-center space-x-2\">\n                <Checkbox\n                  id=\"map\"\n                  checked={includeMap}\n                  onCheckedChange={(checked) => setIncludeMap(checked === true)}\n                />\n                <label htmlFor=\"map\" className=\"text-sm text-gray-700\">\n                  Map screenshot (coming soon)\n                </label>\n              </div>\n            </div>\n          </div>\n        </div>\n        \n        <div className=\"flex justify-end space-x-3\">\n          <Button variant=\"ghost\" onClick={onClose}>\n            Cancel\n          </Button>\n          <Button \n            onClick={handleExport}\n            disabled={exportMutation.isPending || !selectedPointId}\n          >\n            <Download className=\"mr-2\" size={16} />\n            {exportMutation.isPending ? 'Exporting...' : 'Export'}\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":7648,"size_tokens":null},"tailwind.config.ts":{"content":"import type { Config } from \"tailwindcss\";\n\nexport default {\n  darkMode: [\"class\"],\n  content: [\"./client/index.html\", \"./client/src/**/*.{js,jsx,ts,tsx}\"],\n  theme: {\n    extend: {\n      borderRadius: {\n        lg: \"var(--radius)\",\n        md: \"calc(var(--radius) - 2px)\",\n        sm: \"calc(var(--radius) - 4px)\",\n      },\n      colors: {\n        background: \"var(--background)\",\n        foreground: \"var(--foreground)\",\n        card: {\n          DEFAULT: \"var(--card)\",\n          foreground: \"var(--card-foreground)\",\n        },\n        popover: {\n          DEFAULT: \"var(--popover)\",\n          foreground: \"var(--popover-foreground)\",\n        },\n        primary: {\n          DEFAULT: \"var(--primary)\",\n          foreground: \"var(--primary-foreground)\",\n        },\n        secondary: {\n          DEFAULT: \"var(--secondary)\",\n          foreground: \"var(--secondary-foreground)\",\n        },\n        muted: {\n          DEFAULT: \"var(--muted)\",\n          foreground: \"var(--muted-foreground)\",\n        },\n        accent: {\n          DEFAULT: \"var(--accent)\",\n          foreground: \"var(--accent-foreground)\",\n        },\n        destructive: {\n          DEFAULT: \"var(--destructive)\",\n          foreground: \"var(--destructive-foreground)\",\n        },\n        border: \"var(--border)\",\n        input: \"var(--input)\",\n        ring: \"var(--ring)\",\n        chart: {\n          \"1\": \"var(--chart-1)\",\n          \"2\": \"var(--chart-2)\",\n          \"3\": \"var(--chart-3)\",\n          \"4\": \"var(--chart-4)\",\n          \"5\": \"var(--chart-5)\",\n        },\n        sidebar: {\n          DEFAULT: \"var(--sidebar-background)\",\n          foreground: \"var(--sidebar-foreground)\",\n          primary: \"var(--sidebar-primary)\",\n          \"primary-foreground\": \"var(--sidebar-primary-foreground)\",\n          accent: \"var(--sidebar-accent)\",\n          \"accent-foreground\": \"var(--sidebar-accent-foreground)\",\n          border: \"var(--sidebar-border)\",\n          ring: \"var(--sidebar-ring)\",\n        },\n      },\n      keyframes: {\n        \"accordion-down\": {\n          from: {\n            height: \"0\",\n          },\n          to: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n        },\n        \"accordion-up\": {\n          from: {\n            height: \"var(--radix-accordion-content-height)\",\n          },\n          to: {\n            height: \"0\",\n          },\n        },\n      },\n      animation: {\n        \"accordion-down\": \"accordion-down 0.2s ease-out\",\n        \"accordion-up\": \"accordion-up 0.2s ease-out\",\n      },\n    },\n  },\n  plugins: [require(\"tailwindcss-animate\"), require(\"@tailwindcss/typography\")],\n} satisfies Config;\n","path":null,"size_bytes":2627,"size_tokens":null},"client/src/components/ui/toggle-group.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as ToggleGroupPrimitive from \"@radix-ui/react-toggle-group\"\nimport { type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\nimport { toggleVariants } from \"@/components/ui/toggle\"\n\nconst ToggleGroupContext = React.createContext<\n  VariantProps<typeof toggleVariants>\n>({\n  size: \"default\",\n  variant: \"default\",\n})\n\nconst ToggleGroup = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Root> &\n    VariantProps<typeof toggleVariants>\n>(({ className, variant, size, children, ...props }, ref) => (\n  <ToggleGroupPrimitive.Root\n    ref={ref}\n    className={cn(\"flex items-center justify-center gap-1\", className)}\n    {...props}\n  >\n    <ToggleGroupContext.Provider value={{ variant, size }}>\n      {children}\n    </ToggleGroupContext.Provider>\n  </ToggleGroupPrimitive.Root>\n))\n\nToggleGroup.displayName = ToggleGroupPrimitive.Root.displayName\n\nconst ToggleGroupItem = React.forwardRef<\n  React.ElementRef<typeof ToggleGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof ToggleGroupPrimitive.Item> &\n    VariantProps<typeof toggleVariants>\n>(({ className, children, variant, size, ...props }, ref) => {\n  const context = React.useContext(ToggleGroupContext)\n\n  return (\n    <ToggleGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        toggleVariants({\n          variant: context.variant || variant,\n          size: context.size || size,\n        }),\n        className\n      )}\n      {...props}\n    >\n      {children}\n    </ToggleGroupPrimitive.Item>\n  )\n})\n\nToggleGroupItem.displayName = ToggleGroupPrimitive.Item.displayName\n\nexport { ToggleGroup, ToggleGroupItem }\n","path":null,"size_bytes":1753,"size_tokens":null},"client/src/App.tsx":{"content":"import { Switch, Route } from \"wouter\";\nimport { queryClient } from \"./lib/queryClient\";\nimport { QueryClientProvider } from \"@tanstack/react-query\";\nimport { Toaster } from \"@/components/ui/toaster\";\nimport { TooltipProvider } from \"@/components/ui/tooltip\";\nimport { AuthProvider, useAuth } from \"@/context/AuthContext\";\nimport { ActiveSessionProvider } from \"@/context/ActiveSessionContext\";\nimport { pingService } from \"@/services/pingService\";\nimport { useEffect } from \"react\";\nimport HomePage from \"@/pages/home\";\nimport LoginPage from \"@/pages/login\";\nimport MapPage from \"@/pages/map\";\nimport ContractorsPage from \"@/pages/contractors\";\nimport AvailabilityPage from \"@/pages/availability\";\nimport ContractorAvailabilityForm from \"@/pages/contractor-form\";\nimport UtilityAdmin from \"@/pages/utility-admin\";\nimport CompaniesPage from \"@/pages/companies\";\nimport SessionsPage from \"@/pages/sessions\";\nimport RostersPage from \"@/pages/rosters\";\nimport RosterDetailPage from \"@/pages/roster-detail\";\nimport TimesheetsPage from \"@/pages/timesheets\";\nimport TimesheetDetailPage from \"@/pages/timesheet-detail\";\nimport ExpensesPage from \"@/pages/expenses\";\nimport InvoicesPage from \"@/pages/invoices\";\nimport ReportsPage from \"@/pages/reports\";\nimport UsersPage from \"@/pages/users\";\nimport AccessManagementPage from \"@/pages/access-management\";\nimport ContractorProfilePage from \"@/pages/contractor-profile\";\nimport TicketsPage from \"@/pages/tickets\";\nimport NotFound from \"@/pages/not-found\";\n\nfunction AuthenticatedRouter() {\n  const { user, isLoading } = useAuth();\n\n  if (isLoading) {\n    return (\n      <div className=\"min-h-screen flex items-center justify-center\">\n        <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\n      </div>\n    );\n  }\n\n  if (!user) {\n    return <LoginPage />;\n  }\n\n  return (\n    <Switch>\n      <Route path=\"/\" component={HomePage} />\n      <Route path=\"/map\" component={MapPage} />\n      <Route path=\"/contractors\" component={ContractorsPage} />\n      <Route path=\"/availability\" component={AvailabilityPage} />\n      <Route path=\"/utility-admin\" component={UtilityAdmin} />\n      <Route path=\"/companies\" component={CompaniesPage} />\n      <Route path=\"/sessions\" component={SessionsPage} />\n      <Route path=\"/rosters/:id\" component={RosterDetailPage} />\n      <Route path=\"/rosters\" component={RostersPage} />\n      <Route path=\"/timesheets/:id\" component={TimesheetDetailPage} />\n      <Route path=\"/timesheets\" component={TimesheetsPage} />\n      <Route path=\"/expenses\" component={ExpensesPage} />\n      <Route path=\"/invoices\" component={InvoicesPage} />\n      <Route path=\"/reports\" component={ReportsPage} />\n      <Route path=\"/users\" component={UsersPage} />\n      <Route path=\"/access-management\" component={AccessManagementPage} />\n      <Route path=\"/tickets/:id\" component={TicketsPage} />\n      <Route path=\"/tickets\" component={TicketsPage} />\n      <Route path=\"/profile\" component={ContractorProfilePage} />\n      <Route component={NotFound} />\n    </Switch>\n  );\n}\n\nfunction PublicRouter() {\n  return (\n    <Switch>\n      {/* Public contractor form route - no authentication required */}\n      <Route path=\"/contractor-availability\" component={ContractorAvailabilityForm} />\n      <Route path=\"*\" component={AuthenticatedRouter} />\n    </Switch>\n  );\n}\n\nfunction App() {\n  useEffect(() => {\n    // Start the ping service to keep the app awake\n    pingService.start();\n    \n    // Cleanup on unmount\n    return () => {\n      pingService.stop();\n    };\n  }, []);\n\n  return (\n    <QueryClientProvider client={queryClient}>\n      <TooltipProvider>\n        <AuthProvider>\n          <ActiveSessionProvider>\n            <Toaster />\n            <PublicRouter />\n          </ActiveSessionProvider>\n        </AuthProvider>\n      </TooltipProvider>\n    </QueryClientProvider>\n  );\n}\n\nexport default App;\n","path":null,"size_bytes":3888,"size_tokens":null},"client/src/components/ui/alert.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst alertVariants = cva(\n  \"relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-background text-foreground\",\n        destructive:\n          \"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nconst Alert = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & VariantProps<typeof alertVariants>\n>(({ className, variant, ...props }, ref) => (\n  <div\n    ref={ref}\n    role=\"alert\"\n    className={cn(alertVariants({ variant }), className)}\n    {...props}\n  />\n))\nAlert.displayName = \"Alert\"\n\nconst AlertTitle = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLHeadingElement>\n>(({ className, ...props }, ref) => (\n  <h5\n    ref={ref}\n    className={cn(\"mb-1 font-medium leading-none tracking-tight\", className)}\n    {...props}\n  />\n))\nAlertTitle.displayName = \"AlertTitle\"\n\nconst AlertDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm [&_p]:leading-relaxed\", className)}\n    {...props}\n  />\n))\nAlertDescription.displayName = \"AlertDescription\"\n\nexport { Alert, AlertTitle, AlertDescription }\n","path":null,"size_bytes":1584,"size_tokens":null},"client/src/pages/home.tsx":{"content":"import { useAuth } from '@/context/AuthContext';\nimport { Link } from 'wouter';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { useQuery } from '@tanstack/react-query';\nimport type { StormSession, Company } from '@shared/schema';\nimport { \n  Building2, \n  CloudRain, \n  Users, \n  FileText, \n  Receipt, \n  FileSpreadsheet,\n  BarChart3,\n  ArrowRight,\n  Activity,\n  Clock,\n  CheckCircle,\n  AlertCircle,\n  MapPin,\n  Calendar\n} from 'lucide-react';\n\nexport default function HomePage() {\n  const { user, logout } = useAuth();\n\n  const { data: sessions, isLoading: sessionsLoading } = useQuery<StormSession[]>({\n    queryKey: ['/api/storm-sessions'],\n    enabled: !!user,\n  });\n\n  const { data: companies, isLoading: companiesLoading } = useQuery<Company[]>({\n    queryKey: ['/api/companies'],\n    enabled: user?.role === 'UTILITY',\n  });\n\n  const activeSessions = sessions?.filter((s) => !s.closedAt) || [];\n  const totalCompanies = companies?.length || 0;\n\n  const getRoleBadge = (role: string | null) => {\n    if (!role) return null;\n    const roleColors = {\n      UTILITY: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',\n      MANAGER: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',\n      CONTRACTOR: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',\n    };\n    return (\n      <Badge className={roleColors[role as keyof typeof roleColors]}>\n        {role}\n      </Badge>\n    );\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 dark:from-gray-900 dark:to-gray-800\">\n      {/* Header */}\n      <header className=\"bg-white dark:bg-gray-800 shadow-sm border-b\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"flex justify-between items-center h-16\">\n            <div className=\"flex items-center space-x-3\">\n              <div className=\"inline-flex items-center justify-center w-10 h-10 bg-blue-600 text-white rounded-lg\">\n                <CloudRain className=\"w-6 h-6\" />\n              </div>\n              <div>\n                <h1 className=\"text-xl font-bold text-gray-900 dark:text-white\">Storm Response Platform</h1>\n                <p className=\"text-xs text-gray-500 dark:text-gray-400\">Resource Management & Billing</p>\n              </div>\n            </div>\n            <div className=\"flex items-center space-x-4\">\n              <div className=\"flex items-center space-x-2\">\n                <span className=\"text-sm text-gray-600 dark:text-gray-300\">{user?.email}</span>\n                {getRoleBadge(user?.role || null)}\n              </div>\n              <Button variant=\"outline\" size=\"sm\" onClick={logout} data-testid=\"button-logout\">\n                Logout\n              </Button>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      {/* Main Content */}\n      <main className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        {/* Hero Section */}\n        <div className=\"text-center mb-12\">\n          <h2 className=\"text-4xl font-bold text-gray-900 dark:text-white mb-4\">\n            Storm Response Management Hub\n          </h2>\n          <p className=\"text-xl text-gray-600 dark:text-gray-300 max-w-3xl mx-auto\">\n            Comprehensive platform for resource analysis, contractor management, session tracking, timesheets, expenses, and invoicing.\n          </p>\n        </div>\n\n        {/* Stats Section */}\n        <div className=\"bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8\">\n          <h3 className=\"text-lg font-semibold text-gray-900 dark:text-white mb-4\">System Overview</h3>\n          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n            <div className=\"text-center\" data-testid=\"stat-active-sessions\">\n              <div className=\"text-2xl font-bold text-blue-600\">\n                {sessionsLoading ? '...' : activeSessions.length}\n              </div>\n              <div className=\"text-sm text-gray-600 dark:text-gray-400\">Active Sessions</div>\n            </div>\n            {user?.role === 'UTILITY' && (\n              <div className=\"text-center\" data-testid=\"stat-total-companies\">\n                <div className=\"text-2xl font-bold text-green-600\">\n                  {companiesLoading ? '...' : totalCompanies}\n                </div>\n                <div className=\"text-sm text-gray-600 dark:text-gray-400\">Contractor Companies</div>\n              </div>\n            )}\n            <div className=\"text-center\" data-testid=\"stat-status-ready\">\n              <div className=\"text-2xl font-bold text-purple-600\">Ready</div>\n              <div className=\"text-sm text-gray-600 dark:text-gray-400\">System Status</div>\n            </div>\n            <div className=\"text-center\" data-testid=\"stat-database-active\">\n              <div className=\"text-2xl font-bold text-orange-600\">Active</div>\n              <div className=\"text-sm text-gray-600 dark:text-gray-400\">Database</div>\n            </div>\n          </div>\n        </div>\n\n        {/* Storm Response Management Section */}\n        <div className=\"mb-12\">\n          <div className=\"flex items-center mb-6\">\n            <CloudRain className=\"w-6 h-6 text-blue-600 mr-2\" />\n            <h3 className=\"text-2xl font-bold text-gray-900 dark:text-white\">Storm Response Management</h3>\n          </div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {/* Storm Sessions Card */}\n            <Card className=\"border-2 border-blue-200 dark:border-blue-700\" data-testid=\"card-sessions\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-2\">\n                    <CloudRain className=\"w-6 h-6 text-blue-600\" />\n                    <CardTitle>Storm Sessions</CardTitle>\n                  </div>\n                  <Badge variant=\"default\">Core</Badge>\n                </div>\n                <CardDescription>\n                  Create and manage storm response sessions with contractor assignments.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2 mb-4\">\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <Activity className=\"w-4 h-4 mr-2\" />\n                    Active session tracking\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <Clock className=\"w-4 h-4 mr-2\" />\n                    Start/end date management\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <FileText className=\"w-4 h-4 mr-2\" />\n                    Session details & notes\n                  </div>\n                </div>\n                <Link href=\"/sessions\">\n                  <Button className=\"w-full\" data-testid=\"button-open-sessions\">\n                    Manage Sessions\n                    <ArrowRight className=\"w-4 h-4 ml-2\" />\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n\n            {/* Tickets Card */}\n            <Card className=\"border-2 border-blue-200 dark:border-blue-700\" data-testid=\"card-tickets\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-2\">\n                    <FileText className=\"w-6 h-6 text-blue-600\" />\n                    <CardTitle>Tickets</CardTitle>\n                  </div>\n                  <Badge variant=\"secondary\">Operations</Badge>\n                </div>\n                <CardDescription>\n                  Create, assign, and track work tickets for storm restoration crews.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2 mb-4\">\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <CheckCircle className=\"w-4 h-4 mr-2 text-green-500\" />\n                    Ticket lifecycle management\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <Activity className=\"w-4 h-4 mr-2 text-blue-500\" />\n                    Crew assignment &amp; tracking\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <Clock className=\"w-4 h-4 mr-2 text-purple-500\" />\n                    Automatic work segment logging\n                  </div>\n                </div>\n                <Link href=\"/tickets\">\n                  <Button className=\"w-full\" data-testid=\"button-open-tickets\">\n                    Manage Tickets\n                    <ArrowRight className=\"w-4 h-4 ml-2\" />\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n\n            {/* Rosters Card */}\n            <Card className=\"border-2 border-purple-200 dark:border-purple-700\" data-testid=\"card-rosters\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Users className=\"w-6 h-6 text-purple-600\" />\n                    <CardTitle>Rosters & Crews</CardTitle>\n                  </div>\n                  <Badge variant=\"secondary\">Operations</Badge>\n                </div>\n                <CardDescription>\n                  Manage contractor crews, personnel, and equipment assignments.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2 mb-4\">\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <Users className=\"w-4 h-4 mr-2\" />\n                    Crew composition tracking\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <FileText className=\"w-4 h-4 mr-2\" />\n                    Personnel & equipment details\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <CheckCircle className=\"w-4 h-4 mr-2\" />\n                    Role-based access control\n                  </div>\n                </div>\n                <Link href=\"/rosters\">\n                  <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-open-rosters\">\n                    Manage Rosters\n                    <ArrowRight className=\"w-4 h-4 ml-2\" />\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n\n            {/* Timesheets Card */}\n            <Card className=\"border-2 border-green-200 dark:border-green-700\" data-testid=\"card-timesheets\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Clock className=\"w-6 h-6 text-green-600\" />\n                    <CardTitle>Timesheets</CardTitle>\n                  </div>\n                  <Badge variant=\"default\">Workflow</Badge>\n                </div>\n                <CardDescription>\n                  Daily time entry with submit and approve workflows for billing.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2 mb-4\">\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <FileText className=\"w-4 h-4 mr-2\" />\n                    Daily time tracking\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <AlertCircle className=\"w-4 h-4 mr-2\" />\n                    Submit → Approve workflow\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <CheckCircle className=\"w-4 h-4 mr-2\" />\n                    Audit trail tracking\n                  </div>\n                </div>\n                <Link href=\"/timesheets\">\n                  <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-open-timesheets\">\n                    Manage Timesheets\n                    <ArrowRight className=\"w-4 h-4 ml-2\" />\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n\n            {/* Expenses Card */}\n            <Card className=\"border-2 border-orange-200 dark:border-orange-700\" data-testid=\"card-expenses\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Receipt className=\"w-6 h-6 text-orange-600\" />\n                    <CardTitle>Expenses</CardTitle>\n                  </div>\n                  <Badge variant=\"secondary\">Billing</Badge>\n                </div>\n                <CardDescription>\n                  Track expenses with receipt uploads and approval workflows.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2 mb-4\">\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <Receipt className=\"w-4 h-4 mr-2\" />\n                    Receipt file uploads\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <FileText className=\"w-4 h-4 mr-2\" />\n                    Expense categorization\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <CheckCircle className=\"w-4 h-4 mr-2\" />\n                    Approval workflows\n                  </div>\n                </div>\n                <Link href=\"/expenses\">\n                  <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-open-expenses\">\n                    Manage Expenses\n                    <ArrowRight className=\"w-4 h-4 ml-2\" />\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n\n            {/* Invoices Card */}\n            <Card className=\"border-2 border-indigo-200 dark:border-indigo-700\" data-testid=\"card-invoices\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-2\">\n                    <FileSpreadsheet className=\"w-6 h-6 text-indigo-600\" />\n                    <CardTitle>Invoices</CardTitle>\n                  </div>\n                  <Badge variant=\"default\">Billing</Badge>\n                </div>\n                <CardDescription>\n                  Generate and manage invoices with line items from timesheets.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2 mb-4\">\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n                    Invoice generation\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <FileText className=\"w-4 h-4 mr-2\" />\n                    Line item tracking\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <CheckCircle className=\"w-4 h-4 mr-2\" />\n                    Issue → Paid workflow\n                  </div>\n                </div>\n                <Link href=\"/invoices\">\n                  <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-open-invoices\">\n                    Manage Invoices\n                    <ArrowRight className=\"w-4 h-4 ml-2\" />\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n\n            {/* Reports Card */}\n            <Card className=\"border-2 border-teal-200 dark:border-teal-700\" data-testid=\"card-reports\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-2\">\n                    <BarChart3 className=\"w-6 h-6 text-teal-600\" />\n                    <CardTitle>Reports</CardTitle>\n                  </div>\n                  <Badge variant=\"default\">Analytics</Badge>\n                </div>\n                <CardDescription>\n                  Detailed daily hours reports for personnel and equipment by contractor.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2 mb-4\">\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <BarChart3 className=\"w-4 h-4 mr-2\" />\n                    Daily hours breakdown\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <Users className=\"w-4 h-4 mr-2\" />\n                    Personnel & equipment tracking\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n                    Excel export\n                  </div>\n                </div>\n                <Link href=\"/reports\">\n                  <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-open-reports\">\n                    View Reports\n                    <ArrowRight className=\"w-4 h-4 ml-2\" />\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n\n            {/* Companies Card (UTILITY only) */}\n            {user?.role === 'UTILITY' && (\n              <Card className=\"border-2 border-emerald-200 dark:border-emerald-700\" data-testid=\"card-companies\">\n                <CardHeader>\n                  <div className=\"flex items-center justify-between\">\n                    <div className=\"flex items-center space-x-2\">\n                      <Building2 className=\"w-6 h-6 text-emerald-600\" />\n                      <CardTitle>Companies</CardTitle>\n                    </div>\n                    <Badge variant=\"secondary\">Admin</Badge>\n                  </div>\n                  <CardDescription>\n                    Manage contractor companies with contact and billing details.\n                  </CardDescription>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"space-y-2 mb-4\">\n                    <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                      <Building2 className=\"w-4 h-4 mr-2\" />\n                      Company profiles\n                    </div>\n                    <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                      <FileText className=\"w-4 h-4 mr-2\" />\n                      Contact & billing info\n                    </div>\n                    <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                      <CheckCircle className=\"w-4 h-4 mr-2\" />\n                      UTILITY role only\n                    </div>\n                  </div>\n                  <Link href=\"/companies\">\n                    <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-open-companies\">\n                      Manage Companies\n                      <ArrowRight className=\"w-4 h-4 ml-2\" />\n                    </Button>\n                  </Link>\n                </CardContent>\n              </Card>\n            )}\n          </div>\n        </div>\n\n        {/* Legacy Tools Section */}\n        <div>\n          <div className=\"flex items-center mb-6\">\n            <MapPin className=\"w-6 h-6 text-gray-600 mr-2\" />\n            <h3 className=\"text-2xl font-bold text-gray-900 dark:text-white\">Resource Analysis Tools</h3>\n          </div>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6\">\n            {/* Map Analysis Card */}\n            <Card className=\"border-2 border-blue-100 dark:border-blue-800\" data-testid=\"card-map\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-2\">\n                    <MapPin className=\"w-6 h-6 text-blue-600\" />\n                    <CardTitle>Map Analysis</CardTitle>\n                  </div>\n                  <Badge variant=\"outline\">Tool</Badge>\n                </div>\n                <CardDescription>\n                  Interactive map for resource location and distance calculations.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2 mb-4\">\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <Clock className=\"w-4 h-4 mr-2\" />\n                    Real-time distance calculations\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <FileText className=\"w-4 h-4 mr-2\" />\n                    Export to Excel/CSV\n                  </div>\n                </div>\n                <Link href=\"/map\">\n                  <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-open-map\">\n                    Open Map Analysis\n                    <ArrowRight className=\"w-4 h-4 ml-2\" />\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n\n            {/* Contractors Card */}\n            <Card className=\"border-2 border-purple-100 dark:border-purple-800\" data-testid=\"card-contractors\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Users className=\"w-6 h-6 text-purple-600\" />\n                    <CardTitle>Contractor Database</CardTitle>\n                  </div>\n                  <Badge variant=\"outline\">Tool</Badge>\n                </div>\n                <CardDescription>\n                  Manage contractor profiles with ratings and documents.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2 mb-4\">\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <Users className=\"w-4 h-4 mr-2\" />\n                    5-star rating system\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <FileText className=\"w-4 h-4 mr-2\" />\n                    Document management\n                  </div>\n                </div>\n                <Link href=\"/contractors\">\n                  <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-open-contractors\">\n                    Manage Contractors\n                    <ArrowRight className=\"w-4 h-4 ml-2\" />\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n\n            {/* Availability Card */}\n            <Card className=\"border-2 border-green-100 dark:border-green-800\" data-testid=\"card-availability\">\n              <CardHeader>\n                <div className=\"flex items-center justify-between\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Calendar className=\"w-6 h-6 text-green-600\" />\n                    <CardTitle>Availability Tracking</CardTitle>\n                  </div>\n                  <Badge variant=\"outline\">Tool</Badge>\n                </div>\n                <CardDescription>\n                  Collect and track contractor crew and equipment availability.\n                </CardDescription>\n              </CardHeader>\n              <CardContent>\n                <div className=\"space-y-2 mb-4\">\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <Calendar className=\"w-4 h-4 mr-2\" />\n                    Bulk FTE file uploads\n                  </div>\n                  <div className=\"flex items-center text-sm text-gray-600 dark:text-gray-300\">\n                    <Users className=\"w-4 h-4 mr-2\" />\n                    Crew composition tracking\n                  </div>\n                </div>\n                <Link href=\"/availability\">\n                  <Button variant=\"outline\" className=\"w-full\" data-testid=\"button-open-availability\">\n                    Manage Availability\n                    <ArrowRight className=\"w-4 h-4 ml-2\" />\n                  </Button>\n                </Link>\n              </CardContent>\n            </Card>\n          </div>\n        </div>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":25454,"size_tokens":null},"server/services/availabilityParser.ts":{"content":"import * as XLSX from 'xlsx';\nimport * as Papa from 'papaparse';\nimport type { InsertCrewAvailability, InsertEquipmentAvailability } from '@shared/schema';\n\nexport interface FTERow {\n  contractor: string;\n  category: string;\n  avetta: string;\n  email: string;\n  phone: string;\n  birdRep: string;\n  location: string;\n  fte: string;\n  bucket: string;\n  digger: string;\n  pickup: string;\n  bym: string;\n  travelTimeDetroit?: string;\n  travelTimeColumbus?: string;\n  travelTimeCanton?: string;\n  travelTimeJackson?: string;\n  travelTimeRye?: string;\n}\n\nexport interface ParsedAvailabilityData {\n  crewAvailability: Omit<InsertCrewAvailability, 'contractorId'>;\n  equipmentAvailability: Omit<InsertEquipmentAvailability, 'contractorId' | 'crewAvailabilityId'>[];\n}\n\nexport async function parseFTEFile(filePath: string): Promise<FTERow[]> {\n  const extension = filePath.split('.').pop()?.toLowerCase();\n  \n  if (extension === 'xlsx' || extension === 'xls') {\n    return parseExcelFTE(filePath);\n  } else if (extension === 'csv') {\n    return parseCSVFTE(filePath);\n  } else {\n    throw new Error('Unsupported file format. Please use CSV or Excel files.');\n  }\n}\n\nexport async function parseExcelFTE(filePath: string): Promise<FTERow[]> {\n  const workbook = XLSX.readFile(filePath);\n  const sheetName = workbook.SheetNames[0];\n  const worksheet = workbook.Sheets[sheetName];\n  const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });\n  \n  if (jsonData.length < 2) {\n    throw new Error('File must contain at least a header row and one data row');\n  }\n  \n  const headers = jsonData[0] as string[];\n  const rows = jsonData.slice(1) as any[][];\n  \n  return rows.map((row, index) => {\n    const rowObj: any = {};\n    headers.forEach((header, headerIndex) => {\n      const normalizedHeader = normalizeHeader(header);\n      rowObj[normalizedHeader] = row[headerIndex]?.toString().trim() || '';\n    });\n    \n    return mapToFTERow(rowObj, index);\n  }).filter(row => row.contractor && row.contractor.trim() !== '');\n}\n\nexport async function parseCSVFTE(filePath: string): Promise<FTERow[]> {\n  const fs = require('fs');\n  const fileContent = fs.readFileSync(filePath, 'utf8');\n  \n  return new Promise((resolve, reject) => {\n    Papa.parse(fileContent, {\n      header: true,\n      skipEmptyLines: true,\n      transformHeader: (header: string) => normalizeHeader(header),\n      complete: (results) => {\n        try {\n          const fteRows = results.data.map((row: any, index: number) => mapToFTERow(row, index))\n            .filter((row: FTERow) => row.contractor && row.contractor.trim() !== '');\n          resolve(fteRows);\n        } catch (error) {\n          reject(error);\n        }\n      },\n      error: (error) => reject(error)\n    });\n  });\n}\n\nfunction normalizeHeader(header: string): string {\n  const normalized = header.toLowerCase().trim()\n    .replace(/\\s+/g, '')\n    .replace(/[^\\w]/g, '');\n  \n  // Map common variations to standard field names\n  const headerMappings: { [key: string]: string } = {\n    'contractor': 'contractor',\n    'company': 'contractor',\n    'name': 'contractor',\n    'category': 'category',\n    'type': 'category',\n    'avetta': 'avetta',\n    'email': 'email',\n    'emailaddress': 'email',\n    'phone': 'phone',\n    'phonenumber': 'phone',\n    'birdrep': 'birdRep',\n    'rep': 'birdRep',\n    'representative': 'birdRep',\n    'location': 'location',\n    'city': 'city',\n    'state': 'state',\n    'address': 'location',\n    'fte': 'fte',\n    'ftecount': 'fte',\n    'headcount': 'fte',\n    'crew': 'fte',\n    'bucket': 'bucket',\n    'buckettrucks': 'bucket',\n    'buckets': 'bucket',\n    'digger': 'digger',\n    'diggers': 'digger',\n    'pickup': 'pickup',\n    'pickups': 'pickup',\n    'trucks': 'pickup',\n    'bym': 'bym',\n    'byrmilesyard': 'bym',\n    'traveltimetodetroitmi': 'travelTimeDetroit',\n    'detroittime': 'travelTimeDetroit',\n    'traveltimetocolumbusoh': 'travelTimeColumbus',\n    'columbustime': 'travelTimeColumbus',\n    'traveltimetocantonpa': 'travelTimeCanton',\n    'cantontime': 'travelTimeCanton',\n    'traveltimetojacksonms': 'travelTimeJackson',\n    'jacksontime': 'travelTimeJackson',\n    'traveltimetoryeny': 'travelTimeRye',\n    'ryetime': 'travelTimeRye'\n  };\n  \n  return headerMappings[normalized] || normalized;\n}\n\nfunction mapToFTERow(rowObj: any, index: number): FTERow {\n  // Support both new format (city, state) and legacy format (location)\n  let location = '';\n  if (rowObj.city && rowObj.state) {\n    location = `${rowObj.city}, ${rowObj.state}`;\n  } else if (rowObj.location) {\n    location = rowObj.location;\n  }\n  \n  return {\n    contractor: rowObj.contractor || '',\n    category: rowObj.category || '',\n    avetta: rowObj.avetta || '',\n    email: rowObj.email || '',\n    phone: rowObj.phone || '',\n    birdRep: rowObj.birdRep || '',\n    location,\n    fte: rowObj.fte || '0',\n    bucket: rowObj.bucket || '0',\n    digger: rowObj.digger || '0',\n    pickup: rowObj.pickup || '0',\n    bym: rowObj.bym || '0',\n    travelTimeDetroit: rowObj.travelTimeDetroit || '',\n    travelTimeColumbus: rowObj.travelTimeColumbus || '',\n    travelTimeCanton: rowObj.travelTimeCanton || '',\n    travelTimeJackson: rowObj.travelTimeJackson || '',\n    travelTimeRye: rowObj.travelTimeRye || ''\n  };\n}\n\nexport function convertFTEToAvailabilityData(fteRow: FTERow, contractorId: number, availableStartDate: Date, submittedBy: string): ParsedAvailabilityData {\n  const fteCount = parseInt(fteRow.fte) || 0;\n  \n  // Parse location into city and state\n  let city = '';\n  let state = '';\n  if (fteRow.location) {\n    const parts = fteRow.location.split(',').map(p => p.trim());\n    if (parts.length >= 2) {\n      city = parts[0];\n      state = parts[1];\n    } else if (parts.length === 1) {\n      city = parts[0];\n    }\n  }\n  \n  // Create crew availability record\n  const crewAvailability: Omit<InsertCrewAvailability, 'contractorId'> = {\n    submissionDate: new Date(),\n    availableStartDate,\n    availableEndDate: undefined, // Can be set later\n    departureCity: city || undefined,\n    departureState: state || undefined,\n    departureLocation: fteRow.location || '', // Keep for backward compatibility\n    totalFTE: fteCount,\n    buckets: parseInt(fteRow.bucket) || 0,\n    diggers: parseInt(fteRow.digger) || 0,\n    pickups: parseInt(fteRow.pickup) || 0,\n    backyardMachines: parseInt(fteRow.bym) || 0,\n    // Legacy fields for backward compatibility\n    linemenCount: Math.floor(fteCount * 0.6), // Rough estimation\n    groundmenCount: Math.floor(fteCount * 0.4),\n    operatorsCount: 0,\n    foremanCount: fteCount > 5 ? 1 : 0,\n    apprenticesCount: 0,\n    linemenRate: undefined,\n    groundmenRate: undefined,\n    operatorsRate: undefined,\n    foremanRate: undefined,\n    apprenticesRate: undefined,\n    status: 'submitted',\n    notes: `Imported from FTE file. Location: ${fteRow.location}. Original FTE: ${fteRow.fte}`,\n    submittedBy,\n    reviewedBy: undefined,\n    reviewedAt: undefined\n  };\n  \n  // Create equipment availability records\n  const equipmentAvailability: Omit<InsertEquipmentAvailability, 'contractorId' | 'crewAvailabilityId'>[] = [];\n  \n  const bucketCount = parseInt(fteRow.bucket) || 0;\n  if (bucketCount > 0) {\n    equipmentAvailability.push({\n      equipmentType: 'bucket_truck',\n      quantity: bucketCount,\n      specifications: 'Standard bucket truck',\n      dailyRate: undefined,\n      mobilizationCost: undefined,\n      availableStartDate,\n      availableEndDate: undefined,\n      status: 'available',\n      notes: 'Imported from FTE file'\n    });\n  }\n  \n  const diggerCount = parseInt(fteRow.digger) || 0;\n  if (diggerCount > 0) {\n    equipmentAvailability.push({\n      equipmentType: 'digger',\n      quantity: diggerCount,\n      specifications: 'Standard digger/excavator',\n      dailyRate: undefined,\n      mobilizationCost: undefined,\n      availableStartDate,\n      availableEndDate: undefined,\n      status: 'available',\n      notes: 'Imported from FTE file'\n    });\n  }\n  \n  const pickupCount = parseInt(fteRow.pickup) || 0;\n  if (pickupCount > 0) {\n    equipmentAvailability.push({\n      equipmentType: 'pickup_truck',\n      quantity: pickupCount,\n      specifications: 'Standard pickup truck',\n      dailyRate: undefined,\n      mobilizationCost: undefined,\n      availableStartDate,\n      availableEndDate: undefined,\n      status: 'available',\n      notes: 'Imported from FTE file'\n    });\n  }\n  \n  return {\n    crewAvailability,\n    equipmentAvailability\n  };\n}\n\nexport function exportAvailabilityToExcel(availabilityData: any[], filename: string): Buffer {\n  const worksheet = XLSX.utils.json_to_sheet(availabilityData);\n  \n  // Auto-width columns\n  const columnWidths: any[] = [];\n  if (availabilityData.length > 0) {\n    const headers = Object.keys(availabilityData[0]);\n    headers.forEach((header, index) => {\n      let maxWidth = header.length;\n      availabilityData.forEach(row => {\n        const cellValue = String(row[header] || '');\n        maxWidth = Math.max(maxWidth, cellValue.length);\n      });\n      columnWidths[index] = { wch: Math.min(maxWidth + 2, 50) };\n    });\n    worksheet['!cols'] = columnWidths;\n  }\n  \n  const workbook = XLSX.utils.book_new();\n  XLSX.utils.book_append_sheet(workbook, worksheet, 'Availability');\n  \n  return XLSX.write(workbook, { type: 'buffer', bookType: 'xlsx' });\n}","path":null,"size_bytes":9304,"size_tokens":null},"client/src/components/ResultsTable.tsx":{"content":"import { useState, useMemo, useEffect } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { Button } from \"@/components/ui/button\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Input } from \"@/components/ui/input\";\nimport { Download, FileSpreadsheet, FileText, ArrowUpDown, ArrowUp, ArrowDown, ChevronDown } from \"lucide-react\";\nimport { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger, DropdownMenuSeparator } from \"@/components/ui/dropdown-menu\";\n\nimport { useToast } from \"@/hooks/use-toast\";\nimport { formatDuration, getMarkerColor, getResourceColor } from \"@/lib/mapUtils\";\nimport type { AnalysisPoint } from \"@shared/schema\";\n\ninterface ResultsTableProps {\n  analysisPoints: AnalysisPoint[];\n  selectedPointId: number | null;\n  onSelectPoint: (id: number | null) => void;\n  maxDistance?: number | null;\n  maxHours?: number | null;\n}\n\nexport default function ResultsTable({ analysisPoints, selectedPointId, onSelectPoint, maxDistance, maxHours }: ResultsTableProps) {\n  const [sortBy, setSortBy] = useState(\"distance\");\n  const [sortOrder, setSortOrder] = useState<\"asc\" | \"desc\">(\"asc\");\n  const [maxDistanceFilter, setMaxDistanceFilter] = useState(\"\");\n  const [maxTimeFilter, setMaxTimeFilter] = useState(\"\");\n  const { toast } = useToast();\n\n  // Sync local filter with external maxDistance prop\n  useEffect(() => {\n    if (maxDistance !== null && maxDistance !== undefined) {\n      setMaxDistanceFilter(maxDistance.toString());\n    }\n  }, [maxDistance]);\n\n  // Fetch calculations for selected point\n  const { data: calculations = [], isLoading } = useQuery({\n    queryKey: [`/api/analysis-points/${selectedPointId}/calculations`],\n    enabled: !!selectedPointId,\n  });\n\n  // Fetch contractors data\n  const { data: contractors = [] } = useQuery({\n    queryKey: [\"/api/contractors\"],\n  });\n\n  // Filter and sort calculations with contractor data\n  const filteredAndSortedCalculations = useMemo(() => {\n    // Join calculations with contractor data\n    let filtered = (calculations as any[]).map((calc: any) => {\n      const contractorId = calc.resource?.properties?.contractorId;\n      const contractor = (contractors as any[]).find((c: any) => c.id === contractorId);\n      return {\n        ...calc,\n        contractor: contractor || {}\n      };\n    });\n\n    // Apply distance filter (prioritize external maxDistance prop, then local filter)\n    const effectiveMaxDistance = maxDistance || (maxDistanceFilter ? parseFloat(maxDistanceFilter) : null);\n    if (effectiveMaxDistance) {\n      filtered = filtered.filter((calc: any) => calc.distance <= effectiveMaxDistance);\n    }\n\n    // Apply hours filter (driving time at 55mph)\n    if (maxHours) {\n      filtered = filtered.filter((calc: any) => {\n        const hoursToDestination = calc.distance / 55; // 55 mph average speed\n        return hoursToDestination <= maxHours;\n      });\n    }\n\n    // Apply time filter (convert minutes to seconds)\n    if (maxTimeFilter) {\n      const maxTime = parseFloat(maxTimeFilter) * 60;\n      filtered = filtered.filter((calc: any) => calc.duration <= maxTime);\n    }\n\n    // Sort calculations\n    const sorted = [...filtered].sort((a: any, b: any) => {\n      let aValue, bValue;\n\n      switch (sortBy) {\n        case \"name\":\n          aValue = a.contractor?.name || \"\";\n          bValue = b.contractor?.name || \"\";\n          break;\n        case \"company\":\n          aValue = a.contractor?.company || \"\";\n          bValue = b.contractor?.company || \"\";\n          break;\n        case \"category\":\n          aValue = a.contractor?.category || \"\";\n          bValue = b.contractor?.category || \"\";\n          break;\n        case \"pipefile\":\n          aValue = a.contractor?.pipefile || \"\";\n          bValue = b.contractor?.pipefile || \"\";\n          break;\n        case \"avetta\":\n          aValue = a.contractor?.avetta || \"\";\n          bValue = b.contractor?.avetta || \"\";\n          break;\n        case \"city\":\n          aValue = a.contractor?.city || \"\";\n          bValue = b.contractor?.city || \"\";\n          break;\n        case \"state\":\n          aValue = a.contractor?.state || \"\";\n          bValue = b.contractor?.state || \"\";\n          break;\n        case \"fullAddress\":\n          aValue = a.contractor?.fullAddress || \"\";\n          bValue = b.contractor?.fullAddress || \"\";\n          break;\n        case \"latitude\":\n          aValue = a.contractor?.latitude || 0;\n          bValue = b.contractor?.latitude || 0;\n          break;\n        case \"longitude\":\n          aValue = a.contractor?.longitude || 0;\n          bValue = b.contractor?.longitude || 0;\n          break;\n        case \"phone\":\n          aValue = a.contractor?.phone || \"\";\n          bValue = b.contractor?.phone || \"\";\n          break;\n        case \"email\":\n          aValue = a.contractor?.email || \"\";\n          bValue = b.contractor?.email || \"\";\n          break;\n        case \"birdRep\":\n          aValue = a.contractor?.birdRep || \"\";\n          bValue = b.contractor?.birdRep || \"\";\n          break;\n        case \"subRanking\":\n          aValue = a.contractor?.subRanking || \"\";\n          bValue = b.contractor?.subRanking || \"\";\n          break;\n        case \"fteCountsPerLocation\":\n          aValue = a.contractor?.fteCountsPerLocation || \"\";\n          bValue = b.contractor?.fteCountsPerLocation || \"\";\n          break;\n        case \"pipefileUpdates\":\n          aValue = a.contractor?.pipefileUpdates || \"\";\n          bValue = b.contractor?.pipefileUpdates || \"\";\n          break;\n        case \"notes\":\n          aValue = a.contractor?.notes || \"\";\n          bValue = b.contractor?.notes || \"\";\n          break;\n        case \"newMsaComplete\":\n          aValue = a.contractor?.newMsaComplete || \"\";\n          bValue = b.contractor?.newMsaComplete || \"\";\n          break;\n        case \"rating\":\n          aValue = a.contractor?.rating || 0;\n          bValue = b.contractor?.rating || 0;\n          break;\n        case \"distance\":\n          aValue = a.distance || 0;\n          bValue = b.distance || 0;\n          break;\n        case \"duration\":\n          aValue = a.duration || 0;\n          bValue = b.duration || 0;\n          break;\n        default:\n          aValue = a.distance || 0;\n          bValue = b.distance || 0;\n      }\n\n      if (typeof aValue === \"string\") {\n        return sortOrder === \"asc\" \n          ? aValue.localeCompare(bValue)\n          : bValue.localeCompare(aValue);\n      } else {\n        return sortOrder === \"asc\" ? aValue - bValue : bValue - aValue;\n      }\n    });\n\n    return sorted;\n  }, [calculations, maxDistanceFilter, maxTimeFilter, sortBy, sortOrder]);\n\n  const handleSort = (column: string) => {\n    if (sortBy === column) {\n      setSortOrder(sortOrder === \"asc\" ? \"desc\" : \"asc\");\n    } else {\n      setSortBy(column);\n      setSortOrder(\"asc\");\n    }\n  };\n\n  const getSortIcon = (column: string) => {\n    if (sortBy !== column) return <ArrowUpDown className=\"h-4 w-4\" />;\n    return sortOrder === \"asc\" ? <ArrowUp className=\"h-4 w-4\" /> : <ArrowDown className=\"h-4 w-4\" />;\n  };\n\n  const handleExportExcel = async () => {\n    try {\n      // Build query parameters for filtering\n      const params = new URLSearchParams({ format: 'excel' });\n      const effectiveMaxDistance = maxDistance || (maxDistanceFilter ? parseFloat(maxDistanceFilter) : null);\n      if (effectiveMaxDistance) {\n        params.append('maxDistance', effectiveMaxDistance.toString());\n      }\n      if (maxTimeFilter) {\n        params.append('maxTime', maxTimeFilter);\n      }\n      \n      const response = await fetch(`/api/analysis-points/${selectedPointId}/calculations/export?${params.toString()}`);\n      if (!response.ok) throw new Error('Export failed');\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `analysis-results-${selectedPointId}.xlsx`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      window.URL.revokeObjectURL(url);\n      \n      toast({\n        title: \"Export Complete\",\n        description: \"Excel file has been downloaded successfully.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Could not export to Excel. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleExportCSV = async () => {\n    try {\n      // Build query parameters for filtering\n      const params = new URLSearchParams({ format: 'csv' });\n      const effectiveMaxDistance = maxDistance || (maxDistanceFilter ? parseFloat(maxDistanceFilter) : null);\n      if (effectiveMaxDistance) {\n        params.append('maxDistance', effectiveMaxDistance.toString());\n      }\n      if (maxTimeFilter) {\n        params.append('maxTime', maxTimeFilter);\n      }\n      \n      const response = await fetch(`/api/analysis-points/${selectedPointId}/calculations/export?${params.toString()}`);\n      if (!response.ok) throw new Error('Export failed');\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `analysis-results-${selectedPointId}.csv`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      window.URL.revokeObjectURL(url);\n      \n      toast({\n        title: \"Export Complete\",\n        description: \"CSV file has been downloaded successfully.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Could not export to CSV. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleExportCSVByBirdRep = async () => {\n    try {\n      // Build query parameters for filtering and Bird Rep grouping\n      const params = new URLSearchParams({ format: 'csv', groupByBirdRep: 'true' });\n      const effectiveMaxDistance = maxDistance || (maxDistanceFilter ? parseFloat(maxDistanceFilter) : null);\n      if (effectiveMaxDistance) {\n        params.append('maxDistance', effectiveMaxDistance.toString());\n      }\n      if (maxTimeFilter) {\n        params.append('maxTime', maxTimeFilter);\n      }\n      \n      const response = await fetch(`/api/analysis-points/${selectedPointId}/calculations/export?${params.toString()}`);\n      if (!response.ok) throw new Error('Export failed');\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `analysis-results-by-bird-rep-${selectedPointId}.zip`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      window.URL.revokeObjectURL(url);\n      \n      toast({\n        title: \"Export Complete\",\n        description: \"ZIP file with separate CSV files for each Bird Rep has been downloaded.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Could not export CSV files by Bird Rep. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const handleExportWebEOC = async () => {\n    try {\n      // Build query parameters for filtering\n      const params = new URLSearchParams({ format: 'webeoc' });\n      const effectiveMaxDistance = maxDistance || (maxDistanceFilter ? parseFloat(maxDistanceFilter) : null);\n      if (effectiveMaxDistance) {\n        params.append('maxDistance', effectiveMaxDistance.toString());\n      }\n      if (maxTimeFilter) {\n        params.append('maxTime', maxTimeFilter);\n      }\n      \n      const response = await fetch(`/api/analysis-points/${selectedPointId}/calculations/export?${params.toString()}`);\n      if (!response.ok) throw new Error('Export failed');\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const link = document.createElement('a');\n      link.href = url;\n      link.download = `webeoc-contacts-${selectedPointId}.csv`;\n      document.body.appendChild(link);\n      link.click();\n      document.body.removeChild(link);\n      window.URL.revokeObjectURL(url);\n      \n      toast({\n        title: \"Export Complete\",\n        description: \"WebEOC Contact CSV file has been downloaded.\",\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Could not export WebEOC contacts. Please try again.\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const selectedPoint = analysisPoints.find(p => p.id === selectedPointId);\n\n  if (!selectedPointId) {\n    return (\n      <Card className=\"h-full\">\n        <CardContent className=\"p-8 text-center\">\n          <p className=\"text-gray-500\">Select an analysis point to view distance calculations.</p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  if (isLoading) {\n    return (\n      <Card className=\"h-full\">\n        <CardContent className=\"p-8 text-center\">\n          <p className=\"text-gray-500\">Loading calculations...</p>\n        </CardContent>\n      </Card>\n    );\n  }\n\n  return (\n    <Card className=\"h-full flex flex-col\">\n      <CardHeader className=\"pb-4\">\n        <div className=\"flex flex-col sm:flex-row sm:items-center justify-between gap-4\">\n          <div>\n            <CardTitle className=\"text-lg\">Distance Analysis Results</CardTitle>\n            <p className=\"text-sm text-gray-600 mt-1\">\n              {selectedPoint?.label} - {filteredAndSortedCalculations.length} of {(calculations as any[]).length} resources shown\n            </p>\n          </div>\n          \n          {/* Analysis Point Selector */}\n          <Select value={selectedPointId?.toString() || \"\"} onValueChange={(value) => onSelectPoint(parseInt(value))}>\n            <SelectTrigger className=\"w-48\">\n              <SelectValue placeholder=\"Select analysis point\" />\n            </SelectTrigger>\n            <SelectContent>\n              {analysisPoints.map(point => (\n                <SelectItem key={point.id} value={point.id.toString()}>\n                  {point.label}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n\n        {/* Filters and Export */}\n        <div className=\"flex flex-col sm:flex-row gap-4 mt-4\">\n          <div className=\"flex gap-2 flex-1\">\n            <div className=\"flex-1\">\n              <label className=\"text-xs text-gray-600 mb-1 block\">Max Distance (miles)</label>\n              <Input\n                type=\"number\"\n                placeholder=\"25\"\n                value={maxDistanceFilter}\n                onChange={(e) => setMaxDistanceFilter(e.target.value)}\n                className=\"h-8\"\n              />\n            </div>\n            <div className=\"flex-1\">\n              <label className=\"text-xs text-gray-600 mb-1 block\">Max Drive Time (minutes)</label>\n              <Input\n                type=\"number\"\n                placeholder=\"30\"\n                value={maxTimeFilter}\n                onChange={(e) => setMaxTimeFilter(e.target.value)}\n                className=\"h-8\"\n              />\n            </div>\n          </div>\n          \n          <div className=\"flex gap-2\">\n            {/* Excel Export Dropdown */}\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button size=\"sm\" variant=\"outline\">\n                  <FileSpreadsheet className=\"h-4 w-4 mr-1\" />\n                  Excel\n                  <ChevronDown className=\"h-3 w-3 ml-1\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                <DropdownMenuItem onClick={handleExportExcel}>\n                  <FileSpreadsheet className=\"h-4 w-4 mr-2\" />\n                  Excel (Bird Rep Pages)\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n\n            {/* CSV Export Dropdown */}\n            <DropdownMenu>\n              <DropdownMenuTrigger asChild>\n                <Button size=\"sm\" variant=\"outline\">\n                  <FileText className=\"h-4 w-4 mr-1\" />\n                  CSV\n                  <ChevronDown className=\"h-3 w-3 ml-1\" />\n                </Button>\n              </DropdownMenuTrigger>\n              <DropdownMenuContent align=\"end\">\n                <DropdownMenuItem onClick={handleExportCSV}>\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                  Single CSV File\n                </DropdownMenuItem>\n                <DropdownMenuSeparator />\n                <DropdownMenuItem onClick={handleExportCSVByBirdRep}>\n                  <Download className=\"h-4 w-4 mr-2\" />\n                  ZIP with Bird Rep Files\n                </DropdownMenuItem>\n                <DropdownMenuSeparator />\n                <DropdownMenuItem onClick={handleExportWebEOC} data-testid=\"export-webeoc\">\n                  <FileText className=\"h-4 w-4 mr-2\" />\n                  WebEOC Contact Export\n                </DropdownMenuItem>\n              </DropdownMenuContent>\n            </DropdownMenu>\n          </div>\n        </div>\n      </CardHeader>\n\n      <CardContent className=\"flex-1 overflow-hidden p-0\">\n        {/* Mobile Card Layout */}\n        <div className=\"block md:hidden overflow-auto h-full max-h-[calc(100vh-300px)] p-4 space-y-3\">\n          {filteredAndSortedCalculations.length === 0 ? (\n            <p className=\"text-center text-gray-500 py-8\">No calculations found</p>\n          ) : (\n            filteredAndSortedCalculations.map((calc: any) => (\n              <Card key={calc.id} className=\"border-l-4\" style={{ borderLeftColor: getResourceColor(calc.contractor?.category || calc.resource.type) }}>\n                <CardContent className=\"p-4\">\n                  <div className=\"flex justify-between items-start mb-2\">\n                    <h3 className=\"font-semibold text-sm\">{calc.contractor?.name || 'Unknown Contractor'}</h3>\n                    <div className=\"flex items-center gap-2\">\n                      <Badge variant=\"outline\" className=\"text-xs\">\n                        {calc.distance?.toFixed(1)} mi\n                      </Badge>\n                      <Badge variant=\"secondary\" className=\"text-xs\">\n                        {formatDuration(calc.duration)}\n                      </Badge>\n                    </div>\n                  </div>\n                  <div className=\"grid grid-cols-2 gap-2 text-xs text-gray-600\">\n                    <div><span className=\"font-medium\">MSA Status:</span> {calc.contractor?.newMsaComplete || 'N/A'}</div>\n                    <div><span className=\"font-medium\">Company:</span> {calc.contractor?.company || 'N/A'}</div>\n                    <div><span className=\"font-medium\">Category:</span> {calc.contractor?.category || 'N/A'}</div>\n                    <div><span className=\"font-medium\">SUB Ranking:</span> {calc.contractor?.subRanking || 'N/A'}</div>\n                    <div><span className=\"font-medium\">City:</span> {calc.contractor?.city || 'N/A'}</div>\n                    <div><span className=\"font-medium\">State:</span> {calc.contractor?.state || 'N/A'}</div>\n                    <div><span className=\"font-medium\">Pipefile:</span> {calc.contractor?.pipefile || 'N/A'}</div>\n                    <div><span className=\"font-medium\">AVETTA:</span> {calc.contractor?.avetta || 'N/A'}</div>\n                  </div>\n                </CardContent>\n              </Card>\n            ))\n          )}\n        </div>\n\n        {/* Desktop Table Layout */}\n        <div className=\"hidden md:block border rounded-lg overflow-auto h-full max-h-[calc(100vh-300px)]\">\n          <Table className=\"relative\">\n            <TableHeader className=\"sticky top-0 bg-white z-10\">\n              <TableRow>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"name\")}\n                    className=\"font-semibold\"\n                  >\n                    Contractor Name {getSortIcon(\"name\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"newMsaComplete\")}\n                    className=\"font-semibold\"\n                  >\n                    MSA Status {getSortIcon(\"newMsaComplete\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"distance\")}\n                    className=\"font-semibold\"\n                  >\n                    Distance (mi) {getSortIcon(\"distance\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"duration\")}\n                    className=\"font-semibold\"\n                  >\n                    Drive Time {getSortIcon(\"duration\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"company\")}\n                    className=\"font-semibold\"\n                  >\n                    Company {getSortIcon(\"company\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"category\")}\n                    className=\"font-semibold\"\n                  >\n                    Category {getSortIcon(\"category\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"pipefile\")}\n                    className=\"font-semibold\"\n                  >\n                    Pipefile {getSortIcon(\"pipefile\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"avetta\")}\n                    className=\"font-semibold\"\n                  >\n                    AVETTA {getSortIcon(\"avetta\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"city\")}\n                    className=\"font-semibold\"\n                  >\n                    City {getSortIcon(\"city\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"state\")}\n                    className=\"font-semibold\"\n                  >\n                    State {getSortIcon(\"state\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"fullAddress\")}\n                    className=\"font-semibold\"\n                  >\n                    Full Address {getSortIcon(\"fullAddress\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"latitude\")}\n                    className=\"font-semibold\"\n                  >\n                    Latitude {getSortIcon(\"latitude\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"longitude\")}\n                    className=\"font-semibold\"\n                  >\n                    Longitude {getSortIcon(\"longitude\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"phone\")}\n                    className=\"font-semibold\"\n                  >\n                    Phone {getSortIcon(\"phone\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"email\")}\n                    className=\"font-semibold\"\n                  >\n                    Email {getSortIcon(\"email\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"birdRep\")}\n                    className=\"font-semibold\"\n                  >\n                    BIRD REP {getSortIcon(\"birdRep\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"subRanking\")}\n                    className=\"font-semibold\"\n                  >\n                    SUB Ranking {getSortIcon(\"subRanking\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"fteCountsPerLocation\")}\n                    className=\"font-semibold\"\n                  >\n                    FTE Counts {getSortIcon(\"fteCountsPerLocation\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"pipefileUpdates\")}\n                    className=\"font-semibold\"\n                  >\n                    Pipefile Updates {getSortIcon(\"pipefileUpdates\")}\n                  </Button>\n                </TableHead>\n                <TableHead>\n                  <Button\n                    variant=\"ghost\"\n                    size=\"sm\"\n                    onClick={() => handleSort(\"notes\")}\n                    className=\"font-semibold\"\n                  >\n                    Notes {getSortIcon(\"notes\")}\n                  </Button>\n                </TableHead>\n              </TableRow>\n            </TableHeader>\n            <TableBody>\n              {filteredAndSortedCalculations.length === 0 ? (\n                <TableRow>\n                  <TableCell colSpan={20} className=\"text-center py-8 text-gray-500\">\n                    No resources found within the specified criteria.\n                  </TableCell>\n                </TableRow>\n              ) : (\n                filteredAndSortedCalculations.map((calc: any) => {\n                  return (\n                    <TableRow key={calc.id} className=\"hover:bg-gray-50\">\n                      \n                      <TableCell className=\"font-medium\">\n                        <div className=\"flex items-center gap-2\">\n                          <div\n                            className=\"w-3 h-3 rounded-full\"\n                            style={{ backgroundColor: getResourceColor(calc.contractor?.category || calc.resource.type) }}\n                          />\n                          {calc.contractor?.name || 'Unknown'}\n                        </div>\n                      </TableCell>\n                      \n                      <TableCell className=\"text-sm\">\n                        {calc.contractor?.newMsaComplete ? (\n                          <Badge variant=\"default\">\n                            {calc.contractor.newMsaComplete}\n                          </Badge>\n                        ) : (\n                          '-'\n                        )}\n                      </TableCell>\n                      \n                      <TableCell className=\"font-mono\">\n                        {calc.distance ? calc.distance.toFixed(1) : '0.0'}\n                      </TableCell>\n                      \n                      <TableCell className=\"font-mono\">\n                        {formatDuration(calc.duration || 0)}\n                      </TableCell>\n                      <TableCell className=\"font-medium\">\n                        {calc.contractor?.company || '-'}\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant=\"outline\">\n                          {calc.contractor?.category || calc.resource?.type || 'Unknown'}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant={calc.contractor?.pipefile === 'Completed' ? 'default' : 'secondary'}>\n                          {calc.contractor?.pipefile || '-'}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        <Badge variant={calc.contractor?.avetta === 'Yes' ? 'default' : 'outline'}>\n                          {calc.contractor?.avetta || '-'}\n                        </Badge>\n                      </TableCell>\n                      <TableCell>\n                        {calc.contractor?.city || '-'}\n                      </TableCell>\n                      <TableCell>\n                        {calc.contractor?.state || '-'}\n                      </TableCell>\n                      <TableCell className=\"text-sm max-w-xs truncate\" title={calc.contractor?.fullAddress}>\n                        {calc.contractor?.fullAddress || '-'}\n                      </TableCell>\n                      <TableCell className=\"text-sm font-mono\">\n                        {calc.contractor?.latitude ? calc.contractor.latitude.toFixed(6) : '-'}\n                      </TableCell>\n                      <TableCell className=\"text-sm font-mono\">\n                        {calc.contractor?.longitude ? calc.contractor.longitude.toFixed(6) : '-'}\n                      </TableCell>\n                      <TableCell className=\"text-sm\">\n                        {calc.contractor?.phone || '-'}\n                      </TableCell>\n                      <TableCell className=\"text-sm\">\n                        {calc.contractor?.email || '-'}\n                      </TableCell>\n                      <TableCell className=\"text-sm\">\n                        {calc.contractor?.birdRep || '-'}\n                      </TableCell>\n                      <TableCell className=\"text-sm\">\n                        {calc.contractor?.subRanking || '-'}\n                      </TableCell>\n                      <TableCell className=\"text-sm\">\n                        {calc.contractor?.fteCountsPerLocation || '-'}\n                      </TableCell>\n                      <TableCell className=\"text-sm max-w-xs truncate\" title={calc.contractor?.pipefileUpdates}>\n                        {calc.contractor?.pipefileUpdates || '-'}\n                      </TableCell>\n                      <TableCell className=\"text-sm max-w-xs truncate\" title={calc.contractor?.notes}>\n                        {calc.contractor?.notes || '-'}\n                      </TableCell>\n                    </TableRow>\n                  );\n                })\n              )}\n            </TableBody>\n          </Table>\n        </div>\n      </CardContent>\n    </Card>\n  );\n}","path":null,"size_bytes":32199,"size_tokens":null},"vite.config.ts":{"content":"import { defineConfig } from \"vite\";\nimport react from \"@vitejs/plugin-react\";\nimport path from \"path\";\nimport runtimeErrorOverlay from \"@replit/vite-plugin-runtime-error-modal\";\n\nexport default defineConfig({\n  plugins: [\n    react(),\n    runtimeErrorOverlay(),\n    ...(process.env.NODE_ENV !== \"production\" &&\n    process.env.REPL_ID !== undefined\n      ? [\n          await import(\"@replit/vite-plugin-cartographer\").then((m) =>\n            m.cartographer(),\n          ),\n        ]\n      : []),\n  ],\n  resolve: {\n    alias: {\n      \"@\": path.resolve(import.meta.dirname, \"client\", \"src\"),\n      \"@shared\": path.resolve(import.meta.dirname, \"shared\"),\n      \"@assets\": path.resolve(import.meta.dirname, \"attached_assets\"),\n    },\n  },\n  root: path.resolve(import.meta.dirname, \"client\"),\n  build: {\n    outDir: path.resolve(import.meta.dirname, \"dist/public\"),\n    emptyOutDir: true,\n  },\n  server: {\n    fs: {\n      strict: true,\n      deny: [\"**/.*\"],\n    },\n  },\n});\n","path":null,"size_bytes":971,"size_tokens":null},"client/src/components/ui/calendar.tsx":{"content":"import * as React from \"react\"\nimport { ChevronLeft, ChevronRight } from \"lucide-react\"\nimport { DayPicker } from \"react-day-picker\"\n\nimport { cn } from \"@/lib/utils\"\nimport { buttonVariants } from \"@/components/ui/button\"\n\nexport type CalendarProps = React.ComponentProps<typeof DayPicker>\n\nfunction Calendar({\n  className,\n  classNames,\n  showOutsideDays = true,\n  ...props\n}: CalendarProps) {\n  return (\n    <DayPicker\n      showOutsideDays={showOutsideDays}\n      className={cn(\"p-3\", className)}\n      classNames={{\n        months: \"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0\",\n        month: \"space-y-4\",\n        caption: \"flex justify-center pt-1 relative items-center\",\n        caption_label: \"text-sm font-medium\",\n        nav: \"space-x-1 flex items-center\",\n        nav_button: cn(\n          buttonVariants({ variant: \"outline\" }),\n          \"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100\"\n        ),\n        nav_button_previous: \"absolute left-1\",\n        nav_button_next: \"absolute right-1\",\n        table: \"w-full border-collapse space-y-1\",\n        head_row: \"flex\",\n        head_cell:\n          \"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]\",\n        row: \"flex w-full mt-2\",\n        cell: \"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20\",\n        day: cn(\n          buttonVariants({ variant: \"ghost\" }),\n          \"h-9 w-9 p-0 font-normal aria-selected:opacity-100\"\n        ),\n        day_range_end: \"day-range-end\",\n        day_selected:\n          \"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground\",\n        day_today: \"bg-accent text-accent-foreground\",\n        day_outside:\n          \"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground\",\n        day_disabled: \"text-muted-foreground opacity-50\",\n        day_range_middle:\n          \"aria-selected:bg-accent aria-selected:text-accent-foreground\",\n        day_hidden: \"invisible\",\n        ...classNames,\n      }}\n      components={{\n        IconLeft: ({ className, ...props }) => (\n          <ChevronLeft className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n        IconRight: ({ className, ...props }) => (\n          <ChevronRight className={cn(\"h-4 w-4\", className)} {...props} />\n        ),\n      }}\n      {...props}\n    />\n  )\n}\nCalendar.displayName = \"Calendar\"\n\nexport { Calendar }\n","path":null,"size_bytes":2695,"size_tokens":null},"server/db.ts":{"content":"import pg from \"pg\";\nimport { drizzle } from \"drizzle-orm/node-postgres\";\nimport * as schema from \"@shared/schema\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\n    \"DATABASE_URL must be set. Did you forget to provision a database?\",\n  );\n}\n\nexport const pool = new pg.Pool({\n  connectionString: process.env.DATABASE_URL,\n  max: 10,\n  idleTimeoutMillis: 30000,\n  connectionTimeoutMillis: 5000,\n});\n\npool.on('error', (err) => {\n  console.error('Unexpected database pool error:', err);\n});\n\nexport const db = drizzle(pool, { schema });\n","path":null,"size_bytes":542,"size_tokens":null},"client/src/components/ui/select.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SelectPrimitive from \"@radix-ui/react-select\"\nimport { Check, ChevronDown, ChevronUp } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Select = SelectPrimitive.Root\n\nconst SelectGroup = SelectPrimitive.Group\n\nconst SelectValue = SelectPrimitive.Value\n\nconst SelectTrigger = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex h-10 w-full items-center justify-between rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background data-[placeholder]:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <SelectPrimitive.Icon asChild>\n      <ChevronDown className=\"h-4 w-4 opacity-50\" />\n    </SelectPrimitive.Icon>\n  </SelectPrimitive.Trigger>\n))\nSelectTrigger.displayName = SelectPrimitive.Trigger.displayName\n\nconst SelectScrollUpButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollUpButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollUpButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollUpButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronUp className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollUpButton>\n))\nSelectScrollUpButton.displayName = SelectPrimitive.ScrollUpButton.displayName\n\nconst SelectScrollDownButton = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.ScrollDownButton>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.ScrollDownButton>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.ScrollDownButton\n    ref={ref}\n    className={cn(\n      \"flex cursor-default items-center justify-center py-1\",\n      className\n    )}\n    {...props}\n  >\n    <ChevronDown className=\"h-4 w-4\" />\n  </SelectPrimitive.ScrollDownButton>\n))\nSelectScrollDownButton.displayName =\n  SelectPrimitive.ScrollDownButton.displayName\n\nconst SelectContent = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Content>\n>(({ className, children, position = \"popper\", ...props }, ref) => (\n  <SelectPrimitive.Portal>\n    <SelectPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"relative z-50 max-h-[--radix-select-content-available-height] min-w-[8rem] overflow-y-auto overflow-x-hidden rounded-md border bg-popover text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-select-content-transform-origin]\",\n        position === \"popper\" &&\n          \"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1\",\n        className\n      )}\n      position={position}\n      {...props}\n    >\n      <SelectScrollUpButton />\n      <SelectPrimitive.Viewport\n        className={cn(\n          \"p-1\",\n          position === \"popper\" &&\n            \"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]\"\n        )}\n      >\n        {children}\n      </SelectPrimitive.Viewport>\n      <SelectScrollDownButton />\n    </SelectPrimitive.Content>\n  </SelectPrimitive.Portal>\n))\nSelectContent.displayName = SelectPrimitive.Content.displayName\n\nconst SelectLabel = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Label>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Label\n    ref={ref}\n    className={cn(\"py-1.5 pl-8 pr-2 text-sm font-semibold\", className)}\n    {...props}\n  />\n))\nSelectLabel.displayName = SelectPrimitive.Label.displayName\n\nconst SelectItem = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Item>\n>(({ className, children, ...props }, ref) => (\n  <SelectPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <SelectPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </SelectPrimitive.ItemIndicator>\n    </span>\n\n    <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>\n  </SelectPrimitive.Item>\n))\nSelectItem.displayName = SelectPrimitive.Item.displayName\n\nconst SelectSeparator = React.forwardRef<\n  React.ElementRef<typeof SelectPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof SelectPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <SelectPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nSelectSeparator.displayName = SelectPrimitive.Separator.displayName\n\nexport {\n  Select,\n  SelectGroup,\n  SelectValue,\n  SelectTrigger,\n  SelectContent,\n  SelectLabel,\n  SelectItem,\n  SelectSeparator,\n  SelectScrollUpButton,\n  SelectScrollDownButton,\n}\n","path":null,"size_bytes":5742,"size_tokens":null},"client/src/hooks/use-mobile.tsx":{"content":"import * as React from \"react\"\n\nconst MOBILE_BREAKPOINT = 768\n\nexport function useIsMobile() {\n  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(undefined)\n\n  React.useEffect(() => {\n    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`)\n    const onChange = () => {\n      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    }\n    mql.addEventListener(\"change\", onChange)\n    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT)\n    return () => mql.removeEventListener(\"change\", onChange)\n  }, [])\n\n  return !!isMobile\n}\n","path":null,"size_bytes":565,"size_tokens":null},"client/src/components/ui/tooltip.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as TooltipPrimitive from \"@radix-ui/react-tooltip\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst TooltipProvider = TooltipPrimitive.Provider\n\nconst Tooltip = TooltipPrimitive.Root\n\nconst TooltipTrigger = TooltipPrimitive.Trigger\n\nconst TooltipContent = React.forwardRef<\n  React.ElementRef<typeof TooltipPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof TooltipPrimitive.Content>\n>(({ className, sideOffset = 4, ...props }, ref) => (\n  <TooltipPrimitive.Content\n    ref={ref}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-tooltip-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nTooltipContent.displayName = TooltipPrimitive.Content.displayName\n\nexport { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider }\n","path":null,"size_bytes":1209,"size_tokens":null},"client/src/components/ui/button.tsx":{"content":"import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst buttonVariants = cva(\n  \"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n  {\n    variants: {\n      variant: {\n        default: \"bg-primary text-primary-foreground hover:bg-primary/90\",\n        destructive:\n          \"bg-destructive text-destructive-foreground hover:bg-destructive/90\",\n        outline:\n          \"border border-input bg-background hover:bg-accent hover:text-accent-foreground\",\n        secondary:\n          \"bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        ghost: \"hover:bg-accent hover:text-accent-foreground\",\n        link: \"text-primary underline-offset-4 hover:underline\",\n      },\n      size: {\n        default: \"h-10 px-4 py-2\",\n        sm: \"h-9 rounded-md px-3\",\n        lg: \"h-11 rounded-md px-8\",\n        icon: \"h-10 w-10\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n      size: \"default\",\n    },\n  }\n)\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : \"button\"\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nButton.displayName = \"Button\"\n\nexport { Button, buttonVariants }\n","path":null,"size_bytes":1901,"size_tokens":null},"client/src/components/AppHeader.tsx":{"content":"import { Button } from \"@/components/ui/button\";\nimport { Plus, Map, Users, Calendar, Bird, Building2, CloudRain, ClipboardList, Clock, Receipt, FileText, BarChart3, Settings, UserCog, Star, Ticket } from \"lucide-react\";\nimport { Link } from \"wouter\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport { useActiveSession } from \"@/context/ActiveSessionContext\";\nimport { Badge } from \"@/components/ui/badge\";\n\ninterface AppHeaderProps {\n}\n\nexport default function AppHeader({}: AppHeaderProps) {\n  const { user, logout } = useAuth();\n  const { activeSession, isLoading } = useActiveSession();\n  \n  return (\n    <header className=\"fixed top-0 left-0 right-0 z-[99999] bg-white shadow-sm border-b border-gray-200 px-2 sm:px-4 py-2 sm:py-3\">\n      <div className=\"flex items-center justify-between max-w-7xl mx-auto\">\n        <div className=\"flex items-center space-x-2 sm:space-x-3 min-w-0\">\n          <div className=\"w-6 h-6 sm:w-8 sm:h-8 bg-primary rounded-lg flex items-center justify-center flex-shrink-0\">\n            <Bird className=\"text-primary-foreground\" size={12} />\n          </div>\n          <div className=\"flex flex-col min-w-0\">\n            <h1 className=\"text-xs sm:text-lg font-semibold text-gray-900 truncate\">Resource Locator</h1>\n            {(user?.role === 'ADMIN' || user?.role === 'MANAGER' || user?.role === 'UTILITY') && !isLoading && (\n              <div className=\"flex items-center space-x-1 text-xs\">\n                {activeSession ? (\n                  <Badge variant=\"default\" className=\"text-xs py-0 px-1 flex items-center gap-1\" data-testid=\"badge-active-session\">\n                    <Star className=\"w-3 h-3 text-yellow-500 fill-yellow-500\" />\n                    {activeSession.name}\n                  </Badge>\n                ) : (\n                  <Badge variant=\"secondary\" className=\"text-xs py-0 px-1\" data-testid=\"badge-no-session\">\n                    No active session\n                  </Badge>\n                )}\n              </div>\n            )}\n          </div>\n        </div>\n        <div className=\"flex items-center space-x-1 sm:space-x-3\">\n          {/* Mobile Navigation */}\n          <div className=\"flex md:hidden space-x-1 flex-wrap\">\n            <Button variant=\"outline\" size=\"sm\" asChild>\n              <Link href=\"/map\">\n                <Map size={14} />\n              </Link>\n            </Button>\n            <Button variant=\"outline\" size=\"sm\" asChild>\n              <Link href=\"/contractors\">\n                <Users size={14} />\n              </Link>\n            </Button>\n\n            {/* Storm Response - ADMIN, MANAGER, and UTILITY only */}\n            {(user?.role === 'ADMIN' || user?.role === 'MANAGER' || user?.role === 'UTILITY') && (\n              <>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/companies\">\n                    <Building2 size={14} />\n                  </Link>\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/tickets\">\n                    <Ticket size={14} />\n                  </Link>\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/rosters\">\n                    <ClipboardList size={14} />\n                  </Link>\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/timesheets\">\n                    <Clock size={14} />\n                  </Link>\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/invoices\">\n                    <FileText size={14} />\n                  </Link>\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/reports\">\n                    <BarChart3 size={14} />\n                  </Link>\n                </Button>\n              </>\n            )}\n\n            {/* Admin - ADMIN only */}\n            {user?.role === 'ADMIN' && (\n              <Button variant=\"outline\" size=\"sm\" asChild>\n                <Link href=\"/users\">\n                  <Settings size={14} />\n                </Link>\n              </Button>\n            )}\n\n            {/* Access Management - MANAGER only */}\n            {user?.role === 'MANAGER' && (\n              <Button variant=\"outline\" size=\"sm\" asChild>\n                <Link href=\"/access-management\">\n                  <UserCog size={14} />\n                </Link>\n              </Button>\n            )}\n\n            {/* Profile - CONTRACTOR only */}\n            {user?.role === 'CONTRACTOR' && (\n              <Button variant=\"outline\" size=\"sm\" asChild>\n                <Link href=\"/profile\">\n                  <Building2 size={14} />\n                </Link>\n              </Button>\n            )}\n          </div>\n\n          {/* Desktop Navigation */}\n          <div className=\"hidden md:flex items-center space-x-2\">\n            {/* Map & Contractors - visible to all */}\n            <Button variant=\"outline\" size=\"sm\" asChild>\n              <Link href=\"/map\">\n                <Map className=\"mr-1\" size={14} />\n                Map\n              </Link>\n            </Button>\n            <Button variant=\"outline\" size=\"sm\" asChild>\n              <Link href=\"/contractors\">\n                <Users className=\"mr-1\" size={14} />\n                Contractors\n              </Link>\n            </Button>\n\n            {/* Storm Response - ADMIN, MANAGER, and UTILITY only */}\n            {(user?.role === 'ADMIN' || user?.role === 'MANAGER' || user?.role === 'UTILITY') && (\n              <>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/companies\">\n                    <Building2 className=\"mr-1\" size={14} />\n                    Companies\n                  </Link>\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/sessions\">\n                    <CloudRain className=\"mr-1\" size={14} />\n                    Sessions\n                  </Link>\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/tickets\">\n                    <Ticket className=\"mr-1\" size={14} />\n                    Tickets\n                  </Link>\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/rosters\">\n                    <ClipboardList className=\"mr-1\" size={14} />\n                    Rosters\n                  </Link>\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/timesheets\">\n                    <Clock className=\"mr-1\" size={14} />\n                    Timesheets\n                  </Link>\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/expenses\">\n                    <Receipt className=\"mr-1\" size={14} />\n                    Expenses\n                  </Link>\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/invoices\">\n                    <FileText className=\"mr-1\" size={14} />\n                    Invoices\n                  </Link>\n                </Button>\n                <Button variant=\"outline\" size=\"sm\" asChild>\n                  <Link href=\"/reports\">\n                    <BarChart3 className=\"mr-1\" size={14} />\n                    Reports\n                  </Link>\n                </Button>\n              </>\n            )}\n\n            {/* Admin - ADMIN only */}\n            {user?.role === 'ADMIN' && (\n              <Button variant=\"outline\" size=\"sm\" asChild>\n                <Link href=\"/users\">\n                  <Settings className=\"mr-1\" size={14} />\n                  Users\n                </Link>\n              </Button>\n            )}\n\n            {/* Access Management - MANAGER only */}\n            {user?.role === 'MANAGER' && (\n              <Button variant=\"outline\" size=\"sm\" asChild>\n                <Link href=\"/access-management\">\n                  <UserCog className=\"mr-1\" size={14} />\n                  Access\n                </Link>\n              </Button>\n            )}\n\n            {/* Profile - CONTRACTOR only */}\n            {user?.role === 'CONTRACTOR' && (\n              <Button variant=\"outline\" size=\"sm\" asChild>\n                <Link href=\"/profile\">\n                  <Building2 className=\"mr-1\" size={14} />\n                  Profile\n                </Link>\n              </Button>\n            )}\n          </div>\n\n          {/* User Authentication Section */}\n          <div className=\"flex items-center gap-3 ml-3\">\n            <div className=\"text-sm text-gray-600 dark:text-gray-300 hidden sm:block\">\n              Welcome, <span className=\"font-semibold\">{user?.username}</span>\n            </div>\n            <Button variant=\"outline\" size=\"sm\" onClick={logout}>\n              Logout\n            </Button>\n          </div>\n        </div>\n      </div>\n    </header>\n  );\n}","path":null,"size_bytes":9110,"size_tokens":null},"client/src/lib/sessionUtils.ts":{"content":"// Session utility functions for client-side session management\n\nexport function generateSessionId(): string {\n  return crypto.randomUUID();\n}\n\nexport function getSessionId(): string {\n  // Check if we already have a session ID stored\n  let sessionId = localStorage.getItem('sessionId');\n  \n  if (!sessionId) {\n    // For backward compatibility, try to detect if there's existing data\n    // by checking if there are analysis points without a session filter\n    // If so, use a special session ID that will be handled by the server\n    sessionId = 'auto-detect-session';\n    localStorage.setItem('sessionId', sessionId);\n  }\n  \n  return sessionId;\n}\n\nexport function setSessionId(sessionId: string): void {\n  localStorage.setItem('sessionId', sessionId);\n}\n\nexport function clearSessionId(): void {\n  localStorage.removeItem('sessionId');\n}\n\n// Function to add session headers to requests\nexport function getSessionHeaders(): Record<string, string> {\n  return {\n    'X-Session-ID': getSessionId()\n  };\n}","path":null,"size_bytes":1003,"size_tokens":null},"client/src/components/ui/avatar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as AvatarPrimitive from \"@radix-ui/react-avatar\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Avatar = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatar.displayName = AvatarPrimitive.Root.displayName\n\nconst AvatarImage = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Image>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Image>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Image\n    ref={ref}\n    className={cn(\"aspect-square h-full w-full\", className)}\n    {...props}\n  />\n))\nAvatarImage.displayName = AvatarPrimitive.Image.displayName\n\nconst AvatarFallback = React.forwardRef<\n  React.ElementRef<typeof AvatarPrimitive.Fallback>,\n  React.ComponentPropsWithoutRef<typeof AvatarPrimitive.Fallback>\n>(({ className, ...props }, ref) => (\n  <AvatarPrimitive.Fallback\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full items-center justify-center rounded-full bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nAvatarFallback.displayName = AvatarPrimitive.Fallback.displayName\n\nexport { Avatar, AvatarImage, AvatarFallback }\n","path":null,"size_bytes":1419,"size_tokens":null},"client/src/components/ContractorSelector.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery } from \"@tanstack/react-query\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { ArrowLeft, Search, Star } from \"lucide-react\";\nimport type { Contractor, ContractorReview } from \"@shared/schema\";\nimport { calculateContractorAverageRating } from \"@/utils/reviewUtils\";\n\ninterface ContractorSelectorProps {\n  onSelectContractor: (contractor: Contractor) => void;\n  onCancel: () => void;\n}\n\nexport default function ContractorSelector({ onSelectContractor, onCancel }: ContractorSelectorProps) {\n  const [searchTerm, setSearchTerm] = useState(\"\");\n\n  const { data: contractors = [], isLoading } = useQuery<Contractor[]>({\n    queryKey: [\"/api/contractors\"],\n  });\n\n  const { data: allReviews = [] } = useQuery<ContractorReview[]>({\n    queryKey: [\"/api/contractor-reviews\"],\n  });\n\n  // Filter contractors based on search term\n  const filteredContractors = contractors.filter(contractor => \n    contractor.company.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    contractor.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    contractor.category?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    contractor.city?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n    contractor.state?.toLowerCase().includes(searchTerm.toLowerCase())\n  );\n\n  const StarRating = ({ contractorId }: { contractorId: number }) => {\n    const contractorReviews = allReviews.filter(review => review.contractorId === contractorId);\n    const averageRating = calculateContractorAverageRating(contractorReviews);\n    \n    if (averageRating.reviewCount === 0) {\n      return (\n        <div className=\"flex gap-1 items-center\">\n          {[1, 2, 3, 4, 5].map((star) => (\n            <Star key={star} className=\"w-4 h-4 text-gray-300\" />\n          ))}\n          <span className=\"text-xs text-gray-500 ml-1\">No reviews</span>\n        </div>\n      );\n    }\n\n    return (\n      <div className=\"flex gap-1 items-center\">\n        {[1, 2, 3, 4, 5].map((star) => {\n          const isFilled = star <= averageRating.averageRating;\n          \n          return (\n            <Star\n              key={star}\n              className={`w-4 h-4 ${\n                isFilled ? \"fill-red-500 text-red-500\" : \"text-gray-300\"\n              }`}\n            />\n          );\n        })}\n        <span className=\"text-xs text-gray-500 ml-1\">\n          ({averageRating.averageRating.toFixed(1)}) - {averageRating.reviewCount} review{averageRating.reviewCount !== 1 ? 's' : ''}\n        </span>\n      </div>\n    );\n  };\n\n  if (isLoading) {\n    return (\n      <div className=\"flex items-center justify-center min-h-screen\">\n        <div className=\"text-center\">\n          <div className=\"w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4\"></div>\n          <p className=\"text-gray-600 dark:text-gray-300\">Loading contractors...</p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-6\">\n      <div className=\"max-w-4xl mx-auto\">\n        {/* Header */}\n        <div className=\"mb-6\">\n          <div className=\"flex items-center gap-4 mb-4\">\n            <Button\n              onClick={onCancel}\n              variant=\"ghost\"\n              size=\"sm\"\n              className=\"text-gray-600 dark:text-gray-300\"\n            >\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Back\n            </Button>\n            <h1 className=\"text-2xl font-bold\">Select Contractor to Review</h1>\n          </div>\n          \n          {/* Search */}\n          <div className=\"relative\">\n            <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4\" />\n            <Input\n              placeholder=\"Search contractors by name, company, category, or location...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"pl-10\"\n            />\n          </div>\n        </div>\n\n        {/* Results */}\n        <div className=\"space-y-4\">\n          {filteredContractors.length === 0 ? (\n            <Card>\n              <CardContent className=\"text-center py-8\">\n                <p className=\"text-gray-500\">\n                  {searchTerm ? \"No contractors found matching your search.\" : \"No contractors available.\"}\n                </p>\n              </CardContent>\n            </Card>\n          ) : (\n            filteredContractors.map((contractor) => (\n              <Card key={contractor.id} className=\"hover:shadow-md transition-shadow cursor-pointer\">\n                <CardHeader className=\"pb-3\">\n                  <div className=\"flex justify-between items-start\">\n                    <div className=\"flex-1 min-w-0\">\n                      <CardTitle className=\"text-lg truncate\">{contractor.company}</CardTitle>\n                      <p className=\"text-sm text-gray-600 dark:text-gray-400 truncate\">{contractor.name}</p>\n                    </div>\n                    <Button\n                      onClick={() => onSelectContractor(contractor)}\n                      className=\"ml-4\"\n                    >\n                      Review\n                    </Button>\n                  </div>\n                </CardHeader>\n                <CardContent>\n                  <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-sm mb-4\">\n                    {contractor.category && (\n                      <div>\n                        <span className=\"font-medium\">Category:</span>\n                        <Badge variant=\"secondary\" className=\"ml-2\">{contractor.category}</Badge>\n                      </div>\n                    )}\n                    \n                    {contractor.city && (\n                      <div>\n                        <span className=\"font-medium\">Location:</span>\n                        <span className=\"ml-2\">{contractor.city}{contractor.state ? `, ${contractor.state}` : ''}</span>\n                      </div>\n                    )}\n                    \n                    {contractor.email && (\n                      <div>\n                        <span className=\"font-medium\">Email:</span>\n                        <span className=\"ml-2\">{contractor.email}</span>\n                      </div>\n                    )}\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between\">\n                    <StarRating contractorId={contractor.id} />\n                  </div>\n                </CardContent>\n              </Card>\n            ))\n          )}\n        </div>\n        \n        {filteredContractors.length > 0 && (\n          <div className=\"mt-6 text-center text-sm text-gray-500\">\n            Showing {filteredContractors.length} contractor{filteredContractors.length !== 1 ? 's' : ''}\n          </div>\n        )}\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":7061,"size_tokens":null},"client/src/components/ui/input.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Input = React.forwardRef<HTMLInputElement, React.ComponentProps<\"input\">>(\n  ({ className, type, ...props }, ref) => {\n    return (\n      <input\n        type={type}\n        className={cn(\n          \"flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n          className\n        )}\n        ref={ref}\n        {...props}\n      />\n    )\n  }\n)\nInput.displayName = \"Input\"\n\nexport { Input }\n","path":null,"size_bytes":791,"size_tokens":null},"client/src/hooks/useWeatherData.ts":{"content":"import { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\n\nexport interface WeatherOutlookFeature {\n  type: \"Feature\";\n  properties: {\n    category: string;\n    outlook_day: number;\n    [key: string]: any;\n  };\n  geometry: {\n    type: string;\n    coordinates: any;\n  };\n}\n\nexport interface WeatherOutlook {\n  type: \"FeatureCollection\";\n  features: WeatherOutlookFeature[];\n}\n\nexport interface ElectricUtility {\n  name: string;\n  customers: number;\n  intersectingArea: number;\n  highestRiskLevel?: string;\n  riskLevels?: string[];\n}\n\nexport function useWeatherData() {\n  const queryClient = useQueryClient();\n\n  // Fetch SPC 3-day outlook\n  const {\n    data: outlookData,\n    isLoading: isOutlookLoading,\n    error: outlookError,\n    refetch: refetchOutlook\n  } = useQuery<WeatherOutlook>({\n    queryKey: ['/api/weather/spc-outlook'],\n    queryFn: async () => {\n      const response = await fetch('/api/weather/spc-outlook');\n      if (!response.ok) {\n        throw new Error(`Failed to fetch SPC outlook: ${response.statusText}`);\n      }\n      return response.json();\n    },\n    staleTime: 10 * 60 * 1000, // 10 minutes\n    enabled: false // Don't auto-fetch, only when user requests\n  });\n\n  // Fetch electric utilities data\n  const {\n    data: utilitiesData,\n    isLoading: isUtilitiesLoading,\n    error: utilitiesError\n  } = useQuery({\n    queryKey: ['/api/weather/electric-utilities'],\n    queryFn: async () => {\n      const response = await fetch('/api/weather/electric-utilities');\n      if (!response.ok) {\n        throw new Error(`Failed to fetch electric utilities: ${response.statusText}`);\n      }\n      const data = await response.json();\n      \n      // Check if the response contains an error (in case of API fallback)\n      if (data.error) {\n        console.warn('Electric utilities API returned error:', data.error);\n        // Return the data anyway so the UI can show the error message\n        // instead of treating it as a complete failure\n      }\n      \n      return data;\n    },\n    staleTime: 0, // Always fresh - utility data may have been updated via admin\n    enabled: true // Auto-fetch when component mounts\n  });\n\n  // Calculate affected utilities\n  const calculateAffectedUtilities = useMutation({\n    mutationFn: async (outlookGeojson: WeatherOutlook): Promise<ElectricUtility[]> => {\n      const response = await fetch('/api/weather/affected-utilities', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ outlookGeojson })\n      });\n      \n      if (!response.ok) {\n        throw new Error(`Failed to calculate affected utilities: ${response.statusText}`);\n      }\n      \n      return response.json();\n    },\n    onSuccess: () => {\n      // Invalidate related queries if needed\n      queryClient.invalidateQueries({ queryKey: ['/api/weather'] });\n    }\n  });\n\n  // Load weather data (trigger the queries)\n  const loadWeatherData = async () => {\n    try {\n      await Promise.all([\n        refetchOutlook(),\n        queryClient.fetchQuery({\n          queryKey: ['/api/weather/electric-utilities'],\n          queryFn: async () => {\n            const response = await fetch('/api/weather/electric-utilities');\n            if (!response.ok) {\n              throw new Error(`Failed to fetch electric utilities: ${response.statusText}`);\n            }\n            return response.json();\n          }\n        })\n      ]);\n    } catch (error) {\n      console.error('Failed to load weather data:', error);\n      throw error;\n    }\n  };\n\n  return {\n    // Data\n    outlookData,\n    utilitiesData,\n    \n    // Loading states\n    isOutlookLoading,\n    isUtilitiesLoading,\n    isCalculatingAffected: calculateAffectedUtilities.isPending,\n    \n    // Errors\n    outlookError,\n    utilitiesError,\n    calculationError: calculateAffectedUtilities.error,\n    \n    // Actions\n    loadWeatherData,\n    calculateAffectedUtilities: calculateAffectedUtilities.mutateAsync,\n    \n    // Refetch functions\n    refetchOutlook\n  };\n}","path":null,"size_bytes":4090,"size_tokens":null},"client/src/components/ui/textarea.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Textarea = React.forwardRef<\n  HTMLTextAreaElement,\n  React.ComponentProps<\"textarea\">\n>(({ className, ...props }, ref) => {\n  return (\n    <textarea\n      className={cn(\n        \"flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-base ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 md:text-sm\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  )\n})\nTextarea.displayName = \"Textarea\"\n\nexport { Textarea }\n","path":null,"size_bytes":689,"size_tokens":null},"shared/schema.ts":{"content":"import { pgTable, text, serial, integer, real, timestamp, jsonb, varchar, boolean, bigint, index, uuid } from \"drizzle-orm/pg-core\";\nimport { createInsertSchema } from \"drizzle-zod\";\nimport { z } from \"zod\";\nimport { sql } from \"drizzle-orm\";\n\nexport const resources = pgTable(\"resources\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  type: text(\"type\").notNull(),\n  latitude: real(\"latitude\").notNull(),\n  longitude: real(\"longitude\").notNull(),\n  description: text(\"description\"),\n  properties: jsonb(\"properties\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const analysisPoints = pgTable(\"analysis_points\", {\n  id: serial(\"id\").primaryKey(),\n  sessionId: text(\"session_id\").notNull(),\n  label: text(\"label\").notNull(),\n  latitude: real(\"latitude\").notNull(),\n  longitude: real(\"longitude\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const distanceCalculations = pgTable(\"distance_calculations\", {\n  id: serial(\"id\").primaryKey(),\n  sessionId: text(\"session_id\").notNull(),\n  analysisPointId: integer(\"analysis_point_id\").references(() => analysisPoints.id),\n  resourceId: integer(\"resource_id\").references(() => resources.id),\n  distance: real(\"distance\").notNull(), // in miles\n  duration: integer(\"duration\").notNull(), // in seconds\n  route: jsonb(\"route\"), // route geometry\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const contractors = pgTable(\"contractors\", {\n  id: serial(\"id\").primaryKey(),\n  name: text(\"name\").notNull(),\n  company: text(\"company\").notNull(),\n  email: text(\"email\"),\n  phone: text(\"phone\"),\n  category: text(\"category\").notNull(), // Veg, Union, Non-Union, etc.\n  city: text(\"city\"),\n  state: text(\"state\"),\n  fullAddress: text(\"full_address\"),\n  latitude: real(\"latitude\"),\n  longitude: real(\"longitude\"),\n  departureLocations: jsonb(\"departure_locations\"), // Array of {location: string, latitude: number, longitude: number}\n  birdRep: text(\"bird_rep\"),\n  pipefile: text(\"pipefile\"), // Pipefile reference\n  avetta: text(\"avetta\"), // AVETTA status\n  subRanking: text(\"sub_ranking\"),\n  fteCountsPerLocation: text(\"fte_counts_per_location\"),\n  pipefileUpdates: text(\"pipefile_updates\"),\n  notes: text(\"notes\"),\n  newMsaComplete: text(\"new_msa_complete\").default(\"\"),\n  isnComplete: boolean(\"isn_complete\").default(false),\n  rating: real(\"rating\").default(0),\n  needsReview: boolean(\"needs_review\").default(false), // Flag for contractors from submissions needing manual review\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\nexport const contractorFiles = pgTable(\"contractor_files\", {\n  id: serial(\"id\").primaryKey(),\n  contractorId: integer(\"contractor_id\").notNull().references(() => contractors.id, { onDelete: \"cascade\" }),\n  filename: text(\"filename\").notNull(),\n  originalName: text(\"original_name\").notNull(),\n  filePath: text(\"file_path\").notNull(),\n  fileSize: integer(\"file_size\"),\n  mimeType: text(\"mime_type\"),\n  uploadedAt: timestamp(\"uploaded_at\").defaultNow().notNull(),\n});\n\nexport const contractorReviews = pgTable(\"contractor_reviews\", {\n  id: serial(\"id\").primaryKey(),\n  contractorId: integer(\"contractor_id\").notNull().references(() => contractors.id, { onDelete: \"cascade\" }),\n  submitterName: text(\"submitter_name\").notNull(),\n  communicationRating: integer(\"communication_rating\").notNull(), // 1-5 scale\n  workQualityRating: integer(\"work_quality_rating\").notNull(), // 1-5 scale\n  collaborationRating: integer(\"collaboration_rating\").notNull(), // 1-5 scale\n  documentationRating: integer(\"documentation_rating\").notNull(), // 1-5 scale\n  hadConflicts: boolean(\"had_conflicts\").notNull(),\n  conflictDetails: text(\"conflict_details\"),\n  strengths: text(\"strengths\"),\n  improvementAreas: text(\"improvement_areas\"),\n  metSafetyStandards: boolean(\"met_safety_standards\").notNull(),\n  safetyIssues: text(\"safety_issues\"),\n  adheredToSchedule: boolean(\"adhered_to_schedule\").notNull(),\n  scheduleIssues: text(\"schedule_issues\"),\n  wouldRecommend: boolean(\"would_recommend\").notNull(),\n  additionalComments: text(\"additional_comments\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\nexport const analysisJobs = pgTable(\"analysis_jobs\", {\n  id: serial(\"id\").primaryKey(),\n  filename: text(\"filename\").notNull(),\n  status: text(\"status\").notNull(), // 'processing', 'completed', 'failed'\n  resourceCount: integer(\"resource_count\"),\n  error: text(\"error\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const insertResourceSchema = createInsertSchema(resources).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertContractorSchema = createInsertSchema(contractors).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertAnalysisPointSchema = createInsertSchema(analysisPoints).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertDistanceCalculationSchema = createInsertSchema(distanceCalculations).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertContractorFileSchema = createInsertSchema(contractorFiles).omit({\n  id: true,\n  uploadedAt: true,\n});\n\nexport const insertContractorReviewSchema = createInsertSchema(contractorReviews).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertAnalysisJobSchema = createInsertSchema(analysisJobs).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type Resource = typeof resources.$inferSelect;\nexport type InsertResource = z.infer<typeof insertResourceSchema>;\nexport type Contractor = typeof contractors.$inferSelect;\nexport type InsertContractor = z.infer<typeof insertContractorSchema>;\nexport type ContractorFile = typeof contractorFiles.$inferSelect;\nexport type InsertContractorFile = z.infer<typeof insertContractorFileSchema>;\nexport type ContractorReview = typeof contractorReviews.$inferSelect;\nexport type InsertContractorReview = z.infer<typeof insertContractorReviewSchema>;\nexport type AnalysisPoint = typeof analysisPoints.$inferSelect;\nexport type InsertAnalysisPoint = z.infer<typeof insertAnalysisPointSchema>;\nexport type DistanceCalculation = typeof distanceCalculations.$inferSelect;\nexport type InsertDistanceCalculation = z.infer<typeof insertDistanceCalculationSchema>;\nexport type AnalysisJob = typeof analysisJobs.$inferSelect;\nexport type InsertAnalysisJob = z.infer<typeof insertAnalysisJobSchema>;\n\n// User authentication table\n// Crew availability tracking\nexport const crewAvailability = pgTable(\"crew_availability\", {\n  id: serial(\"id\").primaryKey(),\n  contractorId: integer(\"contractor_id\").notNull().references(() => contractors.id, { onDelete: \"cascade\" }),\n  sessionId: integer(\"session_id\").references(() => availabilitySessions.id),\n  submissionDate: timestamp(\"submission_date\").defaultNow().notNull(),\n  availableStartDate: timestamp(\"available_start_date\").notNull(),\n  availableEndDate: timestamp(\"available_end_date\"),\n  departureCity: text(\"departure_city\"),\n  departureState: text(\"departure_state\"),\n  departureLocation: text(\"departure_location\"), // Legacy field for backward compatibility\n  departureLatitude: real(\"departure_latitude\"),\n  departureLongitude: real(\"departure_longitude\"),\n  \n  // Crew and equipment counts\n  totalFTE: integer(\"total_fte\").default(0),\n  buckets: integer(\"buckets\").default(0),\n  diggers: integer(\"diggers\").default(0),\n  pickups: integer(\"pickups\").default(0),\n  backyardMachines: integer(\"backyard_machines\").default(0),\n  \n  // Legacy fields (keeping for backward compatibility)\n  linemenCount: integer(\"linemen_count\").default(0),\n  groundmenCount: integer(\"groundmen_count\").default(0),\n  operatorsCount: integer(\"operators_count\").default(0),\n  foremanCount: integer(\"foreman_count\").default(0),\n  apprenticesCount: integer(\"apprentices_count\").default(0),\n  \n  // Rates and costs\n  linemenRate: real(\"linemen_rate\"),\n  groundmenRate: real(\"groundmen_rate\"),\n  operatorsRate: real(\"operators_rate\"),\n  foremanRate: real(\"foreman_rate\"),\n  apprenticesRate: real(\"apprentices_rate\"),\n  \n  // Status and metadata\n  status: text(\"status\").notNull().default(\"submitted\"), // submitted, approved, deployed, expired\n  notes: text(\"notes\"),\n  submittedBy: text(\"submitted_by\"), // contractor or staff username\n  reviewedBy: text(\"reviewed_by\"),\n  reviewedAt: timestamp(\"reviewed_at\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull(),\n});\n\n// Equipment availability tracking\nexport const equipmentAvailability = pgTable(\"equipment_availability\", {\n  id: serial(\"id\").primaryKey(),\n  contractorId: integer(\"contractor_id\").notNull().references(() => contractors.id, { onDelete: \"cascade\" }),\n  crewAvailabilityId: integer(\"crew_availability_id\").references(() => crewAvailability.id, { onDelete: \"cascade\" }),\n  \n  equipmentType: text(\"equipment_type\").notNull(), // bucket_truck, digger, crane, etc.\n  quantity: integer(\"quantity\").notNull().default(1),\n  specifications: text(\"specifications\"), // height, capacity, special features\n  dailyRate: real(\"daily_rate\"),\n  mobilizationCost: real(\"mobilization_cost\"),\n  \n  availableStartDate: timestamp(\"available_start_date\").notNull(),\n  availableEndDate: timestamp(\"available_end_date\"),\n  \n  status: text(\"status\").notNull().default(\"available\"), // available, deployed, maintenance\n  notes: text(\"notes\"),\n  \n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Availability submissions for tracking bulk uploads\nexport const availabilitySubmissions = pgTable(\"availability_submissions\", {\n  id: serial(\"id\").primaryKey(),\n  contractorId: integer(\"contractor_id\").references(() => contractors.id, { onDelete: \"cascade\" }),\n  filename: text(\"filename\"),\n  originalName: text(\"original_name\"),\n  filePath: text(\"file_path\"),\n  submissionType: text(\"submission_type\").notNull(), // file_upload, manual_entry, contractor_portal\n  status: text(\"status\").notNull().default(\"pending\"), // pending, processed, failed\n  recordsCreated: integer(\"records_created\").default(0),\n  errors: text(\"errors\"), // JSON array of any processing errors\n  submittedBy: text(\"submitted_by\").notNull(),\n  processedAt: timestamp(\"processed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Weekly availability sessions for organizing submissions\nexport const availabilitySessions = pgTable(\"availability_sessions\", {\n  id: serial(\"id\").primaryKey(),\n  label: text(\"label\").notNull(), // e.g., \"Week of Jan 15, 2025\"\n  startDate: timestamp(\"start_date\").defaultNow().notNull(),\n  endDate: timestamp(\"end_date\"),\n  isActive: boolean(\"is_active\").default(true).notNull(),\n  closedAt: timestamp(\"closed_at\"),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n});\n\n// Replit Auth session storage table\nexport const sessions = pgTable(\n  \"sessions\",\n  {\n    sid: varchar(\"sid\").primaryKey(),\n    sess: jsonb(\"sess\").notNull(),\n    expire: timestamp(\"expire\").notNull(),\n  },\n  (table) => [index(\"IDX_session_expire\").on(table.expire)],\n);\n\n// Updated users table for Replit Auth + RBAC\nexport const users = pgTable(\"users\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  email: varchar(\"email\").unique(),\n  firstName: varchar(\"first_name\"),\n  lastName: varchar(\"last_name\"),\n  profileImageUrl: varchar(\"profile_image_url\"),\n  role: varchar(\"role\").notNull().default(\"CONTRACTOR\"), // ADMIN, CONTRACTOR, MANAGER, UTILITY\n  companyId: varchar(\"company_id\"), // Links to companies.id (UUID)\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"), // Soft delete\n});\n\nexport const insertCrewAvailabilitySchema = createInsertSchema(crewAvailability).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport const insertEquipmentAvailabilitySchema = createInsertSchema(equipmentAvailability).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertAvailabilitySubmissionSchema = createInsertSchema(availabilitySubmissions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertAvailabilitySessionSchema = createInsertSchema(availabilitySessions).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport type CrewAvailability = typeof crewAvailability.$inferSelect;\nexport type InsertCrewAvailability = z.infer<typeof insertCrewAvailabilitySchema>;\nexport type EquipmentAvailability = typeof equipmentAvailability.$inferSelect;\nexport type InsertEquipmentAvailability = z.infer<typeof insertEquipmentAvailabilitySchema>;\nexport type AvailabilitySubmission = typeof availabilitySubmissions.$inferSelect;\nexport type InsertAvailabilitySubmission = z.infer<typeof insertAvailabilitySubmissionSchema>;\nexport type AvailabilitySession = typeof availabilitySessions.$inferSelect;\nexport type InsertAvailabilitySession = z.infer<typeof insertAvailabilitySessionSchema>;\n\n// Incidents/Storms table\nexport const incidents = pgTable(\"incidents\", {\n  id: serial(\"id\").primaryKey(),\n  name: varchar(\"name\", { length: 100 }).notNull(),\n  description: text(\"description\"),\n  status: varchar(\"status\", { length: 20 }).default('active'), // active, completed, archived\n  startDate: timestamp(\"start_date\").defaultNow(),\n  endDate: timestamp(\"end_date\"),\n  priority: varchar(\"priority\", { length: 10 }).default('medium'), // low, medium, high, critical\n  location: varchar(\"location\", { length: 100 }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  createdBy: varchar(\"created_by\", { length: 50 }).default('admin'),\n});\n\n// Incident assignments - linking crews to incidents\nexport const incidentAssignments = pgTable(\"incident_assignments\", {\n  id: serial(\"id\").primaryKey(),\n  incidentId: integer(\"incident_id\").references(() => incidents.id),\n  crewAvailabilityId: integer(\"crew_availability_id\").references(() => crewAvailability.id),\n  assignedAt: timestamp(\"assigned_at\").defaultNow(),\n  assignedBy: varchar(\"assigned_by\", { length: 50 }).default('admin'),\n  status: varchar(\"status\", { length: 20 }).default('assigned'), // assigned, deployed, completed\n  notes: text(\"notes\"),\n});\n\n// Crew rosters - detailed crew information for deployed teams\nexport const crewRosters = pgTable(\"crew_rosters\", {\n  id: serial(\"id\").primaryKey(),\n  incidentAssignmentId: integer(\"incident_assignment_id\").references(() => incidentAssignments.id),\n  subcontractor: varchar(\"subcontractor\", { length: 100 }),\n  employeeName: varchar(\"employee_name\", { length: 100 }).notNull(),\n  allPersonnel: varchar(\"all_personnel\", { length: 50 }), // crew size reference\n  gender: varchar(\"gender\", { length: 10 }),\n  employeeId: varchar(\"employee_id\", { length: 50 }),\n  classification: varchar(\"classification\", { length: 50 }), // General Foreman, Lineman, etc.\n  crewId: varchar(\"crew_id\", { length: 20 }),\n  location: varchar(\"location\", { length: 100 }), // city, state\n  timeIn: varchar(\"time_in\", { length: 20 }), // time and date\n  equipmentType: varchar(\"equipment_type\", { length: 50 }), // Pickup, Bucket Truck, etc.\n  equipmentId: varchar(\"equipment_id\", { length: 20 }),\n  equipmentUnitNumber: varchar(\"equipment_unit_number\", { length: 20 }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const insertIncidentSchema = createInsertSchema(incidents).omit({\n  id: true,\n  createdAt: true,\n});\n\nexport const insertIncidentAssignmentSchema = createInsertSchema(incidentAssignments).omit({\n  id: true,\n  assignedAt: true,\n});\n\nexport const insertCrewRosterSchema = createInsertSchema(crewRosters).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n});\n\nexport type Incident = typeof incidents.$inferSelect;\nexport type InsertIncident = z.infer<typeof insertIncidentSchema>;\nexport type IncidentAssignment = typeof incidentAssignments.$inferSelect;\nexport type InsertIncidentAssignment = z.infer<typeof insertIncidentAssignmentSchema>;\nexport type CrewRoster = typeof crewRosters.$inferSelect;\nexport type InsertCrewRoster = z.infer<typeof insertCrewRosterSchema>;\n\n// Configuration storage for app settings\nexport const appConfig = pgTable(\"app_config\", {\n  id: serial(\"id\").primaryKey(),\n  key: text(\"key\").notNull().unique(),\n  value: jsonb(\"value\").notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow().notNull(),\n  updatedAt: timestamp(\"updated_at\").defaultNow().notNull()\n});\n\nexport const insertAppConfigSchema = createInsertSchema(appConfig).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true\n});\n\nexport type AppConfig = typeof appConfig.$inferSelect;\nexport type InsertAppConfig = z.infer<typeof insertAppConfigSchema>;\n\n// ===== STORM RESPONSE MANAGEMENT SYSTEM TABLES =====\n// From Replit Build Prompt — Utility Storm Response Module\n\n// Companies table\nexport const companies = pgTable(\"companies\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull().unique(),\n  contactName: text(\"contact_name\"),\n  contactEmail: text(\"contact_email\"),\n  contactPhone: text(\"contact_phone\"),\n  billingAddress: text(\"billing_address\"),\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// User company access - tracks which UTILITY users have access to which companies\nexport const userCompanyAccess = pgTable(\"user_company_access\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id, { onDelete: \"cascade\" }),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id, { onDelete: \"cascade\" }),\n  grantedBy: varchar(\"granted_by\").references(() => users.id), // MANAGER who granted access\n  grantedAt: timestamp(\"granted_at\").defaultNow().notNull(),\n}, (table) => [\n  index(\"idx_user_company_access_user\").on(table.userId),\n  index(\"idx_user_company_access_company\").on(table.companyId),\n]);\n\n// Storm response sessions table\nexport const stormSessions = pgTable(\"storm_sessions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  startDate: timestamp(\"start_date\").notNull(),\n  location: text(\"location\").notNull(),\n  client: text(\"client\"), // Optional client name\n  status: varchar(\"status\", { length: 20 }).notNull().default(\"DRAFT\"), // DRAFT, ACTIVE, CLOSED\n  isActive: boolean(\"is_active\").default(false).notNull(), // Only one session should be active at a time\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Session contractors (M:N relationship) - links sessions to companies for backward compatibility\nexport const sessionContractors = pgTable(\"session_contractors\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").notNull().references(() => stormSessions.id),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  invitedAt: timestamp(\"invited_at\").defaultNow(),\n  joinedAt: timestamp(\"joined_at\"),\n  roleHint: text(\"role_hint\"), // e.g., \"Line Contractor\", \"Equipment Supplier\"\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Session contractor members (M:N relationship) - links sessions to individual contractors from the contractors database\nexport const sessionContractorMembers = pgTable(\"session_contractor_members\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").notNull().references(() => stormSessions.id, { onDelete: \"cascade\" }),\n  contractorId: integer(\"contractor_id\").notNull().references(() => contractors.id, { onDelete: \"cascade\" }),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n}, (table) => [\n  index(\"idx_session_contractor_members_session\").on(table.sessionId),\n  index(\"idx_session_contractor_members_contractor\").on(table.contractorId),\n]);\n\n// User session grants (RBAC per session)\nexport const userSessions = pgTable(\"user_sessions\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  sessionId: varchar(\"session_id\").notNull().references(() => stormSessions.id),\n  roleScope: varchar(\"role_scope\", { length: 20 }).notNull(), // VIEW, APPROVE, ADMIN\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Rosters table\nexport const rosters = pgTable(\"rosters\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").notNull().references(() => stormSessions.id),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  status: varchar(\"status\", { length: 20 }).notNull().default(\"DRAFT\"), // DRAFT, SUBMITTED, APPROVED, LOCKED\n  lockedBy: varchar(\"locked_by\").references(() => users.id),\n  lockedAt: timestamp(\"locked_at\"),\n  version: integer(\"version\").notNull().default(1),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Crews table\nexport const crews = pgTable(\"crews\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  rosterId: varchar(\"roster_id\").notNull().references(() => rosters.id, { onDelete: \"cascade\" }),\n  crewName: text(\"crew_name\").notNull(),\n  crewLead: text(\"crew_lead\"),\n  workArea: text(\"work_area\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Roster personnel table\nexport const rosterPersonnel = pgTable(\"roster_personnel\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  rosterId: varchar(\"roster_id\").notNull().references(() => rosters.id, { onDelete: \"cascade\" }),\n  crewId: varchar(\"crew_id\").references(() => crews.id),\n  personnelId: text(\"personnel_id\"), // Personnel ID from template\n  firstName: text(\"first_name\"), // First Name from template\n  lastName: text(\"last_name\"), // Last Name from template\n  name: text(\"name\").notNull(), // Combined first + last name\n  role: text(\"role\"), // Team Type from template\n  classification: text(\"classification\"), // Resource Type from template\n  rateCode: text(\"rate_code\"),\n  gender: text(\"gender\"), // Gender from template\n  stOtPtEligibility: text(\"st_ot_pt_eligibility\"), // ST/OT/PT eligibility\n  email: text(\"email\"),\n  phone: text(\"phone\"), // Cell Phone from template\n  teamLead: text(\"team_lead\"), // Team Lead / General Foreman from template\n  crewLeadFlag: text(\"crew_lead_flag\"), // Crew Lead / Foreman from template\n  departureCity: text(\"departure_city\"), // Departure City from template\n  departureState: text(\"departure_state\"), // Departure State from template\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Roster equipment table\nexport const rosterEquipment = pgTable(\"roster_equipment\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  rosterId: varchar(\"roster_id\").notNull().references(() => rosters.id, { onDelete: \"cascade\" }),\n  crewId: varchar(\"crew_id\").references(() => crews.id),\n  equipmentId: text(\"equipment_id\"), // Equipment ID from template\n  equipmentType: text(\"equipment_type\"), // Equipment Type from template\n  equipmentDescription: text(\"equipment_description\"), // Equipment Description from template\n  type: text(\"type\").notNull(), // Kept for backward compatibility\n  classification: text(\"classification\"), // Kept for backward compatibility\n  rateCode: text(\"rate_code\"),\n  ownership: text(\"ownership\"), // Owned, Leased, Subcontractor\n  fuel: text(\"fuel\"), // Equipment Fuel Type from template\n  assignedCrewId: text(\"assigned_crew_id\"), // Assigned Equipment Crew ID from template\n  notes: text(\"notes\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Timesheets table - Header information for one crew's timesheet for one day\nexport const timesheets = pgTable(\"timesheets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").notNull().references(() => stormSessions.id),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  crewId: varchar(\"crew_id\").references(() => crews.id),\n  date: timestamp(\"date\").notNull(),\n  \n  // Header fields from Excel\n  projectName: text(\"project_name\"),\n  utilityName: text(\"utility_name\"),\n  teamGeneralForeman: text(\"team_general_foreman\"),\n  crewForeman: text(\"crew_foreman\"),\n  jobLocations: text(\"job_locations\"),\n  lodgingProvided: boolean(\"lodging_provided\"),\n  crewIdNumber: text(\"crew_id_number\"),\n  locationAreaAssigned: text(\"location_area_assigned\"),\n  foremanPhone: text(\"foreman_phone\"),\n  workDescription: text(\"work_description\"),\n  \n  // Status and signatures\n  status: varchar(\"status\", { length: 20 }).notNull().default(\"DRAFT\"), // DRAFT, SUBMITTED, APPROVED, SIGNED\n  submittedBy: varchar(\"submitted_by\").references(() => users.id),\n  submittedAt: timestamp(\"submitted_at\"),\n  approvedBy: varchar(\"approved_by\").references(() => users.id),\n  approvedAt: timestamp(\"approved_at\"),\n  utilitySignedBy: varchar(\"utility_signed_by\").references(() => users.id),\n  utilitySignedAt: timestamp(\"utility_signed_at\"),\n  utilityRepName: text(\"utility_rep_name\"),\n  \n  version: integer(\"version\").notNull().default(1),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Timesheet personnel rows - one row per employee per day with work segments as JSON\nexport const timesheetPersonnel = pgTable(\"timesheet_personnel\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  timesheetId: varchar(\"timesheet_id\").notNull().references(() => timesheets.id, { onDelete: \"cascade\" }),\n  rosterPersonnelId: varchar(\"roster_personnel_id\").references(() => rosterPersonnel.id), // Link to roster if available\n  employeeName: text(\"employee_name\").notNull(),\n  classification: text(\"classification\").notNull(), // GF, Foreman, Lineman, Apprentice, etc.\n  segments: jsonb(\"segments\"), // Array of work segments: [{ activityType: 'M'|'D'|'W'|'S', ticketNumber?, startTime, endTime }]\n  startTime: text(\"start_time\"), // Primary start time for easy editing (synced with first segment)\n  endTime: text(\"end_time\"), // Primary end time for easy editing (synced with first segment)\n  totalHours: real(\"total_hours\").default(0),\n  mealsProvidedByUtility: integer(\"meals_provided_by_utility\").default(0),\n  perDiemMeals: integer(\"per_diem_meals\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Timesheet equipment rows - equipment used by crew that day\nexport const timesheetEquipment = pgTable(\"timesheet_equipment\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  timesheetId: varchar(\"timesheet_id\").notNull().references(() => timesheets.id, { onDelete: \"cascade\" }),\n  rosterEquipmentId: varchar(\"roster_equipment_id\").references(() => rosterEquipment.id), // Link to roster if available\n  equipmentDescription: text(\"equipment_description\").notNull(),\n  equipmentNumber: text(\"equipment_number\"),\n  startTime: text(\"start_time\"),\n  endTime: text(\"end_time\"),\n  totalHours: real(\"total_hours\").default(0),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Legacy table for backward compatibility - kept for now\nexport const timesheetLines = pgTable(\"timesheet_lines\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  timesheetId: varchar(\"timesheet_id\").notNull().references(() => timesheets.id, { onDelete: \"cascade\" }),\n  subjectType: varchar(\"subject_type\", { length: 20 }).notNull(), // PERSONNEL, EQUIPMENT\n  subjectRefId: varchar(\"subject_ref_id\"), // References roster_personnel.id or roster_equipment.id\n  hoursST: real(\"hours_st\").default(0), // Straight time hours\n  hoursOT: real(\"hours_ot\").default(0), // Overtime hours\n  hoursPT: real(\"hours_pt\").default(0), // Premium time hours\n  rateCode: text(\"rate_code\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Expenses table\nexport const expenses = pgTable(\"expenses\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").notNull().references(() => stormSessions.id),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  date: timestamp(\"date\").notNull(),\n  category: text(\"category\").notNull(), // Fuel, Lodging, Meals, Equipment Rental, etc.\n  amountCents: bigint(\"amount_cents\", { mode: \"number\" }).notNull(), // Store as cents to avoid floating point errors\n  currency: varchar(\"currency\", { length: 3 }).notNull().default(\"USD\"),\n  notes: text(\"notes\"),\n  status: varchar(\"status\", { length: 20 }).notNull().default(\"SUBMITTED\"), // SUBMITTED, APPROVED, REJECTED\n  submittedBy: varchar(\"submitted_by\").notNull().references(() => users.id),\n  approvedBy: varchar(\"approved_by\").references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Expense files table\nexport const expenseFiles = pgTable(\"expense_files\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  expenseId: varchar(\"expense_id\").notNull().references(() => expenses.id, { onDelete: \"cascade\" }),\n  fileKey: text(\"file_key\").notNull(), // Object storage key\n  originalName: text(\"original_name\").notNull(),\n  mimeType: text(\"mime_type\"),\n  size: integer(\"size\"), // File size in bytes\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// FTE reports table\nexport const fteReports = pgTable(\"fte_reports\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  sessionId: varchar(\"session_id\").references(() => stormSessions.id),\n  date: timestamp(\"date\").notNull(),\n  payloadJson: jsonb(\"payload_json\").notNull(), // Flexible JSON payload for FTE data\n  submittedBy: varchar(\"submitted_by\").notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Company locations table\nexport const companyLocations = pgTable(\"company_locations\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  label: text(\"label\").notNull(),\n  address: text(\"address\"),\n  lat: real(\"lat\"),\n  lon: real(\"lon\"),\n  typeTag: text(\"type_tag\"), // office, yard, warehouse, etc.\n  activeFlag: boolean(\"active_flag\").notNull().default(true),\n  effectiveFrom: timestamp(\"effective_from\").defaultNow(),\n  effectiveTo: timestamp(\"effective_to\"),\n  notes: text(\"notes\"),\n  source: text(\"source\"), // manual, import, geocoded, etc.\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Rate tables\nexport const rateTables = pgTable(\"rate_tables\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").references(() => stormSessions.id),\n  scope: varchar(\"scope\", { length: 20 }).notNull(), // GLOBAL, SESSION\n  subject: varchar(\"subject\", { length: 20 }).notNull(), // PERSONNEL, EQUIPMENT\n  classification: text(\"classification\").notNull(),\n  workType: text(\"work_type\"), // MOBILIZED, WORKING, STANDBY, DEMOBILIZED\n  hoursType: varchar(\"hours_type\", { length: 10 }).notNull(), // ST, OT, PT\n  rateCents: bigint(\"rate_cents\", { mode: \"number\" }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Invoices table\nexport const invoices = pgTable(\"invoices\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").notNull().references(() => stormSessions.id),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  status: varchar(\"status\", { length: 20 }).notNull().default(\"DRAFT\"), // DRAFT, ISSUED, PAID\n  issuedAt: timestamp(\"issued_at\"),\n  dueAt: timestamp(\"due_at\"),\n  totalsJson: jsonb(\"totals_json\"), // Flexible JSON for subtotals, taxes, etc.\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Invoice lines table\nexport const invoiceLines = pgTable(\"invoice_lines\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  invoiceId: varchar(\"invoice_id\").notNull().references(() => invoices.id, { onDelete: \"cascade\" }),\n  source: varchar(\"source\", { length: 20 }).notNull(), // TIMESHEET, EXPENSE\n  sourceId: varchar(\"source_id\"), // References timesheets.id or expenses.id\n  description: text(\"description\").notNull(),\n  qty: real(\"qty\").notNull(),\n  unitRateCents: bigint(\"unit_rate_cents\", { mode: \"number\" }).notNull(),\n  amountCents: bigint(\"amount_cents\", { mode: \"number\" }).notNull(),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  deletedAt: timestamp(\"deleted_at\"),\n});\n\n// Audit logs table\nexport const auditLogs = pgTable(\"audit_logs\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  actorUserId: varchar(\"actor_user_id\").references(() => users.id),\n  entity: text(\"entity\").notNull(), // Table name\n  entityId: varchar(\"entity_id\").notNull(), // Record ID\n  action: varchar(\"action\", { length: 20 }).notNull(), // CREATE, UPDATE, DELETE\n  beforeJson: jsonb(\"before_json\"),\n  afterJson: jsonb(\"after_json\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\n// ===== TICKETING MODULE TABLES =====\n\nexport const issueTypes = pgTable(\"issue_types\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  name: text(\"name\").notNull(),\n  code: text(\"code\").notNull().unique(),\n  defaultPriority: varchar(\"default_priority\", { length: 5 }).notNull().default(\"P2\"),\n  defaultRequiredCrewType: text(\"default_required_crew_type\"),\n  defaultRequiredEquipment: jsonb(\"default_required_equipment\"),\n  closeoutChecklist: jsonb(\"closeout_checklist\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n});\n\nexport const tickets = pgTable(\"tickets\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  sessionId: varchar(\"session_id\").notNull().references(() => stormSessions.id),\n  companyId: varchar(\"company_id\").references(() => companies.id),\n  issueTypeId: varchar(\"issue_type_id\").notNull().references(() => issueTypes.id),\n  externalRef: text(\"external_ref\"),\n  title: text(\"title\"),\n  description: text(\"description\"),\n  priority: varchar(\"priority\", { length: 5 }).notNull().default(\"P2\"),\n  status: varchar(\"status\", { length: 20 }).notNull().default(\"CREATED\"),\n  addressText: text(\"address_text\"),\n  lat: real(\"lat\"),\n  lon: real(\"lon\"),\n  feeder: text(\"feeder\"),\n  circuit: text(\"circuit\"),\n  safetyFlags: jsonb(\"safety_flags\"),\n  createdByUserId: varchar(\"created_by_user_id\").notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  updatedAt: timestamp(\"updated_at\").defaultNow(),\n  closedAt: timestamp(\"closed_at\"),\n}, (table) => [\n  index(\"idx_tickets_session\").on(table.sessionId),\n  index(\"idx_tickets_company\").on(table.companyId),\n  index(\"idx_tickets_status\").on(table.status),\n  index(\"idx_tickets_external_ref\").on(table.externalRef),\n]);\n\nexport const ticketAssignments = pgTable(\"ticket_assignments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  ticketId: varchar(\"ticket_id\").notNull().references(() => tickets.id),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  crewId: varchar(\"crew_id\").notNull().references(() => crews.id),\n  status: varchar(\"status\", { length: 20 }).notNull().default(\"PENDING_ACCEPT\"),\n  assignedByUserId: varchar(\"assigned_by_user_id\").notNull().references(() => users.id),\n  assignedAt: timestamp(\"assigned_at\").defaultNow().notNull(),\n  respondedAt: timestamp(\"responded_at\"),\n  responseNote: text(\"response_note\"),\n  isActive: boolean(\"is_active\").notNull().default(true),\n});\n\nexport const ticketStatusEvents = pgTable(\"ticket_status_events\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  ticketId: varchar(\"ticket_id\").notNull().references(() => tickets.id),\n  oldStatus: varchar(\"old_status\", { length: 20 }),\n  newStatus: varchar(\"new_status\", { length: 20 }).notNull(),\n  changedByUserId: varchar(\"changed_by_user_id\").notNull().references(() => users.id),\n  changedAt: timestamp(\"changed_at\").defaultNow().notNull(),\n  note: text(\"note\"),\n});\n\nexport const ticketWorkSegments = pgTable(\"ticket_work_segments\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  ticketId: varchar(\"ticket_id\").notNull().references(() => tickets.id),\n  sessionId: varchar(\"session_id\").notNull().references(() => stormSessions.id),\n  companyId: varchar(\"company_id\").notNull().references(() => companies.id),\n  crewId: varchar(\"crew_id\").notNull().references(() => crews.id),\n  startedAt: timestamp(\"started_at\").notNull(),\n  endedAt: timestamp(\"ended_at\"),\n  createdByUserId: varchar(\"created_by_user_id\").notNull().references(() => users.id),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n});\n\nexport const notifications = pgTable(\"notifications\", {\n  id: varchar(\"id\").primaryKey().default(sql`gen_random_uuid()`),\n  userId: varchar(\"user_id\").notNull().references(() => users.id),\n  type: varchar(\"type\", { length: 30 }).notNull(),\n  entityType: varchar(\"entity_type\", { length: 30 }),\n  entityId: varchar(\"entity_id\"),\n  title: text(\"title\").notNull(),\n  body: text(\"body\"),\n  createdAt: timestamp(\"created_at\").defaultNow(),\n  readAt: timestamp(\"read_at\"),\n});\n\n// Insert schemas and types for Storm Response Management tables\nexport const insertCompanySchema = createInsertSchema(companies).omit({ id: true, createdAt: true, updatedAt: true, deletedAt: true });\nexport const insertStormSessionSchema = createInsertSchema(stormSessions).omit({ id: true, createdAt: true, updatedAt: true, deletedAt: true }).extend({\n  startDate: z.preprocess((val) => (val === null || val === undefined ? undefined : typeof val === 'string' ? new Date(val) : val), z.date()),\n  location: z.string().min(1, \"Location is required\"),\n  client: z.string().optional(),\n});\nexport const insertSessionContractorSchema = createInsertSchema(sessionContractors).omit({ id: true, createdAt: true, deletedAt: true });\nexport const insertSessionContractorMemberSchema = createInsertSchema(sessionContractorMembers).omit({ id: true, createdAt: true, deletedAt: true });\nexport const insertUserSessionSchema = createInsertSchema(userSessions).omit({ id: true, createdAt: true, deletedAt: true });\nexport const insertRosterSchema = createInsertSchema(rosters).omit({ id: true, createdAt: true, updatedAt: true, deletedAt: true });\nexport const insertCrewSchema = createInsertSchema(crews).omit({ id: true, createdAt: true, deletedAt: true });\nexport const insertRosterPersonnelSchema = createInsertSchema(rosterPersonnel).omit({ id: true, createdAt: true, deletedAt: true });\nexport const insertRosterEquipmentSchema = createInsertSchema(rosterEquipment).omit({ id: true, createdAt: true, deletedAt: true });\n// Zod schema for work segments validation\nexport const workSegmentSchema = z.object({\n  activityType: z.enum(['M', 'D', 'W', 'S']), // M=Mobilized, D=Demobilized, W=Work, S=Standby\n  ticketNumber: z.string().optional(),\n  startTime: z.string().optional(), // e.g., \"5AM\" or \"06:00\"\n  endTime: z.string().optional(),\n}).refine(\n  (data) => data.activityType !== 'W' || data.ticketNumber,\n  { message: \"Ticket number required for Work activity\", path: [\"ticketNumber\"] }\n);\n\nexport const insertTimesheetSchema = createInsertSchema(timesheets).omit({ id: true, createdAt: true, updatedAt: true, deletedAt: true, submittedAt: true, approvedAt: true, utilitySignedAt: true });\nexport const insertTimesheetPersonnelSchema = createInsertSchema(timesheetPersonnel).omit({ id: true, createdAt: true, deletedAt: true }).extend({\n  segments: z.array(workSegmentSchema).optional(),\n});\nexport const insertTimesheetEquipmentSchema = createInsertSchema(timesheetEquipment).omit({ id: true, createdAt: true, deletedAt: true });\nexport const insertTimesheetLineSchema = createInsertSchema(timesheetLines).omit({ id: true, createdAt: true, deletedAt: true });\nexport const insertExpenseSchema = createInsertSchema(expenses).omit({ id: true, createdAt: true, updatedAt: true, deletedAt: true }).extend({\n  date: z.preprocess((val) => (typeof val === 'string' ? new Date(val) : val), z.date()),\n});\nexport const insertExpenseFileSchema = createInsertSchema(expenseFiles).omit({ id: true, createdAt: true, deletedAt: true });\nexport const insertFteReportSchema = createInsertSchema(fteReports).omit({ id: true, createdAt: true, deletedAt: true });\nexport const insertCompanyLocationSchema = createInsertSchema(companyLocations).omit({ id: true, createdAt: true, updatedAt: true, deletedAt: true });\nexport const insertRateTableSchema = createInsertSchema(rateTables).omit({ id: true, createdAt: true, updatedAt: true, deletedAt: true });\nexport const insertInvoiceSchema = createInsertSchema(invoices).omit({ id: true, createdAt: true, updatedAt: true, deletedAt: true });\nexport const insertInvoiceLineSchema = createInsertSchema(invoiceLines).omit({ id: true, createdAt: true, deletedAt: true });\nexport const insertAuditLogSchema = createInsertSchema(auditLogs).omit({ id: true, createdAt: true });\n\n// Ticketing module insert schemas\nexport const insertIssueTypeSchema = createInsertSchema(issueTypes).omit({ id: true, createdAt: true, updatedAt: true });\nexport const insertTicketSchema = createInsertSchema(tickets).omit({ id: true, createdAt: true, updatedAt: true, closedAt: true });\nexport const insertTicketAssignmentSchema = createInsertSchema(ticketAssignments).omit({ id: true, assignedAt: true, respondedAt: true });\nexport const insertTicketStatusEventSchema = createInsertSchema(ticketStatusEvents).omit({ id: true, changedAt: true });\nexport const insertTicketWorkSegmentSchema = createInsertSchema(ticketWorkSegments).omit({ id: true, createdAt: true });\nexport const insertNotificationSchema = createInsertSchema(notifications).omit({ id: true, createdAt: true, readAt: true });\n\n// User schemas and types for Replit Auth\nexport const insertUserSchema = createInsertSchema(users).omit({\n  id: true,\n  createdAt: true,\n  updatedAt: true,\n  deletedAt: true,\n});\n\nexport const insertUserCompanyAccessSchema = createInsertSchema(userCompanyAccess).omit({\n  id: true,\n  grantedAt: true,\n});\n\nexport type UpsertUser = typeof users.$inferInsert;\nexport type User = typeof users.$inferSelect;\nexport type InsertUser = z.infer<typeof insertUserSchema>;\nexport type UserCompanyAccess = typeof userCompanyAccess.$inferSelect;\nexport type InsertUserCompanyAccess = z.infer<typeof insertUserCompanyAccessSchema>;\nexport type Company = typeof companies.$inferSelect;\nexport type InsertCompany = z.infer<typeof insertCompanySchema>;\nexport type StormSession = typeof stormSessions.$inferSelect;\nexport type InsertStormSession = z.infer<typeof insertStormSessionSchema>;\nexport type SessionContractor = typeof sessionContractors.$inferSelect;\nexport type InsertSessionContractor = z.infer<typeof insertSessionContractorSchema>;\nexport type SessionContractorMember = typeof sessionContractorMembers.$inferSelect;\nexport type InsertSessionContractorMember = z.infer<typeof insertSessionContractorMemberSchema>;\nexport type UserSession = typeof userSessions.$inferSelect;\nexport type InsertUserSession = z.infer<typeof insertUserSessionSchema>;\nexport type Roster = typeof rosters.$inferSelect;\nexport type InsertRoster = z.infer<typeof insertRosterSchema>;\nexport type Crew = typeof crews.$inferSelect;\nexport type InsertCrew = z.infer<typeof insertCrewSchema>;\nexport type RosterPersonnel = typeof rosterPersonnel.$inferSelect;\nexport type InsertRosterPersonnel = z.infer<typeof insertRosterPersonnelSchema>;\nexport type RosterEquipment = typeof rosterEquipment.$inferSelect;\nexport type InsertRosterEquipment = z.infer<typeof insertRosterEquipmentSchema>;\nexport type WorkSegment = z.infer<typeof workSegmentSchema>;\nexport type Timesheet = typeof timesheets.$inferSelect;\nexport type InsertTimesheet = z.infer<typeof insertTimesheetSchema>;\nexport type TimesheetPersonnel = typeof timesheetPersonnel.$inferSelect;\nexport type InsertTimesheetPersonnel = z.infer<typeof insertTimesheetPersonnelSchema>;\nexport type TimesheetEquipment = typeof timesheetEquipment.$inferSelect;\nexport type InsertTimesheetEquipment = z.infer<typeof insertTimesheetEquipmentSchema>;\nexport type TimesheetLine = typeof timesheetLines.$inferSelect;\nexport type InsertTimesheetLine = z.infer<typeof insertTimesheetLineSchema>;\nexport type Expense = typeof expenses.$inferSelect;\nexport type InsertExpense = z.infer<typeof insertExpenseSchema>;\nexport type ExpenseFile = typeof expenseFiles.$inferSelect;\nexport type InsertExpenseFile = z.infer<typeof insertExpenseFileSchema>;\nexport type FteReport = typeof fteReports.$inferSelect;\nexport type InsertFteReport = z.infer<typeof insertFteReportSchema>;\nexport type CompanyLocation = typeof companyLocations.$inferSelect;\nexport type InsertCompanyLocation = z.infer<typeof insertCompanyLocationSchema>;\nexport type RateTable = typeof rateTables.$inferSelect;\nexport type InsertRateTable = z.infer<typeof insertRateTableSchema>;\nexport type Invoice = typeof invoices.$inferSelect;\nexport type InsertInvoice = z.infer<typeof insertInvoiceSchema>;\nexport type InvoiceLine = typeof invoiceLines.$inferSelect;\nexport type InsertInvoiceLine = z.infer<typeof insertInvoiceLineSchema>;\nexport type AuditLog = typeof auditLogs.$inferSelect;\nexport type InsertAuditLog = z.infer<typeof insertAuditLogSchema>;\n\n// Ticketing module types\nexport type IssueType = typeof issueTypes.$inferSelect;\nexport type InsertIssueType = z.infer<typeof insertIssueTypeSchema>;\nexport type Ticket = typeof tickets.$inferSelect;\nexport type InsertTicket = z.infer<typeof insertTicketSchema>;\nexport type TicketAssignment = typeof ticketAssignments.$inferSelect;\nexport type InsertTicketAssignment = z.infer<typeof insertTicketAssignmentSchema>;\nexport type TicketStatusEvent = typeof ticketStatusEvents.$inferSelect;\nexport type InsertTicketStatusEvent = z.infer<typeof insertTicketStatusEventSchema>;\nexport type TicketWorkSegment = typeof ticketWorkSegments.$inferSelect;\nexport type InsertTicketWorkSegment = z.infer<typeof insertTicketWorkSegmentSchema>;\nexport type Notification = typeof notifications.$inferSelect;\nexport type InsertNotification = z.infer<typeof insertNotificationSchema>;\n","path":null,"size_bytes":47110,"size_tokens":null},"client/src/components/ui/switch.tsx":{"content":"import * as React from \"react\"\nimport * as SwitchPrimitives from \"@radix-ui/react-switch\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Switch = React.forwardRef<\n  React.ElementRef<typeof SwitchPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof SwitchPrimitives.Root>\n>(({ className, ...props }, ref) => (\n  <SwitchPrimitives.Root\n    className={cn(\n      \"peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=unchecked]:bg-input\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  >\n    <SwitchPrimitives.Thumb\n      className={cn(\n        \"pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0\"\n      )}\n    />\n  </SwitchPrimitives.Root>\n))\nSwitch.displayName = SwitchPrimitives.Root.displayName\n\nexport { Switch }\n","path":null,"size_bytes":1139,"size_tokens":null},"client/src/components/ui/form.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport {\n  Controller,\n  FormProvider,\n  useFormContext,\n  type ControllerProps,\n  type FieldPath,\n  type FieldValues,\n} from \"react-hook-form\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Label } from \"@/components/ui/label\"\n\nconst Form = FormProvider\n\ntype FormFieldContextValue<\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n> = {\n  name: TName\n}\n\nconst FormFieldContext = React.createContext<FormFieldContextValue>(\n  {} as FormFieldContextValue\n)\n\nconst FormField = <\n  TFieldValues extends FieldValues = FieldValues,\n  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>\n>({\n  ...props\n}: ControllerProps<TFieldValues, TName>) => {\n  return (\n    <FormFieldContext.Provider value={{ name: props.name }}>\n      <Controller {...props} />\n    </FormFieldContext.Provider>\n  )\n}\n\nconst useFormField = () => {\n  const fieldContext = React.useContext(FormFieldContext)\n  const itemContext = React.useContext(FormItemContext)\n  const { getFieldState, formState } = useFormContext()\n\n  const fieldState = getFieldState(fieldContext.name, formState)\n\n  if (!fieldContext) {\n    throw new Error(\"useFormField should be used within <FormField>\")\n  }\n\n  const { id } = itemContext\n\n  return {\n    id,\n    name: fieldContext.name,\n    formItemId: `${id}-form-item`,\n    formDescriptionId: `${id}-form-item-description`,\n    formMessageId: `${id}-form-item-message`,\n    ...fieldState,\n  }\n}\n\ntype FormItemContextValue = {\n  id: string\n}\n\nconst FormItemContext = React.createContext<FormItemContextValue>(\n  {} as FormItemContextValue\n)\n\nconst FormItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const id = React.useId()\n\n  return (\n    <FormItemContext.Provider value={{ id }}>\n      <div ref={ref} className={cn(\"space-y-2\", className)} {...props} />\n    </FormItemContext.Provider>\n  )\n})\nFormItem.displayName = \"FormItem\"\n\nconst FormLabel = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  const { error, formItemId } = useFormField()\n\n  return (\n    <Label\n      ref={ref}\n      className={cn(error && \"text-destructive\", className)}\n      htmlFor={formItemId}\n      {...props}\n    />\n  )\n})\nFormLabel.displayName = \"FormLabel\"\n\nconst FormControl = React.forwardRef<\n  React.ElementRef<typeof Slot>,\n  React.ComponentPropsWithoutRef<typeof Slot>\n>(({ ...props }, ref) => {\n  const { error, formItemId, formDescriptionId, formMessageId } = useFormField()\n\n  return (\n    <Slot\n      ref={ref}\n      id={formItemId}\n      aria-describedby={\n        !error\n          ? `${formDescriptionId}`\n          : `${formDescriptionId} ${formMessageId}`\n      }\n      aria-invalid={!!error}\n      {...props}\n    />\n  )\n})\nFormControl.displayName = \"FormControl\"\n\nconst FormDescription = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, ...props }, ref) => {\n  const { formDescriptionId } = useFormField()\n\n  return (\n    <p\n      ref={ref}\n      id={formDescriptionId}\n      className={cn(\"text-sm text-muted-foreground\", className)}\n      {...props}\n    />\n  )\n})\nFormDescription.displayName = \"FormDescription\"\n\nconst FormMessage = React.forwardRef<\n  HTMLParagraphElement,\n  React.HTMLAttributes<HTMLParagraphElement>\n>(({ className, children, ...props }, ref) => {\n  const { error, formMessageId } = useFormField()\n  const body = error ? String(error?.message ?? \"\") : children\n\n  if (!body) {\n    return null\n  }\n\n  return (\n    <p\n      ref={ref}\n      id={formMessageId}\n      className={cn(\"text-sm font-medium text-destructive\", className)}\n      {...props}\n    >\n      {body}\n    </p>\n  )\n})\nFormMessage.displayName = \"FormMessage\"\n\nexport {\n  useFormField,\n  Form,\n  FormItem,\n  FormLabel,\n  FormControl,\n  FormDescription,\n  FormMessage,\n  FormField,\n}\n","path":null,"size_bytes":4120,"size_tokens":null},"client/src/components/ui/navigation-menu.tsx":{"content":"import * as React from \"react\"\nimport * as NavigationMenuPrimitive from \"@radix-ui/react-navigation-menu\"\nimport { cva } from \"class-variance-authority\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst NavigationMenu = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative z-10 flex max-w-max flex-1 items-center justify-center\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <NavigationMenuViewport />\n  </NavigationMenuPrimitive.Root>\n))\nNavigationMenu.displayName = NavigationMenuPrimitive.Root.displayName\n\nconst NavigationMenuList = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.List\n    ref={ref}\n    className={cn(\n      \"group flex flex-1 list-none items-center justify-center space-x-1\",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuList.displayName = NavigationMenuPrimitive.List.displayName\n\nconst NavigationMenuItem = NavigationMenuPrimitive.Item\n\nconst navigationMenuTriggerStyle = cva(\n  \"group inline-flex h-10 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium transition-colors hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus:outline-none disabled:pointer-events-none disabled:opacity-50 data-[state=open]:text-accent-foreground data-[state=open]:bg-accent/50 data-[state=open]:hover:bg-accent data-[state=open]:focus:bg-accent\"\n)\n\nconst NavigationMenuTrigger = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <NavigationMenuPrimitive.Trigger\n    ref={ref}\n    className={cn(navigationMenuTriggerStyle(), \"group\", className)}\n    {...props}\n  >\n    {children}{\" \"}\n    <ChevronDown\n      className=\"relative top-[1px] ml-1 h-3 w-3 transition duration-200 group-data-[state=open]:rotate-180\"\n      aria-hidden=\"true\"\n    />\n  </NavigationMenuPrimitive.Trigger>\n))\nNavigationMenuTrigger.displayName = NavigationMenuPrimitive.Trigger.displayName\n\nconst NavigationMenuContent = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Content>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Content\n    ref={ref}\n    className={cn(\n      \"left-0 top-0 w-full data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 md:absolute md:w-auto \",\n      className\n    )}\n    {...props}\n  />\n))\nNavigationMenuContent.displayName = NavigationMenuPrimitive.Content.displayName\n\nconst NavigationMenuLink = NavigationMenuPrimitive.Link\n\nconst NavigationMenuViewport = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Viewport>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Viewport>\n>(({ className, ...props }, ref) => (\n  <div className={cn(\"absolute left-0 top-full flex justify-center\")}>\n    <NavigationMenuPrimitive.Viewport\n      className={cn(\n        \"origin-top-center relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 md:w-[var(--radix-navigation-menu-viewport-width)]\",\n        className\n      )}\n      ref={ref}\n      {...props}\n    />\n  </div>\n))\nNavigationMenuViewport.displayName =\n  NavigationMenuPrimitive.Viewport.displayName\n\nconst NavigationMenuIndicator = React.forwardRef<\n  React.ElementRef<typeof NavigationMenuPrimitive.Indicator>,\n  React.ComponentPropsWithoutRef<typeof NavigationMenuPrimitive.Indicator>\n>(({ className, ...props }, ref) => (\n  <NavigationMenuPrimitive.Indicator\n    ref={ref}\n    className={cn(\n      \"top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in\",\n      className\n    )}\n    {...props}\n  >\n    <div className=\"relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm bg-border shadow-md\" />\n  </NavigationMenuPrimitive.Indicator>\n))\nNavigationMenuIndicator.displayName =\n  NavigationMenuPrimitive.Indicator.displayName\n\nexport {\n  navigationMenuTriggerStyle,\n  NavigationMenu,\n  NavigationMenuList,\n  NavigationMenuItem,\n  NavigationMenuContent,\n  NavigationMenuTrigger,\n  NavigationMenuLink,\n  NavigationMenuIndicator,\n  NavigationMenuViewport,\n}\n","path":null,"size_bytes":5128,"size_tokens":null},"client/src/components/ContractorReviewsModal.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Dialog, DialogContent, DialogHeader, DialogTitle } from \"@/components/ui/dialog\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Separator } from \"@/components/ui/separator\";\nimport { Star, Trash2, Calendar, User, CheckCircle, XCircle, AlertCircle } from \"lucide-react\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { calculateContractorAverageRating } from \"@/utils/reviewUtils\";\nimport type { Contractor, ContractorReview } from \"@shared/schema\";\n\ninterface ContractorReviewsModalProps {\n  contractor: Contractor;\n  isOpen: boolean;\n  onClose: () => void;\n}\n\nconst StarDisplay = ({ rating }: { rating: number }) => (\n  <div className=\"flex gap-1\">\n    {[1, 2, 3, 4, 5].map((star) => (\n      <Star\n        key={star}\n        className={`w-4 h-4 ${\n          star <= rating ? \"fill-yellow-400 text-yellow-400\" : \"text-gray-300\"\n        }`}\n      />\n    ))}\n  </div>\n);\n\nconst BooleanDisplay = ({ value, trueText = \"Yes\", falseText = \"No\" }: { \n  value: boolean; \n  trueText?: string; \n  falseText?: string; \n}) => (\n  <div className=\"flex items-center gap-2\">\n    {value ? (\n      <>\n        <CheckCircle className=\"w-4 h-4 text-green-600\" />\n        <span className=\"text-green-700\">{trueText}</span>\n      </>\n    ) : (\n      <>\n        <XCircle className=\"w-4 h-4 text-red-600\" />\n        <span className=\"text-red-700\">{falseText}</span>\n      </>\n    )}\n  </div>\n);\n\nexport default function ContractorReviewsModal({ \n  contractor, \n  isOpen, \n  onClose \n}: ContractorReviewsModalProps) {\n  const [deletingReviewId, setDeletingReviewId] = useState<number | null>(null);\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n\n  const { data: allReviews = [], isLoading } = useQuery<ContractorReview[]>({\n    queryKey: [\"/api/contractor-reviews\"],\n  });\n\n  const contractorReviews = allReviews.filter(review => review.contractorId === contractor.id);\n  const averageRating = calculateContractorAverageRating(contractorReviews);\n\n  const deleteMutation = useMutation({\n    mutationFn: async (reviewId: number) => {\n      const response = await fetch(`/api/contractor-reviews/${reviewId}`, {\n        method: \"DELETE\",\n      });\n      if (!response.ok) {\n        throw new Error('Failed to delete review');\n      }\n      return response;\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/contractor-reviews\"] });\n      toast({\n        title: \"Review deleted\",\n        description: \"The review has been successfully removed.\",\n      });\n      setDeletingReviewId(null);\n    },\n    onError: (error) => {\n      console.error(\"Error deleting review:\", error);\n      toast({\n        title: \"Error\",\n        description: \"Failed to delete review. Please try again.\",\n        variant: \"destructive\",\n      });\n      setDeletingReviewId(null);\n    },\n  });\n\n  const handleDeleteReview = (reviewId: number) => {\n    if (window.confirm(\"Are you sure you want to delete this review? This action cannot be undone.\")) {\n      setDeletingReviewId(reviewId);\n      deleteMutation.mutate(reviewId);\n    }\n  };\n\n  return (\n    <Dialog open={isOpen} onOpenChange={onClose}>\n      <DialogContent className=\"max-w-4xl max-h-[90vh] overflow-y-auto\">\n        <DialogHeader>\n          <DialogTitle className=\"text-xl\">\n            Reviews for {contractor.company}\n          </DialogTitle>\n          <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n            {contractor.name} • {contractor.category}\n          </p>\n        </DialogHeader>\n\n        {isLoading ? (\n          <div className=\"flex items-center justify-center py-8\">\n            <div className=\"w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full animate-spin\"></div>\n          </div>\n        ) : contractorReviews.length === 0 ? (\n          <div className=\"text-center py-8\">\n            <AlertCircle className=\"w-12 h-12 text-gray-400 mx-auto mb-4\" />\n            <p className=\"text-gray-600 dark:text-gray-400\">\n              No reviews have been submitted for this contractor yet.\n            </p>\n          </div>\n        ) : (\n          <div className=\"space-y-6\">\n            {/* Summary Card */}\n            <Card className=\"bg-blue-50 dark:bg-blue-950 border-blue-200 dark:border-blue-800\">\n              <CardHeader>\n                <CardTitle className=\"text-lg text-blue-900 dark:text-blue-100\">\n                  Review Summary\n                </CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6\">\n                  <div className=\"text-center\">\n                    <div className=\"text-2xl font-bold text-blue-900 dark:text-blue-100\">\n                      {averageRating.averageRating.toFixed(1)}\n                    </div>\n                    <StarDisplay rating={averageRating.averageRating} />\n                    <p className=\"text-sm text-blue-700 dark:text-blue-300 mt-1\">\n                      Overall Rating\n                    </p>\n                  </div>\n                  \n                  <div className=\"text-center\">\n                    <div className=\"text-2xl font-bold text-blue-900 dark:text-blue-100\">\n                      {averageRating.reviewCount}\n                    </div>\n                    <p className=\"text-sm text-blue-700 dark:text-blue-300\">\n                      Total Reviews\n                    </p>\n                  </div>\n                  \n                  <div className=\"text-center\">\n                    <div className=\"text-2xl font-bold text-blue-900 dark:text-blue-100\">\n                      {averageRating.recommendationPercentage}%\n                    </div>\n                    <p className=\"text-sm text-blue-700 dark:text-blue-300\">\n                      Would Recommend\n                    </p>\n                  </div>\n                  \n                  <div className=\"text-center\">\n                    <div className=\"space-y-1\">\n                      <div className=\"text-xs text-blue-700 dark:text-blue-300\">\n                        Communication: {averageRating.communicationAvg.toFixed(1)}\n                      </div>\n                      <div className=\"text-xs text-blue-700 dark:text-blue-300\">\n                        Work Quality: {averageRating.workQualityAvg.toFixed(1)}\n                      </div>\n                      <div className=\"text-xs text-blue-700 dark:text-blue-300\">\n                        Collaboration: {averageRating.collaborationAvg.toFixed(1)}\n                      </div>\n                      <div className=\"text-xs text-blue-700 dark:text-blue-300\">\n                        Documentation: {averageRating.documentationAvg.toFixed(1)}\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n\n            {/* Individual Reviews */}\n            <div className=\"space-y-4\">\n              <h3 className=\"text-lg font-semibold\">Individual Reviews</h3>\n              {contractorReviews.map((review) => (\n                <Card key={review.id} className=\"relative\">\n                  <CardHeader>\n                    <div className=\"flex justify-between items-start\">\n                      <div>\n                        <CardTitle className=\"text-base flex items-center gap-2\">\n                          <User className=\"w-4 h-4\" />\n                          {review.submitterName}\n                        </CardTitle>\n                        <p className=\"text-sm text-gray-600 dark:text-gray-400 flex items-center gap-1 mt-1\">\n                          <Calendar className=\"w-3 h-3\" />\n                          {new Date(review.createdAt).toLocaleDateString()}\n                        </p>\n                      </div>\n                      <Button\n                        variant=\"ghost\"\n                        size=\"sm\"\n                        onClick={() => handleDeleteReview(review.id)}\n                        disabled={deletingReviewId === review.id}\n                        className=\"text-red-600 hover:text-red-700 hover:bg-red-50\"\n                      >\n                        {deletingReviewId === review.id ? (\n                          <div className=\"w-4 h-4 border-2 border-red-500 border-t-transparent rounded-full animate-spin\" />\n                        ) : (\n                          <Trash2 className=\"w-4 h-4\" />\n                        )}\n                      </Button>\n                    </div>\n                  </CardHeader>\n                  <CardContent className=\"space-y-4\">\n                    {/* Ratings */}\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\n                      <div>\n                        <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                          Communication\n                        </p>\n                        <StarDisplay rating={review.communicationRating} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                          Work Quality\n                        </p>\n                        <StarDisplay rating={review.workQualityRating} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                          Collaboration\n                        </p>\n                        <StarDisplay rating={review.collaborationRating} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                          Documentation\n                        </p>\n                        <StarDisplay rating={review.documentationRating} />\n                      </div>\n                    </div>\n\n                    <Separator />\n\n                    {/* Boolean Questions */}\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4\">\n                      <div>\n                        <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                          Had Conflicts\n                        </p>\n                        <BooleanDisplay value={review.hadConflicts} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                          Met Safety Standards\n                        </p>\n                        <BooleanDisplay value={review.metSafetyStandards} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                          Adhered to Schedule\n                        </p>\n                        <BooleanDisplay value={review.adheredToSchedule} />\n                      </div>\n                      <div>\n                        <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\n                          Would Recommend\n                        </p>\n                        <BooleanDisplay value={review.wouldRecommend} />\n                      </div>\n                    </div>\n\n                    {/* Text Responses */}\n                    {(review.strengths || review.improvementAreas || review.conflictDetails || \n                      review.safetyIssues || review.scheduleIssues || review.additionalComments) && (\n                      <>\n                        <Separator />\n                        <div className=\"space-y-3\">\n                          {review.strengths && (\n                            <div>\n                              <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                                Strengths\n                              </p>\n                              <p className=\"text-sm text-gray-600 dark:text-gray-400 bg-green-50 dark:bg-green-950 p-2 rounded\">\n                                {review.strengths}\n                              </p>\n                            </div>\n                          )}\n                          \n                          {review.improvementAreas && (\n                            <div>\n                              <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                                Areas for Improvement\n                              </p>\n                              <p className=\"text-sm text-gray-600 dark:text-gray-400 bg-yellow-50 dark:bg-yellow-950 p-2 rounded\">\n                                {review.improvementAreas}\n                              </p>\n                            </div>\n                          )}\n                          \n                          {review.conflictDetails && (\n                            <div>\n                              <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                                Conflict Details\n                              </p>\n                              <p className=\"text-sm text-gray-600 dark:text-gray-400 bg-red-50 dark:bg-red-950 p-2 rounded\">\n                                {review.conflictDetails}\n                              </p>\n                            </div>\n                          )}\n                          \n                          {review.safetyIssues && (\n                            <div>\n                              <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                                Safety Issues\n                              </p>\n                              <p className=\"text-sm text-gray-600 dark:text-gray-400 bg-red-50 dark:bg-red-950 p-2 rounded\">\n                                {review.safetyIssues}\n                              </p>\n                            </div>\n                          )}\n                          \n                          {review.scheduleIssues && (\n                            <div>\n                              <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                                Schedule Issues\n                              </p>\n                              <p className=\"text-sm text-gray-600 dark:text-gray-400 bg-orange-50 dark:bg-orange-950 p-2 rounded\">\n                                {review.scheduleIssues}\n                              </p>\n                            </div>\n                          )}\n                          \n                          {review.additionalComments && (\n                            <div>\n                              <p className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-1\">\n                                Additional Comments\n                              </p>\n                              <p className=\"text-sm text-gray-600 dark:text-gray-400 bg-gray-50 dark:bg-gray-800 p-2 rounded\">\n                                {review.additionalComments}\n                              </p>\n                            </div>\n                          )}\n                        </div>\n                      </>\n                    )}\n                  </CardContent>\n                </Card>\n              ))}\n            </div>\n          </div>\n        )}\n      </DialogContent>\n    </Dialog>\n  );\n}","path":null,"size_bytes":15698,"size_tokens":null},"client/src/pages/utility-admin.tsx":{"content":"import { useState } from \"react\";\nimport { Button } from \"@/components/ui/button\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Upload, FileText, CheckCircle, AlertCircle } from \"lucide-react\";\nimport { apiRequest, queryClient } from \"@/lib/queryClient\";\n\nexport default function UtilityAdmin() {\n  const [geojsonData, setGeojsonData] = useState(\"\");\n  const [isUploading, setIsUploading] = useState(false);\n  const [uploadStatus, setUploadStatus] = useState<{\n    success: boolean;\n    message: string;\n    featureCount?: number;\n  } | null>(null);\n  const { toast } = useToast();\n\n  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (!file) return;\n\n    const reader = new FileReader();\n    reader.onload = (e) => {\n      const content = e.target?.result as string;\n      setGeojsonData(content);\n    };\n    reader.readAsText(file);\n  };\n\n  const validateGeoJSON = (data: string) => {\n    try {\n      const parsed = JSON.parse(data);\n      if (parsed.type !== \"FeatureCollection\") {\n        throw new Error(\"Must be a FeatureCollection\");\n      }\n      if (!Array.isArray(parsed.features)) {\n        throw new Error(\"Must have features array\");\n      }\n      if (parsed.features.length === 0) {\n        throw new Error(\"Must contain at least one feature\");\n      }\n      \n      // Check first few features for required properties\n      const missingProps = parsed.features.slice(0, 5).filter((feature: any) => {\n        return !feature.geometry || !feature.properties || \n               (!feature.properties.NAME && !feature.properties.name && !feature.properties.COMPANY);\n      });\n      \n      if (missingProps.length > 0) {\n        throw new Error(\"Features must have geometry and properties with NAME, name, or COMPANY field\");\n      }\n      \n      return { valid: true, featureCount: parsed.features.length };\n    } catch (error) {\n      return { \n        valid: false, \n        error: error instanceof Error ? error.message : \"Invalid JSON format\" \n      };\n    }\n  };\n\n  const handleUpload = async () => {\n    if (!geojsonData.trim()) {\n      toast({\n        title: \"No data provided\",\n        description: \"Please paste GeoJSON data or upload a file\",\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    const validation = validateGeoJSON(geojsonData);\n    if (!validation.valid) {\n      toast({\n        title: \"Invalid GeoJSON\",\n        description: validation.error,\n        variant: \"destructive\"\n      });\n      return;\n    }\n\n    setIsUploading(true);\n    setUploadStatus(null);\n\n    try {\n      const response = await fetch(\"/api/weather/electric-utilities\", {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\"\n        },\n        body: geojsonData\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const result = await response.json();\n\n      setUploadStatus({\n        success: true,\n        message: result.message,\n        featureCount: result.featureCount\n      });\n\n      // Invalidate utilities cache to force refresh\n      queryClient.invalidateQueries({ queryKey: ['/api/weather/electric-utilities'] });\n\n      toast({\n        title: \"Upload successful\",\n        description: `${result.featureCount} electric utility service areas uploaded. Map will refresh automatically.`,\n      });\n\n    } catch (error) {\n      const errorMessage = error instanceof Error ? error.message : \"Upload failed\";\n      setUploadStatus({\n        success: false,\n        message: errorMessage\n      });\n\n      toast({\n        title: \"Upload failed\",\n        description: errorMessage,\n        variant: \"destructive\"\n      });\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  const exampleGeoJSON = `{\n  \"type\": \"FeatureCollection\",\n  \"features\": [\n    {\n      \"type\": \"Feature\",\n      \"properties\": {\n        \"NAME\": \"Florida Power & Light\",\n        \"CUSTOMERS\": 5100000,\n        \"COMPANY\": \"FPL\"\n      },\n      \"geometry\": {\n        \"type\": \"Polygon\",\n        \"coordinates\": [[\n          [-87.6, 24.5], [-80.0, 24.5], [-80.0, 31.0], [-87.6, 31.0], [-87.6, 24.5]\n        ]]\n      }\n    },\n    {\n      \"type\": \"Feature\",\n      \"properties\": {\n        \"NAME\": \"Duke Energy Carolinas\",\n        \"CUSTOMERS\": 2800000\n      },\n      \"geometry\": {\n        \"type\": \"Polygon\",\n        \"coordinates\": [[\n          [-84.3, 32.0], [-75.4, 32.0], [-75.4, 39.7], [-84.3, 39.7], [-84.3, 32.0]\n        ]]\n      }\n    },\n    {\n      \"type\": \"Feature\",\n      \"properties\": {\n        \"NAME\": \"Commonwealth Edison (ComEd)\",\n        \"CUSTOMERS\": 4000000\n      },\n      \"geometry\": {\n        \"type\": \"Polygon\",\n        \"coordinates\": [[\n          [-88.3, 41.6], [-87.5, 41.6], [-87.5, 42.5], [-88.3, 42.5], [-88.3, 41.6]\n        ]]\n      }\n    }\n  ]\n}`;\n\n  return (\n    <div className=\"container mx-auto p-6 max-w-4xl\">\n      <div className=\"mb-6\">\n        <h1 className=\"text-2xl font-bold\">Electric Utility Data Management</h1>\n        <p className=\"text-muted-foreground mt-2\">\n          Upload custom electric utility service area data in GeoJSON format\n        </p>\n      </div>\n\n      <div className=\"grid gap-6\">\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Upload className=\"h-5 w-5\" />\n              Upload Utility Data\n            </CardTitle>\n            <CardDescription>\n              Provide electric utility service areas as GeoJSON. This will replace the default fallback data.\n            </CardDescription>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div>\n              <label className=\"block text-sm font-medium mb-2\">\n                Upload GeoJSON File\n              </label>\n              <input\n                type=\"file\"\n                accept=\".json,.geojson\"\n                onChange={handleFileUpload}\n                className=\"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100\"\n              />\n            </div>\n\n            <div className=\"text-center text-muted-foreground\">or</div>\n\n            <div>\n              <label className=\"block text-sm font-medium mb-2\">\n                Paste GeoJSON Data\n              </label>\n              <Textarea\n                placeholder=\"Paste your GeoJSON FeatureCollection here...\"\n                value={geojsonData}\n                onChange={(e) => setGeojsonData(e.target.value)}\n                className=\"min-h-[300px] font-mono text-sm\"\n              />\n            </div>\n\n            <Button \n              onClick={handleUpload} \n              disabled={isUploading || !geojsonData.trim()}\n              className=\"w-full\"\n            >\n              {isUploading ? \"Uploading...\" : \"Upload Utility Data\"}\n            </Button>\n\n            {uploadStatus && (\n              <div className={`flex items-center gap-2 p-3 rounded-lg ${\n                uploadStatus.success \n                  ? \"bg-green-50 text-green-700 border border-green-200\" \n                  : \"bg-red-50 text-red-700 border border-red-200\"\n              }`}>\n                {uploadStatus.success ? (\n                  <CheckCircle className=\"h-5 w-5\" />\n                ) : (\n                  <AlertCircle className=\"h-5 w-5\" />\n                )}\n                <div>\n                  <div className=\"font-medium\">\n                    {uploadStatus.success ? \"Success\" : \"Error\"}\n                  </div>\n                  <div className=\"text-sm\">\n                    {uploadStatus.message}\n                    {uploadStatus.featureCount && ` (${uploadStatus.featureCount} utilities)`}\n                  </div>\n                </div>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <FileText className=\"h-5 w-5\" />\n              GeoJSON Format Requirements\n            </CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3\">\n            <div className=\"text-sm space-y-2\">\n              <p><strong>Required Structure:</strong></p>\n              <ul className=\"list-disc list-inside space-y-1 text-muted-foreground\">\n                <li>Must be a FeatureCollection with features array</li>\n                <li>Each feature must have geometry (Polygon/MultiPolygon)</li>\n                <li>Each feature must have properties object</li>\n                <li>Properties must include one of: NAME, name, or COMPANY</li>\n                <li>Optional: CUSTOMERS, Customers, or customers field for customer count</li>\n              </ul>\n            </div>\n\n            <details className=\"mt-4\">\n              <summary className=\"cursor-pointer font-medium\">View Example GeoJSON</summary>\n              <pre className=\"mt-2 p-3 bg-gray-50 rounded text-xs overflow-auto max-h-60\">\n                {exampleGeoJSON}\n              </pre>\n            </details>\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}","path":null,"size_bytes":9353,"size_tokens":null},"server/index.ts":{"content":"import express, { type Request, Response, NextFunction } from \"express\";\nimport { registerRoutes } from \"./routes\";\nimport { setupVite, serveStatic, log } from \"./vite\";\nimport { setupAuth } from \"./replitAuth\";\n\nconst app = express();\napp.use(express.json({ limit: '10mb' }));\napp.use(express.urlencoded({ extended: false, limit: '10mb' }));\n\napp.use((req, res, next) => {\n  const start = Date.now();\n  const path = req.path;\n  let capturedJsonResponse: Record<string, any> | undefined = undefined;\n\n  const originalResJson = res.json;\n  res.json = function (bodyJson, ...args) {\n    capturedJsonResponse = bodyJson;\n    return originalResJson.apply(res, [bodyJson, ...args]);\n  };\n\n  res.on(\"finish\", () => {\n    const duration = Date.now() - start;\n    if (path.startsWith(\"/api\")) {\n      let logLine = `${req.method} ${path} ${res.statusCode} in ${duration}ms`;\n      if (capturedJsonResponse) {\n        logLine += ` :: ${JSON.stringify(capturedJsonResponse)}`;\n      }\n\n      if (logLine.length > 80) {\n        logLine = logLine.slice(0, 79) + \"…\";\n      }\n\n      log(logLine);\n    }\n  });\n\n  next();\n});\n\n(async () => {\n  try {\n    // Setup Replit Auth (must be before registerRoutes)\n    await setupAuth(app);\n    \n    const server = await registerRoutes(app);\n\n    app.use((err: any, _req: Request, res: Response, _next: NextFunction) => {\n      const status = err.status || err.statusCode || 500;\n      const message = err.message || \"Internal Server Error\";\n      \n      console.error('Express error:', err);\n      res.status(status).json({ message });\n    });\n\n    // importantly only setup vite in development and after\n    // setting up all the other routes so the catch-all route\n    // doesn't interfere with the other routes\n    if (app.get(\"env\") === \"development\") {\n      await setupVite(app, server);\n    } else {\n      serveStatic(app);\n    }\n\n    // ALWAYS serve the app on port 5000\n    // this serves both the API and the client.\n    // It is the only port that is not firewalled.\n    const port = 5000;\n    server.listen({\n      port,\n      host: \"0.0.0.0\",\n      reusePort: true,\n    }, () => {\n      log(`serving on port ${port}`);\n    });\n  } catch (error) {\n    console.error('Failed to start server:', error);\n    process.exit(1);\n  }\n})();\n","path":null,"size_bytes":2274,"size_tokens":null},"client/src/lib/utils.ts":{"content":"import { clsx, type ClassValue } from \"clsx\"\nimport { twMerge } from \"tailwind-merge\"\n\nexport function cn(...inputs: ClassValue[]) {\n  return twMerge(clsx(inputs))\n}\n","path":null,"size_bytes":166,"size_tokens":null},"client/src/components/ui/scroll-area.tsx":{"content":"import * as React from \"react\"\nimport * as ScrollAreaPrimitive from \"@radix-ui/react-scroll-area\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst ScrollArea = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.Root>\n>(({ className, children, ...props }, ref) => (\n  <ScrollAreaPrimitive.Root\n    ref={ref}\n    className={cn(\"relative overflow-hidden\", className)}\n    {...props}\n  >\n    <ScrollAreaPrimitive.Viewport className=\"h-full w-full rounded-[inherit]\">\n      {children}\n    </ScrollAreaPrimitive.Viewport>\n    <ScrollBar />\n    <ScrollAreaPrimitive.Corner />\n  </ScrollAreaPrimitive.Root>\n))\nScrollArea.displayName = ScrollAreaPrimitive.Root.displayName\n\nconst ScrollBar = React.forwardRef<\n  React.ElementRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>,\n  React.ComponentPropsWithoutRef<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>\n>(({ className, orientation = \"vertical\", ...props }, ref) => (\n  <ScrollAreaPrimitive.ScrollAreaScrollbar\n    ref={ref}\n    orientation={orientation}\n    className={cn(\n      \"flex touch-none select-none transition-colors\",\n      orientation === \"vertical\" &&\n        \"h-full w-2.5 border-l border-l-transparent p-[1px]\",\n      orientation === \"horizontal\" &&\n        \"h-2.5 flex-col border-t border-t-transparent p-[1px]\",\n      className\n    )}\n    {...props}\n  >\n    <ScrollAreaPrimitive.ScrollAreaThumb className=\"relative flex-1 rounded-full bg-border\" />\n  </ScrollAreaPrimitive.ScrollAreaScrollbar>\n))\nScrollBar.displayName = ScrollAreaPrimitive.ScrollAreaScrollbar.displayName\n\nexport { ScrollArea, ScrollBar }\n","path":null,"size_bytes":1642,"size_tokens":null},"client/src/pages/contractors.tsx":{"content":"import { useState, useRef } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Trash2, Edit, Plus, Star, CloudUpload, FileArchive, Upload, MapPin, ArrowUpDown, ArrowUp, ArrowDown, Paperclip, Download, X, ClipboardList, Eye, Link2 } from \"lucide-react\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { Contractor, InsertContractor, ContractorReview } from \"@shared/schema\";\nimport { Link } from \"wouter\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport AppHeader from \"@/components/AppHeader\";\nimport ContractorReviewFlow from \"@/components/ContractorReviewFlow\";\nimport ContractorReviewsModal from \"@/components/ContractorReviewsModal\";\nimport { calculateContractorAverageRating } from \"@/utils/reviewUtils\";\n\nconst categories = [\"Union\", \"Non-Union\", \"Veg\", \"HVAC\", \"DAT\", \"Consulting\"];\nconst statuses = [\"Completed\", \"Unfinished\"];\nconst avettaStatuses = [\"Yes\", \"No\", \"N/A\"];\nconst msaStatuses = [\n  { value: \"none\", label: \"No Status\" },\n  { value: \"Executed\", label: \"Executed\" },\n  { value: \"Redlines Returned\", label: \"Redlines Returned\" },\n  { value: \"NDA Signed\", label: \"NDA Signed\" },\n  { value: \"Signed Not Exe\", label: \"Signed Not Exe\" }\n];\n\ntype SortField = 'name' | 'company' | 'category' | 'rating' | 'city' | 'state' | 'pipefile' | 'avetta' | 'isnComplete' | 'newMsaComplete';\ntype SortDirection = 'asc' | 'desc';\n\nexport default function ContractorsPage() {\n  const [editingContractor, setEditingContractor] = useState<Contractor | null>(null);\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [isImportDialogOpen, setIsImportDialogOpen] = useState(false);\n  const [isReviewFlowOpen, setIsReviewFlowOpen] = useState(false);\n  const [reviewsModalContractor, setReviewsModalContractor] = useState<Contractor | null>(null);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [categoryFilter, setCategoryFilter] = useState(\"all\");\n  const [sortField, setSortField] = useState<SortField>('company');\n  const [sortDirection, setSortDirection] = useState<SortDirection>('asc');\n  const [isDragOver, setIsDragOver] = useState(false);\n  const [isUploading, setIsUploading] = useState(false);\n  const [contractorFiles, setContractorFiles] = useState<any[]>([]);\n  const [uploadingFile, setUploadingFile] = useState(false);\n  const [activeTab, setActiveTab] = useState<'all' | 'pending'>('all');\n  const [mergeDialogOpen, setMergeDialogOpen] = useState(false);\n  const [mergeSourceId, setMergeSourceId] = useState<number | null>(null);\n  const [mergeTargetId, setMergeTargetId] = useState<string>(\"\");\n  const [mergeSearchTerm, setMergeSearchTerm] = useState(\"\");\n  const [locationsDialogOpen, setLocationsDialogOpen] = useState(false);\n  const [locationsContractor, setLocationsContractor] = useState<Contractor | null>(null);\n  const [newLocationAddress, setNewLocationAddress] = useState(\"\");\n  const [isGeocodingLocation, setIsGeocodingLocation] = useState(false);\n  const [mergeStep, setMergeStep] = useState<'select' | 'review'>('select');\n  const [mergedEmails, setMergedEmails] = useState<string[]>([]);\n  const [mergedPhones, setMergedPhones] = useState<string[]>([]);\n  const [mergedNames, setMergedNames] = useState<string[]>([]);\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const contractorFileInputRef = useRef<HTMLInputElement>(null);\n  const { toast} = useToast();\n  const queryClient = useQueryClient();\n  const { user, logout } = useAuth();\n\n  // Export all contractors function\n  const exportAllContractors = async () => {\n    try {\n      const response = await fetch('/api/contractors/export');\n      \n      if (!response.ok) {\n        throw new Error('Export failed');\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.style.display = 'none';\n      a.href = url;\n      \n      const today = new Date().toISOString().slice(0, 10);\n      a.download = `contractors_export_${today}.xlsx`;\n      \n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"Export Successful\",\n        description: `${contractors.length} contractors exported to Excel`,\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Could not export contractors\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  const { data: contractors = [], isLoading } = useQuery<Contractor[]>({\n    queryKey: [\"/api/contractors\"],\n  });\n\n  const { data: allReviews = [] } = useQuery<ContractorReview[]>({\n    queryKey: [\"/api/contractor-reviews\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: InsertContractor) => apiRequest(\"POST\", \"/api/contractors\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/contractors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/resources\"] });\n      setIsDialogOpen(false);\n      setEditingContractor(null);\n      toast({ description: \"Contractor saved successfully\" });\n    },\n    onError: () => {\n      toast({ description: \"Failed to save contractor\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: number; data: Partial<InsertContractor> }) =>\n      apiRequest(\"PUT\", `/api/contractors/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/contractors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/resources\"] });\n      setIsDialogOpen(false);\n      setEditingContractor(null);\n      toast({ description: \"Contractor updated successfully\" });\n    },\n    onError: (error: any) => {\n      console.error(\"Update error:\", error);\n      toast({ \n        description: `Failed to update contractor: ${error?.message || 'Unknown error'}`, \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: number) => apiRequest(\"DELETE\", `/api/contractors/${id}`),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/contractors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/resources\"] });\n      toast({ description: \"Contractor deleted successfully\" });\n    },\n    onError: () => {\n      toast({ description: \"Failed to delete contractor\", variant: \"destructive\" });\n    },\n  });\n\n  const updateLocationsMutation = useMutation({\n    mutationFn: ({ contractorId, locations }: { contractorId: number, locations: Array<{location: string, latitude: number | null, longitude: number | null}> }) =>\n      apiRequest(\"PUT\", `/api/contractors/${contractorId}/departure-locations`, { locations }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/contractors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/crew-availability\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/resources\"] });\n      toast({ description: \"Departure locations updated successfully\" });\n    },\n    onError: () => {\n      toast({ description: \"Failed to update departure locations\", variant: \"destructive\" });\n    },\n  });\n\n  const mergeMutation = useMutation({\n    mutationFn: ({ sourceId, targetId, mergedData }: { sourceId: number; targetId: number; mergedData: any }) =>\n      apiRequest(\"POST\", \"/api/contractors/merge\", { sourceId, targetId, mergedData }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/contractors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/resources\"] });\n      setMergeDialogOpen(false);\n      setMergeSourceId(null);\n      setMergeTargetId(\"\");\n      setMergeSearchTerm(\"\");\n      setMergeStep('select');\n      setMergedEmails([]);\n      setMergedPhones([]);\n      setMergedNames([]);\n      toast({ \n        title: \"Success\",\n        description: \"Contractors merged successfully\" \n      });\n    },\n    onError: (error: any) => {\n      toast({ \n        title: \"Merge Failed\",\n        description: error?.message || \"Failed to merge contractors\", \n        variant: \"destructive\" \n      });\n    },\n  });\n\n  // Function to prepare merged data when target is selected\n  const prepareMergeData = () => {\n    if (!mergeSourceId || !mergeTargetId) return;\n    \n    const source = contractors.find(c => c.id === mergeSourceId);\n    const target = contractors.find(c => c.id === parseInt(mergeTargetId));\n    \n    if (!source || !target) return;\n    \n    // Parse and merge emails (support both semicolon and comma separators)\n    const sourceEmails = (source.email || '').split(/[;,]/).map(e => e.trim()).filter(e => e);\n    const targetEmails = (target.email || '').split(/[;,]/).map(e => e.trim()).filter(e => e);\n    const allEmails = Array.from(new Set([...targetEmails, ...sourceEmails]));\n    setMergedEmails(allEmails.length > 0 ? allEmails : ['']);\n    \n    // Parse and merge phones (support both semicolon and comma separators)\n    const sourcePhones = (source.phone || '').split(/[;,]/).map(p => p.trim()).filter(p => p);\n    const targetPhones = (target.phone || '').split(/[;,]/).map(p => p.trim()).filter(p => p);\n    const allPhones = Array.from(new Set([...targetPhones, ...sourcePhones]));\n    setMergedPhones(allPhones.length > 0 ? allPhones : ['']);\n    \n    // Parse and merge names\n    const sourceNames = source.name.split(',').map(n => n.trim()).filter(n => n);\n    const targetNames = target.name.split(',').map(n => n.trim()).filter(n => n);\n    const allNames = Array.from(new Set([...targetNames, ...sourceNames]));\n    setMergedNames(allNames.length > 0 ? allNames : [target.name]);\n    \n    setMergeStep('review');\n  };\n\n  const ratingMutation = useMutation({\n    mutationFn: ({ id, rating }: { id: number; rating: number }) =>\n      apiRequest(\"PUT\", `/api/contractors/${id}`, { rating }),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/contractors\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/resources\"] });\n    },\n    onError: () => {\n      toast({ description: \"Failed to update rating\", variant: \"destructive\" });\n    },\n  });\n\n  const uploadFileMutation = useMutation({\n    mutationFn: ({ contractorId, file }: { contractorId: number; file: File }) => {\n      const formData = new FormData();\n      formData.append('file', file);\n      return fetch(`/api/contractors/${contractorId}/files`, {\n        method: 'POST',\n        body: formData,\n      });\n    },\n    onSuccess: () => {\n      toast({ description: \"File uploaded successfully\" });\n      if (editingContractor) {\n        loadContractorFiles(editingContractor.id);\n      }\n    },\n    onError: () => {\n      toast({ description: \"Failed to upload file\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteFileMutation = useMutation({\n    mutationFn: (fileId: number) => apiRequest(\"DELETE\", `/api/contractor-files/${fileId}`),\n    onSuccess: () => {\n      toast({ description: \"File deleted successfully\" });\n      if (editingContractor) {\n        loadContractorFiles(editingContractor.id);\n      }\n    },\n    onError: () => {\n      toast({ description: \"Failed to delete file\", variant: \"destructive\" });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const formData = new FormData(e.currentTarget);\n    \n    const contractorData: InsertContractor = {\n      name: formData.get(\"name\") as string,\n      company: formData.get(\"company\") as string,\n      email: formData.get(\"email\") as string,\n      phone: formData.get(\"phone\") as string,\n      category: formData.get(\"category\") as string,\n      city: formData.get(\"city\") as string,\n      state: formData.get(\"state\") as string,\n      fullAddress: formData.get(\"fullAddress\") as string,\n      latitude: formData.get(\"latitude\") ? parseFloat(formData.get(\"latitude\") as string) : null,\n      longitude: formData.get(\"longitude\") ? parseFloat(formData.get(\"longitude\") as string) : null,\n      pipefile: formData.get(\"pipefile\") as string,\n      avetta: formData.get(\"avetta\") as string,\n      isnComplete: formData.get(\"isnComplete\") === \"Yes\",\n      subRanking: formData.get(\"subRanking\") as string || \"\",\n      fteCountsPerLocation: formData.get(\"fteCountsPerLocation\") as string,\n      pipefileUpdates: formData.get(\"pipefileUpdates\") as string,\n      birdRep: formData.get(\"birdRep\") as string,\n      notes: formData.get(\"notes\") as string,\n      newMsaComplete: formData.get(\"newMsaComplete\") === \"none\" ? \"\" : formData.get(\"newMsaComplete\") as string || \"\",\n      rating: formData.get(\"rating\") ? parseFloat(formData.get(\"rating\") as string) : 0,\n    };\n\n    console.log(\"Submitting contractor data:\", contractorData);\n    console.log(\"Editing contractor:\", editingContractor);\n\n    if (editingContractor) {\n      console.log(\"Updating contractor with ID:\", editingContractor.id);\n      updateMutation.mutate({ id: editingContractor.id, data: contractorData });\n    } else {\n      console.log(\"Creating new contractor\");\n      createMutation.mutate(contractorData);\n    }\n  };\n\n  const handleEdit = (contractor: Contractor) => {\n    setEditingContractor(contractor);\n    setIsDialogOpen(true);\n    loadContractorFiles(contractor.id);\n  };\n\n  const loadContractorFiles = async (contractorId: number) => {\n    try {\n      const response = await fetch(`/api/contractors/${contractorId}/files`);\n      if (response.ok) {\n        const files = await response.json();\n        setContractorFiles(files);\n      }\n    } catch (error) {\n      console.error('Failed to load contractor files:', error);\n    }\n  };\n\n  const handleFileUploadForContractor = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file && editingContractor) {\n      setUploadingFile(true);\n      uploadFileMutation.mutate({ contractorId: editingContractor.id, file }, {\n        onSettled: () => setUploadingFile(false)\n      });\n    }\n  };\n\n  const handleDeleteFile = (fileId: number) => {\n    if (window.confirm(\"Are you sure you want to delete this file?\")) {\n      deleteFileMutation.mutate(fileId);\n    }\n  };\n\n  const formatFileSize = (bytes: number) => {\n    if (bytes === 0) return '0 Bytes';\n    const k = 1024;\n    const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n    const i = Math.floor(Math.log(bytes) / Math.log(k));\n    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n  };\n\n  const handleDelete = (id: number) => {\n    if (window.confirm(\"Are you sure you want to delete this contractor?\")) {\n      deleteMutation.mutate(id);\n    }\n  };\n\n  const handleManageLocations = (contractor: Contractor) => {\n    setLocationsContractor(contractor);\n    setLocationsDialogOpen(true);\n    setNewLocationAddress(\"\");\n  };\n\n  const handleAddLocation = async () => {\n    if (!newLocationAddress.trim() || !locationsContractor) return;\n    \n    setIsGeocodingLocation(true);\n    try {\n      const response = await fetch('/api/geocode', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify({ location: newLocationAddress }),\n      });\n      \n      if (!response.ok) throw new Error('Geocoding failed');\n      \n      const data = await response.json();\n      \n      if (!data.success) {\n        toast({ \n          description: data.message || \"Failed to geocode location\", \n          variant: \"destructive\" \n        });\n        setIsGeocodingLocation(false);\n        return;\n      }\n      \n      const currentLocations = (locationsContractor.departureLocations as any) || [];\n      \n      const newLocations = [\n        ...currentLocations,\n        {\n          location: newLocationAddress,\n          latitude: data.latitude,\n          longitude: data.longitude\n        }\n      ];\n      \n      await updateLocationsMutation.mutateAsync({\n        contractorId: locationsContractor.id,\n        locations: newLocations\n      });\n      \n      setNewLocationAddress(\"\");\n      queryClient.invalidateQueries({ queryKey: [\"/api/contractors\"] });\n      const updatedContractor = await queryClient.fetchQuery({ queryKey: [\"/api/contractors\"] });\n      const updated = Array.isArray(updatedContractor) ? updatedContractor.find((c: any) => c.id === locationsContractor.id) : null;\n      if (updated) setLocationsContractor(updated);\n    } catch (error) {\n      console.error('Geocoding error:', error);\n      toast({ description: \"Failed to add location\", variant: \"destructive\" });\n    } finally {\n      setIsGeocodingLocation(false);\n    }\n  };\n\n  const handleRemoveLocation = async (index: number) => {\n    if (!locationsContractor) return;\n    \n    const currentLocations = (locationsContractor.departureLocations as any) || [];\n    const newLocations = currentLocations.filter((_: any, i: number) => i !== index);\n    \n    await updateLocationsMutation.mutateAsync({\n      contractorId: locationsContractor.id,\n      locations: newLocations\n    });\n    \n    queryClient.invalidateQueries({ queryKey: [\"/api/contractors\"] });\n    const updatedContractor = await queryClient.fetchQuery({ queryKey: [\"/api/contractors\"] });\n    const updated = Array.isArray(updatedContractor) ? updatedContractor.find((c: any) => c.id === locationsContractor.id) : null;\n    if (updated) setLocationsContractor(updated);\n  };\n\n  const handleRating = (contractorId: number, rating: number) => {\n    ratingMutation.mutate({ id: contractorId, rating });\n  };\n\n  const handleSort = (field: SortField) => {\n    setSortField(field);\n    // Keep current direction when changing fields\n  };\n\n  const getSortIcon = (field: SortField) => {\n    if (sortField !== field) {\n      return <ArrowUpDown className=\"w-4 h-4 text-gray-400\" />;\n    }\n    return sortDirection === 'asc' ? \n      <ArrowUp className=\"w-4 h-4 text-blue-600\" /> : \n      <ArrowDown className=\"w-4 h-4 text-blue-600\" />;\n  };\n\n  // File upload handlers\n  const handleFileUpload = async (file: File) => {\n    if (!file) return;\n\n    const formData = new FormData();\n    formData.append('file', file);\n\n    setIsUploading(true);\n    try {\n      const response = await fetch('/api/upload-file', {\n        method: 'POST',\n        body: formData,\n      });\n\n      if (!response.ok) {\n        throw new Error('Upload failed');\n      }\n\n      const result = await response.json();\n      \n      // Poll for job completion\n      const pollJob = async (jobId: number) => {\n        const jobResponse = await fetch(`/api/jobs/${jobId}`);\n        const job = await jobResponse.json();\n        \n        if (job.status === 'completed') {\n          toast({ description: `Successfully imported ${job.resourceCount} contractors from ${file.name}` });\n          queryClient.invalidateQueries({ queryKey: [\"/api/contractors\"] });\n          queryClient.invalidateQueries({ queryKey: [\"/api/resources\"] });\n        } else if (job.status === 'failed') {\n          throw new Error(job.error || 'Import failed');\n        } else {\n          // Still processing, poll again in 1 second\n          setTimeout(() => pollJob(jobId), 1000);\n        }\n      };\n      \n      await pollJob(result.jobId);\n    } catch (error) {\n      toast({ \n        description: `Failed to upload file: ${error instanceof Error ? error.message : 'Unknown error'}`, \n        variant: \"destructive\" \n      });\n    } finally {\n      setIsUploading(false);\n    }\n  };\n\n  const handleFileInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {\n    const file = e.target.files?.[0];\n    if (file) {\n      handleFileUpload(file);\n    }\n  };\n\n  const handleDragOver = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(true);\n  };\n\n  const handleDragLeave = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n  };\n\n  const handleDrop = (e: React.DragEvent) => {\n    e.preventDefault();\n    setIsDragOver(false);\n    \n    const file = e.dataTransfer.files[0];\n    if (file) {\n      handleFileUpload(file);\n    }\n  };\n\n  const StarRating = ({ contractorId }: { contractorId: number }) => {\n    const contractorReviews = allReviews.filter(review => review.contractorId === contractorId);\n    const averageRating = calculateContractorAverageRating(contractorReviews);\n    \n    if (averageRating.reviewCount === 0) {\n      return (\n        <div className=\"flex gap-1 items-center\">\n          {[1, 2, 3, 4, 5].map((star) => (\n            <Star key={star} className=\"w-4 h-4 text-gray-300\" />\n          ))}\n          <span className=\"text-xs text-gray-500 ml-1\">No reviews yet</span>\n        </div>\n      );\n    }\n\n    return (\n      <div className=\"flex gap-1 items-center\">\n        {[1, 2, 3, 4, 5].map((star) => {\n          const isFilled = star <= averageRating.averageRating;\n          const isPartial = star > averageRating.averageRating && star - 1 < averageRating.averageRating;\n          \n          return (\n            <Star\n              key={star}\n              className={`w-4 h-4 ${\n                isFilled ? \"fill-red-500 text-red-500\" : \n                isPartial ? \"fill-red-300 text-red-300\" : \"text-gray-300\"\n              }`}\n            />\n          );\n        })}\n        <span className=\"text-xs text-gray-500 ml-1\">\n          ({averageRating.averageRating.toFixed(1)}) - {averageRating.reviewCount} review{averageRating.reviewCount !== 1 ? 's' : ''}\n        </span>\n      </div>\n    );\n  };\n\n  // Split contractors into regular and pending review\n  const regularContractors = contractors.filter(c => !c.needsReview);\n  const pendingReviewContractors = contractors.filter(c => c.needsReview);\n\n  const filteredContractors = (activeTab === 'pending' ? pendingReviewContractors : regularContractors)\n    .filter((contractor) => {\n      const matchesSearch = \n        contractor.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        contractor.company.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        contractor.city?.toLowerCase().includes(searchTerm.toLowerCase()) ||\n        contractor.state?.toLowerCase().includes(searchTerm.toLowerCase());\n      \n      const matchesCategory = categoryFilter === \"all\" || contractor.category === categoryFilter;\n      \n      return matchesSearch && matchesCategory;\n    })\n    .sort((a, b) => {\n      let aValue: any = a[sortField];\n      let bValue: any = b[sortField];\n      \n      // Handle null/undefined values\n      if (aValue == null) aValue = '';\n      if (bValue == null) bValue = '';\n      \n      // Handle numeric sorting for rating\n      if (sortField === 'rating') {\n        aValue = Number(aValue) || 0;\n        bValue = Number(bValue) || 0;\n      } else {\n        // Convert to string for text sorting\n        aValue = String(aValue).toLowerCase();\n        bValue = String(bValue).toLowerCase();\n      }\n      \n      if (sortDirection === 'asc') {\n        return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;\n      } else {\n        return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;\n      }\n    });\n\n  if (isLoading) {\n    return <div className=\"p-6\">Loading contractors...</div>;\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 overflow-x-hidden\">\n      <AppHeader />\n\n      <div className=\"container mx-auto px-4 py-6 max-w-full overflow-x-hidden pt-28 sm:pt-32 md:pt-36\">\n        <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4\">\n          <h2 className=\"text-2xl font-bold\">Contractors Management</h2>\n          <div className=\"flex flex-col sm:flex-row gap-3 w-full sm:w-auto\">\n            <Button onClick={() => setIsDialogOpen(true)} className=\"w-full sm:w-auto\">\n              <Plus className=\"w-4 h-4 mr-2\" />\n              Add Contractor\n            </Button>\n            <Button \n              onClick={() => setIsReviewFlowOpen(true)} \n              className=\"w-full sm:w-auto bg-blue-600 hover:bg-blue-700\"\n            >\n              <ClipboardList className=\"w-4 h-4 mr-2\" />\n              Review Contractors\n            </Button>\n            <Button \n              variant=\"outline\" \n              className=\"w-full sm:w-auto\"\n              onClick={exportAllContractors}\n              data-testid=\"button-export-contractors\"\n            >\n              <Download className=\"w-4 h-4 mr-2\" />\n              Export All\n            </Button>\n            <Dialog open={isImportDialogOpen} onOpenChange={setIsImportDialogOpen}>\n              <DialogTrigger asChild>\n                <Button variant=\"outline\" className=\"w-full sm:w-auto\">\n                  <Upload className=\"w-4 h-4 mr-2\" />\n                  Import\n                </Button>\n              </DialogTrigger>\n            <DialogContent className=\"max-w-md\">\n              <DialogHeader>\n                <DialogTitle>Import Contractors</DialogTitle>\n                <DialogDescription>Upload CSV, Excel, or KMZ files</DialogDescription>\n              </DialogHeader>\n              <div \n                className={`border-2 border-dashed rounded-lg p-4 transition-colors cursor-pointer ${\n                  isDragOver \n                    ? 'border-primary bg-primary/5' \n                    : 'border-gray-300 hover:border-primary/60'\n                } ${isUploading ? 'opacity-50 cursor-not-allowed' : ''}`}\n                onClick={() => !isUploading && fileInputRef.current?.click()}\n                onDragOver={handleDragOver}\n                onDragLeave={handleDragLeave}\n                onDrop={handleDrop}\n              >\n                <div className=\"text-center\">\n                  {isUploading ? (\n                    <div className=\"animate-spin rounded-full h-6 w-6 border-b-2 border-primary mx-auto mb-2\"></div>\n                  ) : (\n                    <CloudUpload className=\"mx-auto text-gray-400 mb-2\" size={32} />\n                  )}\n                  <p className=\"text-sm font-medium text-gray-700 mb-1\">\n                    {isUploading ? 'Processing...' : 'Drop file or click to browse'}\n                  </p>\n                  <p className=\"text-xs text-gray-500\">\n                    .csv, .xlsx, .xls, .kmz, .kml\n                  </p>\n                </div>\n                <input\n                  ref={fileInputRef}\n                  type=\"file\"\n                  className=\"hidden\"\n                  accept=\".kmz,.kml,.csv,.xlsx,.xls\"\n                  onChange={handleFileInputChange}\n                  disabled={isUploading}\n                />\n              </div>\n              {contractors.length > 0 && (\n                <div className=\"mt-3 flex items-center justify-between p-2 bg-emerald-50 border border-emerald-200 rounded\">\n                  <div className=\"flex items-center space-x-2\">\n                    <FileArchive className=\"text-emerald-600\" size={16} />\n                    <span className=\"text-xs font-medium text-emerald-800\">Contractors loaded</span>\n                  </div>\n                  <Badge variant=\"secondary\" className=\"text-emerald-600 bg-emerald-100\">\n                    {contractors.length}\n                  </Badge>\n                </div>\n              )}\n            </DialogContent>\n          </Dialog>\n          \n          <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n          <DialogContent className=\"max-w-2xl max-h-[90vh] overflow-y-auto\">\n            <DialogHeader>\n              <DialogTitle>\n                {editingContractor ? \"Edit Contractor\" : \"Add New Contractor\"}\n              </DialogTitle>\n              <DialogDescription>\n                {editingContractor ? \"Update contractor information\" : \"Enter contractor details\"}\n              </DialogDescription>\n            </DialogHeader>\n            <form onSubmit={handleSubmit} className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"name\">Contact Name</Label>\n                  <Input\n                    id=\"name\"\n                    name=\"name\"\n                    defaultValue={editingContractor?.name || \"\"}\n                    required\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"company\">Company</Label>\n                  <Input\n                    id=\"company\"\n                    name=\"company\"\n                    defaultValue={editingContractor?.company || \"\"}\n                    required\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"email\">Email</Label>\n                  <Input\n                    id=\"email\"\n                    name=\"email\"\n                    type=\"text\"\n                    placeholder=\"email1@example.com; email2@example.com\"\n                    defaultValue={editingContractor?.email || \"\"}\n                  />\n                  <p className=\"text-xs text-muted-foreground\">Separate multiple emails with semicolons (;)</p>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"phone\">Phone</Label>\n                  <Input\n                    id=\"phone\"\n                    name=\"phone\"\n                    defaultValue={editingContractor?.phone || \"\"}\n                  />\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"category\">Category</Label>\n                  <Select name=\"category\" defaultValue={editingContractor?.category || \"\"} required>\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Select category\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {categories.map((cat) => (\n                        <SelectItem key={cat} value={cat}>{cat}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"pipefile\">Pipefile</Label>\n                  <Select name=\"pipefile\" defaultValue={editingContractor?.pipefile || \"\"}>\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Select pipefile status\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"Completed\">Completed</SelectItem>\n                      <SelectItem value=\"Unfinished\">Unfinished</SelectItem>\n                      <SelectItem value=\"N/A\">N/A</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"avetta\">AVETTA</Label>\n                  <Select name=\"avetta\" defaultValue={editingContractor?.avetta || \"\"}>\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Select AVETTA status\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"Yes\">Yes</SelectItem>\n                      <SelectItem value=\"No\">No</SelectItem>\n                      <SelectItem value=\"N/A\">N/A</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"isnComplete\">ISN Complete</Label>\n                  <Select name=\"isnComplete\" defaultValue={editingContractor?.isnComplete ? \"Yes\" : \"No\"}>\n                    <SelectTrigger>\n                      <SelectValue placeholder=\"Select ISN status\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"Yes\">Yes</SelectItem>\n                      <SelectItem value=\"No\">No</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n              </div>\n\n              <div className=\"grid grid-cols-1 sm:grid-cols-3 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"city\">City</Label>\n                  <Input\n                    id=\"city\"\n                    name=\"city\"\n                    defaultValue={editingContractor?.city || \"\"}\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"state\">State</Label>\n                  <Input\n                    id=\"state\"\n                    name=\"state\"\n                    defaultValue={editingContractor?.state || \"\"}\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"subRanking\">Sub Ranking (0-5)</Label>\n                  <Input\n                    id=\"subRanking\"\n                    name=\"subRanking\"\n                    type=\"number\"\n                    min=\"0\"\n                    max=\"5\"\n                    defaultValue={editingContractor?.subRanking || \"\"}\n                    placeholder=\"0-5\"\n                  />\n                </div>\n              </div>\n              \n              <div className=\"space-y-2\">\n                <Label htmlFor=\"birdRep\">Bird Rep</Label>\n                <Input\n                  id=\"birdRep\"\n                  name=\"birdRep\"\n                  defaultValue={editingContractor?.birdRep || \"\"}\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"fullAddress\">Full Address</Label>\n                <Input\n                  id=\"fullAddress\"\n                  name=\"fullAddress\"\n                  defaultValue={editingContractor?.fullAddress || \"\"}\n                />\n              </div>\n\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 gap-4\">\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"latitude\">Latitude</Label>\n                  <Input\n                    id=\"latitude\"\n                    name=\"latitude\"\n                    type=\"number\"\n                    step=\"any\"\n                    defaultValue={editingContractor?.latitude || \"\"}\n                  />\n                </div>\n                <div className=\"space-y-2\">\n                  <Label htmlFor=\"longitude\">Longitude</Label>\n                  <Input\n                    id=\"longitude\"\n                    name=\"longitude\"\n                    type=\"number\"\n                    step=\"any\"\n                    defaultValue={editingContractor?.longitude || \"\"}\n                  />\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"fteCountsPerLocation\">FTE Counts Per Location</Label>\n                <Input\n                  id=\"fteCountsPerLocation\"\n                  name=\"fteCountsPerLocation\"\n                  defaultValue={editingContractor?.fteCountsPerLocation || \"\"}\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"pipefileUpdates\">Pipefile Updates</Label>\n                <Input\n                  id=\"pipefileUpdates\"\n                  name=\"pipefileUpdates\"\n                  defaultValue={editingContractor?.pipefileUpdates || \"\"}\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"rating\">Rating (0-5, decimals allowed)</Label>\n                <div className=\"flex items-center gap-4\">\n                  <Input\n                    id=\"rating\"\n                    name=\"rating\"\n                    type=\"number\"\n                    min=\"0\"\n                    max=\"5\"\n                    step=\"0.1\"\n                    defaultValue={editingContractor?.rating || 0}\n                    className=\"w-24\"\n                  />\n                  <div className=\"flex gap-1\">\n                    {[1, 2, 3, 4, 5].map((star) => {\n                      const rating = editingContractor?.rating || 0;\n                      const isFilled = star <= rating;\n                      const isPartial = star > rating && star - 1 < rating;\n                      \n                      return (\n                        <Star\n                          key={star}\n                          className={`w-5 h-5 ${\n                            isFilled ? \"fill-red-500 text-red-500\" : \n                            isPartial ? \"fill-red-300 text-red-300\" : \"text-gray-300\"\n                          }`}\n                        />\n                      );\n                    })}\n                  </div>\n                  <span className=\"text-sm text-gray-500\">({(editingContractor?.rating || 0).toFixed(1)})</span>\n                </div>\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"notes\">Notes</Label>\n                <Textarea\n                  id=\"notes\"\n                  name=\"notes\"\n                  defaultValue={editingContractor?.notes || \"\"}\n                  rows={3}\n                />\n              </div>\n\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"newMsaComplete\">MSA Status</Label>\n                <Select name=\"newMsaComplete\" defaultValue={editingContractor?.newMsaComplete || \"none\"}>\n                  <SelectTrigger>\n                    <SelectValue placeholder=\"Select MSA status\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {msaStatuses.map((status) => (\n                      <SelectItem key={status.value} value={status.value}>\n                        {status.label}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              {/* File Upload Section */}\n              {editingContractor && (\n                <div className=\"space-y-4 border-t pt-4\">\n                  <div className=\"flex items-center justify-between\">\n                    <Label className=\"text-base font-medium\">Attached Files</Label>\n                    <div className=\"flex items-center gap-2\">\n                      <input\n                        ref={contractorFileInputRef}\n                        type=\"file\"\n                        className=\"hidden\"\n                        accept=\".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.csv,.xlsx,.xls\"\n                        onChange={handleFileUploadForContractor}\n                        disabled={uploadingFile}\n                      />\n                      <Button\n                        type=\"button\"\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => contractorFileInputRef.current?.click()}\n                        disabled={uploadingFile}\n                      >\n                        {uploadingFile ? (\n                          <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-primary\"></div>\n                        ) : (\n                          <Paperclip className=\"w-4 h-4 mr-2\" />\n                        )}\n                        {uploadingFile ? \"Uploading...\" : \"Add File\"}\n                      </Button>\n                    </div>\n                  </div>\n                  \n                  {contractorFiles.length > 0 ? (\n                    <div className=\"space-y-2 max-h-40 overflow-y-auto\">\n                      {contractorFiles.map((file) => (\n                        <div key={file.id} className=\"flex items-center justify-between p-2 bg-gray-50 rounded border\">\n                          <div className=\"flex items-center gap-2 flex-1 min-w-0\">\n                            <Paperclip className=\"w-4 h-4 text-gray-500 flex-shrink-0\" />\n                            <div className=\"min-w-0 flex-1\">\n                              <p className=\"text-sm font-medium truncate\">{file.originalName}</p>\n                              <p className=\"text-xs text-gray-500\">\n                                {formatFileSize(file.fileSize)} • {new Date(file.uploadedAt).toLocaleDateString()}\n                              </p>\n                            </div>\n                          </div>\n                          <div className=\"flex items-center gap-1\">\n                            <Button\n                              type=\"button\"\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => window.open(`/api/contractor-files/${file.id}/download`, '_blank')}\n                            >\n                              <Download className=\"w-4 h-4\" />\n                            </Button>\n                            <Button\n                              type=\"button\"\n                              variant=\"ghost\"\n                              size=\"sm\"\n                              onClick={() => handleDeleteFile(file.id)}\n                            >\n                              <X className=\"w-4 h-4\" />\n                            </Button>\n                          </div>\n                        </div>\n                      ))}\n                    </div>\n                  ) : (\n                    <p className=\"text-sm text-gray-500 text-center py-4\">No files uploaded yet</p>\n                  )}\n                </div>\n              )}\n\n              <div className=\"flex justify-end gap-2\">\n                <Button\n                  type=\"button\"\n                  variant=\"outline\"\n                  onClick={() => {\n                    setIsDialogOpen(false);\n                    setContractorFiles([]);\n                    setEditingContractor(null);\n                  }}\n                >\n                  Cancel\n                </Button>\n                <Button\n                  type=\"submit\"\n                  disabled={createMutation.isPending || updateMutation.isPending}\n                >\n                  {editingContractor ? \"Update\" : \"Create\"}\n                </Button>\n              </div>\n            </form>\n          </DialogContent>\n        </Dialog>\n        </div>\n      </div>\n\n        <div className=\"flex flex-col sm:flex-row gap-4 mb-6\">\n          <div className=\"flex-1 min-w-0\">\n            <Input\n              placeholder=\"Search contractors by name, company, or location...\"\n              value={searchTerm}\n              onChange={(e) => setSearchTerm(e.target.value)}\n              className=\"w-full\"\n            />\n          </div>\n          <Select value={categoryFilter} onValueChange={setCategoryFilter}>\n            <SelectTrigger className=\"w-full sm:w-48 flex-shrink-0\">\n              <SelectValue />\n            </SelectTrigger>\n            <SelectContent>\n              <SelectItem value=\"all\">All Categories</SelectItem>\n              {categories.map((cat) => (\n                <SelectItem key={cat} value={cat}>{cat}</SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n\n        {/* Tabs for All Contractors and Pending Review */}\n        <Tabs value={activeTab} onValueChange={(value) => setActiveTab(value as 'all' | 'pending')} className=\"w-full\">\n          <TabsList className=\"mb-6\">\n            <TabsTrigger value=\"all\">All Contractors</TabsTrigger>\n            <TabsTrigger value=\"pending\">\n              Pending Review\n              {pendingReviewContractors.length > 0 && (\n                <Badge variant=\"destructive\" className=\"ml-2\">\n                  {pendingReviewContractors.length}\n                </Badge>\n              )}\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"all\" className=\"mt-0\">\n            {/* Sort Controls */}\n            <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4\">\n              <div className=\"flex flex-col sm:flex-row sm:items-center gap-3 w-full sm:w-auto\">\n                <span className=\"text-sm font-medium text-gray-700\">Sort by:</span>\n                <Select value={sortField} onValueChange={(value: SortField) => handleSort(value)}>\n                  <SelectTrigger className=\"w-full sm:w-48 flex-shrink-0\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"company\">Company</SelectItem>\n                    <SelectItem value=\"name\">Contact Name</SelectItem>\n                    <SelectItem value=\"category\">Category</SelectItem>\n                    <SelectItem value=\"rating\">Rating</SelectItem>\n                    <SelectItem value=\"newMsaComplete\">MSA Status</SelectItem>\n                    <SelectItem value=\"city\">City</SelectItem>\n                    <SelectItem value=\"state\">State</SelectItem>\n                    <SelectItem value=\"pipefile\">Pipefile</SelectItem>\n                    <SelectItem value=\"avetta\">AVETTA</SelectItem>\n                    <SelectItem value=\"isnComplete\">ISN Complete</SelectItem>\n                  </SelectContent>\n                </Select>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc')}\n                  className=\"flex items-center gap-1\"\n                >\n                  {sortDirection === 'asc' ? <ArrowUp className=\"w-4 h-4\" /> : <ArrowDown className=\"w-4 h-4\" />}\n                  {sortDirection === 'asc' ? 'A-Z' : 'Z-A'}\n                </Button>\n              </div>\n              <div className=\"text-sm text-gray-500 flex-shrink-0\">\n                {filteredContractors.length} contractors\n              </div>\n            </div>\n\n            <div className=\"grid gap-4 lg:gap-6 w-full\">\n        {filteredContractors.map((contractor) => (\n          <Card key={contractor.id} className=\"w-full\">\n            <CardHeader className=\"pb-3\">\n              <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\n                <div className=\"flex-1 min-w-0\">\n                  <CardTitle className=\"text-lg truncate\">{contractor.company}</CardTitle>\n                  <CardDescription className=\"truncate\">{contractor.name}</CardDescription>\n                </div>\n                <div className=\"flex items-center gap-2 flex-shrink-0\">\n                  <div className=\"flex gap-1 items-center\">\n                    {[1, 2, 3, 4, 5].map((star) => {\n                      const rating = contractor.rating || 0;\n                      const isFilled = star <= rating;\n                      const isPartial = star > rating && star - 1 < rating;\n                      \n                      return (\n                        <Star\n                          key={star}\n                          className={`w-4 h-4 ${\n                            isFilled ? \"fill-red-500 text-red-500\" : \n                            isPartial ? \"fill-red-300 text-red-300\" : \"text-gray-300\"\n                          }`}\n                        />\n                      );\n                    })}\n                    <span className=\"text-xs text-gray-500 ml-1\">\n                      ({(contractor.rating || 0).toFixed(1)})\n                    </span>\n                  </div>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => setReviewsModalContractor(contractor)}\n                    title=\"View Reviews\"\n                  >\n                    <Eye className=\"w-4 h-4\" />\n                  </Button>\n                  <Button\n                    data-testid={`button-merge-${contractor.id}`}\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => {\n                      setMergeSourceId(contractor.id);\n                      setMergeDialogOpen(true);\n                    }}\n                    title=\"Merge with Another Contractor\"\n                    className={activeTab === 'pending' ? \"bg-blue-50 hover:bg-blue-100\" : \"\"}\n                  >\n                    <Link2 className=\"w-4 h-4\" />\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handleEdit(contractor)}\n                    title=\"Edit Contractor\"\n                  >\n                    <Edit className=\"w-4 h-4\" />\n                  </Button>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handleDelete(contractor.id)}\n                    title=\"Delete Contractor\"\n                  >\n                    <Trash2 className=\"w-4 h-4\" />\n                  </Button>\n                </div>\n              </div>\n            </CardHeader>\n            <CardContent>\n              <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 text-sm\">\n                <div>\n                  <span className=\"font-medium\">Category:</span>\n                  <Badge variant=\"secondary\" className=\"ml-2\">\n                    {contractor.category}\n                  </Badge>\n                </div>\n                <div>\n                  <span className=\"font-medium\">Pipefile:</span>\n                  <Badge \n                    variant={contractor.pipefile === \"Completed\" ? \"default\" : \"outline\"}\n                    className=\"ml-2\"\n                  >\n                    {contractor.pipefile || 'N/A'}\n                  </Badge>\n                </div>\n                <div>\n                  <span className=\"font-medium\">AVETTA:</span>\n                  <Badge \n                    variant={contractor.avetta === \"Yes\" ? \"default\" : \"outline\"}\n                    className=\"ml-2\"\n                  >\n                    {contractor.avetta || 'N/A'}\n                  </Badge>\n                </div>\n                <div>\n                  <span className=\"font-medium\">ISN Complete:</span>\n                  <Badge \n                    variant={contractor.isnComplete ? \"default\" : \"outline\"}\n                    className=\"ml-2\"\n                  >\n                    {contractor.isnComplete ? 'Yes' : 'No'}\n                  </Badge>\n                </div>\n                <div>\n                  <span className=\"font-medium\">Location:</span>\n                  <span className=\"ml-2\">{contractor.city}, {contractor.state}</span>\n                </div>\n              </div>\n              \n              {contractor.email && (\n                <div className=\"mt-2 text-sm\">\n                  <span className=\"font-medium\">Email:</span>\n                  <span className=\"ml-2\">{contractor.email}</span>\n                </div>\n              )}\n              \n              {contractor.phone && (\n                <div className=\"mt-1 text-sm\">\n                  <span className=\"font-medium\">Phone:</span>\n                  <span className=\"ml-2\">{contractor.phone}</span>\n                </div>\n              )}\n              \n              {contractor.birdRep && (\n                <div className=\"mt-1 text-sm\">\n                  <span className=\"font-medium\">Bird Rep:</span>\n                  <span className=\"ml-2\">{contractor.birdRep}</span>\n                </div>\n              )}\n              \n              {contractor.newMsaComplete && (\n                <div className=\"mt-2 text-sm\">\n                  <span className=\"font-medium\">MSA Status:</span>\n                  <Badge \n                    variant=\"default\"\n                    className=\"ml-2\"\n                  >\n                    {contractor.newMsaComplete}\n                  </Badge>\n                </div>\n              )}\n\n              {contractor.notes && (\n                <div className=\"mt-2 text-sm\">\n                  <span className=\"font-medium\">Notes:</span>\n                  <p className=\"mt-1 text-gray-600\">{contractor.notes}</p>\n                </div>\n              )}\n\n              <div className=\"mt-2 text-sm\">\n                <div className=\"flex items-center justify-between\">\n                  <span className=\"font-medium\">Storage Yards / Departure Locations:</span>\n                  <Button\n                    data-testid={`button-manage-locations-${contractor.id}`}\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => handleManageLocations(contractor)}\n                    className=\"h-7 text-xs\"\n                  >\n                    <MapPin className=\"w-3 h-3 mr-1\" />\n                    Manage Locations\n                  </Button>\n                </div>\n                {contractor.departureLocations && Array.isArray(contractor.departureLocations) && contractor.departureLocations.length > 0 && (\n                  <div className=\"mt-1 flex flex-wrap gap-2\">\n                    {contractor.departureLocations.map((loc: any, idx: number) => (\n                      <Badge key={idx} variant=\"outline\" className=\"flex items-center gap-1\">\n                        <MapPin className=\"w-3 h-3\" />\n                        {loc.location}\n                      </Badge>\n                    ))}\n                  </div>\n                )}\n              </div>\n            </CardContent>\n          </Card>\n        ))}\n        \n          {filteredContractors.length === 0 && (\n            <Card>\n              <CardContent className=\"text-center py-8\">\n                <p className=\"text-gray-500\">No contractors found matching your search criteria.</p>\n              </CardContent>\n            </Card>\n          )}\n            </div>\n          </TabsContent>\n\n          <TabsContent value=\"pending\" className=\"mt-0\">\n            {/* Sort Controls */}\n            <div className=\"flex flex-col sm:flex-row items-start sm:items-center justify-between mb-4 gap-4\">\n              <div className=\"flex flex-col sm:flex-row sm:items-center gap-3 w-full sm:w-auto\">\n                <span className=\"text-sm font-medium text-gray-700\">Sort by:</span>\n                <Select value={sortField} onValueChange={(value: SortField) => handleSort(value)}>\n                  <SelectTrigger className=\"w-full sm:w-48 flex-shrink-0\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"company\">Company</SelectItem>\n                    <SelectItem value=\"name\">Contact Name</SelectItem>\n                    <SelectItem value=\"category\">Category</SelectItem>\n                    <SelectItem value=\"rating\">Rating</SelectItem>\n                    <SelectItem value=\"newMsaComplete\">MSA Status</SelectItem>\n                    <SelectItem value=\"city\">City</SelectItem>\n                    <SelectItem value=\"state\">State</SelectItem>\n                    <SelectItem value=\"pipefile\">Pipefile</SelectItem>\n                    <SelectItem value=\"avetta\">AVETTA</SelectItem>\n                    <SelectItem value=\"isnComplete\">ISN Complete</SelectItem>\n                  </SelectContent>\n                </Select>\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc')}\n                  className=\"flex items-center gap-1\"\n                >\n                  {sortDirection === 'asc' ? <ArrowUp className=\"w-4 h-4\" /> : <ArrowDown className=\"w-4 h-4\" />}\n                  {sortDirection === 'asc' ? 'A-Z' : 'Z-A'}\n                </Button>\n              </div>\n              <div className=\"text-sm text-gray-500 flex-shrink-0\">\n                {filteredContractors.length} contractors\n              </div>\n            </div>\n\n            <div className=\"grid gap-4 lg:gap-6 w-full\">\n              {filteredContractors.map((contractor) => (\n                <Card key={contractor.id} className=\"w-full\">\n                  <CardHeader className=\"pb-3\">\n                    <div className=\"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\n                      <div className=\"flex-1 min-w-0\">\n                        <CardTitle className=\"text-lg truncate\">{contractor.company}</CardTitle>\n                        <CardDescription className=\"truncate\">{contractor.name}</CardDescription>\n                      </div>\n                      <div className=\"flex items-center gap-2 flex-shrink-0\">\n                        <div className=\"flex gap-1 items-center\">\n                          {[1, 2, 3, 4, 5].map((star) => {\n                            const rating = contractor.rating || 0;\n                            const isFilled = star <= rating;\n                            const isPartial = star > rating && star - 1 < rating;\n                            \n                            return (\n                              <Star\n                                key={star}\n                                className={`w-4 h-4 ${\n                                  isFilled ? \"fill-red-500 text-red-500\" : \n                                  isPartial ? \"fill-red-300 text-red-300\" : \"text-gray-300\"\n                                }`}\n                              />\n                            );\n                          })}\n                          <span className=\"text-xs text-gray-500 ml-1\">\n                            ({(contractor.rating || 0).toFixed(1)})\n                          </span>\n                        </div>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => setReviewsModalContractor(contractor)}\n                          title=\"View Reviews\"\n                        >\n                          <Eye className=\"w-4 h-4\" />\n                        </Button>\n                        {activeTab === 'pending' && (\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => {\n                              setMergeSourceId(contractor.id);\n                              setMergeDialogOpen(true);\n                            }}\n                            title=\"Combine with Existing\"\n                            className=\"bg-blue-50 hover:bg-blue-100\"\n                          >\n                            <Link2 className=\"w-4 h-4\" />\n                          </Button>\n                        )}\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleEdit(contractor)}\n                          title=\"Edit Contractor\"\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </Button>\n                        <Button\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleDelete(contractor.id)}\n                          title=\"Delete Contractor\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </div>\n                  </CardHeader>\n                  <CardContent>\n                    <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 text-sm\">\n                      <div>\n                        <span className=\"font-medium\">Category:</span>\n                        <Badge variant=\"secondary\" className=\"ml-2\">\n                          {contractor.category}\n                        </Badge>\n                      </div>\n                      <div>\n                        <span className=\"font-medium\">Pipefile:</span>\n                        <Badge \n                          variant={contractor.pipefile === \"Completed\" ? \"default\" : \"outline\"}\n                          className=\"ml-2\"\n                        >\n                          {contractor.pipefile || 'N/A'}\n                        </Badge>\n                      </div>\n                      <div>\n                        <span className=\"font-medium\">AVETTA:</span>\n                        <Badge \n                          variant={contractor.avetta === \"Yes\" ? \"default\" : \"outline\"}\n                          className=\"ml-2\"\n                        >\n                          {contractor.avetta || 'N/A'}\n                        </Badge>\n                      </div>\n                      <div>\n                        <span className=\"font-medium\">ISN Complete:</span>\n                        <Badge \n                          variant={contractor.isnComplete ? \"default\" : \"outline\"}\n                          className=\"ml-2\"\n                        >\n                          {contractor.isnComplete ? 'Yes' : 'No'}\n                        </Badge>\n                      </div>\n                      <div>\n                        <span className=\"font-medium\">Location:</span>\n                        <span className=\"ml-2\">{contractor.city}, {contractor.state}</span>\n                      </div>\n                    </div>\n                    \n                    {contractor.email && (\n                      <div className=\"mt-2 text-sm\">\n                        <span className=\"font-medium\">Email:</span>\n                        <span className=\"ml-2\">{contractor.email}</span>\n                      </div>\n                    )}\n                    \n                    {contractor.phone && (\n                      <div className=\"mt-1 text-sm\">\n                        <span className=\"font-medium\">Phone:</span>\n                        <span className=\"ml-2\">{contractor.phone}</span>\n                      </div>\n                    )}\n                    \n                    {contractor.birdRep && (\n                      <div className=\"mt-1 text-sm\">\n                        <span className=\"font-medium\">Bird Rep:</span>\n                        <span className=\"ml-2\">{contractor.birdRep}</span>\n                      </div>\n                    )}\n                    \n                    {contractor.newMsaComplete && (\n                      <div className=\"mt-2 text-sm\">\n                        <span className=\"font-medium\">MSA Status:</span>\n                        <Badge \n                          variant=\"default\"\n                          className=\"ml-2\"\n                        >\n                          {contractor.newMsaComplete}\n                        </Badge>\n                      </div>\n                    )}\n\n                    {contractor.notes && (\n                      <div className=\"mt-2 text-sm\">\n                        <span className=\"font-medium\">Notes:</span>\n                        <p className=\"mt-1 text-gray-600\">{contractor.notes}</p>\n                      </div>\n                    )}\n\n                    <div className=\"mt-2 text-sm\">\n                      <div className=\"flex items-center justify-between\">\n                        <span className=\"font-medium\">Storage Yards / Departure Locations:</span>\n                        <Button\n                          data-testid={`button-manage-locations-pending-${contractor.id}`}\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleManageLocations(contractor)}\n                          className=\"h-7 text-xs\"\n                        >\n                          <MapPin className=\"w-3 h-3 mr-1\" />\n                          Manage Locations\n                        </Button>\n                      </div>\n                      {contractor.departureLocations && Array.isArray(contractor.departureLocations) && contractor.departureLocations.length > 0 && (\n                        <div className=\"mt-1 flex flex-wrap gap-2\">\n                          {contractor.departureLocations.map((loc: any, idx: number) => (\n                            <Badge key={idx} variant=\"outline\" className=\"flex items-center gap-1\">\n                              <MapPin className=\"w-3 h-3\" />\n                              {loc.location}\n                            </Badge>\n                          ))}\n                        </div>\n                      )}\n                    </div>\n                  </CardContent>\n                </Card>\n              ))}\n              \n              {filteredContractors.length === 0 && (\n                <Card>\n                  <CardContent className=\"text-center py-8\">\n                    <p className=\"text-gray-500\">No contractors found matching your search criteria.</p>\n                  </CardContent>\n                </Card>\n              )}\n            </div>\n          </TabsContent>\n        </Tabs>\n      </div>\n\n      {/* Merge Dialog */}\n      <Dialog open={mergeDialogOpen} onOpenChange={(open) => {\n        setMergeDialogOpen(open);\n        if (!open) {\n          setMergeStep('select');\n          setMergeTargetId(\"\");\n          setMergeSearchTerm(\"\");\n          setMergedEmails([]);\n          setMergedPhones([]);\n          setMergedNames([]);\n        }\n      }}>\n        <DialogContent className=\"max-w-3xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>\n              {mergeStep === 'select' ? 'Combine Contractor with Existing Record' : 'Review Combined Data'}\n            </DialogTitle>\n            <DialogDescription>\n              {mergeStep === 'select' \n                ? 'Select an existing contractor to merge this record into.' \n                : 'Review and edit the combined information. Remove any duplicate or incorrect entries.'}\n            </DialogDescription>\n          </DialogHeader>\n          \n          {mergeStep === 'select' ? (\n            <div className=\"space-y-4\">\n              <div className=\"space-y-2\">\n                <Label htmlFor=\"merge-search\">Search Contractors</Label>\n                <Input\n                  id=\"merge-search\"\n                  placeholder=\"Search by name or company...\"\n                  value={mergeSearchTerm}\n                  onChange={(e) => setMergeSearchTerm(e.target.value)}\n                />\n              </div>\n\n              <div className=\"space-y-2 max-h-96 overflow-y-auto\">\n                {regularContractors\n                  .filter((c) =>\n                    c.name.toLowerCase().includes(mergeSearchTerm.toLowerCase()) ||\n                    c.company.toLowerCase().includes(mergeSearchTerm.toLowerCase())\n                  )\n                  .map((contractor) => (\n                    <Card\n                      key={contractor.id}\n                      className={`cursor-pointer transition-all ${\n                        mergeTargetId === contractor.id.toString()\n                          ? 'border-blue-500 bg-blue-50'\n                          : 'hover:border-gray-400'\n                      }`}\n                      onClick={() => setMergeTargetId(contractor.id.toString())}\n                    >\n                      <CardContent className=\"p-4\">\n                        <div className=\"flex justify-between items-start\">\n                          <div>\n                            <h4 className=\"font-semibold\">{contractor.company}</h4>\n                            <p className=\"text-sm text-gray-600\">{contractor.name}</p>\n                            <p className=\"text-xs text-gray-500 mt-1\">\n                              {contractor.city}, {contractor.state}\n                            </p>\n                          </div>\n                          <Badge variant=\"secondary\">{contractor.category}</Badge>\n                        </div>\n                      </CardContent>\n                    </Card>\n                  ))}\n                \n                {regularContractors.filter((c) =>\n                  c.name.toLowerCase().includes(mergeSearchTerm.toLowerCase()) ||\n                  c.company.toLowerCase().includes(mergeSearchTerm.toLowerCase())\n                ).length === 0 && (\n                  <p className=\"text-center text-gray-500 py-4\">No contractors found</p>\n                )}\n              </div>\n\n              {mergeTargetId && (\n                <div className=\"pt-4 border-t\">\n                  <div className=\"flex gap-2 justify-end\">\n                    <Button\n                      variant=\"outline\"\n                      onClick={() => {\n                        setMergeDialogOpen(false);\n                        setMergeTargetId(\"\");\n                        setMergeSearchTerm(\"\");\n                      }}\n                    >\n                      Cancel\n                    </Button>\n                    <Button onClick={prepareMergeData}>\n                      Next: Review Data\n                    </Button>\n                  </div>\n                </div>\n              )}\n            </div>\n          ) : (\n            <div className=\"space-y-6\">\n              {/* Names */}\n              <div className=\"space-y-3\">\n                <Label className=\"text-base font-semibold\">Contact Names</Label>\n                {mergedNames.map((name, index) => (\n                  <div key={index} className=\"flex gap-2\">\n                    <Input\n                      value={name}\n                      onChange={(e) => {\n                        const updated = [...mergedNames];\n                        updated[index] = e.target.value;\n                        setMergedNames(updated);\n                      }}\n                      placeholder=\"Name\"\n                    />\n                    <Button\n                      variant=\"outline\"\n                      size=\"icon\"\n                      onClick={() => {\n                        setMergedNames(mergedNames.filter((_, i) => i !== index));\n                      }}\n                      disabled={mergedNames.length === 1}\n                    >\n                      <X className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                ))}\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setMergedNames([...mergedNames, ''])}\n                >\n                  <Plus className=\"h-4 w-4 mr-1\" /> Add Name\n                </Button>\n              </div>\n\n              {/* Emails */}\n              <div className=\"space-y-3\">\n                <Label className=\"text-base font-semibold\">Email Addresses</Label>\n                {mergedEmails.map((email, index) => (\n                  <div key={index} className=\"flex gap-2\">\n                    <Input\n                      type=\"email\"\n                      value={email}\n                      onChange={(e) => {\n                        const updated = [...mergedEmails];\n                        updated[index] = e.target.value;\n                        setMergedEmails(updated);\n                      }}\n                      placeholder=\"email@example.com\"\n                    />\n                    <Button\n                      variant=\"outline\"\n                      size=\"icon\"\n                      onClick={() => {\n                        setMergedEmails(mergedEmails.filter((_, i) => i !== index));\n                      }}\n                    >\n                      <X className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                ))}\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setMergedEmails([...mergedEmails, ''])}\n                >\n                  <Plus className=\"h-4 w-4 mr-1\" /> Add Email\n                </Button>\n              </div>\n\n              {/* Phone Numbers */}\n              <div className=\"space-y-3\">\n                <Label className=\"text-base font-semibold\">Phone Numbers</Label>\n                {mergedPhones.map((phone, index) => (\n                  <div key={index} className=\"flex gap-2\">\n                    <Input\n                      type=\"tel\"\n                      value={phone}\n                      onChange={(e) => {\n                        const updated = [...mergedPhones];\n                        updated[index] = e.target.value;\n                        setMergedPhones(updated);\n                      }}\n                      placeholder=\"(555) 123-4567\"\n                    />\n                    <Button\n                      variant=\"outline\"\n                      size=\"icon\"\n                      onClick={() => {\n                        setMergedPhones(mergedPhones.filter((_, i) => i !== index));\n                      }}\n                    >\n                      <X className=\"h-4 w-4\" />\n                    </Button>\n                  </div>\n                ))}\n                <Button\n                  variant=\"outline\"\n                  size=\"sm\"\n                  onClick={() => setMergedPhones([...mergedPhones, ''])}\n                >\n                  <Plus className=\"h-4 w-4 mr-1\" /> Add Phone\n                </Button>\n              </div>\n\n              <div className=\"pt-4 border-t flex gap-2 justify-end\">\n                <Button\n                  variant=\"outline\"\n                  onClick={() => {\n                    setMergeStep('select');\n                    setMergedEmails([]);\n                    setMergedPhones([]);\n                    setMergedNames([]);\n                  }}\n                >\n                  Back\n                </Button>\n                <Button\n                  onClick={() => {\n                    if (mergeSourceId && mergeTargetId) {\n                      const mergedData = {\n                        name: mergedNames.filter(n => n.trim()).join(', '),\n                        email: mergedEmails.filter(e => e.trim()).join('; '),\n                        phone: mergedPhones.filter(p => p.trim()).join('; ')\n                      };\n                      mergeMutation.mutate({\n                        sourceId: mergeSourceId,\n                        targetId: parseInt(mergeTargetId),\n                        mergedData\n                      });\n                    }\n                  }}\n                  disabled={mergeMutation.isPending}\n                >\n                  {mergeMutation.isPending ? 'Merging...' : 'Confirm Merge'}\n                </Button>\n              </div>\n            </div>\n          )}\n        </DialogContent>\n      </Dialog>\n\n      {/* Departure Locations Management Dialog */}\n      <Dialog open={locationsDialogOpen} onOpenChange={setLocationsDialogOpen}>\n        <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-y-auto\">\n          <DialogHeader>\n            <DialogTitle>Manage Storage Yards / Departure Locations</DialogTitle>\n            <DialogDescription>\n              {locationsContractor && `Managing locations for ${locationsContractor.company}`}\n            </DialogDescription>\n          </DialogHeader>\n\n          <div className=\"space-y-4\">\n            {/* Add New Location */}\n            <div className=\"space-y-2\">\n              <Label htmlFor=\"new-location\">Add New Location</Label>\n              <div className=\"flex gap-2\">\n                <Input\n                  id=\"new-location\"\n                  data-testid=\"input-new-location\"\n                  placeholder=\"Enter address (e.g., 123 Main St, City, State ZIP)\"\n                  value={newLocationAddress}\n                  onChange={(e) => setNewLocationAddress(e.target.value)}\n                  onKeyDown={(e) => {\n                    if (e.key === 'Enter' && !isGeocodingLocation) {\n                      handleAddLocation();\n                    }\n                  }}\n                />\n                <Button\n                  data-testid=\"button-add-location\"\n                  onClick={handleAddLocation}\n                  disabled={!newLocationAddress.trim() || isGeocodingLocation}\n                >\n                  {isGeocodingLocation ? 'Adding...' : <><Plus className=\"w-4 h-4 mr-1\" /> Add</>}\n                </Button>\n              </div>\n              <p className=\"text-xs text-gray-500\">\n                The address will be geocoded automatically to get coordinates for distance calculations.\n              </p>\n            </div>\n\n            {/* Existing Locations List */}\n            <div className=\"space-y-2\">\n              <Label>Current Locations ({(locationsContractor?.departureLocations as any)?.length || 0})</Label>\n              {locationsContractor?.departureLocations && Array.isArray(locationsContractor.departureLocations) && locationsContractor.departureLocations.length > 0 ? (\n                <div className=\"space-y-2\">\n                  {(locationsContractor.departureLocations as any[]).map((loc: any, idx: number) => (\n                    <Card key={idx} className=\"p-3\">\n                      <div className=\"flex items-start justify-between gap-2\">\n                        <div className=\"flex-1\">\n                          <div className=\"flex items-center gap-2\">\n                            <MapPin className=\"w-4 h-4 text-blue-600\" />\n                            <span className=\"font-medium\">{loc.location}</span>\n                          </div>\n                          {loc.latitude && loc.longitude && (\n                            <p className=\"text-xs text-gray-500 mt-1 ml-6\">\n                              Coordinates: {loc.latitude.toFixed(6)}, {loc.longitude.toFixed(6)}\n                            </p>\n                          )}\n                        </div>\n                        <Button\n                          data-testid={`button-remove-location-${idx}`}\n                          variant=\"outline\"\n                          size=\"sm\"\n                          onClick={() => handleRemoveLocation(idx)}\n                          className=\"text-red-600 hover:text-red-700\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    </Card>\n                  ))}\n                </div>\n              ) : (\n                <p className=\"text-sm text-gray-500\">No locations added yet. Add locations above to get started.</p>\n              )}\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* Review Flow Modal */}\n      {isReviewFlowOpen && (\n        <div className=\"fixed inset-0 z-[9000] bg-white dark:bg-gray-900 overflow-y-auto\">\n          <AppHeader />\n          <div className=\"pt-16 sm:pt-20\">\n            <ContractorReviewFlow\n              onComplete={() => setIsReviewFlowOpen(false)}\n              onCancel={() => setIsReviewFlowOpen(false)}\n            />\n          </div>\n        </div>\n      )}\n\n      {/* Reviews Modal */}\n      {reviewsModalContractor && (\n        <ContractorReviewsModal\n          contractor={reviewsModalContractor}\n          isOpen={!!reviewsModalContractor}\n          onClose={() => setReviewsModalContractor(null)}\n        />\n      )}\n    </div>\n  );\n}","path":null,"size_bytes":79463,"size_tokens":null},"client/src/components/ui/input-otp.tsx":{"content":"import * as React from \"react\"\nimport { OTPInput, OTPInputContext } from \"input-otp\"\nimport { Dot } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst InputOTP = React.forwardRef<\n  React.ElementRef<typeof OTPInput>,\n  React.ComponentPropsWithoutRef<typeof OTPInput>\n>(({ className, containerClassName, ...props }, ref) => (\n  <OTPInput\n    ref={ref}\n    containerClassName={cn(\n      \"flex items-center gap-2 has-[:disabled]:opacity-50\",\n      containerClassName\n    )}\n    className={cn(\"disabled:cursor-not-allowed\", className)}\n    {...props}\n  />\n))\nInputOTP.displayName = \"InputOTP\"\n\nconst InputOTPGroup = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"flex items-center\", className)} {...props} />\n))\nInputOTPGroup.displayName = \"InputOTPGroup\"\n\nconst InputOTPSlot = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\"> & { index: number }\n>(({ index, className, ...props }, ref) => {\n  const inputOTPContext = React.useContext(OTPInputContext)\n  const { char, hasFakeCaret, isActive } = inputOTPContext.slots[index]\n\n  return (\n    <div\n      ref={ref}\n      className={cn(\n        \"relative flex h-10 w-10 items-center justify-center border-y border-r border-input text-sm transition-all first:rounded-l-md first:border-l last:rounded-r-md\",\n        isActive && \"z-10 ring-2 ring-ring ring-offset-background\",\n        className\n      )}\n      {...props}\n    >\n      {char}\n      {hasFakeCaret && (\n        <div className=\"pointer-events-none absolute inset-0 flex items-center justify-center\">\n          <div className=\"h-4 w-px animate-caret-blink bg-foreground duration-1000\" />\n        </div>\n      )}\n    </div>\n  )\n})\nInputOTPSlot.displayName = \"InputOTPSlot\"\n\nconst InputOTPSeparator = React.forwardRef<\n  React.ElementRef<\"div\">,\n  React.ComponentPropsWithoutRef<\"div\">\n>(({ ...props }, ref) => (\n  <div ref={ref} role=\"separator\" {...props}>\n    <Dot />\n  </div>\n))\nInputOTPSeparator.displayName = \"InputOTPSeparator\"\n\nexport { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator }\n","path":null,"size_bytes":2154,"size_tokens":null},"client/src/components/ui/menubar.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as MenubarPrimitive from \"@radix-ui/react-menubar\"\nimport { Check, ChevronRight, Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction MenubarMenu({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {\n  return <MenubarPrimitive.Menu {...props} />\n}\n\nfunction MenubarGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Group>) {\n  return <MenubarPrimitive.Group {...props} />\n}\n\nfunction MenubarPortal({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {\n  return <MenubarPrimitive.Portal {...props} />\n}\n\nfunction MenubarRadioGroup({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {\n  return <MenubarPrimitive.RadioGroup {...props} />\n}\n\nfunction MenubarSub({\n  ...props\n}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {\n  return <MenubarPrimitive.Sub data-slot=\"menubar-sub\" {...props} />\n}\n\nconst Menubar = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"flex h-10 items-center space-x-1 rounded-md border bg-background p-1\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubar.displayName = MenubarPrimitive.Root.displayName\n\nconst MenubarTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Trigger>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Trigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-3 py-1.5 text-sm font-medium outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarTrigger.displayName = MenubarPrimitive.Trigger.displayName\n\nconst MenubarSubTrigger = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubTrigger>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubTrigger> & {\n    inset?: boolean\n  }\n>(({ className, inset, children, ...props }, ref) => (\n  <MenubarPrimitive.SubTrigger\n    ref={ref}\n    className={cn(\n      \"flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  >\n    {children}\n    <ChevronRight className=\"ml-auto h-4 w-4\" />\n  </MenubarPrimitive.SubTrigger>\n))\nMenubarSubTrigger.displayName = MenubarPrimitive.SubTrigger.displayName\n\nconst MenubarSubContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.SubContent>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.SubContent>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.SubContent\n    ref={ref}\n    className={cn(\n      \"z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarSubContent.displayName = MenubarPrimitive.SubContent.displayName\n\nconst MenubarContent = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Content>\n>(\n  (\n    { className, align = \"start\", alignOffset = -4, sideOffset = 8, ...props },\n    ref\n  ) => (\n    <MenubarPrimitive.Portal>\n      <MenubarPrimitive.Content\n        ref={ref}\n        align={align}\n        alignOffset={alignOffset}\n        sideOffset={sideOffset}\n        className={cn(\n          \"z-50 min-w-[12rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-menubar-content-transform-origin]\",\n          className\n        )}\n        {...props}\n      />\n    </MenubarPrimitive.Portal>\n  )\n)\nMenubarContent.displayName = MenubarPrimitive.Content.displayName\n\nconst MenubarItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Item> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarItem.displayName = MenubarPrimitive.Item.displayName\n\nconst MenubarCheckboxItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.CheckboxItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.CheckboxItem>\n>(({ className, children, checked, ...props }, ref) => (\n  <MenubarPrimitive.CheckboxItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    checked={checked}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Check className=\"h-4 w-4\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.CheckboxItem>\n))\nMenubarCheckboxItem.displayName = MenubarPrimitive.CheckboxItem.displayName\n\nconst MenubarRadioItem = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.RadioItem>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.RadioItem>\n>(({ className, children, ...props }, ref) => (\n  <MenubarPrimitive.RadioItem\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none focus:bg-accent focus:text-accent-foreground data-[disabled]:pointer-events-none data-[disabled]:opacity-50\",\n      className\n    )}\n    {...props}\n  >\n    <span className=\"absolute left-2 flex h-3.5 w-3.5 items-center justify-center\">\n      <MenubarPrimitive.ItemIndicator>\n        <Circle className=\"h-2 w-2 fill-current\" />\n      </MenubarPrimitive.ItemIndicator>\n    </span>\n    {children}\n  </MenubarPrimitive.RadioItem>\n))\nMenubarRadioItem.displayName = MenubarPrimitive.RadioItem.displayName\n\nconst MenubarLabel = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Label>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Label> & {\n    inset?: boolean\n  }\n>(({ className, inset, ...props }, ref) => (\n  <MenubarPrimitive.Label\n    ref={ref}\n    className={cn(\n      \"px-2 py-1.5 text-sm font-semibold\",\n      inset && \"pl-8\",\n      className\n    )}\n    {...props}\n  />\n))\nMenubarLabel.displayName = MenubarPrimitive.Label.displayName\n\nconst MenubarSeparator = React.forwardRef<\n  React.ElementRef<typeof MenubarPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof MenubarPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <MenubarPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 my-1 h-px bg-muted\", className)}\n    {...props}\n  />\n))\nMenubarSeparator.displayName = MenubarPrimitive.Separator.displayName\n\nconst MenubarShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nMenubarShortcut.displayname = \"MenubarShortcut\"\n\nexport {\n  Menubar,\n  MenubarMenu,\n  MenubarTrigger,\n  MenubarContent,\n  MenubarItem,\n  MenubarSeparator,\n  MenubarLabel,\n  MenubarCheckboxItem,\n  MenubarRadioGroup,\n  MenubarRadioItem,\n  MenubarPortal,\n  MenubarSubContent,\n  MenubarSubTrigger,\n  MenubarGroup,\n  MenubarSub,\n  MenubarShortcut,\n}\n","path":null,"size_bytes":8605,"size_tokens":null},"client/src/components/WeatherMapLayers.tsx":{"content":"import { useEffect, useRef } from 'react';\nimport L from 'leaflet';\nimport type { WeatherOutlook } from '@/hooks/useWeatherData';\n\ninterface WeatherMapLayersProps {\n  map: L.Map | null;\n  outlookData: WeatherOutlook | undefined;\n  utilitiesData: any;\n  showOutlookLayer: boolean;\n  showUtilitiesLayer: boolean;\n  visibleDays?: { [key: number]: boolean };\n}\n\nexport default function WeatherMapLayers({\n  map,\n  outlookData,\n  utilitiesData,\n  showOutlookLayer,\n  showUtilitiesLayer,\n  visibleDays = { 1: true, 2: true, 3: true }\n}: WeatherMapLayersProps) {\n  const outlookLayerRef = useRef<L.LayerGroup | null>(null);\n  const utilitiesLayerRef = useRef<L.LayerGroup | null>(null);\n\n  // Helper function to get risk colors\n  const getRiskColor = (category: string): string => {\n    switch (category.toUpperCase()) {\n      case 'HIGH': return '#dc2626'; // red-600\n      case 'MDT': return '#f97316';  // orange-500\n      case 'ENH': return '#eab308';  // yellow-500\n      case 'SLGT': return '#16a34a'; // green-600\n      default: return '#6b7280';     // gray-500\n    }\n  };\n\n  // Helper function to get risk opacity\n  const getRiskOpacity = (category: string): number => {\n    switch (category.toUpperCase()) {\n      case 'HIGH': return 0.7;\n      case 'MDT': return 0.6;\n      case 'ENH': return 0.5;\n      case 'SLGT': return 0.4;\n      default: return 0.3;\n    }\n  };\n\n  // Add SPC Outlook layer\n  useEffect(() => {\n    if (!map || !outlookData) return;\n\n    // Remove existing layer\n    if (outlookLayerRef.current) {\n      map.removeLayer(outlookLayerRef.current);\n      outlookLayerRef.current = null;\n    }\n\n    if (!showOutlookLayer) return;\n\n    // Create new layer group\n    const layerGroup = L.layerGroup();\n\n    try {\n      outlookData.features.forEach((feature) => {\n        if (!feature.geometry || !feature.geometry.coordinates) return;\n\n        const category = feature.properties.category || '';\n        const day = feature.properties.outlook_day || 1;\n\n        // Skip if this day is not visible\n        if (!visibleDays[day]) return;\n\n        // Convert GeoJSON coordinates to Leaflet LatLng format\n        const coords = convertGeoJSONToLeaflet(feature.geometry);\n\n        if (coords && coords.length > 0) {\n          const polygon = L.polygon(coords, {\n            color: getRiskColor(category),\n            fillColor: getRiskColor(category),\n            fillOpacity: getRiskOpacity(category),\n            weight: 2,\n            opacity: 0.8\n          });\n\n          // Add popup with risk information\n          polygon.bindPopup(`\n            <div class=\"text-sm\">\n              <strong>Day ${day} Outlook</strong><br/>\n              Risk Level: <span style=\"color: ${getRiskColor(category)}; font-weight: bold;\">${category}</span><br/>\n              <em>SPC Convective Outlook</em>\n            </div>\n          `);\n\n          layerGroup.addLayer(polygon);\n        }\n      });\n\n      layerGroup.addTo(map);\n      outlookLayerRef.current = layerGroup;\n\n    } catch (error) {\n      console.error('Error adding SPC outlook layer:', error);\n    }\n\n  }, [map, outlookData, showOutlookLayer, visibleDays]);\n\n  // Add Electric Utilities layer with optimization\n  useEffect(() => {\n    if (!map || !utilitiesData) return;\n\n    // Remove existing layer\n    if (utilitiesLayerRef.current) {\n      map.removeLayer(utilitiesLayerRef.current);\n      utilitiesLayerRef.current = null;\n    }\n\n    if (!showUtilitiesLayer) return;\n\n    // Create new layer group\n    const layerGroup = L.layerGroup();\n\n    try {\n      if (utilitiesData.features) {\n        console.log(`Initializing map...`);\n        console.log(`Map created, adding tile layer...`);\n        console.log(`Tile layer added`);\n\n        // Get current map zoom for styling\n        const currentZoom = map.getZoom();\n\n        // Display all fetched utilities (already sorted by customer count on server)\n        const filteredFeatures = utilitiesData.features.filter((feature: any) => {\n          return feature.geometry && feature.geometry.coordinates;\n        });\n\n        console.log(`Updated resource markers: ${filteredFeatures.length} resources (top utilities by customer count)`);\n\n        // Process filtered features\n        filteredFeatures.forEach((feature: any) => {\n          // Use authentic field names from the ArcGIS service\n          const name = feature.properties.NAME || 'Unknown Utility';\n          const customers = feature.properties.CUSTOMERS || 0;\n          const state = feature.properties.STATE || '';\n          const utilityType = feature.properties.TYPE || '';\n          const address = feature.properties.ADDRESS || '';\n          const city = feature.properties.CITY || '';\n\n          // Convert GeoJSON coordinates to Leaflet LatLng format\n          const coords = convertGeoJSONToLeaflet(feature.geometry);\n\n          if (coords && coords.length > 0) {\n            try {\n              // Simplified polygon creation - let Leaflet handle the geometry types\n              const polygon = L.polygon(coords, {\n                color: '#3b82f6', // blue-500\n                fillColor: '#3b82f6',\n                fillOpacity: 0.1,\n                weight: 1,\n                opacity: 0.6\n              });\n\n              // Add popup with authentic utility information\n              polygon.bindPopup(`\n                <div class=\"text-sm max-w-64\">\n                  <strong class=\"text-base\">${name}</strong><br/>\n                  ${state ? `<div class=\"text-gray-600\">${city ? city + ', ' : ''}${state}</div>` : ''}\n                  <div style=\"font-weight: bold; color: #2563eb; font-size: 14px; margin: 4px 0;\">\n                    ${customers > 0 ? customers.toLocaleString() : 'N/A'} Customers\n                  </div>\n                  ${utilityType && utilityType !== 'NOT AVAILABLE' ? `<div class=\"text-xs text-gray-500\">${utilityType}</div>` : ''}\n                  <em class=\"text-xs\">Electric Service Territory</em>\n                </div>\n              `);\n\n              layerGroup.addLayer(polygon);\n              \n            } catch (error) {\n              console.error(`Error creating polygon for utility ${name}:`, error, feature.geometry.type);\n            }\n          } else {\n            console.warn(`No valid coordinates for utility ${name}`);\n          }\n        });\n      }\n\n      layerGroup.addTo(map);\n      utilitiesLayerRef.current = layerGroup;\n\n    } catch (error) {\n      console.error('Error adding utilities layer:', error);\n    }\n\n  }, [map, utilitiesData, showUtilitiesLayer]);\n\n  // Removed zoom-based optimization - show all utilities >2500 customers at all zoom levels\n\n  // Cleanup on unmount\n  useEffect(() => {\n    return () => {\n      if (map) {\n        if (outlookLayerRef.current) {\n          map.removeLayer(outlookLayerRef.current);\n        }\n        if (utilitiesLayerRef.current) {\n          map.removeLayer(utilitiesLayerRef.current);\n        }\n      }\n    };\n  }, [map]);\n\n  return null; // This component doesn't render anything directly\n}\n\n// Helper function to convert GeoJSON coordinates to Leaflet format\nfunction convertGeoJSONToLeaflet(geometry: any): L.LatLngExpression[][] | null {\n  try {\n    if (!geometry || !geometry.coordinates) {\n      return null;\n    }\n\n    if (geometry.type === 'Polygon') {\n      // Standard polygon: array of rings (first ring is exterior, others are holes)\n      return geometry.coordinates.map((ring: number[][]) =>\n        ring.map((coord: number[]) => [coord[1], coord[0]] as L.LatLngExpression)\n      );\n    } else if (geometry.type === 'MultiPolygon') {\n      // MultiPolygon: take the first (largest) polygon only to simplify\n      if (geometry.coordinates.length > 0) {\n        const firstPolygon = geometry.coordinates[0];\n        return firstPolygon.map((ring: number[][]) =>\n          ring.map((coord: number[]) => [coord[1], coord[0]] as L.LatLngExpression)\n        );\n      }\n    }\n    \n    console.warn(`Unsupported geometry type: ${geometry.type}`);\n    return null;\n  } catch (error) {\n    console.error('Error converting GeoJSON coordinates:', error, geometry);\n    return null;\n  }\n}","path":null,"size_bytes":8087,"size_tokens":null},"client/src/components/ui/popover.tsx":{"content":"import * as React from \"react\"\nimport * as PopoverPrimitive from \"@radix-ui/react-popover\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Popover = PopoverPrimitive.Root\n\nconst PopoverTrigger = PopoverPrimitive.Trigger\n\nconst PopoverContent = React.forwardRef<\n  React.ElementRef<typeof PopoverPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof PopoverPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <PopoverPrimitive.Portal>\n    <PopoverPrimitive.Content\n      ref={ref}\n      align={align}\n      sideOffset={sideOffset}\n      className={cn(\n        \"z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-popover-content-transform-origin]\",\n        className\n      )}\n      {...props}\n    />\n  </PopoverPrimitive.Portal>\n))\nPopoverContent.displayName = PopoverPrimitive.Content.displayName\n\nexport { Popover, PopoverTrigger, PopoverContent }\n","path":null,"size_bytes":1280,"size_tokens":null},"client/src/components/ui/radio-group.tsx":{"content":"import * as React from \"react\"\nimport * as RadioGroupPrimitive from \"@radix-ui/react-radio-group\"\nimport { Circle } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst RadioGroup = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Root>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Root\n      className={cn(\"grid gap-2\", className)}\n      {...props}\n      ref={ref}\n    />\n  )\n})\nRadioGroup.displayName = RadioGroupPrimitive.Root.displayName\n\nconst RadioGroupItem = React.forwardRef<\n  React.ElementRef<typeof RadioGroupPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof RadioGroupPrimitive.Item>\n>(({ className, ...props }, ref) => {\n  return (\n    <RadioGroupPrimitive.Item\n      ref={ref}\n      className={cn(\n        \"aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    >\n      <RadioGroupPrimitive.Indicator className=\"flex items-center justify-center\">\n        <Circle className=\"h-2.5 w-2.5 fill-current text-current\" />\n      </RadioGroupPrimitive.Indicator>\n    </RadioGroupPrimitive.Item>\n  )\n})\nRadioGroupItem.displayName = RadioGroupPrimitive.Item.displayName\n\nexport { RadioGroup, RadioGroupItem }\n","path":null,"size_bytes":1467,"size_tokens":null},"client/src/components/ui/slider.tsx":{"content":"import * as React from \"react\"\nimport * as SliderPrimitive from \"@radix-ui/react-slider\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Slider = React.forwardRef<\n  React.ElementRef<typeof SliderPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SliderPrimitive.Root>\n>(({ className, ...props }, ref) => (\n  <SliderPrimitive.Root\n    ref={ref}\n    className={cn(\n      \"relative flex w-full touch-none select-none items-center\",\n      className\n    )}\n    {...props}\n  >\n    <SliderPrimitive.Track className=\"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary\">\n      <SliderPrimitive.Range className=\"absolute h-full bg-primary\" />\n    </SliderPrimitive.Track>\n    <SliderPrimitive.Thumb className=\"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50\" />\n  </SliderPrimitive.Root>\n))\nSlider.displayName = SliderPrimitive.Root.displayName\n\nexport { Slider }\n","path":null,"size_bytes":1077,"size_tokens":null},"client/src/hooks/useMapData.ts":{"content":"import { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport type { Resource, AnalysisPoint, InsertAnalysisPoint } from \"@shared/schema\";\n\nexport function useMapData(onPointCreated?: (pointId: number) => void) {\n  const queryClient = useQueryClient();\n  const { toast } = useToast();\n\n  const { data: resources = [], isLoading: resourcesLoading } = useQuery<Resource[]>({\n    queryKey: ['/api/resources'],\n  });\n\n  const { data: analysisPoints = [], isLoading: pointsLoading } = useQuery<AnalysisPoint[]>({\n    queryKey: ['/api/analysis-points'],\n  });\n\n  const uploadMutation = useMutation({\n    mutationFn: async (file: File) => {\n      const formData = new FormData();\n      formData.append('file', file);\n      \n      const response = await fetch('/api/upload-file', {\n        method: 'POST',\n        body: formData,\n        credentials: 'include',\n      });\n\n      if (!response.ok) {\n        const error = await response.text();\n        throw new Error(error || 'Upload failed');\n      }\n\n      return response.json();\n    },\n    onSuccess: (data) => {\n      toast({\n        title: \"File uploaded successfully\",\n        description: \"Processing KMZ file and extracting resources...\",\n      });\n\n      // Poll for job completion\n      const pollJob = () => {\n        queryClient.fetchQuery({\n          queryKey: [`/api/jobs/${data.jobId}`],\n        }).then((job: any) => {\n          if (job.status === 'completed') {\n            queryClient.invalidateQueries({ queryKey: ['/api/resources'] });\n            toast({\n              title: \"Resources loaded\",\n              description: `Successfully loaded ${job.resourceCount} resources from KMZ file.`,\n            });\n          } else if (job.status === 'failed') {\n            toast({\n              title: \"Processing failed\",\n              description: job.error || \"Failed to process KMZ file.\",\n              variant: \"destructive\",\n            });\n          } else {\n            setTimeout(pollJob, 1000);\n          }\n        });\n      };\n\n      setTimeout(pollJob, 1000);\n    },\n    onError: (error) => {\n      toast({\n        title: \"Upload failed\",\n        description: error instanceof Error ? error.message : \"Failed to upload file.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const createPointMutation = useMutation({\n    mutationFn: async (point: InsertAnalysisPoint) => {\n      const response = await apiRequest('POST', '/api/analysis-points', point);\n      return response.json();\n    },\n    onSuccess: (newPoint) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/analysis-points'] });\n      \n      // Trigger distance calculations\n      if (resources.length > 0) {\n        calculateDistancesMutation.mutate({ pointId: newPoint.id });\n      }\n\n      // Auto-select the newly created point\n      if (onPointCreated) {\n        onPointCreated(newPoint.id);\n      }\n\n      toast({\n        title: \"Analysis point created\",\n        description: `Point \"${newPoint.label}\" has been added to the map.`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to create point\",\n        description: \"Could not create analysis point.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const deletePointMutation = useMutation({\n    mutationFn: async (pointId: number) => {\n      await apiRequest('DELETE', `/api/analysis-points/${pointId}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/analysis-points'] });\n      toast({\n        title: \"Point deleted\",\n        description: \"Analysis point has been removed.\",\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Failed to delete point\",\n        description: \"Could not delete analysis point.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  const calculateDistancesMutation = useMutation({\n    mutationFn: async ({ pointId, maxDistance }: { pointId: number; maxDistance?: number }) => {\n      const response = await apiRequest('POST', `/api/calculate-distances/${pointId}`, { maxDistance });\n      return response.json();\n    },\n    onSuccess: (data, variables) => {\n      // Invalidate all calculation queries for this point\n      queryClient.invalidateQueries({ \n        queryKey: [`/api/analysis-points/${variables.pointId}/calculations`],\n        exact: false\n      });\n      toast({\n        title: \"Distances calculated\",\n        description: `Calculated distances to ${data.count} resources.`,\n      });\n    },\n    onError: () => {\n      toast({\n        title: \"Calculation failed\",\n        description: \"Could not calculate distances to resources.\",\n        variant: \"destructive\",\n      });\n    },\n  });\n\n  return {\n    resources,\n    analysisPoints,\n    isLoading: resourcesLoading || pointsLoading,\n    uploadFile: uploadMutation.mutate,\n    createAnalysisPoint: createPointMutation.mutate,\n    deleteAnalysisPoint: deletePointMutation.mutate,\n    calculateDistances: calculateDistancesMutation.mutate,\n    isUploading: uploadMutation.isPending,\n    isCreatingPoint: createPointMutation.isPending,\n  };\n}\n","path":null,"size_bytes":5164,"size_tokens":null},"client/src/components/ui/badge.tsx":{"content":"import * as React from \"react\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground hover:bg-primary/80\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80\",\n        destructive:\n          \"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80\",\n        outline: \"text-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nexport interface BadgeProps\n  extends React.HTMLAttributes<HTMLDivElement>,\n    VariantProps<typeof badgeVariants> {}\n\nfunction Badge({ className, variant, ...props }: BadgeProps) {\n  return (\n    <div className={cn(badgeVariants({ variant }), className)} {...props} />\n  )\n}\n\nexport { Badge, badgeVariants }\n","path":null,"size_bytes":1128,"size_tokens":null},"client/src/components/ui/carousel.tsx":{"content":"import * as React from \"react\"\nimport useEmblaCarousel, {\n  type UseEmblaCarouselType,\n} from \"embla-carousel-react\"\nimport { ArrowLeft, ArrowRight } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Button } from \"@/components/ui/button\"\n\ntype CarouselApi = UseEmblaCarouselType[1]\ntype UseCarouselParameters = Parameters<typeof useEmblaCarousel>\ntype CarouselOptions = UseCarouselParameters[0]\ntype CarouselPlugin = UseCarouselParameters[1]\n\ntype CarouselProps = {\n  opts?: CarouselOptions\n  plugins?: CarouselPlugin\n  orientation?: \"horizontal\" | \"vertical\"\n  setApi?: (api: CarouselApi) => void\n}\n\ntype CarouselContextProps = {\n  carouselRef: ReturnType<typeof useEmblaCarousel>[0]\n  api: ReturnType<typeof useEmblaCarousel>[1]\n  scrollPrev: () => void\n  scrollNext: () => void\n  canScrollPrev: boolean\n  canScrollNext: boolean\n} & CarouselProps\n\nconst CarouselContext = React.createContext<CarouselContextProps | null>(null)\n\nfunction useCarousel() {\n  const context = React.useContext(CarouselContext)\n\n  if (!context) {\n    throw new Error(\"useCarousel must be used within a <Carousel />\")\n  }\n\n  return context\n}\n\nconst Carousel = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement> & CarouselProps\n>(\n  (\n    {\n      orientation = \"horizontal\",\n      opts,\n      setApi,\n      plugins,\n      className,\n      children,\n      ...props\n    },\n    ref\n  ) => {\n    const [carouselRef, api] = useEmblaCarousel(\n      {\n        ...opts,\n        axis: orientation === \"horizontal\" ? \"x\" : \"y\",\n      },\n      plugins\n    )\n    const [canScrollPrev, setCanScrollPrev] = React.useState(false)\n    const [canScrollNext, setCanScrollNext] = React.useState(false)\n\n    const onSelect = React.useCallback((api: CarouselApi) => {\n      if (!api) {\n        return\n      }\n\n      setCanScrollPrev(api.canScrollPrev())\n      setCanScrollNext(api.canScrollNext())\n    }, [])\n\n    const scrollPrev = React.useCallback(() => {\n      api?.scrollPrev()\n    }, [api])\n\n    const scrollNext = React.useCallback(() => {\n      api?.scrollNext()\n    }, [api])\n\n    const handleKeyDown = React.useCallback(\n      (event: React.KeyboardEvent<HTMLDivElement>) => {\n        if (event.key === \"ArrowLeft\") {\n          event.preventDefault()\n          scrollPrev()\n        } else if (event.key === \"ArrowRight\") {\n          event.preventDefault()\n          scrollNext()\n        }\n      },\n      [scrollPrev, scrollNext]\n    )\n\n    React.useEffect(() => {\n      if (!api || !setApi) {\n        return\n      }\n\n      setApi(api)\n    }, [api, setApi])\n\n    React.useEffect(() => {\n      if (!api) {\n        return\n      }\n\n      onSelect(api)\n      api.on(\"reInit\", onSelect)\n      api.on(\"select\", onSelect)\n\n      return () => {\n        api?.off(\"select\", onSelect)\n      }\n    }, [api, onSelect])\n\n    return (\n      <CarouselContext.Provider\n        value={{\n          carouselRef,\n          api: api,\n          opts,\n          orientation:\n            orientation || (opts?.axis === \"y\" ? \"vertical\" : \"horizontal\"),\n          scrollPrev,\n          scrollNext,\n          canScrollPrev,\n          canScrollNext,\n        }}\n      >\n        <div\n          ref={ref}\n          onKeyDownCapture={handleKeyDown}\n          className={cn(\"relative\", className)}\n          role=\"region\"\n          aria-roledescription=\"carousel\"\n          {...props}\n        >\n          {children}\n        </div>\n      </CarouselContext.Provider>\n    )\n  }\n)\nCarousel.displayName = \"Carousel\"\n\nconst CarouselContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { carouselRef, orientation } = useCarousel()\n\n  return (\n    <div ref={carouselRef} className=\"overflow-hidden\">\n      <div\n        ref={ref}\n        className={cn(\n          \"flex\",\n          orientation === \"horizontal\" ? \"-ml-4\" : \"-mt-4 flex-col\",\n          className\n        )}\n        {...props}\n      />\n    </div>\n  )\n})\nCarouselContent.displayName = \"CarouselContent\"\n\nconst CarouselItem = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => {\n  const { orientation } = useCarousel()\n\n  return (\n    <div\n      ref={ref}\n      role=\"group\"\n      aria-roledescription=\"slide\"\n      className={cn(\n        \"min-w-0 shrink-0 grow-0 basis-full\",\n        orientation === \"horizontal\" ? \"pl-4\" : \"pt-4\",\n        className\n      )}\n      {...props}\n    />\n  )\n})\nCarouselItem.displayName = \"CarouselItem\"\n\nconst CarouselPrevious = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollPrev, canScrollPrev } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute  h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-left-12 top-1/2 -translate-y-1/2\"\n          : \"-top-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollPrev}\n      onClick={scrollPrev}\n      {...props}\n    >\n      <ArrowLeft className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Previous slide</span>\n    </Button>\n  )\n})\nCarouselPrevious.displayName = \"CarouselPrevious\"\n\nconst CarouselNext = React.forwardRef<\n  HTMLButtonElement,\n  React.ComponentProps<typeof Button>\n>(({ className, variant = \"outline\", size = \"icon\", ...props }, ref) => {\n  const { orientation, scrollNext, canScrollNext } = useCarousel()\n\n  return (\n    <Button\n      ref={ref}\n      variant={variant}\n      size={size}\n      className={cn(\n        \"absolute h-8 w-8 rounded-full\",\n        orientation === \"horizontal\"\n          ? \"-right-12 top-1/2 -translate-y-1/2\"\n          : \"-bottom-12 left-1/2 -translate-x-1/2 rotate-90\",\n        className\n      )}\n      disabled={!canScrollNext}\n      onClick={scrollNext}\n      {...props}\n    >\n      <ArrowRight className=\"h-4 w-4\" />\n      <span className=\"sr-only\">Next slide</span>\n    </Button>\n  )\n})\nCarouselNext.displayName = \"CarouselNext\"\n\nexport {\n  type CarouselApi,\n  Carousel,\n  CarouselContent,\n  CarouselItem,\n  CarouselPrevious,\n  CarouselNext,\n}\n","path":null,"size_bytes":6210,"size_tokens":null},"server/services/routingService.ts":{"content":"import type { AnalysisPoint, Resource } from '@shared/schema';\n\ninterface RouteResponse {\n  distance: number; // in meters\n  duration: number; // in seconds\n  geometry?: any;\n}\n\nexport class RoutingService {\n  private apiKey: string;\n\n  constructor() {\n    this.apiKey = process.env.MAPBOX_ACCESS_TOKEN || '';\n    if (!this.apiKey) {\n      console.warn('Mapbox access token not found. Falling back to distance calculations.');\n    }\n  }\n\n  async calculateRoute(from: AnalysisPoint, to: Resource): Promise<RouteResponse> {\n    if (!this.apiKey) {\n      // Fallback to straight-line distance calculation\n      return this.calculateStraightLineDistance(from, to);\n    }\n\n    try {\n      // Use Mapbox Matrix API - much more cost-effective (100k free elements/month)\n      // Note: Mapbox uses longitude,latitude format (not latitude,longitude)\n      const coordinates = `${from.longitude},${from.latitude};${to.longitude},${to.latitude}`;\n      const url = `https://api.mapbox.com/directions-matrix/v1/mapbox/driving/${coordinates}?annotations=distance,duration&access_token=${this.apiKey}`;\n\n      const response = await fetch(url);\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(`Mapbox Matrix API error: ${response.status} - ${errorText}`);\n        console.warn('Falling back to straight-line distance calculation');\n        return this.calculateStraightLineDistance(from, to);\n      }\n\n      const data = await response.json();\n\n      if (data.code !== 'Ok') {\n        console.error(`Mapbox API status: ${data.code}`);\n        console.warn('Falling back to straight-line distance calculation');\n        return this.calculateStraightLineDistance(from, to);\n      }\n\n      // Mapbox returns durations and distances as 2D arrays\n      // For a single origin to single destination, we want [0][1] (origin 0 to destination 1)\n      const distanceMeters = data.distances[0][1];\n      const durationSeconds = data.durations[0][1];\n\n      if (!distanceMeters || !durationSeconds) {\n        console.error('Mapbox API returned null distance or duration');\n        console.warn('Falling back to straight-line distance calculation');\n        return this.calculateStraightLineDistance(from, to);\n      }\n\n      console.log(`Mapbox Matrix API success: ${(distanceMeters * 0.000621371).toFixed(1)} miles, ${Math.round(durationSeconds / 60)} minutes`);\n\n      return {\n        distance: distanceMeters,\n        duration: Math.round(durationSeconds), // Convert to integer for database\n      };\n    } catch (error) {\n      console.error('Mapbox Matrix API request failed:', error);\n      console.warn('Falling back to straight-line distance calculation');\n      return this.calculateStraightLineDistance(from, to);\n    }\n  }\n\n  async calculateBatchRoutes(from: AnalysisPoint, resources: Resource[]): Promise<RouteResponse[]> {\n    if (!this.apiKey || resources.length === 0) {\n      // Fallback to straight-line distance\n      return resources.map(resource => this.calculateStraightLineDistance(from, resource));\n    }\n\n    // Use Mapbox Matrix API for efficient batch processing\n    // Split into batches of 24 destinations (1 source + 24 destinations = 25 total coordinates, Mapbox's limit)\n    const batchSize = 24;\n    const allResults: RouteResponse[] = [];\n\n    for (let i = 0; i < resources.length; i += batchSize) {\n      const batch = resources.slice(i, i + batchSize);\n      const batchResults = await this.calculateBatchWithMatrix(from, batch);\n      allResults.push(...batchResults);\n    }\n\n    return allResults;\n  }\n\n  private async calculateBatchWithMatrix(from: AnalysisPoint, resources: Resource[]): Promise<RouteResponse[]> {\n    try {\n      // Build coordinate string: origin;destination1;destination2;...\n      // Note: Mapbox uses longitude,latitude format (not latitude,longitude)\n      const originCoord = `${from.longitude},${from.latitude}`;\n      const destCoords = resources.map(r => `${r.longitude},${r.latitude}`).join(';');\n      const coordinates = `${originCoord};${destCoords}`;\n      \n      // Build URL with sources=0 (only first coordinate is origin) and destinations=all others\n      const url = `https://api.mapbox.com/directions-matrix/v1/mapbox/driving/${coordinates}?sources=0&annotations=distance,duration&access_token=${this.apiKey}`;\n\n      console.log(`Calculating batch of ${resources.length} routes using Mapbox Matrix API (cost-effective)`);\n\n      const response = await fetch(url);\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error(`Mapbox Matrix API error: ${response.status} - ${errorText}`);\n        return resources.map(r => this.calculateStraightLineDistance(from, r));\n      }\n\n      const data = await response.json();\n\n      if (data.code !== 'Ok') {\n        console.error(`Mapbox API status: ${data.code}`);\n        return resources.map(r => this.calculateStraightLineDistance(from, r));\n      }\n\n      console.log(`Received ${data.distances[0].length - 1} route elements from Mapbox Matrix API`);\n\n      // Mapbox returns durations and distances as 2D arrays\n      // For 1 origin to N destinations, we have distances[0][1...N] and durations[0][1...N]\n      // Index 0 is the origin itself (0 distance/duration), indices 1+ are the destinations\n      return resources.map((resource, index) => {\n        const destIndex = index + 1; // +1 because index 0 is the origin\n        const distanceMeters = data.distances[0][destIndex];\n        const durationSeconds = data.durations[0][destIndex];\n\n        // Handle null values (no route found between origin and destination)\n        if (distanceMeters === null || durationSeconds === null || \n            distanceMeters === undefined || durationSeconds === undefined) {\n          console.warn(`No route found for destination ${index}, using straight-line distance`);\n          return this.calculateStraightLineDistance(from, resource);\n        }\n\n        return {\n          distance: distanceMeters,\n          duration: Math.round(durationSeconds), // Convert to integer for database\n        };\n      });\n    } catch (error) {\n      console.error('Mapbox Matrix API request failed:', error);\n      return resources.map(r => this.calculateStraightLineDistance(from, r));\n    }\n  }\n\n  private calculateStraightLineDistance(from: AnalysisPoint, to: Resource): RouteResponse {\n    // Haversine formula for great-circle distance\n    const R = 6371000; // Earth's radius in meters\n    const φ1 = (from.latitude * Math.PI) / 180;\n    const φ2 = (to.latitude * Math.PI) / 180;\n    const Δφ = ((to.latitude - from.latitude) * Math.PI) / 180;\n    const Δλ = ((to.longitude - from.longitude) * Math.PI) / 180;\n\n    const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\n              Math.cos(φ1) * Math.cos(φ2) *\n              Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\n    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n\n    const distance = R * c; // in meters\n    \n    // Estimate duration based on distance (assume average speed of 55 mph for driving)\n    const averageSpeedMph = 55;\n    const distanceMiles = distance * 0.000621371; // Convert meters to miles\n    const duration = (distanceMiles / averageSpeedMph) * 3600; // in seconds\n\n    return {\n      distance: distance * 1.2, // Add 20% for road routing vs straight line\n      duration: Math.round(duration * 1.3), // Add 30% for traffic and stops\n    };\n  }\n}\n\nexport const routingService = new RoutingService();\n","path":null,"size_bytes":7468,"size_tokens":null},"client/src/components/ui/card.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Card = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"rounded-lg border bg-card text-card-foreground shadow-sm\",\n      className\n    )}\n    {...props}\n  />\n))\nCard.displayName = \"Card\"\n\nconst CardHeader = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\n    {...props}\n  />\n))\nCardHeader.displayName = \"CardHeader\"\n\nconst CardTitle = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\n      \"text-2xl font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nCardTitle.displayName = \"CardTitle\"\n\nconst CardDescription = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nCardDescription.displayName = \"CardDescription\"\n\nconst CardContent = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\n))\nCardContent.displayName = \"CardContent\"\n\nconst CardFooter = React.forwardRef<\n  HTMLDivElement,\n  React.HTMLAttributes<HTMLDivElement>\n>(({ className, ...props }, ref) => (\n  <div\n    ref={ref}\n    className={cn(\"flex items-center p-6 pt-0\", className)}\n    {...props}\n  />\n))\nCardFooter.displayName = \"CardFooter\"\n\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent }\n","path":null,"size_bytes":1858,"size_tokens":null},"client/src/lib/queryClient.ts":{"content":"import { QueryClient, QueryFunction } from \"@tanstack/react-query\";\nimport { getSessionHeaders } from \"./sessionUtils\";\n\nasync function throwIfResNotOk(res: Response) {\n  if (!res.ok) {\n    const text = (await res.text()) || res.statusText;\n    throw new Error(`${res.status}: ${text}`);\n  }\n}\n\nexport async function apiRequest(\n  method: string,\n  url: string,\n  data?: unknown | undefined,\n): Promise<Response> {\n  const headers = {\n    ...(data ? { \"Content-Type\": \"application/json\" } : {}),\n    ...getSessionHeaders(),\n  };\n\n  const res = await fetch(url, {\n    method,\n    headers,\n    body: data ? JSON.stringify(data) : undefined,\n    credentials: \"include\",\n  });\n\n  await throwIfResNotOk(res);\n  return res;\n}\n\nexport async function getJson<T>(url: string): Promise<T> {\n  const res = await apiRequest('GET', url);\n  return await res.json();\n}\n\nexport async function postJson<T>(url: string, data?: unknown): Promise<T> {\n  const res = await apiRequest('POST', url, data);\n  return await res.json();\n}\n\nexport async function patchJson<T>(url: string, data?: unknown): Promise<T> {\n  const res = await apiRequest('PATCH', url, data);\n  return await res.json();\n}\n\nexport async function deleteJson<T>(url: string): Promise<T> {\n  const res = await apiRequest('DELETE', url);\n  return await res.json();\n}\n\ntype UnauthorizedBehavior = \"returnNull\" | \"throw\";\nexport const getQueryFn: <T>(options: {\n  on401: UnauthorizedBehavior;\n}) => QueryFunction<T> =\n  ({ on401: unauthorizedBehavior }) =>\n  async ({ queryKey }) => {\n    const res = await fetch(queryKey[0] as string, {\n      headers: getSessionHeaders(),\n      credentials: \"include\",\n    });\n\n    if (unauthorizedBehavior === \"returnNull\" && res.status === 401) {\n      return null;\n    }\n\n    await throwIfResNotOk(res);\n    return await res.json();\n  };\n\nexport const queryClient = new QueryClient({\n  defaultOptions: {\n    queries: {\n      queryFn: getQueryFn({ on401: \"throw\" }),\n      refetchInterval: false,\n      refetchOnWindowFocus: false,\n      staleTime: Infinity,\n      retry: false,\n    },\n    mutations: {\n      retry: false,\n    },\n  },\n});\n","path":null,"size_bytes":2119,"size_tokens":null},"client/src/components/ui/label.tsx":{"content":"import * as React from \"react\"\nimport * as LabelPrimitive from \"@radix-ui/react-label\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst labelVariants = cva(\n  \"text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70\"\n)\n\nconst Label = React.forwardRef<\n  React.ElementRef<typeof LabelPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof LabelPrimitive.Root> &\n    VariantProps<typeof labelVariants>\n>(({ className, ...props }, ref) => (\n  <LabelPrimitive.Root\n    ref={ref}\n    className={cn(labelVariants(), className)}\n    {...props}\n  />\n))\nLabel.displayName = LabelPrimitive.Root.displayName\n\nexport { Label }\n","path":null,"size_bytes":710,"size_tokens":null},"client/src/components/ui/collapsible.tsx":{"content":"\"use client\"\n\nimport * as CollapsiblePrimitive from \"@radix-ui/react-collapsible\"\n\nconst Collapsible = CollapsiblePrimitive.Root\n\nconst CollapsibleTrigger = CollapsiblePrimitive.CollapsibleTrigger\n\nconst CollapsibleContent = CollapsiblePrimitive.CollapsibleContent\n\nexport { Collapsible, CollapsibleTrigger, CollapsibleContent }\n","path":null,"size_bytes":329,"size_tokens":null},"client/src/components/ui/drawer.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport { Drawer as DrawerPrimitive } from \"vaul\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Drawer = ({\n  shouldScaleBackground = true,\n  ...props\n}: React.ComponentProps<typeof DrawerPrimitive.Root>) => (\n  <DrawerPrimitive.Root\n    shouldScaleBackground={shouldScaleBackground}\n    {...props}\n  />\n)\nDrawer.displayName = \"Drawer\"\n\nconst DrawerTrigger = DrawerPrimitive.Trigger\n\nconst DrawerPortal = DrawerPrimitive.Portal\n\nconst DrawerClose = DrawerPrimitive.Close\n\nconst DrawerOverlay = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Overlay\n    ref={ref}\n    className={cn(\"fixed inset-0 z-50 bg-black/80\", className)}\n    {...props}\n  />\n))\nDrawerOverlay.displayName = DrawerPrimitive.Overlay.displayName\n\nconst DrawerContent = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <DrawerPortal>\n    <DrawerOverlay />\n    <DrawerPrimitive.Content\n      ref={ref}\n      className={cn(\n        \"fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto flex-col rounded-t-[10px] border bg-background\",\n        className\n      )}\n      {...props}\n    >\n      <div className=\"mx-auto mt-4 h-2 w-[100px] rounded-full bg-muted\" />\n      {children}\n    </DrawerPrimitive.Content>\n  </DrawerPortal>\n))\nDrawerContent.displayName = \"DrawerContent\"\n\nconst DrawerHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"grid gap-1.5 p-4 text-center sm:text-left\", className)}\n    {...props}\n  />\n)\nDrawerHeader.displayName = \"DrawerHeader\"\n\nconst DrawerFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\"mt-auto flex flex-col gap-2 p-4\", className)}\n    {...props}\n  />\n)\nDrawerFooter.displayName = \"DrawerFooter\"\n\nconst DrawerTitle = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Title\n    ref={ref}\n    className={cn(\n      \"text-lg font-semibold leading-none tracking-tight\",\n      className\n    )}\n    {...props}\n  />\n))\nDrawerTitle.displayName = DrawerPrimitive.Title.displayName\n\nconst DrawerDescription = React.forwardRef<\n  React.ElementRef<typeof DrawerPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof DrawerPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <DrawerPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nDrawerDescription.displayName = DrawerPrimitive.Description.displayName\n\nexport {\n  Drawer,\n  DrawerPortal,\n  DrawerOverlay,\n  DrawerTrigger,\n  DrawerClose,\n  DrawerContent,\n  DrawerHeader,\n  DrawerFooter,\n  DrawerTitle,\n  DrawerDescription,\n}\n","path":null,"size_bytes":3021,"size_tokens":null},"client/src/utils/reviewUtils.ts":{"content":"import type { ContractorReview } from \"@shared/schema\";\n\nexport interface ContractorAverageRating {\n  averageRating: number;\n  reviewCount: number;\n  communicationAvg: number;\n  workQualityAvg: number;\n  collaborationAvg: number;\n  documentationAvg: number;\n  recommendationPercentage: number;\n}\n\nexport function calculateContractorAverageRating(reviews: ContractorReview[]): ContractorAverageRating {\n  if (reviews.length === 0) {\n    return {\n      averageRating: 0,\n      reviewCount: 0,\n      communicationAvg: 0,\n      workQualityAvg: 0,\n      collaborationAvg: 0,\n      documentationAvg: 0,\n      recommendationPercentage: 0,\n    };\n  }\n\n  const communicationAvg = reviews.reduce((sum, review) => sum + review.communicationRating, 0) / reviews.length;\n  const workQualityAvg = reviews.reduce((sum, review) => sum + review.workQualityRating, 0) / reviews.length;\n  const collaborationAvg = reviews.reduce((sum, review) => sum + review.collaborationRating, 0) / reviews.length;\n  const documentationAvg = reviews.reduce((sum, review) => sum + review.documentationRating, 0) / reviews.length;\n\n  // Overall average is the average of all four rating categories\n  const averageRating = (communicationAvg + workQualityAvg + collaborationAvg + documentationAvg) / 4;\n\n  // Calculate recommendation percentage\n  const recommendationsCount = reviews.filter(review => review.wouldRecommend).length;\n  const recommendationPercentage = (recommendationsCount / reviews.length) * 100;\n\n  return {\n    averageRating: Math.round(averageRating * 10) / 10, // Round to 1 decimal place\n    reviewCount: reviews.length,\n    communicationAvg: Math.round(communicationAvg * 10) / 10,\n    workQualityAvg: Math.round(workQualityAvg * 10) / 10,\n    collaborationAvg: Math.round(collaborationAvg * 10) / 10,\n    documentationAvg: Math.round(documentationAvg * 10) / 10,\n    recommendationPercentage: Math.round(recommendationPercentage),\n  };\n}\n\n","path":null,"size_bytes":1926,"size_tokens":null},"client/src/components/ui/command.tsx":{"content":"import * as React from \"react\"\nimport { type DialogProps } from \"@radix-ui/react-dialog\"\nimport { Command as CommandPrimitive } from \"cmdk\"\nimport { Search } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\nimport { Dialog, DialogContent } from \"@/components/ui/dialog\"\n\nconst Command = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive\n    ref={ref}\n    className={cn(\n      \"flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\nCommand.displayName = CommandPrimitive.displayName\n\nconst CommandDialog = ({ children, ...props }: DialogProps) => {\n  return (\n    <Dialog {...props}>\n      <DialogContent className=\"overflow-hidden p-0 shadow-lg\">\n        <Command className=\"[&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-group]]:px-2 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5\">\n          {children}\n        </Command>\n      </DialogContent>\n    </Dialog>\n  )\n}\n\nconst CommandInput = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Input>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Input>\n>(({ className, ...props }, ref) => (\n  <div className=\"flex items-center border-b px-3\" cmdk-input-wrapper=\"\">\n    <Search className=\"mr-2 h-4 w-4 shrink-0 opacity-50\" />\n    <CommandPrimitive.Input\n      ref={ref}\n      className={cn(\n        \"flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50\",\n        className\n      )}\n      {...props}\n    />\n  </div>\n))\n\nCommandInput.displayName = CommandPrimitive.Input.displayName\n\nconst CommandList = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.List>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.List>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.List\n    ref={ref}\n    className={cn(\"max-h-[300px] overflow-y-auto overflow-x-hidden\", className)}\n    {...props}\n  />\n))\n\nCommandList.displayName = CommandPrimitive.List.displayName\n\nconst CommandEmpty = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Empty>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Empty>\n>((props, ref) => (\n  <CommandPrimitive.Empty\n    ref={ref}\n    className=\"py-6 text-center text-sm\"\n    {...props}\n  />\n))\n\nCommandEmpty.displayName = CommandPrimitive.Empty.displayName\n\nconst CommandGroup = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Group>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Group>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Group\n    ref={ref}\n    className={cn(\n      \"overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandGroup.displayName = CommandPrimitive.Group.displayName\n\nconst CommandSeparator = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Separator>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Separator>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Separator\n    ref={ref}\n    className={cn(\"-mx-1 h-px bg-border\", className)}\n    {...props}\n  />\n))\nCommandSeparator.displayName = CommandPrimitive.Separator.displayName\n\nconst CommandItem = React.forwardRef<\n  React.ElementRef<typeof CommandPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof CommandPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <CommandPrimitive.Item\n    ref={ref}\n    className={cn(\n      \"relative flex cursor-default gap-2 select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0\",\n      className\n    )}\n    {...props}\n  />\n))\n\nCommandItem.displayName = CommandPrimitive.Item.displayName\n\nconst CommandShortcut = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLSpanElement>) => {\n  return (\n    <span\n      className={cn(\n        \"ml-auto text-xs tracking-widest text-muted-foreground\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\nCommandShortcut.displayName = \"CommandShortcut\"\n\nexport {\n  Command,\n  CommandDialog,\n  CommandInput,\n  CommandList,\n  CommandEmpty,\n  CommandGroup,\n  CommandItem,\n  CommandShortcut,\n  CommandSeparator,\n}\n","path":null,"size_bytes":4885,"size_tokens":null},"client/src/components/ui/hover-card.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as HoverCardPrimitive from \"@radix-ui/react-hover-card\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst HoverCard = HoverCardPrimitive.Root\n\nconst HoverCardTrigger = HoverCardPrimitive.Trigger\n\nconst HoverCardContent = React.forwardRef<\n  React.ElementRef<typeof HoverCardPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof HoverCardPrimitive.Content>\n>(({ className, align = \"center\", sideOffset = 4, ...props }, ref) => (\n  <HoverCardPrimitive.Content\n    ref={ref}\n    align={align}\n    sideOffset={sideOffset}\n    className={cn(\n      \"z-50 w-64 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 origin-[--radix-hover-card-content-transform-origin]\",\n      className\n    )}\n    {...props}\n  />\n))\nHoverCardContent.displayName = HoverCardPrimitive.Content.displayName\n\nexport { HoverCard, HoverCardTrigger, HoverCardContent }\n","path":null,"size_bytes":1251,"size_tokens":null},"client/src/components/ui/accordion.tsx":{"content":"import * as React from \"react\"\nimport * as AccordionPrimitive from \"@radix-ui/react-accordion\"\nimport { ChevronDown } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Accordion = AccordionPrimitive.Root\n\nconst AccordionItem = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Item>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Item>\n>(({ className, ...props }, ref) => (\n  <AccordionPrimitive.Item\n    ref={ref}\n    className={cn(\"border-b\", className)}\n    {...props}\n  />\n))\nAccordionItem.displayName = \"AccordionItem\"\n\nconst AccordionTrigger = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Trigger>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Trigger>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Header className=\"flex\">\n    <AccordionPrimitive.Trigger\n      ref={ref}\n      className={cn(\n        \"flex flex-1 items-center justify-between py-4 font-medium transition-all hover:underline [&[data-state=open]>svg]:rotate-180\",\n        className\n      )}\n      {...props}\n    >\n      {children}\n      <ChevronDown className=\"h-4 w-4 shrink-0 transition-transform duration-200\" />\n    </AccordionPrimitive.Trigger>\n  </AccordionPrimitive.Header>\n))\nAccordionTrigger.displayName = AccordionPrimitive.Trigger.displayName\n\nconst AccordionContent = React.forwardRef<\n  React.ElementRef<typeof AccordionPrimitive.Content>,\n  React.ComponentPropsWithoutRef<typeof AccordionPrimitive.Content>\n>(({ className, children, ...props }, ref) => (\n  <AccordionPrimitive.Content\n    ref={ref}\n    className=\"overflow-hidden text-sm transition-all data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down\"\n    {...props}\n  >\n    <div className={cn(\"pb-4 pt-0\", className)}>{children}</div>\n  </AccordionPrimitive.Content>\n))\n\nAccordionContent.displayName = AccordionPrimitive.Content.displayName\n\nexport { Accordion, AccordionItem, AccordionTrigger, AccordionContent }\n","path":null,"size_bytes":1977,"size_tokens":null},"client/src/components/ui/chart.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as RechartsPrimitive from \"recharts\"\n\nimport { cn } from \"@/lib/utils\"\n\n// Format: { THEME_NAME: CSS_SELECTOR }\nconst THEMES = { light: \"\", dark: \".dark\" } as const\n\nexport type ChartConfig = {\n  [k in string]: {\n    label?: React.ReactNode\n    icon?: React.ComponentType\n  } & (\n    | { color?: string; theme?: never }\n    | { color?: never; theme: Record<keyof typeof THEMES, string> }\n  )\n}\n\ntype ChartContextProps = {\n  config: ChartConfig\n}\n\nconst ChartContext = React.createContext<ChartContextProps | null>(null)\n\nfunction useChart() {\n  const context = React.useContext(ChartContext)\n\n  if (!context) {\n    throw new Error(\"useChart must be used within a <ChartContainer />\")\n  }\n\n  return context\n}\n\nconst ChartContainer = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> & {\n    config: ChartConfig\n    children: React.ComponentProps<\n      typeof RechartsPrimitive.ResponsiveContainer\n    >[\"children\"]\n  }\n>(({ id, className, children, config, ...props }, ref) => {\n  const uniqueId = React.useId()\n  const chartId = `chart-${id || uniqueId.replace(/:/g, \"\")}`\n\n  return (\n    <ChartContext.Provider value={{ config }}>\n      <div\n        data-chart={chartId}\n        ref={ref}\n        className={cn(\n          \"flex aspect-video justify-center text-xs [&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-none [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-sector]:outline-none [&_.recharts-surface]:outline-none\",\n          className\n        )}\n        {...props}\n      >\n        <ChartStyle id={chartId} config={config} />\n        <RechartsPrimitive.ResponsiveContainer>\n          {children}\n        </RechartsPrimitive.ResponsiveContainer>\n      </div>\n    </ChartContext.Provider>\n  )\n})\nChartContainer.displayName = \"Chart\"\n\nconst ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {\n  const colorConfig = Object.entries(config).filter(\n    ([, config]) => config.theme || config.color\n  )\n\n  if (!colorConfig.length) {\n    return null\n  }\n\n  return (\n    <style\n      dangerouslySetInnerHTML={{\n        __html: Object.entries(THEMES)\n          .map(\n            ([theme, prefix]) => `\n${prefix} [data-chart=${id}] {\n${colorConfig\n  .map(([key, itemConfig]) => {\n    const color =\n      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||\n      itemConfig.color\n    return color ? `  --color-${key}: ${color};` : null\n  })\n  .join(\"\\n\")}\n}\n`\n          )\n          .join(\"\\n\"),\n      }}\n    />\n  )\n}\n\nconst ChartTooltip = RechartsPrimitive.Tooltip\n\nconst ChartTooltipContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<typeof RechartsPrimitive.Tooltip> &\n    React.ComponentProps<\"div\"> & {\n      hideLabel?: boolean\n      hideIndicator?: boolean\n      indicator?: \"line\" | \"dot\" | \"dashed\"\n      nameKey?: string\n      labelKey?: string\n    }\n>(\n  (\n    {\n      active,\n      payload,\n      className,\n      indicator = \"dot\",\n      hideLabel = false,\n      hideIndicator = false,\n      label,\n      labelFormatter,\n      labelClassName,\n      formatter,\n      color,\n      nameKey,\n      labelKey,\n    },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    const tooltipLabel = React.useMemo(() => {\n      if (hideLabel || !payload?.length) {\n        return null\n      }\n\n      const [item] = payload\n      const key = `${labelKey || item?.dataKey || item?.name || \"value\"}`\n      const itemConfig = getPayloadConfigFromPayload(config, item, key)\n      const value =\n        !labelKey && typeof label === \"string\"\n          ? config[label as keyof typeof config]?.label || label\n          : itemConfig?.label\n\n      if (labelFormatter) {\n        return (\n          <div className={cn(\"font-medium\", labelClassName)}>\n            {labelFormatter(value, payload)}\n          </div>\n        )\n      }\n\n      if (!value) {\n        return null\n      }\n\n      return <div className={cn(\"font-medium\", labelClassName)}>{value}</div>\n    }, [\n      label,\n      labelFormatter,\n      payload,\n      hideLabel,\n      labelClassName,\n      config,\n      labelKey,\n    ])\n\n    if (!active || !payload?.length) {\n      return null\n    }\n\n    const nestLabel = payload.length === 1 && indicator !== \"dot\"\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"grid min-w-[8rem] items-start gap-1.5 rounded-lg border border-border/50 bg-background px-2.5 py-1.5 text-xs shadow-xl\",\n          className\n        )}\n      >\n        {!nestLabel ? tooltipLabel : null}\n        <div className=\"grid gap-1.5\">\n          {payload.map((item, index) => {\n            const key = `${nameKey || item.name || item.dataKey || \"value\"}`\n            const itemConfig = getPayloadConfigFromPayload(config, item, key)\n            const indicatorColor = color || item.payload.fill || item.color\n\n            return (\n              <div\n                key={item.dataKey}\n                className={cn(\n                  \"flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5 [&>svg]:text-muted-foreground\",\n                  indicator === \"dot\" && \"items-center\"\n                )}\n              >\n                {formatter && item?.value !== undefined && item.name ? (\n                  formatter(item.value, item.name, item, index, item.payload)\n                ) : (\n                  <>\n                    {itemConfig?.icon ? (\n                      <itemConfig.icon />\n                    ) : (\n                      !hideIndicator && (\n                        <div\n                          className={cn(\n                            \"shrink-0 rounded-[2px] border-[--color-border] bg-[--color-bg]\",\n                            {\n                              \"h-2.5 w-2.5\": indicator === \"dot\",\n                              \"w-1\": indicator === \"line\",\n                              \"w-0 border-[1.5px] border-dashed bg-transparent\":\n                                indicator === \"dashed\",\n                              \"my-0.5\": nestLabel && indicator === \"dashed\",\n                            }\n                          )}\n                          style={\n                            {\n                              \"--color-bg\": indicatorColor,\n                              \"--color-border\": indicatorColor,\n                            } as React.CSSProperties\n                          }\n                        />\n                      )\n                    )}\n                    <div\n                      className={cn(\n                        \"flex flex-1 justify-between leading-none\",\n                        nestLabel ? \"items-end\" : \"items-center\"\n                      )}\n                    >\n                      <div className=\"grid gap-1.5\">\n                        {nestLabel ? tooltipLabel : null}\n                        <span className=\"text-muted-foreground\">\n                          {itemConfig?.label || item.name}\n                        </span>\n                      </div>\n                      {item.value && (\n                        <span className=\"font-mono font-medium tabular-nums text-foreground\">\n                          {item.value.toLocaleString()}\n                        </span>\n                      )}\n                    </div>\n                  </>\n                )}\n              </div>\n            )\n          })}\n        </div>\n      </div>\n    )\n  }\n)\nChartTooltipContent.displayName = \"ChartTooltip\"\n\nconst ChartLegend = RechartsPrimitive.Legend\n\nconst ChartLegendContent = React.forwardRef<\n  HTMLDivElement,\n  React.ComponentProps<\"div\"> &\n    Pick<RechartsPrimitive.LegendProps, \"payload\" | \"verticalAlign\"> & {\n      hideIcon?: boolean\n      nameKey?: string\n    }\n>(\n  (\n    { className, hideIcon = false, payload, verticalAlign = \"bottom\", nameKey },\n    ref\n  ) => {\n    const { config } = useChart()\n\n    if (!payload?.length) {\n      return null\n    }\n\n    return (\n      <div\n        ref={ref}\n        className={cn(\n          \"flex items-center justify-center gap-4\",\n          verticalAlign === \"top\" ? \"pb-3\" : \"pt-3\",\n          className\n        )}\n      >\n        {payload.map((item) => {\n          const key = `${nameKey || item.dataKey || \"value\"}`\n          const itemConfig = getPayloadConfigFromPayload(config, item, key)\n\n          return (\n            <div\n              key={item.value}\n              className={cn(\n                \"flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3 [&>svg]:text-muted-foreground\"\n              )}\n            >\n              {itemConfig?.icon && !hideIcon ? (\n                <itemConfig.icon />\n              ) : (\n                <div\n                  className=\"h-2 w-2 shrink-0 rounded-[2px]\"\n                  style={{\n                    backgroundColor: item.color,\n                  }}\n                />\n              )}\n              {itemConfig?.label}\n            </div>\n          )\n        })}\n      </div>\n    )\n  }\n)\nChartLegendContent.displayName = \"ChartLegend\"\n\n// Helper to extract item config from a payload.\nfunction getPayloadConfigFromPayload(\n  config: ChartConfig,\n  payload: unknown,\n  key: string\n) {\n  if (typeof payload !== \"object\" || payload === null) {\n    return undefined\n  }\n\n  const payloadPayload =\n    \"payload\" in payload &&\n    typeof payload.payload === \"object\" &&\n    payload.payload !== null\n      ? payload.payload\n      : undefined\n\n  let configLabelKey: string = key\n\n  if (\n    key in payload &&\n    typeof payload[key as keyof typeof payload] === \"string\"\n  ) {\n    configLabelKey = payload[key as keyof typeof payload] as string\n  } else if (\n    payloadPayload &&\n    key in payloadPayload &&\n    typeof payloadPayload[key as keyof typeof payloadPayload] === \"string\"\n  ) {\n    configLabelKey = payloadPayload[\n      key as keyof typeof payloadPayload\n    ] as string\n  }\n\n  return configLabelKey in config\n    ? config[configLabelKey]\n    : config[key as keyof typeof config]\n}\n\nexport {\n  ChartContainer,\n  ChartTooltip,\n  ChartTooltipContent,\n  ChartLegend,\n  ChartLegendContent,\n  ChartStyle,\n}\n","path":null,"size_bytes":10481,"size_tokens":null},"client/src/components/ui/separator.tsx":{"content":"import * as React from \"react\"\nimport * as SeparatorPrimitive from \"@radix-ui/react-separator\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Separator = React.forwardRef<\n  React.ElementRef<typeof SeparatorPrimitive.Root>,\n  React.ComponentPropsWithoutRef<typeof SeparatorPrimitive.Root>\n>(\n  (\n    { className, orientation = \"horizontal\", decorative = true, ...props },\n    ref\n  ) => (\n    <SeparatorPrimitive.Root\n      ref={ref}\n      decorative={decorative}\n      orientation={orientation}\n      className={cn(\n        \"shrink-0 bg-border\",\n        orientation === \"horizontal\" ? \"h-[1px] w-full\" : \"h-full w-[1px]\",\n        className\n      )}\n      {...props}\n    />\n  )\n)\nSeparator.displayName = SeparatorPrimitive.Root.displayName\n\nexport { Separator }\n","path":null,"size_bytes":756,"size_tokens":null},"drizzle.config.ts":{"content":"import { defineConfig } from \"drizzle-kit\";\n\nif (!process.env.DATABASE_URL) {\n  throw new Error(\"DATABASE_URL, ensure the database is provisioned\");\n}\n\nexport default defineConfig({\n  out: \"./migrations\",\n  schema: \"./shared/schema.ts\",\n  dialect: \"postgresql\",\n  dbCredentials: {\n    url: process.env.DATABASE_URL,\n  },\n});\n","path":null,"size_bytes":325,"size_tokens":null},"client/src/components/ui/table.tsx":{"content":"import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Table = React.forwardRef<\n  HTMLTableElement,\n  React.HTMLAttributes<HTMLTableElement>\n>(({ className, ...props }, ref) => (\n  <div className=\"relative w-full overflow-auto\">\n    <table\n      ref={ref}\n      className={cn(\"w-full caption-bottom text-sm\", className)}\n      {...props}\n    />\n  </div>\n))\nTable.displayName = \"Table\"\n\nconst TableHeader = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <thead ref={ref} className={cn(\"[&_tr]:border-b\", className)} {...props} />\n))\nTableHeader.displayName = \"TableHeader\"\n\nconst TableBody = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tbody\n    ref={ref}\n    className={cn(\"[&_tr:last-child]:border-0\", className)}\n    {...props}\n  />\n))\nTableBody.displayName = \"TableBody\"\n\nconst TableFooter = React.forwardRef<\n  HTMLTableSectionElement,\n  React.HTMLAttributes<HTMLTableSectionElement>\n>(({ className, ...props }, ref) => (\n  <tfoot\n    ref={ref}\n    className={cn(\n      \"border-t bg-muted/50 font-medium [&>tr]:last:border-b-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableFooter.displayName = \"TableFooter\"\n\nconst TableRow = React.forwardRef<\n  HTMLTableRowElement,\n  React.HTMLAttributes<HTMLTableRowElement>\n>(({ className, ...props }, ref) => (\n  <tr\n    ref={ref}\n    className={cn(\n      \"border-b transition-colors hover:bg-muted/50 data-[state=selected]:bg-muted\",\n      className\n    )}\n    {...props}\n  />\n))\nTableRow.displayName = \"TableRow\"\n\nconst TableHead = React.forwardRef<\n  HTMLTableCellElement,\n  React.ThHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <th\n    ref={ref}\n    className={cn(\n      \"h-12 px-4 text-left align-middle font-medium text-muted-foreground [&:has([role=checkbox])]:pr-0\",\n      className\n    )}\n    {...props}\n  />\n))\nTableHead.displayName = \"TableHead\"\n\nconst TableCell = React.forwardRef<\n  HTMLTableCellElement,\n  React.TdHTMLAttributes<HTMLTableCellElement>\n>(({ className, ...props }, ref) => (\n  <td\n    ref={ref}\n    className={cn(\"p-4 align-middle [&:has([role=checkbox])]:pr-0\", className)}\n    {...props}\n  />\n))\nTableCell.displayName = \"TableCell\"\n\nconst TableCaption = React.forwardRef<\n  HTMLTableCaptionElement,\n  React.HTMLAttributes<HTMLTableCaptionElement>\n>(({ className, ...props }, ref) => (\n  <caption\n    ref={ref}\n    className={cn(\"mt-4 text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nTableCaption.displayName = \"TableCaption\"\n\nexport {\n  Table,\n  TableHeader,\n  TableBody,\n  TableFooter,\n  TableHead,\n  TableRow,\n  TableCell,\n  TableCaption,\n}\n","path":null,"size_bytes":2765,"size_tokens":null},"client/src/components/ui/sheet.tsx":{"content":"\"use client\"\n\nimport * as React from \"react\"\nimport * as SheetPrimitive from \"@radix-ui/react-dialog\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\nimport { X } from \"lucide-react\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst Sheet = SheetPrimitive.Root\n\nconst SheetTrigger = SheetPrimitive.Trigger\n\nconst SheetClose = SheetPrimitive.Close\n\nconst SheetPortal = SheetPrimitive.Portal\n\nconst SheetOverlay = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Overlay>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Overlay>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Overlay\n    className={cn(\n      \"fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0\",\n      className\n    )}\n    {...props}\n    ref={ref}\n  />\n))\nSheetOverlay.displayName = SheetPrimitive.Overlay.displayName\n\nconst sheetVariants = cva(\n  \"fixed z-50 gap-4 bg-background p-6 shadow-lg transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-300 data-[state=open]:duration-500\",\n  {\n    variants: {\n      side: {\n        top: \"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top\",\n        bottom:\n          \"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom\",\n        left: \"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm\",\n        right:\n          \"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm\",\n      },\n    },\n    defaultVariants: {\n      side: \"right\",\n    },\n  }\n)\n\ninterface SheetContentProps\n  extends React.ComponentPropsWithoutRef<typeof SheetPrimitive.Content>,\n    VariantProps<typeof sheetVariants> {}\n\nconst SheetContent = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Content>,\n  SheetContentProps\n>(({ side = \"right\", className, children, ...props }, ref) => (\n  <SheetPortal>\n    <SheetOverlay />\n    <SheetPrimitive.Content\n      ref={ref}\n      className={cn(sheetVariants({ side }), className)}\n      {...props}\n    >\n      {children}\n      <SheetPrimitive.Close className=\"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-secondary\">\n        <X className=\"h-4 w-4\" />\n        <span className=\"sr-only\">Close</span>\n      </SheetPrimitive.Close>\n    </SheetPrimitive.Content>\n  </SheetPortal>\n))\nSheetContent.displayName = SheetPrimitive.Content.displayName\n\nconst SheetHeader = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col space-y-2 text-center sm:text-left\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetHeader.displayName = \"SheetHeader\"\n\nconst SheetFooter = ({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) => (\n  <div\n    className={cn(\n      \"flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2\",\n      className\n    )}\n    {...props}\n  />\n)\nSheetFooter.displayName = \"SheetFooter\"\n\nconst SheetTitle = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Title>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Title>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Title\n    ref={ref}\n    className={cn(\"text-lg font-semibold text-foreground\", className)}\n    {...props}\n  />\n))\nSheetTitle.displayName = SheetPrimitive.Title.displayName\n\nconst SheetDescription = React.forwardRef<\n  React.ElementRef<typeof SheetPrimitive.Description>,\n  React.ComponentPropsWithoutRef<typeof SheetPrimitive.Description>\n>(({ className, ...props }, ref) => (\n  <SheetPrimitive.Description\n    ref={ref}\n    className={cn(\"text-sm text-muted-foreground\", className)}\n    {...props}\n  />\n))\nSheetDescription.displayName = SheetPrimitive.Description.displayName\n\nexport {\n  Sheet,\n  SheetPortal,\n  SheetOverlay,\n  SheetTrigger,\n  SheetClose,\n  SheetContent,\n  SheetHeader,\n  SheetFooter,\n  SheetTitle,\n  SheetDescription,\n}\n","path":null,"size_bytes":4281,"size_tokens":null},"client/src/components/ui/aspect-ratio.tsx":{"content":"import * as AspectRatioPrimitive from \"@radix-ui/react-aspect-ratio\"\n\nconst AspectRatio = AspectRatioPrimitive.Root\n\nexport { AspectRatio }\n","path":null,"size_bytes":140,"size_tokens":null},"client/src/pages/availability.tsx":{"content":"import { useState } from \"react\";\nimport { useMutation, useQuery } from \"@tanstack/react-query\";\nimport { queryClient, apiRequest } from \"@/lib/queryClient\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Checkbox } from \"@/components/ui/checkbox\";\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from \"@/components/ui/tabs\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from \"@/components/ui/table\";\nimport { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle, AlertDialogTrigger } from \"@/components/ui/alert-dialog\";\nimport { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from \"@/components/ui/tooltip\";\nimport { Upload, Plus, FileSpreadsheet, Users, Truck, Calendar, CheckCircle, Clock, AlertTriangle, Download, ArrowUpDown, Trash2, Map, Building, LogOut, User, MapPin } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { Link } from \"wouter\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport AppHeader from \"@/components/AppHeader\";\nimport type { Contractor } from \"@shared/schema\";\n\nconst categories = [\"Union\", \"Non-Union\", \"Veg\", \"HVAC\", \"DAT\", \"Consulting\"];\n\ninterface CrewAvailability {\n  id: number;\n  contractorId: number;\n  submissionDate: string;\n  availableStartDate: string;\n  availableEndDate?: string;\n  departureCity?: string;\n  departureState?: string;\n  departureLocation?: string; // Legacy field for backward compatibility\n  departureLatitude?: number;\n  departureLongitude?: number;\n  totalFTE?: number;\n  buckets?: number;\n  diggers?: number;\n  pickups?: number;\n  backyardMachines?: number;\n  // Legacy fields for backward compatibility\n  linemenCount: number;\n  groundmenCount: number;\n  operatorsCount: number;\n  foremanCount: number;\n  apprenticesCount: number;\n  linemenRate?: number;\n  groundmenRate?: number;\n  operatorsRate?: number;\n  foremanRate?: number;\n  apprenticesRate?: number;\n  status: string;\n  notes?: string;\n  submittedBy?: string;\n  reviewedBy?: string;\n  reviewedAt?: string;\n  contractor?: {\n    name: string;\n    company: string;\n    category: string;\n    birdRep: string;\n    departureLocations?: Array<{\n      location: string;\n      latitude: number | null;\n      longitude: number | null;\n    }>;\n  };\n}\n\nexport default function AvailabilityPage() {\n  const { toast } = useToast();\n  const { user, logout } = useAuth();\n  const [isFileUploadOpen, setIsFileUploadOpen] = useState(false);\n  const [isManualEntryOpen, setIsManualEntryOpen] = useState(false);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [selectedContractor, setSelectedContractor] = useState<string>(\"\");\n  const [hasSubcontractor, setHasSubcontractor] = useState(false);\n  const [isNewCompany, setIsNewCompany] = useState(false);\n  const [editingAvailability, setEditingAvailability] = useState<any>(null);\n  const [analysisLocations, setAnalysisLocations] = useState<string[]>(['']);\n  const [distanceResults, setDistanceResults] = useState<any[]>([]);\n  const [isCalculatingDistances, setIsCalculatingDistances] = useState(false);\n  const [sortField, setSortField] = useState<string>('distance');\n  const [sortDirection, setSortDirection] = useState<'asc' | 'desc'>('asc');\n  const [isSessionDialogOpen, setIsSessionDialogOpen] = useState(false);\n  const [newSessionName, setNewSessionName] = useState('');\n  const [selectedSessionId, setSelectedSessionId] = useState<string>('active');\n\n  // Format duration from seconds to human readable\n  const formatDuration = (seconds: number): string => {\n    const hours = Math.floor(seconds / 3600);\n    const minutes = Math.floor((seconds % 3600) / 60);\n    \n    if (hours > 0) {\n      return `${hours}h ${minutes}m`;\n    } else {\n      return `${minutes}m`;\n    }\n  };\n\n  // Fetch availability sessions\n  const { data: sessionsData } = useQuery<{ sessions: any[], unassignedCount: number }>({\n    queryKey: [\"/api/availability-sessions\"],\n  });\n\n  // Fetch availability data filtered by session\n  const { data: availabilityData = [], isLoading } = useQuery<CrewAvailability[]>({\n    queryKey: [\"/api/crew-availability\", selectedSessionId],\n    queryFn: async () => {\n      try {\n        const response = await fetch(`/api/crew-availability?sessionId=${selectedSessionId}`);\n        if (!response.ok) {\n          // If session filtering fails, fallback to getting all availability data\n          const fallbackResponse = await fetch('/api/crew-availability-fallback');\n          if (fallbackResponse.ok) {\n            return fallbackResponse.json();\n          }\n          throw new Error('Failed to fetch availability data');\n        }\n        return response.json();\n      } catch (error) {\n        // Fallback to basic query without session filtering\n        const fallbackResponse = await fetch('/api/crew-availability-fallback');\n        if (fallbackResponse.ok) {\n          return fallbackResponse.json();\n        }\n        throw error;\n      }\n    },\n    refetchInterval: 30000, // Refresh every 30 seconds\n  });\n\n  // Fetch contractors for manual entry\n  const { data: contractors = [] } = useQuery<Contractor[]>({\n    queryKey: [\"/api/contractors\"]\n  });\n\n  // Start new availability session\n  const startNewSessionMutation = useMutation({\n    mutationFn: async (sessionName: string) => {\n      return await apiRequest(\"POST\", \"/api/availability-sessions/start-new\", { label: sessionName });\n    },\n    onSuccess: () => {\n      toast({\n        title: \"New Session Started\",\n        description: `Session \"${newSessionName}\" has been created and is now active.`,\n      });\n      // Invalidate queries to refresh data\n      queryClient.invalidateQueries({ queryKey: [\"/api/availability-sessions\"] });\n      queryClient.invalidateQueries({ queryKey: [\"/api/crew-availability\"] });\n      // Switch to active session and close dialog\n      setSelectedSessionId('active');\n      setIsSessionDialogOpen(false);\n      setNewSessionName('');\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Error\",\n        description: \"Failed to start new session: \" + error.message,\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Function to handle adding/removing locations\n  const addLocation = () => {\n    setAnalysisLocations([...analysisLocations, '']);\n  };\n\n  const removeLocation = (index: number) => {\n    if (analysisLocations.length > 1) {\n      const newLocations = analysisLocations.filter((_, i) => i !== index);\n      setAnalysisLocations(newLocations);\n    }\n  };\n\n  const updateLocation = (index: number, value: string) => {\n    const newLocations = [...analysisLocations];\n    newLocations[index] = value;\n    setAnalysisLocations(newLocations);\n  };\n\n  // Function to calculate distances for approved contractors\n  const calculateDistances = async () => {\n    const validLocations = analysisLocations.filter(loc => loc.trim());\n    if (validLocations.length === 0) {\n      toast({\n        title: \"Location Required\",\n        description: \"Please enter at least one location for distance analysis\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    const approvedContractors = availabilityData.filter((item: any) => item.status === 'approved');\n    \n    if (approvedContractors.length === 0) {\n      toast({\n        title: \"No Approved Contractors\",\n        description: \"There are no approved contractors to analyze\",\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    setIsCalculatingDistances(true);\n    \n    try {\n      const response = await fetch('/api/calculate-distances', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          contractors: approvedContractors,\n          destinations: validLocations\n        })\n      });\n\n      if (!response.ok) {\n        throw new Error('Failed to calculate distances');\n      }\n\n      const data = await response.json();\n      setDistanceResults(data.results);\n      \n      toast({\n        title: \"Distance Analysis Complete\",\n        description: `Calculated driving distances for ${data.results.length} contractors to ${validLocations.length} location(s)`,\n      });\n    } catch (error) {\n      console.error('Distance calculation error:', error);\n      toast({\n        title: \"Calculation Failed\",\n        description: \"Could not calculate distances. Please try again.\",\n        variant: \"destructive\",\n      });\n    } finally {\n      setIsCalculatingDistances(false);\n    }\n  };\n\n  // Function to calculate straight-line distance between two locations\n  const calculateStraightLineDistance = async (location1: string, location2: string): Promise<number | null> => {\n    try {\n      // Geocode both locations\n      const coords1 = await geocodeLocation(location1);\n      const coords2 = await geocodeLocation(location2);\n      \n      if (!coords1 || !coords2) return null;\n      \n      // Calculate distance using Haversine formula\n      const R = 3959; // Earth's radius in miles\n      const dLat = (coords2.lat - coords1.lat) * Math.PI / 180;\n      const dLon = (coords2.lng - coords1.lng) * Math.PI / 180;\n      const a = \n        Math.sin(dLat/2) * Math.sin(dLat/2) +\n        Math.cos(coords1.lat * Math.PI / 180) * Math.cos(coords2.lat * Math.PI / 180) * \n        Math.sin(dLon/2) * Math.sin(dLon/2);\n      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));\n      const distance = R * c;\n      \n      return distance;\n    } catch (error) {\n      console.error('Distance calculation error:', error);\n      return null;\n    }\n  };\n\n  // Function to geocode a location using a simple geocoding service\n  const geocodeLocation = async (location: string): Promise<{lat: number, lng: number} | null> => {\n    try {\n      // Using OpenStreetMap Nominatim API (free, no API key required)\n      const response = await fetch(\n        `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(location)}`\n      );\n      const data = await response.json();\n      \n      if (data.length > 0) {\n        return {\n          lat: parseFloat(data[0].lat),\n          lng: parseFloat(data[0].lon)\n        };\n      }\n      return null;\n    } catch (error) {\n      console.error('Geocoding error:', error);\n      return null;\n    }\n  };\n\n  // Sorting function for distance results\n  const handleSort = (field: string) => {\n    if (sortField === field) {\n      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');\n    } else {\n      setSortField(field);\n      setSortDirection('asc');\n    }\n  };\n\n  // Get sorted distance results\n  const getSortedResults = () => {\n    return [...distanceResults].sort((a, b) => {\n      let aValue, bValue;\n      \n      switch (sortField) {\n        case 'contractor':\n          aValue = a.contractor?.company || '';\n          bValue = b.contractor?.company || '';\n          break;\n        case 'distance':\n          aValue = parseFloat(a.distance);\n          bValue = parseFloat(b.distance);\n          break;\n        case 'travelTime':\n          aValue = parseFloat(a.travelTimeHours);\n          bValue = parseFloat(b.travelTimeHours);\n          break;\n        case 'totalFTE':\n          aValue = getTotalCrew(a);\n          bValue = getTotalCrew(b);\n          break;\n        case 'buckets':\n          aValue = a.buckets || 0;\n          bValue = b.buckets || 0;\n          break;\n        case 'diggers':\n          aValue = a.diggers || 0;\n          bValue = b.diggers || 0;\n          break;\n        case 'pickups':\n          aValue = a.pickups || 0;\n          bValue = b.pickups || 0;\n          break;\n        case 'backyardMachines':\n          aValue = a.backyardMachines || 0;\n          bValue = b.backyardMachines || 0;\n          break;\n        default:\n          return 0;\n      }\n      \n      if (sortDirection === 'asc') {\n        return aValue < bValue ? -1 : aValue > bValue ? 1 : 0;\n      } else {\n        return aValue > bValue ? -1 : aValue < bValue ? 1 : 0;\n      }\n    });\n  };\n\n  // Calculate totals for the results\n  const calculateTotals = () => {\n    return distanceResults.reduce((totals, result) => ({\n      totalFTE: totals.totalFTE + getTotalCrew(result),\n      buckets: totals.buckets + (result.buckets || 0),\n      diggers: totals.diggers + (result.diggers || 0),\n      pickups: totals.pickups + (result.pickups || 0),\n      backyardMachines: totals.backyardMachines + (result.backyardMachines || 0),\n    }), {\n      totalFTE: 0,\n      buckets: 0,\n      diggers: 0,\n      pickups: 0,\n      backyardMachines: 0,\n    });\n  };\n\n  // Export availability data function\n  const exportAvailabilityData = async (format: 'excel' | 'csv') => {\n    try {\n      const sessionParam = selectedSessionId || 'active';\n      const response = await fetch(`/api/crew-availability/export?format=${format}&session=${sessionParam}`);\n      \n      if (!response.ok) {\n        throw new Error('Export failed');\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.style.display = 'none';\n      a.href = url;\n      \n      // Get filename from response header or use default\n      const contentDisposition = response.headers.get('content-disposition');\n      const filenameMatch = contentDisposition?.match(/filename=\"(.+)\"/);\n      const filename = filenameMatch ? filenameMatch[1] : `availability_submissions_${new Date().toISOString().slice(0, 10)}.${format === 'excel' ? 'xlsx' : 'csv'}`;\n      \n      a.download = filename;\n      \n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"Export Successful\",\n        description: `Availability submissions exported to ${format.toUpperCase()}`,\n      });\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: `Could not export availability submissions to ${format.toUpperCase()}`,\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Export ALL sessions data function\n  const exportAllSessionsData = async (format: 'excel' | 'csv') => {\n    try {\n      // Don't pass a session parameter to get all data\n      const response = await fetch(`/api/crew-availability/export?format=${format}`);\n      \n      if (!response.ok) {\n        throw new Error('Export failed');\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.style.display = 'none';\n      a.href = url;\n      \n      // Get filename from response header or use default\n      const contentDisposition = response.headers.get('content-disposition');\n      const filenameMatch = contentDisposition?.match(/filename=\"(.+)\"/);\n      const filename = filenameMatch ? filenameMatch[1] : `all_sessions_availability_${new Date().toISOString().slice(0, 10)}.${format === 'excel' ? 'xlsx' : 'csv'}`;\n      \n      a.download = filename;\n      \n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"Export All Sessions Successful\",\n        description: `All availability data from all sessions exported to ${format.toUpperCase()}`,\n      });\n    } catch (error) {\n      toast({\n        title: \"Export All Sessions Failed\",\n        description: `Could not export all sessions data to ${format.toUpperCase()}`,\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // AI-Enhanced export function\n  const exportAIMatchedData = async (format: 'excel' | 'csv') => {\n    try {\n      toast({\n        title: \"AI Matching Started\",\n        description: \"Analyzing submissions with AI to match contractors. This may take a moment...\",\n      });\n\n      const sessionParam = selectedSessionId || 'active';\n      const response = await fetch(`/api/crew-availability/export-ai-matched?format=${format}&session=${sessionParam}`);\n      \n      if (!response.ok) {\n        throw new Error('AI export failed');\n      }\n\n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.style.display = 'none';\n      a.href = url;\n      \n      // Get filename from response header or use default\n      const contentDisposition = response.headers.get('content-disposition');\n      const filenameMatch = contentDisposition?.match(/filename=\"(.+)\"/);\n      const filename = filenameMatch ? filenameMatch[1] : `ai_matched_availability_${new Date().toISOString().slice(0, 10)}.${format === 'excel' ? 'xlsx' : 'csv'}`;\n      \n      a.download = filename;\n      \n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({\n        title: \"AI Export Complete\",\n        description: `AI-matched availability data exported to ${format.toUpperCase()} with contractor matching results`,\n      });\n    } catch (error) {\n      toast({\n        title: \"AI Export Failed\",\n        description: `Could not export AI-matched data: ${(error as Error).message}`,\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Excel export function\n  const exportToExcel = async () => {\n    try {\n      const validLocations = analysisLocations.filter(loc => loc.trim());\n      const sortedResults = getSortedResults();\n      const totals = calculateTotals();\n      \n      // Prepare data for export with multiple destination columns\n      const exportData = sortedResults.map(result => {\n        const row: any = {\n          'Contractor': result.contractor?.company || '',\n          'Contact Person': result.contractor?.name || '',\n          'Email': result.contractor?.email || 'Not provided',\n          'Phone': result.contractor?.phone || 'Not provided',\n          'Category': result.contractor?.category || 'Not specified',\n          'Departure City': result.departureCity || (result.departureLocation ? result.departureLocation.split(',')[0]?.trim() : ''),\n          'Departure State': result.departureState || (result.departureLocation ? result.departureLocation.split(',')[1]?.trim() : ''),\n          'Total FTE': getTotalCrew(result),\n          'Buckets': result.buckets || 0,\n          'Diggers': result.diggers || 0,\n          'Pickups': result.pickups || 0,\n          'BackYard Machines': result.backyardMachines || 0,\n        };\n\n        // Add distance and time columns for each destination\n        validLocations.forEach((location, index) => {\n          row[`Distance to ${location} (miles)`] = parseFloat(result[`distance_${index}`]) || 0;\n          row[`Travel Time to ${location} (hours)`] = parseFloat(result[`travelTimeHours_${index}`]) || 0;\n        });\n\n        return row;\n      });\n\n      // Add totals row\n      const totalsRow: any = {\n        'Contractor': 'TOTALS',\n        'Contact Person': '',\n        'Email': '',\n        'Phone': '',\n        'Category': '',\n        'Departure Location': '',\n        'Total FTE': totals.totalFTE,\n        'Buckets': totals.buckets,\n        'Diggers': totals.diggers,\n        'Pickups': totals.pickups,\n        'BackYard Machines': totals.backyardMachines,\n      };\n\n      // Add empty cells for distance/time columns in totals row\n      validLocations.forEach((location) => {\n        totalsRow[`Distance to ${location} (miles)`] = null;\n        totalsRow[`Travel Time to ${location} (hours)`] = null;\n      });\n\n      exportData.push(totalsRow);\n\n      const response = await fetch('/api/export-excel', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          data: exportData,\n          filename: `distance-analysis-${validLocations.join('-').replace(/[^a-zA-Z0-9-]/g, '-')}-${new Date().toISOString().slice(0, 10)}.xlsx`,\n          sheetName: 'Distance Analysis'\n        })\n      });\n\n      if (response.ok) {\n        const blob = await response.blob();\n        const url = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.style.display = 'none';\n        a.href = url;\n        a.download = `distance-analysis-${validLocations.join('-').replace(/[^a-zA-Z0-9-]/g, '-')}-${new Date().toISOString().slice(0, 10)}.xlsx`;\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url);\n        document.body.removeChild(a);\n        \n        toast({\n          title: \"Export Successful\",\n          description: \"Distance analysis exported to Excel\",\n        });\n      } else {\n        throw new Error('Export failed');\n      }\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Could not export distance analysis to Excel\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // Color-coded Excel export function (time only, no distance)\n  const exportToExcelColorCoded = async () => {\n    try {\n      const validLocations = analysisLocations.filter(loc => loc.trim());\n      const sortedResults = getSortedResults();\n      const totals = calculateTotals();\n      \n      // Prepare data for export with only time columns (no distance)\n      const exportData = sortedResults.map(result => {\n        const row: any = {\n          'Contractor': result.contractor?.company || '',\n          'Contact Person': result.contractor?.name || '',\n          'Email': result.contractor?.email || 'Not provided',\n          'Phone': result.contractor?.phone || 'Not provided',\n          'Category': result.contractor?.category || 'Not specified',\n          'Departure City': result.departureCity || (result.departureLocation ? result.departureLocation.split(',')[0]?.trim() : ''),\n          'Departure State': result.departureState || (result.departureLocation ? result.departureLocation.split(',')[1]?.trim() : ''),\n          'Total FTE': getTotalCrew(result),\n          'Buckets': result.buckets || 0,\n          'Diggers': result.diggers || 0,\n          'Pickups': result.pickups || 0,\n          'BackYard Machines': result.backyardMachines || 0,\n        };\n\n        // Add ONLY time columns for each destination (no distance)\n        validLocations.forEach((location, index) => {\n          row[`Travel Time to ${location} (hours)`] = parseFloat(result[`travelTimeHours_${index}`]) || 0;\n        });\n\n        return row;\n      });\n\n      // Add totals row\n      const totalsRow: any = {\n        'Contractor': 'TOTALS',\n        'Contact Person': '',\n        'Email': '',\n        'Phone': '',\n        'Category': '',\n        'Departure Location': '',\n        'Total FTE': totals.totalFTE,\n        'Buckets': totals.buckets,\n        'Diggers': totals.diggers,\n        'Pickups': totals.pickups,\n        'BackYard Machines': totals.backyardMachines,\n      };\n\n      // Add empty cells for time columns in totals row\n      validLocations.forEach((location) => {\n        totalsRow[`Travel Time to ${location} (hours)`] = null;\n      });\n\n      exportData.push(totalsRow);\n\n      const response = await fetch('/api/export-excel-color-coded', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          data: exportData,\n          filename: `distance-analysis-color-coded-${validLocations.join('-').replace(/[^a-zA-Z0-9-]/g, '-')}-${new Date().toISOString().slice(0, 10)}.xlsx`,\n          sheetName: 'Color Coded Analysis',\n          destinations: validLocations\n        })\n      });\n\n      if (response.ok) {\n        const blob = await response.blob();\n        const url = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.style.display = 'none';\n        a.href = url;\n        a.download = `distance-analysis-color-coded-${validLocations.join('-').replace(/[^a-zA-Z0-9-]/g, '-')}-${new Date().toISOString().slice(0, 10)}.xlsx`;\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url);\n        document.body.removeChild(a);\n        \n        toast({\n          title: \"Color-Coded Export Successful\",\n          description: \"Color-coded time analysis exported to Excel\",\n        });\n      } else {\n        throw new Error('Export failed');\n      }\n    } catch (error) {\n      toast({\n        title: \"Export Failed\",\n        description: \"Could not export color-coded analysis to Excel\",\n        variant: \"destructive\",\n      });\n    }\n  };\n\n  // File upload mutation\n  const fileUploadMutation = useMutation({\n    mutationFn: async (formData: FormData) => {\n      const response = await fetch('/api/availability/upload', {\n        method: 'POST',\n        body: formData,\n      });\n      if (!response.ok) throw new Error('Upload failed');\n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/crew-availability\"] });\n      toast({\n        title: \"Upload Successful\",\n        description: `Processed ${data.recordsCreated} availability records`,\n      });\n      setIsFileUploadOpen(false);\n      setSelectedFile(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Upload Failed\",\n        description: error.message || \"Could not process the file\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Manual entry mutation\n  const manualEntryMutation = useMutation({\n    mutationFn: async (data: any) => {\n      return await apiRequest('POST', '/api/crew-availability', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/crew-availability\"] });\n      toast({\n        title: \"Availability Added\",\n        description: \"Crew availability has been successfully recorded\",\n      });\n      setIsManualEntryOpen(false);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Failed to Add Availability\",\n        description: error.message || \"Could not save availability data\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Status update mutation\n  const statusUpdateMutation = useMutation({\n    mutationFn: async ({ id, status }: { id: number; status: string }) => {\n      return await apiRequest('PATCH', `/api/crew-availability/${id}`, { status });\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/crew-availability\"] });\n      toast({\n        title: \"Status Updated\",\n        description: \"Availability status has been updated\",\n      });\n    }\n  });\n\n  // Edit mutation\n  const editMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: number, data: any }) => {\n      return await apiRequest('PATCH', `/api/crew-availability/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/crew-availability\"] });\n      toast({\n        title: \"Entry Updated\",\n        description: \"Crew availability entry has been updated successfully\",\n      });\n      setEditingAvailability(null);\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Update Failed\",\n        description: error.message || \"Could not update availability entry\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  // Delete mutation\n  const deleteMutation = useMutation({\n    mutationFn: async (id: number) => {\n      return await apiRequest('DELETE', `/api/crew-availability/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/crew-availability\"] });\n      toast({\n        title: \"Entry Deleted\",\n        description: \"Crew availability entry has been deleted successfully\",\n      });\n    },\n    onError: (error: any) => {\n      toast({\n        title: \"Delete Failed\",\n        description: error.message || \"Could not delete availability entry\",\n        variant: \"destructive\",\n      });\n    }\n  });\n\n  const handleFileUpload = () => {\n    if (!selectedFile) return;\n\n    const formData = new FormData();\n    formData.append('file', selectedFile);\n    formData.append('submittedBy', 'admin'); // Get from auth context\n\n    fileUploadMutation.mutate(formData);\n  };\n\n  const handleManualEntry = async (event: React.FormEvent<HTMLFormElement>) => {\n    event.preventDefault();\n    const formData = new FormData(event.currentTarget);\n    \n    let contractorId;\n    \n    // If new company, create contractor first\n    if (isNewCompany) {\n      const newContractorData = {\n        name: formData.get('newContractorName'),\n        company: formData.get('newCompanyName'),\n        category: formData.get('newCategory') || 'Union',\n        birdRep: formData.get('newBirdRep') || 'TBD',\n        email: formData.get('newEmail') || '',\n        phone: formData.get('newPhone') || '',\n        rating: 0\n      };\n      \n      try {\n        const response = await apiRequest('POST', '/api/contractors', newContractorData);\n        const newContractor = await response.json();\n        contractorId = newContractor.id;\n        console.log('Created new contractor with ID:', contractorId);\n        queryClient.invalidateQueries({ queryKey: [\"/api/contractors\"] });\n      } catch (error) {\n        console.error('Failed to create contractor:', error);\n        toast({\n          title: \"Failed to Create Contractor\",\n          description: \"Could not create new contractor entry\",\n          variant: \"destructive\",\n        });\n        return;\n      }\n    } else {\n      // Using existing contractor\n      contractorId = parseInt(selectedContractor);\n      \n      // Update existing contractor information if provided\n      const contractorEmail = formData.get('contractorEmail');\n      const contractorPhone = formData.get('contractorPhone');\n      const contractorCategory = formData.get('contractorCategory');\n      \n      if (contractorEmail || contractorPhone || contractorCategory) {\n        const updateData: any = {};\n        if (contractorEmail) updateData.email = contractorEmail;\n        if (contractorPhone) updateData.phone = contractorPhone;\n        if (contractorCategory) updateData.category = contractorCategory;\n        \n        try {\n          await apiRequest('PATCH', `/api/contractors/${contractorId}`, updateData);\n          queryClient.invalidateQueries({ queryKey: [\"/api/contractors\"] });\n        } catch (error) {\n          console.warn('Failed to update contractor information:', error);\n          // Continue with availability creation even if contractor update fails\n        }\n      }\n    }\n    \n    const departureCity = formData.get('departureCity') as string;\n    const departureState = formData.get('departureState') as string;\n    const departureLocation = `${departureCity}, ${departureState}`;\n    \n    const subDepartureCity = formData.get('subDepartureCity') as string;\n    const subDepartureState = formData.get('subDepartureState') as string;\n    const subDepartureLocation = hasSubcontractor && subDepartureCity && subDepartureState \n      ? `${subDepartureCity}, ${subDepartureState}` \n      : '';\n    \n    const data = {\n      contractorId,\n      isNewCompany,\n      departureCity,\n      departureState,\n      departureLocation,\n      totalFTE: parseInt(formData.get('totalFTE') as string) || 0,\n      buckets: parseInt(formData.get('buckets') as string) || 0,\n      diggers: parseInt(formData.get('diggers') as string) || 0,\n      pickups: parseInt(formData.get('pickups') as string) || 0,\n      backyardMachines: parseInt(formData.get('backyardMachines') as string) || 0,\n      notes: formData.get('notes'),\n      submittedBy: 'admin', // Get from auth context\n      // Subcontractor data\n      hasSubcontractor,\n      subcontractorData: hasSubcontractor ? {\n        name: formData.get('subName'),\n        company: formData.get('subCompany'),\n        departureCity: subDepartureCity,\n        departureState: subDepartureState,\n        departureLocation: subDepartureLocation,\n        totalFTE: parseInt(formData.get('subTotalFTE') as string) || 0,\n        buckets: parseInt(formData.get('subBuckets') as string) || 0,\n        diggers: parseInt(formData.get('subDiggers') as string) || 0,\n        pickups: parseInt(formData.get('subPickups') as string) || 0,\n        backyardMachines: parseInt(formData.get('subBackyardMachines') as string) || 0,\n      } : undefined\n    };\n\n    // Validate contractorId before submitting\n    console.log('Validating contractorId:', contractorId, 'Type:', typeof contractorId, 'isNaN:', isNaN(contractorId));\n    if (!contractorId || isNaN(contractorId)) {\n      console.error('Invalid contractorId detected:', contractorId);\n      toast({\n        title: \"Invalid Contractor\",\n        description: `Please select a valid contractor or create a new one. ContractorId: ${contractorId}`,\n        variant: \"destructive\",\n      });\n      return;\n    }\n\n    console.log('Frontend submitting data:', data);\n    manualEntryMutation.mutate(data);\n    \n    // Reset form state\n    setSelectedContractor(\"\");\n    setHasSubcontractor(false);\n    setIsNewCompany(false);\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'submitted':\n        return <Badge variant=\"outline\"><Clock className=\"w-3 h-3 mr-1\" />Submitted</Badge>;\n      case 'approved':\n        return <Badge variant=\"default\"><CheckCircle className=\"w-3 h-3 mr-1\" />Approved</Badge>;\n      case 'deployed':\n        return <Badge variant=\"secondary\"><Truck className=\"w-3 h-3 mr-1\" />Deployed</Badge>;\n      case 'expired':\n        return <Badge variant=\"destructive\"><AlertTriangle className=\"w-3 h-3 mr-1\" />Expired</Badge>;\n      default:\n        return <Badge variant=\"outline\">{status}</Badge>;\n    }\n  };\n\n  const getTotalCrew = (availability: CrewAvailability) => {\n    // Use new field structure if available, fallback to legacy fields\n    return availability.totalFTE || \n           (availability.linemenCount + availability.groundmenCount + \n            availability.operatorsCount + availability.foremanCount + \n            availability.apprenticesCount);\n  };\n\n  const getEquipmentSummary = (availability: CrewAvailability) => {\n    const equipment = [];\n    if (availability.buckets && availability.buckets > 0) equipment.push(`${availability.buckets} Buckets`);\n    if (availability.diggers && availability.diggers > 0) equipment.push(`${availability.diggers} Diggers`);\n    if (availability.pickups && availability.pickups > 0) equipment.push(`${availability.pickups} Pickups`);\n    if (availability.backyardMachines && availability.backyardMachines > 0) equipment.push(`${availability.backyardMachines} BYM`);\n    return equipment.join(', ') || 'No equipment';\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <AppHeader />\n      \n      <div className=\"container mx-auto p-4 sm:p-6 space-y-6 pt-28 sm:pt-32 md:pt-36\">\n        <div className=\"flex flex-col sm:flex-row justify-between sm:items-center gap-4\">\n        <div>\n          <h1 className=\"text-2xl sm:text-3xl font-bold\">Contractor Availability</h1>\n          <p className=\"text-gray-600 mt-2 text-sm sm:text-base\">Manage crew and equipment availability submissions</p>\n          \n          {/* Session Management */}\n          <div className=\"mt-4 flex flex-col sm:flex-row items-start sm:items-center gap-3\">\n            <div className=\"flex items-center gap-3\">\n              <Label htmlFor=\"session-select\" className=\"text-sm font-medium\">Session:</Label>\n              <Select \n                value={selectedSessionId} \n                onValueChange={setSelectedSessionId}\n                data-testid=\"select-availability-session\"\n              >\n                <SelectTrigger className=\"w-[200px]\">\n                  <SelectValue placeholder=\"Select session\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"active\">Active Session</SelectItem>\n                  {sessionsData?.unassignedCount && sessionsData.unassignedCount > 0 && (\n                    <SelectItem value=\"unassigned\">\n                      Unassigned ({sessionsData.unassignedCount})\n                    </SelectItem>\n                  )}\n                  {sessionsData?.sessions?.map((session) => (\n                    <SelectItem key={session.id} value={session.id.toString()}>\n                      {session.label} ({session.recordCount})\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            \n            <Button \n              variant=\"default\"\n              onClick={() => setIsSessionDialogOpen(true)}\n              disabled={startNewSessionMutation.isPending}\n              className=\"bg-green-600 hover:bg-green-700\"\n              data-testid=\"button-save-start-new-session\"\n            >\n              {startNewSessionMutation.isPending ? (\n                <>\n                  <Clock className=\"w-4 h-4 mr-2 animate-spin\" />\n                  Starting New Session...\n                </>\n              ) : (\n                <>\n                  <CheckCircle className=\"w-4 h-4 mr-2\" />\n                  Save & Start New Session\n                </>\n              )}\n            </Button>\n          </div>\n          \n          <div className=\"mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg\">\n            <p className=\"text-sm text-blue-800 mb-2\">\n              <strong>Contractor Submission Form:</strong> Share this link with contractors to submit availability{selectedSessionId !== 'active' && selectedSessionId !== 'unassigned' ? ` for this session` : ''}\n            </p>\n            <div className=\"flex items-center gap-2 flex-wrap\">\n              <code className=\"text-xs bg-white px-2 py-1 rounded border text-blue-900 flex-1 min-w-0 overflow-x-auto\">\n                {selectedSessionId === 'active' || selectedSessionId === 'unassigned'\n                  ? `${window.location.origin}/contractor-availability`\n                  : `${window.location.origin}/contractor-availability?session=${selectedSessionId}`}\n              </code>\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={() => {\n                  const formUrl = selectedSessionId === 'active' || selectedSessionId === 'unassigned'\n                    ? `${window.location.origin}/contractor-availability`\n                    : `${window.location.origin}/contractor-availability?session=${selectedSessionId}`;\n                  navigator.clipboard.writeText(formUrl);\n                  toast({\n                    title: \"Link Copied\",\n                    description: selectedSessionId === 'active' || selectedSessionId === 'unassigned'\n                      ? \"General contractor form link copied to clipboard\"\n                      : \"Session-specific form link copied to clipboard\",\n                  });\n                }}\n                data-testid=\"button-copy-form-link\"\n              >\n                Copy Link\n              </Button>\n              <Button\n                size=\"sm\"\n                variant=\"outline\"\n                onClick={() => {\n                  const formUrl = selectedSessionId === 'active' || selectedSessionId === 'unassigned'\n                    ? '/contractor-availability'\n                    : `/contractor-availability?session=${selectedSessionId}`;\n                  window.open(formUrl, '_blank');\n                }}\n                data-testid=\"button-open-form\"\n              >\n                Open Form\n              </Button>\n            </div>\n            {selectedSessionId !== 'active' && selectedSessionId !== 'unassigned' && (\n              <p className=\"text-xs text-blue-700 mt-2\">\n                <strong>Note:</strong> Submissions through this link will be saved to the selected session only.\n              </p>\n            )}\n          </div>\n        </div>\n        <div className=\"flex flex-col sm:flex-row gap-2\">\n          <Dialog open={isFileUploadOpen} onOpenChange={setIsFileUploadOpen}>\n            <DialogTrigger asChild>\n              <Button variant=\"outline\">\n                <Upload className=\"w-4 h-4 mr-2\" />\n                Bulk Upload\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-md\">\n              <DialogHeader>\n                <DialogTitle>Upload FTE File</DialogTitle>\n                <DialogDescription>\n                  Upload an Excel or CSV file with contractor availability data\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"file\">Select File</Label>\n                  <Input\n                    id=\"file\"\n                    type=\"file\"\n                    accept=\".xlsx,.xls,.csv\"\n                    onChange={(e) => setSelectedFile(e.target.files?.[0] || null)}\n                  />\n                  <p className=\"text-xs text-gray-500 mt-1\">\n                    Supported formats: Excel (.xlsx, .xls) or CSV (.csv)\n                  </p>\n                </div>\n                <div className=\"flex justify-end gap-2\">\n                  <Button variant=\"outline\" onClick={() => setIsFileUploadOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button \n                    onClick={handleFileUpload} \n                    disabled={!selectedFile || fileUploadMutation.isPending}\n                  >\n                    {fileUploadMutation.isPending ? \"Uploading...\" : \"Upload\"}\n                  </Button>\n                </div>\n              </div>\n            </DialogContent>\n          </Dialog>\n\n          <Dialog open={isManualEntryOpen} onOpenChange={setIsManualEntryOpen}>\n            <DialogTrigger asChild>\n              <Button>\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Manual Entry\n              </Button>\n            </DialogTrigger>\n            <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>Add Crew Availability</DialogTitle>\n                <DialogDescription>\n                  Manually enter contractor availability information\n                </DialogDescription>\n              </DialogHeader>\n              <form onSubmit={handleManualEntry} className=\"space-y-4\">\n                <div className=\"grid grid-cols-1 gap-4\">\n                  <div>\n                    <div className=\"flex items-center space-x-2 mb-2\">\n                      <Checkbox \n                        id=\"newCompany\" \n                        checked={isNewCompany} \n                        onCheckedChange={(checked) => setIsNewCompany(checked === true)}\n                      />\n                      <Label htmlFor=\"newCompany\">New Company (not in contractor list)</Label>\n                    </div>\n                    \n                    {!isNewCompany ? (\n                      <>\n                        <div>\n                          <Label htmlFor=\"contractor\">Select Contractor</Label>\n                          <Select value={selectedContractor} onValueChange={setSelectedContractor} required={!isNewCompany}>\n                            <SelectTrigger>\n                              <SelectValue placeholder=\"Select contractor\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {contractors\n                                .sort((a: any, b: any) => {\n                                  // Sort by company first, then by person name\n                                  if (a.company !== b.company) {\n                                    return a.company.localeCompare(b.company);\n                                  }\n                                  return a.name.localeCompare(b.name);\n                                })\n                                .map((contractor: any) => (\n                                <SelectItem key={contractor.id} value={contractor.id.toString()}>\n                                  {contractor.company} - {contractor.name}\n                                </SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                        \n                        {selectedContractor && (\n                          <div className=\"grid grid-cols-2 gap-4 mt-4 p-4 bg-gray-50 rounded-lg\">\n                            <div className=\"col-span-2\">\n                              <Label className=\"text-sm font-medium text-gray-700\">Update Contractor Information (Optional)</Label>\n                            </div>\n                            <div>\n                              <Label htmlFor=\"contractorEmail\">Email</Label>\n                              <Input\n                                id=\"contractorEmail\"\n                                name=\"contractorEmail\"\n                                type=\"email\"\n                                placeholder=\"contractor@company.com\"\n                                defaultValue={contractors.find((c: any) => c.id.toString() === selectedContractor)?.email || ''}\n                              />\n                            </div>\n                            <div>\n                              <Label htmlFor=\"contractorPhone\">Phone Number</Label>\n                              <Input\n                                id=\"contractorPhone\"\n                                name=\"contractorPhone\"\n                                type=\"tel\"\n                                placeholder=\"(555) 123-4567\"\n                                defaultValue={contractors.find((c: any) => c.id.toString() === selectedContractor)?.phone || ''}\n                              />\n                            </div>\n                            <div>\n                              <Label htmlFor=\"contractorCategory\">Category</Label>\n                              <Select name=\"contractorCategory\" defaultValue={contractors.find((c: any) => c.id.toString() === selectedContractor)?.category || ''}>\n                                <SelectTrigger>\n                                  <SelectValue placeholder=\"Select category\" />\n                                </SelectTrigger>\n                                <SelectContent>\n                                  {categories.map((cat) => (\n                                    <SelectItem key={cat} value={cat}>{cat}</SelectItem>\n                                  ))}\n                                </SelectContent>\n                              </Select>\n                            </div>\n                          </div>\n                        )}\n                      </>\n                    ) : (\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <div>\n                          <Label htmlFor=\"newCompanyName\">Company Name</Label>\n                          <Input\n                            id=\"newCompanyName\"\n                            name=\"newCompanyName\"\n                            placeholder=\"Company name\"\n                            required={isNewCompany}\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"newContractorName\">Contact Person</Label>\n                          <Input\n                            id=\"newContractorName\"\n                            name=\"newContractorName\"\n                            placeholder=\"Contact person name\"\n                            required={isNewCompany}\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"newBirdRep\">Bird Rep</Label>\n                          <Input\n                            id=\"newBirdRep\"\n                            name=\"newBirdRep\"\n                            placeholder=\"Bird Representative\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"newEmail\">Email</Label>\n                          <Input\n                            id=\"newEmail\"\n                            name=\"newEmail\"\n                            type=\"email\"\n                            placeholder=\"contractor@company.com\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"newPhone\">Phone Number</Label>\n                          <Input\n                            id=\"newPhone\"\n                            name=\"newPhone\"\n                            type=\"tel\"\n                            placeholder=\"(555) 123-4567\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"newCategory\">Category</Label>\n                          <Select name=\"newCategory\">\n                            <SelectTrigger>\n                              <SelectValue placeholder=\"Select category\" />\n                            </SelectTrigger>\n                            <SelectContent>\n                              {categories.map((cat) => (\n                                <SelectItem key={cat} value={cat}>{cat}</SelectItem>\n                              ))}\n                            </SelectContent>\n                          </Select>\n                        </div>\n                      </div>\n                    )}\n                  </div>\n                </div>\n\n                <div className=\"grid grid-cols-2 gap-4\">\n                  <div>\n                    <Label htmlFor=\"departureCity\">Departure City</Label>\n                    <Input\n                      id=\"departureCity\"\n                      name=\"departureCity\"\n                      type=\"text\"\n                      placeholder=\"e.g., Detroit\"\n                      required\n                      data-testid=\"input-departure-city\"\n                    />\n                  </div>\n                  <div>\n                    <Label htmlFor=\"departureState\">Departure State</Label>\n                    <Input\n                      id=\"departureState\"\n                      name=\"departureState\"\n                      type=\"text\"\n                      placeholder=\"e.g., TX\"\n                      required\n                      data-testid=\"input-departure-state\"\n                    />\n                  </div>\n                </div>\n\n                <div className=\"space-y-3\">\n                  <h4 className=\"font-semibold\">Crew & Equipment Composition</h4>\n                  \n                  {/* Total FTE on one line */}\n                  <div className=\"grid grid-cols-1 gap-4\">\n                    <div>\n                      <Label htmlFor=\"totalFTE\">Total FTE</Label>\n                      <Input\n                        id=\"totalFTE\"\n                        name=\"totalFTE\"\n                        type=\"number\"\n                        min=\"0\"\n                        defaultValue=\"0\"\n                      />\n                    </div>\n                  </div>\n                  \n                  {/* Equipment fields below */}\n                  <div className=\"grid grid-cols-4 gap-4\">\n                    <div>\n                      <Label htmlFor=\"buckets\">Buckets</Label>\n                      <Input\n                        id=\"buckets\"\n                        name=\"buckets\"\n                        type=\"number\"\n                        min=\"0\"\n                        defaultValue=\"0\"\n                      />\n                    </div>\n                    <div>\n                      <Label htmlFor=\"diggers\">Diggers</Label>\n                      <Input\n                        id=\"diggers\"\n                        name=\"diggers\"\n                        type=\"number\"\n                        min=\"0\"\n                        defaultValue=\"0\"\n                      />\n                    </div>\n                    <div>\n                      <Label htmlFor=\"pickups\">Pickups</Label>\n                      <Input\n                        id=\"pickups\"\n                        name=\"pickups\"\n                        type=\"number\"\n                        min=\"0\"\n                        defaultValue=\"0\"\n                      />\n                    </div>\n                    <div>\n                      <Label htmlFor=\"backyardMachines\">BackYard Machines</Label>\n                      <Input\n                        id=\"backyardMachines\"\n                        name=\"backyardMachines\"\n                        type=\"number\"\n                        min=\"0\"\n                        defaultValue=\"0\"\n                      />\n                    </div>\n                  </div>\n                </div>\n\n                <div className=\"space-y-3\">\n                  <div className=\"flex items-center space-x-2\">\n                    <Checkbox \n                      id=\"hasSubcontractor\" \n                      checked={hasSubcontractor}\n                      onCheckedChange={(checked) => setHasSubcontractor(checked === true)}\n                    />\n                    <Label htmlFor=\"hasSubcontractor\">This contractor is bringing subcontractors</Label>\n                  </div>\n                </div>\n\n                {hasSubcontractor && (\n                  <div className=\"space-y-4 border-t pt-4\">\n                    <h4 className=\"font-semibold text-lg\">Subcontractor Information</h4>\n                    \n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <Label htmlFor=\"subName\">Subcontractor Name</Label>\n                        <Input\n                          id=\"subName\"\n                          name=\"subName\"\n                          type=\"text\"\n                          placeholder=\"Individual or company name\"\n                          required={hasSubcontractor}\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"subCompany\">Subcontractor Company</Label>\n                        <Input\n                          id=\"subCompany\"\n                          name=\"subCompany\"\n                          type=\"text\"\n                          placeholder=\"Company name\"\n                          required={hasSubcontractor}\n                        />\n                      </div>\n                    </div>\n\n                    <div className=\"grid grid-cols-2 gap-4\">\n                      <div>\n                        <Label htmlFor=\"subDepartureCity\">Sub Departure City</Label>\n                        <Input\n                          id=\"subDepartureCity\"\n                          name=\"subDepartureCity\"\n                          type=\"text\"\n                          placeholder=\"e.g., Columbus\"\n                          required={hasSubcontractor}\n                          data-testid=\"input-sub-departure-city\"\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"subDepartureState\">Sub Departure State</Label>\n                        <Input\n                          id=\"subDepartureState\"\n                          name=\"subDepartureState\"\n                          type=\"text\"\n                          placeholder=\"e.g., TX\"\n                          required={hasSubcontractor}\n                          data-testid=\"input-sub-departure-state\"\n                        />\n                      </div>\n                    </div>\n\n                    <div className=\"space-y-3\">\n                      <h5 className=\"font-medium\">Subcontractor Crew & Equipment</h5>\n                      <div className=\"grid grid-cols-2 gap-4\">\n                        <div>\n                          <Label htmlFor=\"subTotalFTE\">Sub Total FTE</Label>\n                          <Input\n                            id=\"subTotalFTE\"\n                            name=\"subTotalFTE\"\n                            type=\"number\"\n                            min=\"0\"\n                            defaultValue=\"0\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"subBuckets\">Sub Buckets</Label>\n                          <Input\n                            id=\"subBuckets\"\n                            name=\"subBuckets\"\n                            type=\"number\"\n                            min=\"0\"\n                            defaultValue=\"0\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"subDiggers\">Sub Diggers</Label>\n                          <Input\n                            id=\"subDiggers\"\n                            name=\"subDiggers\"\n                            type=\"number\"\n                            min=\"0\"\n                            defaultValue=\"0\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"subPickups\">Sub Pickups</Label>\n                          <Input\n                            id=\"subPickups\"\n                            name=\"subPickups\"\n                            type=\"number\"\n                            min=\"0\"\n                            defaultValue=\"0\"\n                          />\n                        </div>\n                        <div>\n                          <Label htmlFor=\"subBackyardMachines\">Sub BackYard Machines</Label>\n                          <Input\n                            id=\"subBackyardMachines\"\n                            name=\"subBackyardMachines\"\n                            type=\"number\"\n                            min=\"0\"\n                            defaultValue=\"0\"\n                          />\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                )}\n\n                <div>\n                  <Label htmlFor=\"notes\">Notes</Label>\n                  <Textarea\n                    id=\"notes\"\n                    name=\"notes\"\n                    placeholder=\"Additional information about availability...\"\n                    rows={3}\n                  />\n                </div>\n\n                <div className=\"flex justify-end gap-2\">\n                  <Button type=\"button\" variant=\"outline\" onClick={() => setIsManualEntryOpen(false)}>\n                    Cancel\n                  </Button>\n                  <Button type=\"submit\" disabled={manualEntryMutation.isPending}>\n                    {manualEntryMutation.isPending ? \"Saving...\" : \"Save Availability\"}\n                  </Button>\n                </div>\n              </form>\n            </DialogContent>\n          </Dialog>\n\n          <Button \n            variant=\"default\" \n            onClick={() => exportAllSessionsData('excel')}\n            data-testid=\"button-export-all-sessions\"\n            className=\"bg-green-600 hover:bg-green-700 text-white\"\n          >\n            <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n            Export All Sessions\n          </Button>\n\n          {/* Edit Dialog */}\n          <Dialog open={!!editingAvailability} onOpenChange={() => setEditingAvailability(null)}>\n            <DialogContent className=\"max-w-2xl max-h-[80vh] overflow-y-auto\">\n              <DialogHeader>\n                <DialogTitle>Edit Crew Availability</DialogTitle>\n                <DialogDescription>\n                  Update contractor availability information\n                </DialogDescription>\n              </DialogHeader>\n              {editingAvailability && (\n                <form onSubmit={(e) => {\n                  e.preventDefault();\n                  const formData = new FormData(e.currentTarget);\n                  \n                  const departureCity = formData.get('departureCity') as string;\n                  const departureState = formData.get('departureState') as string;\n                  const departureLocation = `${departureCity}, ${departureState}`;\n                  \n                  const data = {\n                    departureCity,\n                    departureState,\n                    departureLocation,\n                    totalFTE: parseInt(formData.get('totalFTE') as string) || 0,\n                    buckets: parseInt(formData.get('buckets') as string) || 0,\n                    diggers: parseInt(formData.get('diggers') as string) || 0,\n                    pickups: parseInt(formData.get('pickups') as string) || 0,\n                    backyardMachines: parseInt(formData.get('backyardMachines') as string) || 0,\n                    notes: formData.get('notes'),\n                    status: formData.get('status'),\n                  };\n\n                  editMutation.mutate({ id: editingAvailability.id, data });\n                }} className=\"space-y-4\">\n                  \n                  <div className=\"grid grid-cols-1 gap-4\">\n                    <div>\n                      <Label htmlFor=\"edit-contractor\">Contractor (Read-only)</Label>\n                      <Input\n                        id=\"edit-contractor\"\n                        value={`${editingAvailability.contractor?.company} - ${editingAvailability.contractor?.name}`}\n                        disabled\n                      />\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-2 gap-4\">\n                    <div>\n                      <Label htmlFor=\"edit-departureCity\">Departure City</Label>\n                      <Input\n                        id=\"edit-departureCity\"\n                        name=\"departureCity\"\n                        type=\"text\"\n                        placeholder=\"e.g., Detroit\"\n                        defaultValue={editingAvailability.departureCity || (editingAvailability.departureLocation ? editingAvailability.departureLocation.split(',')[0]?.trim() : '')}\n                        required\n                        data-testid=\"input-departure-city\"\n                      />\n                    </div>\n                    <div>\n                      <Label htmlFor=\"edit-departureState\">Departure State</Label>\n                      <Input\n                        id=\"edit-departureState\"\n                        name=\"departureState\"\n                        type=\"text\"\n                        placeholder=\"e.g., TX\"\n                        defaultValue={editingAvailability.departureState || (editingAvailability.departureLocation ? editingAvailability.departureLocation.split(',')[1]?.trim() : '')}\n                        required\n                        data-testid=\"input-departure-state\"\n                      />\n                    </div>\n                  </div>\n\n                  <div className=\"space-y-3\">\n                    <h4 className=\"font-semibold\">Crew & Equipment Composition</h4>\n                    \n                    {/* Total FTE on one line */}\n                    <div className=\"grid grid-cols-1 gap-4\">\n                      <div>\n                        <Label htmlFor=\"edit-totalFTE\">Total FTE</Label>\n                        <Input\n                          id=\"edit-totalFTE\"\n                          name=\"totalFTE\"\n                          type=\"number\"\n                          min=\"0\"\n                          defaultValue={editingAvailability.totalFTE || 0}\n                        />\n                      </div>\n                    </div>\n                    \n                    {/* Equipment fields below */}\n                    <div className=\"grid grid-cols-4 gap-4\">\n                      <div>\n                        <Label htmlFor=\"edit-buckets\">Buckets</Label>\n                        <Input\n                          id=\"edit-buckets\"\n                          name=\"buckets\"\n                          type=\"number\"\n                          min=\"0\"\n                          defaultValue={editingAvailability.buckets || 0}\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"edit-diggers\">Diggers</Label>\n                        <Input\n                          id=\"edit-diggers\"\n                          name=\"diggers\"\n                          type=\"number\"\n                          min=\"0\"\n                          defaultValue={editingAvailability.diggers || 0}\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"edit-pickups\">Pickups</Label>\n                        <Input\n                          id=\"edit-pickups\"\n                          name=\"pickups\"\n                          type=\"number\"\n                          min=\"0\"\n                          defaultValue={editingAvailability.pickups || 0}\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"edit-backyardMachines\">BackYard Machines</Label>\n                        <Input\n                          id=\"edit-backyardMachines\"\n                          name=\"backyardMachines\"\n                          type=\"number\"\n                          min=\"0\"\n                          defaultValue={editingAvailability.backyardMachines || 0}\n                        />\n                      </div>\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-1 gap-4\">\n                    <div>\n                      <Label htmlFor=\"edit-status\">Status</Label>\n                      <Select name=\"status\" defaultValue={editingAvailability.status}>\n                        <SelectTrigger>\n                          <SelectValue placeholder=\"Select status\" />\n                        </SelectTrigger>\n                        <SelectContent>\n                          <SelectItem value=\"submitted\">Submitted</SelectItem>\n                          <SelectItem value=\"approved\">Approved</SelectItem>\n                          <SelectItem value=\"deployed\">Deployed</SelectItem>\n                          <SelectItem value=\"expired\">Expired</SelectItem>\n                        </SelectContent>\n                      </Select>\n                    </div>\n                  </div>\n\n                  <div className=\"grid grid-cols-1 gap-4\">\n                    <div>\n                      <Label htmlFor=\"edit-notes\">Notes (Optional)</Label>\n                      <Textarea\n                        id=\"edit-notes\"\n                        name=\"notes\"\n                        rows={3}\n                        placeholder=\"Additional notes or comments\"\n                        defaultValue={editingAvailability.notes || ''}\n                      />\n                    </div>\n                  </div>\n\n                  <div className=\"flex justify-end gap-2\">\n                    <Button variant=\"outline\" type=\"button\" onClick={() => setEditingAvailability(null)}>\n                      Cancel\n                    </Button>\n                    <Button type=\"submit\" disabled={editMutation.isPending}>\n                      {editMutation.isPending ? \"Updating...\" : \"Update Entry\"}\n                    </Button>\n                  </div>\n                </form>\n              )}\n            </DialogContent>\n          </Dialog>\n        </div>\n        </div>\n\n        <div className=\"grid grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4\">\n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Total Submissions</CardTitle>\n            <FileSpreadsheet className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">{availabilityData.length}</div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Available Crews</CardTitle>\n            <Users className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {availabilityData\n                .filter((item: CrewAvailability) => item.status === 'approved')\n                .reduce((sum: number, item: CrewAvailability) => sum + getTotalCrew(item), 0)}\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Pending Review</CardTitle>\n            <Clock className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {availabilityData.filter((item: CrewAvailability) => item.status === 'submitted').length}\n            </div>\n          </CardContent>\n        </Card>\n        \n        <Card>\n          <CardHeader className=\"flex flex-row items-center justify-between space-y-0 pb-2\">\n            <CardTitle className=\"text-sm font-medium\">Currently Deployed</CardTitle>\n            <Truck className=\"h-4 w-4 text-muted-foreground\" />\n          </CardHeader>\n          <CardContent>\n            <div className=\"text-2xl font-bold\">\n              {availabilityData.filter((item: CrewAvailability) => item.status === 'deployed').length}\n            </div>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Approved Contractors Distance Analysis */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Approved Contractors - Distance Analysis</CardTitle>\n          <CardDescription>\n            Calculate travel distances and times at 55mph for approved contractors\n          </CardDescription>\n        </CardHeader>\n        <CardContent>\n          <div className=\"space-y-4\">\n            <div className=\"flex flex-col sm:flex-row gap-4 sm:items-end\">\n              <div className=\"flex-1\">\n                <Label>Destination Locations</Label>\n                <div className=\"space-y-2\">\n                  {analysisLocations.map((location, index) => (\n                    <div key={index} className=\"flex gap-2 items-end\">\n                      <div className=\"flex-1\">\n                        <Input\n                          placeholder={`Location ${index + 1} (e.g., Detroit, MI)`}\n                          value={location}\n                          onChange={(e) => updateLocation(index, e.target.value)}\n                        />\n                      </div>\n                      {analysisLocations.length > 1 && (\n                        <Button \n                          type=\"button\"\n                          variant=\"outline\" \n                          size=\"sm\"\n                          onClick={() => removeLocation(index)}\n                          className=\"text-red-600 hover:text-red-700\"\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      )}\n                    </div>\n                  ))}\n                  <Button \n                    type=\"button\" \n                    variant=\"outline\" \n                    size=\"sm\" \n                    onClick={addLocation}\n                    className=\"text-xs\"\n                  >\n                    <Plus className=\"w-4 h-4 mr-1\" />\n                    Add Destination\n                  </Button>\n                </div>\n              </div>\n              <Button \n                onClick={calculateDistances}\n                disabled={isCalculatingDistances || analysisLocations.filter(loc => loc.trim()).length === 0}\n                className=\"w-full sm:w-auto\"\n              >\n                {isCalculatingDistances ? \"Calculating...\" : \"Calculate Distances\"}\n              </Button>\n            </div>\n\n            {distanceResults.length > 0 && (\n              <div className=\"mt-6\">\n                <div className=\"flex flex-col sm:flex-row justify-between sm:items-center gap-3 mb-3\">\n                  <h4 className=\"font-semibold\">Distance Analysis Results</h4>\n                  <div className=\"flex gap-2 flex-col sm:flex-row\">\n                    <Button onClick={exportToExcel} variant=\"outline\" size=\"sm\" className=\"w-full sm:w-auto\" data-testid=\"button-export-excel-standard\">\n                      <Download className=\"w-4 h-4 mr-2\" />\n                      Export to Excel\n                    </Button>\n                    <Button onClick={exportToExcelColorCoded} variant=\"outline\" size=\"sm\" className=\"w-full sm:w-auto\" data-testid=\"button-export-excel-color-coded\">\n                      <Download className=\"w-4 h-4 mr-2\" />\n                      Color Coded Export\n                    </Button>\n                  </div>\n                </div>\n                {/* Desktop/Tablet Table - Show on medium screens and larger */}\n                <div className=\"hidden md:block\">\n                  <div className=\"min-w-full overflow-x-auto\">\n                  <Table>\n                    <TableHeader>\n                      <TableRow>\n                        <TableHead className=\"w-[20%]\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\" \n                            onClick={() => handleSort('contractor')}\n                            className=\"h-8 p-0 font-semibold text-xs\"\n                          >\n                            Contractor\n                            <ArrowUpDown className=\"ml-1 h-3 w-3\" />\n                          </Button>\n                        </TableHead>\n                        <TableHead className=\"w-[15%]\">\n                          <span className=\"text-xs font-semibold\">Departure</span>\n                        </TableHead>\n                        {/* Dynamic destination columns - separate distance and time columns */}\n                        {analysisLocations.filter(loc => loc.trim()).map((location, index) => [\n                          <TableHead key={`${index}-dist`} className=\"w-[8%]\">\n                            <div className=\"text-center\">\n                              <div className=\"text-xs font-semibold text-blue-600 mb-1\">\n                                {location.length > 12 ? location.substring(0, 12) + '...' : location}\n                              </div>\n                              <Button \n                                variant=\"ghost\" \n                                size=\"sm\" \n                                onClick={() => handleSort(`distance_${index}`)}\n                                className=\"h-6 px-1 font-semibold text-xs\"\n                              >\n                                Distance <ArrowUpDown className=\"ml-1 h-2 w-2\" />\n                              </Button>\n                            </div>\n                          </TableHead>,\n                          <TableHead key={`${index}-time`} className=\"w-[8%]\">\n                            <div className=\"text-center\">\n                              <div className=\"text-xs font-semibold text-blue-600 mb-1\">\n                                &nbsp;\n                              </div>\n                              <Button \n                                variant=\"ghost\" \n                                size=\"sm\" \n                                onClick={() => handleSort(`travelTime_${index}`)}\n                                className=\"h-6 px-1 font-semibold text-xs\"\n                              >\n                                Time <ArrowUpDown className=\"ml-1 h-2 w-2\" />\n                              </Button>\n                            </div>\n                          </TableHead>\n                        ]).flat()}\n                        <TableHead className=\"w-[9%]\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\" \n                            onClick={() => handleSort('totalFTE')}\n                            className=\"h-8 p-0 font-semibold text-xs\"\n                          >\n                            FTE\n                            <ArrowUpDown className=\"ml-1 h-3 w-3\" />\n                          </Button>\n                        </TableHead>\n                        <TableHead className=\"w-[9%]\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\" \n                            onClick={() => handleSort('buckets')}\n                            className=\"h-8 p-0 font-semibold text-xs\"\n                          >\n                            Buckets\n                            <ArrowUpDown className=\"ml-1 h-3 w-3\" />\n                          </Button>\n                        </TableHead>\n                        <TableHead className=\"w-[9%]\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\" \n                            onClick={() => handleSort('diggers')}\n                            className=\"h-8 p-0 font-semibold text-xs\"\n                          >\n                            Diggers\n                            <ArrowUpDown className=\"ml-1 h-3 w-3\" />\n                          </Button>\n                        </TableHead>\n                        <TableHead className=\"w-[9%]\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\" \n                            onClick={() => handleSort('pickups')}\n                            className=\"h-8 p-0 font-semibold text-xs\"\n                          >\n                            Pickups\n                            <ArrowUpDown className=\"ml-1 h-3 w-3\" />\n                          </Button>\n                        </TableHead>\n                        <TableHead className=\"w-[9%]\">\n                          <Button \n                            variant=\"ghost\" \n                            size=\"sm\" \n                            onClick={() => handleSort('backyardMachines')}\n                            className=\"h-8 p-0 font-semibold text-xs\"\n                          >\n                            BYM\n                            <ArrowUpDown className=\"ml-1 h-3 w-3\" />\n                          </Button>\n                        </TableHead>\n                      </TableRow>\n                    </TableHeader>\n                    <TableBody>\n                      {getSortedResults().map((result: any) => (\n                        <TableRow key={result.id}>\n                          <TableCell className=\"p-2\">\n                            <div>\n                              <div className=\"font-medium text-xs\">{result.contractor?.company}</div>\n                              <div className=\"text-xs text-gray-500\">{result.contractor?.name}</div>\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"p-2\">\n                            <div className=\"text-xs flex items-center gap-1\">\n                              {result.departureLocation}\n                              {result.contractor?.departureLocations && result.contractor.departureLocations.length > 1 && (\n                                <TooltipProvider>\n                                  <Tooltip>\n                                    <TooltipTrigger asChild>\n                                      <MapPin className=\"w-3 h-3 text-blue-600 cursor-help\" />\n                                    </TooltipTrigger>\n                                    <TooltipContent className=\"max-w-xs\">\n                                      <div className=\"text-xs\">\n                                        <div className=\"font-semibold mb-1\">All Storage Yards:</div>\n                                        {result.contractor.departureLocations.map((loc: any, idx: number) => (\n                                          <div key={idx} className=\"py-0.5\">• {loc.location}</div>\n                                        ))}\n                                      </div>\n                                    </TooltipContent>\n                                  </Tooltip>\n                                </TooltipProvider>\n                              )}\n                            </div>\n                          </TableCell>\n                          {/* Dynamic destination columns - separate distance and time cells */}\n                          {analysisLocations.filter(loc => loc.trim()).map((location, index) => [\n                            <TableCell key={`${index}-dist`} className=\"p-2 text-center\">\n                              <div className=\"font-medium text-blue-600 text-xs\">\n                                {result[`distance_${index}`] || 'N/A'}\n                              </div>\n                            </TableCell>,\n                            <TableCell key={`${index}-time`} className=\"p-2 text-center\">\n                              <div className=\"font-medium text-green-600 text-xs\">\n                                {result[`travelTime_${index}`] || 'N/A'}\n                              </div>\n                            </TableCell>\n                          ]).flat()}\n                          <TableCell className=\"p-2\">\n                            <div className=\"text-center font-medium text-xs\">\n                              {getTotalCrew(result)}\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"p-2\">\n                            <div className=\"text-center text-xs\">\n                              {result.buckets || 0}\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"p-2\">\n                            <div className=\"text-center text-xs\">\n                              {result.diggers || 0}\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"p-2\">\n                            <div className=\"text-center text-xs\">\n                              {result.pickups || 0}\n                            </div>\n                          </TableCell>\n                          <TableCell className=\"p-2\">\n                            <div className=\"text-center text-xs\">\n                              {result.backyardMachines || 0}\n                            </div>\n                          </TableCell>\n                        </TableRow>\n                      ))}\n                      {/* Totals Row */}\n                      <TableRow className=\"bg-gray-50 font-bold border-t-2\">\n                        <TableCell colSpan={2 + (analysisLocations.filter(loc => loc.trim()).length * 2)} className=\"text-right p-2\">\n                          <strong className=\"text-xs\">TOTALS:</strong>\n                        </TableCell>\n                        <TableCell className=\"text-center bg-blue-50 p-2\">\n                          <strong className=\"text-xs\">{calculateTotals().totalFTE}</strong>\n                        </TableCell>\n                        <TableCell className=\"text-center bg-blue-50 p-2\">\n                          <strong className=\"text-xs\">{calculateTotals().buckets}</strong>\n                        </TableCell>\n                        <TableCell className=\"text-center bg-blue-50 p-2\">\n                          <strong className=\"text-xs\">{calculateTotals().diggers}</strong>\n                        </TableCell>\n                        <TableCell className=\"text-center bg-blue-50 p-2\">\n                          <strong className=\"text-xs\">{calculateTotals().pickups}</strong>\n                        </TableCell>\n                        <TableCell className=\"text-center bg-blue-50 p-2\">\n                          <strong className=\"text-xs\">{calculateTotals().backyardMachines}</strong>\n                        </TableCell>\n                      </TableRow>\n                    </TableBody>\n                  </Table>\n                  </div>\n                </div>\n\n                {/* Mobile Card Layout */}\n                <div className=\"md:hidden space-y-4\">\n                  <div className=\"flex flex-wrap gap-2 mb-4\">\n                    <Button \n                      variant={sortField === 'distance' ? 'default' : 'outline'} \n                      size=\"sm\" \n                      onClick={() => handleSort('distance')}\n                      className=\"text-xs\"\n                    >\n                      Distance <ArrowUpDown className=\"ml-1 h-3 w-3\" />\n                    </Button>\n                    <Button \n                      variant={sortField === 'totalFTE' ? 'default' : 'outline'} \n                      size=\"sm\" \n                      onClick={() => handleSort('totalFTE')}\n                      className=\"text-xs\"\n                    >\n                      FTE <ArrowUpDown className=\"ml-1 h-3 w-3\" />\n                    </Button>\n                    <Button \n                      variant={sortField === 'contractor' ? 'default' : 'outline'} \n                      size=\"sm\" \n                      onClick={() => handleSort('contractor')}\n                      className=\"text-xs\"\n                    >\n                      Company <ArrowUpDown className=\"ml-1 h-3 w-3\" />\n                    </Button>\n                  </div>\n\n                  {getSortedResults().map((result: any) => (\n                    <Card key={result.id} className=\"p-4\">\n                      <div className=\"space-y-3\">\n                        <div className=\"flex justify-between items-start\">\n                          <div className=\"flex-1\">\n                            <div className=\"font-medium text-sm\">{result.contractor?.company}</div>\n                            <div className=\"text-xs text-gray-500\">{result.contractor?.name}</div>\n                            <div className=\"text-xs text-blue-600 font-medium mt-1 flex items-center gap-1\">\n                              <strong>From:</strong> {result.departureLocation}\n                              {result.contractor?.departureLocations && result.contractor.departureLocations.length > 1 && (\n                                <TooltipProvider>\n                                  <Tooltip>\n                                    <TooltipTrigger asChild>\n                                      <MapPin className=\"w-3 h-3 cursor-help\" />\n                                    </TooltipTrigger>\n                                    <TooltipContent className=\"max-w-xs\">\n                                      <div className=\"text-xs\">\n                                        <div className=\"font-semibold mb-1\">All Storage Yards:</div>\n                                        {result.contractor.departureLocations.map((loc: any, idx: number) => (\n                                          <div key={idx} className=\"py-0.5\">• {loc.location}</div>\n                                        ))}\n                                      </div>\n                                    </TooltipContent>\n                                  </Tooltip>\n                                </TooltipProvider>\n                              )}\n                            </div>\n                          </div>\n                        </div>\n\n                        {/* Distance and Travel Time Grid for All Destinations */}\n                        <div className=\"space-y-2\">\n                          <div className=\"text-xs font-medium text-gray-700\">Distances & Travel Times:</div>\n                          <div className=\"grid gap-2\">\n                            {analysisLocations.filter(loc => loc.trim()).map((location, index) => (\n                              <div key={index} className=\"flex justify-between items-center p-2 bg-gray-50 rounded text-xs\">\n                                <div className=\"font-medium text-blue-600\">\n                                  {location.length > 20 ? location.substring(0, 20) + '...' : location}\n                                </div>\n                                <div className=\"flex gap-3 text-right\">\n                                  <div>\n                                    <span className=\"font-medium text-blue-600\">{result[`distance_${index}`] || 'N/A'}</span>\n                                    <span className=\"text-gray-500\"> mi</span>\n                                  </div>\n                                  <div>\n                                    <span className=\"font-medium text-green-600\">{result[`travelTime_${index}`] || 'N/A'}</span>\n                                  </div>\n                                </div>\n                              </div>\n                            ))}\n                          </div>\n                        </div>\n                        \n                        {/* Equipment Grid */}\n                        <div className=\"grid grid-cols-5 gap-2 text-center bg-blue-50 p-2 rounded\">\n                          <div>\n                            <div className=\"text-xs font-medium text-gray-600\">FTE</div>\n                            <div className=\"text-sm font-bold text-blue-600\">{getTotalCrew(result)}</div>\n                          </div>\n                          <div>\n                            <div className=\"text-xs font-medium text-gray-600\">Buckets</div>\n                            <div className=\"text-sm font-medium\">{result.buckets || 0}</div>\n                          </div>\n                          <div>\n                            <div className=\"text-xs font-medium text-gray-600\">Diggers</div>\n                            <div className=\"text-sm font-medium\">{result.diggers || 0}</div>\n                          </div>\n                          <div>\n                            <div className=\"text-xs font-medium text-gray-600\">Pickups</div>\n                            <div className=\"text-sm font-medium\">{result.pickups || 0}</div>\n                          </div>\n                          <div>\n                            <div className=\"text-xs font-medium text-gray-600\">BYM</div>\n                            <div className=\"text-sm font-medium\">{result.backyardMachines || 0}</div>\n                          </div>\n                        </div>\n                      </div>\n                    </Card>\n                  ))}\n\n                  {/* Mobile Totals Card */}\n                  <Card className=\"p-4 bg-blue-50 border-blue-200\">\n                    <div className=\"text-center\">\n                      <div className=\"text-sm font-bold mb-2\">TOTALS</div>\n                      <div className=\"grid grid-cols-5 gap-2 text-center\">\n                        <div>\n                          <div className=\"text-xs font-medium text-gray-600\">FTE</div>\n                          <div className=\"text-lg font-bold text-blue-600\">{calculateTotals().totalFTE}</div>\n                        </div>\n                        <div>\n                          <div className=\"text-xs font-medium text-gray-600\">Buckets</div>\n                          <div className=\"text-lg font-bold text-blue-600\">{calculateTotals().buckets}</div>\n                        </div>\n                        <div>\n                          <div className=\"text-xs font-medium text-gray-600\">Diggers</div>\n                          <div className=\"text-lg font-bold text-blue-600\">{calculateTotals().diggers}</div>\n                        </div>\n                        <div>\n                          <div className=\"text-xs font-medium text-gray-600\">Pickups</div>\n                          <div className=\"text-lg font-bold text-blue-600\">{calculateTotals().pickups}</div>\n                        </div>\n                        <div>\n                          <div className=\"text-xs font-medium text-gray-600\">BYM</div>\n                          <div className=\"text-lg font-bold text-blue-600\">{calculateTotals().backyardMachines}</div>\n                        </div>\n                      </div>\n                    </div>\n                  </Card>\n                </div>\n                <div className=\"mt-4 p-4 bg-blue-50 rounded-lg\">\n                  <p className=\"text-sm text-blue-700\">\n                    <strong>Analysis Locations:</strong> {analysisLocations.filter(loc => loc.trim()).join(', ')} | \n                    <strong> Approved Contractors Found:</strong> {distanceResults.length} | \n                    <strong> Total Available FTE:</strong> {calculateTotals().totalFTE}\n                  </p>\n                </div>\n              </div>\n            )}\n\n            {availabilityData.filter((item: any) => item.status === 'approved').length === 0 && (\n              <div className=\"text-center py-8 text-gray-500\">\n                No approved contractors available for distance analysis. Approve some contractors first.\n              </div>\n            )}\n          </div>\n        </CardContent>\n      </Card>\n\n      <Card>\n        <CardHeader>\n          <div className=\"flex justify-between items-start\">\n            <div>\n              <CardTitle>Availability Submissions</CardTitle>\n              <CardDescription>\n                Review and manage contractor availability submissions\n              </CardDescription>\n            </div>\n            <div className=\"flex gap-2 flex-wrap\">\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={() => exportAvailabilityData('csv')}\n                data-testid=\"button-export-csv\"\n                disabled={availabilityData.length === 0}\n              >\n                <Download className=\"w-4 h-4 mr-2\" />\n                Export CSV\n              </Button>\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={() => exportAvailabilityData('excel')}\n                data-testid=\"button-export-excel\"\n                disabled={availabilityData.length === 0}\n              >\n                <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n                Export Excel\n              </Button>\n              <Button \n                variant=\"outline\" \n                size=\"sm\" \n                onClick={() => exportAIMatchedData('excel')}\n                data-testid=\"button-export-ai-excel\"\n                disabled={availabilityData.length === 0}\n                className=\"bg-blue-50 hover:bg-blue-100 border-blue-200\"\n              >\n                <FileSpreadsheet className=\"w-4 h-4 mr-2\" />\n                AI-Enhanced Export\n              </Button>\n            </div>\n          </div>\n        </CardHeader>\n        <CardContent>\n          {isLoading ? (\n            <div className=\"text-center py-8\">Loading availability data...</div>\n          ) : availabilityData.length === 0 ? (\n            <div className=\"text-center py-8 text-gray-500\">\n              No availability submissions found. Upload a file or add manually to get started.\n            </div>\n          ) : (\n            <div className=\"overflow-x-auto\">\n              <Table>\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Contractor</TableHead>\n                    <TableHead>Crew & Equipment</TableHead>\n                    <TableHead>Departure</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Submitted By</TableHead>\n                    <TableHead>Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {availabilityData\n                    .slice()\n                    .sort((a: any, b: any) => new Date(a.submissionDate).getTime() - new Date(b.submissionDate).getTime())\n                    .map((availability: CrewAvailability) => (\n                    <TableRow key={availability.id}>\n                      <TableCell>\n                        <div>\n                          <div className=\"font-medium\">{availability.contractor?.company}</div>\n                          <div className=\"text-sm text-gray-500\">{availability.contractor?.name}</div>\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"text-sm\">\n                          <div className=\"font-medium\">Total FTE: {getTotalCrew(availability)}</div>\n                          <div className=\"text-gray-500\">{getEquipmentSummary(availability)}</div>\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        <div className=\"text-sm\">\n                          {availability.departureCity && availability.departureState \n                            ? `${availability.departureCity}, ${availability.departureState}`\n                            : availability.departureLocation || 'Not specified'}\n                        </div>\n                      </TableCell>\n                      <TableCell>\n                        {getStatusBadge(availability.status)}\n                      </TableCell>\n                      <TableCell>{availability.submittedBy}</TableCell>\n                      <TableCell>\n                        <div className=\"flex gap-2\">\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => setEditingAvailability(availability)}\n                          >\n                            Edit\n                          </Button>\n                          <AlertDialog>\n                            <AlertDialogTrigger asChild>\n                              <Button variant=\"outline\" size=\"sm\">\n                                Delete\n                              </Button>\n                            </AlertDialogTrigger>\n                            <AlertDialogContent>\n                              <AlertDialogHeader>\n                                <AlertDialogTitle>Delete Availability Entry</AlertDialogTitle>\n                                <AlertDialogDescription>\n                                  Are you sure you want to delete this availability entry for {availability.contractor?.name}? This action cannot be undone.\n                                </AlertDialogDescription>\n                              </AlertDialogHeader>\n                              <AlertDialogFooter>\n                                <AlertDialogCancel>Cancel</AlertDialogCancel>\n                                <AlertDialogAction\n                                  onClick={() => deleteMutation.mutate(availability.id)}\n                                  className=\"bg-red-600 hover:bg-red-700\"\n                                >\n                                  Delete\n                                </AlertDialogAction>\n                              </AlertDialogFooter>\n                            </AlertDialogContent>\n                          </AlertDialog>\n                          <Button\n                            variant=\"outline\"\n                            size=\"sm\"\n                            onClick={() => statusUpdateMutation.mutate({ \n                              id: availability.id, \n                              status: availability.status === 'approved' ? 'submitted' : 'approved' \n                            })}\n                            disabled={statusUpdateMutation.isPending}\n                          >\n                            {availability.status === 'approved' ? 'Unapprove' : 'Approve'}\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n      </div>\n\n      {/* Session Naming Dialog */}\n      <Dialog open={isSessionDialogOpen} onOpenChange={setIsSessionDialogOpen}>\n        <DialogContent>\n          <DialogHeader>\n            <DialogTitle>Start New Session</DialogTitle>\n            <DialogDescription>\n              Enter a name for your new availability session. This will save current submissions and start fresh.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"sessionName\">Session Name</Label>\n              <Input\n                id=\"sessionName\"\n                placeholder=\"e.g., Week of Jan 15, 2025\"\n                value={newSessionName}\n                onChange={(e) => setNewSessionName(e.target.value)}\n                data-testid=\"input-session-name\"\n              />\n            </div>\n            <div className=\"flex justify-end gap-2\">\n              <Button\n                variant=\"outline\"\n                onClick={() => {\n                  setIsSessionDialogOpen(false);\n                  setNewSessionName('');\n                }}\n                data-testid=\"button-cancel-session\"\n              >\n                Cancel\n              </Button>\n              <Button\n                onClick={() => {\n                  if (newSessionName.trim()) {\n                    startNewSessionMutation.mutate(newSessionName.trim());\n                  } else {\n                    toast({\n                      title: \"Session Name Required\",\n                      description: \"Please enter a name for the new session.\",\n                      variant: \"destructive\",\n                    });\n                  }\n                }}\n                disabled={startNewSessionMutation.isPending || !newSessionName.trim()}\n                className=\"bg-green-600 hover:bg-green-700\"\n                data-testid=\"button-create-session\"\n              >\n                {startNewSessionMutation.isPending ? (\n                  <>\n                    <Clock className=\"w-4 h-4 mr-2 animate-spin\" />\n                    Creating Session...\n                  </>\n                ) : (\n                  <>\n                    <CheckCircle className=\"w-4 h-4 mr-2\" />\n                    Create Session\n                  </>\n                )}\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}","path":null,"size_bytes":102338,"size_tokens":null},"client/src/components/ui/skeleton.tsx":{"content":"import { cn } from \"@/lib/utils\"\n\nfunction Skeleton({\n  className,\n  ...props\n}: React.HTMLAttributes<HTMLDivElement>) {\n  return (\n    <div\n      className={cn(\"animate-pulse rounded-md bg-muted\", className)}\n      {...props}\n    />\n  )\n}\n\nexport { Skeleton }\n","path":null,"size_bytes":261,"size_tokens":null},"server/services/weatherService.ts":{"content":"interface SPCOutlookFeature {\n  type: \"Feature\";\n  properties: {\n    category: string;\n    outlook_day?: number;\n    [key: string]: any;\n  };\n  geometry: {\n    type: string;\n    coordinates: any;\n  };\n}\n\ninterface ElectricUtilityFeature {\n  type: \"Feature\";\n  properties: {\n    NAME: string;\n    Customers: number;\n    [key: string]: any;\n  };\n  geometry: {\n    type: string;\n    coordinates: any;\n  };\n}\n\ninterface AffectedUtility {\n  name: string;\n  customers: number;\n  intersectingArea: number;\n  highestRiskLevel?: string;\n  riskLevels?: string[];\n}\n\nexport async function fetchSPCOutlook(days: number[] = [1, 2, 3]) {\n  const baseUrl = \"https://mapservices.weather.noaa.gov/vector/rest/services/outlooks/SPC_wx_outlks/MapServer/\";\n  \n  // Map days to layer IDs for PROBABILISTIC WIND OUTLOOK specifically \n  const layerIds = {\n    1: 7,  // Day 1 Probabilistic Wind Outlook\n    2: 15, // Day 2 Probabilistic Wind Outlook  \n    3: 17  // Day 3 Categorical Outlook (since Day 3 doesn't have specific wind probability layer)\n  };\n\n  const combinedFeatures: SPCOutlookFeature[] = [];\n\n  console.log(`Fetching SPC wind outlook for days: ${JSON.stringify(days)} (5% or higher wind probability)`);\n\n  for (const day of days) {\n    if (!(day in layerIds)) {\n      console.warn(`Invalid day number: ${day}. Skipping.`);\n      continue;\n    }\n\n    const layerId = layerIds[day as keyof typeof layerIds];\n    \n    // Day 3 uses categorical outlook, so we need different query parameters\n    let whereClause, logDescription;\n    if (day === 3) {\n      // For Day 3 categorical outlook, get ENH, MDT, and HIGH categories\n      whereClause = \"dn IN (2, 3, 4, 5)\"; // SLGT=2, ENH=3, MDT=4, HIGH=5 for categorical outlook\n      logDescription = \"categorical outlook (ENH, MDT, HIGH categories)\";\n    } else {\n      // For Days 1-2, query for wind probabilities 5% or higher\n      whereClause = \"dn >= 5\"; // 5% or higher wind probability\n      logDescription = \"wind outlook (5%+ probability)\";\n    }\n\n    const params = new URLSearchParams({\n      where: whereClause,\n      outFields: \"*\",\n      f: \"geojson\",\n      returnGeometry: \"true\"\n    });\n\n    console.log(`Day ${day} ${logDescription} query: ${baseUrl}${layerId}/query?${params.toString()}`);\n\n    try {\n      console.log(`Fetching Day ${day} ${logDescription}...`);\n      const response = await fetch(`${baseUrl}${layerId}/query?${params}`);\n      \n      if (!response.ok) {\n        console.error(`Failed to fetch Day ${day} wind outlook: ${response.status} ${response.statusText}`);\n        continue;\n      }\n\n      const geojsonData = await response.json();\n      \n      if (geojsonData?.features) {\n        // Process outlook features - different logic for Day 3 vs Days 1-2\n        geojsonData.features.forEach((feature: SPCOutlookFeature) => {\n          const dnValue = feature.properties.dn;\n          const source = feature.properties.idp_source;\n          \n          if (day === 3) {\n            // Day 3 uses categorical outlook: 2=SLGT, 3=ENH, 4=MDT, 5=HIGH\n            console.log(`Day ${day} categorical level: ${dnValue}`, 'Source:', source);\n            \n            if (dnValue >= 3) { // Only include ENH, MDT, HIGH (excluding SLGT=2)\n              let category = '';\n              if (dnValue === 5) category = 'HIGH';\n              else if (dnValue === 4) category = 'MDT';\n              else if (dnValue === 3) category = 'ENH';\n              else category = 'SLGT';\n              \n              feature.properties.outlook_day = day;\n              feature.properties.category = category;\n              feature.properties.categorical_level = dnValue;\n              combinedFeatures.push(feature);\n            }\n          } else {\n            // Days 1-2 use wind probability\n            console.log(`Day ${day} wind probability: ${dnValue}%`, 'Source:', source);\n            \n            // Only include areas with 5% or higher wind probability (excluding lowest threat)\n            if (dnValue >= 5) {\n              // Categorize wind risk based on probability\n              let category = '';\n              if (dnValue >= 45) category = 'HIGH';        // 45%+ = High\n              else if (dnValue >= 30) category = 'MDT';    // 30-44% = Moderate\n              else if (dnValue >= 15) category = 'ENH';    // 15-29% = Enhanced\n              else if (dnValue >= 5) category = 'SLGT';    // 5-14% = Slight\n              else category = 'MRGL';\n              \n              feature.properties.outlook_day = day;\n              feature.properties.category = category;\n              feature.properties.wind_probability = dnValue;\n              combinedFeatures.push(feature);\n            }\n          }\n        });\n        \n        const totalFeatures = geojsonData.features.length;\n        const filteredCount = combinedFeatures.filter(f => f.properties.outlook_day === day).length;\n        console.log(`Fetched ${totalFeatures} total wind features for Day ${day}, filtered to ${filteredCount} wind areas (5%+ probability)`);\n      }\n    } catch (error) {\n      console.error(`Error fetching Day ${day} wind outlook:`, error);\n    }\n  }\n\n  if (combinedFeatures.length === 0) {\n    console.log(\"No wind areas with 5% or higher probability found in current 3-day outlook.\");\n  }\n\n  console.log(`Wind outlook result: ${combinedFeatures.length} wind areas with 5%+ probability`);\n  return {\n    type: \"FeatureCollection\",\n    features: combinedFeatures\n  };\n}\n\n// Function to generate fallback utility data when APIs fail\nfunction generateFallbackUtilities() {\n  // Return a basic set of major utility service areas for demonstration\n  // This ensures the map layer functionality works even when external APIs fail\n  const majorUtilities = [\n    // Major electric utilities with approximate service areas\n    { name: \"PG&E\", customers: 5400000, bounds: [-124.4, 32.5, -114.5, 42.0] }, // California\n    { name: \"Southern California Edison\", customers: 5000000, bounds: [-119.3, 33.7, -116.8, 35.8] },\n    { name: \"Florida Power & Light\", customers: 5100000, bounds: [-87.6, 24.5, -80.0, 31.0] }, // Florida\n    { name: \"Duke Energy\", customers: 7800000, bounds: [-84.3, 32.0, -75.4, 39.7] }, // Carolinas/Ohio\n    { name: \"Georgia Power\", customers: 2600000, bounds: [-85.6, 30.4, -80.8, 35.0] }, // Georgia\n    { name: \"ConEd\", customers: 3400000, bounds: [-74.3, 40.5, -73.7, 41.0] }, // NYC area\n    { name: \"ComEd\", customers: 4000000, bounds: [-88.3, 41.6, -87.5, 42.5] }, // Chicago\n    { name: \"Xcel Energy\", customers: 3600000, bounds: [-105.1, 39.6, -94.4, 45.0] }, // Colorado/Minnesota\n    { name: \"PEPCO\", customers: 860000, bounds: [-77.1, 38.8, -76.9, 39.0] }, // DC area\n    { name: \"PSEG\", customers: 2200000, bounds: [-75.6, 39.4, -73.9, 41.4] }, // New Jersey\n  ];\n\n  const features = majorUtilities.map((utility, index) => ({\n    type: \"Feature\",\n    properties: {\n      NAME: utility.name,\n      CUSTOMERS: utility.customers,\n      id: index + 1\n    },\n    geometry: {\n      type: \"Polygon\",\n      coordinates: [[\n        [utility.bounds[0], utility.bounds[1]], // SW\n        [utility.bounds[2], utility.bounds[1]], // SE\n        [utility.bounds[2], utility.bounds[3]], // NE\n        [utility.bounds[0], utility.bounds[3]], // NW\n        [utility.bounds[0], utility.bounds[1]]  // Close polygon\n      ]]\n    }\n  }));\n\n  return {\n    type: \"FeatureCollection\",\n    features,\n    fallback: true,\n    message: \"Using cached utility data - external API unavailable\"\n  };\n}\n\nexport async function fetchElectricUtilities() {\n  console.log('Electric utilities API called');\n  \n  // Check for custom uploaded data first\n  try {\n    const customDataPath = './data/custom_utility_data.json';\n    const fs = await import('fs/promises');\n    const customData = await fs.readFile(customDataPath, 'utf-8');\n    const parsedData = JSON.parse(customData);\n    \n    if (parsedData.features && parsedData.features.length > 0) {\n      console.log(`Returning custom utility data: ${parsedData.features.length} utilities`);\n      return {\n        ...parsedData,\n        source: \"custom\",\n        message: \"Using custom uploaded utility data\"\n      };\n    }\n  } catch (error) {\n    console.log('No custom utility data found, trying external APIs...');\n  }\n\n  // Use only the user's specified authentic ArcGIS service URL\n  const apiUrl = \"https://services1.arcgis.com/Hp6G80Pky0om7QvQ/arcgis/rest/services/Retail_Service_Territories_gdb/FeatureServer/0/query\";\n  const params = new URLSearchParams({\n    outFields: \"*\", \n    where: \"1=1\", \n    f: \"geojson\",\n    resultRecordCount: \"1500\" // Fetch top 1500 utilities\n  });\n\n  console.log(`Attempting authentic ArcGIS API: ${apiUrl}`);\n  console.log(`Request URL: ${apiUrl}?${params}`);\n  \n  try {\n    const controller = new AbortController();\n    const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout\n    \n    const response = await fetch(`${apiUrl}?${params}`, {\n      signal: controller.signal,\n      headers: {\n        'User-Agent': 'Mozilla/5.0 (compatible; Storm Response Application)',\n        'Accept': 'application/json, application/geo+json',\n        'Referer': 'https://www.arcgis.com'\n      }\n    });\n    \n    clearTimeout(timeoutId);\n    \n    console.log(`Authentic ArcGIS API response status: ${response.status} ${response.statusText}`);\n    \n    if (response.ok) {\n      const territoriesGeojson = await response.json();\n      console.log(`Raw authentic API response structure:`, {\n        type: territoriesGeojson.type,\n        featuresCount: territoriesGeojson.features?.length || 0,\n        firstFeatureKeys: territoriesGeojson.features?.[0]?.properties ? Object.keys(territoriesGeojson.features[0].properties) : [],\n        firstFeature: territoriesGeojson.features?.[0]?.properties || {}\n      });\n      \n      // Validate the response structure\n      if (territoriesGeojson.features && Array.isArray(territoriesGeojson.features) && territoriesGeojson.features.length > 0) {\n        console.log(`Successfully fetched ${territoriesGeojson.features.length} authentic electric utility territories`);\n        \n        // Sort by customer count (highest first) and take top 1500\n        const sortedFeatures = territoriesGeojson.features\n          .filter((feature: any) => feature.properties.CUSTOMERS > 0)\n          .sort((a: any, b: any) => (b.properties.CUSTOMERS || 0) - (a.properties.CUSTOMERS || 0))\n          .slice(0, 1500);\n        \n        console.log(`Sorted and filtered to top ${sortedFeatures.length} utilities by customer count`);\n        \n        // Log first few features to understand the authentic data structure\n        sortedFeatures.slice(0, 3).forEach((feature: any, index: number) => {\n          console.log(`Top Utility ${index + 1} properties:`, feature.properties);\n        });\n        \n        return {\n          ...territoriesGeojson,\n          features: sortedFeatures,\n          source: \"ArcGIS Retail Service Territories (Authentic)\",\n          message: `Top ${sortedFeatures.length} utilities by customer count loaded from user's ArcGIS service`\n        };\n      } else {\n        console.log('Authentic ArcGIS API returned empty or invalid data structure');\n      }\n    } else {\n      const errorText = await response.text();\n      console.log(`Authentic ArcGIS API failed with status ${response.status}: ${errorText.substring(0, 200)}`);\n    }\n  } catch (error) {\n    const errorMessage = error instanceof Error ? error.message : 'Unknown error';\n    console.log(`Authentic ArcGIS API request failed: ${errorMessage}`);\n  }\n\n  console.log('Authentic ArcGIS API failed, using fallback dataset');\n  return generateFallbackUtilities();\n}\n\nexport async function calculateAffectedUtilities(outlookGeojson: any): Promise<AffectedUtility[]> {\n  if (!outlookGeojson?.features?.length) {\n    console.log(\"No outlook features provided for intersection calculation\");\n    return [];\n  }\n\n  try {\n    // Fetch electric utilities data\n    const utilitiesData = await fetchElectricUtilities();\n    \n    if (!utilitiesData?.features?.length) {\n      console.log(\"No electric utility data available for intersection\");\n      return [];\n    }\n\n    console.log(\"Calculating intersections between SPC outlook and electric utilities...\");\n    console.log(\"Filtering to utilities affected only by HIGH, MDT (Moderate), or ENH (Enhanced) risk areas\");\n    \n    // Pre-filter outlook features to only significant risk levels for efficiency\n    const significantRiskLevels = ['HIGH', 'MDT', 'ENH'];\n    const significantOutlookFeatures = outlookGeojson.features.filter((feature: any) => {\n      const category = feature.properties.category || 'UNKNOWN';\n      return significantRiskLevels.includes(category);\n    });\n    \n    if (significantOutlookFeatures.length === 0) {\n      console.log(\"No significant risk areas (HIGH, MDT, ENH) found in outlook\");\n      return [];\n    }\n    \n    // Create spatial index for outlook features (simplified bounding box index)\n    const outlookSpatialIndex = significantOutlookFeatures.map((feature: any) => ({\n      feature,\n      bounds: calculateBoundingBox([feature]),\n      category: feature.properties.category || 'UNKNOWN'\n    }));\n    \n    const affectedUtilities: AffectedUtility[] = [];\n    let processedCount = 0;\n    \n    // Process utilities in batches for better performance\n    const batchSize = 50;\n    for (let i = 0; i < utilitiesData.features.length; i += batchSize) {\n      const batch = utilitiesData.features.slice(i, i + batchSize);\n      \n      for (const utility of batch) {\n        if (!utility.geometry || !utility.properties) continue;\n        \n        processedCount++;\n        \n        // Calculate utility bounds once\n        const utilityBounds = calculateBoundingBox([utility]);\n        \n        // Find intersecting significant risk areas using spatial index\n        const intersectingRiskLevels = new Set<string>();\n        \n        for (const indexedFeature of outlookSpatialIndex) {\n          if (boundingBoxesIntersect(utilityBounds, indexedFeature.bounds)) {\n            intersectingRiskLevels.add(indexedFeature.category);\n          }\n        }\n        \n        // Only process utilities that intersect with significant risk areas\n        if (intersectingRiskLevels.size > 0) {\n          const customers = utility.properties.CUSTOMERS || \n                           utility.properties.Customers || \n                           utility.properties.customers || \n                           utility.properties.Customer_Count ||\n                           utility.properties.NUM_CUSTOMERS || \n                           0;\n          \n          const affectingRiskLevels = Array.from(intersectingRiskLevels);\n          \n          // Determine highest risk level (priority order: HIGH > MDT > ENH)\n          const riskPriority = { HIGH: 4, MDT: 3, ENH: 2, SLGT: 1, UNKNOWN: 0 };\n          const highestRisk = affectingRiskLevels.reduce((highest, current) => \n            (riskPriority[current as keyof typeof riskPriority] || 0) > (riskPriority[highest as keyof typeof riskPriority] || 0) ? current : highest, 'UNKNOWN');\n          \n          // Calculate intersection area estimate (simplified)\n          const intersectionArea = calculateIntersectionArea(utilityBounds, outlookSpatialIndex);\n          \n          affectedUtilities.push({\n            name: utility.properties.NAME || 'Unknown Utility',\n            customers: customers,\n            intersectingArea: intersectionArea,\n            highestRiskLevel: highestRisk,\n            riskLevels: affectingRiskLevels\n          });\n        }\n      }\n      \n      // Log progress for large datasets\n      if (processedCount % 100 === 0) {\n        console.log(`Processed ${processedCount}/${utilitiesData.features.length} utilities...`);\n      }\n    }\n\n    // Sort by highest risk level first, then by customer count (largest first)\n    const riskPriority = { HIGH: 4, MDT: 3, ENH: 2, SLGT: 1, UNKNOWN: 0 };\n    affectedUtilities.sort((a, b) => {\n      const aRisk = riskPriority[a.highestRiskLevel as keyof typeof riskPriority] || 0;\n      const bRisk = riskPriority[b.highestRiskLevel as keyof typeof riskPriority] || 0;\n      \n      // First sort by risk level (highest first)\n      if (aRisk !== bRisk) {\n        return bRisk - aRisk;\n      }\n      \n      // Then sort by customer count (largest first)\n      return b.customers - a.customers;\n    });\n    \n    console.log(`Found ${affectedUtilities.length} utilities affected by HIGH, MDT, or ENH risk areas (excluding SLGT/slight risk)`);\n    return affectedUtilities;\n    \n  } catch (error) {\n    console.error(\"Error calculating affected utilities:\", error);\n    throw error;\n  }\n}\n\nfunction calculateBoundingBox(features: any[]) {\n  let minLng = Infinity, minLat = Infinity;\n  let maxLng = -Infinity, maxLat = -Infinity;\n  \n  for (const feature of features) {\n    if (!feature.geometry?.coordinates) continue;\n    \n    const coords = flattenCoordinates(feature.geometry.coordinates);\n    \n    for (const [lng, lat] of coords) {\n      minLng = Math.min(minLng, lng);\n      maxLng = Math.max(maxLng, lng);\n      minLat = Math.min(minLat, lat);\n      maxLat = Math.max(maxLat, lat);\n    }\n  }\n  \n  return { minLng, minLat, maxLng, maxLat };\n}\n\nfunction calculateIntersectionArea(utilityBounds: any, outlookSpatialIndex: any[]): number {\n  // Calculate approximate intersection area using bounding box overlap\n  let totalIntersectionArea = 0;\n  \n  for (const indexedFeature of outlookSpatialIndex) {\n    if (boundingBoxesIntersect(utilityBounds, indexedFeature.bounds)) {\n      // Calculate intersection area of bounding boxes\n      const intersectionBounds = {\n        minLng: Math.max(utilityBounds.minLng, indexedFeature.bounds.minLng),\n        minLat: Math.max(utilityBounds.minLat, indexedFeature.bounds.minLat),\n        maxLng: Math.min(utilityBounds.maxLng, indexedFeature.bounds.maxLng),\n        maxLat: Math.min(utilityBounds.maxLat, indexedFeature.bounds.maxLat)\n      };\n      \n      const width = intersectionBounds.maxLng - intersectionBounds.minLng;\n      const height = intersectionBounds.maxLat - intersectionBounds.minLat;\n      totalIntersectionArea += width * height;\n    }\n  }\n  \n  return totalIntersectionArea;\n}\n\nfunction flattenCoordinates(coords: any[]): number[][] {\n  const result: number[][] = [];\n  \n  function flatten(arr: any) {\n    if (Array.isArray(arr) && arr.length >= 2 && typeof arr[0] === 'number' && typeof arr[1] === 'number') {\n      result.push([arr[0], arr[1]]);\n    } else if (Array.isArray(arr)) {\n      arr.forEach(flatten);\n    }\n  }\n  \n  flatten(coords);\n  return result;\n}\n\nfunction boundingBoxesIntersect(box1: any, box2: any): boolean {\n  return !(box1.maxLng < box2.minLng || \n           box2.maxLng < box1.minLng || \n           box1.maxLat < box2.minLat || \n           box2.maxLat < box1.minLat);\n}","path":null,"size_bytes":18789,"size_tokens":null},"server/reimport-storage-yards.ts":{"content":"import { parseKMZFile, convertToResources } from './services/kmzParser';\nimport { db } from './db';\nimport { resources } from '@shared/schema';\nimport { eq } from 'drizzle-orm';\nimport path from 'path';\n\nasync function reimportStorageYards() {\n  try {\n    console.log('Starting storage yard re-import...');\n    \n    // Parse the KMZ file\n    const kmzPath = path.join(process.cwd(), 'attached_assets', 'pipefile 16May2025_1750283456722.kmz');\n    console.log(`Parsing KMZ file: ${kmzPath}`);\n    \n    const placemarks = await parseKMZFile(kmzPath);\n    const resourceData = convertToResources(placemarks);\n    \n    console.log(`Found ${resourceData.length} total items in KMZ file`);\n    \n    // First, delete only storage yards (not contractors)\n    const existingResources = await db.select().from(resources);\n    console.log(`Current resources in database: ${existingResources.length}`);\n    \n    const storageYards = existingResources.filter(r => !r.properties?.contractorId);\n    console.log(`Deleting ${storageYards.length} existing storage yards...`);\n    \n    for (const yard of storageYards) {\n      await db.delete(resources).where(eq(resources.id, yard.id));\n    }\n    \n    // Now insert all items from KMZ (they should all be storage yards)\n    console.log(`Inserting ${resourceData.length} items from KMZ...`);\n    \n    let insertedCount = 0;\n    for (const data of resourceData) {\n      await db.insert(resources).values(data);\n      insertedCount++;\n    }\n    \n    console.log(`✓ Successfully inserted ${insertedCount} storage yards`);\n    \n    // Verify final count\n    const finalResources = await db.select().from(resources);\n    const finalContractors = finalResources.filter(r => r.properties?.contractorId).length;\n    const finalStorageYards = finalResources.filter(r => !r.properties?.contractorId).length;\n    \n    console.log('\\nFinal resource count:');\n    console.log(`  - Contractors: ${finalContractors}`);\n    console.log(`  - Storage Yards: ${finalStorageYards}`);\n    console.log(`  - Total: ${finalResources.length}`);\n    \n    process.exit(0);\n  } catch (error) {\n    console.error('Error reimporting storage yards:', error);\n    process.exit(1);\n  }\n}\n\nreimportStorageYards();\n","path":null,"size_bytes":2214,"size_tokens":null},"server/migrate-location-fields.ts":{"content":"import { db } from \"./db\";\nimport { crewAvailability } from \"../shared/schema\";\nimport { eq, isNotNull, or } from \"drizzle-orm\";\n\n/**\n * Migration script to split departureLocation into departureCity and departureState\n * This script:\n * 1. Reads all crew_availability records with departureLocation\n * 2. Splits \"City, State\" format into separate fields\n * 3. Updates the database with new city and state values\n */\n\nasync function migrateDepartureLocations() {\n  console.log(\"Starting migration of departure locations...\");\n  \n  try {\n    // Get all records that have departureLocation but missing city/state\n    const records = await db\n      .select()\n      .from(crewAvailability)\n      .where(\n        or(\n          isNotNull(crewAvailability.departureLocation)\n        )\n      );\n\n    console.log(`Found ${records.length} records to process`);\n\n    let updated = 0;\n    let skipped = 0;\n    let errors = 0;\n\n    for (const record of records) {\n      try {\n        // Skip if already has city and state\n        if (record.departureCity && record.departureState) {\n          skipped++;\n          continue;\n        }\n\n        // Skip if no departure location to parse\n        if (!record.departureLocation || record.departureLocation.trim() === '') {\n          skipped++;\n          continue;\n        }\n\n        // Parse \"City, State\" format\n        const locationParts = record.departureLocation.split(',').map(part => part.trim());\n        \n        let city = '';\n        let state = '';\n\n        if (locationParts.length >= 2) {\n          // Standard \"City, State\" format\n          city = locationParts[0];\n          state = locationParts[1];\n        } else if (locationParts.length === 1) {\n          // Only one part - could be city or state, treat as city\n          city = locationParts[0];\n        }\n\n        // Update the record\n        await db\n          .update(crewAvailability)\n          .set({\n            departureCity: city || null,\n            departureState: state || null,\n          })\n          .where(eq(crewAvailability.id, record.id));\n\n        updated++;\n        \n        if (updated % 10 === 0) {\n          console.log(`Progress: ${updated} records updated...`);\n        }\n      } catch (error) {\n        console.error(`Error processing record ${record.id}:`, error);\n        errors++;\n      }\n    }\n\n    console.log(\"\\nMigration complete!\");\n    console.log(`- Updated: ${updated} records`);\n    console.log(`- Skipped: ${skipped} records`);\n    console.log(`- Errors: ${errors} records`);\n\n    return { updated, skipped, errors };\n  } catch (error) {\n    console.error(\"Migration failed:\", error);\n    throw error;\n  }\n}\n\nexport { migrateDepartureLocations };\n\n// Run migration if executed directly\nmigrateDepartureLocations()\n  .then(() => {\n    console.log(\"Migration script completed successfully\");\n    process.exit(0);\n  })\n  .catch((error) => {\n    console.error(\"Migration script failed:\", error);\n    process.exit(1);\n  });\n","path":null,"size_bytes":2961,"size_tokens":null},"server/objectStorage.ts":{"content":"// Replit Object Storage service for file uploads\n// Reference: javascript_object_storage blueprint\n\nimport { Storage, File } from \"@google-cloud/storage\";\nimport { Response } from \"express\";\nimport { randomUUID } from \"crypto\";\nimport {\n  ObjectAclPolicy,\n  ObjectPermission,\n  canAccessObject,\n  getObjectAclPolicy,\n  setObjectAclPolicy,\n} from \"./objectAcl\";\n\nconst REPLIT_SIDECAR_ENDPOINT = \"http://127.0.0.1:1106\";\n\n// The object storage client is used to interact with the object storage service.\nexport const objectStorageClient = new Storage({\n  credentials: {\n    audience: \"replit\",\n    subject_token_type: \"access_token\",\n    token_url: `${REPLIT_SIDECAR_ENDPOINT}/token`,\n    type: \"external_account\",\n    credential_source: {\n      url: `${REPLIT_SIDECAR_ENDPOINT}/credential`,\n      format: {\n        type: \"json\",\n        subject_token_field_name: \"access_token\",\n      },\n    },\n    universe_domain: \"googleapis.com\",\n  },\n  projectId: \"\",\n});\n\nexport class ObjectNotFoundError extends Error {\n  constructor() {\n    super(\"Object not found\");\n    this.name = \"ObjectNotFoundError\";\n    Object.setPrototypeOf(this, ObjectNotFoundError.prototype);\n  }\n}\n\n// The object storage service is used to interact with the object storage service.\nexport class ObjectStorageService {\n  constructor() {}\n\n  // Gets the public object search paths.\n  getPublicObjectSearchPaths(): Array<string> {\n    const pathsStr = process.env.PUBLIC_OBJECT_SEARCH_PATHS || \"\";\n    const paths = Array.from(\n      new Set(\n        pathsStr\n          .split(\",\")\n          .map((path) => path.trim())\n          .filter((path) => path.length > 0)\n      )\n    );\n    if (paths.length === 0) {\n      throw new Error(\n        \"PUBLIC_OBJECT_SEARCH_PATHS not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PUBLIC_OBJECT_SEARCH_PATHS env var (comma-separated paths).\"\n      );\n    }\n    return paths;\n  }\n\n  // Gets the private object directory.\n  getPrivateObjectDir(): string {\n    const dir = process.env.PRIVATE_OBJECT_DIR || \"\";\n    if (!dir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n    return dir;\n  }\n\n  // Search for a public object from the search paths.\n  async searchPublicObject(filePath: string): Promise<File | null> {\n    for (const searchPath of this.getPublicObjectSearchPaths()) {\n      const fullPath = `${searchPath}/${filePath}`;\n\n      // Full path format: /<bucket_name>/<object_name>\n      const { bucketName, objectName } = parseObjectPath(fullPath);\n      const bucket = objectStorageClient.bucket(bucketName);\n      const file = bucket.file(objectName);\n\n      // Check if file exists\n      const [exists] = await file.exists();\n      if (exists) {\n        return file;\n      }\n    }\n\n    return null;\n  }\n\n  // Downloads an object to the response.\n  async downloadObject(file: File, res: Response, cacheTtlSec: number = 3600) {\n    try {\n      // Get file metadata\n      const [metadata] = await file.getMetadata();\n      // Get the ACL policy for the object.\n      const aclPolicy = await getObjectAclPolicy(file);\n      const isPublic = aclPolicy?.visibility === \"public\";\n      // Set appropriate headers\n      res.set({\n        \"Content-Type\": metadata.contentType || \"application/octet-stream\",\n        \"Content-Length\": metadata.size,\n        \"Cache-Control\": `${\n          isPublic ? \"public\" : \"private\"\n        }, max-age=${cacheTtlSec}`,\n      });\n\n      // Stream the file to the response\n      const stream = file.createReadStream();\n\n      stream.on(\"error\", (err) => {\n        console.error(\"Stream error:\", err);\n        if (!res.headersSent) {\n          res.status(500).json({ error: \"Error streaming file\" });\n        }\n      });\n\n      stream.pipe(res);\n    } catch (error) {\n      console.error(\"Error downloading file:\", error);\n      if (!res.headersSent) {\n        res.status(500).json({ error: \"Error downloading file\" });\n      }\n    }\n  }\n\n  // Gets the upload URL for an object entity.\n  async getObjectEntityUploadURL(): Promise<string> {\n    const privateObjectDir = this.getPrivateObjectDir();\n    if (!privateObjectDir) {\n      throw new Error(\n        \"PRIVATE_OBJECT_DIR not set. Create a bucket in 'Object Storage' \" +\n          \"tool and set PRIVATE_OBJECT_DIR env var.\"\n      );\n    }\n\n    const objectId = randomUUID();\n    const fullPath = `${privateObjectDir}/uploads/${objectId}`;\n\n    const { bucketName, objectName } = parseObjectPath(fullPath);\n\n    // Sign URL for PUT method with TTL\n    return signObjectURL({\n      bucketName,\n      objectName,\n      method: \"PUT\",\n      ttlSec: 900,\n    });\n  }\n\n  // Gets the object entity file from the object path.\n  async getObjectEntityFile(objectPath: string): Promise<File> {\n    if (!objectPath.startsWith(\"/objects/\")) {\n      throw new ObjectNotFoundError();\n    }\n\n    const parts = objectPath.slice(1).split(\"/\");\n    if (parts.length < 2) {\n      throw new ObjectNotFoundError();\n    }\n\n    const entityId = parts.slice(1).join(\"/\");\n    let entityDir = this.getPrivateObjectDir();\n    if (!entityDir.endsWith(\"/\")) {\n      entityDir = `${entityDir}/`;\n    }\n    const objectEntityPath = `${entityDir}${entityId}`;\n    const { bucketName, objectName } = parseObjectPath(objectEntityPath);\n    const bucket = objectStorageClient.bucket(bucketName);\n    const objectFile = bucket.file(objectName);\n    const [exists] = await objectFile.exists();\n    if (!exists) {\n      throw new ObjectNotFoundError();\n    }\n    return objectFile;\n  }\n\n  normalizeObjectEntityPath(rawPath: string): string {\n    if (!rawPath.startsWith(\"https://storage.googleapis.com/\")) {\n      return rawPath;\n    }\n\n    // Extract the path from the URL by removing query parameters and domain\n    const url = new URL(rawPath);\n    const rawObjectPath = url.pathname;\n\n    let objectEntityDir = this.getPrivateObjectDir();\n    if (!objectEntityDir.endsWith(\"/\")) {\n      objectEntityDir = `${objectEntityDir}/`;\n    }\n\n    if (!rawObjectPath.startsWith(objectEntityDir)) {\n      return rawObjectPath;\n    }\n\n    // Extract the entity ID from the path\n    const entityId = rawObjectPath.slice(objectEntityDir.length);\n    return `/objects/${entityId}`;\n  }\n\n  // Tries to set the ACL policy for the object entity and return the normalized path.\n  async trySetObjectEntityAclPolicy(\n    rawPath: string,\n    aclPolicy: ObjectAclPolicy\n  ): Promise<string> {\n    const normalizedPath = this.normalizeObjectEntityPath(rawPath);\n    if (!normalizedPath.startsWith(\"/\")) {\n      return normalizedPath;\n    }\n\n    const objectFile = await this.getObjectEntityFile(normalizedPath);\n    await setObjectAclPolicy(objectFile, aclPolicy);\n    return normalizedPath;\n  }\n\n  // Checks if the user can access the object entity.\n  async canAccessObjectEntity({\n    userId,\n    objectFile,\n    requestedPermission,\n  }: {\n    userId?: string;\n    objectFile: File;\n    requestedPermission?: ObjectPermission;\n  }): Promise<boolean> {\n    return canAccessObject({\n      userId,\n      objectFile,\n      requestedPermission: requestedPermission ?? ObjectPermission.READ,\n    });\n  }\n}\n\nexport function parseObjectPath(path: string): {\n  bucketName: string;\n  objectName: string;\n} {\n  if (!path.startsWith(\"/\")) {\n    path = `/${path}`;\n  }\n  const pathParts = path.split(\"/\");\n  if (pathParts.length < 3) {\n    throw new Error(\"Invalid path: must contain at least a bucket name\");\n  }\n\n  const bucketName = pathParts[1];\n  const objectName = pathParts.slice(2).join(\"/\");\n\n  return {\n    bucketName,\n    objectName,\n  };\n}\n\nasync function signObjectURL({\n  bucketName,\n  objectName,\n  method,\n  ttlSec,\n}: {\n  bucketName: string;\n  objectName: string;\n  method: \"GET\" | \"PUT\" | \"DELETE\" | \"HEAD\";\n  ttlSec: number;\n}): Promise<string> {\n  const request = {\n    bucket_name: bucketName,\n    object_name: objectName,\n    method,\n    expires_at: new Date(Date.now() + ttlSec * 1000).toISOString(),\n  };\n  const response = await fetch(\n    `${REPLIT_SIDECAR_ENDPOINT}/object-storage/signed-object-url`,\n    {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify(request),\n    }\n  );\n  if (!response.ok) {\n    throw new Error(\n      `Failed to sign object URL, errorcode: ${response.status}, ` +\n        `make sure you're running on Replit`\n    );\n  }\n\n  const { signed_url: signedURL } = await response.json();\n  return signedURL;\n}\n","path":null,"size_bytes":8499,"size_tokens":null},"server/objectAcl.ts":{"content":"// Object storage ACL (Access Control List) management\n// Reference: javascript_object_storage blueprint\n\nimport { File } from \"@google-cloud/storage\";\n\nconst ACL_POLICY_METADATA_KEY = \"custom:aclPolicy\";\n\n// The type of the access group.\nexport enum ObjectAccessGroupType {\n  // Can be extended based on use case needs\n  USER_LIST = \"USER_LIST\",\n  EMAIL_DOMAIN = \"EMAIL_DOMAIN\",\n  COMPANY_MEMBER = \"COMPANY_MEMBER\",\n  SESSION_PARTICIPANT = \"SESSION_PARTICIPANT\",\n}\n\n// The logic user group that can access the object.\nexport interface ObjectAccessGroup {\n  type: ObjectAccessGroupType;\n  id: string; // Group identifier (user list ID, email domain, company ID, etc.)\n}\n\nexport enum ObjectPermission {\n  READ = \"read\",\n  WRITE = \"write\",\n}\n\nexport interface ObjectAclRule {\n  group: ObjectAccessGroup;\n  permission: ObjectPermission;\n}\n\n// The ACL policy of the object.\nexport interface ObjectAclPolicy {\n  owner: string;\n  visibility: \"public\" | \"private\";\n  aclRules?: Array<ObjectAclRule>;\n}\n\n// Check if the requested permission is allowed based on the granted permission.\nfunction isPermissionAllowed(\n  requested: ObjectPermission,\n  granted: ObjectPermission,\n): boolean {\n  // Users granted with read or write permissions can read the object.\n  if (requested === ObjectPermission.READ) {\n    return [ObjectPermission.READ, ObjectPermission.WRITE].includes(granted);\n  }\n\n  // Only users granted with write permissions can write the object.\n  return granted === ObjectPermission.WRITE;\n}\n\n// The base class for all access groups.\nabstract class BaseObjectAccessGroup implements ObjectAccessGroup {\n  constructor(\n    public readonly type: ObjectAccessGroupType,\n    public readonly id: string,\n  ) {}\n\n  // Check if the user is a member of the group.\n  public abstract hasMember(userId: string): Promise<boolean>;\n}\n\n// Implement specific access group types as needed\nclass CompanyMemberAccessGroup extends BaseObjectAccessGroup {\n  async hasMember(userId: string): Promise<boolean> {\n    // TODO: Implement company membership check\n    // This would query the users table to check if user.companyId matches this.id\n    return false;\n  }\n}\n\nclass SessionParticipantAccessGroup extends BaseObjectAccessGroup {\n  async hasMember(userId: string): Promise<boolean> {\n    // TODO: Implement session participation check\n    // This would query user_sessions table to check if user has access to the session\n    return false;\n  }\n}\n\nfunction createObjectAccessGroup(\n  group: ObjectAccessGroup,\n): BaseObjectAccessGroup {\n  switch (group.type) {\n    case ObjectAccessGroupType.COMPANY_MEMBER:\n      return new CompanyMemberAccessGroup(group.type, group.id);\n    case ObjectAccessGroupType.SESSION_PARTICIPANT:\n      return new SessionParticipantAccessGroup(group.type, group.id);\n    default:\n      throw new Error(`Unknown access group type: ${group.type}`);\n  }\n}\n\n// Sets the ACL policy to the object metadata.\nexport async function setObjectAclPolicy(\n  objectFile: File,\n  aclPolicy: ObjectAclPolicy,\n): Promise<void> {\n  const [exists] = await objectFile.exists();\n  if (!exists) {\n    throw new Error(`Object not found: ${objectFile.name}`);\n  }\n\n  await objectFile.setMetadata({\n    metadata: {\n      [ACL_POLICY_METADATA_KEY]: JSON.stringify(aclPolicy),\n    },\n  });\n}\n\n// Gets the ACL policy from the object metadata.\nexport async function getObjectAclPolicy(\n  objectFile: File,\n): Promise<ObjectAclPolicy | null> {\n  const [metadata] = await objectFile.getMetadata();\n  const aclPolicy = metadata?.metadata?.[ACL_POLICY_METADATA_KEY];\n  if (!aclPolicy) {\n    return null;\n  }\n  return JSON.parse(aclPolicy as string);\n}\n\n// Checks if the user can access the object.\nexport async function canAccessObject({\n  userId,\n  objectFile,\n  requestedPermission,\n}: {\n  userId?: string;\n  objectFile: File;\n  requestedPermission: ObjectPermission;\n}): Promise<boolean> {\n  // When this function is called, the acl policy is required.\n  const aclPolicy = await getObjectAclPolicy(objectFile);\n  if (!aclPolicy) {\n    return false;\n  }\n\n  // Public objects are always accessible for read.\n  if (\n    aclPolicy.visibility === \"public\" &&\n    requestedPermission === ObjectPermission.READ\n  ) {\n    return true;\n  }\n\n  // Access control requires the user id.\n  if (!userId) {\n    return false;\n  }\n\n  // The owner of the object can always access it.\n  if (aclPolicy.owner === userId) {\n    return true;\n  }\n\n  // Go through the ACL rules to check if the user has the required permission.\n  for (const rule of aclPolicy.aclRules || []) {\n    const accessGroup = createObjectAccessGroup(rule.group);\n    if (\n      (await accessGroup.hasMember(userId)) &&\n      isPermissionAllowed(requestedPermission, rule.permission)\n    ) {\n      return true;\n    }\n  }\n\n  return false;\n}\n","path":null,"size_bytes":4772,"size_tokens":null},"server/replitAuth.ts":{"content":"// Replit Auth integration for OpenID Connect authentication\n// Reference: javascript_log_in_with_replit blueprint\n\nimport * as client from \"openid-client\";\nimport { Strategy, type VerifyFunction } from \"openid-client/passport\";\nimport passport from \"passport\";\nimport session from \"express-session\";\nimport type { Express, RequestHandler } from \"express\";\nimport memoize from \"memoizee\";\nimport connectPg from \"connect-pg-simple\";\nimport { storage } from \"./storage\";\n\nconst getOidcConfig = memoize(\n  async () => {\n    return await client.discovery(\n      new URL(process.env.ISSUER_URL ?? \"https://replit.com/oidc\"),\n      process.env.REPL_ID!\n    );\n  },\n  { maxAge: 3600 * 1000 }\n);\n\nexport function getSession() {\n  const sessionTtl = 7 * 24 * 60 * 60 * 1000; // 1 week\n  const pgStore = connectPg(session);\n  const sessionStore = new pgStore({\n    conString: process.env.DATABASE_URL,\n    createTableIfMissing: false,\n    ttl: sessionTtl,\n    tableName: \"sessions\",\n  });\n  \n  // Use secure cookies only in production (HTTPS)\n  const isProduction = process.env.NODE_ENV === 'production';\n  \n  return session({\n    secret: process.env.SESSION_SECRET!,\n    store: sessionStore,\n    resave: false,\n    saveUninitialized: false,\n    cookie: {\n      httpOnly: true,\n      secure: isProduction,\n      sameSite: 'lax',\n      maxAge: sessionTtl,\n    },\n  });\n}\n\nfunction updateUserSession(\n  user: any,\n  tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers\n) {\n  user.claims = tokens.claims();\n  user.access_token = tokens.access_token;\n  user.refresh_token = tokens.refresh_token;\n  user.expires_at = user.claims?.exp;\n}\n\nasync function upsertUser(claims: any) {\n  await storage.upsertUser({\n    id: claims[\"sub\"],\n    email: claims[\"email\"],\n    firstName: claims[\"first_name\"],\n    lastName: claims[\"last_name\"],\n    profileImageUrl: claims[\"profile_image_url\"],\n  });\n}\n\nexport async function setupAuth(app: Express) {\n  app.set(\"trust proxy\", 1);\n  app.use(getSession());\n  app.use(passport.initialize());\n  app.use(passport.session());\n\n  const config = await getOidcConfig();\n\n  const verify: VerifyFunction = async (\n    tokens: client.TokenEndpointResponse & client.TokenEndpointResponseHelpers,\n    verified: passport.AuthenticateCallback\n  ) => {\n    const user = {};\n    updateUserSession(user, tokens);\n    await upsertUser(tokens.claims());\n    verified(null, user);\n  };\n\n  // Keep track of registered strategies\n  const registeredStrategies = new Set<string>();\n\n  // Helper function to ensure strategy exists for a domain\n  const ensureStrategy = (domain: string) => {\n    const strategyName = `replitauth:${domain}`;\n    if (!registeredStrategies.has(strategyName)) {\n      const strategy = new Strategy(\n        {\n          name: strategyName,\n          config,\n          scope: \"openid email profile offline_access\",\n          callbackURL: `https://${domain}/api/callback`,\n        },\n        verify,\n      );\n      passport.use(strategy);\n      registeredStrategies.add(strategyName);\n    }\n  };\n\n  passport.serializeUser((user: Express.User, cb) => cb(null, user));\n  passport.deserializeUser((user: Express.User, cb) => cb(null, user));\n\n  app.get(\"/api/login\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      prompt: \"login consent\",\n      scope: [\"openid\", \"email\", \"profile\", \"offline_access\"],\n    })(req, res, next);\n  });\n\n  app.get(\"/api/callback\", (req, res, next) => {\n    ensureStrategy(req.hostname);\n    passport.authenticate(`replitauth:${req.hostname}`, {\n      successReturnToOrRedirect: \"/\",\n      failureRedirect: \"/api/login\",\n    })(req, res, next);\n  });\n\n  app.get(\"/api/logout\", (req, res) => {\n    req.logout(() => {\n      res.redirect(\n        client.buildEndSessionUrl(config, {\n          client_id: process.env.REPL_ID!,\n          post_logout_redirect_uri: `${req.protocol}://${req.hostname}`,\n        }).href\n      );\n    });\n  });\n}\n\nexport const isAuthenticated: RequestHandler = async (req, res, next) => {\n  const user = req.user as any;\n\n  if (!req.isAuthenticated() || !user.expires_at) {\n    return res.status(401).json({ message: \"Unauthorized\" });\n  }\n\n  const now = Math.floor(Date.now() / 1000);\n  if (now <= user.expires_at) {\n    return next();\n  }\n\n  const refreshToken = user.refresh_token;\n  if (!refreshToken) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n\n  try {\n    const config = await getOidcConfig();\n    const tokenResponse = await client.refreshTokenGrant(config, refreshToken);\n    updateUserSession(user, tokenResponse);\n    return next();\n  } catch (error) {\n    res.status(401).json({ message: \"Unauthorized\" });\n    return;\n  }\n};\n","path":null,"size_bytes":4732,"size_tokens":null},"server/services/auditLog.ts":{"content":"// Audit logging service for tracking all system activities\nimport { db } from \"../db\";\nimport { auditLogs, type InsertAuditLog } from \"@shared/schema\";\n\nexport type AuditAction = \n  // Company actions\n  | 'company.create' | 'company.update' | 'company.delete'\n  // Session actions\n  | 'session.create' | 'session.update' | 'session.close' | 'session.add_contractor' | 'session.remove_contractor'\n  // Roster actions\n  | 'roster.create' | 'roster.update' | 'roster.delete' | 'roster.submit' | 'roster.approve' | 'roster.reject'\n  // Crew actions\n  | 'crew.create' | 'crew.update' | 'crew.delete'\n  // Timesheet actions\n  | 'timesheet.create' | 'timesheet.update' | 'timesheet.submit' | 'timesheet.approve' | 'timesheet.reject'\n  // Expense actions\n  | 'expense.create' | 'expense.update' | 'expense.delete' | 'expense.submit' | 'expense.approve' | 'expense.reject'\n  // Invoice actions\n  | 'invoice.create' | 'invoice.update' | 'invoice.send' | 'invoice.pay' | 'invoice.void'\n  // User actions\n  | 'user.login' | 'user.logout' | 'user.update_role' | 'user.assign_company'\n  // Auth actions\n  | 'auth.login' | 'auth.logout' | 'auth.failed_login';\n\nexport interface AuditContext {\n  userId?: string;\n  userEmail?: string;\n  ipAddress?: string;\n  userAgent?: string;\n}\n\n/**\n * Create an audit log entry\n */\nexport async function createAuditLog(params: {\n  action: AuditAction;\n  entityType: string;\n  entityId?: string;\n  details?: Record<string, any>;\n  context: AuditContext;\n}): Promise<void> {\n  try {\n    const auditEntry: InsertAuditLog = {\n      userId: params.context.userId || null,\n      action: params.action,\n      entityType: params.entityType,\n      entityId: params.entityId || null,\n      changes: params.details ? JSON.stringify(params.details) : null,\n      ipAddress: params.context.ipAddress || null,\n      userAgent: params.context.userAgent || null,\n    };\n\n    await db.insert(auditLogs).values(auditEntry);\n  } catch (error) {\n    // Log audit errors but don't throw - audit failures shouldn't break operations\n    console.error('Failed to create audit log:', error);\n  }\n}\n\n/**\n * Get audit context from Express request\n */\nexport function getAuditContext(req: any): AuditContext {\n  return {\n    userId: req.authenticatedUser?.id,\n    userEmail: req.authenticatedUser?.email || undefined,\n    ipAddress: req.ip || req.connection?.remoteAddress,\n    userAgent: req.get('user-agent'),\n  };\n}\n\n/**\n * Audit decorator for tracking changes\n */\nexport function auditAction(\n  action: AuditAction,\n  entityType: string,\n  getEntityId?: (result: any) => string\n) {\n  return function (\n    target: any,\n    propertyKey: string,\n    descriptor: PropertyDescriptor\n  ) {\n    const originalMethod = descriptor.value;\n\n    descriptor.value = async function (...args: any[]) {\n      const result = await originalMethod.apply(this, args);\n      \n      const req = args.find((arg: any) => arg?.authenticatedUser);\n      if (req) {\n        const entityId = getEntityId ? getEntityId(result) : undefined;\n        await createAuditLog({\n          action,\n          entityType,\n          entityId,\n          context: getAuditContext(req),\n        });\n      }\n\n      return result;\n    };\n\n    return descriptor;\n  };\n}\n\n/**\n * Log authentication events\n */\nexport async function logAuthEvent(params: {\n  action: 'auth.login' | 'auth.logout' | 'auth.failed_login';\n  userId?: string;\n  userEmail?: string;\n  ipAddress?: string;\n  userAgent?: string;\n  details?: Record<string, any>;\n}): Promise<void> {\n  await createAuditLog({\n    action: params.action,\n    entityType: 'auth',\n    details: params.details,\n    context: {\n      userId: params.userId,\n      userEmail: params.userEmail,\n      ipAddress: params.ipAddress,\n      userAgent: params.userAgent,\n    },\n  });\n}\n\n/**\n * Query audit logs with filters\n */\nexport async function getAuditLogs(filters?: {\n  userId?: string;\n  action?: AuditAction;\n  entityType?: string;\n  entityId?: string;\n  startDate?: Date;\n  endDate?: Date;\n  limit?: number;\n}) {\n  // TODO: Implement when needed\n  // This would use Drizzle queries to filter audit logs\n  return [];\n}\n","path":null,"size_bytes":4116,"size_tokens":null},"server/middleware/rbac.ts":{"content":"// Role-Based Access Control (RBAC) middleware\nimport type { RequestHandler } from \"express\";\nimport { storage } from \"../storage\";\n\nexport type UserRole = 'ADMIN' | 'CONTRACTOR' | 'MANAGER' | 'UTILITY';\n\n// Extend Express Request to include authenticated user\ndeclare global {\n  namespace Express {\n    interface Request {\n      authenticatedUser?: {\n        id: string;\n        email: string | null;\n        role: UserRole | null;\n        companyId: string | null;\n        firstName: string | null;\n        lastName: string | null;\n      };\n    }\n  }\n}\n\n/**\n * Middleware to require authentication and attach user to request\n */\nexport const requireAuth: RequestHandler = async (req, res, next) => {\n  if (!req.isAuthenticated()) {\n    return res.status(401).json({ message: \"Authentication required\" });\n  }\n\n  const userClaims = (req.user as any)?.claims;\n  if (!userClaims?.sub) {\n    return res.status(401).json({ message: \"No user session\" });\n  }\n\n  // Get user from database\n  const user = await storage.getUser(userClaims.sub);\n  if (!user) {\n    return res.status(404).json({ message: \"User not found\" });\n  }\n\n  // Attach user to request\n  req.authenticatedUser = {\n    id: user.id,\n    email: user.email,\n    role: user.role as UserRole | null,\n    companyId: user.companyId,\n    firstName: user.firstName,\n    lastName: user.lastName,\n  };\n\n  next();\n};\n\n/**\n * Middleware to require specific role(s)\n */\nexport function requireRole(...allowedRoles: UserRole[]): RequestHandler {\n  return async (req, res, next) => {\n    // First ensure user is authenticated\n    if (!req.authenticatedUser) {\n      return res.status(401).json({ message: \"Authentication required\" });\n    }\n\n    const userRole = req.authenticatedUser.role;\n    \n    if (!userRole) {\n      return res.status(403).json({ \n        message: \"User has no assigned role. Contact your administrator.\" \n      });\n    }\n\n    if (!allowedRoles.includes(userRole)) {\n      return res.status(403).json({ \n        message: `Access denied. Required role: ${allowedRoles.join(' or ')}` \n      });\n    }\n\n    next();\n  };\n}\n\n/**\n * Middleware to require company membership\n * Ensures user belongs to a company\n */\nexport const requireCompany: RequestHandler = async (req, res, next) => {\n  if (!req.authenticatedUser) {\n    return res.status(401).json({ message: \"Authentication required\" });\n  }\n\n  if (!req.authenticatedUser.companyId) {\n    return res.status(403).json({ \n      message: \"Company membership required. Contact your administrator.\" \n    });\n  }\n\n  next();\n};\n\n/**\n * Middleware to check if user has access to a specific company\n * Used for company-scoped operations\n * \n * Access rules:\n * - ADMIN: NO access to company data (user management only)\n * - MANAGER: Full access to all companies\n * - CONTRACTOR: Access only to own company (companyId match)\n * - UTILITY: Access only to companies granted via userCompanyAccess table\n */\nexport function requireCompanyAccess(getCompanyId: (req: any) => string | null): RequestHandler {\n  return async (req, res, next) => {\n    if (!req.authenticatedUser) {\n      return res.status(401).json({ message: \"Authentication required\" });\n    }\n\n    const targetCompanyId = getCompanyId(req);\n    \n    // Short-circuit if no target company resolved\n    if (!targetCompanyId) {\n      return res.status(400).json({ message: \"Company ID required\" });\n    }\n\n    const userRole = req.authenticatedUser.role;\n\n    // ADMIN has NO access to company data\n    if (userRole === 'ADMIN') {\n      return res.status(403).json({ \n        message: \"Access denied. ADMIN role can only manage users, not company data.\" \n      });\n    }\n\n    // MANAGER has full access to all companies\n    if (userRole === 'MANAGER') {\n      return next();\n    }\n\n    // CONTRACTOR can only access own company\n    if (userRole === 'CONTRACTOR') {\n      if (req.authenticatedUser.companyId !== targetCompanyId) {\n        return res.status(403).json({ \n          message: \"Access denied. You can only access your own company's data.\" \n        });\n      }\n      return next();\n    }\n\n    // UTILITY can only access granted companies (requires DB lookup)\n    if (userRole === 'UTILITY') {\n      try {\n        const hasAccess = await storage.hasUtilityCompanyAccess(\n          req.authenticatedUser.id,\n          targetCompanyId\n        );\n        \n        if (!hasAccess) {\n          return res.status(403).json({ \n            message: \"Access denied. You don't have permission to access this company's data.\" \n          });\n        }\n        \n        return next();\n      } catch (error) {\n        console.error('Error checking UTILITY company access:', error);\n        return res.status(500).json({ \n          message: \"Error verifying company access\" \n        });\n      }\n    }\n\n    // Shouldn't reach here, but deny by default\n    return res.status(403).json({ message: \"Access denied\" });\n  };\n}\n\n/**\n * Helper to check if user is ADMIN (user management only)\n */\nexport const requireAdminRole: RequestHandler = (req, res, next) => {\n  return requireRole('ADMIN')(req, res, next);\n};\n\n/**\n * Helper to check if user is MANAGER (full system access)\n */\nexport const requireManager: RequestHandler = (req, res, next) => {\n  return requireRole('MANAGER')(req, res, next);\n};\n\n/**\n * Helper to check if user is MANAGER or UTILITY (broad access roles)\n */\nexport const requireManagerOrUtility: RequestHandler = (req, res, next) => {\n  return requireRole('MANAGER', 'UTILITY')(req, res, next);\n};\n\n/**\n * Helper to check if user is UTILITY (for utility-specific operations)\n */\nexport const requireUtility: RequestHandler = (req, res, next) => {\n  return requireRole('UTILITY')(req, res, next);\n};\n\n/**\n * Helper to check if user is ADMIN or MANAGER (for storm session management)\n */\nexport const requireAdminOrManager: RequestHandler = (req, res, next) => {\n  return requireRole('ADMIN', 'MANAGER')(req, res, next);\n};\n","path":null,"size_bytes":5902,"size_tokens":null},"client/src/pages/timesheets.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { Link, useLocation } from 'wouter';\nimport { ArrowLeft, Eye, Plus } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Badge } from '@/components/ui/badge';\nimport { useAuth } from '@/context/AuthContext';\nimport { useActiveSession } from '@/context/ActiveSessionContext';\nimport { useToast } from '@/hooks/use-toast';\nimport { apiRequest, queryClient } from '@/lib/queryClient';\nimport type { Timesheet, StormSession, Company, Crew, Roster } from '@shared/schema';\n\nexport default function TimesheetsPage() {\n  const { user } = useAuth();\n  const { activeSession } = useActiveSession();\n  const { toast } = useToast();\n  const [, navigate] = useLocation();\n  const [selectedSessionId, setSelectedSessionId] = useState<string>('');\n  const [hasUserSelectedSession, setHasUserSelectedSession] = useState(false);\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [selectedRosterId, setSelectedRosterId] = useState<string>('');\n  const [selectedCrewId, setSelectedCrewId] = useState<string>('');\n  const [selectedDate, setSelectedDate] = useState<string>(new Date().toISOString().split('T')[0]);\n  const [startTime, setStartTime] = useState<string>('07:00');\n  const [stopTime, setStopTime] = useState<string>('17:00');\n\n  const canManage = user?.role === 'ADMIN' || user?.role === 'MANAGER' || user?.role === 'UTILITY';\n\n  const { data: sessions } = useQuery<StormSession[]>({\n    queryKey: ['/api/storm-sessions'],\n  });\n\n  const { data: companies } = useQuery<Company[]>({\n    queryKey: ['/api/companies'],\n    enabled: canManage,\n  });\n\n  const { data: timesheets = [], isLoading: timesheetsLoading } = useQuery<Timesheet[]>({\n    queryKey: ['/api/timesheets', selectedSessionId],\n    queryFn: async () => {\n      if (!selectedSessionId) return [];\n      const response = await fetch(`/api/timesheets?sessionId=${selectedSessionId}`);\n      if (!response.ok) throw new Error('Failed to fetch timesheets');\n      return response.json();\n    },\n    enabled: !!selectedSessionId,\n  });\n\n  const { data: rosters = [] } = useQuery<Roster[]>({\n    queryKey: ['/api/rosters', selectedSessionId],\n    queryFn: async () => {\n      if (!selectedSessionId) return [];\n      const response = await fetch(`/api/rosters?sessionId=${selectedSessionId}`);\n      if (!response.ok) throw new Error('Failed to fetch rosters');\n      return response.json();\n    },\n    enabled: !!selectedSessionId,\n  });\n\n  // Fetch crews for selected roster\n  const { data: crews = [] } = useQuery<Crew[]>({\n    queryKey: ['/api/rosters', selectedRosterId, 'crews'],\n    queryFn: async () => {\n      if (!selectedRosterId) return [];\n      const response = await fetch(`/api/rosters/${selectedRosterId}/crews`);\n      if (!response.ok) throw new Error('Failed to fetch crews');\n      return response.json();\n    },\n    enabled: !!selectedRosterId && isCreateDialogOpen,\n  });\n\n  // Auto-select active session (or first session as fallback) - only if user hasn't manually selected\n  useEffect(() => {\n    if (sessions && sessions.length > 0 && !hasUserSelectedSession) {\n      if (!selectedSessionId) {\n        // Initial selection: prefer active session\n        if (activeSession && sessions.some(s => s.id === activeSession.id)) {\n          setSelectedSessionId(activeSession.id);\n        } else {\n          setSelectedSessionId(sessions[0].id);\n        }\n      } else if (activeSession && sessions.some(s => s.id === activeSession.id) && selectedSessionId !== activeSession.id) {\n        // Active session became available - switch to it\n        setSelectedSessionId(activeSession.id);\n      }\n    }\n  }, [sessions, selectedSessionId, activeSession, hasUserSelectedSession]);\n\n  // Group timesheets by company\n  const timesheetsByCompany = timesheets.reduce((acc, timesheet) => {\n    if (!acc[timesheet.companyId]) {\n      acc[timesheet.companyId] = [];\n    }\n    acc[timesheet.companyId].push(timesheet);\n    return acc;\n  }, {} as Record<string, Timesheet[]>);\n\n  const getStatusBadge = (status: string) => {\n    const variants: Record<string, 'default' | 'secondary' | 'outline'> = {\n      DRAFT: 'secondary',\n      SUBMITTED: 'outline',\n      APPROVED: 'default',\n      SIGNED: 'default',\n    };\n    return <Badge variant={variants[status] || 'secondary'}>{status}</Badge>;\n  };\n\n  const getCompanyName = (companyId: string) => {\n    const company = companies?.find((c) => c.id === companyId);\n    return company?.name || 'Unknown Company';\n  };\n\n  const createTimesheetMutation = useMutation({\n    mutationFn: async (data: { rosterId: string; crewId: string; date: string; startTime?: string; stopTime?: string }) => {\n      const response = await apiRequest('POST', '/api/timesheets/from-roster', data);\n      return response.json();\n    },\n    onSuccess: (newTimesheet: any) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/timesheets', selectedSessionId] });\n      toast({ title: 'Timesheet created successfully', description: 'Personnel and equipment auto-populated from roster' });\n      setIsCreateDialogOpen(false);\n      navigate(`/timesheets/${newTimesheet.id}`);\n    },\n    onError: (error: any) => {\n      toast({\n        title: 'Failed to create timesheet',\n        description: error.message || 'An error occurred',\n        variant: 'destructive',\n      });\n    },\n  });\n\n  const handleOpenCreateDialog = () => {\n    setSelectedRosterId('');\n    setSelectedCrewId('');\n    setSelectedDate(new Date().toISOString().split('T')[0]);\n    setStartTime('07:00');\n    setStopTime('17:00');\n    setIsCreateDialogOpen(true);\n  };\n\n  const handleCreateTimesheet = () => {\n    if (!selectedRosterId || !selectedCrewId || !selectedDate) {\n      toast({\n        title: 'Missing information',\n        description: 'Please select a roster, crew, and date',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    createTimesheetMutation.mutate({\n      rosterId: selectedRosterId,\n      crewId: selectedCrewId,\n      date: selectedDate,\n      startTime,\n      stopTime,\n    });\n  };\n\n  return (\n    <div className=\"min-h-screen bg-white dark:bg-gray-950\">\n      <div className=\"max-w-7xl mx-auto p-4 md:p-8 space-y-6\">\n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row items-start md:items-center justify-between gap-4\">\n          <div className=\"flex items-center gap-2\">\n            <Link href=\"/\">\n              <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-back\">\n                <ArrowLeft className=\"w-4 h-4\" />\n              </Button>\n            </Link>\n            <div>\n              <h1 className=\"text-2xl font-semibold text-gray-900 dark:text-gray-100\">Timesheets</h1>\n              <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                Daily crew timesheets with personnel and equipment tracking\n              </p>\n            </div>\n          </div>\n        </div>\n\n        {/* Session Selection */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Select Storm Session</CardTitle>\n            <CardDescription>Choose a session to view timesheets</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Select value={selectedSessionId} onValueChange={(value) => { setSelectedSessionId(value); setHasUserSelectedSession(true); }}>\n              <SelectTrigger data-testid=\"select-session\">\n                <SelectValue placeholder=\"Select a session...\" />\n              </SelectTrigger>\n              <SelectContent>\n                {sessions?.map((session) => (\n                  <SelectItem key={session.id} value={session.id}>\n                    {session.name} ({new Date(session.startDate).toLocaleDateString()})\n                    {activeSession?.id === session.id && ' ⭐ ACTIVE'}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </CardContent>\n        </Card>\n\n        {/* Timesheets List */}\n        {selectedSessionId && (\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle>Timesheets</CardTitle>\n                  <CardDescription>\n                    {timesheets.length} timesheet{timesheets.length !== 1 ? 's' : ''} for this session\n                  </CardDescription>\n                </div>\n                {canManage && (\n                  <Button onClick={handleOpenCreateDialog} data-testid=\"button-create-timesheet\">\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Create from Roster\n                  </Button>\n                )}\n              </div>\n            </CardHeader>\n            <CardContent>\n              {timesheetsLoading ? (\n                <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">Loading timesheets...</div>\n              ) : timesheets.length === 0 ? (\n                <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">\n                  No timesheets found for this session. Click \"Create from Roster\" to get started.\n                </div>\n              ) : (\n                <div className=\"space-y-6\">\n                  {Object.entries(timesheetsByCompany).map(([companyId, companyTimesheets]) => (\n                    <div key={companyId} className=\"border border-gray-200 dark:border-gray-800 rounded-lg\">\n                      <div className=\"bg-gray-50 dark:bg-gray-900 px-4 py-3 border-b border-gray-200 dark:border-gray-800\">\n                        <h3 className=\"font-semibold text-gray-900 dark:text-gray-100\">\n                          {getCompanyName(companyId)}\n                        </h3>\n                        <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                          {companyTimesheets.length} timesheet{companyTimesheets.length !== 1 ? 's' : ''}\n                        </p>\n                      </div>\n                      <div className=\"overflow-x-auto\">\n                        <Table>\n                          <TableHeader>\n                            <TableRow>\n                              <TableHead>Date</TableHead>\n                              <TableHead>Foreman Name</TableHead>\n                              <TableHead>Crew Number</TableHead>\n                              <TableHead>Project</TableHead>\n                              <TableHead>Status</TableHead>\n                              <TableHead>Actions</TableHead>\n                            </TableRow>\n                          </TableHeader>\n                          <TableBody>\n                            {companyTimesheets.map((timesheet) => (\n                              <TableRow key={timesheet.id} data-testid={`row-timesheet-${timesheet.id}`}>\n                                <TableCell className=\"font-medium\">\n                                  {new Date(timesheet.date).toLocaleDateString()}\n                                </TableCell>\n                                <TableCell>{timesheet.crewForeman || 'Unassigned'}</TableCell>\n                                <TableCell>{timesheet.crewIdNumber || '-'}</TableCell>\n                                <TableCell>{timesheet.projectName || '-'}</TableCell>\n                                <TableCell>{getStatusBadge(timesheet.status)}</TableCell>\n                                <TableCell>\n                                  <Link href={`/timesheets/${timesheet.id}`}>\n                                    <Button variant=\"ghost\" size=\"sm\" data-testid={`button-view-${timesheet.id}`}>\n                                      <Eye className=\"w-4 h-4 mr-1\" />\n                                      View\n                                    </Button>\n                                  </Link>\n                                </TableCell>\n                              </TableRow>\n                            ))}\n                          </TableBody>\n                        </Table>\n                      </div>\n                    </div>\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n      </div>\n\n      {/* Create Timesheet Dialog */}\n      <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n        <DialogContent data-testid=\"dialog-create-timesheet\">\n          <DialogHeader>\n            <DialogTitle>Create Timesheet from Roster</DialogTitle>\n            <DialogDescription>\n              Select a roster, crew, and date to create a timesheet with auto-populated personnel and equipment.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div>\n              <Label htmlFor=\"roster\">Roster</Label>\n              <Select value={selectedRosterId} onValueChange={setSelectedRosterId}>\n                <SelectTrigger id=\"roster\" data-testid=\"select-roster\">\n                  <SelectValue placeholder=\"Select a roster...\" />\n                </SelectTrigger>\n                <SelectContent>\n                  {rosters.map((roster) => {\n                    const company = companies?.find((c) => c.id === roster.companyId);\n                    return (\n                      <SelectItem key={roster.id} value={roster.id}>\n                        {company?.name || 'Unknown'} - Roster {roster.status}\n                      </SelectItem>\n                    );\n                  })}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label htmlFor=\"crew\">Crew</Label>\n              <Select\n                value={selectedCrewId}\n                onValueChange={setSelectedCrewId}\n                disabled={!selectedRosterId}\n              >\n                <SelectTrigger id=\"crew\" data-testid=\"select-crew\">\n                  <SelectValue placeholder={selectedRosterId ? \"Select a crew...\" : \"Select a roster first\"} />\n                </SelectTrigger>\n                <SelectContent>\n                  {crews.map((crew) => (\n                    <SelectItem key={crew.id} value={crew.id}>\n                      {crew.crewName || `Crew ${crew.id}`}\n                    </SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n            </div>\n            <div>\n              <Label htmlFor=\"date\">Date</Label>\n              <Input\n                id=\"date\"\n                type=\"date\"\n                value={selectedDate}\n                onChange={(e) => setSelectedDate(e.target.value)}\n                data-testid=\"input-date\"\n              />\n            </div>\n            <div className=\"grid grid-cols-2 gap-4\">\n              <div>\n                <Label htmlFor=\"start-time\">Start Time</Label>\n                <Input\n                  id=\"start-time\"\n                  type=\"time\"\n                  value={startTime}\n                  onChange={(e) => setStartTime(e.target.value)}\n                  data-testid=\"input-start-time\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"stop-time\">Stop Time</Label>\n                <Input\n                  id=\"stop-time\"\n                  type=\"time\"\n                  value={stopTime}\n                  onChange={(e) => setStopTime(e.target.value)}\n                  data-testid=\"input-stop-time\"\n                />\n              </div>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsCreateDialogOpen(false)} data-testid=\"button-cancel\">\n              Cancel\n            </Button>\n            <Button\n              onClick={handleCreateTimesheet}\n              disabled={!selectedRosterId || !selectedCrewId || !selectedDate || createTimesheetMutation.isPending}\n              data-testid=\"button-create\"\n            >\n              {createTimesheetMutation.isPending ? 'Creating...' : 'Create Timesheet'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":16578,"size_tokens":null},"client/src/pages/expenses.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { Link } from 'wouter';\nimport { ArrowLeft, Plus, Edit, Trash2, CheckCircle, XCircle, Upload, Download, FileText } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Textarea } from '@/components/ui/textarea';\nimport { useToast } from '@/hooks/use-toast';\nimport { useAuth } from '@/context/AuthContext';\nimport { useActiveSession } from '@/context/ActiveSessionContext';\nimport { getJson, postJson, patchJson, deleteJson, queryClient } from '@/lib/queryClient';\nimport type { Expense, InsertExpense, ExpenseFile, StormSession, Company } from '@shared/schema';\nimport { Badge } from '@/components/ui/badge';\n\nconst EXPENSE_CATEGORIES = [\n  'Fuel',\n  'Lodging',\n  'Meals',\n  'Equipment Rental',\n  'Vehicle Rental',\n  'Tools',\n  'Materials',\n  'Other'\n];\n\nexport default function ExpensesPage() {\n  const { user, logout } = useAuth();\n  const { activeSession } = useActiveSession();\n  const { toast } = useToast();\n  \n  const [selectedSessionId, setSelectedSessionId] = useState<string>('');\n  const [hasUserSelectedSession, setHasUserSelectedSession] = useState(false);\n  const [isCreateExpenseOpen, setIsCreateExpenseOpen] = useState(false);\n  const [isEditExpenseOpen, setIsEditExpenseOpen] = useState(false);\n  const [isDeleteExpenseOpen, setIsDeleteExpenseOpen] = useState(false);\n  const [isUploadFileOpen, setIsUploadFileOpen] = useState(false);\n  const [selectedExpense, setSelectedExpense] = useState<Expense | null>(null);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [expenseFormData, setExpenseFormData] = useState<Partial<InsertExpense>>({\n    sessionId: '',\n    companyId: '',\n    date: new Date(),\n    category: 'Fuel',\n    amountCents: 0,\n    currency: 'USD',\n    notes: '',\n    status: 'SUBMITTED',\n    submittedBy: '',\n  });\n\n  const resetExpenseForm = () => {\n    setExpenseFormData({\n      sessionId: selectedSessionId || '',\n      companyId: user?.companyId || '',\n      date: new Date(),\n      category: 'Fuel',\n      amountCents: 0,\n      currency: 'USD',\n      notes: '',\n      status: 'SUBMITTED',\n      submittedBy: user?.id || '',\n    });\n  };\n\n  const canManageExpenses = user?.role === 'ADMIN' || user?.role === 'MANAGER' || user?.role === 'CONTRACTOR' || user?.role === 'UTILITY';\n  const canApproveExpenses = user?.role === 'UTILITY';\n\n  // Fetch sessions\n  const { data: sessions } = useQuery<StormSession[]>({\n    queryKey: ['/api/storm-sessions'],\n  });\n\n  // Fetch companies (for UTILITY users)\n  const { data: companies, isLoading: companiesLoading } = useQuery<Company[]>({\n    queryKey: ['/api/companies'],\n    enabled: user?.role === 'UTILITY',\n  });\n\n  // Fetch expenses for selected session\n  const { data: expenses, isLoading: expensesLoading } = useQuery<Expense[]>({\n    queryKey: ['/api/expenses', selectedSessionId],\n    queryFn: () => selectedSessionId ? getJson<Expense[]>(`/api/expenses?sessionId=${selectedSessionId}`) : Promise.resolve([]),\n    enabled: !!selectedSessionId,\n  });\n\n  // Fetch files for an expense\n  const useExpenseFiles = (expenseId: string) => {\n    return useQuery<ExpenseFile[]>({\n      queryKey: ['/api/expenses', expenseId, 'files'],\n      queryFn: () => getJson<ExpenseFile[]>(`/api/expenses/${expenseId}/files`),\n      enabled: !!expenseId,\n    });\n  };\n\n  // Auto-select active session (or first session as fallback) - only if user hasn't manually selected\n  useEffect(() => {\n    if (sessions && sessions.length > 0 && !hasUserSelectedSession) {\n      if (!selectedSessionId) {\n        // Initial selection: prefer active session\n        if (activeSession && sessions.some(s => s.id === activeSession.id)) {\n          setSelectedSessionId(activeSession.id);\n        } else {\n          setSelectedSessionId(sessions[0].id);\n        }\n      } else if (activeSession && sessions.some(s => s.id === activeSession.id) && selectedSessionId !== activeSession.id) {\n        // Active session became available - switch to it\n        setSelectedSessionId(activeSession.id);\n      }\n    }\n  }, [sessions, selectedSessionId, activeSession, hasUserSelectedSession]);\n\n  // Create expense mutation\n  const createExpenseMutation = useMutation({\n    mutationFn: async (data: Partial<InsertExpense>) => {\n      const cleanedData = Object.fromEntries(\n        Object.entries(data).filter(([_, v]) => v !== undefined)\n      );\n      return postJson('/api/expenses', cleanedData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/expenses', selectedSessionId] });\n      toast({ title: 'Expense created successfully' });\n      setIsCreateExpenseOpen(false);\n      resetExpenseForm();\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to create expense', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  // Update expense mutation\n  const updateExpenseMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertExpense> }) => {\n      const cleanedData = Object.fromEntries(\n        Object.entries(data).filter(([_, v]) => v !== undefined)\n      );\n      return patchJson(`/api/expenses/${id}`, cleanedData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/expenses', selectedSessionId] });\n      toast({ title: 'Expense updated successfully' });\n      setIsEditExpenseOpen(false);\n      setSelectedExpense(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to update expense', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  // Delete expense mutation\n  const deleteExpenseMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return deleteJson(`/api/expenses/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/expenses', selectedSessionId] });\n      toast({ title: 'Expense deleted successfully' });\n      setIsDeleteExpenseOpen(false);\n      setSelectedExpense(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to delete expense', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  // Approve expense mutation\n  const approveExpenseMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return postJson(`/api/expenses/${id}/approve`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/expenses', selectedSessionId] });\n      toast({ title: 'Expense approved successfully' });\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to approve expense', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  // Reject expense mutation\n  const rejectExpenseMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return postJson(`/api/expenses/${id}/reject`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/expenses', selectedSessionId] });\n      toast({ title: 'Expense rejected successfully' });\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to reject expense', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  // Upload file mutation\n  const uploadFileMutation = useMutation({\n    mutationFn: async ({ expenseId, file }: { expenseId: string; file: File }) => {\n      const formData = new FormData();\n      formData.append('file', file);\n      return fetch(`/api/expenses/${expenseId}/files`, {\n        method: 'POST',\n        body: formData,\n        credentials: 'include',\n      }).then(res => {\n        if (!res.ok) throw new Error('Upload failed');\n        return res.json();\n      });\n    },\n    onSuccess: (_, { expenseId }) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/expenses', expenseId, 'files'] });\n      toast({ title: 'File uploaded successfully' });\n      setIsUploadFileOpen(false);\n      setSelectedFile(null);\n      setSelectedExpense(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to upload file', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  const handleCreateExpense = () => {\n    if (!expenseFormData.date || !expenseFormData.category || expenseFormData.amountCents === undefined) {\n      toast({ title: 'Please fill in all required fields', variant: 'destructive' });\n      return;\n    }\n    if (user?.role === 'UTILITY' && !expenseFormData.companyId) {\n      toast({ title: 'Company assignment required', variant: 'destructive' });\n      return;\n    }\n    createExpenseMutation.mutate(expenseFormData);\n  };\n\n  const handleEditExpense = (expense: Expense) => {\n    setSelectedExpense(expense);\n    setExpenseFormData({\n      sessionId: expense.sessionId,\n      companyId: expense.companyId,\n      date: new Date(expense.date),\n      category: expense.category,\n      amountCents: expense.amountCents,\n      currency: expense.currency,\n      notes: expense.notes ?? '',\n      status: expense.status,\n      submittedBy: expense.submittedBy,\n    });\n    setIsEditExpenseOpen(true);\n  };\n\n  const handleUpdateExpense = () => {\n    if (!selectedExpense) return;\n    const { sessionId, companyId, submittedBy, ...updateData } = expenseFormData;\n    updateExpenseMutation.mutate({ id: selectedExpense.id, data: updateData });\n  };\n\n  const handleDeleteExpense = (expense: Expense) => {\n    setSelectedExpense(expense);\n    setIsDeleteExpenseOpen(true);\n  };\n\n  const handleConfirmDelete = () => {\n    if (!selectedExpense) return;\n    deleteExpenseMutation.mutate(selectedExpense.id);\n  };\n\n  const handleApprove = (expense: Expense) => {\n    approveExpenseMutation.mutate(expense.id);\n  };\n\n  const handleReject = (expense: Expense) => {\n    rejectExpenseMutation.mutate(expense.id);\n  };\n\n  const handleUploadFile = (expense: Expense) => {\n    setSelectedExpense(expense);\n    setIsUploadFileOpen(true);\n  };\n\n  const handleConfirmUpload = () => {\n    if (!selectedExpense || !selectedFile) return;\n    uploadFileMutation.mutate({ expenseId: selectedExpense.id, file: selectedFile });\n  };\n\n  const formatCurrency = (cents: number, currency: string) => {\n    const dollars = cents / 100;\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: currency || 'USD',\n    }).format(dollars);\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'APPROVED':\n        return <Badge className=\"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100\">Approved</Badge>;\n      case 'REJECTED':\n        return <Badge className=\"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-100\">Rejected</Badge>;\n      case 'SUBMITTED':\n      default:\n        return <Badge className=\"bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-100\">Submitted</Badge>;\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-8\">\n      <div className=\"max-w-7xl mx-auto\">\n        <div className=\"mb-6 flex items-center gap-4\">\n          <Link href=\"/\" data-testid=\"link-back\">\n            <Button variant=\"ghost\" size=\"icon\">\n              <ArrowLeft className=\"w-5 h-5\" />\n            </Button>\n          </Link>\n          <div>\n            <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white\">Expenses</h1>\n            <p className=\"text-gray-600 dark:text-gray-400\">Track expenses and receipts</p>\n          </div>\n        </div>\n\n        {/* Session Selector */}\n        <Card className=\"mb-6\">\n          <CardHeader>\n            <CardTitle>Select Session</CardTitle>\n            <CardDescription>Choose a storm session to view expenses</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Select value={selectedSessionId} onValueChange={setSelectedSessionId}>\n              <SelectTrigger data-testid=\"select-session\">\n                <SelectValue placeholder=\"Select session\" />\n              </SelectTrigger>\n              <SelectContent>\n                {sessions?.map((session) => (\n                  <SelectItem key={session.id} value={session.id}>\n                    {session.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </CardContent>\n        </Card>\n\n        {/* Expenses List */}\n        {selectedSessionId && (\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle>Expenses</CardTitle>\n                  <CardDescription>Expense submissions for the selected session</CardDescription>\n                </div>\n                {canManageExpenses && (\n                  <Button \n                    onClick={() => {\n                      resetExpenseForm();\n                      setIsCreateExpenseOpen(true);\n                    }} \n                    disabled={user?.role === 'UTILITY' && companiesLoading}\n                    data-testid=\"button-create-expense\"\n                  >\n                    <Plus className=\"w-4 h-4 mr-2\" />\n                    Submit Expense\n                  </Button>\n                )}\n              </div>\n            </CardHeader>\n            <CardContent>\n              {expensesLoading ? (\n                <div className=\"text-center py-8 text-gray-500 dark:text-gray-400\">Loading expenses...</div>\n              ) : expenses && expenses.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {expenses.map((expense) => (\n                    <ExpenseCard\n                      key={expense.id}\n                      expense={expense}\n                      onEdit={handleEditExpense}\n                      onDelete={handleDeleteExpense}\n                      onApprove={handleApprove}\n                      onReject={handleReject}\n                      onUploadFile={handleUploadFile}\n                      canEdit={canManageExpenses && expense.status === 'SUBMITTED'}\n                      canApprove={canApproveExpenses && expense.status === 'SUBMITTED'}\n                      formatCurrency={formatCurrency}\n                      getStatusBadge={getStatusBadge}\n                      useExpenseFiles={useExpenseFiles}\n                    />\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-gray-500 dark:text-gray-400\">\n                  No expenses found. Create one to get started.\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Create Expense Dialog */}\n        <Dialog open={isCreateExpenseOpen} onOpenChange={setIsCreateExpenseOpen}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Submit New Expense</DialogTitle>\n              <DialogDescription>Create a new expense submission.</DialogDescription>\n            </DialogHeader>\n            <div className=\"grid gap-4 py-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"date\">Date *</Label>\n                <Input\n                  id=\"date\"\n                  type=\"date\"\n                  value={expenseFormData.date ? new Date(expenseFormData.date).toISOString().split('T')[0] : ''}\n                  onChange={(e) => setExpenseFormData({ ...expenseFormData, date: new Date(e.target.value) })}\n                  data-testid=\"input-date\"\n                />\n              </div>\n              {user?.role === 'UTILITY' && (\n                <div className=\"grid gap-2\">\n                  <Label htmlFor=\"companyId\">Company *</Label>\n                  <Select value={expenseFormData.companyId} onValueChange={(value) => setExpenseFormData({ ...expenseFormData, companyId: value })}>\n                    <SelectTrigger id=\"companyId\" data-testid=\"select-company\">\n                      <SelectValue placeholder=\"Select company\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {companies?.map((company) => (\n                        <SelectItem key={company.id} value={company.id}>\n                          {company.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n              )}\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"category\">Category *</Label>\n                <Select value={expenseFormData.category} onValueChange={(value) => setExpenseFormData({ ...expenseFormData, category: value })}>\n                  <SelectTrigger id=\"category\" data-testid=\"select-category\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {EXPENSE_CATEGORIES.map((cat) => (\n                      <SelectItem key={cat} value={cat}>\n                        {cat}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"amount\">Amount *</Label>\n                <Input\n                  id=\"amount\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={expenseFormData.amountCents ? (expenseFormData.amountCents / 100).toFixed(2) : ''}\n                  onChange={(e) => setExpenseFormData({ ...expenseFormData, amountCents: Math.round(parseFloat(e.target.value || '0') * 100) })}\n                  placeholder=\"0.00\"\n                  data-testid=\"input-amount\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"notes\">Notes</Label>\n                <Textarea\n                  id=\"notes\"\n                  value={expenseFormData.notes ?? ''}\n                  onChange={(e) => setExpenseFormData({ ...expenseFormData, notes: e.target.value })}\n                  placeholder=\"Additional details...\"\n                  data-testid=\"textarea-notes\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setIsCreateExpenseOpen(false)} data-testid=\"button-cancel\">\n                Cancel\n              </Button>\n              <Button onClick={handleCreateExpense} disabled={createExpenseMutation.isPending} data-testid=\"button-submit\">\n                {createExpenseMutation.isPending ? 'Creating...' : 'Submit Expense'}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n\n        {/* Edit Expense Dialog */}\n        <Dialog open={isEditExpenseOpen} onOpenChange={setIsEditExpenseOpen}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Edit Expense</DialogTitle>\n              <DialogDescription>Update expense details.</DialogDescription>\n            </DialogHeader>\n            <div className=\"grid gap-4 py-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-date\">Date *</Label>\n                <Input\n                  id=\"edit-date\"\n                  type=\"date\"\n                  value={expenseFormData.date ? new Date(expenseFormData.date).toISOString().split('T')[0] : ''}\n                  onChange={(e) => setExpenseFormData({ ...expenseFormData, date: new Date(e.target.value) })}\n                  data-testid=\"input-edit-date\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-category\">Category *</Label>\n                <Select value={expenseFormData.category} onValueChange={(value) => setExpenseFormData({ ...expenseFormData, category: value })}>\n                  <SelectTrigger id=\"edit-category\" data-testid=\"select-edit-category\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {EXPENSE_CATEGORIES.map((cat) => (\n                      <SelectItem key={cat} value={cat}>\n                        {cat}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-amount\">Amount *</Label>\n                <Input\n                  id=\"edit-amount\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={expenseFormData.amountCents ? (expenseFormData.amountCents / 100).toFixed(2) : ''}\n                  onChange={(e) => setExpenseFormData({ ...expenseFormData, amountCents: Math.round(parseFloat(e.target.value || '0') * 100) })}\n                  data-testid=\"input-edit-amount\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-notes\">Notes</Label>\n                <Textarea\n                  id=\"edit-notes\"\n                  value={expenseFormData.notes ?? ''}\n                  onChange={(e) => setExpenseFormData({ ...expenseFormData, notes: e.target.value })}\n                  data-testid=\"textarea-edit-notes\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setIsEditExpenseOpen(false)} data-testid=\"button-cancel-edit\">\n                Cancel\n              </Button>\n              <Button onClick={handleUpdateExpense} disabled={updateExpenseMutation.isPending} data-testid=\"button-update\">\n                {updateExpenseMutation.isPending ? 'Updating...' : 'Update Expense'}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n\n        {/* Delete Expense Dialog */}\n        <Dialog open={isDeleteExpenseOpen} onOpenChange={setIsDeleteExpenseOpen}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Delete Expense</DialogTitle>\n              <DialogDescription>\n                Are you sure you want to delete this expense? This action cannot be undone.\n              </DialogDescription>\n            </DialogHeader>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setIsDeleteExpenseOpen(false)} data-testid=\"button-cancel-delete\">\n                Cancel\n              </Button>\n              <Button variant=\"destructive\" onClick={handleConfirmDelete} disabled={deleteExpenseMutation.isPending} data-testid=\"button-confirm-delete\">\n                {deleteExpenseMutation.isPending ? 'Deleting...' : 'Delete'}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n\n        {/* Upload File Dialog */}\n        <Dialog open={isUploadFileOpen} onOpenChange={setIsUploadFileOpen}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Upload Receipt</DialogTitle>\n              <DialogDescription>Upload a receipt or supporting document for this expense.</DialogDescription>\n            </DialogHeader>\n            <div className=\"grid gap-4 py-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"file\">File *</Label>\n                <Input\n                  id=\"file\"\n                  type=\"file\"\n                  onChange={(e) => setSelectedFile(e.target.files?.[0] || null)}\n                  data-testid=\"input-file\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setIsUploadFileOpen(false)} data-testid=\"button-cancel-upload\">\n                Cancel\n              </Button>\n              <Button onClick={handleConfirmUpload} disabled={!selectedFile || uploadFileMutation.isPending} data-testid=\"button-upload\">\n                {uploadFileMutation.isPending ? 'Uploading...' : 'Upload'}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n\nfunction ExpenseCard({\n  expense,\n  onEdit,\n  onDelete,\n  onApprove,\n  onReject,\n  onUploadFile,\n  canEdit,\n  canApprove,\n  formatCurrency,\n  getStatusBadge,\n  useExpenseFiles,\n}: {\n  expense: Expense;\n  onEdit: (expense: Expense) => void;\n  onDelete: (expense: Expense) => void;\n  onApprove: (expense: Expense) => void;\n  onReject: (expense: Expense) => void;\n  onUploadFile: (expense: Expense) => void;\n  canEdit: boolean;\n  canApprove: boolean;\n  formatCurrency: (cents: number, currency: string) => string;\n  getStatusBadge: (status: string) => JSX.Element;\n  useExpenseFiles: (expenseId: string) => { data?: ExpenseFile[]; isLoading: boolean };\n}) {\n  const { data: files, isLoading: filesLoading } = useExpenseFiles(expense.id);\n\n  return (\n    <div className=\"border dark:border-gray-700 rounded-lg p-4 hover:shadow-md transition-shadow\" data-testid={`card-expense-${expense.id}`}>\n      <div className=\"flex items-start justify-between mb-3\">\n        <div>\n          <div className=\"flex items-center gap-2 mb-1\">\n            <h3 className=\"font-semibold text-gray-900 dark:text-white\">{expense.category}</h3>\n            {getStatusBadge(expense.status)}\n          </div>\n          <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n            {new Date(expense.date).toLocaleDateString()} • {formatCurrency(expense.amountCents, expense.currency)}\n          </p>\n          {expense.notes && (\n            <p className=\"text-sm text-gray-600 dark:text-gray-400 mt-1\">{expense.notes}</p>\n          )}\n        </div>\n        <div className=\"flex gap-2\">\n          {canEdit && (\n            <>\n              <Button variant=\"ghost\" size=\"icon\" onClick={() => onEdit(expense)} data-testid={`button-edit-${expense.id}`}>\n                <Edit className=\"w-4 h-4\" />\n              </Button>\n              <Button variant=\"ghost\" size=\"icon\" onClick={() => onDelete(expense)} data-testid={`button-delete-${expense.id}`}>\n                <Trash2 className=\"w-4 h-4\" />\n              </Button>\n            </>\n          )}\n          {canApprove && (\n            <>\n              <Button variant=\"ghost\" size=\"icon\" onClick={() => onApprove(expense)} className=\"text-green-600 hover:text-green-700\" data-testid={`button-approve-${expense.id}`}>\n                <CheckCircle className=\"w-4 h-4\" />\n              </Button>\n              <Button variant=\"ghost\" size=\"icon\" onClick={() => onReject(expense)} className=\"text-red-600 hover:text-red-700\" data-testid={`button-reject-${expense.id}`}>\n                <XCircle className=\"w-4 h-4\" />\n              </Button>\n            </>\n          )}\n        </div>\n      </div>\n      \n      {/* Files Section */}\n      <div className=\"mt-3 pt-3 border-t dark:border-gray-700\">\n        <div className=\"flex items-center justify-between mb-2\">\n          <h4 className=\"text-sm font-medium text-gray-700 dark:text-gray-300\">Receipts & Documents</h4>\n          <Button variant=\"ghost\" size=\"sm\" onClick={() => onUploadFile(expense)} data-testid={`button-upload-file-${expense.id}`}>\n            <Upload className=\"w-3 h-3 mr-1\" />\n            Upload\n          </Button>\n        </div>\n        {filesLoading ? (\n          <p className=\"text-xs text-gray-500 dark:text-gray-400\">Loading files...</p>\n        ) : files && files.length > 0 ? (\n          <div className=\"space-y-1\">\n            {files.map((file) => (\n              <div key={file.id} className=\"flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400\">\n                <FileText className=\"w-3 h-3\" />\n                <span className=\"flex-1 truncate\">{file.originalName}</span>\n                <a \n                  href={`/api/expenses/${expense.id}/files/${file.id}/download`}\n                  download\n                  className=\"text-blue-600 hover:text-blue-700 dark:text-blue-400\"\n                  data-testid={`link-download-${file.id}`}\n                >\n                  <Download className=\"w-3 h-3\" />\n                </a>\n              </div>\n            ))}\n          </div>\n        ) : (\n          <p className=\"text-xs text-gray-500 dark:text-gray-400\">No files uploaded</p>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":28541,"size_tokens":null},"client/src/pages/invoices.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { Link } from 'wouter';\nimport { ArrowLeft, Plus, Edit, Trash2, Send, DollarSign, ChevronDown, ChevronRight, FileDown } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Textarea } from '@/components/ui/textarea';\nimport { useToast } from '@/hooks/use-toast';\nimport { useAuth } from '@/context/AuthContext';\nimport { getJson, postJson, patchJson, deleteJson, queryClient } from '@/lib/queryClient';\nimport type { Invoice, InsertInvoice, InvoiceLine, InsertInvoiceLine, StormSession, Company } from '@shared/schema';\nimport { Badge } from '@/components/ui/badge';\n\nexport default function InvoicesPage() {\n  const { user, logout } = useAuth();\n  const { toast } = useToast();\n  \n  const [selectedSessionId, setSelectedSessionId] = useState<string>('');\n  const [expandedInvoices, setExpandedInvoices] = useState<Set<string>>(new Set());\n  const [isCreateInvoiceOpen, setIsCreateInvoiceOpen] = useState(false);\n  const [isEditInvoiceOpen, setIsEditInvoiceOpen] = useState(false);\n  const [isDeleteInvoiceOpen, setIsDeleteInvoiceOpen] = useState(false);\n  const [isAddLineOpen, setIsAddLineOpen] = useState(false);\n  const [selectedInvoice, setSelectedInvoice] = useState<Invoice | null>(null);\n  const [invoiceFormData, setInvoiceFormData] = useState<Partial<InsertInvoice>>({\n    sessionId: '',\n    companyId: '',\n    status: 'DRAFT',\n    issuedAt: undefined,\n    dueAt: undefined,\n    totalsJson: undefined,\n  });\n  const [lineFormData, setLineFormData] = useState<Partial<InsertInvoiceLine>>({\n    invoiceId: '',\n    source: 'TIMESHEET',\n    sourceId: undefined,\n    description: '',\n    qty: 1,\n    unitRateCents: 0,\n    amountCents: 0,\n  });\n\n  const resetInvoiceForm = () => {\n    setInvoiceFormData({\n      sessionId: selectedSessionId || '',\n      companyId: '',\n      status: 'DRAFT',\n      issuedAt: undefined,\n      dueAt: undefined,\n      totalsJson: undefined,\n    });\n  };\n\n  const resetLineForm = () => {\n    setLineFormData({\n      invoiceId: '',\n      source: 'TIMESHEET',\n      sourceId: undefined,\n      description: '',\n      qty: 1,\n      unitRateCents: 0,\n      amountCents: 0,\n    });\n  };\n\n  const canManageInvoices = user?.role === 'ADMIN' || user?.role === 'MANAGER' || user?.role === 'CONTRACTOR' || user?.role === 'UTILITY';\n\n  // Fetch sessions\n  const { data: sessions } = useQuery<StormSession[]>({\n    queryKey: ['/api/storm-sessions'],\n  });\n\n  // Fetch companies (for company selector)\n  const { data: companies, isLoading: companiesLoading } = useQuery<Company[]>({\n    queryKey: ['/api/companies'],\n    enabled: canManageInvoices,\n  });\n\n  // Fetch invoices for selected session\n  const { data: invoices, isLoading: invoicesLoading } = useQuery<Invoice[]>({\n    queryKey: ['/api/invoices', selectedSessionId],\n    queryFn: () => selectedSessionId ? getJson<Invoice[]>(`/api/invoices?sessionId=${selectedSessionId}`) : Promise.resolve([]),\n    enabled: !!selectedSessionId,\n  });\n\n\n  // Auto-select first session if available\n  useEffect(() => {\n    if (sessions && sessions.length > 0 && !selectedSessionId) {\n      setSelectedSessionId(sessions[0].id);\n    }\n  }, [sessions, selectedSessionId]);\n\n  // Create invoice mutation\n  const createInvoiceMutation = useMutation({\n    mutationFn: async (data: Partial<InsertInvoice>) => {\n      const cleanedData = Object.fromEntries(\n        Object.entries(data).filter(([_, v]) => v !== undefined)\n      );\n      return postJson('/api/invoices', cleanedData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/invoices', selectedSessionId] });\n      toast({ title: 'Invoice created successfully' });\n      setIsCreateInvoiceOpen(false);\n      resetInvoiceForm();\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to create invoice', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  // Update invoice mutation\n  const updateInvoiceMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertInvoice> }) => {\n      const cleanedData = Object.fromEntries(\n        Object.entries(data).filter(([_, v]) => v !== undefined)\n      );\n      return patchJson(`/api/invoices/${id}`, cleanedData);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/invoices', selectedSessionId] });\n      toast({ title: 'Invoice updated successfully' });\n      setIsEditInvoiceOpen(false);\n      setSelectedInvoice(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to update invoice', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  // Delete invoice mutation\n  const deleteInvoiceMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return deleteJson(`/api/invoices/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/invoices', selectedSessionId] });\n      toast({ title: 'Invoice deleted successfully' });\n      setIsDeleteInvoiceOpen(false);\n      setSelectedInvoice(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to delete invoice', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  // Issue invoice mutation\n  const issueInvoiceMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return postJson(`/api/invoices/${id}/issue`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/invoices', selectedSessionId] });\n      toast({ title: 'Invoice issued successfully' });\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to issue invoice', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  // Mark paid mutation\n  const markPaidMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return postJson(`/api/invoices/${id}/mark-paid`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/invoices', selectedSessionId] });\n      toast({ title: 'Invoice marked as paid successfully' });\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to mark invoice as paid', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  // Add invoice line mutation\n  const addLineMutation = useMutation({\n    mutationFn: async ({ invoiceId, data }: { invoiceId: string; data: Partial<InsertInvoiceLine> }) => {\n      const cleanedData = Object.fromEntries(\n        Object.entries(data).filter(([_, v]) => v !== undefined)\n      );\n      return postJson(`/api/invoices/${invoiceId}/lines`, cleanedData);\n    },\n    onSuccess: (_, { invoiceId }) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/invoices', invoiceId, 'lines'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/invoices', selectedSessionId] });\n      toast({ title: 'Invoice line added successfully' });\n      setIsAddLineOpen(false);\n      resetLineForm();\n      setSelectedInvoice(null);\n    },\n    onError: (error: Error) => {\n      toast({ title: 'Failed to add invoice line', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  const handleCreateInvoice = () => {\n    if (!invoiceFormData.companyId) {\n      toast({ title: 'Company assignment required', variant: 'destructive' });\n      return;\n    }\n    createInvoiceMutation.mutate(invoiceFormData);\n  };\n\n  const handleEditInvoice = (invoice: Invoice) => {\n    setSelectedInvoice(invoice);\n    setInvoiceFormData({\n      sessionId: invoice.sessionId,\n      companyId: invoice.companyId,\n      status: invoice.status,\n      issuedAt: invoice.issuedAt ? new Date(invoice.issuedAt) : undefined,\n      dueAt: invoice.dueAt ? new Date(invoice.dueAt) : undefined,\n      totalsJson: invoice.totalsJson,\n    });\n    setIsEditInvoiceOpen(true);\n  };\n\n  const handleUpdateInvoice = () => {\n    if (!selectedInvoice) return;\n    const { sessionId, companyId, ...updateData } = invoiceFormData;\n    updateInvoiceMutation.mutate({ id: selectedInvoice.id, data: updateData });\n  };\n\n  const handleDeleteInvoice = (invoice: Invoice) => {\n    setSelectedInvoice(invoice);\n    setIsDeleteInvoiceOpen(true);\n  };\n\n  const handleConfirmDelete = () => {\n    if (!selectedInvoice) return;\n    deleteInvoiceMutation.mutate(selectedInvoice.id);\n  };\n\n  const handleIssue = (invoice: Invoice) => {\n    issueInvoiceMutation.mutate(invoice.id);\n  };\n\n  const handleMarkPaid = (invoice: Invoice) => {\n    markPaidMutation.mutate(invoice.id);\n  };\n\n  const handleAddLine = (invoice: Invoice) => {\n    setSelectedInvoice(invoice);\n    setLineFormData({\n      invoiceId: invoice.id,\n      source: 'TIMESHEET',\n      sourceId: undefined,\n      description: '',\n      qty: 1,\n      unitRateCents: 0,\n      amountCents: 0,\n    });\n    setIsAddLineOpen(true);\n  };\n\n  const handleSubmitLine = () => {\n    if (!selectedInvoice) return;\n    if (!lineFormData.description || lineFormData.qty === undefined || lineFormData.unitRateCents === undefined) {\n      toast({ title: 'Please fill in all required fields', variant: 'destructive' });\n      return;\n    }\n    // Calculate amountCents from qty and unitRateCents\n    const calculatedAmount = (lineFormData.qty || 0) * (lineFormData.unitRateCents || 0);\n    addLineMutation.mutate({\n      invoiceId: selectedInvoice.id,\n      data: { ...lineFormData, amountCents: calculatedAmount },\n    });\n  };\n\n  const toggleInvoice = (invoiceId: string) => {\n    setExpandedInvoices(prev => {\n      const next = new Set(prev);\n      if (next.has(invoiceId)) {\n        next.delete(invoiceId);\n      } else {\n        next.add(invoiceId);\n      }\n      return next;\n    });\n  };\n\n  const formatCurrency = (cents: number) => {\n    const dollars = cents / 100;\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: 'USD',\n    }).format(dollars);\n  };\n\n  const getStatusBadge = (status: string) => {\n    switch (status) {\n      case 'PAID':\n        return <Badge className=\"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-100\">Paid</Badge>;\n      case 'ISSUED':\n        return <Badge className=\"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-100\">Issued</Badge>;\n      case 'DRAFT':\n      default:\n        return <Badge className=\"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-100\">Draft</Badge>;\n    }\n  };\n\n  const calculateInvoiceTotal = (lines: InvoiceLine[] | undefined) => {\n    if (!lines) return 0;\n    return lines.reduce((sum, line) => sum + line.amountCents, 0);\n  };\n\n  if (!canManageInvoices) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-8\">\n        <div className=\"max-w-7xl mx-auto\">\n          <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white mb-6\">Invoices</h1>\n          <p className=\"text-gray-600 dark:text-gray-400\">\n            You do not have permission to access invoice management.\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-8\">\n      <div className=\"max-w-7xl mx-auto\">\n        <div className=\"mb-6 flex items-center gap-4\">\n          <Link href=\"/\" data-testid=\"link-back\">\n            <Button variant=\"ghost\" size=\"icon\">\n              <ArrowLeft className=\"w-5 h-5\" />\n            </Button>\n          </Link>\n          <div>\n            <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white\">Invoices</h1>\n            <p className=\"text-gray-600 dark:text-gray-400\">Generate and manage invoices</p>\n          </div>\n        </div>\n\n        {/* Session Selector */}\n        <Card className=\"mb-6\">\n          <CardHeader>\n            <CardTitle>Select Session</CardTitle>\n            <CardDescription>Choose a storm session to view invoices</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <Select value={selectedSessionId} onValueChange={setSelectedSessionId}>\n              <SelectTrigger data-testid=\"select-session\">\n                <SelectValue placeholder=\"Select session\" />\n              </SelectTrigger>\n              <SelectContent>\n                {sessions?.map((session) => (\n                  <SelectItem key={session.id} value={session.id}>\n                    {session.name}\n                  </SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </CardContent>\n        </Card>\n\n        {/* Invoices List */}\n        {selectedSessionId && (\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle>Invoices</CardTitle>\n                  <CardDescription>Generated invoices for the selected session</CardDescription>\n                </div>\n                <Button \n                  onClick={() => {\n                    resetInvoiceForm();\n                    setIsCreateInvoiceOpen(true);\n                  }} \n                  disabled={companiesLoading}\n                  data-testid=\"button-create-invoice\"\n                >\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Create Invoice\n                </Button>\n              </div>\n            </CardHeader>\n            <CardContent>\n              {invoicesLoading ? (\n                <div className=\"text-center py-8 text-gray-500 dark:text-gray-400\">Loading invoices...</div>\n              ) : invoices && invoices.length > 0 ? (\n                <div className=\"space-y-4\">\n                  {invoices.map((invoice) => (\n                    <InvoiceCard\n                      key={invoice.id}\n                      invoice={invoice}\n                      isExpanded={expandedInvoices.has(invoice.id)}\n                      onToggle={() => toggleInvoice(invoice.id)}\n                      onEdit={handleEditInvoice}\n                      onDelete={handleDeleteInvoice}\n                      onIssue={handleIssue}\n                      onMarkPaid={handleMarkPaid}\n                      onAddLine={handleAddLine}\n                      getStatusBadge={getStatusBadge}\n                      formatCurrency={formatCurrency}\n                      companies={companies}\n                    />\n                  ))}\n                </div>\n              ) : (\n                <div className=\"text-center py-8 text-gray-500 dark:text-gray-400\">\n                  No invoices found. Create one to get started.\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n\n        {/* Create Invoice Dialog */}\n        <Dialog open={isCreateInvoiceOpen} onOpenChange={setIsCreateInvoiceOpen}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Create New Invoice</DialogTitle>\n              <DialogDescription>Create a new invoice for billing.</DialogDescription>\n            </DialogHeader>\n            <div className=\"grid gap-4 py-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"companyId\">Company *</Label>\n                <Select value={invoiceFormData.companyId} onValueChange={(value) => setInvoiceFormData({ ...invoiceFormData, companyId: value })}>\n                  <SelectTrigger id=\"companyId\" data-testid=\"select-company\">\n                    <SelectValue placeholder=\"Select company\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {companies?.map((company) => (\n                      <SelectItem key={company.id} value={company.id}>\n                        {company.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"dueAt\">Due Date</Label>\n                <Input\n                  id=\"dueAt\"\n                  type=\"date\"\n                  value={invoiceFormData.dueAt ? new Date(invoiceFormData.dueAt).toISOString().split('T')[0] : ''}\n                  onChange={(e) => setInvoiceFormData({ ...invoiceFormData, dueAt: e.target.value ? new Date(e.target.value) : undefined })}\n                  data-testid=\"input-due-date\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setIsCreateInvoiceOpen(false)} data-testid=\"button-cancel\">\n                Cancel\n              </Button>\n              <Button onClick={handleCreateInvoice} disabled={createInvoiceMutation.isPending} data-testid=\"button-submit\">\n                {createInvoiceMutation.isPending ? 'Creating...' : 'Create Invoice'}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n\n        {/* Edit Invoice Dialog */}\n        <Dialog open={isEditInvoiceOpen} onOpenChange={setIsEditInvoiceOpen}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Edit Invoice</DialogTitle>\n              <DialogDescription>Update invoice details.</DialogDescription>\n            </DialogHeader>\n            <div className=\"grid gap-4 py-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"edit-dueAt\">Due Date</Label>\n                <Input\n                  id=\"edit-dueAt\"\n                  type=\"date\"\n                  value={invoiceFormData.dueAt ? new Date(invoiceFormData.dueAt).toISOString().split('T')[0] : ''}\n                  onChange={(e) => setInvoiceFormData({ ...invoiceFormData, dueAt: e.target.value ? new Date(e.target.value) : undefined })}\n                  data-testid=\"input-edit-due-date\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setIsEditInvoiceOpen(false)} data-testid=\"button-cancel-edit\">\n                Cancel\n              </Button>\n              <Button onClick={handleUpdateInvoice} disabled={updateInvoiceMutation.isPending} data-testid=\"button-update\">\n                {updateInvoiceMutation.isPending ? 'Updating...' : 'Update Invoice'}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n\n        {/* Delete Invoice Dialog */}\n        <Dialog open={isDeleteInvoiceOpen} onOpenChange={setIsDeleteInvoiceOpen}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Delete Invoice</DialogTitle>\n              <DialogDescription>\n                Are you sure you want to delete this invoice? This action cannot be undone.\n              </DialogDescription>\n            </DialogHeader>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setIsDeleteInvoiceOpen(false)} data-testid=\"button-cancel-delete\">\n                Cancel\n              </Button>\n              <Button variant=\"destructive\" onClick={handleConfirmDelete} disabled={deleteInvoiceMutation.isPending} data-testid=\"button-confirm-delete\">\n                {deleteInvoiceMutation.isPending ? 'Deleting...' : 'Delete'}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n\n        {/* Add Invoice Line Dialog */}\n        <Dialog open={isAddLineOpen} onOpenChange={setIsAddLineOpen}>\n          <DialogContent className=\"max-w-md\">\n            <DialogHeader>\n              <DialogTitle>Add Invoice Line</DialogTitle>\n              <DialogDescription>Add a line item to the invoice.</DialogDescription>\n            </DialogHeader>\n            <div className=\"grid gap-4 py-4\">\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"line-source\">Source *</Label>\n                <Select value={lineFormData.source} onValueChange={(value) => setLineFormData({ ...lineFormData, source: value })}>\n                  <SelectTrigger id=\"line-source\" data-testid=\"select-line-source\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"TIMESHEET\">Timesheet</SelectItem>\n                    <SelectItem value=\"EXPENSE\">Expense</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"line-description\">Description *</Label>\n                <Textarea\n                  id=\"line-description\"\n                  value={lineFormData.description ?? ''}\n                  onChange={(e) => setLineFormData({ ...lineFormData, description: e.target.value })}\n                  placeholder=\"Labor, equipment rental, etc.\"\n                  data-testid=\"textarea-line-description\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"line-qty\">Quantity *</Label>\n                <Input\n                  id=\"line-qty\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={lineFormData.qty ?? 1}\n                  onChange={(e) => setLineFormData({ ...lineFormData, qty: parseFloat(e.target.value || '1') })}\n                  data-testid=\"input-line-qty\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label htmlFor=\"line-rate\">Unit Rate *</Label>\n                <Input\n                  id=\"line-rate\"\n                  type=\"number\"\n                  step=\"0.01\"\n                  value={lineFormData.unitRateCents ? (lineFormData.unitRateCents / 100).toFixed(2) : ''}\n                  onChange={(e) => setLineFormData({ ...lineFormData, unitRateCents: Math.round(parseFloat(e.target.value || '0') * 100) })}\n                  placeholder=\"0.00\"\n                  data-testid=\"input-line-rate\"\n                />\n              </div>\n              <div className=\"grid gap-2\">\n                <Label>Total Amount</Label>\n                <Input\n                  type=\"text\"\n                  value={formatCurrency((lineFormData.qty || 0) * (lineFormData.unitRateCents || 0))}\n                  disabled\n                  data-testid=\"input-line-total\"\n                />\n              </div>\n            </div>\n            <DialogFooter>\n              <Button variant=\"outline\" onClick={() => setIsAddLineOpen(false)} data-testid=\"button-cancel-add-line\">\n                Cancel\n              </Button>\n              <Button onClick={handleSubmitLine} disabled={addLineMutation.isPending} data-testid=\"button-add-line\">\n                {addLineMutation.isPending ? 'Adding...' : 'Add Line'}\n              </Button>\n            </DialogFooter>\n          </DialogContent>\n        </Dialog>\n      </div>\n    </div>\n  );\n}\n\nfunction InvoiceCard({\n  invoice,\n  isExpanded,\n  onToggle,\n  onEdit,\n  onDelete,\n  onIssue,\n  onMarkPaid,\n  onAddLine,\n  getStatusBadge,\n  formatCurrency,\n  companies,\n}: {\n  invoice: Invoice;\n  isExpanded: boolean;\n  onToggle: () => void;\n  onEdit: (invoice: Invoice) => void;\n  onDelete: (invoice: Invoice) => void;\n  onIssue: (invoice: Invoice) => void;\n  onMarkPaid: (invoice: Invoice) => void;\n  onAddLine: (invoice: Invoice) => void;\n  getStatusBadge: (status: string) => JSX.Element;\n  formatCurrency: (cents: number) => string;\n  companies: Company[] | undefined;\n}) {\n  // Fetch lines for this invoice\n  const { data: lines, isLoading: linesLoading } = useQuery<InvoiceLine[]>({\n    queryKey: ['/api/invoices', invoice.id, 'lines'],\n    queryFn: () => getJson<InvoiceLine[]>(`/api/invoices/${invoice.id}/lines`),\n    enabled: isExpanded,\n  });\n\n  const company = companies?.find(c => c.id === invoice.companyId);\n  \n  const calculateTotal = (lines: InvoiceLine[] | undefined) => {\n    if (!lines) return 0;\n    return lines.reduce((sum, line) => sum + line.amountCents, 0);\n  };\n\n  return (\n    <div className=\"border dark:border-gray-700 rounded-lg p-4\" data-testid={`card-invoice-${invoice.id}`}>\n      <div className=\"flex items-start justify-between mb-3\">\n        <button onClick={onToggle} className=\"flex items-center gap-2 flex-1 text-left\" data-testid={`button-toggle-${invoice.id}`}>\n          {isExpanded ? <ChevronDown className=\"w-4 h-4\" /> : <ChevronRight className=\"w-4 h-4\" />}\n          <div>\n            <div className=\"flex items-center gap-2 mb-1\">\n              <h3 className=\"font-semibold text-gray-900 dark:text-white\">Invoice #{invoice.id.slice(0, 8)}</h3>\n              {getStatusBadge(invoice.status)}\n            </div>\n            <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n              {company?.name || 'Unknown Company'}\n              {invoice.dueAt && ` • Due: ${new Date(invoice.dueAt).toLocaleDateString()}`}\n            </p>\n            {isExpanded && lines && (\n              <p className=\"text-sm font-medium text-gray-900 dark:text-white mt-1\">\n                Total: {formatCurrency(calculateTotal(lines))}\n              </p>\n            )}\n          </div>\n        </button>\n        <div className=\"flex gap-2\">\n          {invoice.status === 'DRAFT' && (\n            <>\n              <Button variant=\"ghost\" size=\"icon\" onClick={() => onEdit(invoice)} data-testid={`button-edit-${invoice.id}`}>\n                <Edit className=\"w-4 h-4\" />\n              </Button>\n              <Button variant=\"ghost\" size=\"icon\" onClick={() => onAddLine(invoice)} data-testid={`button-add-line-${invoice.id}`}>\n                <Plus className=\"w-4 h-4\" />\n              </Button>\n              <Button variant=\"ghost\" size=\"icon\" onClick={() => onIssue(invoice)} className=\"text-blue-600 hover:text-blue-700\" data-testid={`button-issue-${invoice.id}`}>\n                <Send className=\"w-4 h-4\" />\n              </Button>\n              <Button variant=\"ghost\" size=\"icon\" onClick={() => onDelete(invoice)} data-testid={`button-delete-${invoice.id}`}>\n                <Trash2 className=\"w-4 h-4\" />\n              </Button>\n            </>\n          )}\n          {invoice.status === 'ISSUED' && (\n            <Button variant=\"ghost\" size=\"icon\" onClick={() => onMarkPaid(invoice)} className=\"text-green-600 hover:text-green-700\" data-testid={`button-mark-paid-${invoice.id}`}>\n              <DollarSign className=\"w-4 h-4\" />\n            </Button>\n          )}\n        </div>\n      </div>\n\n      {/* Invoice Lines */}\n      {isExpanded && (\n        <div className=\"mt-3 pt-3 border-t dark:border-gray-700\">\n          <h4 className=\"text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">Line Items</h4>\n          {linesLoading ? (\n            <p className=\"text-sm text-gray-500 dark:text-gray-400\">Loading lines...</p>\n          ) : lines && lines.length > 0 ? (\n            <div className=\"space-y-2\">\n              {lines.map((line) => (\n                <div key={line.id} className=\"text-sm bg-gray-50 dark:bg-gray-800 p-2 rounded\" data-testid={`line-${line.id}`}>\n                  <div className=\"flex justify-between items-start\">\n                    <div className=\"flex-1\">\n                      <p className=\"font-medium text-gray-900 dark:text-white\">{line.description}</p>\n                      <p className=\"text-gray-600 dark:text-gray-400\">\n                        {line.qty} × {formatCurrency(line.unitRateCents)}\n                      </p>\n                    </div>\n                    <p className=\"font-medium text-gray-900 dark:text-white\">{formatCurrency(line.amountCents)}</p>\n                  </div>\n                </div>\n              ))}\n            </div>\n          ) : (\n            <p className=\"text-sm text-gray-500 dark:text-gray-400\">No line items. Add lines to build the invoice.</p>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":28005,"size_tokens":null},"client/src/pages/companies.tsx":{"content":"import { useState } from 'react';\nimport { useAuth } from '@/context/AuthContext';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { queryClient, postJson, patchJson, deleteJson } from '@/lib/queryClient';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport {\n  Table,\n  TableBody,\n  TableCell,\n  TableHead,\n  TableHeader,\n  TableRow,\n} from '@/components/ui/table';\nimport {\n  Dialog,\n  DialogContent,\n  DialogDescription,\n  DialogFooter,\n  DialogHeader,\n  DialogTitle,\n} from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport {  Textarea } from '@/components/ui/textarea';\nimport { useToast } from '@/hooks/use-toast';\nimport { Building2, Plus, Pencil, Trash2, ArrowLeft } from 'lucide-react';\nimport { Link } from 'wouter';\nimport type { Company, InsertCompany } from '@shared/schema';\nimport { insertCompanySchema } from '@shared/schema';\n\nexport default function CompaniesPage() {\n  const { user, logout } = useAuth();\n  const { toast } = useToast();\n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isDeleteDialogOpen, setIsDeleteDialogOpen] = useState(false);\n  const [selectedCompany, setSelectedCompany] = useState<Company | null>(null);\n  const [formData, setFormData] = useState<Partial<InsertCompany>>({\n    name: '',\n    contactName: '',\n    contactEmail: '',\n    contactPhone: '',\n    billingAddress: '',\n    notes: '',\n  });\n\n  // Check UTILITY role\n  if (user?.role !== 'UTILITY') {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-8\">\n        <div className=\"max-w-7xl mx-auto\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Access Denied</CardTitle>\n              <CardDescription>Only UTILITY users can manage companies.</CardDescription>\n            </CardHeader>\n            <CardContent>\n              <Link href=\"/\">\n                <Button variant=\"outline\" data-testid=\"button-back-access-denied\">\n                  <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                  Back to Dashboard\n                </Button>\n              </Link>\n            </CardContent>\n          </Card>\n        </div>\n      </div>\n    );\n  }\n\n  const { data: companies, isLoading } = useQuery<Company[]>({\n    queryKey: ['/api/companies'],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: InsertCompany) => {\n      return await postJson('/api/companies', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/companies'] });\n      setIsCreateDialogOpen(false);\n      resetForm();\n      toast({ title: 'Company created successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to create company', variant: 'destructive' });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertCompany> }) => {\n      return await patchJson(`/api/companies/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/companies'] });\n      setIsEditDialogOpen(false);\n      setSelectedCompany(null);\n      resetForm();\n      toast({ title: 'Company updated successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to update company', variant: 'destructive' });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await deleteJson(`/api/companies/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/companies'] });\n      setIsDeleteDialogOpen(false);\n      setSelectedCompany(null);\n      toast({ title: 'Company deleted successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to delete company', variant: 'destructive' });\n    },\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: '',\n      contactName: '',\n      contactEmail: '',\n      contactPhone: '',\n      billingAddress: '',\n      notes: '',\n    });\n  };\n\n  const handleCreate = () => {\n    try {\n      const validData = insertCompanySchema.parse(formData);\n      createMutation.mutate(validData);\n    } catch (error) {\n      toast({ title: 'Please fill in all required fields', variant: 'destructive' });\n    }\n  };\n\n  const handleEdit = (company: Company) => {\n    setSelectedCompany(company);\n    setFormData({\n      name: company.name,\n      contactName: company.contactName ?? '',\n      contactEmail: company.contactEmail ?? '',\n      contactPhone: company.contactPhone ?? '',\n      billingAddress: company.billingAddress ?? '',\n      notes: company.notes ?? '',\n    });\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdate = () => {\n    if (!selectedCompany) return;\n    updateMutation.mutate({ id: selectedCompany.id, data: formData });\n  };\n\n  const handleDelete = (company: Company) => {\n    setSelectedCompany(company);\n    setIsDeleteDialogOpen(true);\n  };\n\n  const confirmDelete = () => {\n    if (!selectedCompany) return;\n    deleteMutation.mutate(selectedCompany.id);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n      {/* Header */}\n      <header className=\"bg-white dark:bg-gray-800 shadow-sm border-b\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4\">\n          <div className=\"flex justify-between items-center\">\n            <div className=\"flex items-center space-x-3\">\n              <Building2 className=\"w-8 h-8 text-blue-600\" />\n              <div>\n                <h1 className=\"text-2xl font-bold text-gray-900 dark:text-white\">Companies Management</h1>\n                <p className=\"text-sm text-gray-600 dark:text-gray-400\">Manage contractor companies</p>\n              </div>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <Link href=\"/\">\n                <Button variant=\"outline\" size=\"sm\" data-testid=\"button-back-dashboard\">\n                  <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                  Dashboard\n                </Button>\n              </Link>\n              <Button variant=\"outline\" size=\"sm\" onClick={logout} data-testid=\"button-logout\">\n                Logout\n              </Button>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      {/* Main Content */}\n      <main className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        <Card>\n          <CardHeader>\n            <div className=\"flex justify-between items-center\">\n              <div>\n                <CardTitle>Contractor Companies</CardTitle>\n                <CardDescription>View and manage all contractor companies</CardDescription>\n              </div>\n              <Button onClick={() => setIsCreateDialogOpen(true)} data-testid=\"button-create-company\">\n                <Plus className=\"w-4 h-4 mr-2\" />\n                Add Company\n              </Button>\n            </div>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"flex justify-center py-8\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\n              </div>\n            ) : !companies || companies.length === 0 ? (\n              <div className=\"text-center py-8 text-gray-500\">\n                No companies found. Create your first company to get started.\n              </div>\n            ) : (\n              <Table data-testid=\"table-companies\">\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Name</TableHead>\n                    <TableHead>Contact</TableHead>\n                    <TableHead>Email</TableHead>\n                    <TableHead>Phone</TableHead>\n                    <TableHead className=\"text-right\">Actions</TableHead>\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {companies.map((company) => (\n                    <TableRow key={company.id} data-testid={`row-company-${company.id}`}>\n                      <TableCell className=\"font-medium\">{company.name}</TableCell>\n                      <TableCell>{company.contactName || '-'}</TableCell>\n                      <TableCell>{company.contactEmail || '-'}</TableCell>\n                      <TableCell>{company.contactPhone || '-'}</TableCell>\n                      <TableCell className=\"text-right\">\n                        <div className=\"flex justify-end space-x-2\">\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => handleEdit(company)}\n                            data-testid={`button-edit-${company.id}`}\n                          >\n                            <Pencil className=\"w-4 h-4\" />\n                          </Button>\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => handleDelete(company)}\n                            data-testid={`button-delete-${company.id}`}\n                          >\n                            <Trash2 className=\"w-4 h-4 text-red-600\" />\n                          </Button>\n                        </div>\n                      </TableCell>\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n      </main>\n\n      {/* Create Dialog */}\n      <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n        <DialogContent data-testid=\"dialog-create-company\">\n          <DialogHeader>\n            <DialogTitle>Create New Company</DialogTitle>\n            <DialogDescription>Add a new contractor company to the system.</DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"name\">Company Name *</Label>\n              <Input\n                id=\"name\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                placeholder=\"Acme Construction Inc.\"\n                data-testid=\"input-company-name\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"contactName\">Contact Name</Label>\n              <Input\n                id=\"contactName\"\n                value={formData.contactName ?? ''}\n                onChange={(e) => setFormData({ ...formData, contactName: e.target.value })}\n                placeholder=\"John Doe\"\n                data-testid=\"input-contact-name\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"contactEmail\">Contact Email</Label>\n              <Input\n                id=\"contactEmail\"\n                type=\"email\"\n                value={formData.contactEmail ?? ''}\n                onChange={(e) => setFormData({ ...formData, contactEmail: e.target.value })}\n                placeholder=\"john@acme.com\"\n                data-testid=\"input-contact-email\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"contactPhone\">Contact Phone</Label>\n              <Input\n                id=\"contactPhone\"\n                value={formData.contactPhone ?? ''}\n                onChange={(e) => setFormData({ ...formData, contactPhone: e.target.value })}\n                placeholder=\"+1 (555) 123-4567\"\n                data-testid=\"input-contact-phone\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"billingAddress\">Billing Address</Label>\n              <Textarea\n                id=\"billingAddress\"\n                value={formData.billingAddress ?? ''}\n                onChange={(e) => setFormData({ ...formData, billingAddress: e.target.value })}\n                placeholder=\"123 Main St, City, State, ZIP\"\n                data-testid=\"input-billing-address\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"notes\">Notes</Label>\n              <Textarea\n                id=\"notes\"\n                value={formData.notes ?? ''}\n                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                placeholder=\"Additional notes...\"\n                data-testid=\"input-notes\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsCreateDialogOpen(false)} data-testid=\"button-cancel-create\">\n              Cancel\n            </Button>\n            <Button\n              onClick={handleCreate}\n              disabled={createMutation.isPending}\n              data-testid=\"button-submit-create\"\n            >\n              {createMutation.isPending ? 'Creating...' : 'Create Company'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Dialog */}\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent data-testid=\"dialog-edit-company\">\n          <DialogHeader>\n            <DialogTitle>Edit Company</DialogTitle>\n            <DialogDescription>Update company information.</DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-name\">Company Name *</Label>\n              <Input\n                id=\"edit-name\"\n                value={formData.name}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                data-testid=\"input-edit-company-name\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-contactName\">Contact Name</Label>\n              <Input\n                id=\"edit-contactName\"\n                value={formData.contactName ?? ''}\n                onChange={(e) => setFormData({ ...formData, contactName: e.target.value })}\n                data-testid=\"input-edit-contact-name\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-contactEmail\">Contact Email</Label>\n              <Input\n                id=\"edit-contactEmail\"\n                type=\"email\"\n                value={formData.contactEmail ?? ''}\n                onChange={(e) => setFormData({ ...formData, contactEmail: e.target.value })}\n                data-testid=\"input-edit-contact-email\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-contactPhone\">Contact Phone</Label>\n              <Input\n                id=\"edit-contactPhone\"\n                value={formData.contactPhone ?? ''}\n                onChange={(e) => setFormData({ ...formData, contactPhone: e.target.value })}\n                data-testid=\"input-edit-contact-phone\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-billingAddress\">Billing Address</Label>\n              <Textarea\n                id=\"edit-billingAddress\"\n                value={formData.billingAddress ?? ''}\n                onChange={(e) => setFormData({ ...formData, billingAddress: e.target.value })}\n                data-testid=\"input-edit-billing-address\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-notes\">Notes</Label>\n              <Textarea\n                id=\"edit-notes\"\n                value={formData.notes ?? ''}\n                onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                data-testid=\"input-edit-notes\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsEditDialogOpen(false)} data-testid=\"button-cancel-edit\">\n              Cancel\n            </Button>\n            <Button\n              onClick={handleUpdate}\n              disabled={updateMutation.isPending}\n              data-testid=\"button-submit-edit\"\n            >\n              {updateMutation.isPending ? 'Updating...' : 'Update Company'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Confirmation Dialog */}\n      <Dialog open={isDeleteDialogOpen} onOpenChange={setIsDeleteDialogOpen}>\n        <DialogContent data-testid=\"dialog-delete-company\">\n          <DialogHeader>\n            <DialogTitle>Delete Company</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete \"{selectedCompany?.name}\"? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsDeleteDialogOpen(false)} data-testid=\"button-cancel-delete\">\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={confirmDelete}\n              disabled={deleteMutation.isPending}\n              data-testid=\"button-confirm-delete\"\n            >\n              {deleteMutation.isPending ? 'Deleting...' : 'Delete'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":17502,"size_tokens":null},"client/src/pages/sessions.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { Link } from 'wouter';\nimport { ArrowLeft, Plus, Edit, XCircle, Star } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { useToast } from '@/hooks/use-toast';\nimport { useAuth } from '@/context/AuthContext';\nimport { postJson, patchJson, queryClient } from '@/lib/queryClient';\nimport type { StormSession, InsertStormSession } from '@shared/schema';\nimport { insertStormSessionSchema } from '@shared/schema';\nimport { Badge } from '@/components/ui/badge';\nimport { Checkbox } from '@/components/ui/checkbox';\n\nexport default function SessionsPage() {\n  const { user, logout } = useAuth();\n  const { toast } = useToast();\n  \n  const [isCreateDialogOpen, setIsCreateDialogOpen] = useState(false);\n  const [isEditDialogOpen, setIsEditDialogOpen] = useState(false);\n  const [isCloseDialogOpen, setIsCloseDialogOpen] = useState(false);\n  const [selectedSession, setSelectedSession] = useState<StormSession | null>(null);\n  const [formData, setFormData] = useState<Partial<InsertStormSession>>({\n    name: '',\n    startDate: undefined,\n    location: '',\n    client: '',\n    status: 'DRAFT',\n    isActive: false,\n  });\n\n  const resetForm = () => {\n    setFormData({\n      name: '',\n      startDate: undefined,\n      location: '',\n      client: '',\n      status: 'DRAFT',\n      isActive: false,\n    });\n  };\n\n  // Check if user can manage sessions (ADMIN or MANAGER)\n  const canManageSessions = user?.role === 'ADMIN' || user?.role === 'MANAGER';\n\n  const { data: sessions, isLoading } = useQuery<StormSession[]>({\n    queryKey: ['/api/storm-sessions'],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: async (data: InsertStormSession) => {\n      console.log('Creating session with data:', data);\n      return await postJson('/api/storm-sessions', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/storm-sessions'] });\n      setIsCreateDialogOpen(false);\n      resetForm();\n      toast({ title: 'Session created successfully' });\n    },\n    onError: (error: any) => {\n      console.error('Create session error:', error);\n      toast({ title: 'Failed to create session', description: error?.message || 'Unknown error', variant: 'destructive' });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertStormSession> }) => {\n      return await patchJson(`/api/storm-sessions/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/storm-sessions'] });\n      setIsEditDialogOpen(false);\n      setSelectedSession(null);\n      resetForm();\n      toast({ title: 'Session updated successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to update session', variant: 'destructive' });\n    },\n  });\n\n  const closeMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await postJson(`/api/storm-sessions/${id}/close`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/storm-sessions'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/storm-sessions/active'] });\n      setIsCloseDialogOpen(false);\n      setSelectedSession(null);\n      toast({ title: 'Session closed successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to close session', variant: 'destructive' });\n    },\n  });\n\n  const reopenMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await postJson(`/api/storm-sessions/${id}/reopen`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/storm-sessions'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/storm-sessions/active'] });\n      toast({ title: 'Session reopened successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to reopen session', variant: 'destructive' });\n    },\n  });\n\n  const activateMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await postJson(`/api/storm-sessions/${id}/activate`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/storm-sessions'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/storm-sessions/active'] });\n      toast({ title: 'Session activated successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to activate session', variant: 'destructive' });\n    },\n  });\n\n  const deactivateMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await postJson(`/api/storm-sessions/${id}/deactivate`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/storm-sessions'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/storm-sessions/active'] });\n      toast({ title: 'Session deactivated successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to deactivate session', variant: 'destructive' });\n    },\n  });\n\n  const handleCreate = () => {\n    console.log('handleCreate called with formData:', formData);\n    if (!formData.name) {\n      toast({ title: 'Please enter a session name', variant: 'destructive' });\n      return;\n    }\n    console.log('Calling createMutation.mutate with:', formData);\n    createMutation.mutate(formData as InsertStormSession);\n  };\n\n  const handleEdit = (session: StormSession) => {\n    setSelectedSession(session);\n    setFormData({\n      name: session.name,\n      startDate: session.startDate ?? undefined,\n      location: session.location || '',\n      client: session.client || '',\n      status: session.status,\n    });\n    setIsEditDialogOpen(true);\n  };\n\n  const handleUpdate = () => {\n    if (!selectedSession) return;\n    updateMutation.mutate({ id: selectedSession.id, data: formData });\n  };\n\n  const handleCloseSession = (session: StormSession) => {\n    setSelectedSession(session);\n    setIsCloseDialogOpen(true);\n  };\n\n  const confirmClose = () => {\n    if (!selectedSession) return;\n    closeMutation.mutate(selectedSession.id);\n  };\n\n  const getStatusBadge = (status: string) => {\n    const variants: Record<string, 'default' | 'secondary' | 'destructive' | 'outline'> = {\n      DRAFT: 'secondary',\n      ACTIVE: 'default',\n      CLOSED: 'outline',\n    };\n    return <Badge variant={variants[status] || 'default'} data-testid={`badge-status-${status.toLowerCase()}`}>{status}</Badge>;\n  };\n\n  const formatDate = (date: Date | null | undefined) => {\n    if (!date) return 'Not set';\n    return new Date(date).toLocaleDateString();\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n      <header className=\"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10\">\n        <div className=\"max-w-7xl mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <div>\n                <h1 className=\"text-2xl font-bold text-gray-900 dark:text-white\">Storm Sessions</h1>\n                <p className=\"text-sm text-gray-600 dark:text-gray-400\">Manage storm response sessions</p>\n              </div>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <Link href=\"/\">\n                <Button variant=\"outline\" size=\"sm\" data-testid=\"button-back-dashboard\">\n                  <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                  Dashboard\n                </Button>\n              </Link>\n              <Button variant=\"outline\" size=\"sm\" onClick={logout} data-testid=\"button-logout\">\n                Logout\n              </Button>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <main className=\"max-w-7xl mx-auto px-4 py-8\">\n        <Card>\n          <CardHeader>\n            <div className=\"flex items-center justify-between\">\n              <div>\n                <CardTitle>Sessions</CardTitle>\n                <CardDescription>View and manage storm response sessions</CardDescription>\n              </div>\n              {canManageSessions && (\n                <Button onClick={() => setIsCreateDialogOpen(true)} data-testid=\"button-create-session\">\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Create Session\n                </Button>\n              )}\n            </div>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">Loading sessions...</div>\n            ) : !sessions || sessions.length === 0 ? (\n              <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">\n                No sessions found. {canManageSessions && 'Create one to get started!'}\n              </div>\n            ) : (\n              <Table data-testid=\"table-sessions\">\n                <TableHeader>\n                  <TableRow>\n                    <TableHead>Name</TableHead>\n                    <TableHead>Location</TableHead>\n                    <TableHead>Client</TableHead>\n                    <TableHead>Status</TableHead>\n                    <TableHead>Start Date</TableHead>\n                    <TableHead>Active</TableHead>\n                    {canManageSessions && <TableHead className=\"text-right\">Actions</TableHead>}\n                  </TableRow>\n                </TableHeader>\n                <TableBody>\n                  {sessions.map((session) => (\n                    <TableRow key={session.id} data-testid={`row-session-${session.id}`}>\n                      <TableCell className=\"font-medium\">{session.name}</TableCell>\n                      <TableCell>{session.location || '-'}</TableCell>\n                      <TableCell>{session.client || '-'}</TableCell>\n                      <TableCell>{getStatusBadge(session.status)}</TableCell>\n                      <TableCell>{formatDate(session.startDate)}</TableCell>\n                      <TableCell>\n                        {canManageSessions ? (\n                          <Button\n                            variant=\"ghost\"\n                            size=\"sm\"\n                            onClick={() => session.isActive ? deactivateMutation.mutate(session.id) : activateMutation.mutate(session.id)}\n                            disabled={session.status === 'CLOSED' || activateMutation.isPending || deactivateMutation.isPending}\n                            data-testid={`button-toggle-active-${session.id}`}\n                          >\n                            <Star className={`w-5 h-5 ${session.isActive ? 'text-yellow-500 fill-yellow-500' : 'text-gray-400'}`} />\n                          </Button>\n                        ) : (\n                          session.isActive && (\n                            <Star className=\"w-5 h-5 text-yellow-500 fill-yellow-500\" data-testid={`icon-active-${session.id}`} />\n                          )\n                        )}\n                      </TableCell>\n                      {canManageSessions && (\n                        <TableCell className=\"text-right\">\n                          <div className=\"flex justify-end gap-2\">\n                            {session.status === 'CLOSED' ? (\n                              <Button\n                                variant=\"outline\"\n                                size=\"sm\"\n                                onClick={() => reopenMutation.mutate(session.id)}\n                                disabled={reopenMutation.isPending}\n                                data-testid={`button-reopen-${session.id}`}\n                              >\n                                Reopen\n                              </Button>\n                            ) : (\n                              <>\n                                <Button\n                                  variant=\"outline\"\n                                  size=\"sm\"\n                                  onClick={() => handleEdit(session)}\n                                  data-testid={`button-edit-${session.id}`}\n                                >\n                                  <Edit className=\"w-4 h-4\" />\n                                </Button>\n                                <Button\n                                  variant=\"outline\"\n                                  size=\"sm\"\n                                  onClick={() => handleCloseSession(session)}\n                                  data-testid={`button-close-${session.id}`}\n                                >\n                                  <XCircle className=\"w-4 h-4\" />\n                                </Button>\n                              </>\n                            )}\n                          </div>\n                        </TableCell>\n                      )}\n                    </TableRow>\n                  ))}\n                </TableBody>\n              </Table>\n            )}\n          </CardContent>\n        </Card>\n      </main>\n\n      {/* Create Dialog */}\n      <Dialog open={isCreateDialogOpen} onOpenChange={setIsCreateDialogOpen}>\n        <DialogContent data-testid=\"dialog-create-session\">\n          <DialogHeader>\n            <DialogTitle>Create New Session</DialogTitle>\n            <DialogDescription>Create a new storm response session.</DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"name\">Session Name *</Label>\n              <Input\n                id=\"name\"\n                value={formData.name ?? ''}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                placeholder=\"Hurricane Response 2024\"\n                data-testid=\"input-session-name\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"startDate\">Start Date *</Label>\n              <Input\n                id=\"startDate\"\n                type=\"date\"\n                value={formData.startDate ? new Date(formData.startDate).toISOString().split('T')[0] : ''}\n                onChange={(e) => setFormData({ ...formData, startDate: e.target.value ? new Date(e.target.value) : undefined })}\n                data-testid=\"input-start-date\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"location\">Location *</Label>\n              <Input\n                id=\"location\"\n                value={formData.location ?? ''}\n                onChange={(e) => setFormData({ ...formData, location: e.target.value })}\n                placeholder=\"e.g., Florida Panhandle\"\n                data-testid=\"input-location\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"client\">Client (Optional)</Label>\n              <Input\n                id=\"client\"\n                value={formData.client ?? ''}\n                onChange={(e) => setFormData({ ...formData, client: e.target.value })}\n                placeholder=\"e.g., Duke Energy\"\n                data-testid=\"input-client\"\n              />\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <Checkbox\n                id=\"isActive\"\n                checked={formData.isActive ?? false}\n                onCheckedChange={(checked) => setFormData({ ...formData, isActive: checked as boolean })}\n                data-testid=\"checkbox-is-active\"\n              />\n              <Label htmlFor=\"isActive\" className=\"text-sm font-normal cursor-pointer\">\n                Mark as Active Session\n              </Label>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsCreateDialogOpen(false)} data-testid=\"button-cancel-create\">\n              Cancel\n            </Button>\n            <Button\n              onClick={handleCreate}\n              disabled={createMutation.isPending}\n              data-testid=\"button-submit-create\"\n            >\n              {createMutation.isPending ? 'Creating...' : 'Create Session'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Dialog */}\n      <Dialog open={isEditDialogOpen} onOpenChange={setIsEditDialogOpen}>\n        <DialogContent data-testid=\"dialog-edit-session\">\n          <DialogHeader>\n            <DialogTitle>Edit Session</DialogTitle>\n            <DialogDescription>Update session information.</DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-name\">Session Name *</Label>\n              <Input\n                id=\"edit-name\"\n                value={formData.name ?? ''}\n                onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                data-testid=\"input-edit-session-name\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-startDate\">Start Date *</Label>\n              <Input\n                id=\"edit-startDate\"\n                type=\"date\"\n                value={formData.startDate ? new Date(formData.startDate).toISOString().split('T')[0] : ''}\n                onChange={(e) => setFormData({ ...formData, startDate: e.target.value ? new Date(e.target.value) : undefined })}\n                data-testid=\"input-edit-start-date\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-location\">Location *</Label>\n              <Input\n                id=\"edit-location\"\n                value={formData.location ?? ''}\n                onChange={(e) => setFormData({ ...formData, location: e.target.value })}\n                data-testid=\"input-edit-location\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-client\">Client (Optional)</Label>\n              <Input\n                id=\"edit-client\"\n                value={formData.client ?? ''}\n                onChange={(e) => setFormData({ ...formData, client: e.target.value })}\n                data-testid=\"input-edit-client\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsEditDialogOpen(false)} data-testid=\"button-cancel-edit\">\n              Cancel\n            </Button>\n            <Button\n              onClick={handleUpdate}\n              disabled={updateMutation.isPending}\n              data-testid=\"button-submit-edit\"\n            >\n              {updateMutation.isPending ? 'Updating...' : 'Update Session'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Close Session Dialog */}\n      <Dialog open={isCloseDialogOpen} onOpenChange={setIsCloseDialogOpen}>\n        <DialogContent data-testid=\"dialog-close-session\">\n          <DialogHeader>\n            <DialogTitle>Close Session</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to close \"{selectedSession?.name}\"? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsCloseDialogOpen(false)} data-testid=\"button-cancel-close\">\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={confirmClose}\n              disabled={closeMutation.isPending}\n              data-testid=\"button-confirm-close\"\n            >\n              {closeMutation.isPending ? 'Closing...' : 'Close Session'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n","path":null,"size_bytes":20137,"size_tokens":null},"client/src/pages/rosters.tsx":{"content":"import { useState, useEffect, useRef } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { Link } from 'wouter';\nimport { ArrowLeft, Plus, Edit, Trash2, ChevronDown, ChevronRight, Users, Upload, Download, UserPlus, FileDown } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from '@/components/ui/dialog';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { useToast } from '@/hooks/use-toast';\nimport { useAuth } from '@/context/AuthContext';\nimport { useActiveSession } from '@/context/ActiveSessionContext';\nimport { getJson, postJson, patchJson, deleteJson, queryClient } from '@/lib/queryClient';\nimport type { Roster, InsertRoster, Crew, InsertCrew, StormSession, Company, Contractor } from '@shared/schema';\nimport { insertRosterSchema } from '@shared/schema';\nimport { Badge } from '@/components/ui/badge';\n\nexport default function RostersPage() {\n  const { user, logout } = useAuth();\n  const { activeSession } = useActiveSession();\n  const { toast } = useToast();\n  \n  const [selectedSessionId, setSelectedSessionId] = useState<string>('');\n  const [hasUserSelectedSession, setHasUserSelectedSession] = useState(false);\n  const [expandedRosters, setExpandedRosters] = useState<Set<string>>(new Set());\n  const [isCreateRosterOpen, setIsCreateRosterOpen] = useState(false);\n  const [isChooseMethodOpen, setIsChooseMethodOpen] = useState(false);\n  const [isImportExcelOpen, setIsImportExcelOpen] = useState(false);\n  const [isEditRosterOpen, setIsEditRosterOpen] = useState(false);\n  const [isDeleteRosterOpen, setIsDeleteRosterOpen] = useState(false);\n  const [isCreateCrewOpen, setIsCreateCrewOpen] = useState(false);\n  const [isEditCrewOpen, setIsEditCrewOpen] = useState(false);\n  const [isDeleteCrewOpen, setIsDeleteCrewOpen] = useState(false);\n  const [selectedRoster, setSelectedRoster] = useState<Roster | null>(null);\n  const [selectedCrew, setSelectedCrew] = useState<Crew | null>(null);\n  const [selectedFile, setSelectedFile] = useState<File | null>(null);\n  const [importCompanyId, setImportCompanyId] = useState<string>('');\n  const [contractorSearch, setContractorSearch] = useState('');\n  const [isCustomContractorOpen, setIsCustomContractorOpen] = useState(false);\n  const [customCompanyName, setCustomCompanyName] = useState('');\n  const [customContactName, setCustomContactName] = useState('');\n  const [customContactEmail, setCustomContactEmail] = useState('');\n  const [customContactPhone, setCustomContactPhone] = useState('');\n  const fileInputRef = useRef<HTMLInputElement>(null);\n  const [rosterFormData, setRosterFormData] = useState<Partial<InsertRoster>>({\n    sessionId: '',\n    companyId: '',\n    status: 'DRAFT',\n  });\n  const [crewFormData, setCrewFormData] = useState<Partial<InsertCrew>>({\n    rosterId: '',\n    crewName: '',\n    crewLead: '',\n    workArea: '',\n  });\n\n  const resetRosterForm = () => {\n    setRosterFormData({\n      sessionId: selectedSessionId || '',\n      companyId: user?.companyId || '',\n      status: 'DRAFT',\n    });\n  };\n\n  const resetCrewForm = () => {\n    setCrewFormData({\n      rosterId: '',\n      crewName: '',\n      crewLead: '',\n      workArea: '',\n    });\n  };\n\n  const resetCustomCompanyForm = () => {\n    setCustomCompanyName('');\n    setCustomContactName('');\n    setCustomContactEmail('');\n    setCustomContactPhone('');\n  };\n\n  // Check if user can manage rosters\n  const canManageRosters = user?.role === 'ADMIN' || user?.role === 'MANAGER' || user?.role === 'UTILITY';\n\n  // Fetch sessions\n  const { data: sessions } = useQuery<StormSession[]>({\n    queryKey: ['/api/storm-sessions'],\n  });\n\n  // Sync companies from contractors database\n  const syncCompaniesMutation = useMutation({\n    mutationFn: async () => {\n      return await postJson('/api/companies/sync-from-contractors');\n    },\n    onSuccess: () => {\n      // Refresh companies list after sync\n      queryClient.invalidateQueries({ queryKey: ['/api/companies'] });\n    },\n  });\n\n  // Auto-sync companies on mount\n  useEffect(() => {\n    if (user?.role === 'ADMIN' || user?.role === 'MANAGER' || user?.role === 'UTILITY') {\n      syncCompaniesMutation.mutate();\n    }\n  }, [user?.role]); // eslint-disable-line react-hooks/exhaustive-deps\n\n  // Fetch companies (for ADMIN, MANAGER, and UTILITY users)\n  const { data: companies, isLoading: companiesLoading } = useQuery<Company[]>({\n    queryKey: ['/api/companies'],\n    enabled: user?.role === 'ADMIN' || user?.role === 'MANAGER' || user?.role === 'UTILITY',\n  });\n\n  // Fetch contractors for selection\n  const { data: contractors = [] } = useQuery<Contractor[]>({\n    queryKey: ['/api/contractors'],\n    enabled: user?.role === 'ADMIN' || user?.role === 'MANAGER',\n  });\n\n  // Filter contractors based on search\n  const filteredContractors = contractors.filter(c =>\n    c.company.toLowerCase().includes(contractorSearch.toLowerCase()) ||\n    c.name.toLowerCase().includes(contractorSearch.toLowerCase()) ||\n    c.city?.toLowerCase().includes(contractorSearch.toLowerCase())\n  );\n\n  // Fetch rosters for selected session\n  const { data: rosters, isLoading: rostersLoading } = useQuery<Roster[]>({\n    queryKey: ['/api/rosters', selectedSessionId],\n    queryFn: () => selectedSessionId ? getJson<Roster[]>(`/api/rosters?sessionId=${selectedSessionId}`) : Promise.resolve([]),\n    enabled: !!selectedSessionId,\n  });\n\n\n  // Auto-select active session (or first session as fallback) - only if user hasn't manually selected\n  useEffect(() => {\n    if (sessions && sessions.length > 0 && !hasUserSelectedSession) {\n      if (!selectedSessionId) {\n        // Initial selection: prefer active session\n        if (activeSession && sessions.some(s => s.id === activeSession.id)) {\n          setSelectedSessionId(activeSession.id);\n        } else {\n          setSelectedSessionId(sessions[0].id);\n        }\n      } else if (activeSession && sessions.some(s => s.id === activeSession.id) && selectedSessionId !== activeSession.id) {\n        // Active session became available - switch to it\n        setSelectedSessionId(activeSession.id);\n      }\n    }\n  }, [sessions, selectedSessionId, activeSession, hasUserSelectedSession]);\n\n  const createRosterMutation = useMutation({\n    mutationFn: async (data: InsertRoster) => {\n      return await postJson('/api/rosters', data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters'] });\n      setIsCreateRosterOpen(false);\n      resetRosterForm();\n      toast({ title: 'Roster created successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to create roster', variant: 'destructive' });\n    },\n  });\n\n  const updateRosterMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<InsertRoster> }) => {\n      return await patchJson(`/api/rosters/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters'] });\n      setIsEditRosterOpen(false);\n      setSelectedRoster(null);\n      resetRosterForm();\n      toast({ title: 'Roster updated successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to update roster', variant: 'destructive' });\n    },\n  });\n\n  const deleteRosterMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await deleteJson(`/api/rosters/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters'] });\n      setIsDeleteRosterOpen(false);\n      setSelectedRoster(null);\n      toast({ title: 'Roster deleted successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to delete roster', variant: 'destructive' });\n    },\n  });\n\n  const importExcelMutation = useMutation({\n    mutationFn: async ({ file, sessionId, companyId }: { file: File; sessionId: string; companyId: string }) => {\n      const formData = new FormData();\n      formData.append('file', file);\n      formData.append('sessionId', sessionId);\n      formData.append('companyId', companyId);\n      \n      const response = await fetch('/api/rosters/import-excel', {\n        method: 'POST',\n        body: formData,\n        credentials: 'include',\n      });\n      \n      if (!response.ok) {\n        const error = await response.json();\n        throw new Error(error.message || 'Failed to import roster');\n      }\n      \n      return response.json();\n    },\n    onSuccess: (data) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters', selectedSessionId] });\n      setIsImportExcelOpen(false);\n      setSelectedFile(null);\n      setImportCompanyId('');\n      toast({ \n        title: 'Roster imported successfully',\n        description: `Created ${data.crewCount} crews from Excel file` \n      });\n    },\n    onError: (error: Error) => {\n      toast({ \n        title: 'Failed to import roster', \n        description: error.message,\n        variant: 'destructive' \n      });\n    },\n  });\n\n  const createCrewMutation = useMutation({\n    mutationFn: async ({ rosterId, data }: { rosterId: string; data: Omit<InsertCrew, 'rosterId'> }) => {\n      return await postJson(`/api/rosters/${rosterId}/crews`, data);\n    },\n    onSuccess: (_data, variables) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters', variables.rosterId, 'crews'] });\n      setIsCreateCrewOpen(false);\n      resetCrewForm();\n      toast({ title: 'Crew added successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to add crew', variant: 'destructive' });\n    },\n  });\n\n  const updateCrewMutation = useMutation({\n    mutationFn: async ({ id, data, rosterId }: { id: string; data: Partial<InsertCrew>; rosterId: string }) => {\n      return await patchJson(`/api/crews/${id}`, data);\n    },\n    onSuccess: (_data, variables) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters', variables.rosterId, 'crews'] });\n      setIsEditCrewOpen(false);\n      setSelectedCrew(null);\n      resetCrewForm();\n      toast({ title: 'Crew updated successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to update crew', variant: 'destructive' });\n    },\n  });\n\n  const deleteCrewMutation = useMutation({\n    mutationFn: async ({ id, rosterId }: { id: string; rosterId: string }) => {\n      return await deleteJson(`/api/crews/${id}`);\n    },\n    onSuccess: (_data, variables) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters'] });\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters', variables.rosterId, 'crews'] });\n      setIsDeleteCrewOpen(false);\n      setSelectedCrew(null);\n      toast({ title: 'Crew deleted successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to delete crew', variant: 'destructive' });\n    },\n  });\n\n  const createCustomCompanyMutation = useMutation({\n    mutationFn: async (data: { name: string; contactName?: string; contactEmail?: string; contactPhone?: string }): Promise<Company> => {\n      return await postJson('/api/companies', data) as Company;\n    },\n    onSuccess: (newCompany: Company) => {\n      queryClient.invalidateQueries({ queryKey: ['/api/companies'] });\n      setIsCustomContractorOpen(false);\n      resetCustomCompanyForm();\n      setRosterFormData({ ...rosterFormData, companyId: newCompany.id });\n      setImportCompanyId(newCompany.id);\n      setIsCreateRosterOpen(false);\n      setIsChooseMethodOpen(true);\n      toast({ title: 'Custom contractor added successfully' });\n    },\n    onError: (error: Error) => {\n      toast({ \n        title: 'Failed to add contractor', \n        description: error.message || 'Company may already exist',\n        variant: 'destructive' \n      });\n    },\n  });\n\n  const handleCreateCustomCompany = () => {\n    if (!customCompanyName.trim()) {\n      toast({ title: 'Please enter a company name', variant: 'destructive' });\n      return;\n    }\n    createCustomCompanyMutation.mutate({\n      name: customCompanyName.trim(),\n      contactName: customContactName.trim() || undefined,\n      contactEmail: customContactEmail.trim() || undefined,\n      contactPhone: customContactPhone.trim() || undefined,\n    });\n  };\n\n  const handleDownloadTemplate = async () => {\n    try {\n      const response = await fetch('/api/rosters/template', {\n        method: 'GET',\n        credentials: 'include',\n      });\n      \n      if (!response.ok) {\n        throw new Error('Failed to download template');\n      }\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = 'roster-import-template.xlsx';\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({ title: 'Template downloaded successfully' });\n    } catch (error) {\n      toast({ title: 'Failed to download template', variant: 'destructive' });\n    }\n  };\n\n  const handleCreateRoster = () => {\n    // For non-UTILITY users, use their companyId\n    const dataToSubmit = {\n      ...rosterFormData,\n      companyId: user?.role === 'UTILITY' ? rosterFormData.companyId : user?.companyId,\n    };\n    \n    if (!dataToSubmit.companyId) {\n      toast({ title: 'Company assignment required', variant: 'destructive' });\n      return;\n    }\n    \n    createRosterMutation.mutate(dataToSubmit as InsertRoster);\n  };\n\n  const handleEditRoster = (roster: Roster) => {\n    setSelectedRoster(roster);\n    setRosterFormData({\n      sessionId: roster.sessionId,\n      companyId: roster.companyId,\n      status: roster.status,\n    });\n    setIsEditRosterOpen(true);\n  };\n\n  const handleUpdateRoster = () => {\n    if (!selectedRoster) return;\n    updateRosterMutation.mutate({ id: selectedRoster.id, data: rosterFormData });\n  };\n\n  const handleDeleteRoster = (roster: Roster) => {\n    setSelectedRoster(roster);\n    setIsDeleteRosterOpen(true);\n  };\n\n  const confirmDeleteRoster = () => {\n    if (!selectedRoster) return;\n    deleteRosterMutation.mutate(selectedRoster.id);\n  };\n\n  const handleCreateCrew = (roster: Roster) => {\n    setSelectedRoster(roster);\n    setCrewFormData({\n      rosterId: roster.id,\n      crewName: '',\n      crewLead: '',\n      workArea: '',\n    });\n    setIsCreateCrewOpen(true);\n  };\n\n  const handleSubmitCrew = () => {\n    if (!selectedRoster) return;\n    if (!crewFormData.crewName) {\n      toast({ title: 'Please fill in crew name', variant: 'destructive' });\n      return;\n    }\n    try {\n      const { rosterId, ...crewData } = crewFormData;\n      createCrewMutation.mutate({ rosterId: selectedRoster.id, data: crewData as Omit<InsertCrew, 'rosterId'> });\n    } catch (error) {\n      toast({ title: 'Failed to create crew', variant: 'destructive' });\n    }\n  };\n\n  const handleEditCrew = (crew: Crew) => {\n    setSelectedCrew(crew);\n    setCrewFormData({\n      rosterId: crew.rosterId,\n      crewName: crew.crewName,\n      crewLead: crew.crewLead ?? '',\n      workArea: crew.workArea ?? '',\n    });\n    setIsEditCrewOpen(true);\n  };\n\n  const handleUpdateCrew = () => {\n    if (!selectedCrew) return;\n    const { rosterId, ...crewData } = crewFormData;\n    updateCrewMutation.mutate({ id: selectedCrew.id, data: crewData, rosterId: selectedCrew.rosterId });\n  };\n\n  const handleDeleteCrew = (crew: Crew) => {\n    setSelectedCrew(crew);\n    setIsDeleteCrewOpen(true);\n  };\n\n  const confirmDeleteCrew = () => {\n    if (!selectedCrew) return;\n    deleteCrewMutation.mutate({ id: selectedCrew.id, rosterId: selectedCrew.rosterId });\n  };\n\n  const toggleRosterExpanded = (rosterId: string) => {\n    const newExpanded = new Set(expandedRosters);\n    if (newExpanded.has(rosterId)) {\n      newExpanded.delete(rosterId);\n    } else {\n      newExpanded.add(rosterId);\n    }\n    setExpandedRosters(newExpanded);\n  };\n\n  const handleFileChange = (event: React.ChangeEvent<HTMLInputElement>) => {\n    const file = event.target.files?.[0];\n    if (file) {\n      if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {\n        toast({ \n          title: 'Invalid file type', \n          description: 'Please select an Excel file (.xlsx or .xls)',\n          variant: 'destructive' \n        });\n        return;\n      }\n      setSelectedFile(file);\n    }\n  };\n\n  const handleImportExcel = () => {\n    if (!selectedFile || !selectedSessionId) {\n      toast({ title: 'Please select a file and session', variant: 'destructive' });\n      return;\n    }\n\n    const companyId = (user?.role === 'ADMIN' || user?.role === 'UTILITY') ? importCompanyId : user?.companyId;\n    if (!companyId) {\n      toast({ title: 'Company selection required', variant: 'destructive' });\n      return;\n    }\n\n    importExcelMutation.mutate({ \n      file: selectedFile, \n      sessionId: selectedSessionId, \n      companyId \n    });\n  };\n\n  const openImportDialog = () => {\n    setImportCompanyId(user?.companyId || '');\n    setSelectedFile(null);\n    setIsImportExcelOpen(true);\n  };\n\n  const handleExportRoster = async (rosterId: string) => {\n    try {\n      const response = await fetch(`/api/rosters/${rosterId}/export`, {\n        method: 'GET',\n        credentials: 'include',\n      });\n      \n      if (!response.ok) {\n        throw new Error('Failed to export roster');\n      }\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `roster-${rosterId}.xlsx`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({ title: 'Roster exported successfully' });\n    } catch (error) {\n      toast({ title: 'Failed to export roster', variant: 'destructive' });\n    }\n  };\n\n  const handleExportAll = async () => {\n    try {\n      if (!selectedSessionId) {\n        toast({ title: 'Please select a session first', variant: 'destructive' });\n        return;\n      }\n      \n      const response = await fetch(`/api/rosters/export-all?sessionId=${selectedSessionId}`, {\n        method: 'GET',\n        credentials: 'include',\n      });\n      \n      if (!response.ok) {\n        throw new Error('Failed to export rosters');\n      }\n      \n      const blob = await response.blob();\n      const url = window.URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `all-rosters-${new Date().toISOString().split('T')[0]}.xlsx`;\n      document.body.appendChild(a);\n      a.click();\n      window.URL.revokeObjectURL(url);\n      document.body.removeChild(a);\n      \n      toast({ title: 'All rosters exported successfully' });\n    } catch (error) {\n      toast({ title: 'Failed to export rosters', variant: 'destructive' });\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    const variants: Record<string, 'default' | 'secondary' | 'destructive' | 'outline'> = {\n      DRAFT: 'secondary',\n      SUBMITTED: 'default',\n      APPROVED: 'outline',\n      LOCKED: 'destructive',\n    };\n    return <Badge variant={variants[status] || 'default'} data-testid={`badge-status-${status.toLowerCase()}`}>{status}</Badge>;\n  };\n\n  const getCompanyName = (companyId: string) => {\n    const company = companies?.find(c => c.id === companyId);\n    return company?.name || companyId;\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n      <header className=\"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10\">\n        <div className=\"max-w-7xl mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <div>\n                <h1 className=\"text-2xl font-bold text-gray-900 dark:text-white\">Rosters & Crews</h1>\n                <p className=\"text-sm text-gray-600 dark:text-gray-400\">Manage crew rosters for storm sessions</p>\n              </div>\n            </div>\n            <div className=\"flex items-center space-x-2\">\n              <Link href=\"/\">\n                <Button variant=\"outline\" size=\"sm\" data-testid=\"button-back-dashboard\">\n                  <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                  Dashboard\n                </Button>\n              </Link>\n              <Button variant=\"outline\" size=\"sm\" onClick={logout} data-testid=\"button-logout\">\n                Logout\n              </Button>\n            </div>\n          </div>\n        </div>\n      </header>\n\n      <main className=\"max-w-7xl mx-auto px-4 py-8\">\n        <div className=\"mb-6\">\n          <Label htmlFor=\"session-select\">Select Session</Label>\n          <Select value={selectedSessionId} onValueChange={(value) => { setSelectedSessionId(value); setHasUserSelectedSession(true); }}>\n            <SelectTrigger id=\"session-select\" className=\"w-full max-w-md\" data-testid=\"select-session\">\n              <SelectValue placeholder=\"Choose a session\" />\n            </SelectTrigger>\n            <SelectContent>\n              {sessions?.map((session) => (\n                <SelectItem key={session.id} value={session.id}>\n                  {session.name} ({session.status})\n                  {activeSession?.id === session.id && ' ⭐ ACTIVE'}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n\n        {selectedSessionId && (\n          <Card>\n            <CardHeader>\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <CardTitle>Rosters</CardTitle>\n                  <CardDescription>Crew rosters for the selected session</CardDescription>\n                </div>\n                {canManageRosters && (\n                  <div className=\"flex gap-2\">\n                    <Button \n                      variant=\"outline\"\n                      onClick={() => handleExportAll()} \n                      data-testid=\"button-export-all-rosters\"\n                    >\n                      <Download className=\"w-4 h-4 mr-2\" />\n                      Export All\n                    </Button>\n                    <Button onClick={() => {\n                      resetRosterForm();\n                      setIsCreateRosterOpen(true);\n                    }} data-testid=\"button-create-roster\">\n                      <Plus className=\"w-4 h-4 mr-2\" />\n                      Create Roster\n                    </Button>\n                  </div>\n                )}\n              </div>\n            </CardHeader>\n            <CardContent>\n              {rostersLoading ? (\n                <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">Loading rosters...</div>\n              ) : !rosters || rosters.length === 0 ? (\n                <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">\n                  No rosters found. {canManageRosters && 'Create one to get started!'}\n                </div>\n              ) : (\n                <div className=\"space-y-4\">\n                  {rosters.map((roster) => (\n                    <RosterRow\n                      key={roster.id}\n                      roster={roster}\n                      isExpanded={expandedRosters.has(roster.id)}\n                      onToggle={() => toggleRosterExpanded(roster.id)}\n                      onEdit={() => handleEditRoster(roster)}\n                      onDelete={() => handleDeleteRoster(roster)}\n                      onAddCrew={() => handleCreateCrew(roster)}\n                      onExport={() => handleExportRoster(roster.id)}\n                      getStatusBadge={getStatusBadge}\n                      getCompanyName={getCompanyName}\n                      canManageRosters={canManageRosters}\n                      onEditCrew={handleEditCrew}\n                      onDeleteCrew={handleDeleteCrew}\n                    />\n                  ))}\n                </div>\n              )}\n            </CardContent>\n          </Card>\n        )}\n      </main>\n\n      {/* Create Roster Dialog */}\n      <Dialog open={isCreateRosterOpen} onOpenChange={setIsCreateRosterOpen}>\n        <DialogContent className=\"max-w-2xl max-h-[80vh]\" data-testid=\"dialog-create-roster\">\n          <DialogHeader>\n            <DialogTitle>Select Contractor for Roster</DialogTitle>\n            <DialogDescription>Search and select a contractor, then import or manually create roster.</DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"contractor-search\">Search Contractors</Label>\n              <Input\n                id=\"contractor-search\"\n                placeholder=\"Search by company, name, or location...\"\n                value={contractorSearch}\n                onChange={(e) => setContractorSearch(e.target.value)}\n                data-testid=\"input-contractor-search\"\n              />\n            </div>\n            <div className=\"border rounded-lg max-h-[300px] overflow-y-auto\">\n              {filteredContractors.length === 0 ? (\n                <div className=\"text-center py-8 text-gray-500\">\n                  {contractorSearch ? 'No contractors found matching your search' : 'Start typing to search contractors'}\n                </div>\n              ) : (\n                <div className=\"divide-y\">\n                  {filteredContractors.map((contractor) => {\n                    const matchingCompany = companies?.find(c => c.name === contractor.company);\n                    return (\n                      <div\n                        key={contractor.id}\n                        className=\"p-3 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer\"\n                        onClick={() => {\n                          if (!matchingCompany) {\n                            toast({\n                              title: 'Company not found',\n                              description: 'Please sync companies first',\n                              variant: 'destructive'\n                            });\n                            return;\n                          }\n                          setRosterFormData({ ...rosterFormData, companyId: matchingCompany.id });\n                          setImportCompanyId(matchingCompany.id);\n                          setIsCreateRosterOpen(false);\n                          setIsChooseMethodOpen(true);\n                          setContractorSearch('');\n                        }}\n                        data-testid={`contractor-item-${contractor.id}`}\n                      >\n                        <div className=\"font-medium\">{contractor.company}</div>\n                        <div className=\"text-sm text-gray-600 dark:text-gray-400\">\n                          {contractor.name} • {contractor.city}, {contractor.state}\n                        </div>\n                      </div>\n                    );\n                  })}\n                </div>\n              )}\n            </div>\n          </div>\n          {(user?.role === 'MANAGER' || user?.role === 'UTILITY') && (\n            <div className=\"border-t pt-4 mt-2\">\n              <Button\n                variant=\"outline\"\n                className=\"w-full\"\n                onClick={() => {\n                  setIsCreateRosterOpen(false);\n                  setContractorSearch('');\n                  setIsCustomContractorOpen(true);\n                }}\n                data-testid=\"button-add-custom-contractor\"\n              >\n                <UserPlus className=\"w-4 h-4 mr-2\" />\n                Add Custom Contractor\n              </Button>\n              <p className=\"text-xs text-gray-500 mt-2 text-center\">\n                Can't find a contractor? Add them manually.\n              </p>\n            </div>\n          )}\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => {\n              setIsCreateRosterOpen(false);\n              setContractorSearch('');\n              resetRosterForm();\n            }} data-testid=\"button-cancel-create-roster\">\n              Cancel\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Add Custom Contractor Dialog */}\n      <Dialog open={isCustomContractorOpen} onOpenChange={setIsCustomContractorOpen}>\n        <DialogContent data-testid=\"dialog-custom-contractor\">\n          <DialogHeader>\n            <DialogTitle>Add Custom Contractor</DialogTitle>\n            <DialogDescription>\n              Enter details for a contractor not in the system.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"custom-company-name\">Company Name *</Label>\n              <Input\n                id=\"custom-company-name\"\n                placeholder=\"Enter company name\"\n                value={customCompanyName}\n                onChange={(e) => setCustomCompanyName(e.target.value)}\n                data-testid=\"input-custom-company-name\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"custom-contact-name\">Contact Name</Label>\n              <Input\n                id=\"custom-contact-name\"\n                placeholder=\"Enter contact name (optional)\"\n                value={customContactName}\n                onChange={(e) => setCustomContactName(e.target.value)}\n                data-testid=\"input-custom-contact-name\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"custom-contact-email\">Contact Email</Label>\n              <Input\n                id=\"custom-contact-email\"\n                type=\"email\"\n                placeholder=\"Enter contact email (optional)\"\n                value={customContactEmail}\n                onChange={(e) => setCustomContactEmail(e.target.value)}\n                data-testid=\"input-custom-contact-email\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"custom-contact-phone\">Contact Phone</Label>\n              <Input\n                id=\"custom-contact-phone\"\n                type=\"tel\"\n                placeholder=\"Enter contact phone (optional)\"\n                value={customContactPhone}\n                onChange={(e) => setCustomContactPhone(e.target.value)}\n                data-testid=\"input-custom-contact-phone\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => {\n              setIsCustomContractorOpen(false);\n              resetCustomCompanyForm();\n              setIsCreateRosterOpen(true);\n            }} data-testid=\"button-back-to-search\">\n              Back to Search\n            </Button>\n            <Button \n              onClick={handleCreateCustomCompany}\n              disabled={createCustomCompanyMutation.isPending || !customCompanyName.trim()}\n              data-testid=\"button-create-custom-contractor\"\n            >\n              {createCustomCompanyMutation.isPending ? 'Creating...' : 'Add Contractor'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Choose Method Dialog */}\n      <Dialog open={isChooseMethodOpen} onOpenChange={setIsChooseMethodOpen}>\n        <DialogContent data-testid=\"dialog-choose-method\">\n          <DialogHeader>\n            <DialogTitle>Create Roster</DialogTitle>\n            <DialogDescription>\n              Contractor selected: {rosterFormData.companyId}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-6\">\n            <Button\n              variant=\"outline\"\n              size=\"lg\"\n              onClick={() => {\n                setIsChooseMethodOpen(false);\n                setIsImportExcelOpen(true);\n              }}\n              className=\"h-auto py-6 justify-start\"\n              data-testid=\"button-choose-import\"\n            >\n              <div className=\"text-left\">\n                <div className=\"flex items-center gap-2 mb-1\">\n                  <Upload className=\"w-5 h-5\" />\n                  <span className=\"font-semibold\">Import from Excel</span>\n                </div>\n                <p className=\"text-sm text-gray-600 dark:text-gray-400 font-normal\">\n                  Upload an Excel file with CREW and EQUIPMENTS sheets\n                </p>\n              </div>\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"lg\"\n              onClick={() => {\n                setIsChooseMethodOpen(false);\n                handleCreateRoster();\n              }}\n              className=\"h-auto py-6 justify-start\"\n              data-testid=\"button-choose-manual\"\n            >\n              <div className=\"text-left\">\n                <div className=\"flex items-center gap-2 mb-1\">\n                  <Plus className=\"w-5 h-5\" />\n                  <span className=\"font-semibold\">Create Manually</span>\n                </div>\n                <p className=\"text-sm text-gray-600 dark:text-gray-400 font-normal\">\n                  Add crew and equipment entries one by one\n                </p>\n              </div>\n            </Button>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => {\n              setIsChooseMethodOpen(false);\n              setIsCreateRosterOpen(true);\n            }} data-testid=\"button-back-to-contractor\">\n              Back to Contractor Selection\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Import Excel Roster Dialog */}\n      <Dialog open={isImportExcelOpen} onOpenChange={setIsImportExcelOpen}>\n        <DialogContent data-testid=\"dialog-import-excel\">\n          <DialogHeader>\n            <DialogTitle>Import Roster from Excel</DialogTitle>\n            <DialogDescription>\n              Contractor: {importCompanyId}\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"excel-file\">Excel File *</Label>\n              <Input\n                id=\"excel-file\"\n                type=\"file\"\n                accept=\".xlsx,.xls\"\n                onChange={handleFileChange}\n                ref={fileInputRef}\n                data-testid=\"input-excel-file\"\n              />\n              {selectedFile && (\n                <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                  Selected: {selectedFile.name}\n                </p>\n              )}\n            </div>\n            <div className=\"bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-md p-3\">\n              <p className=\"text-sm text-blue-800 dark:text-blue-200\">\n                <strong>Required sheets:</strong> CREW (personnel data) and EQUIPMENTS (optional)\n              </p>\n              <Button\n                variant=\"link\"\n                size=\"sm\"\n                className=\"mt-2 h-auto p-0 text-blue-700 dark:text-blue-300\"\n                onClick={handleDownloadTemplate}\n                data-testid=\"button-download-template\"\n              >\n                <FileDown className=\"w-4 h-4 mr-1\" />\n                Download Template\n              </Button>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsImportExcelOpen(false)} data-testid=\"button-cancel-import\">\n              Cancel\n            </Button>\n            <Button\n              onClick={handleImportExcel}\n              disabled={!selectedFile || importExcelMutation.isPending}\n              data-testid=\"button-submit-import\"\n            >\n              {importExcelMutation.isPending ? 'Importing...' : 'Import Roster'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Roster Dialog */}\n      <Dialog open={isEditRosterOpen} onOpenChange={setIsEditRosterOpen}>\n        <DialogContent data-testid=\"dialog-edit-roster\">\n          <DialogHeader>\n            <DialogTitle>Edit Roster</DialogTitle>\n            <DialogDescription>Update roster status.</DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-status\">Status</Label>\n              <Select value={rosterFormData.status} onValueChange={(value) => setRosterFormData({ ...rosterFormData, status: value })}>\n                <SelectTrigger id=\"edit-status\" data-testid=\"select-edit-status\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"DRAFT\">DRAFT</SelectItem>\n                  <SelectItem value=\"SUBMITTED\">SUBMITTED</SelectItem>\n                  <SelectItem value=\"APPROVED\">APPROVED</SelectItem>\n                  <SelectItem value=\"LOCKED\">LOCKED</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsEditRosterOpen(false)} data-testid=\"button-cancel-edit-roster\">\n              Cancel\n            </Button>\n            <Button\n              onClick={handleUpdateRoster}\n              disabled={updateRosterMutation.isPending}\n              data-testid=\"button-submit-edit-roster\"\n            >\n              {updateRosterMutation.isPending ? 'Updating...' : 'Update Roster'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Roster Dialog */}\n      <Dialog open={isDeleteRosterOpen} onOpenChange={setIsDeleteRosterOpen}>\n        <DialogContent data-testid=\"dialog-delete-roster\">\n          <DialogHeader>\n            <DialogTitle>Delete Roster</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete this roster? All crews will be deleted. This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsDeleteRosterOpen(false)} data-testid=\"button-cancel-delete-roster\">\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={confirmDeleteRoster}\n              disabled={deleteRosterMutation.isPending}\n              data-testid=\"button-confirm-delete-roster\"\n            >\n              {deleteRosterMutation.isPending ? 'Deleting...' : 'Delete Roster'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Create Crew Dialog */}\n      <Dialog open={isCreateCrewOpen} onOpenChange={setIsCreateCrewOpen}>\n        <DialogContent data-testid=\"dialog-create-crew\">\n          <DialogHeader>\n            <DialogTitle>Add Crew</DialogTitle>\n            <DialogDescription>Add a new crew to the roster.</DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"crew-name\">Crew Name *</Label>\n              <Input\n                id=\"crew-name\"\n                value={crewFormData.crewName ?? ''}\n                onChange={(e) => setCrewFormData({ ...crewFormData, crewName: e.target.value })}\n                placeholder=\"Alpha Team\"\n                data-testid=\"input-crew-name\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"crew-lead\">Crew Lead</Label>\n              <Input\n                id=\"crew-lead\"\n                value={crewFormData.crewLead ?? ''}\n                onChange={(e) => setCrewFormData({ ...crewFormData, crewLead: e.target.value })}\n                placeholder=\"John Smith\"\n                data-testid=\"input-crew-lead\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"work-area\">Work Area</Label>\n              <Input\n                id=\"work-area\"\n                value={crewFormData.workArea ?? ''}\n                onChange={(e) => setCrewFormData({ ...crewFormData, workArea: e.target.value })}\n                placeholder=\"North District\"\n                data-testid=\"input-work-area\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsCreateCrewOpen(false)} data-testid=\"button-cancel-create-crew\">\n              Cancel\n            </Button>\n            <Button\n              onClick={handleSubmitCrew}\n              disabled={createCrewMutation.isPending}\n              data-testid=\"button-submit-create-crew\"\n            >\n              {createCrewMutation.isPending ? 'Adding...' : 'Add Crew'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Edit Crew Dialog */}\n      <Dialog open={isEditCrewOpen} onOpenChange={setIsEditCrewOpen}>\n        <DialogContent data-testid=\"dialog-edit-crew\">\n          <DialogHeader>\n            <DialogTitle>Edit Crew</DialogTitle>\n            <DialogDescription>Update crew information.</DialogDescription>\n          </DialogHeader>\n          <div className=\"grid gap-4 py-4\">\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-crew-name\">Crew Name *</Label>\n              <Input\n                id=\"edit-crew-name\"\n                value={crewFormData.crewName ?? ''}\n                onChange={(e) => setCrewFormData({ ...crewFormData, crewName: e.target.value })}\n                data-testid=\"input-edit-crew-name\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-crew-lead\">Crew Lead</Label>\n              <Input\n                id=\"edit-crew-lead\"\n                value={crewFormData.crewLead ?? ''}\n                onChange={(e) => setCrewFormData({ ...crewFormData, crewLead: e.target.value })}\n                data-testid=\"input-edit-crew-lead\"\n              />\n            </div>\n            <div className=\"grid gap-2\">\n              <Label htmlFor=\"edit-work-area\">Work Area</Label>\n              <Input\n                id=\"edit-work-area\"\n                value={crewFormData.workArea ?? ''}\n                onChange={(e) => setCrewFormData({ ...crewFormData, workArea: e.target.value })}\n                data-testid=\"input-edit-work-area\"\n              />\n            </div>\n          </div>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsEditCrewOpen(false)} data-testid=\"button-cancel-edit-crew\">\n              Cancel\n            </Button>\n            <Button\n              onClick={handleUpdateCrew}\n              disabled={updateCrewMutation.isPending}\n              data-testid=\"button-submit-edit-crew\"\n            >\n              {updateCrewMutation.isPending ? 'Updating...' : 'Update Crew'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n\n      {/* Delete Crew Dialog */}\n      <Dialog open={isDeleteCrewOpen} onOpenChange={setIsDeleteCrewOpen}>\n        <DialogContent data-testid=\"dialog-delete-crew\">\n          <DialogHeader>\n            <DialogTitle>Delete Crew</DialogTitle>\n            <DialogDescription>\n              Are you sure you want to delete \"{selectedCrew?.crewName}\"? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <DialogFooter>\n            <Button variant=\"outline\" onClick={() => setIsDeleteCrewOpen(false)} data-testid=\"button-cancel-delete-crew\">\n              Cancel\n            </Button>\n            <Button\n              variant=\"destructive\"\n              onClick={confirmDeleteCrew}\n              disabled={deleteCrewMutation.isPending}\n              data-testid=\"button-confirm-delete-crew\"\n            >\n              {deleteCrewMutation.isPending ? 'Deleting...' : 'Delete Crew'}\n            </Button>\n          </DialogFooter>\n        </DialogContent>\n      </Dialog>\n    </div>\n  );\n}\n\n// Roster Row Component with Collapsible Crews\nfunction RosterRow({ roster, isExpanded, onToggle, onEdit, onDelete, onAddCrew, onExport, getStatusBadge, getCompanyName, canManageRosters, onEditCrew, onDeleteCrew }: {\n  roster: Roster;\n  isExpanded: boolean;\n  onToggle: () => void;\n  onEdit: () => void;\n  onDelete: () => void;\n  onAddCrew: () => void;\n  onExport: () => void;\n  getStatusBadge: (status: string) => JSX.Element;\n  getCompanyName: (companyId: string) => string;\n  canManageRosters: boolean;\n  onEditCrew: (crew: Crew) => void;\n  onDeleteCrew: (crew: Crew) => void;\n}) {\n  const { data: crews, isLoading: crewsLoading } = useQuery<Crew[]>({\n    queryKey: ['/api/rosters', roster.id, 'crews'],\n    queryFn: () => getJson<Crew[]>(`/api/rosters/${roster.id}/crews`),\n    enabled: isExpanded,\n  });\n\n  // Fetch roster personnel to get counts by crew\n  const { data: allPersonnel } = useQuery<any[]>({\n    queryKey: ['/api/rosters', roster.id, 'personnel'],\n    queryFn: () => getJson<any[]>(`/api/rosters/${roster.id}/personnel`),\n    enabled: isExpanded,\n  });\n\n  // Fetch roster equipment to get counts by crew\n  const { data: allEquipment } = useQuery<any[]>({\n    queryKey: ['/api/rosters', roster.id, 'equipment'],\n    queryFn: () => getJson<any[]>(`/api/rosters/${roster.id}/equipment`),\n    enabled: isExpanded,\n  });\n\n  // Helper to get counts for a crew\n  const getCrewCounts = (crewId: string) => {\n    const personnelCount = allPersonnel?.filter(p => p.crewId === crewId).length || 0;\n    const equipmentCount = allEquipment?.filter(e => e.crewId === crewId).length || 0;\n    return { personnelCount, equipmentCount };\n  };\n\n  // Helper to find foreman for a crew\n  const getCrewForeman = (crewId: string) => {\n    const foreman = allPersonnel?.find(p => p.crewId === crewId && p.role?.toLowerCase().includes('foreman'));\n    return foreman?.name || crews?.find(c => c.id === crewId)?.crewLead || 'N/A';\n  };\n  \n  return (\n    <div className=\"border rounded-lg bg-white dark:bg-gray-800\" data-testid={`roster-${roster.id}`}>\n      <div className=\"p-4 flex items-center justify-between\">\n        <div className=\"flex items-center space-x-4 flex-1\">\n          <Button\n            variant=\"ghost\"\n            size=\"sm\"\n            onClick={onToggle}\n            data-testid={`button-toggle-${roster.id}`}\n          >\n            {isExpanded ? <ChevronDown className=\"w-4 h-4\" /> : <ChevronRight className=\"w-4 h-4\" />}\n          </Button>\n          <div className=\"flex-1\">\n            <div className=\"flex items-center space-x-3\">\n              <span className=\"font-medium\">{getCompanyName(roster.companyId)}</span>\n              {getStatusBadge(roster.status)}\n              <span className=\"text-sm text-gray-500 dark:text-gray-400\">\n                <Users className=\"w-4 h-4 inline mr-1\" />\n                {crews?.length || 0} crews\n              </span>\n            </div>\n          </div>\n        </div>\n        {canManageRosters && (\n          <div className=\"flex gap-2\">\n            <Link href={`/rosters/${roster.id}`}>\n              <Button\n                variant=\"outline\"\n                size=\"sm\"\n                data-testid={`button-view-details-${roster.id}`}\n              >\n                View Details\n              </Button>\n            </Link>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={onExport}\n              data-testid={`button-export-roster-${roster.id}`}\n            >\n              <Download className=\"w-4 h-4\" />\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={onEdit}\n              data-testid={`button-edit-roster-${roster.id}`}\n            >\n              <Edit className=\"w-4 h-4\" />\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={onAddCrew}\n              data-testid={`button-add-crew-${roster.id}`}\n            >\n              <Plus className=\"w-4 h-4\" />\n            </Button>\n            <Button\n              variant=\"outline\"\n              size=\"sm\"\n              onClick={onDelete}\n              data-testid={`button-delete-roster-${roster.id}`}\n            >\n              <Trash2 className=\"w-4 h-4\" />\n            </Button>\n          </div>\n        )}\n      </div>\n\n      {isExpanded && (\n        <div className=\"border-t px-4 py-3 bg-gray-50 dark:bg-gray-900\">\n          {crewsLoading ? (\n            <div className=\"text-sm text-gray-600 dark:text-gray-400\">Loading crews...</div>\n          ) : !crews || crews.length === 0 ? (\n            <div className=\"text-sm text-gray-600 dark:text-gray-400\">No crews added yet.</div>\n          ) : (\n            <div className=\"space-y-2\">\n              {crews.map((crew) => {\n                const { personnelCount, equipmentCount } = getCrewCounts(crew.id);\n                const foreman = getCrewForeman(crew.id);\n                return (\n                  <div\n                    key={crew.id}\n                    className=\"flex items-center justify-between p-3 bg-white dark:bg-gray-800 rounded border\"\n                    data-testid={`crew-${crew.id}`}\n                  >\n                    <div>\n                      <div className=\"font-medium\">{crew.crewName}</div>\n                      <div className=\"text-sm text-gray-600 dark:text-gray-400\">\n                        Foreman: {foreman}\n                        {' • '}\n                        <Users className=\"w-3 h-3 inline mr-1\" />\n                        {personnelCount} {personnelCount === 1 ? 'person' : 'people'}\n                        {' • '}\n                        <span className=\"inline-flex items-center\">\n                          <span className=\"mr-1\">⚙️</span>\n                          {equipmentCount} {equipmentCount === 1 ? 'piece' : 'pieces'}\n                        </span>\n                      </div>\n                    </div>\n                    {canManageRosters && (\n                      <div className=\"flex gap-2\">\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => onEditCrew(crew)}\n                          data-testid={`button-edit-crew-${crew.id}`}\n                        >\n                          <Edit className=\"w-4 h-4\" />\n                        </Button>\n                        <Button\n                          variant=\"ghost\"\n                          size=\"sm\"\n                          onClick={() => onDeleteCrew(crew)}\n                          data-testid={`button-delete-crew-${crew.id}`}\n                        >\n                          <Trash2 className=\"w-4 h-4\" />\n                        </Button>\n                      </div>\n                    )}\n                  </div>\n                );\n              })}\n            </div>\n          )}\n        </div>\n      )}\n    </div>\n  );\n}\n","path":null,"size_bytes":51237,"size_tokens":null},"client/src/pages/roster-detail.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { Link, useParams } from 'wouter';\nimport { ArrowLeft, Edit2, Save, X, Plus, Trash2 } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { useToast } from '@/hooks/use-toast';\nimport { useAuth } from '@/context/AuthContext';\nimport { getJson, patchJson, deleteJson, postJson, queryClient } from '@/lib/queryClient';\nimport { Badge } from '@/components/ui/badge';\nimport type { Roster, RosterPersonnel, RosterEquipment, Company } from '@shared/schema';\n\ntype PersonnelFormData = {\n  personnelId: string;\n  firstName: string;\n  lastName: string;\n  name: string;\n  role: string;\n  classification: string;\n  rateCode: string;\n  gender: string;\n  stOtPtEligibility: string;\n  email: string;\n  phone: string;\n  teamLead: string;\n  crewLeadFlag: string;\n  departureCity: string;\n  departureState: string;\n  notes: string;\n};\n\ntype EquipmentFormData = {\n  equipmentId: string;\n  equipmentType: string;\n  equipmentDescription: string;\n  type: string;\n  classification: string;\n  rateCode: string;\n  ownership: string;\n  fuel: string;\n  assignedCrewId: string;\n  notes: string;\n};\n\nexport default function RosterDetailPage() {\n  const params = useParams();\n  const rosterId = params.id as string;\n  const { user, logout } = useAuth();\n  const { toast } = useToast();\n\n  const [editingPersonnelId, setEditingPersonnelId] = useState<string | null>(null);\n  const [editingEquipmentId, setEditingEquipmentId] = useState<string | null>(null);\n  const [personnelFormData, setPersonnelFormData] = useState<PersonnelFormData>({\n    personnelId: '',\n    firstName: '',\n    lastName: '',\n    name: '',\n    role: '',\n    classification: '',\n    rateCode: '',\n    gender: '',\n    stOtPtEligibility: '',\n    email: '',\n    phone: '',\n    teamLead: '',\n    crewLeadFlag: '',\n    departureCity: '',\n    departureState: '',\n    notes: '',\n  });\n  const [equipmentFormData, setEquipmentFormData] = useState<EquipmentFormData>({\n    equipmentId: '',\n    equipmentType: '',\n    equipmentDescription: '',\n    type: '',\n    classification: '',\n    rateCode: '',\n    ownership: '',\n    fuel: '',\n    assignedCrewId: '',\n    notes: '',\n  });\n\n  const { data: roster, isLoading: rosterLoading } = useQuery<Roster>({\n    queryKey: ['/api/rosters', rosterId],\n    queryFn: () => getJson<Roster>(`/api/rosters/${rosterId}`),\n  });\n\n  const { data: personnel, isLoading: personnelLoading } = useQuery<RosterPersonnel[]>({\n    queryKey: ['/api/rosters', rosterId, 'personnel'],\n    queryFn: () => getJson<RosterPersonnel[]>(`/api/rosters/${rosterId}/personnel`),\n  });\n\n  const { data: equipment, isLoading: equipmentLoading } = useQuery<RosterEquipment[]>({\n    queryKey: ['/api/rosters', rosterId, 'equipment'],\n    queryFn: () => getJson<RosterEquipment[]>(`/api/rosters/${rosterId}/equipment`),\n  });\n\n  const { data: companies } = useQuery<Company[]>({\n    queryKey: ['/api/companies'],\n    enabled: user?.role === 'UTILITY',\n  });\n\n  const updatePersonnelMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<PersonnelFormData> }) => {\n      return await patchJson(`/api/personnel/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters', rosterId, 'personnel'] });\n      setEditingPersonnelId(null);\n      toast({ title: 'Personnel updated successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to update personnel', variant: 'destructive' });\n    },\n  });\n\n  const deletePersonnelMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await deleteJson(`/api/personnel/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters', rosterId, 'personnel'] });\n      toast({ title: 'Personnel deleted successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to delete personnel', variant: 'destructive' });\n    },\n  });\n\n  const updateEquipmentMutation = useMutation({\n    mutationFn: async ({ id, data }: { id: string; data: Partial<EquipmentFormData> }) => {\n      return await patchJson(`/api/equipment/${id}`, data);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters', rosterId, 'equipment'] });\n      setEditingEquipmentId(null);\n      toast({ title: 'Equipment updated successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to update equipment', variant: 'destructive' });\n    },\n  });\n\n  const deleteEquipmentMutation = useMutation({\n    mutationFn: async (id: string) => {\n      return await deleteJson(`/api/equipment/${id}`);\n    },\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: ['/api/rosters', rosterId, 'equipment'] });\n      toast({ title: 'Equipment deleted successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to delete equipment', variant: 'destructive' });\n    },\n  });\n\n  const handleEditPersonnel = (person: RosterPersonnel) => {\n    setEditingPersonnelId(person.id);\n    setPersonnelFormData({\n      personnelId: person.personnelId || '',\n      firstName: person.firstName || '',\n      lastName: person.lastName || '',\n      name: person.name || '',\n      role: person.role || '',\n      classification: person.classification || '',\n      rateCode: person.rateCode || '',\n      gender: person.gender || '',\n      stOtPtEligibility: person.stOtPtEligibility || '',\n      email: person.email || '',\n      phone: person.phone || '',\n      teamLead: person.teamLead || '',\n      crewLeadFlag: person.crewLeadFlag || '',\n      departureCity: person.departureCity || '',\n      departureState: person.departureState || '',\n      notes: person.notes || '',\n    });\n  };\n\n  const handleSavePersonnel = () => {\n    if (!editingPersonnelId) return;\n    updatePersonnelMutation.mutate({\n      id: editingPersonnelId,\n      data: personnelFormData,\n    });\n  };\n\n  const handleCancelPersonnelEdit = () => {\n    setEditingPersonnelId(null);\n    setPersonnelFormData({\n      personnelId: '',\n      firstName: '',\n      lastName: '',\n      name: '',\n      role: '',\n      classification: '',\n      rateCode: '',\n      gender: '',\n      stOtPtEligibility: '',\n      email: '',\n      phone: '',\n      teamLead: '',\n      crewLeadFlag: '',\n      departureCity: '',\n      departureState: '',\n      notes: '',\n    });\n  };\n\n  const handleEditEquipment = (equip: RosterEquipment) => {\n    setEditingEquipmentId(equip.id);\n    setEquipmentFormData({\n      equipmentId: equip.equipmentId || '',\n      equipmentType: equip.equipmentType || '',\n      equipmentDescription: equip.equipmentDescription || '',\n      type: equip.type || '',\n      classification: equip.classification || '',\n      rateCode: equip.rateCode || '',\n      ownership: equip.ownership || '',\n      fuel: equip.fuel || '',\n      assignedCrewId: equip.assignedCrewId || '',\n      notes: equip.notes || '',\n    });\n  };\n\n  const handleSaveEquipment = () => {\n    if (!editingEquipmentId) return;\n    updateEquipmentMutation.mutate({\n      id: editingEquipmentId,\n      data: equipmentFormData,\n    });\n  };\n\n  const handleCancelEquipmentEdit = () => {\n    setEditingEquipmentId(null);\n    setEquipmentFormData({\n      equipmentId: '',\n      equipmentType: '',\n      equipmentDescription: '',\n      type: '',\n      classification: '',\n      rateCode: '',\n      ownership: '',\n      fuel: '',\n      assignedCrewId: '',\n      notes: '',\n    });\n  };\n\n  const getStatusBadge = (status: string) => {\n    const variants: Record<string, 'default' | 'secondary' | 'destructive' | 'outline'> = {\n      DRAFT: 'secondary',\n      SUBMITTED: 'default',\n      APPROVED: 'outline',\n      LOCKED: 'destructive',\n    };\n    return <Badge variant={variants[status] || 'default'}>{status}</Badge>;\n  };\n\n  const getCompanyName = (companyId: string) => {\n    const company = companies?.find(c => c.id === companyId);\n    return company?.name || companyId;\n  };\n\n  if (rosterLoading) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center\">\n        <div className=\"text-gray-600 dark:text-gray-400\">Loading roster...</div>\n      </div>\n    );\n  }\n\n  if (!roster) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 flex items-center justify-center\">\n        <div className=\"text-center\">\n          <p className=\"text-gray-600 dark:text-gray-400 mb-4\">Roster not found</p>\n          <Link href=\"/rosters\">\n            <Button variant=\"outline\">\n              <ArrowLeft className=\"w-4 h-4 mr-2\" />\n              Back to Rosters\n            </Button>\n          </Link>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n      <header className=\"bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 sticky top-0 z-10\">\n        <div className=\"max-w-7xl mx-auto px-4 py-4\">\n          <div className=\"flex items-center justify-between\">\n            <div className=\"flex items-center space-x-4\">\n              <Link href=\"/rosters\">\n                <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-back-rosters\">\n                  <ArrowLeft className=\"w-4 h-4 mr-2\" />\n                  Back to Rosters\n                </Button>\n              </Link>\n              <div>\n                <h1 className=\"text-2xl font-bold text-gray-900 dark:text-white\">Roster Details</h1>\n                <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                  {getCompanyName(roster.companyId)} • {getStatusBadge(roster.status)}\n                </p>\n              </div>\n            </div>\n            <Button variant=\"outline\" size=\"sm\" onClick={logout} data-testid=\"button-logout\">\n              Logout\n            </Button>\n          </div>\n        </div>\n      </header>\n\n      <main className=\"max-w-7xl mx-auto px-4 py-8\">\n        <Tabs defaultValue=\"personnel\" className=\"space-y-6\">\n          <TabsList>\n            <TabsTrigger value=\"personnel\" data-testid=\"tab-personnel\">\n              Personnel ({personnel?.length || 0})\n            </TabsTrigger>\n            <TabsTrigger value=\"equipment\" data-testid=\"tab-equipment\">\n              Equipment ({equipment?.length || 0})\n            </TabsTrigger>\n          </TabsList>\n\n          <TabsContent value=\"personnel\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Personnel</CardTitle>\n                <CardDescription>Crew members assigned to this roster</CardDescription>\n              </CardHeader>\n              <CardContent>\n                {personnelLoading ? (\n                  <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">Loading personnel...</div>\n                ) : !personnel || personnel.length === 0 ? (\n                  <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">\n                    No personnel found. Import an Excel roster to add personnel.\n                  </div>\n                ) : (\n                  <div className=\"overflow-x-auto\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Personnel ID</TableHead>\n                          <TableHead>First Name</TableHead>\n                          <TableHead>Last Name</TableHead>\n                          <TableHead>Email</TableHead>\n                          <TableHead>Cell Phone</TableHead>\n                          <TableHead>Gender</TableHead>\n                          <TableHead>Team Lead</TableHead>\n                          <TableHead>Crew Lead</TableHead>\n                          <TableHead>Team Type</TableHead>\n                          <TableHead>Resource Type</TableHead>\n                          <TableHead>Departure City</TableHead>\n                          <TableHead>Departure State</TableHead>\n                          <TableHead className=\"text-right\">Actions</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {personnel.map((person) => {\n                          const isEditing = editingPersonnelId === person.id;\n                          \n                          return (\n                            <TableRow key={person.id} data-testid={`row-personnel-${person.id}`}>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={personnelFormData.personnelId}\n                                    onChange={(e) => setPersonnelFormData({ ...personnelFormData, personnelId: e.target.value })}\n                                    className=\"min-w-[120px]\"\n                                    data-testid=\"input-edit-personnelid\"\n                                  />\n                                ) : (\n                                  person.personnelId || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={personnelFormData.firstName}\n                                    onChange={(e) => setPersonnelFormData({ ...personnelFormData, firstName: e.target.value })}\n                                    className=\"min-w-[120px]\"\n                                    data-testid=\"input-edit-firstname\"\n                                  />\n                                ) : (\n                                  person.firstName || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={personnelFormData.lastName}\n                                    onChange={(e) => setPersonnelFormData({ ...personnelFormData, lastName: e.target.value })}\n                                    className=\"min-w-[120px]\"\n                                    data-testid=\"input-edit-lastname\"\n                                  />\n                                ) : (\n                                  person.lastName || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={personnelFormData.email}\n                                    onChange={(e) => setPersonnelFormData({ ...personnelFormData, email: e.target.value })}\n                                    className=\"min-w-[150px]\"\n                                    data-testid=\"input-edit-email\"\n                                  />\n                                ) : (\n                                  person.email || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={personnelFormData.phone}\n                                    onChange={(e) => setPersonnelFormData({ ...personnelFormData, phone: e.target.value })}\n                                    className=\"min-w-[120px]\"\n                                    data-testid=\"input-edit-phone\"\n                                  />\n                                ) : (\n                                  person.phone || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={personnelFormData.gender}\n                                    onChange={(e) => setPersonnelFormData({ ...personnelFormData, gender: e.target.value })}\n                                    className=\"min-w-[80px]\"\n                                    data-testid=\"input-edit-gender\"\n                                  />\n                                ) : (\n                                  person.gender || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={personnelFormData.teamLead}\n                                    onChange={(e) => setPersonnelFormData({ ...personnelFormData, teamLead: e.target.value })}\n                                    className=\"min-w-[80px]\"\n                                    data-testid=\"input-edit-teamlead\"\n                                  />\n                                ) : (\n                                  person.teamLead || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={personnelFormData.crewLeadFlag}\n                                    onChange={(e) => setPersonnelFormData({ ...personnelFormData, crewLeadFlag: e.target.value })}\n                                    className=\"min-w-[80px]\"\n                                    data-testid=\"input-edit-crewlead\"\n                                  />\n                                ) : (\n                                  person.crewLeadFlag || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={personnelFormData.role}\n                                    onChange={(e) => setPersonnelFormData({ ...personnelFormData, role: e.target.value })}\n                                    className=\"min-w-[120px]\"\n                                    data-testid=\"input-edit-role\"\n                                  />\n                                ) : (\n                                  person.role || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={personnelFormData.classification}\n                                    onChange={(e) => setPersonnelFormData({ ...personnelFormData, classification: e.target.value })}\n                                    className=\"min-w-[140px]\"\n                                    data-testid=\"input-edit-classification\"\n                                  />\n                                ) : (\n                                  person.classification || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={personnelFormData.departureCity}\n                                    onChange={(e) => setPersonnelFormData({ ...personnelFormData, departureCity: e.target.value })}\n                                    className=\"min-w-[120px]\"\n                                    data-testid=\"input-edit-departurecity\"\n                                  />\n                                ) : (\n                                  person.departureCity || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={personnelFormData.departureState}\n                                    onChange={(e) => setPersonnelFormData({ ...personnelFormData, departureState: e.target.value })}\n                                    className=\"min-w-[120px]\"\n                                    data-testid=\"input-edit-departurestate\"\n                                  />\n                                ) : (\n                                  person.departureState || '-'\n                                )}\n                              </TableCell>\n                              <TableCell className=\"text-right\">\n                                {isEditing ? (\n                                  <div className=\"flex items-center justify-end gap-2\">\n                                    <Button\n                                      size=\"sm\"\n                                      onClick={handleSavePersonnel}\n                                      disabled={updatePersonnelMutation.isPending}\n                                      data-testid=\"button-save-personnel\"\n                                    >\n                                      <Save className=\"w-4 h-4\" />\n                                    </Button>\n                                    <Button\n                                      size=\"sm\"\n                                      variant=\"outline\"\n                                      onClick={handleCancelPersonnelEdit}\n                                      data-testid=\"button-cancel-personnel\"\n                                    >\n                                      <X className=\"w-4 h-4\" />\n                                    </Button>\n                                  </div>\n                                ) : (\n                                  <div className=\"flex items-center justify-end gap-2\">\n                                    <Button\n                                      size=\"sm\"\n                                      variant=\"ghost\"\n                                      onClick={() => handleEditPersonnel(person)}\n                                      data-testid={`button-edit-personnel-${person.id}`}\n                                    >\n                                      <Edit2 className=\"w-4 h-4\" />\n                                    </Button>\n                                    <Button\n                                      size=\"sm\"\n                                      variant=\"ghost\"\n                                      onClick={() => deletePersonnelMutation.mutate(person.id)}\n                                      data-testid={`button-delete-personnel-${person.id}`}\n                                    >\n                                      <Trash2 className=\"w-4 h-4 text-red-600 dark:text-red-400\" />\n                                    </Button>\n                                  </div>\n                                )}\n                              </TableCell>\n                            </TableRow>\n                          );\n                        })}\n                      </TableBody>\n                    </Table>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n\n          <TabsContent value=\"equipment\">\n            <Card>\n              <CardHeader>\n                <CardTitle>Equipment</CardTitle>\n                <CardDescription>Equipment assigned to this roster</CardDescription>\n              </CardHeader>\n              <CardContent>\n                {equipmentLoading ? (\n                  <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">Loading equipment...</div>\n                ) : !equipment || equipment.length === 0 ? (\n                  <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">\n                    No equipment found. Import an Excel roster to add equipment.\n                  </div>\n                ) : (\n                  <div className=\"overflow-x-auto\">\n                    <Table>\n                      <TableHeader>\n                        <TableRow>\n                          <TableHead>Equipment ID</TableHead>\n                          <TableHead>Equipment Type</TableHead>\n                          <TableHead>Equipment Description</TableHead>\n                          <TableHead>Equipment Fuel Type</TableHead>\n                          <TableHead>Assigned Equipment Crew ID</TableHead>\n                          <TableHead className=\"text-right\">Actions</TableHead>\n                        </TableRow>\n                      </TableHeader>\n                      <TableBody>\n                        {equipment.map((equip) => {\n                          const isEditing = editingEquipmentId === equip.id;\n                          \n                          return (\n                            <TableRow key={equip.id} data-testid={`row-equipment-${equip.id}`}>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={equipmentFormData.equipmentId}\n                                    onChange={(e) => setEquipmentFormData({ ...equipmentFormData, equipmentId: e.target.value })}\n                                    className=\"min-w-[120px]\"\n                                    data-testid=\"input-edit-equipmentid\"\n                                  />\n                                ) : (\n                                  equip.equipmentId || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={equipmentFormData.equipmentType}\n                                    onChange={(e) => setEquipmentFormData({ ...equipmentFormData, equipmentType: e.target.value })}\n                                    className=\"min-w-[150px]\"\n                                    data-testid=\"input-edit-equipmenttype\"\n                                  />\n                                ) : (\n                                  equip.equipmentType || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={equipmentFormData.equipmentDescription}\n                                    onChange={(e) => setEquipmentFormData({ ...equipmentFormData, equipmentDescription: e.target.value })}\n                                    className=\"min-w-[180px]\"\n                                    data-testid=\"input-edit-equipmentdescription\"\n                                  />\n                                ) : (\n                                  equip.equipmentDescription || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={equipmentFormData.fuel}\n                                    onChange={(e) => setEquipmentFormData({ ...equipmentFormData, fuel: e.target.value })}\n                                    className=\"min-w-[120px]\"\n                                    data-testid=\"input-edit-fuel\"\n                                  />\n                                ) : (\n                                  equip.fuel || '-'\n                                )}\n                              </TableCell>\n                              <TableCell>\n                                {isEditing ? (\n                                  <Input\n                                    value={equipmentFormData.assignedCrewId}\n                                    onChange={(e) => setEquipmentFormData({ ...equipmentFormData, assignedCrewId: e.target.value })}\n                                    className=\"min-w-[140px]\"\n                                    data-testid=\"input-edit-assignedcrewid\"\n                                  />\n                                ) : (\n                                  equip.assignedCrewId || '-'\n                                )}\n                              </TableCell>\n                              <TableCell className=\"text-right\">\n                                {isEditing ? (\n                                  <div className=\"flex items-center justify-end gap-2\">\n                                    <Button\n                                      size=\"sm\"\n                                      onClick={handleSaveEquipment}\n                                      disabled={updateEquipmentMutation.isPending}\n                                      data-testid=\"button-save-equipment\"\n                                    >\n                                      <Save className=\"w-4 h-4\" />\n                                    </Button>\n                                    <Button\n                                      size=\"sm\"\n                                      variant=\"outline\"\n                                      onClick={handleCancelEquipmentEdit}\n                                      data-testid=\"button-cancel-equipment\"\n                                    >\n                                      <X className=\"w-4 h-4\" />\n                                    </Button>\n                                  </div>\n                                ) : (\n                                  <div className=\"flex items-center justify-end gap-2\">\n                                    <Button\n                                      size=\"sm\"\n                                      variant=\"ghost\"\n                                      onClick={() => handleEditEquipment(equip)}\n                                      data-testid={`button-edit-equipment-${equip.id}`}\n                                    >\n                                      <Edit2 className=\"w-4 h-4\" />\n                                    </Button>\n                                    <Button\n                                      size=\"sm\"\n                                      variant=\"ghost\"\n                                      onClick={() => deleteEquipmentMutation.mutate(equip.id)}\n                                      data-testid={`button-delete-equipment-${equip.id}`}\n                                    >\n                                      <Trash2 className=\"w-4 h-4 text-red-600 dark:text-red-400\" />\n                                    </Button>\n                                  </div>\n                                )}\n                              </TableCell>\n                            </TableRow>\n                          );\n                        })}\n                      </TableBody>\n                    </Table>\n                  </div>\n                )}\n              </CardContent>\n            </Card>\n          </TabsContent>\n        </Tabs>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":31339,"size_tokens":null},"client/src/pages/access-management.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Trash2, Plus, UserCheck } from \"lucide-react\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { User, Company, UserCompanyAccess } from \"@shared/schema\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport AppHeader from \"@/components/AppHeader\";\n\nexport default function AccessManagementPage() {\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [selectedUserId, setSelectedUserId] = useState(\"\");\n  const [selectedCompanyId, setSelectedCompanyId] = useState(\"\");\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { user } = useAuth();\n\n  // MANAGER-only protection\n  if (user?.role !== 'MANAGER') {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n        <AppHeader />\n        <main className=\"container mx-auto px-4 py-8\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Access Denied</CardTitle>\n              <CardDescription>This page is only accessible to MANAGER users.</CardDescription>\n            </CardHeader>\n          </Card>\n        </main>\n      </div>\n    );\n  }\n\n  const { data: users = [] } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const { data: companies = [] } = useQuery<Company[]>({\n    queryKey: [\"/api/companies\"],\n  });\n\n  const { data: accessGrants = [], isLoading } = useQuery<UserCompanyAccess[]>({\n    queryKey: [\"/api/user-company-access\"],\n  });\n\n  const grantMutation = useMutation({\n    mutationFn: (data: { userId: string; companyId: string }) =>\n      apiRequest(\"POST\", \"/api/user-company-access\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/user-company-access\"] });\n      setIsDialogOpen(false);\n      setSelectedUserId(\"\");\n      setSelectedCompanyId(\"\");\n      toast({ description: \"Access granted successfully\" });\n    },\n    onError: () => {\n      toast({ description: \"Failed to grant access\", variant: \"destructive\" });\n    },\n  });\n\n  const revokeMutation = useMutation({\n    mutationFn: ({ userId, companyId }: { userId: string; companyId: string }) =>\n      apiRequest(\"DELETE\", `/api/user-company-access/${userId}/${companyId}`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/user-company-access\"] });\n      toast({ description: \"Access revoked successfully\" });\n    },\n    onError: () => {\n      toast({ description: \"Failed to revoke access\", variant: \"destructive\" });\n    },\n  });\n\n  const handleGrant = () => {\n    if (!selectedUserId || !selectedCompanyId) {\n      toast({ description: \"Please select both user and company\", variant: \"destructive\" });\n      return;\n    }\n    grantMutation.mutate({ userId: selectedUserId, companyId: selectedCompanyId });\n  };\n\n  // Get UTILITY users only\n  const utilityUsers = users.filter(u => u.role === 'UTILITY');\n\n  // Group grants by user\n  const grantsByUser = accessGrants.reduce((acc, grant) => {\n    if (!acc[grant.userId]) {\n      acc[grant.userId] = [];\n    }\n    acc[grant.userId].push(grant);\n    return acc;\n  }, {} as Record<string, UserCompanyAccess[]>);\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n      <AppHeader />\n      <main className=\"container mx-auto px-4 py-8\">\n        <div className=\"flex justify-between items-center mb-6\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-gray-900 dark:text-gray-100\">Access Management</h1>\n            <p className=\"text-gray-600 dark:text-gray-400 mt-1\">Grant UTILITY users access to specific companies</p>\n          </div>\n          <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n            <DialogTrigger asChild>\n              <Button data-testid=\"button-grant-access\">\n                <Plus className=\"mr-2 h-4 w-4\" />\n                Grant Access\n              </Button>\n            </DialogTrigger>\n            <DialogContent data-testid=\"dialog-grant-access\">\n              <DialogHeader>\n                <DialogTitle>Grant Company Access</DialogTitle>\n                <DialogDescription>\n                  Allow a UTILITY user to access a specific company\n                </DialogDescription>\n              </DialogHeader>\n              <div className=\"space-y-4\">\n                <div>\n                  <label className=\"text-sm font-medium\">UTILITY User</label>\n                  <Select value={selectedUserId} onValueChange={setSelectedUserId}>\n                    <SelectTrigger data-testid=\"select-grant-user\">\n                      <SelectValue placeholder=\"Select user...\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {utilityUsers.map(u => (\n                        <SelectItem key={u.id} value={u.id}>\n                          {u.firstName} {u.lastName} ({u.email})\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div>\n                  <label className=\"text-sm font-medium\">Company</label>\n                  <Select value={selectedCompanyId} onValueChange={setSelectedCompanyId}>\n                    <SelectTrigger data-testid=\"select-grant-company\">\n                      <SelectValue placeholder=\"Select company...\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      {companies.map(c => (\n                        <SelectItem key={c.id} value={c.id}>\n                          {c.name}\n                        </SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <Button\n                  onClick={handleGrant}\n                  className=\"w-full\"\n                  disabled={!selectedUserId || !selectedCompanyId}\n                  data-testid=\"button-submit-grant\"\n                >\n                  Grant Access\n                </Button>\n              </div>\n            </DialogContent>\n          </Dialog>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Access Grants ({accessGrants.length})</CardTitle>\n            <CardDescription>UTILITY users and their company access</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"text-center py-8 text-gray-500\">Loading access grants...</div>\n            ) : utilityUsers.length === 0 ? (\n              <div className=\"text-center py-8 text-gray-500\">No UTILITY users found</div>\n            ) : (\n              <div className=\"space-y-6\">\n                {utilityUsers.map(u => {\n                  const userGrants = grantsByUser[u.id] || [];\n                  return (\n                    <div key={u.id} className=\"border rounded-lg p-4\" data-testid={`section-user-grants-${u.id}`}>\n                      <div className=\"flex items-center gap-3 mb-3\">\n                        <UserCheck className=\"h-5 w-5 text-gray-500\" />\n                        <div>\n                          <h3 className=\"font-medium\" data-testid={`text-user-name-${u.id}`}>\n                            {u.firstName} {u.lastName}\n                          </h3>\n                          <p className=\"text-sm text-gray-500\">{u.email}</p>\n                        </div>\n                        <Badge className=\"ml-auto bg-orange-500\">UTILITY</Badge>\n                      </div>\n                      \n                      {userGrants.length === 0 ? (\n                        <p className=\"text-sm text-gray-500 italic\">No company access granted</p>\n                      ) : (\n                        <div className=\"grid grid-cols-1 md:grid-cols-2 gap-2\">\n                          {userGrants.map(grant => {\n                            const company = companies.find(c => c.id === grant.companyId);\n                            return (\n                              <div\n                                key={`${grant.userId}-${grant.companyId}`}\n                                className=\"flex items-center justify-between bg-gray-50 dark:bg-gray-800 rounded p-2\"\n                                data-testid={`grant-${grant.userId}-${grant.companyId}`}\n                              >\n                                <span className=\"text-sm font-medium\">{company?.name || 'Unknown Company'}</span>\n                                <Button\n                                  variant=\"ghost\"\n                                  size=\"sm\"\n                                  onClick={() => {\n                                    if (confirm(`Revoke ${company?.name} access for ${u.firstName} ${u.lastName}?`)) {\n                                      revokeMutation.mutate({ userId: grant.userId, companyId: grant.companyId });\n                                    }\n                                  }}\n                                  data-testid={`button-revoke-${grant.userId}-${grant.companyId}`}\n                                >\n                                  <Trash2 className=\"h-4 w-4 text-red-500\" />\n                                </Button>\n                              </div>\n                            );\n                          })}\n                        </div>\n                      )}\n                    </div>\n                  );\n                })}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":9962,"size_tokens":null},"client/src/pages/contractor-profile.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Textarea } from \"@/components/ui/textarea\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Edit, Save, X } from \"lucide-react\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { Company } from \"@shared/schema\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport AppHeader from \"@/components/AppHeader\";\n\nexport default function ContractorProfilePage() {\n  const [isEditing, setIsEditing] = useState(false);\n  const [formData, setFormData] = useState<Partial<Company>>({});\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { user } = useAuth();\n\n  // CONTRACTOR-only protection\n  if (user?.role !== 'CONTRACTOR') {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n        <AppHeader />\n        <main className=\"container mx-auto px-4 py-8\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Access Denied</CardTitle>\n              <CardDescription>This page is only accessible to CONTRACTOR users.</CardDescription>\n            </CardHeader>\n          </Card>\n        </main>\n      </div>\n    );\n  }\n\n  const { data: company, isLoading: loadingCompany } = useQuery<Company>({\n    queryKey: [\"/api/profile\"],\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: (data: Partial<Company>) => apiRequest(\"PATCH\", \"/api/profile\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/profile\"] });\n      setIsEditing(false);\n      toast({ description: \"Company profile updated successfully\" });\n    },\n    onError: () => {\n      toast({ description: \"Failed to update profile\", variant: \"destructive\" });\n    },\n  });\n\n  const handleEdit = () => {\n    setFormData(company || {});\n    setIsEditing(true);\n  };\n\n  const handleCancel = () => {\n    setFormData({});\n    setIsEditing(false);\n  };\n\n  const handleSave = () => {\n    updateMutation.mutate(formData);\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n      <AppHeader />\n      <main className=\"container mx-auto px-4 py-8\">\n        <div className=\"max-w-3xl mx-auto space-y-6\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-gray-900 dark:text-gray-100\">Company Profile</h1>\n            <p className=\"text-gray-600 dark:text-gray-400 mt-1\">View and manage your company information</p>\n          </div>\n\n          {loadingCompany ? (\n            <Card>\n              <CardContent className=\"py-8\">\n                <div className=\"text-center text-gray-500\">Loading profile...</div>\n              </CardContent>\n            </Card>\n          ) : !company ? (\n            <Card>\n              <CardContent className=\"py-8\">\n                <div className=\"text-center text-gray-500\">No company assigned to your account</div>\n              </CardContent>\n            </Card>\n          ) : (\n            <>\n              <Card>\n                <CardHeader>\n                  <div className=\"flex justify-between items-center\">\n                    <div>\n                      <CardTitle>Company Information</CardTitle>\n                      <CardDescription>Basic company details</CardDescription>\n                    </div>\n                    {!isEditing ? (\n                      <Button onClick={handleEdit} data-testid=\"button-edit-profile\">\n                        <Edit className=\"mr-2 h-4 w-4\" />\n                        Edit\n                      </Button>\n                    ) : (\n                      <div className=\"flex gap-2\">\n                        <Button onClick={handleSave} data-testid=\"button-save-profile\">\n                          <Save className=\"mr-2 h-4 w-4\" />\n                          Save\n                        </Button>\n                        <Button variant=\"outline\" onClick={handleCancel} data-testid=\"button-cancel-edit\">\n                          <X className=\"mr-2 h-4 w-4\" />\n                          Cancel\n                        </Button>\n                      </div>\n                    )}\n                  </div>\n                </CardHeader>\n                <CardContent className=\"space-y-4\">\n                  {!isEditing ? (\n                    <>\n                      <div>\n                        <Label className=\"text-gray-600\">Company Name</Label>\n                        <p className=\"font-medium\" data-testid=\"text-company-name\">{company.name}</p>\n                      </div>\n                      <div>\n                        <Label className=\"text-gray-600\">Contact Name</Label>\n                        <p className=\"font-medium\" data-testid=\"text-contact-name\">\n                          {company.contactName || <span className=\"text-gray-400\">Not provided</span>}\n                        </p>\n                      </div>\n                      <div>\n                        <Label className=\"text-gray-600\">Contact Email</Label>\n                        <p className=\"font-medium\" data-testid=\"text-contact-email\">\n                          {company.contactEmail || <span className=\"text-gray-400\">Not provided</span>}\n                        </p>\n                      </div>\n                      <div>\n                        <Label className=\"text-gray-600\">Contact Phone</Label>\n                        <p className=\"font-medium\" data-testid=\"text-contact-phone\">\n                          {company.contactPhone || <span className=\"text-gray-400\">Not provided</span>}\n                        </p>\n                      </div>\n                      <div>\n                        <Label className=\"text-gray-600\">Billing Address</Label>\n                        <p className=\"font-medium whitespace-pre-wrap\" data-testid=\"text-billing-address\">\n                          {company.billingAddress || <span className=\"text-gray-400\">Not provided</span>}\n                        </p>\n                      </div>\n                      <div>\n                        <Label className=\"text-gray-600\">Notes</Label>\n                        <p className=\"font-medium whitespace-pre-wrap\" data-testid=\"text-notes\">\n                          {company.notes || <span className=\"text-gray-400\">No notes</span>}\n                        </p>\n                      </div>\n                    </>\n                  ) : (\n                    <>\n                      <div>\n                        <Label htmlFor=\"name\">Company Name</Label>\n                        <Input\n                          id=\"name\"\n                          value={formData.name || \"\"}\n                          onChange={(e) => setFormData({ ...formData, name: e.target.value })}\n                          required\n                          data-testid=\"input-company-name\"\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"contactName\">Contact Name</Label>\n                        <Input\n                          id=\"contactName\"\n                          value={formData.contactName || \"\"}\n                          onChange={(e) => setFormData({ ...formData, contactName: e.target.value })}\n                          data-testid=\"input-contact-name\"\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"contactEmail\">Contact Email</Label>\n                        <Input\n                          id=\"contactEmail\"\n                          type=\"email\"\n                          value={formData.contactEmail || \"\"}\n                          onChange={(e) => setFormData({ ...formData, contactEmail: e.target.value })}\n                          data-testid=\"input-contact-email\"\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"contactPhone\">Contact Phone</Label>\n                        <Input\n                          id=\"contactPhone\"\n                          value={formData.contactPhone || \"\"}\n                          onChange={(e) => setFormData({ ...formData, contactPhone: e.target.value })}\n                          data-testid=\"input-contact-phone\"\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"billingAddress\">Billing Address</Label>\n                        <Textarea\n                          id=\"billingAddress\"\n                          value={formData.billingAddress || \"\"}\n                          onChange={(e) => setFormData({ ...formData, billingAddress: e.target.value })}\n                          rows={3}\n                          data-testid=\"input-billing-address\"\n                        />\n                      </div>\n                      <div>\n                        <Label htmlFor=\"notes\">Notes</Label>\n                        <Textarea\n                          id=\"notes\"\n                          value={formData.notes || \"\"}\n                          onChange={(e) => setFormData({ ...formData, notes: e.target.value })}\n                          rows={3}\n                          data-testid=\"input-notes\"\n                        />\n                      </div>\n                    </>\n                  )}\n                </CardContent>\n              </Card>\n            </>\n          )}\n        </div>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":9657,"size_tokens":null},"client/src/pages/users.tsx":{"content":"import { useState } from \"react\";\nimport { useQuery, useMutation, useQueryClient } from \"@tanstack/react-query\";\nimport { Button } from \"@/components/ui/button\";\nimport { Input } from \"@/components/ui/input\";\nimport { Label } from \"@/components/ui/label\";\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from \"@/components/ui/select\";\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Badge } from \"@/components/ui/badge\";\nimport { Trash2, Edit, Plus, Search, ArrowUpDown } from \"lucide-react\";\nimport { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from \"@/components/ui/dialog\";\nimport { useToast } from \"@/hooks/use-toast\";\nimport { apiRequest } from \"@/lib/queryClient\";\nimport type { User, InsertUser, Company } from \"@shared/schema\";\nimport { useAuth } from \"@/context/AuthContext\";\nimport AppHeader from \"@/components/AppHeader\";\n\ntype SortField = 'firstName' | 'email' | 'role' | 'company';\ntype SortDirection = 'asc' | 'desc';\n\nexport default function UsersPage() {\n  const [editingUser, setEditingUser] = useState<User | null>(null);\n  const [isDialogOpen, setIsDialogOpen] = useState(false);\n  const [searchTerm, setSearchTerm] = useState(\"\");\n  const [roleFilter, setRoleFilter] = useState(\"all\");\n  const [sortField, setSortField] = useState<SortField>('firstName');\n  const [sortDirection, setSortDirection] = useState<SortDirection>('asc');\n  const { toast } = useToast();\n  const queryClient = useQueryClient();\n  const { user } = useAuth();\n\n  // ADMIN-only protection\n  if (user?.role !== 'ADMIN') {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n        <AppHeader />\n        <main className=\"container mx-auto px-4 py-8\">\n          <Card>\n            <CardHeader>\n              <CardTitle>Access Denied</CardTitle>\n              <CardDescription>This page is only accessible to ADMIN users.</CardDescription>\n            </CardHeader>\n          </Card>\n        </main>\n      </div>\n    );\n  }\n\n  const { data: users = [], isLoading } = useQuery<User[]>({\n    queryKey: [\"/api/users\"],\n  });\n\n  const { data: companies = [] } = useQuery<Company[]>({\n    queryKey: [\"/api/companies\"],\n  });\n\n  const createMutation = useMutation({\n    mutationFn: (data: InsertUser) => apiRequest(\"POST\", \"/api/users\", data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      setIsDialogOpen(false);\n      setEditingUser(null);\n      toast({ description: \"User created successfully\" });\n    },\n    onError: () => {\n      toast({ description: \"Failed to create user\", variant: \"destructive\" });\n    },\n  });\n\n  const updateMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: Partial<InsertUser> }) =>\n      apiRequest(\"PATCH\", `/api/users/${id}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      setIsDialogOpen(false);\n      setEditingUser(null);\n      toast({ description: \"User updated successfully\" });\n    },\n    onError: () => {\n      toast({ description: \"Failed to update user\", variant: \"destructive\" });\n    },\n  });\n\n  const deleteMutation = useMutation({\n    mutationFn: (id: string) => apiRequest(\"DELETE\", `/api/users/${id}`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [\"/api/users\"] });\n      toast({ description: \"User deleted successfully\" });\n    },\n    onError: () => {\n      toast({ description: \"Failed to delete user\", variant: \"destructive\" });\n    },\n  });\n\n  const handleSubmit = (e: React.FormEvent<HTMLFormElement>) => {\n    e.preventDefault();\n    const formData = new FormData(e.currentTarget);\n    const companyIdStr = formData.get(\"companyId\") as string;\n    \n    const data: InsertUser = {\n      firstName: formData.get(\"firstName\") as string,\n      lastName: formData.get(\"lastName\") as string,\n      email: formData.get(\"email\") as string,\n      role: formData.get(\"role\") as \"ADMIN\" | \"MANAGER\" | \"CONTRACTOR\" | \"UTILITY\",\n      companyId: companyIdStr && companyIdStr !== \"\" ? companyIdStr : null,\n      profileImageUrl: null,\n    };\n\n    if (editingUser) {\n      const updates: Partial<InsertUser> = {\n        firstName: data.firstName,\n        lastName: data.lastName,\n        email: data.email,\n        role: data.role,\n        companyId: data.companyId,\n      };\n      updateMutation.mutate({ id: editingUser.id, data: updates });\n    } else {\n      createMutation.mutate(data);\n    }\n  };\n\n  // Filter and sort users\n  const filteredUsers = users\n    .filter(u => {\n      const fullName = `${u.firstName || ''} ${u.lastName || ''}`.trim();\n      const matchesSearch = fullName.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                           (u.email || '').toLowerCase().includes(searchTerm.toLowerCase());\n      const matchesRole = roleFilter === \"all\" || u.role === roleFilter;\n      return matchesSearch && matchesRole;\n    })\n    .sort((a, b) => {\n      let aVal, bVal;\n      if (sortField === 'company') {\n        const aCompany = companies.find(c => c.id === a.companyId);\n        const bCompany = companies.find(c => c.id === b.companyId);\n        aVal = aCompany?.name || '';\n        bVal = bCompany?.name || '';\n      } else {\n        aVal = a[sortField] || '';\n        bVal = b[sortField] || '';\n      }\n      \n      if (typeof aVal === 'string') {\n        return sortDirection === 'asc' \n          ? aVal.localeCompare(bVal as string)\n          : (bVal as string).localeCompare(aVal);\n      }\n      return 0;\n    });\n\n  const toggleSort = (field: SortField) => {\n    if (sortField === field) {\n      setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');\n    } else {\n      setSortField(field);\n      setSortDirection('asc');\n    }\n  };\n\n  const getRoleBadgeColor = (role: string) => {\n    switch (role) {\n      case 'ADMIN': return 'bg-purple-500';\n      case 'MANAGER': return 'bg-blue-500';\n      case 'CONTRACTOR': return 'bg-green-500';\n      case 'UTILITY': return 'bg-orange-500';\n      default: return 'bg-gray-500';\n    }\n  };\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900\">\n      <AppHeader />\n      <main className=\"container mx-auto px-4 py-8\">\n        <div className=\"flex justify-between items-center mb-6\">\n          <div>\n            <h1 className=\"text-3xl font-bold text-gray-900 dark:text-gray-100\">User Management</h1>\n            <p className=\"text-gray-600 dark:text-gray-400 mt-1\">Manage system users and their roles</p>\n          </div>\n          <Dialog open={isDialogOpen} onOpenChange={setIsDialogOpen}>\n            <DialogTrigger asChild>\n              <Button onClick={() => setEditingUser(null)} data-testid=\"button-create-user\">\n                <Plus className=\"mr-2 h-4 w-4\" />\n                Add User\n              </Button>\n            </DialogTrigger>\n            <DialogContent data-testid=\"dialog-user-form\">\n              <DialogHeader>\n                <DialogTitle>{editingUser ? \"Edit User\" : \"Create User\"}</DialogTitle>\n                <DialogDescription>\n                  {editingUser ? \"Update user details\" : \"Add a new user to the system\"}\n                </DialogDescription>\n              </DialogHeader>\n              <form onSubmit={handleSubmit} className=\"space-y-4\">\n                <div>\n                  <Label htmlFor=\"firstName\">First Name</Label>\n                  <Input\n                    id=\"firstName\"\n                    name=\"firstName\"\n                    defaultValue={editingUser?.firstName || \"\"}\n                    required\n                    data-testid=\"input-user-firstName\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"lastName\">Last Name</Label>\n                  <Input\n                    id=\"lastName\"\n                    name=\"lastName\"\n                    defaultValue={editingUser?.lastName || \"\"}\n                    required\n                    data-testid=\"input-user-lastName\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"email\">Email</Label>\n                  <Input\n                    id=\"email\"\n                    name=\"email\"\n                    type=\"email\"\n                    defaultValue={editingUser?.email || \"\"}\n                    required\n                    data-testid=\"input-user-email\"\n                  />\n                </div>\n                <div>\n                  <Label htmlFor=\"role\">Role</Label>\n                  <Select name=\"role\" defaultValue={editingUser?.role || \"CONTRACTOR\"} required>\n                    <SelectTrigger data-testid=\"select-user-role\">\n                      <SelectValue />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"ADMIN\">ADMIN - User management only</SelectItem>\n                      <SelectItem value=\"MANAGER\">MANAGER - Full system access</SelectItem>\n                      <SelectItem value=\"CONTRACTOR\">CONTRACTOR - Own company only</SelectItem>\n                      <SelectItem value=\"UTILITY\">UTILITY - Granted companies</SelectItem>\n                    </SelectContent>\n                  </Select>\n                </div>\n                <div>\n                  <Label htmlFor=\"companyId\">Company (optional)</Label>\n                  <Select name=\"companyId\" defaultValue={editingUser?.companyId || \"\"}>\n                    <SelectTrigger data-testid=\"select-user-company\">\n                      <SelectValue placeholder=\"No company\" />\n                    </SelectTrigger>\n                    <SelectContent>\n                      <SelectItem value=\"\">No company</SelectItem>\n                      {companies.map(c => (\n                        <SelectItem key={c.id} value={c.id}>{c.name}</SelectItem>\n                      ))}\n                    </SelectContent>\n                  </Select>\n                </div>\n                <Button type=\"submit\" className=\"w-full\" data-testid=\"button-save-user\">\n                  {editingUser ? \"Update\" : \"Create\"} User\n                </Button>\n              </form>\n            </DialogContent>\n          </Dialog>\n        </div>\n\n        <Card>\n          <CardHeader>\n            <CardTitle>Users ({filteredUsers.length})</CardTitle>\n            <CardDescription>Search and filter users</CardDescription>\n            <div className=\"flex gap-4 mt-4\">\n              <div className=\"flex-1 relative\">\n                <Search className=\"absolute left-3 top-3 h-4 w-4 text-gray-400\" />\n                <Input\n                  placeholder=\"Search by name or email...\"\n                  value={searchTerm}\n                  onChange={(e) => setSearchTerm(e.target.value)}\n                  className=\"pl-10\"\n                  data-testid=\"input-search-users\"\n                />\n              </div>\n              <Select value={roleFilter} onValueChange={setRoleFilter}>\n                <SelectTrigger className=\"w-48\" data-testid=\"select-filter-role\">\n                  <SelectValue />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Roles</SelectItem>\n                  <SelectItem value=\"ADMIN\">ADMIN</SelectItem>\n                  <SelectItem value=\"MANAGER\">MANAGER</SelectItem>\n                  <SelectItem value=\"CONTRACTOR\">CONTRACTOR</SelectItem>\n                  <SelectItem value=\"UTILITY\">UTILITY</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n          </CardHeader>\n          <CardContent>\n            {isLoading ? (\n              <div className=\"text-center py-8 text-gray-500\">Loading users...</div>\n            ) : filteredUsers.length === 0 ? (\n              <div className=\"text-center py-8 text-gray-500\">No users found</div>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <table className=\"w-full\">\n                  <thead className=\"border-b\">\n                    <tr>\n                      <th className=\"text-left py-3 px-4\">\n                        <button\n                          onClick={() => toggleSort('firstName')}\n                          className=\"flex items-center gap-2 hover:text-blue-600\"\n                          data-testid=\"sort-name\"\n                        >\n                          Name\n                          <ArrowUpDown className=\"h-4 w-4\" />\n                        </button>\n                      </th>\n                      <th className=\"text-left py-3 px-4\">\n                        <button\n                          onClick={() => toggleSort('email')}\n                          className=\"flex items-center gap-2 hover:text-blue-600\"\n                          data-testid=\"sort-email\"\n                        >\n                          Email\n                          <ArrowUpDown className=\"h-4 w-4\" />\n                        </button>\n                      </th>\n                      <th className=\"text-left py-3 px-4\">\n                        <button\n                          onClick={() => toggleSort('role')}\n                          className=\"flex items-center gap-2 hover:text-blue-600\"\n                          data-testid=\"sort-role\"\n                        >\n                          Role\n                          <ArrowUpDown className=\"h-4 w-4\" />\n                        </button>\n                      </th>\n                      <th className=\"text-left py-3 px-4\">\n                        <button\n                          onClick={() => toggleSort('company')}\n                          className=\"flex items-center gap-2 hover:text-blue-600\"\n                          data-testid=\"sort-company\"\n                        >\n                          Company\n                          <ArrowUpDown className=\"h-4 w-4\" />\n                        </button>\n                      </th>\n                      <th className=\"text-right py-3 px-4\">Actions</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    {filteredUsers.map(u => {\n                      const company = companies.find(c => c.id === u.companyId);\n                      const fullName = `${u.firstName || ''} ${u.lastName || ''}`.trim();\n                      return (\n                        <tr key={u.id} className=\"border-b hover:bg-gray-50 dark:hover:bg-gray-800\" data-testid={`row-user-${u.id}`}>\n                          <td className=\"py-3 px-4 font-medium\" data-testid={`text-user-name-${u.id}`}>{fullName}</td>\n                          <td className=\"py-3 px-4 text-gray-600 dark:text-gray-400\" data-testid={`text-user-email-${u.id}`}>{u.email}</td>\n                          <td className=\"py-3 px-4\">\n                            <Badge className={getRoleBadgeColor(u.role)} data-testid={`badge-user-role-${u.id}`}>\n                              {u.role}\n                            </Badge>\n                          </td>\n                          <td className=\"py-3 px-4 text-gray-600 dark:text-gray-400\" data-testid={`text-user-company-${u.id}`}>\n                            {company?.name || <span className=\"text-gray-400\">None</span>}\n                          </td>\n                          <td className=\"py-3 px-4\">\n                            <div className=\"flex justify-end gap-2\">\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => {\n                                  setEditingUser(u);\n                                  setIsDialogOpen(true);\n                                }}\n                                data-testid={`button-edit-user-${u.id}`}\n                              >\n                                <Edit className=\"h-4 w-4\" />\n                              </Button>\n                              <Button\n                                variant=\"ghost\"\n                                size=\"sm\"\n                                onClick={() => {\n                                  const fullName = `${u.firstName || ''} ${u.lastName || ''}`.trim();\n                                  if (confirm(`Delete user ${fullName}?`)) {\n                                    deleteMutation.mutate(u.id);\n                                  }\n                                }}\n                                disabled={u.id === user?.id}\n                                data-testid={`button-delete-user-${u.id}`}\n                              >\n                                <Trash2 className=\"h-4 w-4\" />\n                              </Button>\n                            </div>\n                          </td>\n                        </tr>\n                      );\n                    })}\n                  </tbody>\n                </table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </main>\n    </div>\n  );\n}\n","path":null,"size_bytes":16934,"size_tokens":null},"client/src/pages/timesheet-detail.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useParams, Link, useLocation } from 'wouter';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { ArrowLeft, Save, Send, Check, Plus, Trash2, X } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Input } from '@/components/ui/input';\nimport { Label } from '@/components/ui/label';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Badge } from '@/components/ui/badge';\nimport { useToast } from '@/hooks/use-toast';\nimport { getJson, apiRequest, queryClient } from '@/lib/queryClient';\nimport { useAuth } from '@/context/AuthContext';\nimport type { Timesheet, TimesheetPersonnel, TimesheetEquipment, WorkSegment, RosterPersonnel, RosterEquipment } from '@shared/schema';\n\n// Helper: Calculate hours from HH:mm time strings, handle overnight shifts\nfunction calcShiftHours(startTime: string, endTime: string): number {\n  if (!startTime || !endTime) return 0;\n  \n  const [startHour, startMin] = startTime.split(':').map(Number);\n  const [endHour, endMin] = endTime.split(':').map(Number);\n  \n  let startMinutes = startHour * 60 + startMin;\n  let endMinutes = endHour * 60 + endMin;\n  \n  // Handle overnight shifts\n  if (endMinutes < startMinutes) {\n    endMinutes += 24 * 60;\n  }\n  \n  return Math.round(((endMinutes - startMinutes) / 60) * 100) / 100;\n}\n\nexport default function TimesheetDetailPage() {\n  const params = useParams();\n  const timesheetId = params.id as string;\n  const { toast } = useToast();\n  const { user } = useAuth();\n  const [, navigate] = useLocation();\n\n  const [headerData, setHeaderData] = useState<Partial<Timesheet>>({});\n  const [editingPersonnel, setEditingPersonnel] = useState<Record<string, Partial<TimesheetPersonnel>>>({});\n  const [editingEquipment, setEditingEquipment] = useState<Record<string, Partial<TimesheetEquipment>>>({});\n\n  const { data: timesheet, isLoading: timesheetLoading } = useQuery<Timesheet>({\n    queryKey: [`/api/timesheets/${timesheetId}`],\n    enabled: !!timesheetId,\n  });\n\n  const { data: personnel = [], isLoading: personnelLoading } = useQuery<TimesheetPersonnel[]>({\n    queryKey: [`/api/timesheets/${timesheetId}/personnel`],\n    enabled: !!timesheetId,\n  });\n\n  const { data: equipment = [], isLoading: equipmentLoading } = useQuery<TimesheetEquipment[]>({\n    queryKey: [`/api/timesheets/${timesheetId}/equipment`],\n    enabled: !!timesheetId,\n  });\n\n  // Sync header data when timesheet loads\n  useEffect(() => {\n    if (timesheet) {\n      setHeaderData(timesheet);\n    }\n  }, [timesheet]);\n\n  const updateTimesheetMutation = useMutation({\n    mutationFn: (data: Partial<Timesheet>) =>\n      apiRequest('PATCH', `/api/timesheets/${timesheetId}`, data),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/timesheets/${timesheetId}`] });\n      toast({ title: 'Timesheet updated successfully' });\n    },\n    onError: () => {\n      toast({ title: 'Failed to update timesheet', variant: 'destructive' });\n    },\n  });\n\n  const updatePersonnelMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: Partial<TimesheetPersonnel> }) =>\n      apiRequest('PATCH', `/api/timesheets/${timesheetId}/personnel/${id}`, data),\n    onSuccess: (_, variables) => {\n      // Clear the editing state for this person\n      const newEditing = { ...editingPersonnel };\n      delete newEditing[variables.id];\n      setEditingPersonnel(newEditing);\n      \n      queryClient.invalidateQueries({ queryKey: [`/api/timesheets/${timesheetId}/personnel`] });\n      toast({ title: 'Personnel updated successfully' });\n    },\n  });\n\n  const updateEquipmentMutation = useMutation({\n    mutationFn: ({ id, data }: { id: string; data: Partial<TimesheetEquipment> }) =>\n      apiRequest('PATCH', `/api/timesheets/${timesheetId}/equipment/${id}`, data),\n    onSuccess: (_, variables) => {\n      // Clear the editing state for this equipment\n      const newEditing = { ...editingEquipment };\n      delete newEditing[variables.id];\n      setEditingEquipment(newEditing);\n      \n      queryClient.invalidateQueries({ queryKey: [`/api/timesheets/${timesheetId}/equipment`] });\n      toast({ title: 'Equipment updated successfully' });\n    },\n  });\n\n  const submitTimesheetMutation = useMutation({\n    mutationFn: () => apiRequest('POST', `/api/timesheets/${timesheetId}/submit`, {}),\n    onSuccess: () => {\n      queryClient.invalidateQueries({ queryKey: [`/api/timesheets/${timesheetId}`] });\n      toast({ title: 'Timesheet submitted successfully' });\n    },\n  });\n\n  const deleteTimesheetMutation = useMutation({\n    mutationFn: () => apiRequest('DELETE', `/api/timesheets/${timesheetId}`, {}),\n    onSuccess: () => {\n      toast({ title: 'Timesheet deleted successfully' });\n      navigate('/timesheets');\n    },\n    onError: () => {\n      toast({ title: 'Failed to delete timesheet', variant: 'destructive' });\n    },\n  });\n\n  const handleSaveHeader = () => {\n    updateTimesheetMutation.mutate(headerData);\n  };\n\n  const handleSubmitTimesheet = () => {\n    submitTimesheetMutation.mutate();\n  };\n\n  const handleDeleteTimesheet = () => {\n    if (confirm('Are you sure you want to delete this timesheet? This action cannot be undone.')) {\n      deleteTimesheetMutation.mutate();\n    }\n  };\n\n  const getStatusBadge = (status: string) => {\n    const variants: Record<string, 'default' | 'secondary' | 'outline'> = {\n      DRAFT: 'secondary',\n      SUBMITTED: 'outline',\n      APPROVED: 'default',\n      SIGNED: 'default',\n    };\n    return <Badge variant={variants[status] || 'secondary'}>{status}</Badge>;\n  };\n\n  if (timesheetLoading) {\n    return <div className=\"p-8 text-center\">Loading timesheet...</div>;\n  }\n\n  if (!timesheet) {\n    return <div className=\"p-8 text-center text-gray-600 dark:text-gray-400\">Timesheet not found</div>;\n  }\n\n  return (\n    <div className=\"min-h-screen bg-white dark:bg-gray-950 p-4 md:p-8\">\n      <div className=\"max-w-7xl mx-auto space-y-4\">\n        {/* Header */}\n        <div className=\"flex flex-col md:flex-row items-start md:items-center justify-between gap-4\">\n          <div>\n            <div className=\"flex items-center gap-2\">\n              <Link href=\"/timesheets\">\n                <Button variant=\"ghost\" size=\"sm\" data-testid=\"button-back\">\n                  <ArrowLeft className=\"w-4 h-4\" />\n                </Button>\n              </Link>\n              <div>\n                <h1 className=\"text-2xl font-semibold text-gray-900 dark:text-gray-100\">\n                  Timesheet Detail\n                </h1>\n                <p className=\"text-sm text-gray-600 dark:text-gray-400\">\n                  {new Date(timesheet.date).toLocaleDateString()} - {getStatusBadge(timesheet.status)}\n                </p>\n              </div>\n            </div>\n          </div>\n          <div className=\"flex gap-2\">\n            <Button\n              onClick={handleSaveHeader}\n              disabled={updateTimesheetMutation.isPending || timesheet.status !== 'DRAFT'}\n              data-testid=\"button-save\"\n            >\n              <Save className=\"w-4 h-4 mr-2\" />\n              Save\n            </Button>\n            {timesheet.status === 'DRAFT' && (\n              <Button\n                onClick={handleSubmitTimesheet}\n                disabled={submitTimesheetMutation.isPending}\n                data-testid=\"button-submit\"\n              >\n                <Send className=\"w-4 h-4 mr-2\" />\n                Submit\n              </Button>\n            )}\n            {user?.role === 'ADMIN' && (\n              <Button\n                onClick={handleDeleteTimesheet}\n                disabled={deleteTimesheetMutation.isPending}\n                variant=\"destructive\"\n                data-testid=\"button-delete\"\n              >\n                <Trash2 className=\"w-4 h-4 mr-2\" />\n                Delete\n              </Button>\n            )}\n          </div>\n        </div>\n\n        {/* Timesheet Header - Excel Fields */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Timesheet Header</CardTitle>\n            <CardDescription>Project and crew information</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <Label htmlFor=\"projectName\">Project Name</Label>\n                <Input\n                  id=\"projectName\"\n                  value={headerData.projectName || ''}\n                  onChange={(e) => setHeaderData({ ...headerData, projectName: e.target.value })}\n                  placeholder=\"e.g., National Grid November Storm\"\n                  disabled={timesheet.status !== 'DRAFT'}\n                  data-testid=\"input-project-name\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"utilityName\">Utility Name</Label>\n                <Input\n                  id=\"utilityName\"\n                  value={headerData.utilityName || ''}\n                  onChange={(e) => setHeaderData({ ...headerData, utilityName: e.target.value })}\n                  placeholder=\"e.g., National Grid\"\n                  disabled={timesheet.status !== 'DRAFT'}\n                  data-testid=\"input-utility-name\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"teamGeneralForeman\">Team General Foreman</Label>\n                <Input\n                  id=\"teamGeneralForeman\"\n                  value={headerData.teamGeneralForeman || ''}\n                  onChange={(e) => setHeaderData({ ...headerData, teamGeneralForeman: e.target.value })}\n                  disabled={timesheet.status !== 'DRAFT'}\n                  data-testid=\"input-team-gf\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"crewForeman\">Crew Foreman</Label>\n                <Input\n                  id=\"crewForeman\"\n                  value={headerData.crewForeman || ''}\n                  onChange={(e) => setHeaderData({ ...headerData, crewForeman: e.target.value })}\n                  disabled={timesheet.status !== 'DRAFT'}\n                  data-testid=\"input-crew-foreman\"\n                />\n              </div>\n              <div className=\"md:col-span-2\">\n                <Label htmlFor=\"jobLocations\">Job Locations / Service Addresses</Label>\n                <Textarea\n                  id=\"jobLocations\"\n                  value={headerData.jobLocations || ''}\n                  onChange={(e) => setHeaderData({ ...headerData, jobLocations: e.target.value })}\n                  disabled={timesheet.status !== 'DRAFT'}\n                  data-testid=\"input-job-locations\"\n                  rows={2}\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"lodgingProvided\">Lodging Provided</Label>\n                <Select\n                  value={headerData.lodgingProvided === true ? 'yes' : 'no'}\n                  onValueChange={(val) => setHeaderData({ ...headerData, lodgingProvided: val === 'yes' })}\n                  disabled={timesheet.status !== 'DRAFT'}\n                >\n                  <SelectTrigger data-testid=\"select-lodging\">\n                    <SelectValue />\n                  </SelectTrigger>\n                  <SelectContent>\n                    <SelectItem value=\"yes\">Yes</SelectItem>\n                    <SelectItem value=\"no\">No</SelectItem>\n                  </SelectContent>\n                </Select>\n              </div>\n              <div>\n                <Label htmlFor=\"crewIdNumber\">Crew ID #</Label>\n                <Input\n                  id=\"crewIdNumber\"\n                  value={headerData.crewIdNumber || ''}\n                  onChange={(e) => setHeaderData({ ...headerData, crewIdNumber: e.target.value })}\n                  disabled={timesheet.status !== 'DRAFT'}\n                  data-testid=\"input-crew-id\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"locationAreaAssigned\">Location Area Assigned</Label>\n                <Input\n                  id=\"locationAreaAssigned\"\n                  value={headerData.locationAreaAssigned || ''}\n                  onChange={(e) => setHeaderData({ ...headerData, locationAreaAssigned: e.target.value })}\n                  disabled={timesheet.status !== 'DRAFT'}\n                  data-testid=\"input-location-area\"\n                />\n              </div>\n              <div>\n                <Label htmlFor=\"foremanPhone\">Foreman Phone Number</Label>\n                <Input\n                  id=\"foremanPhone\"\n                  value={headerData.foremanPhone || ''}\n                  onChange={(e) => setHeaderData({ ...headerData, foremanPhone: e.target.value })}\n                  disabled={timesheet.status !== 'DRAFT'}\n                  data-testid=\"input-foreman-phone\"\n                />\n              </div>\n              <div className=\"md:col-span-2\">\n                <Label htmlFor=\"workDescription\">Description of Work Performed</Label>\n                <Textarea\n                  id=\"workDescription\"\n                  value={headerData.workDescription || ''}\n                  onChange={(e) => setHeaderData({ ...headerData, workDescription: e.target.value })}\n                  disabled={timesheet.status !== 'DRAFT'}\n                  placeholder=\"Include mobilization/demobilization start and stop addresses\"\n                  data-testid=\"input-work-description\"\n                  rows={3}\n                />\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Personnel Table */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Personnel</CardTitle>\n            <CardDescription>Crew members and their work segments for this day</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {personnelLoading ? (\n              <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">Loading personnel...</div>\n            ) : personnel.length === 0 ? (\n              <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">\n                No personnel assigned. Personnel will be auto-populated from the roster.\n              </div>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Employee Name</TableHead>\n                      <TableHead>Classification</TableHead>\n                      <TableHead>Start Time</TableHead>\n                      <TableHead>End Time</TableHead>\n                      <TableHead>Total Hours</TableHead>\n                      <TableHead>Meals (Utility)</TableHead>\n                      <TableHead>Meals (Per Diem)</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {personnel.map((person) => {\n                      const editing = editingPersonnel[person.id] || {};\n                      // Extract start/end times from segments\n                      const firstSegment = (person.segments as WorkSegment[] || [])[0];\n                      const personStartTime = firstSegment?.startTime || '';\n                      const personEndTime = firstSegment?.endTime || '';\n                      \n                      // Coerce values to avoid null\n                      const classificationValue = editing.classification !== undefined ? editing.classification : (person.classification ?? '');\n                      const startTimeValue = editing.startTime !== undefined ? editing.startTime : personStartTime;\n                      const endTimeValue = editing.endTime !== undefined ? editing.endTime : personEndTime;\n                      const totalHoursValue = editing.totalHours !== undefined ? editing.totalHours : (person.totalHours ?? 0);\n                      const mealsUtilityValue = editing.mealsProvidedByUtility !== undefined ? editing.mealsProvidedByUtility : (person.mealsProvidedByUtility ?? 0);\n                      const perDiemMealsValue = editing.perDiemMeals !== undefined ? editing.perDiemMeals : (person.perDiemMeals ?? 0);\n                      \n                      return (\n                        <TableRow key={person.id} data-testid={`row-personnel-${person.id}`}>\n                          <TableCell className=\"font-medium\">{person.employeeName}</TableCell>\n                          <TableCell>\n                            <Input\n                              value={classificationValue == null ? '' : classificationValue}\n                              onChange={(e) => {\n                                setEditingPersonnel({\n                                  ...editingPersonnel,\n                                  [person.id]: { ...editing, classification: e.target.value }\n                                });\n                              }}\n                              onBlur={() => {\n                                if (editing.classification !== undefined && editing.classification !== person.classification) {\n                                  updatePersonnelMutation.mutate({\n                                    id: person.id,\n                                    data: { classification: editing.classification }\n                                  });\n                                }\n                              }}\n                              disabled={timesheet?.status !== 'DRAFT'}\n                              className=\"w-32\"\n                              placeholder=\"e.g., Foreman\"\n                            />\n                          </TableCell>\n                          <TableCell>\n                            <Input\n                              type=\"time\"\n                              value={startTimeValue == null ? '' : startTimeValue}\n                              onChange={(e) => {\n                                const newStartTime = e.target.value;\n                                const currentEndTime = editing.endTime !== undefined ? editing.endTime : personEndTime;\n                                const newTotalHours = calcShiftHours(newStartTime, currentEndTime || '');\n                                \n                                setEditingPersonnel({\n                                  ...editingPersonnel,\n                                  [person.id]: { ...editing, startTime: newStartTime, totalHours: newTotalHours }\n                                });\n                              }}\n                              onBlur={() => {\n                                if (editing.startTime !== undefined && editing.startTime !== personStartTime) {\n                                  const currentEndTime = editing.endTime !== undefined ? editing.endTime : personEndTime;\n                                  const updateData: Partial<TimesheetPersonnel> = { \n                                    startTime: editing.startTime,\n                                    endTime: currentEndTime || undefined,\n                                    segments: [{\n                                      activityType: 'S' as const,\n                                      startTime: editing.startTime,\n                                      endTime: currentEndTime || '',\n                                    }]\n                                  };\n                                  if (editing.totalHours !== undefined) {\n                                    updateData.totalHours = editing.totalHours;\n                                  }\n                                  updatePersonnelMutation.mutate({\n                                    id: person.id,\n                                    data: updateData\n                                  });\n                                }\n                              }}\n                              disabled={timesheet?.status !== 'DRAFT'}\n                              className=\"w-28\"\n                            />\n                          </TableCell>\n                          <TableCell>\n                            <Input\n                              type=\"time\"\n                              value={endTimeValue == null ? '' : endTimeValue}\n                              onChange={(e) => {\n                                const newEndTime = e.target.value;\n                                const currentStartTime = editing.startTime !== undefined ? editing.startTime : personStartTime;\n                                const newTotalHours = calcShiftHours(currentStartTime || '', newEndTime);\n                                \n                                setEditingPersonnel({\n                                  ...editingPersonnel,\n                                  [person.id]: { ...editing, endTime: newEndTime, totalHours: newTotalHours }\n                                });\n                              }}\n                              onBlur={() => {\n                                if (editing.endTime !== undefined && editing.endTime !== personEndTime) {\n                                  const currentStartTime = editing.startTime !== undefined ? editing.startTime : personStartTime;\n                                  const updateData: Partial<TimesheetPersonnel> = { \n                                    startTime: currentStartTime || undefined,\n                                    endTime: editing.endTime,\n                                    segments: [{\n                                      activityType: 'S' as const,\n                                      startTime: currentStartTime || '',\n                                      endTime: editing.endTime,\n                                    }]\n                                  };\n                                  if (editing.totalHours !== undefined) {\n                                    updateData.totalHours = editing.totalHours;\n                                  }\n                                  updatePersonnelMutation.mutate({\n                                    id: person.id,\n                                    data: updateData\n                                  });\n                                }\n                              }}\n                              disabled={timesheet?.status !== 'DRAFT'}\n                              className=\"w-28\"\n                            />\n                          </TableCell>\n                          <TableCell>\n                            <Input\n                              type=\"number\"\n                              step=\"0.5\"\n                              value={totalHoursValue == null ? '' : totalHoursValue}\n                              onChange={(e) => {\n                                setEditingPersonnel({\n                                  ...editingPersonnel,\n                                  [person.id]: { ...editing, totalHours: parseFloat(e.target.value) || 0 }\n                                });\n                              }}\n                              onBlur={() => {\n                                if (editing.totalHours !== undefined && editing.totalHours !== person.totalHours) {\n                                  updatePersonnelMutation.mutate({\n                                    id: person.id,\n                                    data: { totalHours: editing.totalHours }\n                                  });\n                                }\n                              }}\n                              disabled={timesheet?.status !== 'DRAFT'}\n                              className=\"w-20\"\n                            />\n                          </TableCell>\n                          <TableCell>\n                            <Input\n                              type=\"number\"\n                              value={mealsUtilityValue == null ? '' : mealsUtilityValue}\n                              onChange={(e) => {\n                                setEditingPersonnel({\n                                  ...editingPersonnel,\n                                  [person.id]: { ...editing, mealsProvidedByUtility: parseInt(e.target.value) || 0 }\n                                });\n                              }}\n                              onBlur={() => {\n                                if (editing.mealsProvidedByUtility !== undefined && editing.mealsProvidedByUtility !== person.mealsProvidedByUtility) {\n                                  updatePersonnelMutation.mutate({\n                                    id: person.id,\n                                    data: { mealsProvidedByUtility: editing.mealsProvidedByUtility }\n                                  });\n                                }\n                              }}\n                              disabled={timesheet?.status !== 'DRAFT'}\n                              className=\"w-16\"\n                            />\n                          </TableCell>\n                          <TableCell>\n                            <Input\n                              type=\"number\"\n                              value={perDiemMealsValue == null ? '' : perDiemMealsValue}\n                              onChange={(e) => {\n                                setEditingPersonnel({\n                                  ...editingPersonnel,\n                                  [person.id]: { ...editing, perDiemMeals: parseInt(e.target.value) || 0 }\n                                });\n                              }}\n                              onBlur={() => {\n                                if (editing.perDiemMeals !== undefined && editing.perDiemMeals !== person.perDiemMeals) {\n                                  updatePersonnelMutation.mutate({\n                                    id: person.id,\n                                    data: { perDiemMeals: editing.perDiemMeals }\n                                  });\n                                }\n                              }}\n                              disabled={timesheet?.status !== 'DRAFT'}\n                              className=\"w-16\"\n                            />\n                          </TableCell>\n                        </TableRow>\n                      );\n                    })}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n\n        {/* Equipment Table */}\n        <Card>\n          <CardHeader>\n            <CardTitle>Equipment</CardTitle>\n            <CardDescription>Equipment used by this crew for the day</CardDescription>\n          </CardHeader>\n          <CardContent>\n            {equipmentLoading ? (\n              <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">Loading equipment...</div>\n            ) : equipment.length === 0 ? (\n              <div className=\"text-center py-8 text-gray-600 dark:text-gray-400\">\n                No equipment assigned. Equipment will be auto-populated from the roster.\n              </div>\n            ) : (\n              <div className=\"overflow-x-auto\">\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead>Equipment Description</TableHead>\n                      <TableHead>Equipment #</TableHead>\n                      <TableHead>Start Time</TableHead>\n                      <TableHead>End Time</TableHead>\n                      <TableHead>Total Hours</TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {equipment.map((equip) => {\n                      const editing = editingEquipment[equip.id] || {};\n                      \n                      // Coerce values to avoid null\n                      const startTimeValue = editing.startTime !== undefined ? editing.startTime : (equip.startTime ?? '');\n                      const endTimeValue = editing.endTime !== undefined ? editing.endTime : (equip.endTime ?? '');\n                      const totalHoursValue = editing.totalHours !== undefined ? editing.totalHours : (equip.totalHours ?? 0);\n                      \n                      return (\n                        <TableRow key={equip.id} data-testid={`row-equipment-${equip.id}`}>\n                          <TableCell className=\"font-medium\">{equip.equipmentDescription}</TableCell>\n                          <TableCell>{equip.equipmentNumber || '-'}</TableCell>\n                          <TableCell>\n                            <Input\n                              type=\"time\"\n                              value={startTimeValue == null ? '' : startTimeValue}\n                              onChange={(e) => {\n                                const newStartTime = e.target.value;\n                                const currentEndTime = editing.endTime !== undefined ? editing.endTime : (equip.endTime ?? '');\n                                const newTotalHours = calcShiftHours(newStartTime, currentEndTime || '');\n                                \n                                setEditingEquipment({\n                                  ...editingEquipment,\n                                  [equip.id]: { ...editing, startTime: newStartTime, totalHours: newTotalHours }\n                                });\n                              }}\n                              onBlur={() => {\n                                if (editing.startTime !== undefined && editing.startTime !== equip.startTime) {\n                                  const updateData: Partial<TimesheetEquipment> = { startTime: editing.startTime };\n                                  if (editing.totalHours !== undefined) {\n                                    updateData.totalHours = editing.totalHours;\n                                  }\n                                  updateEquipmentMutation.mutate({\n                                    id: equip.id,\n                                    data: updateData\n                                  });\n                                }\n                              }}\n                              disabled={timesheet?.status !== 'DRAFT'}\n                              className=\"w-32\"\n                            />\n                          </TableCell>\n                          <TableCell>\n                            <Input\n                              type=\"time\"\n                              value={endTimeValue == null ? '' : endTimeValue}\n                              onChange={(e) => {\n                                const newEndTime = e.target.value;\n                                const currentStartTime = editing.startTime !== undefined ? editing.startTime : (equip.startTime ?? '');\n                                const newTotalHours = calcShiftHours(currentStartTime || '', newEndTime);\n                                \n                                setEditingEquipment({\n                                  ...editingEquipment,\n                                  [equip.id]: { ...editing, endTime: newEndTime, totalHours: newTotalHours }\n                                });\n                              }}\n                              onBlur={() => {\n                                if (editing.endTime !== undefined && editing.endTime !== equip.endTime) {\n                                  const updateData: Partial<TimesheetEquipment> = { endTime: editing.endTime };\n                                  if (editing.totalHours !== undefined) {\n                                    updateData.totalHours = editing.totalHours;\n                                  }\n                                  updateEquipmentMutation.mutate({\n                                    id: equip.id,\n                                    data: updateData\n                                  });\n                                }\n                              }}\n                              disabled={timesheet?.status !== 'DRAFT'}\n                              className=\"w-32\"\n                            />\n                          </TableCell>\n                          <TableCell>\n                            <Input\n                              type=\"number\"\n                              step=\"0.5\"\n                              value={totalHoursValue == null ? '' : totalHoursValue}\n                              onChange={(e) => {\n                                setEditingEquipment({\n                                  ...editingEquipment,\n                                  [equip.id]: { ...editing, totalHours: parseFloat(e.target.value) || 0 }\n                                });\n                              }}\n                              onBlur={() => {\n                                if (editing.totalHours !== undefined && editing.totalHours !== equip.totalHours) {\n                                  updateEquipmentMutation.mutate({\n                                    id: equip.id,\n                                    data: { totalHours: editing.totalHours }\n                                  });\n                                }\n                              }}\n                              disabled={timesheet?.status !== 'DRAFT'}\n                              className=\"w-20\"\n                            />\n                          </TableCell>\n                        </TableRow>\n                      );\n                    })}\n                  </TableBody>\n                </Table>\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":33615,"size_tokens":null},"client/src/pages/reports.tsx":{"content":"import { useState, useEffect } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport { Link } from 'wouter';\nimport { ArrowLeft, Download, Users, Wrench } from 'lucide-react';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';\nimport { useToast } from '@/hooks/use-toast';\nimport { useAuth } from '@/context/AuthContext';\nimport { useActiveSession } from '@/context/ActiveSessionContext';\nimport type { StormSession, Company, Timesheet, TimesheetPersonnel, TimesheetEquipment } from '@shared/schema';\nimport * as XLSX from 'xlsx';\n\ninterface PersonnelDailyHours {\n  employeeName: string;\n  classification: string;\n  dailyHours: Record<string, number>; // date -> hours\n  totalHours: number;\n}\n\ninterface EquipmentDailyHours {\n  equipmentDescription: string;\n  equipmentNumber: string;\n  dailyHours: Record<string, number>; // date -> hours\n  totalHours: number;\n}\n\nexport default function ReportsPage() {\n  const { user } = useAuth();\n  const { activeSession } = useActiveSession();\n  const { toast } = useToast();\n  \n  const [selectedSessionId, setSelectedSessionId] = useState<string>('');\n  const [hasUserSelectedSession, setHasUserSelectedSession] = useState(false);\n  const [selectedCompanyId, setSelectedCompanyId] = useState<string>('');\n\n  const canAccessReports = user?.role === 'ADMIN' || user?.role === 'MANAGER' || user?.role === 'CONTRACTOR' || user?.role === 'UTILITY';\n\n  // Fetch sessions\n  const { data: sessions } = useQuery<StormSession[]>({\n    queryKey: ['/api/storm-sessions'],\n  });\n\n  // Fetch companies\n  const { data: companies } = useQuery<Company[]>({\n    queryKey: ['/api/companies'],\n  });\n\n  // Auto-select active session (or first session as fallback) - only if user hasn't manually selected\n  useEffect(() => {\n    if (sessions && sessions.length > 0 && !hasUserSelectedSession) {\n      if (!selectedSessionId) {\n        // Initial selection: prefer active session\n        if (activeSession && sessions.some(s => s.id === activeSession.id)) {\n          setSelectedSessionId(activeSession.id);\n        } else {\n          setSelectedSessionId(sessions[0].id);\n        }\n      } else if (activeSession && sessions.some(s => s.id === activeSession.id) && selectedSessionId !== activeSession.id) {\n        // Active session became available - switch to it\n        setSelectedSessionId(activeSession.id);\n      }\n    }\n  }, [sessions, selectedSessionId, activeSession, hasUserSelectedSession]);\n\n  // Auto-select first company for contractors or first available company\n  useEffect(() => {\n    if (!selectedCompanyId && companies && companies.length > 0) {\n      // Validate user's company exists in the list before selecting it\n      if (user?.companyId && companies.some(c => c.id === user.companyId)) {\n        setSelectedCompanyId(user.companyId);\n      } else {\n        setSelectedCompanyId(companies[0].id);\n      }\n    }\n  }, [companies, selectedCompanyId, user?.companyId]);\n\n  // Fetch timesheets for selected session and company\n  const { data: timesheets, isLoading: timesheetsLoading } = useQuery<Timesheet[]>({\n    queryKey: ['/api/timesheets', selectedSessionId, selectedCompanyId],\n    queryFn: async () => {\n      if (!selectedSessionId || !selectedCompanyId) return [];\n      const response = await fetch(`/api/timesheets?sessionId=${selectedSessionId}&companyId=${selectedCompanyId}`);\n      if (!response.ok) throw new Error('Failed to fetch timesheets');\n      return response.json();\n    },\n    enabled: !!selectedSessionId && !!selectedCompanyId,\n  });\n\n  // Fetch personnel for all timesheets\n  const { data: allPersonnel } = useQuery<TimesheetPersonnel[]>({\n    queryKey: ['/api/timesheets/personnel', timesheets?.map(t => t.id)],\n    enabled: !!timesheets && timesheets.length > 0,\n    queryFn: async () => {\n      if (!timesheets || timesheets.length === 0) return [];\n      \n      const personnelByTimesheet = await Promise.all(\n        timesheets.map(async (ts) => {\n          const response = await fetch(`/api/timesheets/${ts.id}/personnel`);\n          if (!response.ok) throw new Error('Failed to fetch personnel');\n          return response.json();\n        })\n      );\n      \n      return personnelByTimesheet.flat();\n    },\n  });\n\n  // Fetch equipment for all timesheets\n  const { data: allEquipment } = useQuery<TimesheetEquipment[]>({\n    queryKey: ['/api/timesheets/equipment', timesheets?.map(t => t.id)],\n    enabled: !!timesheets && timesheets.length > 0,\n    queryFn: async () => {\n      if (!timesheets || timesheets.length === 0) return [];\n      \n      const equipmentByTimesheet = await Promise.all(\n        timesheets.map(async (ts) => {\n          const response = await fetch(`/api/timesheets/${ts.id}/equipment`);\n          if (!response.ok) throw new Error('Failed to fetch equipment');\n          return response.json();\n        })\n      );\n      \n      return equipmentByTimesheet.flat();\n    },\n  });\n\n  // Aggregate personnel data by person and date\n  const personnelReport: PersonnelDailyHours[] = (() => {\n    if (!allPersonnel || !timesheets) return [];\n\n    const personnelMap = new Map<string, PersonnelDailyHours>();\n\n    allPersonnel.forEach((person) => {\n      const timesheet = timesheets.find(ts => ts.id === person.timesheetId);\n      if (!timesheet) return;\n\n      const date = new Date(timesheet.date).toLocaleDateString('en-US');\n      const key = `${person.employeeName}-${person.classification}`;\n\n      if (!personnelMap.has(key)) {\n        personnelMap.set(key, {\n          employeeName: person.employeeName,\n          classification: person.classification,\n          dailyHours: {},\n          totalHours: 0,\n        });\n      }\n\n      const record = personnelMap.get(key)!;\n      record.dailyHours[date] = (record.dailyHours[date] || 0) + (person.totalHours || 0);\n      record.totalHours += person.totalHours || 0;\n    });\n\n    return Array.from(personnelMap.values()).sort((a, b) => \n      a.employeeName.localeCompare(b.employeeName)\n    );\n  })();\n\n  // Aggregate equipment data by equipment and date\n  const equipmentReport: EquipmentDailyHours[] = (() => {\n    if (!allEquipment || !timesheets) return [];\n\n    const equipmentMap = new Map<string, EquipmentDailyHours>();\n\n    allEquipment.forEach((equip) => {\n      const timesheet = timesheets.find(ts => ts.id === equip.timesheetId);\n      if (!timesheet) return;\n\n      const date = new Date(timesheet.date).toLocaleDateString('en-US');\n      const key = `${equip.equipmentDescription}-${equip.equipmentNumber || 'N/A'}`;\n\n      if (!equipmentMap.has(key)) {\n        equipmentMap.set(key, {\n          equipmentDescription: equip.equipmentDescription,\n          equipmentNumber: equip.equipmentNumber || '',\n          dailyHours: {},\n          totalHours: 0,\n        });\n      }\n\n      const record = equipmentMap.get(key)!;\n      record.dailyHours[date] = (record.dailyHours[date] || 0) + (equip.totalHours || 0);\n      record.totalHours += equip.totalHours || 0;\n    });\n\n    return Array.from(equipmentMap.values()).sort((a, b) => \n      a.equipmentDescription.localeCompare(b.equipmentDescription)\n    );\n  })();\n\n  // Get all unique dates sorted\n  const allDates = (() => {\n    if (!timesheets) return [];\n    return Array.from(new Set(timesheets.map(ts => \n      new Date(ts.date).toLocaleDateString('en-US')\n    ))).sort((a, b) => new Date(a).getTime() - new Date(b).getTime());\n  })();\n\n  const exportToExcel = () => {\n    if (!personnelReport.length && !equipmentReport.length) {\n      toast({ title: 'No data to export', variant: 'destructive' });\n      return;\n    }\n\n    const workbook = XLSX.utils.book_new();\n\n    // Personnel sheet\n    if (personnelReport.length > 0) {\n      const personnelData = personnelReport.map(person => {\n        const row: any = {\n          'Employee Name': person.employeeName,\n          'Classification': person.classification,\n        };\n        \n        allDates.forEach(date => {\n          row[date] = person.dailyHours[date] || 0;\n        });\n        \n        row['Total Hours'] = person.totalHours;\n        return row;\n      });\n\n      const personnelSheet = XLSX.utils.json_to_sheet(personnelData);\n      XLSX.utils.book_append_sheet(workbook, personnelSheet, 'Personnel Hours');\n    }\n\n    // Equipment sheet\n    if (equipmentReport.length > 0) {\n      const equipmentData = equipmentReport.map(equip => {\n        const row: any = {\n          'Equipment Description': equip.equipmentDescription,\n          'Equipment Number': equip.equipmentNumber || 'N/A',\n        };\n        \n        allDates.forEach(date => {\n          row[date] = equip.dailyHours[date] || 0;\n        });\n        \n        row['Total Hours'] = equip.totalHours;\n        return row;\n      });\n\n      const equipmentSheet = XLSX.utils.json_to_sheet(equipmentData);\n      XLSX.utils.book_append_sheet(workbook, equipmentSheet, 'Equipment Hours');\n    }\n\n    const companyName = companies?.find(c => c.id === selectedCompanyId)?.name || 'Company';\n    const sessionName = sessions?.find(s => s.id === selectedSessionId)?.name || 'Session';\n    const fileName = `${companyName}_${sessionName}_Hours_Report.xlsx`;\n\n    XLSX.writeFile(workbook, fileName);\n    toast({ title: 'Report exported successfully' });\n  };\n\n  if (!canAccessReports) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-8\">\n        <div className=\"max-w-7xl mx-auto\">\n          <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white mb-6\">Reports</h1>\n          <p className=\"text-gray-600 dark:text-gray-400\">\n            You do not have permission to access reports.\n          </p>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50 dark:bg-gray-900 p-8\">\n      <div className=\"max-w-7xl mx-auto\">\n        <div className=\"mb-6 flex items-center gap-4\">\n          <Link href=\"/\" data-testid=\"link-back\">\n            <Button variant=\"ghost\" size=\"icon\">\n              <ArrowLeft className=\"w-5 h-5\" />\n            </Button>\n          </Link>\n          <div className=\"flex-1\">\n            <h1 className=\"text-3xl font-bold text-gray-900 dark:text-white\">Reports</h1>\n            <p className=\"text-gray-600 dark:text-gray-400\">Daily hours reports by personnel and equipment</p>\n          </div>\n          <Button\n            onClick={exportToExcel}\n            disabled={!personnelReport.length && !equipmentReport.length}\n            data-testid=\"button-export\"\n          >\n            <Download className=\"w-4 h-4 mr-2\" />\n            Export to Excel\n          </Button>\n        </div>\n\n        {/* Filters */}\n        <Card className=\"mb-6\">\n          <CardHeader>\n            <CardTitle>Report Filters</CardTitle>\n            <CardDescription>Select session and company to view hours report</CardDescription>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n              <div>\n                <label className=\"text-sm font-medium mb-2 block text-gray-900 dark:text-gray-100\">\n                  Storm Session\n                </label>\n                <Select value={selectedSessionId} onValueChange={(value) => { setSelectedSessionId(value); setHasUserSelectedSession(true); }}>\n                  <SelectTrigger data-testid=\"select-session\">\n                    <SelectValue placeholder=\"Select session\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {sessions?.map((session) => (\n                      <SelectItem key={session.id} value={session.id}>\n                        {session.name}\n                        {activeSession?.id === session.id && ' ⭐ ACTIVE'}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n\n              <div>\n                <label className=\"text-sm font-medium mb-2 block text-gray-900 dark:text-gray-100\">\n                  Company\n                </label>\n                <Select value={selectedCompanyId} onValueChange={setSelectedCompanyId}>\n                  <SelectTrigger data-testid=\"select-company\">\n                    <SelectValue placeholder=\"Select company\" />\n                  </SelectTrigger>\n                  <SelectContent>\n                    {companies?.map((company) => (\n                      <SelectItem key={company.id} value={company.id}>\n                        {company.name}\n                      </SelectItem>\n                    ))}\n                  </SelectContent>\n                </Select>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n\n        {/* Report Data */}\n        {selectedSessionId && selectedCompanyId && (\n          <>\n            {timesheetsLoading ? (\n              <div className=\"text-center py-8\">\n                <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto\"></div>\n                <p className=\"mt-4 text-gray-600 dark:text-gray-400\">Loading report data...</p>\n              </div>\n            ) : !timesheets?.length ? (\n              <Card>\n                <CardContent className=\"py-8\">\n                  <p className=\"text-center text-gray-600 dark:text-gray-400\">\n                    No timesheets found for selected session and company.\n                  </p>\n                </CardContent>\n              </Card>\n            ) : (\n              <Tabs defaultValue=\"personnel\" className=\"space-y-4\">\n                <TabsList>\n                  <TabsTrigger value=\"personnel\" data-testid=\"tab-personnel\">\n                    <Users className=\"w-4 h-4 mr-2\" />\n                    Personnel ({personnelReport.length})\n                  </TabsTrigger>\n                  <TabsTrigger value=\"equipment\" data-testid=\"tab-equipment\">\n                    <Wrench className=\"w-4 h-4 mr-2\" />\n                    Equipment ({equipmentReport.length})\n                  </TabsTrigger>\n                </TabsList>\n\n                {/* Personnel Report */}\n                <TabsContent value=\"personnel\">\n                  <Card>\n                    <CardHeader>\n                      <CardTitle>Personnel Daily Hours</CardTitle>\n                      <CardDescription>Hours worked by each person across all dates</CardDescription>\n                    </CardHeader>\n                    <CardContent>\n                      {personnelReport.length === 0 ? (\n                        <p className=\"text-center text-gray-600 dark:text-gray-400 py-4\">\n                          No personnel data available.\n                        </p>\n                      ) : (\n                        <div className=\"overflow-x-auto\">\n                          <Table>\n                            <TableHeader>\n                              <TableRow>\n                                <TableHead className=\"sticky left-0 bg-white dark:bg-gray-950 z-10\">Employee Name</TableHead>\n                                <TableHead className=\"sticky left-[200px] bg-white dark:bg-gray-950 z-10\">Classification</TableHead>\n                                {allDates.map(date => (\n                                  <TableHead key={date} className=\"text-right\">{date}</TableHead>\n                                ))}\n                                <TableHead className=\"text-right font-bold\">Total Hours</TableHead>\n                              </TableRow>\n                            </TableHeader>\n                            <TableBody>\n                              {personnelReport.map((person, idx) => (\n                                <TableRow key={idx}>\n                                  <TableCell className=\"sticky left-0 bg-white dark:bg-gray-950 font-medium\">\n                                    {person.employeeName}\n                                  </TableCell>\n                                  <TableCell className=\"sticky left-[200px] bg-white dark:bg-gray-950\">\n                                    {person.classification}\n                                  </TableCell>\n                                  {allDates.map(date => (\n                                    <TableCell key={date} className=\"text-right\">\n                                      {person.dailyHours[date]?.toFixed(2) || '0.00'}\n                                    </TableCell>\n                                  ))}\n                                  <TableCell className=\"text-right font-bold\">\n                                    {person.totalHours.toFixed(2)}\n                                  </TableCell>\n                                </TableRow>\n                              ))}\n                            </TableBody>\n                          </Table>\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n                </TabsContent>\n\n                {/* Equipment Report */}\n                <TabsContent value=\"equipment\">\n                  <Card>\n                    <CardHeader>\n                      <CardTitle>Equipment Daily Hours</CardTitle>\n                      <CardDescription>Hours worked by each piece of equipment across all dates</CardDescription>\n                    </CardHeader>\n                    <CardContent>\n                      {equipmentReport.length === 0 ? (\n                        <p className=\"text-center text-gray-600 dark:text-gray-400 py-4\">\n                          No equipment data available.\n                        </p>\n                      ) : (\n                        <div className=\"overflow-x-auto\">\n                          <Table>\n                            <TableHeader>\n                              <TableRow>\n                                <TableHead className=\"sticky left-0 bg-white dark:bg-gray-950 z-10\">Equipment Description</TableHead>\n                                <TableHead className=\"sticky left-[250px] bg-white dark:bg-gray-950 z-10\">Equipment Number</TableHead>\n                                {allDates.map(date => (\n                                  <TableHead key={date} className=\"text-right\">{date}</TableHead>\n                                ))}\n                                <TableHead className=\"text-right font-bold\">Total Hours</TableHead>\n                              </TableRow>\n                            </TableHeader>\n                            <TableBody>\n                              {equipmentReport.map((equip, idx) => (\n                                <TableRow key={idx}>\n                                  <TableCell className=\"sticky left-0 bg-white dark:bg-gray-950 font-medium\">\n                                    {equip.equipmentDescription}\n                                  </TableCell>\n                                  <TableCell className=\"sticky left-[250px] bg-white dark:bg-gray-950\">\n                                    {equip.equipmentNumber || 'N/A'}\n                                  </TableCell>\n                                  {allDates.map(date => (\n                                    <TableCell key={date} className=\"text-right\">\n                                      {equip.dailyHours[date]?.toFixed(2) || '0.00'}\n                                    </TableCell>\n                                  ))}\n                                  <TableCell className=\"text-right font-bold\">\n                                    {equip.totalHours.toFixed(2)}\n                                  </TableCell>\n                                </TableRow>\n                              ))}\n                            </TableBody>\n                          </Table>\n                        </div>\n                      )}\n                    </CardContent>\n                  </Card>\n                </TabsContent>\n              </Tabs>\n            )}\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n","path":null,"size_bytes":20125,"size_tokens":null},"client/src/context/ActiveSessionContext.tsx":{"content":"import { createContext, useContext, ReactNode } from 'react';\nimport { useQuery } from '@tanstack/react-query';\nimport type { StormSession } from '@shared/schema';\n\ninterface ActiveSessionContextValue {\n  activeSession: StormSession | null;\n  isLoading: boolean;\n  error: Error | null;\n}\n\nconst ActiveSessionContext = createContext<ActiveSessionContextValue | undefined>(undefined);\n\nexport function ActiveSessionProvider({ children }: { children: ReactNode }) {\n  const { data, isLoading, error } = useQuery<{ activeSession: StormSession | null }>({\n    queryKey: ['/api/storm-sessions/active'],\n    retry: false,\n    refetchOnWindowFocus: true,\n  });\n\n  const value: ActiveSessionContextValue = {\n    activeSession: data?.activeSession || null,\n    isLoading,\n    error: error as Error | null,\n  };\n\n  return (\n    <ActiveSessionContext.Provider value={value}>\n      {children}\n    </ActiveSessionContext.Provider>\n  );\n}\n\nexport function useActiveSession() {\n  const context = useContext(ActiveSessionContext);\n  if (context === undefined) {\n    throw new Error('useActiveSession must be used within an ActiveSessionProvider');\n  }\n  return context;\n}\n","path":null,"size_bytes":1155,"size_tokens":null},"client/src/pages/tickets.tsx":{"content":"import { useState } from 'react';\nimport { useQuery, useMutation } from '@tanstack/react-query';\nimport { queryClient, apiRequest } from '@/lib/queryClient';\nimport { useAuth } from '@/context/AuthContext';\nimport { useActiveSession } from '@/context/ActiveSessionContext';\nimport AppHeader from '@/components/AppHeader';\nimport { Button } from '@/components/ui/button';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Badge } from '@/components/ui/badge';\nimport { Input } from '@/components/ui/input';\nimport { Textarea } from '@/components/ui/textarea';\nimport { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';\nimport { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '@/components/ui/dialog';\nimport { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';\nimport { Skeleton } from '@/components/ui/skeleton';\nimport { useToast } from '@/hooks/use-toast';\nimport type { Ticket, IssueType, StormSession, Company, Crew } from '@shared/schema';\nimport {\n  Plus,\n  Ticket as TicketIcon,\n  Filter,\n  MapPin,\n  Clock,\n  AlertTriangle,\n  CheckCircle,\n  XCircle,\n  ArrowLeft,\n  Play,\n  Square,\n  UserCheck,\n  UserX,\n  Send,\n  ChevronRight,\n} from 'lucide-react';\n\nconst STATUS_COLORS: Record<string, string> = {\n  CREATED: 'bg-gray-100 text-gray-800',\n  ASSIGNED: 'bg-blue-100 text-blue-800',\n  ACCEPTED: 'bg-cyan-100 text-cyan-800',\n  ENROUTE: 'bg-yellow-100 text-yellow-800',\n  ON_SITE: 'bg-orange-100 text-orange-800',\n  WORKING: 'bg-purple-100 text-purple-800',\n  BLOCKED: 'bg-red-100 text-red-800',\n  COMPLETED: 'bg-green-100 text-green-800',\n  CLOSED: 'bg-gray-200 text-gray-600',\n  CANCELLED: 'bg-red-200 text-red-600',\n};\n\nconst PRIORITY_COLORS: Record<string, string> = {\n  P1: 'bg-red-600 text-white',\n  P2: 'bg-orange-500 text-white',\n  P3: 'bg-yellow-500 text-white',\n};\n\nconst ALL_STATUSES = ['CREATED', 'ASSIGNED', 'ACCEPTED', 'ENROUTE', 'ON_SITE', 'WORKING', 'BLOCKED', 'COMPLETED', 'CLOSED', 'CANCELLED'];\n\nexport default function TicketsPage() {\n  const { user } = useAuth();\n  const { activeSession } = useActiveSession();\n  const { toast } = useToast();\n  const [selectedTicketId, setSelectedTicketId] = useState<string | null>(null);\n  const [filterStatus, setFilterStatus] = useState<string>('all');\n  const [filterPriority, setFilterPriority] = useState<string>('all');\n  const [searchQuery, setSearchQuery] = useState('');\n  const [showCreateDialog, setShowCreateDialog] = useState(false);\n  const [showAssignDialog, setShowAssignDialog] = useState(false);\n  const [selectedSessionFilter, setSelectedSessionFilter] = useState<string>(activeSession?.id || '');\n\n  const effectiveSessionId = selectedSessionFilter || activeSession?.id;\n\n  const { data: sessions = [] } = useQuery<StormSession[]>({\n    queryKey: ['/api/storm-sessions'],\n  });\n\n  const { data: ticketsList = [], isLoading: ticketsLoading } = useQuery<Ticket[]>({\n    queryKey: ['/api/tickets', { sessionId: effectiveSessionId }],\n    queryFn: async () => {\n      if (!effectiveSessionId) return [];\n      const res = await fetch(`/api/tickets?sessionId=${effectiveSessionId}`, { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed to fetch tickets');\n      return res.json();\n    },\n    enabled: !!effectiveSessionId,\n  });\n\n  const { data: issueTypes = [] } = useQuery<IssueType[]>({\n    queryKey: ['/api/issue-types'],\n  });\n\n  const { data: companies = [] } = useQuery<Company[]>({\n    queryKey: ['/api/companies'],\n  });\n\n  const { data: selectedTicket } = useQuery<Ticket>({\n    queryKey: ['/api/tickets', selectedTicketId],\n    enabled: !!selectedTicketId,\n  });\n\n  const { data: ticketEvents = [] } = useQuery<any[]>({\n    queryKey: ['/api/tickets', selectedTicketId, 'events'],\n    queryFn: async () => {\n      const res = await fetch(`/api/tickets/${selectedTicketId}/events`, { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed');\n      return res.json();\n    },\n    enabled: !!selectedTicketId,\n  });\n\n  const { data: ticketAssignments = [] } = useQuery<any[]>({\n    queryKey: ['/api/tickets', selectedTicketId, 'assignments'],\n    queryFn: async () => {\n      const res = await fetch(`/api/tickets/${selectedTicketId}/assignments`, { credentials: 'include' });\n      if (!res.ok) throw new Error('Failed');\n      return res.json();\n    },\n    enabled: !!selectedTicketId,\n  });\n\n  const filteredTickets = ticketsList.filter((t) => {\n    if (filterStatus !== 'all' && t.status !== filterStatus) return false;\n    if (filterPriority !== 'all' && t.priority !== filterPriority) return false;\n    if (searchQuery) {\n      const q = searchQuery.toLowerCase();\n      return (\n        (t.title || '').toLowerCase().includes(q) ||\n        (t.externalRef || '').toLowerCase().includes(q) ||\n        (t.addressText || '').toLowerCase().includes(q) ||\n        t.id.toLowerCase().includes(q)\n      );\n    }\n    return true;\n  });\n\n  const issueTypeMap = Object.fromEntries(issueTypes.map((it) => [it.id, it]));\n\n  if (!user) return null;\n\n  if (selectedTicketId && selectedTicket) {\n    return (\n      <div className=\"min-h-screen bg-gray-50\">\n        <AppHeader />\n        <div className=\"pt-16 sm:pt-20 max-w-5xl mx-auto px-4 py-6\">\n          <TicketDetailView\n            ticket={selectedTicket}\n            issueTypes={issueTypes}\n            events={ticketEvents}\n            assignments={ticketAssignments}\n            companies={companies}\n            user={user}\n            onBack={() => setSelectedTicketId(null)}\n            onAssign={() => setShowAssignDialog(true)}\n            sessionId={effectiveSessionId || ''}\n          />\n          {showAssignDialog && (\n            <AssignDialog\n              ticketId={selectedTicket.id}\n              sessionId={selectedTicket.sessionId}\n              open={showAssignDialog}\n              onClose={() => setShowAssignDialog(false)}\n            />\n          )}\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      <AppHeader />\n      <div className=\"pt-16 sm:pt-20 max-w-7xl mx-auto px-4 py-6\">\n        <div className=\"flex items-center justify-between mb-6\">\n          <div className=\"flex items-center gap-3\">\n            <TicketIcon className=\"w-6 h-6 text-blue-600\" />\n            <h2 className=\"text-2xl font-bold text-gray-900\">Tickets</h2>\n          </div>\n          {(user.role === 'MANAGER' || user.role === 'UTILITY') && (\n            <Dialog open={showCreateDialog} onOpenChange={setShowCreateDialog}>\n              <DialogTrigger asChild>\n                <Button>\n                  <Plus className=\"w-4 h-4 mr-2\" />\n                  Create Ticket\n                </Button>\n              </DialogTrigger>\n              <DialogContent className=\"max-w-lg\">\n                <DialogHeader>\n                  <DialogTitle>Create New Ticket</DialogTitle>\n                </DialogHeader>\n                <CreateTicketForm\n                  sessionId={effectiveSessionId || ''}\n                  sessions={sessions}\n                  issueTypes={issueTypes}\n                  onSuccess={() => setShowCreateDialog(false)}\n                />\n              </DialogContent>\n            </Dialog>\n          )}\n        </div>\n\n        {/* Session filter */}\n        <div className=\"mb-4\">\n          <Select value={selectedSessionFilter || (activeSession?.id || '')} onValueChange={setSelectedSessionFilter}>\n            <SelectTrigger className=\"w-72\">\n              <SelectValue placeholder=\"Select a session\" />\n            </SelectTrigger>\n            <SelectContent>\n              {sessions.filter(s => !s.deletedAt).map((s) => (\n                <SelectItem key={s.id} value={s.id}>\n                  {s.name} {s.isActive ? '(Active)' : ''}\n                </SelectItem>\n              ))}\n            </SelectContent>\n          </Select>\n        </div>\n\n        {!effectiveSessionId ? (\n          <Card>\n            <CardContent className=\"py-12 text-center text-gray-500\">\n              Select a storm session to view tickets.\n            </CardContent>\n          </Card>\n        ) : (\n          <>\n            {/* Filters */}\n            <div className=\"flex flex-wrap gap-3 mb-4\">\n              <Input\n                placeholder=\"Search tickets...\"\n                value={searchQuery}\n                onChange={(e) => setSearchQuery(e.target.value)}\n                className=\"w-64\"\n              />\n              <Select value={filterStatus} onValueChange={setFilterStatus}>\n                <SelectTrigger className=\"w-40\">\n                  <SelectValue placeholder=\"Status\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All Statuses</SelectItem>\n                  {ALL_STATUSES.map((s) => (\n                    <SelectItem key={s} value={s}>{s}</SelectItem>\n                  ))}\n                </SelectContent>\n              </Select>\n              <Select value={filterPriority} onValueChange={setFilterPriority}>\n                <SelectTrigger className=\"w-32\">\n                  <SelectValue placeholder=\"Priority\" />\n                </SelectTrigger>\n                <SelectContent>\n                  <SelectItem value=\"all\">All</SelectItem>\n                  <SelectItem value=\"P1\">P1</SelectItem>\n                  <SelectItem value=\"P2\">P2</SelectItem>\n                  <SelectItem value=\"P3\">P3</SelectItem>\n                </SelectContent>\n              </Select>\n            </div>\n\n            {/* Summary badges */}\n            <div className=\"flex flex-wrap gap-2 mb-4\">\n              {['CREATED', 'ASSIGNED', 'ACCEPTED', 'WORKING', 'BLOCKED', 'COMPLETED'].map((s) => {\n                const count = ticketsList.filter((t) => t.status === s).length;\n                if (count === 0) return null;\n                return (\n                  <Badge\n                    key={s}\n                    className={`${STATUS_COLORS[s]} cursor-pointer`}\n                    onClick={() => setFilterStatus(filterStatus === s ? 'all' : s)}\n                  >\n                    {s}: {count}\n                  </Badge>\n                );\n              })}\n            </div>\n\n            {ticketsLoading ? (\n              <div className=\"space-y-2\">\n                {[1, 2, 3].map((i) => (\n                  <Skeleton key={i} className=\"h-14 w-full\" />\n                ))}\n              </div>\n            ) : filteredTickets.length === 0 ? (\n              <Card>\n                <CardContent className=\"py-12 text-center text-gray-500\">\n                  No tickets found. {user.role === 'MANAGER' || user.role === 'UTILITY' ? 'Create one to get started.' : ''}\n                </CardContent>\n              </Card>\n            ) : (\n              <Card>\n                <Table>\n                  <TableHeader>\n                    <TableRow>\n                      <TableHead className=\"w-20\">Priority</TableHead>\n                      <TableHead>Title / ID</TableHead>\n                      <TableHead>Issue Type</TableHead>\n                      <TableHead>Status</TableHead>\n                      <TableHead>Location</TableHead>\n                      <TableHead className=\"w-10\"></TableHead>\n                    </TableRow>\n                  </TableHeader>\n                  <TableBody>\n                    {filteredTickets.map((ticket) => (\n                      <TableRow\n                        key={ticket.id}\n                        className=\"cursor-pointer hover:bg-gray-50\"\n                        onClick={() => setSelectedTicketId(ticket.id)}\n                      >\n                        <TableCell>\n                          <Badge className={PRIORITY_COLORS[ticket.priority || 'P2']}>\n                            {ticket.priority}\n                          </Badge>\n                        </TableCell>\n                        <TableCell>\n                          <div className=\"font-medium\">{ticket.title || 'Untitled'}</div>\n                          <div className=\"text-xs text-gray-500\">{ticket.id.slice(0, 8)}...</div>\n                        </TableCell>\n                        <TableCell className=\"text-sm\">\n                          {issueTypeMap[ticket.issueTypeId]?.name || ticket.issueTypeId?.slice(0, 8)}\n                        </TableCell>\n                        <TableCell>\n                          <Badge className={STATUS_COLORS[ticket.status || 'CREATED']}>\n                            {ticket.status}\n                          </Badge>\n                        </TableCell>\n                        <TableCell className=\"text-sm text-gray-600 max-w-[200px] truncate\">\n                          {ticket.addressText || '-'}\n                        </TableCell>\n                        <TableCell>\n                          <ChevronRight className=\"w-4 h-4 text-gray-400\" />\n                        </TableCell>\n                      </TableRow>\n                    ))}\n                  </TableBody>\n                </Table>\n              </Card>\n            )}\n          </>\n        )}\n      </div>\n    </div>\n  );\n}\n\nfunction CreateTicketForm({\n  sessionId,\n  sessions,\n  issueTypes,\n  onSuccess,\n}: {\n  sessionId: string;\n  sessions: StormSession[];\n  issueTypes: IssueType[];\n  onSuccess: () => void;\n}) {\n  const { toast } = useToast();\n  const [formSessionId, setFormSessionId] = useState(sessionId);\n  const [issueTypeId, setIssueTypeId] = useState('');\n  const [title, setTitle] = useState('');\n  const [description, setDescription] = useState('');\n  const [priority, setPriority] = useState('P2');\n  const [addressText, setAddressText] = useState('');\n  const [externalRef, setExternalRef] = useState('');\n  const [feeder, setFeeder] = useState('');\n  const [circuit, setCircuit] = useState('');\n\n  const createMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest('POST', '/api/tickets', {\n        sessionId: formSessionId,\n        issueTypeId,\n        title: title || null,\n        description: description || null,\n        priority,\n        addressText: addressText || null,\n        externalRef: externalRef || null,\n        feeder: feeder || null,\n        circuit: circuit || null,\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: 'Ticket created successfully' });\n      queryClient.invalidateQueries({ queryKey: ['/api/tickets'] });\n      onSuccess();\n    },\n    onError: (error: any) => {\n      toast({ title: 'Error creating ticket', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  const selectedIssueType = issueTypes.find((it) => it.id === issueTypeId);\n\n  return (\n    <div className=\"space-y-4\">\n      <div>\n        <label className=\"text-sm font-medium mb-1 block\">Session</label>\n        <Select value={formSessionId} onValueChange={setFormSessionId}>\n          <SelectTrigger>\n            <SelectValue placeholder=\"Select session\" />\n          </SelectTrigger>\n          <SelectContent>\n            {sessions.filter(s => !s.deletedAt).map((s) => (\n              <SelectItem key={s.id} value={s.id}>{s.name}</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n      <div>\n        <label className=\"text-sm font-medium mb-1 block\">Issue Type</label>\n        <Select value={issueTypeId} onValueChange={(v) => {\n          setIssueTypeId(v);\n          const it = issueTypes.find((i) => i.id === v);\n          if (it) setPriority(it.defaultPriority || 'P2');\n        }}>\n          <SelectTrigger>\n            <SelectValue placeholder=\"Select issue type\" />\n          </SelectTrigger>\n          <SelectContent>\n            {issueTypes.filter(it => it.isActive).map((it) => (\n              <SelectItem key={it.id} value={it.id}>{it.name} ({it.code})</SelectItem>\n            ))}\n          </SelectContent>\n        </Select>\n      </div>\n      <div>\n        <label className=\"text-sm font-medium mb-1 block\">Title</label>\n        <Input value={title} onChange={(e) => setTitle(e.target.value)} placeholder=\"Brief ticket title\" />\n      </div>\n      <div>\n        <label className=\"text-sm font-medium mb-1 block\">Priority</label>\n        <Select value={priority} onValueChange={setPriority}>\n          <SelectTrigger>\n            <SelectValue />\n          </SelectTrigger>\n          <SelectContent>\n            <SelectItem value=\"P1\">P1 - Critical</SelectItem>\n            <SelectItem value=\"P2\">P2 - High</SelectItem>\n            <SelectItem value=\"P3\">P3 - Normal</SelectItem>\n          </SelectContent>\n        </Select>\n      </div>\n      <div>\n        <label className=\"text-sm font-medium mb-1 block\">Description</label>\n        <Textarea value={description} onChange={(e) => setDescription(e.target.value)} placeholder=\"Detailed description...\" rows={3} />\n      </div>\n      <div>\n        <label className=\"text-sm font-medium mb-1 block\">Address / Location</label>\n        <Input value={addressText} onChange={(e) => setAddressText(e.target.value)} placeholder=\"Street address or location description\" />\n      </div>\n      <div className=\"grid grid-cols-2 gap-3\">\n        <div>\n          <label className=\"text-sm font-medium mb-1 block\">Feeder</label>\n          <Input value={feeder} onChange={(e) => setFeeder(e.target.value)} placeholder=\"Feeder ID\" />\n        </div>\n        <div>\n          <label className=\"text-sm font-medium mb-1 block\">Circuit</label>\n          <Input value={circuit} onChange={(e) => setCircuit(e.target.value)} placeholder=\"Circuit ID\" />\n        </div>\n      </div>\n      <div>\n        <label className=\"text-sm font-medium mb-1 block\">External Reference</label>\n        <Input value={externalRef} onChange={(e) => setExternalRef(e.target.value)} placeholder=\"OMS reference number\" />\n      </div>\n      <Button\n        className=\"w-full\"\n        onClick={() => createMutation.mutate()}\n        disabled={!formSessionId || !issueTypeId || createMutation.isPending}\n      >\n        {createMutation.isPending ? 'Creating...' : 'Create Ticket'}\n      </Button>\n    </div>\n  );\n}\n\nfunction TicketDetailView({\n  ticket,\n  issueTypes,\n  events,\n  assignments,\n  companies,\n  user,\n  onBack,\n  onAssign,\n  sessionId,\n}: {\n  ticket: Ticket;\n  issueTypes: IssueType[];\n  events: any[];\n  assignments: any[];\n  companies: Company[];\n  user: any;\n  onBack: () => void;\n  onAssign: () => void;\n  sessionId: string;\n}) {\n  const { toast } = useToast();\n  const issueType = issueTypes.find((it) => it.id === ticket.issueTypeId);\n  const activeAssignment = assignments.find((a: any) => a.isActive);\n  const companyName = companies.find((c) => c.id === ticket.companyId)?.name;\n\n  const statusMutation = useMutation({\n    mutationFn: async ({ status, note }: { status: string; note?: string }) => {\n      const res = await apiRequest('POST', `/api/tickets/${ticket.id}/status`, { status, note });\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: 'Status updated' });\n      queryClient.invalidateQueries({ queryKey: ['/api/tickets'] });\n    },\n    onError: (error: any) => {\n      toast({ title: 'Error', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  const respondMutation = useMutation({\n    mutationFn: async ({ assignmentId, action, note }: { assignmentId: string; action: string; note?: string }) => {\n      const res = await apiRequest('POST', `/api/ticket-assignments/${assignmentId}/respond`, { action, note });\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: 'Response submitted' });\n      queryClient.invalidateQueries({ queryKey: ['/api/tickets'] });\n    },\n    onError: (error: any) => {\n      toast({ title: 'Error', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  const getNextActions = () => {\n    const actions: { label: string; status: string; icon: any; variant: any }[] = [];\n    const s = ticket.status;\n    if (s === 'ACCEPTED') {\n      actions.push({ label: 'En Route', status: 'ENROUTE', icon: Send, variant: 'outline' as const });\n    }\n    if (s === 'ENROUTE' || s === 'ACCEPTED') {\n      actions.push({ label: 'On Site', status: 'ON_SITE', icon: MapPin, variant: 'outline' as const });\n    }\n    if (s === 'ON_SITE' || s === 'ACCEPTED' || s === 'ENROUTE') {\n      actions.push({ label: 'Start Work', status: 'WORKING', icon: Play, variant: 'default' as const });\n    }\n    if (s === 'WORKING' || s === 'ON_SITE') {\n      actions.push({ label: 'Complete', status: 'COMPLETED', icon: CheckCircle, variant: 'default' as const });\n      actions.push({ label: 'Blocked', status: 'BLOCKED', icon: AlertTriangle, variant: 'destructive' as const });\n    }\n    if (s === 'BLOCKED') {\n      actions.push({ label: 'Resume Work', status: 'WORKING', icon: Play, variant: 'default' as const });\n    }\n    if (s === 'COMPLETED') {\n      actions.push({ label: 'Close', status: 'CLOSED', icon: Square, variant: 'outline' as const });\n    }\n    if (!['CLOSED', 'CANCELLED', 'COMPLETED'].includes(s || '')) {\n      actions.push({ label: 'Cancel', status: 'CANCELLED', icon: XCircle, variant: 'destructive' as const });\n    }\n    return actions;\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      <div className=\"flex items-center gap-3\">\n        <Button variant=\"ghost\" size=\"sm\" onClick={onBack}>\n          <ArrowLeft className=\"w-4 h-4 mr-1\" /> Back\n        </Button>\n        <Badge className={PRIORITY_COLORS[ticket.priority || 'P2']}>{ticket.priority}</Badge>\n        <Badge className={STATUS_COLORS[ticket.status || 'CREATED']}>{ticket.status}</Badge>\n      </div>\n\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center justify-between\">\n            <span>{ticket.title || 'Untitled Ticket'}</span>\n            <span className=\"text-sm font-normal text-gray-500\">ID: {ticket.id.slice(0, 8)}</span>\n          </CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-4\">\n          <div className=\"grid grid-cols-2 gap-4 text-sm\">\n            <div>\n              <span className=\"text-gray-500\">Issue Type:</span>\n              <span className=\"ml-2 font-medium\">{issueType?.name || '-'} ({issueType?.code || '-'})</span>\n            </div>\n            <div>\n              <span className=\"text-gray-500\">External Ref:</span>\n              <span className=\"ml-2 font-medium\">{ticket.externalRef || '-'}</span>\n            </div>\n            <div>\n              <span className=\"text-gray-500\">Company:</span>\n              <span className=\"ml-2 font-medium\">{companyName || '-'}</span>\n            </div>\n            <div>\n              <span className=\"text-gray-500\">Feeder / Circuit:</span>\n              <span className=\"ml-2 font-medium\">{ticket.feeder || '-'} / {ticket.circuit || '-'}</span>\n            </div>\n          </div>\n\n          {ticket.addressText && (\n            <div className=\"flex items-start gap-2 text-sm\">\n              <MapPin className=\"w-4 h-4 text-gray-400 mt-0.5\" />\n              <span>{ticket.addressText}</span>\n              {ticket.lat && ticket.lon && (\n                <span className=\"text-gray-400\">({ticket.lat?.toFixed(4)}, {ticket.lon?.toFixed(4)})</span>\n              )}\n            </div>\n          )}\n\n          {ticket.description && (\n            <div className=\"text-sm\">\n              <span className=\"text-gray-500 block mb-1\">Description:</span>\n              <p className=\"whitespace-pre-wrap\">{ticket.description}</p>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Assignment Card */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg\">Assignment</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {activeAssignment ? (\n            <div className=\"space-y-3\">\n              <div className=\"flex items-center justify-between\">\n                <div>\n                  <span className=\"text-sm text-gray-500\">Crew ID:</span>\n                  <span className=\"ml-2 text-sm font-medium\">{activeAssignment.crewId.slice(0, 8)}</span>\n                </div>\n                <Badge className={\n                  activeAssignment.status === 'ACCEPTED' ? 'bg-green-100 text-green-800' :\n                  activeAssignment.status === 'PENDING_ACCEPT' ? 'bg-yellow-100 text-yellow-800' :\n                  'bg-gray-100 text-gray-800'\n                }>\n                  {activeAssignment.status}\n                </Badge>\n              </div>\n              {activeAssignment.status === 'PENDING_ACCEPT' && (\n                <div className=\"flex gap-2\">\n                  <Button\n                    size=\"sm\"\n                    onClick={() => respondMutation.mutate({ assignmentId: activeAssignment.id, action: 'accept' })}\n                    disabled={respondMutation.isPending}\n                  >\n                    <UserCheck className=\"w-4 h-4 mr-1\" /> Accept\n                  </Button>\n                  <Button\n                    size=\"sm\"\n                    variant=\"destructive\"\n                    onClick={() => respondMutation.mutate({ assignmentId: activeAssignment.id, action: 'reject' })}\n                    disabled={respondMutation.isPending}\n                  >\n                    <UserX className=\"w-4 h-4 mr-1\" /> Reject\n                  </Button>\n                </div>\n              )}\n            </div>\n          ) : (\n            <div className=\"flex items-center justify-between\">\n              <span className=\"text-sm text-gray-500\">No active assignment</span>\n              {(user.role === 'MANAGER' || user.role === 'UTILITY') && (\n                <Button size=\"sm\" variant=\"outline\" onClick={onAssign}>\n                  Assign Crew\n                </Button>\n              )}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Status Actions */}\n      {getNextActions().length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">Actions</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex flex-wrap gap-2\">\n              {getNextActions().map((action) => (\n                <Button\n                  key={action.status}\n                  variant={action.variant}\n                  size=\"sm\"\n                  onClick={() => statusMutation.mutate({ status: action.status })}\n                  disabled={statusMutation.isPending}\n                >\n                  <action.icon className=\"w-4 h-4 mr-1\" />\n                  {action.label}\n                </Button>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Timeline */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg\">Timeline</CardTitle>\n        </CardHeader>\n        <CardContent>\n          {events.length === 0 ? (\n            <p className=\"text-sm text-gray-500\">No status events yet.</p>\n          ) : (\n            <div className=\"space-y-3\">\n              {events.map((event: any) => (\n                <div key={event.id} className=\"flex items-start gap-3 text-sm border-l-2 border-gray-200 pl-3\">\n                  <Clock className=\"w-4 h-4 text-gray-400 mt-0.5 flex-shrink-0\" />\n                  <div>\n                    <div className=\"flex items-center gap-2\">\n                      {event.oldStatus && (\n                        <>\n                          <Badge className={STATUS_COLORS[event.oldStatus] || 'bg-gray-100'} variant=\"outline\">\n                            {event.oldStatus}\n                          </Badge>\n                          <span className=\"text-gray-400\">→</span>\n                        </>\n                      )}\n                      <Badge className={STATUS_COLORS[event.newStatus] || 'bg-gray-100'}>\n                        {event.newStatus}\n                      </Badge>\n                    </div>\n                    {event.note && <p className=\"text-gray-600 mt-1\">{event.note}</p>}\n                    <p className=\"text-xs text-gray-400 mt-1\">\n                      {new Date(event.changedAt).toLocaleString()}\n                    </p>\n                  </div>\n                </div>\n              ))}\n            </div>\n          )}\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction AssignDialog({\n  ticketId,\n  sessionId,\n  open,\n  onClose,\n}: {\n  ticketId: string;\n  sessionId: string;\n  open: boolean;\n  onClose: () => void;\n}) {\n  const { toast } = useToast();\n  const [selectedCompanyId, setSelectedCompanyId] = useState('');\n  const [selectedCrewId, setSelectedCrewId] = useState('');\n\n  const { data: companies = [] } = useQuery<Company[]>({\n    queryKey: ['/api/companies'],\n  });\n\n  const { data: rosters = [] } = useQuery<any[]>({\n    queryKey: ['/api/rosters', { sessionId }],\n    queryFn: async () => {\n      const res = await fetch(`/api/rosters?sessionId=${sessionId}`, { credentials: 'include' });\n      if (!res.ok) return [];\n      return res.json();\n    },\n  });\n\n  const companyRosters = rosters.filter((r: any) => !selectedCompanyId || r.companyId === selectedCompanyId);\n\n  const { data: allCrews = [] } = useQuery<Crew[]>({\n    queryKey: ['/api/crews', { rosterIds: companyRosters.map((r: any) => r.id) }],\n    queryFn: async () => {\n      const crewPromises = companyRosters.map(async (r: any) => {\n        const res = await fetch(`/api/rosters/${r.id}/crews`, { credentials: 'include' });\n        if (!res.ok) return [];\n        return res.json();\n      });\n      const results = await Promise.all(crewPromises);\n      return results.flat();\n    },\n    enabled: companyRosters.length > 0,\n  });\n\n  const assignMutation = useMutation({\n    mutationFn: async () => {\n      const res = await apiRequest('POST', `/api/tickets/${ticketId}/assign`, {\n        companyId: selectedCompanyId,\n        crewId: selectedCrewId,\n      });\n      return res.json();\n    },\n    onSuccess: () => {\n      toast({ title: 'Ticket assigned successfully' });\n      queryClient.invalidateQueries({ queryKey: ['/api/tickets'] });\n      onClose();\n    },\n    onError: (error: any) => {\n      toast({ title: 'Error', description: error.message, variant: 'destructive' });\n    },\n  });\n\n  return (\n    <Dialog open={open} onOpenChange={(o) => !o && onClose()}>\n      <DialogContent>\n        <DialogHeader>\n          <DialogTitle>Assign Ticket to Crew</DialogTitle>\n        </DialogHeader>\n        <div className=\"space-y-4\">\n          <div>\n            <label className=\"text-sm font-medium mb-1 block\">Company</label>\n            <Select value={selectedCompanyId} onValueChange={(v) => { setSelectedCompanyId(v); setSelectedCrewId(''); }}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select company\" />\n              </SelectTrigger>\n              <SelectContent>\n                {companies.map((c) => (\n                  <SelectItem key={c.id} value={c.id}>{c.name}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          <div>\n            <label className=\"text-sm font-medium mb-1 block\">Crew</label>\n            <Select value={selectedCrewId} onValueChange={setSelectedCrewId}>\n              <SelectTrigger>\n                <SelectValue placeholder=\"Select crew\" />\n              </SelectTrigger>\n              <SelectContent>\n                {allCrews.map((c: any) => (\n                  <SelectItem key={c.id} value={c.id}>{c.crewName} {c.crewLead ? `(${c.crewLead})` : ''}</SelectItem>\n                ))}\n              </SelectContent>\n            </Select>\n          </div>\n          <Button\n            className=\"w-full\"\n            onClick={() => assignMutation.mutate()}\n            disabled={!selectedCompanyId || !selectedCrewId || assignMutation.isPending}\n          >\n            {assignMutation.isPending ? 'Assigning...' : 'Assign'}\n          </Button>\n        </div>\n      </DialogContent>\n    </Dialog>\n  );\n}\n","path":null,"size_bytes":31804,"size_tokens":null}},"version":2}